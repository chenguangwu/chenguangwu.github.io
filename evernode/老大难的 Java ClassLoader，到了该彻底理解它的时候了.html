<html>
<head>
  <title>老大难的 Java ClassLoader，到了该彻底理解它的时候了</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2879"/>
<h1>老大难的 Java ClassLoader，到了该彻底理解它的时候了</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/12/3 13:44</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://mp.weixin.qq.com/s?__biz=MzI0MzQyMTYzOQ==&mid=2247484574&idx=1&sn=3d0f21e0f5cf2205f1173255e415f289&chksm=e96c1c36de1b9520b1866ce65be541dfbfdb56dbc0315026696f8d57fec62b79eafc673e32ca&mpshare=1&scene=1&srcid=12026hp3dwf2GIMJ8mv4ySti#rd"><i>https://mp.weixin.qq.com/s?__biz=MzI0MzQyMTYzOQ==&amp;mid=2247484574&amp;idx=1&amp;sn=3d0f21e0f5cf2205f1173255e415f289&amp;chksm=e96c1c36de1b9520b1866ce65be541dfbfdb56dbc0315026696f8d57fec62b79eafc673e32ca&amp;mpshare=1&amp;scene=1&amp;srcid=12026hp3dwf2GIMJ8mv4ySti#rd</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="text-size-adjust:100%;line-height:1.6;"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);letter-spacing:0.034em;background-color:rgb(255, 255, 255);"><div><div style="word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div><div style="overflow:hidden;color:rgb(51, 51, 51);font-size:17px;word-wrap:break-word;text-align:justify;">
                    

                    

                    
                    
                    <p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640" type="image/webp" data-filename="640" height="315" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:560px !important;visibility:visible !important;" width="560"/></p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">ClassLoader 是 Java 届最为神秘的技术之一，无数人被它伤透了脑筋，摸不清门道究竟在哪里。网上的文章也是一篇又一篇，经过本人的亲自鉴定，绝大部分内容都是在误导别人。本文我带读者彻底吃透 ClassLoader，以后其它的相关文章你们可以不必再细看了。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">ClassLoader 做什么的？</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">顾名思义，它是用来加载 Class 的。它负责将 Class 的字节码形式转换成内存形式的 Class 对象。字节码可以来自于磁盘文件 *.class，也可以是 jar 包里的 *.class，也可以来自远程服务器提供的字节流，字节码的本质就是一个字节数组 []byte，它有特定的复杂的内部格式。</p><div style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640 [1]" type="image/webp" data-filename="640" height="117" style="border-style:none;margin:0px;width:599px !important;box-sizing:border-box;display:block;height:auto !important;margin-right:auto;margin-left:auto;border-width:initial;padding:0px;border-color:initial;border-radius:6px;font-size:inherit;color:inherit;line-height:inherit;word-wrap:break-word;max-width:100%;visibility:visible !important;" title="图片" width="599"/><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:10px;font-size:0.7em;color:rgb(153, 153, 153);line-height:inherit;text-align:center;">图片</div></div><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">有很多字节码加密技术就是依靠定制 ClassLoader 来实现的。先使用工具对字节码文件进行加密，运行时使用定制的 ClassLoader 先解密文件内容再加载这些解密后的字节码。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">每个 Class 对象的内部都有一个 classLoader 字段来标识自己是由哪个 ClassLoader 加载的。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class</span>&lt;T&gt; {</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">private</span> final ClassLoader classLoader;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">延迟加载</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">JVM 运行并不是一次性加载所需要的全部类的，它是按需加载，也就是延迟加载。程序在运行的过程中会逐渐遇到很多不认识的新类，这时候就会调用 ClassLoader 来加载这些类。加载完成后就会将 Class 对象存在 ClassLoader 里面，下次就不需要重新加载了。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">比如你在调用某个类的静态方法时，首先这个类肯定是需要被加载的，但是并不会触及这个类的实例字段，那么实例字段的类别 Class 就可以暂时不必去加载，但是它可能会加载静态字段相关的类别，因为静态方法会访问静态字段。而实例字段的类别需要等到你实例化对象的时候才可能会加载。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">各司其职</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">JVM 运行实例中会存在多个 ClassLoader，不同的 ClassLoader 会从不同的地方加载字节码文件。它可以从不同的文件目录加载，也可以从不同的 jar 文件中加载，也可以从网络上不同的服务地址来加载。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">JVM 中内置了三个重要的 ClassLoader，分别是 BootstrapClassLoader、ExtensionClassLoader 和 AppClassLoader。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">BootstrapClassLoader 负责加载 JVM 运行时核心类，这些类位于 JAVA_HOME/lib/rt.jar 文件中，我们常用内置库 java.xxx.* 都在里面，比如 java.util.*、java.io.*、java.nio.*、java.lang.* 等等。这个 ClassLoader 比较特殊，它是由 C 代码实现的，我们将它称之为「根加载器」。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">ExtensionClassLoader 负责加载 JVM 扩展类，比如 swing 系列、内置的 js 引擎、xml 解析器 等等，这些库名通常以 javax 开头，它们的 jar 包位于 JAVA_HOME/lib/ext/*.jar 中，有很多 jar 包。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">AppClassLoader 才是直接面向我们用户的加载器，它会加载 Classpath 环境变量里定义的路径中的 jar 包和目录。我们自己编写的代码以及使用的第三方 jar 包通常都是由它来加载的。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">那些位于网络上静态文件服务器提供的 jar 包和 class文件，jdk 内置了一个 URLClassLoader，用户只需要传递规范的网络路径给构造器，就可以使用 URLClassLoader 来加载远程类库了。URLClassLoader 不但可以加载远程类库，还可以加载本地路径的类库，取决于构造器中不同的地址形式。ExtensionClassLoader 和 AppClassLoader 都是 URLClassLoader 的子类，它们都是从本地文件系统里加载类库。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">AppClassLoader 可以由 ClassLoader 类提供的静态方法 getSystemClassLoader() 得到，它就是我们所说的「系统类加载器」，我们用户平时编写的类代码通常都是由它加载的。当我们的 main 方法执行的时候，这第一个用户类的加载器就是 AppClassLoader。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">ClassLoader 传递性</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">程序在运行过程中，遇到了一个未知的类，它会选择哪个 ClassLoader 来加载它呢？虚拟机的策略是使用调用者 Class 对象的 ClassLoader 来加载当前未知的类。何为调用者 Class 对象？就是在遇到这个未知的类时，虚拟机肯定正在运行一个方法调用（静态方法或者实例方法），这个方法挂在哪个类上面，那这个类就是调用者 Class 对象。前面我们提到每个 Class 对象里面都有一个 classLoader 属性记录了当前的类是由谁来加载的。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">因为 ClassLoader 的传递性，所有延迟加载的类都会由初始调用 main 方法的这个 ClassLoader 全全负责，它就是 AppClassLoader。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">双亲委派</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">前面我们提到 AppClassLoader 只负责加载 Classpath 下面的类库，如果遇到没有加载的系统类库怎么办，AppClassLoader 必须将系统类库的加载工作交给 BootstrapClassLoader 和 ExtensionClassLoader 来做，这就是我们常说的「双亲委派」。</p><div style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640 [2]" type="image/webp" data-filename="640" height="373" style="border-style:none;margin:0px;width:375px !important;box-sizing:border-box;display:block;height:auto !important;margin-right:auto;margin-left:auto;border-width:initial;padding:0px;border-color:initial;border-radius:6px;font-size:inherit;color:inherit;line-height:inherit;word-wrap:break-word;max-width:100%;visibility:visible !important;" title="图片" width="375"/><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:10px;font-size:0.7em;color:rgb(153, 153, 153);line-height:inherit;text-align:center;">图片</div></div><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">AppClassLoader 在加载一个未知的类名时，它并不是立即去搜寻 Classpath，它会首先将这个类名称交给 ExtensionClassLoader 来加载，如果 ExtensionClassLoader 可以加载，那么 AppClassLoader 就不用麻烦了。否则它就会搜索 Classpath 。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">而 ExtensionClassLoader 在加载一个未知的类名时，它也并不是立即搜寻 ext 路径，它会首先将类名称交给 BootstrapClassLoader 来加载，如果 BootstrapClassLoader 可以加载，那么 ExtensionClassLoader 也就不用麻烦了。否则它就会搜索 ext 路径下的 jar 包。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">这三个 ClassLoader 之间形成了级联的父子关系，每个 ClassLoader 都很懒，尽量把工作交给父亲做，父亲干不了了自己才会干。每个 ClassLoader 对象内部都会有一个 parent 属性指向它的父加载器。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">ClassLoader</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">private</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">final</span> ClassLoader <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">parent</span>;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>值得注意的是图中的 ExtensionClassLoader 的 parent 指针画了虚线，这是因为它的 parent 的值是 null，当 parent 字段是 null 时就表示它的父加载器是「根加载器」。如果某个 Class 对象的 classLoader 属性值是 null，那么就表示这个类也是「根加载器」加载的。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">Class.forName</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">当我们在使用 jdbc 驱动时，经常会使用 Class.forName 方法来动态加载驱动类。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.forName</span>(&quot;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">com</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.mysql</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.cj</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.jdbc</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.Driver</span>&quot;);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>其原理是 mysql 驱动的 Driver 类里有一个静态代码块，它会在 Driver 类被加载的时候执行。这个静态代码块会将 mysql 驱动实例注册到全局的 jdbc 驱动管理器里。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Driver</span> {</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">static</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">try</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>       java.sql.DriverManager.registerDriver(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> Driver());<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">catch</span> (SQLException E) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">throw</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> RuntimeException(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;Can't register driver!&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>forName 方法同样也是使用调用者 Class 对象的 ClassLoader 来加载目标类。不过 forName 还提供了多参数版本，可以指定使用哪个 ClassLoader 来加载</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class</span>&lt;?&gt; forName(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">String</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">name</span>, boolean initialize, ClassLoader cl)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>通过这种形式的 forName 方法可以突破内置加载器的限制，通过使用自定类加载器允许我们自由加载其它任意来源的类库。根据 ClassLoader 的传递性，目标类库传递引用到的其它类库也将会使用自定义加载器加载。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">自定义加载器</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">ClassLoader 里面有三个重要的方法 loadClass()、findClass() 和 defineClass()。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">loadClass() 方法是加载目标类的入口，它首先会查找当前 ClassLoader 以及它的双亲里面是否已经加载了目标类，如果没有找到就会让双亲尝试加载，如果双亲都加载不了，就会调用 findClass() 让自定义加载器自己来加载目标类。ClassLoader 的 findClass() 方法是需要子类来覆盖的，不同的加载器将使用不同的逻辑来获取目标类的字节码。拿到这个字节码之后再调用 defineClass() 方法将字节码转换成 Class 对象。下面我使用伪代码表示一下基本过程</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">ClassLoader</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 加载入口，定义了双亲委派规则</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">loadClass</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">(String name)</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 是否已经加载了</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    Class t = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">this</span>.findFromLoaded(name);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">if</span>(t == <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">null</span>) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 交给双亲</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>      t = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">this</span>.parent.loadClass(name)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">if</span>(t == <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">null</span>) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 双亲都不行，只能靠自己了</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>      t = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">this</span>.findClass(name);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">return</span> t;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 交给子类自己去实现</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">findClass</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">(String name)</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">throw</span> ClassNotFoundException();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 组装Class对象</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">defineClass</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">byte</span>[] code, String name)</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">return</span> buildClassFromCode(code, name);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">CustomClassLoader</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">extends</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">ClassLoader</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Class <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">findClass</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">(String name)</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 寻找字节码</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">byte</span>[] code = findCodeFromSomewhere(name);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// 组装Class对象</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">return</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">this</span>.defineClass(code, name);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>自定义类加载器不易破坏双亲委派规则，不要轻易覆盖 loadClass 方法。否则可能会导致自定义加载器无法加载内置的核心类库。在使用自定义加载器时，要明确好它的父加载器是谁，将父加载器通过子类的构造器传入。如果父类加载器是 null，那就表示父加载器是「根加载器」。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(88, 110, 117);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">// ClassLoader 构造器</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">protected</span> ClassLoader(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">String</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">name</span>, ClassLoader parent);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>双亲委派规则可能会变成三亲委派，四亲委派，取决于你使用的父加载器是谁，它会一直递归委派到根加载器。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">Class.forName vs ClassLoader.loadClass</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">这两个方法都可以用来加载目标类，它们之间有一个小小的区别，那就是 Class.forName() 方法可以获取原生类型的 Class，而 ClassLoader.loadClass() 则会报错。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;">Class&lt;?&gt; x = Class.forName(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;[I&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>System.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">out</span>.println(x);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>x = ClassLoader.getSystemClassLoader().loadClass(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;[I&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>System.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">out</span>.println(x);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>---------------------<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> [<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">I</span></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>Exception <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">in</span> thread <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;main&quot;</span> java.lang.ClassNotFoundException: [I<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">钻石依赖</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">项目管理上有一个著名的概念叫着「钻石依赖」，是指软件依赖导致同一个软件包的两个版本需要共存而不能冲突。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;"/></p><div style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640 [3]" type="image/webp" data-filename="640" height="298" style="border-style:none;margin:0px;width:606px !important;box-sizing:border-box;display:block;height:auto !important;margin-right:auto;margin-left:auto;border-width:initial;padding:0px;border-color:initial;border-radius:6px;font-size:inherit;color:inherit;line-height:inherit;word-wrap:break-word;max-width:100%;visibility:visible !important;" title="图片" width="606"/><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:10px;font-size:0.7em;color:rgb(153, 153, 153);line-height:inherit;text-align:center;">图片</div></div><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(62, 62, 62);font-size:15px;letter-spacing:2px;word-spacing:2px;background-color:rgb(255, 255, 255);">我们平时使用的 maven 是这样解决钻石依赖的，它会从多个冲突的版本中选择一个来使用，如果不同的版本之间兼容性很糟糕，那么程序将无法正常编译运行。Maven 这种形式叫「扁平化」依赖管理。</span></p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">使用 ClassLoader 可以解决钻石依赖问题。不同版本的软件包使用不同的 ClassLoader 来加载，<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(233, 105, 0);font-size:inherit;line-height:inherit;">位于不同 ClassLoader 中名称一样的类实际上是不同的类</strong>。下面让我们使用 URLClassLoader 来尝试一个简单的例子，它默认的父加载器是 AppClassLoader</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;">$ cat ~/source/jcl/v1/Dep.java<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Dep</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">print</span>() </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        System.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">out</span>.println(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;v1&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>$ cat ~/source/jcl/v2/Dep.java<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Dep</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">print</span>() </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    System.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">out</span>.println(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;v1&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>$ cat ~/source/jcl/Test.java<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Test</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">static</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">main</span>(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">String[] args</span>) throws Exception </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        String v1dir = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;file:///Users/qianwp/source/jcl/v1/&quot;</span>;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        String v2dir = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;file:///Users/qianwp/source/jcl/v2/&quot;</span>;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        URLClassLoader v1 = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URLClassLoader(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URL[]{<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URL(v1dir)});<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        URLClassLoader v2 = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URLClassLoader(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URL[]{<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">new</span> URL(v2dir)});<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        Class&lt;?&gt; depv1Class = v1.loadClass(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;Dep&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        Object depv1 = depv1Class.getConstructor().newInstance();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        depv1Class.getMethod(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;print&quot;</span>).invoke(depv1);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        Class&lt;?&gt; depv2Class = v2.loadClass(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;Dep&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        Object depv2 = depv2Class.getConstructor().newInstance();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        depv2Class.getMethod(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;print&quot;</span>).invoke(depv2);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>        System.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">out</span>.println(depv1Class.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">equals</span>(depv2Class));<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>   }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">在运行之前，我们需要对依赖的类库进行编译</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">cd</span> ~/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">source</span>/jcl/v1</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> javac Dep.java</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">cd</span> ~/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">source</span>/jcl/v2</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> javac Dep.java</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">cd</span> ~/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(220, 50, 47);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">source</span>/jcl</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> javac Test.java</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">$</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"> java Test</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>v1<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>v2<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>false<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>在这个例子中如果两个 URLClassLoader 指向的路径是一样的，下面这个表达式还是 false，因为即使是同样的字节码用不同的 ClassLoader 加载出来的类都不能算同一个类</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;">depv1Class.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">equals</span>(depv2Class)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>我们还可以让两个不同版本的 Dep 类实现同一个接口，这样可以避免使用反射的方式来调用 Dep 类里面的方法。</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;">Class<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(203, 75, 22);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&lt;?</span>&gt; depv1Class = v1.loadClass(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(42, 161, 152);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">&quot;Dep&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>IPrint depv1 = (IPrint)depv1Class.getConstructor().newInstance();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>depv1.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">print</span>()<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></span></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>ClassLoader 固然可以解决依赖冲突问题，不过它也限制了不同软件包的操作界面必须使用反射或接口的方式进行动态调用。Maven 没有这种限制，它依赖于虚拟机的默认懒惰加载策略，运行过程中如果没有显示使用定制的 ClassLoader，那么从头到尾都是在使用 AppClassLoader，而不同版本的同名类必须使用不同的 ClassLoader 加载，所以 Maven 不能完美解决钻石依赖。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;"/>如果你想知道有没有开源的包管理工具可以解决钻石依赖的，我推荐你了解一下 sofa-ark，它是蚂蚁金服开源的轻量级类隔离框架。</p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">分工与合作</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">这里我们重新理解一下 ClassLoader 的意义，它相当于类的命名空间，起到了类隔离的作用。位于同一个 ClassLoader 里面的类名是唯一的，不同的 ClassLoader 可以持有同名的类。ClassLoader 是类名称的容器，是类的沙箱。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;"/></p><div style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640 [4]" type="image/webp" data-filename="640" height="618" style="border-style:none;margin:0px;width:677px !important;box-sizing:border-box;display:block;height:auto !important;margin-right:auto;margin-left:auto;border-width:initial;padding:0px;border-color:initial;border-radius:6px;font-size:inherit;color:inherit;line-height:inherit;word-wrap:break-word;max-width:100%;visibility:visible !important;" title="图片" width="677"/><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:10px;font-size:0.7em;color:rgb(153, 153, 153);line-height:inherit;text-align:center;">图片</div></div><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="color:rgb(62, 62, 62);margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;font-size:15px;padding:0px;line-height:inherit;letter-spacing:2px;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(62, 62, 62);font-size:15px;letter-spacing:2px;word-spacing:2px;background-color:rgb(255, 255, 255);">不同的 ClassLoader 之间也会有合作，它们之间的合作是通过 parent 属性和双亲委派机制来完成的。parent 具有更高的加载优先级。除此之外，parent 还表达了一种共享关系，当多个子 ClassLoader 共享同一个 parent 时，那么这个 parent 里面包含的类可以认为是所有子 ClassLoader 共享的。这也是为什么 BootstrapClassLoader 被所有的类加载器视为祖先加载器，JVM 核心类库自然应该被共享。</span></p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h2 style="margin-top:1.6em;font-weight:bold;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;margin-bottom:1.6em;color:rgb(62, 62, 62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;">Thread.contextClassLoader</span></h2><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">如果你稍微阅读过 Thread 的源代码，你会在它的实例字段中发现有一个字段非常特别</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">class</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(181, 137, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Thread</span> {</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">private</span> ClassLoader contextClassLoader;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> ClassLoader <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">getContextClassLoader</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">()</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">return</span> contextClassLoader;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">setContextClassLoader</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">(ClassLoader cl)</span> </span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">this</span>.contextClassLoader = cl;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>  ...<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>contextClassLoader「线程上下文类加载器」，这究竟是什么东西？</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">首先 contextClassLoader 是那种需要显示使用的类加载器，如果你没有显示使用它，也就永远不会在任何地方用到它。你可以使用下面这种方式来显示使用它</p><pre style="margin-bottom:0px;margin:0px;word-spacing:2px;box-sizing:border-box;letter-spacing:2px;margin-top:0px;padding:0px;font-size:15px;color:rgb(62, 62, 62);line-height:inherit;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><code style="border-radius:0px;margin:0px;word-break:normal !important;box-sizing:border-box;overflow-wrap:normal !important;margin-right:2px;margin-left:2px;font-size:14px;color:rgb(131, 148, 150);line-height:18px;padding:0.5em;background:rgb(0, 43, 54);font-family:Consolas, Inconsolata, Courier, monospace;display:block;overflow-x:auto;word-spacing:0px;letter-spacing:0px;word-wrap:break-word;max-width:100%;overflow-y:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">Thread</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.currentThread</span>()<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.getContextClassLoader</span>()<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(38, 139, 210);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">.loadClass</span>(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:rgb(133, 153, 0);line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;">name</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;overflow-wrap:inherit !important;word-break:inherit !important;"/></code></pre><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>这意味着如果你使用 forName(string name) 方法加载目标类，它不会自动使用 contextClassLoader。那些因为代码上的依赖关系而懒惰加载的类也不会自动使用 contextClassLoader来加载。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">其次线程的 contextClassLoader 是从父线程那里继承过来的，所谓父线程就是创建了当前线程的线程。程序启动时的 main 线程的 contextClassLoader 就是 AppClassLoader。这意味着如果没有人工去设置，那么所有的线程的 contextClassLoader 都是 AppClassLoader。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">那这个 contextClassLoader 究竟是做什么用的？我们要使用前面提到了类加载器分工与合作的原理来解释它的用途。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">它可以做到跨线程共享类，只要它们共享同一个 contextClassLoader。父子线程之间会自动传递 contextClassLoader，所以共享起来将是自动化的。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">如果不同的线程使用不同的 contextClassLoader，那么不同的线程使用的类就可以隔离开来。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">如果我们对业务进行划分，不同的业务使用不同的线程池，线程池内部共享同一个 contextClassLoader，线程池之间使用不同的 contextClassLoader，就可以很好的起到隔离保护的作用，避免类版本冲突。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">如果我们不去定制 contextClassLoader，那么所有的线程将会默认使用 AppClassLoader，所有的类都将会是共享的。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"></span></p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">线程的 contextClassLoader 使用场合比较罕见，如果上面的逻辑晦涩难懂也不必过于计较。</p><p style="margin-bottom:1.7em;margin:0px;word-spacing:2px;box-sizing:border-box;white-space:normal;letter-spacing:2px;line-height:inherit;padding:0px;font-size:15px;color:rgb(62, 62, 62);min-height:1em;clear:both;word-wrap:break-word;max-width:100%;background-color:rgb(255, 255, 255);">JDK9 增加了模块功能之后对类加载器的结构设计做了一定程度的修改，不过类加载器的原理还是类似的，作为类的容器，它起到类隔离的作用，同时还需要依靠双亲委派机制来建立不同的类加载器之间的合作关系。</p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="老大难的 Java ClassLoader，到了该彻底理解它的时候了_files/640 [5]" type="image/webp" data-filename="640" height="505" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:507px !important;visibility:visible !important;" width="507"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"></span><span style="font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;margin:0px;max-width:100%;box-sizing:border-box !important;font-size:14px;color:rgb(51, 51, 51);padding:0px;letter-spacing:0.544px;text-align:center;background-color:rgb(255, 255, 255);word-wrap:break-word;overflow-wrap:break-word !important;">阅读更多精品文章，长按图片识别二维码关注</span><span style="letter-spacing:0.544px;margin:0px;max-width:100%;box-sizing:border-box !important;color:rgb(255, 0, 0);font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;padding:0px;text-align:center;background-color:rgb(255, 255, 255);font-size:14px;word-wrap:break-word;overflow-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word;overflow-wrap:break-word !important;">「码洞」</strong></span></p>
                </div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 