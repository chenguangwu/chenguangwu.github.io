<html>
<head>
  <title>Java异步调用模式 - Jevo - 博客园</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="10506"/>
<h1>Java异步调用模式 - Jevo - 博客园</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/3/29 16:41</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.cnblogs.com/jevo/archive/2013/04/11/3015023.html"><i>http://www.cnblogs.com/jevo/archive/2013/04/11/3015023.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color:rgb(0, 0, 0);background:url(&quot;/Skins/coffee/images/bg_body.gif&quot;) left top;line-height:1.5;font-size:14px;"><div style="min-width:auto;"><div style="min-width:auto;text-align:left;"><div style="background:transparent;text-align:left;overflow-x:hidden;"><div style="background:url(&quot;/Skins/coffee/images/bg_left.gif&quot;) left top repeat-x rgb(254, 254, 242);"><div><div style="text-overflow:ellipsis;overflow:hidden;word-break:break-all;"><div>
		<h1 style="margin:0px;padding:0px;width:100%;clear:both;font-weight:bold;float:left;line-height:1.5;font-size:14px;padding-left:5px;">
			<a href="http://www.cnblogs.com/jevo/archive/2013/04/11/3015023.html" style="margin:0px;padding:0px;text-decoration:none;color:rgb(7, 93, 179);">Java异步调用模式</a>
		</h1>
		<div style="margin:0px;padding:0px;clear:both;"></div>
		<div style="margin:0px;padding:5px 2px 5px 5px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin-top:5px;">
			<div style="margin:0px;padding:0px;margin-bottom:20px;word-break:break-word;"><div style="margin:0px;padding:0px;">在长期的Java客户端开发中，最常见的一个客户端调用模式就是Java的异步调用。所谓异步调用其实就是实现一个可无需等待被调用函数的返回值而让操作继续运行的方法。在Java语言中，简单的讲就是另启一个线程来完成调用中的部分计算，使调用继续运行或返回，而不需要等待计算结果。但调用者仍需要取线程的计算结果。虽然在1.5以前从异步线程中取得返回结果需要自己精心设计，但从JDK1.5开始引入了Future接口(FutureTask类)从异步执行的线程中取得返回值。</div>
<div style="margin:0px;padding:0px;">Future 表示异步计算的结果，它提供了检查计算是否完成的方法，以等待计算的完成，并获取计算的结果。FutureTask类是Future接口方法的一个基本实现，是一种可以取消的异步计算任务，计算是通过Callable接口来实现的。</div>
<div style="margin:0px;padding:0px;">
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">FutureTask有下面几个重要的方法：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">       1. get()   阻塞一直等待执行完成拿到结果</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">       2. get(int timeout, TimeUnit timeUnit)  阻塞一直等待执行完成拿到结果，如果在超时时间内，没有拿到抛出异常</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">       3. isCancelled()  是否被取消</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">       4. isDone()   是否已经完成</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">       5. cancel(boolean mayInterruptIfRunning)  试图取消正在执行的任务</p>
</div>
<div style="margin:0px;padding:0px;">
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">Callable和Runnable有几点不同：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:1em;list-style-type:disc;">Callable规定的方法是call()，而Runnable规定的方法是run().</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:1em;list-style-type:disc;">Callable的任务执行后可返回值，而Runnable的任务是不能返回值的。</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:1em;list-style-type:disc;">call（）方法可抛出异常，而run（）方法是不能抛出异常的。</li>
</ul>
运行Callable任务可拿到一个Future对象，通过Future对象可了解任务执行情况，可取消任务的执行，还可获取任务执行的结果。</div>
<div style="margin:0px;padding:0px;">举一个例子说明如何使用Future对象，如下：</div>
<div style="margin:0px;padding:0px;">
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">public class MyFutureTaskTest {<br style="margin:0px;padding:0px;"/>    public static void main(String[] args) {<br style="margin:0px;padding:0px;"/>        ExecutorService executor = Executors.newCachedThreadPool();<br style="margin:0px;padding:0px;"/>        FutureTask&lt;String&gt; future = new FutureTask&lt;String&gt;(new Callable&lt;String&gt;() {<br style="margin:0px;padding:0px;"/>            public String call() throws Exception{ //建议抛出异常<br style="margin:0px;padding:0px;"/>                try {<br style="margin:0px;padding:0px;"/>                    Thread.sleep(5* 1000);<br style="margin:0px;padding:0px;"/>                    return &quot;Hello Welcome!&quot;;<br style="margin:0px;padding:0px;"/>                }<br style="margin:0px;padding:0px;"/>                catch(Exception e) {<br style="margin:0px;padding:0px;"/>                    throw new Exception(&quot;Callable terminated with Exception!&quot;); // call方法可以抛出异常<br style="margin:0px;padding:0px;"/>                }<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        });<br style="margin:0px;padding:0px;"/>        executor.execute(future);<br style="margin:0px;padding:0px;"/>        long t = System.currentTimeMillis();<br style="margin:0px;padding:0px;"/>        try {</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">//            String result = future.get(3000, TimeUnit.MILLISECONDS); //取得结果，同时设置超时执行时间为5秒。<br style="margin:0px;padding:0px;"/>            String result = future.get(); //取得结果，同时设置超时执行时间为5秒。<br style="margin:0px;padding:0px;"/>            System.err.println(&quot;result is &quot; + result + &quot;, time is &quot; + (System.currentTimeMillis() - t));<br style="margin:0px;padding:0px;"/>        } catch (InterruptedException e) {<br style="margin:0px;padding:0px;"/>            future.cancel(true);<br style="margin:0px;padding:0px;"/>            System.err.println(&quot;Interrupte time is &quot; + (System.currentTimeMillis() - t));<br style="margin:0px;padding:0px;"/>        } catch (ExecutionException e) {<br style="margin:0px;padding:0px;"/>            future.cancel(true);<br style="margin:0px;padding:0px;"/>            System.err.println(&quot;Throw Exception time is &quot; + (System.currentTimeMillis() - t));<br style="margin:0px;padding:0px;"/>//        } catch (TimeoutException e) {<br style="margin:0px;padding:0px;"/>//            future.cancel(true);<br style="margin:0px;padding:0px;"/>//            System.err.println(&quot;Timeout time is &quot; + (System.currentTimeMillis() - t));<br style="margin:0px;padding:0px;"/>        } finally {<br style="margin:0px;padding:0px;"/>            executor.shutdown();<br style="margin:0px;padding:0px;"/>        }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    }<br style="margin:0px;padding:0px;"/>}</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">运行结果如下：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"> result is Hello Welcome!, time is 5000</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">如果设置了超时时间，则运行结果如下：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">Timeout time is 3000</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"> 可以看出设置超时时间的影响。</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">再如一个多个运行任务的例子：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">public class MyAsyncExample implements Callable {<br style="margin:0px;padding:0px;"/>    private int num;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public MyAsyncExample(int aInt) {<br style="margin:0px;padding:0px;"/>        this.num = aInt;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public String call() throws Exception {<br style="margin:0px;padding:0px;"/>        boolean resultOk = false;<br style="margin:0px;padding:0px;"/>        if (num == 0) {<br style="margin:0px;padding:0px;"/>            resultOk = true;<br style="margin:0px;padding:0px;"/>        } else if (num == 1) {<br style="margin:0px;padding:0px;"/>            while (true) { //infinite loop<br style="margin:0px;padding:0px;"/>                System.out.println(&quot;looping....&quot;);<br style="margin:0px;padding:0px;"/>                Thread.sleep(3000);<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        } else {<br style="margin:0px;padding:0px;"/>            throw new Exception(&quot;Callable terminated with Exception!&quot;); <br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>        if (resultOk) {<br style="margin:0px;padding:0px;"/>            return &quot;Task done.&quot;;<br style="margin:0px;padding:0px;"/>        } else {<br style="margin:0px;padding:0px;"/>            return &quot;Task failed&quot;;<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public static void main(String[] args) {<br style="margin:0px;padding:0px;"/>        //定义几个任务<br style="margin:0px;padding:0px;"/>        MyAsyncExample call1 = new MyAsyncExample(0);<br style="margin:0px;padding:0px;"/>        MyAsyncExample call2 = new MyAsyncExample(1);<br style="margin:0px;padding:0px;"/>        MyAsyncExample call3 = new MyAsyncExample(2);<br style="margin:0px;padding:0px;"/>        //初始任务执行工具。<br style="margin:0px;padding:0px;"/>        ExecutorService es = Executors.newFixedThreadPool(3);<br style="margin:0px;padding:0px;"/>        //执行任务，任务启动时返回了一个Future对象，<br style="margin:0px;padding:0px;"/>        Future future1 = es.submit(call1);<br style="margin:0px;padding:0px;"/>        Future future2 = es.submit(call2);<br style="margin:0px;padding:0px;"/>        Future future3 = es.submit(call3);<br style="margin:0px;padding:0px;"/>        try {<br style="margin:0px;padding:0px;"/>            //任务1正常执行完毕，future1.get()会返回线程的值<br style="margin:0px;padding:0px;"/>            System.out.println(future1.get());<br style="margin:0px;padding:0px;"/>            //任务2进行一个死循环，调用future2.cancel(true)来中止此线程。<br style="margin:0px;padding:0px;"/>            Thread.sleep(3000);<br style="margin:0px;padding:0px;"/>            System.out.println(&quot;Thread 2 terminated? :&quot; + future2.cancel(true));<br style="margin:0px;padding:0px;"/>            //任务3抛出异常，调用future3.get()时会引起异常的抛出<br style="margin:0px;padding:0px;"/>            System.out.println(future3.get());<br style="margin:0px;padding:0px;"/>        } catch (ExecutionException ex) {<br style="margin:0px;padding:0px;"/>            ex.printStackTrace();<br style="margin:0px;padding:0px;"/>        } catch (InterruptedException ex) {<br style="margin:0px;padding:0px;"/>            ex.printStackTrace();<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }<br style="margin:0px;padding:0px;"/>}</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"> 运行结果如下：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">looping....<br style="margin:0px;padding:0px;"/>Task done.<br style="margin:0px;padding:0px;"/>java.util.concurrent.ExecutionException: java.lang.Exception: Callable terminated with Exception!<br style="margin:0px;padding:0px;"/> at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)<br style="margin:0px;padding:0px;"/>looping....<br style="margin:0px;padding:0px;"/> at java.util.concurrent.FutureTask.get(FutureTask.java:83)<br style="margin:0px;padding:0px;"/>Thread 2 terminated? :true<br style="margin:0px;padding:0px;"/> at org.jevo.future.sample.MyAsyncExample.main(MyAsyncExample.java:57)<br style="margin:0px;padding:0px;"/> at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br style="margin:0px;padding:0px;"/> at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)<br style="margin:0px;padding:0px;"/> at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br style="margin:0px;padding:0px;"/> at java.lang.reflect.Method.invoke(Method.java:597)<br style="margin:0px;padding:0px;"/> at com.intellij.rt.execution.application.AppMain.main(AppMain.java:90)<br style="margin:0px;padding:0px;"/>Caused by: java.lang.Exception: Callable terminated with Exception!<br style="margin:0px;padding:0px;"/> at org.jevo.future.sample.MyAsyncExample.call(MyAsyncExample.java:30)<br style="margin:0px;padding:0px;"/> at org.jevo.future.sample.MyAsyncExample.call(MyAsyncExample.java:13)<br style="margin:0px;padding:0px;"/> at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)<br style="margin:0px;padding:0px;"/> at java.util.concurrent.FutureTask.run(FutureTask.java:138)<br style="margin:0px;padding:0px;"/> at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br style="margin:0px;padding:0px;"/> at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br style="margin:0px;padding:0px;"/> at java.lang.Thread.run(Thread.java:662)</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">以上是对Future模型的例子。异步调用在Swing中应该十分广泛，当客户端调用一个'重'的服务端操作时，我们常采用这种方式。Swing中存在一个Future的实现——SwingWorker，这使我们十分方便地在客户端开发中使用异步调用，详细使用参见API文档。下面附一个不使用Future来实现取得异步调用的代码，如下：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">public abstract class AsyncWorker {<br style="margin:0px;padding:0px;"/>    private Object value;  //the running result<br style="margin:0px;padding:0px;"/>    private boolean finished = false;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    private static class ThreadVar {<br style="margin:0px;padding:0px;"/>        private Thread thread;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        ThreadVar(Thread t) {<br style="margin:0px;padding:0px;"/>            thread = t;<br style="margin:0px;padding:0px;"/>        }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        synchronized Thread get() {<br style="margin:0px;padding:0px;"/>            return thread;<br style="margin:0px;padding:0px;"/>        }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        synchronized void clear() {<br style="margin:0px;padding:0px;"/>            thread = null;<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    private ThreadVar threadVar;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    /**<br style="margin:0px;padding:0px;"/>     * 返回当前线程运行结果。<br style="margin:0px;padding:0px;"/>     */<br style="margin:0px;padding:0px;"/>    protected synchronized Object getValue() {<br style="margin:0px;padding:0px;"/>        return value;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    /**<br style="margin:0px;padding:0px;"/>     * 设置当前线程运行结果<br style="margin:0px;padding:0px;"/>     */<br style="margin:0px;padding:0px;"/>    private synchronized void setValue(Object x) {<br style="margin:0px;padding:0px;"/>        value = x;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    /**<br style="margin:0px;padding:0px;"/>     * 调用都创建计算逻辑，将运算结果返回<br style="margin:0px;padding:0px;"/>     */<br style="margin:0px;padding:0px;"/>    public abstract Object construct();</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public void finished() {<br style="margin:0px;padding:0px;"/>        finished = true;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public boolean isFinished() {<br style="margin:0px;padding:0px;"/>        return finished;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public void interrupt() {<br style="margin:0px;padding:0px;"/>        Thread t = threadVar.get();<br style="margin:0px;padding:0px;"/>        if (t != null) {<br style="margin:0px;padding:0px;"/>            t.interrupt();<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>        threadVar.clear();<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public void stop() {<br style="margin:0px;padding:0px;"/>        Thread t = threadVar.get();<br style="margin:0px;padding:0px;"/>        if(t!=null) {<br style="margin:0px;padding:0px;"/>            t.stop();<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>        threadVar.clear();<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    /**<br style="margin:0px;padding:0px;"/>     * 返回 construct方法运行结果。<br style="margin:0px;padding:0px;"/>     */<br style="margin:0px;padding:0px;"/>    public Object get() {<br style="margin:0px;padding:0px;"/>        while (true) {<br style="margin:0px;padding:0px;"/>            Thread t = threadVar.get();<br style="margin:0px;padding:0px;"/>            if (t == null) {<br style="margin:0px;padding:0px;"/>                return getValue();<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>            try {<br style="margin:0px;padding:0px;"/>                t.join();<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>            catch (InterruptedException e) {<br style="margin:0px;padding:0px;"/>                Thread.currentThread().interrupt();<br style="margin:0px;padding:0px;"/>                return null;<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"><br style="margin:0px;padding:0px;"/>    public AsyncWorker() {<br style="margin:0px;padding:0px;"/>        final Runnable doFinished = new Runnable() {<br style="margin:0px;padding:0px;"/>            public void run() {<br style="margin:0px;padding:0px;"/>                finished();<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        };</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        Runnable doConstruct = new Runnable() {<br style="margin:0px;padding:0px;"/>            public void run() {<br style="margin:0px;padding:0px;"/>                try {<br style="margin:0px;padding:0px;"/>                    setValue(construct());<br style="margin:0px;padding:0px;"/>                }<br style="margin:0px;padding:0px;"/>                finally {<br style="margin:0px;padding:0px;"/>                    threadVar.clear();<br style="margin:0px;padding:0px;"/>                }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">                SwingUtilities.invokeLater(doFinished);<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        };</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        Thread t = new Thread(doConstruct);<br style="margin:0px;padding:0px;"/>        threadVar = new ThreadVar(t);<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    /**<br style="margin:0px;padding:0px;"/>     * Start the worker thread.<br style="margin:0px;padding:0px;"/>     */<br style="margin:0px;padding:0px;"/>    public void start() {<br style="margin:0px;padding:0px;"/>        finished = false;<br style="margin:0px;padding:0px;"/>        Thread t = threadVar.get();<br style="margin:0px;padding:0px;"/>        if (t != null) {<br style="margin:0px;padding:0px;"/>            t.start();<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public static void main(String[] args) {<br style="margin:0px;padding:0px;"/>        AsyncWorker worker = new AsyncWorker() {<br style="margin:0px;padding:0px;"/>            public Object construct() {<br style="margin:0px;padding:0px;"/>                try {<br style="margin:0px;padding:0px;"/>                    Thread.sleep(3*1000);<br style="margin:0px;padding:0px;"/>                }<br style="margin:0px;padding:0px;"/>                catch(Exception e){}<br style="margin:0px;padding:0px;"/>                return &quot;hello world&quot;;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">            }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">            public void finished() {<br style="margin:0px;padding:0px;"/>                super.finished();<br style="margin:0px;padding:0px;"/>                //取线程运行返回的结果<br style="margin:0px;padding:0px;"/>//                Object obj = this.get();<br style="margin:0px;padding:0px;"/>//                System.err.println(&quot;return is &quot; + obj);<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>        };</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">        long t = System.currentTimeMillis();<br style="margin:0px;padding:0px;"/>        worker.start();<br style="margin:0px;padding:0px;"/>        Object obj = worker.get(); //取得运行结果<br style="margin:0px;padding:0px;"/>        System.err.println(&quot;return is &quot; + obj + &quot;, time = &quot; + (System.currentTimeMillis() - t));</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    }<br style="margin:0px;padding:0px;"/>}</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">在上述代码中，调用者只需要扩展AsyncWorker类定义可计算的逻辑，并将逻辑结果返回。返回结果会保存在一变量中。当调用者调用返回结果时，如果计算还未完成，将调用Thread.join()阻塞线程，直到计算结果返回。用法上是不是与FutureTask相似？在Swing异步调用中，还需要结合等待对话框来表示计算运行进程，从而使运行界面显示更加友好。 </p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">再看一下线程的join方法，我们知道线程可被Object.wait、Thread.join和Thread.sleep三种方法之一阻塞，当接收到一个中断异常（InterruptedException）时，可提早地终结被阻塞状态。Thread.join的使用情况却有所不同：我们对一些耗时运算，常启用一个主线程来生成并启动一些子线程，在子线程中进行耗时的运算，当主线程继续处理完其他的事务后，需要调用子线程的处理结果，这个时候就要使用join();。Joint方法将使主线程等待子线程运行结束，即join()方法后的代码，只有等到子线程运行结束后才能被执行。参考下例：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">public class ChildThread extends Thread {<br style="margin:0px;padding:0px;"/>    public ChildThread() {<br style="margin:0px;padding:0px;"/>        super(&quot;ChildThread&quot;);<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public void run() {<br style="margin:0px;padding:0px;"/>        String threadName = Thread.currentThread().getName();<br style="margin:0px;padding:0px;"/>        System.out.println(threadName + &quot; start.&quot;);<br style="margin:0px;padding:0px;"/>        try {<br style="margin:0px;padding:0px;"/>            for (int i = 0; i &lt; 5; i++) {<br style="margin:0px;padding:0px;"/>                System.out.println(threadName + &quot; loop at &quot; + i);<br style="margin:0px;padding:0px;"/>                Thread.sleep(1000);<br style="margin:0px;padding:0px;"/>            }<br style="margin:0px;padding:0px;"/>            System.out.println(threadName + &quot; end.&quot;);<br style="margin:0px;padding:0px;"/>        } catch (Exception e) {<br style="margin:0px;padding:0px;"/>            System.out.println(&quot;Exception from &quot; + threadName + &quot;.run&quot;);<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }<br style="margin:0px;padding:0px;"/>}</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"> </p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">public class ParentThread extends Thread {<br style="margin:0px;padding:0px;"/>    ChildThread t1;</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public ParentThread(ChildThread t1) {<br style="margin:0px;padding:0px;"/>        super(&quot;ParentThread&quot;);<br style="margin:0px;padding:0px;"/>        this.t1 = t1;<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public void run() {<br style="margin:0px;padding:0px;"/>        String threadName = Thread.currentThread().getName();<br style="margin:0px;padding:0px;"/>        System.out.println(threadName + &quot; start.&quot;);<br style="margin:0px;padding:0px;"/>        try {<br style="margin:0px;padding:0px;"/>            t1.join();   //ChildThread 线程t1结束后，才能运行此行代码后的代码。<br style="margin:0px;padding:0px;"/>            System.out.println(threadName + &quot; end.&quot;);<br style="margin:0px;padding:0px;"/>        } catch (Exception e) {<br style="margin:0px;padding:0px;"/>            System.out.println(&quot;Exception from &quot; + threadName + &quot;.run&quot;);<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">    public static void main(String[] args) {<br style="margin:0px;padding:0px;"/>        String threadName = Thread.currentThread().getName();<br style="margin:0px;padding:0px;"/>        System.out.println(threadName + &quot; start.&quot;);<br style="margin:0px;padding:0px;"/>        ChildThread t1 = new ChildThread();<br style="margin:0px;padding:0px;"/>        ParentThread t = new ParentThread(t1);<br style="margin:0px;padding:0px;"/>        try {<br style="margin:0px;padding:0px;"/>            t1.start();<br style="margin:0px;padding:0px;"/>            Thread.sleep(2000);<br style="margin:0px;padding:0px;"/>            t.start();<br style="margin:0px;padding:0px;"/>            t.join();//此处注释后，将直接运行到结束代码. 注释此处代码，比较运行结果<br style="margin:0px;padding:0px;"/>        } catch (Exception e) {<br style="margin:0px;padding:0px;"/>            System.out.println(&quot;Exception from main&quot;);<br style="margin:0px;padding:0px;"/>        }<br style="margin:0px;padding:0px;"/>        System.out.println(threadName + &quot; end!&quot;);<br style="margin:0px;padding:0px;"/>    }</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">}</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">在t.join()被注释前运行结果如下：</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">main start.<br style="margin:0px;padding:0px;"/>ChildThread start.<br style="margin:0px;padding:0px;"/>ChildThread loop at 0<br style="margin:0px;padding:0px;"/>ChildThread loop at 1<br style="margin:0px;padding:0px;"/>ParentThread start.<br style="margin:0px;padding:0px;"/>ChildThread loop at 2<br style="margin:0px;padding:0px;"/>ChildThread loop at 3<br style="margin:0px;padding:0px;"/>ChildThread loop at 4<br style="margin:0px;padding:0px;"/>ChildThread end.<br style="margin:0px;padding:0px;"/>ParentThread end.<br style="margin:0px;padding:0px;"/>main end!</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">当t.join()被注释后运行结果如下： </p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">main start.<br style="margin:0px;padding:0px;"/>ChildThread start.<br style="margin:0px;padding:0px;"/>ChildThread loop at 0<br style="margin:0px;padding:0px;"/>ChildThread loop at 1<br style="margin:0px;padding:0px;"/>main end!<br style="margin:0px;padding:0px;"/>ParentThread start.<br style="margin:0px;padding:0px;"/>ChildThread loop at 2<br style="margin:0px;padding:0px;"/>ChildThread loop at 3<br style="margin:0px;padding:0px;"/>ChildThread loop at 4<br style="margin:0px;padding:0px;"/>ChildThread end.<br style="margin:0px;padding:0px;"/>ParentThread end.</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;">可见ParentThread线程仍等待ChildThread线程运行结束后才运行完毕，而Main线程与ParentThread线程的运行并没有保持等待。</p>
<p style="padding:0px;line-height:1.5;color:rgb(0, 0, 0);font-size:13px;margin:10px auto;text-indent:0px;"> </p>
</div></div>
<div style="margin:0px;padding:0px;clear:both;"></div>
<div style="margin:0px;padding:0px;margin-top:20px;">
<div style="margin:0px;padding:0px;margin-bottom:10px;">分类: <a href="http://www.cnblogs.com/jevo/category/461909.html" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);" target="_blank">java</a></div>
<div style="margin:0px;padding:0px;font-size:9pt;color:rgb(102, 102, 102);margin-top:0px;"></div>
<div style="margin:0px;padding:0px;"><div style="margin:0px;padding:10px 0px;margin-bottom:10px;margin-top:10px;border:1px dashed silver;font-size:12px;width:320px;text-align:center;">
        <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(45, 174, 191);color:rgb(255, 255, 255);border:none;">好文要顶</a>
            <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(227, 49, 0);color:rgb(255, 255, 255);border:none;">关注我</a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(255, 181, 21);color:rgb(255, 255, 255);border:none;">收藏该文</a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 2px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:none;text-shadow:none;background:none;color:rgb(255, 255, 255);border:none;" title="分享至新浪微博"><img src="Java异步调用模式 - Jevo - 博客园 [2]_files/icon_weibo_24.png" type="image/png" data-filename="icon_weibo_24.png" alt="" height="24" style="margin:0px;padding:0px;height:auto;border:none;vertical-align:middle;margin-left:5px;box-shadow:none;max-width:300px;" width="24"/></a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 2px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:none;text-shadow:none;background:none;color:rgb(255, 255, 255);border:none;" title="分享至微信"><img src="Java异步调用模式 - Jevo - 博客园 [2]_files/wechat.png" type="image/png" data-filename="wechat.png" alt="" height="24" style="margin:0px;padding:0px;border:medium none;width:24px;height:24px;box-shadow:none;margin-left:5px;vertical-align:middle;max-width:300px;" width="24"/></a>
</div>
<div style="margin:0px;padding:0px;float:left;width:280px;margin-top:0px;margin-bottom:10px;color:rgb(0, 0, 0);margin-left:0px;font-size:12px;">
    <div style="margin:0px;padding:0px;float:left;line-height:18px;">
            <a href="http://home.cnblogs.com/u/jevo/" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);" target="_blank"><img src="Java异步调用模式 - Jevo - 博客园 [2]_files/sample_face.gif" type="image/gif" data-filename="sample_face.gif" alt="" height="48" style="margin:0px;padding:0px;height:auto;border:0px;vertical-align:top;float:left;margin-right:5px;padding-top:5px;padding-left:2px;max-width:300px;" width="48"/></a>
        <div style="margin:0px;padding:0px;float:left;line-height:18px;">
            <a href="http://home.cnblogs.com/u/jevo/" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);">Jevo</a><br style="margin:0px;padding:0px;"/>
            <a href="http://home.cnblogs.com/u/jevo/followees" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);">关注 - 0</a><br style="margin:0px;padding:0px;"/>
            <a href="http://home.cnblogs.com/u/jevo/followers" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);">粉丝 - 21</a>
        </div>
    </div>
    <div style="margin:0px;padding:0px;clear:both;"></div>
    <div style="margin:0px;padding:0px;"></div>
    <div style="margin:0px;padding:0px;">
                <a href="#" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);">+加关注</a>
    </div>
</div>
<div style="margin:0px;padding:0px;float:right;margin-bottom:10px;margin-right:30px;font-size:12px;width:125px;text-align:center;margin-top:10px;">
    <div style="margin:0px;padding:0px;float:left;width:46px;height:52px;background:url(&quot;http://static.cnblogs.com/images/upup.gif&quot;) no-repeat;text-align:center;cursor:pointer;margin-top:2px;padding-top:5px;">
        <span style="margin:0px;padding:0px;font-size:14px;color:rgb(7, 93, 179);font-family:Verdana;line-height:1.5em;">2</span>
    </div>
    <div style="text-align:center;padding:0px;margin:0px;height:52px;background:url(&quot;http://static.cnblogs.com/images/downdown.gif&quot;) no-repeat;margin-left:20px;cursor:pointer;margin-top:2px;padding-top:5px;width:46px;float:right;">
        <span style="margin:0px;padding:0px;font-size:14px;color:rgb(7, 93, 179);font-family:Verdana;line-height:1.5em;">0</span>
    </div>
    <div style="margin:0px;padding:0px;clear:both;"></div>
    <div style="margin:0px;padding:0px;margin-top:5px;margin-left:0px;font-size:12px;color:gray;">
    </div>
</div>
</div>
<div style="margin:0px;padding:0px;clear:both;"></div>
<div style="margin:0px;padding:0px;line-height:1.8;font-size:12px;"><a href="http://www.cnblogs.com/jevo/archive/2013/04/10/3039211.html" style="margin:0px;padding:0px;color:rgb(7, 93, 179);text-decoration:none;">« </a> 上一篇：<a href="http://www.cnblogs.com/jevo/archive/2013/04/10/3039211.html" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);" title="发布于2013-04-10 23:08">Hibernate批量操作（二）</a><br style="margin:0px;padding:0px;"/><a href="http://www.cnblogs.com/jevo/archive/2013/04/12/3017518.html" style="margin:0px;padding:0px;color:rgb(7, 93, 179);text-decoration:none;">» </a> 下一篇：<a href="http://www.cnblogs.com/jevo/archive/2013/04/12/3017518.html" style="margin:0px;padding:0px;text-decoration:underline;color:rgb(7, 93, 179);" title="发布于2013-04-12 23:04">Java消息机制</a><br style="margin:0px;padding:0px;"/></div>
</div>


		</div>
		<div style="margin:0px;padding:0px;clear:both;font-size:12px;float:right;width:100%;text-align:right;padding-right:5px;color:rgb(102, 102, 102);margin-top:5px;">posted @ <span style="margin:0px;padding:0px;">2013-04-11 23:05</span> <a href="http://www.cnblogs.com/jevo/" style="margin:0px;padding:0px;text-decoration:none;color:rgb(7, 93, 179);">Jevo</a> 阅读(<span style="margin:0px;padding:0px;">11446</span>) 评论(<span style="margin:0px;padding:0px;">0</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=3015023" rel="nofollow" style="margin:0px;padding:0px;text-decoration:none;color:rgb(7, 93, 179);">编辑</a> <a href="http://www.cnblogs.com/jevo/archive/2013/04/11/3015023.html#" style="margin:0px;padding:0px;text-decoration:none;color:rgb(7, 93, 179);">收藏</a></div>
	</div></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 