<html>
<head>
  <title>漫谈Java高并发方案_慕课手记</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1492"/>
<h1>漫谈Java高并发方案_慕课手记</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/12/17 11:11</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.imooc.com/article/40842?mc_marking=c5dea9fc8382d056b2c3826e2c0b364d&mc_channel=weibo"><i>https://www.imooc.com/article/40842?mc_marking=c5dea9fc8382d056b2c3826e2c0b364d&amp;mc_channel=weibo</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="font:14px/1.5 &quot;PingFang SC&quot;, 微软雅黑, &quot;Microsoft YaHei&quot;, Helvetica, &quot;Helvetica Neue&quot;, Tahoma, Arial, sans-serif;color:rgb(28, 31, 33);"><div style="background:rgb(255, 255, 255);color:rgb(28, 31, 33);font:14px/1.5 &quot;PingFang SC&quot;, 微软雅黑, &quot;Microsoft YaHei&quot;, Helvetica, &quot;Helvetica Neue&quot;, Tahoma, Arial, sans-serif;transition:transform 0.3s ease;overflow-x:hidden;background-color:rgb(248, 250, 252);"><div><div><div><div style="background:rgb(255, 255, 255);box-shadow:rgba(7, 17, 27, 0.05) 0px 8px 16px 0px;border-radius:12px;box-sizing:border-box;">
							<div style="margin:0px;padding:0px;background:url(https://static.mukewang.com/static/img/article/original.png?t=2) 0px 0px / 64px;width:64px;height:64px;position:absolute;left:0px;top:0px;"></div>
						
			<div style="margin:0px;padding:0px;font-size:12px;color:rgb(145, 153, 161);line-height:24px;">
				<a href="https://www.imooc.com/" style="outline:0px;text-decoration:none;color:rgb(145, 153, 161);position:relative;z-index:2;cursor:pointer;" target="_blank"><i style="speak:none;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;-webkit-font-smoothing:antialiased;line-height:16px;font-size:20px;vertical-align:text-bottom;font-family:imv2;"><span style="font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:16px;font-family:imv2;font-size:20px;"></span></i></a>
				<a href="https://www.imooc.com/article" style="outline:0px;text-decoration:none;color:rgb(145, 153, 161);" target="_blank">手记</a>  /<a href="https://www.imooc.com/article/be" style="outline:0px;text-decoration:none;color:rgb(145, 153, 161);" target="_blank">后端开发</a>
			</div>
			       
			<div style="margin:0px;padding:0px;">
				<h1 style="padding:0px;font-weight:400;margin:8px 0px;font-size:32px;color:rgb(28, 31, 33);line-height:40px;word-wrap:break-word;word-break:break-all;">
					<span style="font-weight:700;">漫谈Java高并发方案</span>
				</h1>
				<div style="margin:0px;padding:0px;font-size:12px;color:rgb(145, 153, 161);line-height:24px;">
					<div style="float:left;margin:0px;padding:0px;">
						<span style="vertical-align:middle;margin-right:24px;">2018.07.03 14:20</span>
						<span style="vertical-align:middle;margin-right:24px;">2400浏览</span>
					</div>
					<div style="float:right;margin:0px;padding:0px;">
						<div style="float:left;margin:0px;padding:0px;">
																					
							
						</div> 
					</div>	
				<span style="font-size:12px;color:rgb(145, 153, 161);line-height:24px;display:block;height:0px;clear:both;visibility:hidden;"> </span></div>
			</div> 

			 
			<div style="margin:0px;padding:0px;overflow:hidden;padding-top:24px;">  
				<div style="margin:0px;padding:0px;font-size:16px;word-wrap:break-word;color:rgb(28, 31, 33);font-family:&quot;PingFang SC&quot;, 微软雅黑, &quot;Microsoft YaHei&quot;, Helvetica, &quot;Helvetica Neue&quot;, Tahoma, Arial, sans-serif;line-height:36px;">
					
					<div style="margin:0px;padding:0px;"><p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">所有示例代码,请见/下载于<br/>
<a href="https://github.com/Wasabi1234/concurrency" rel="nofollow" style="outline:0px;text-decoration:none;color:rgb(0, 136, 204);" target="_blank">https://github.com/Wasabi1234/concurrency</a><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240" type="image/png" data-filename="1240" height="348" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [1]" type="image/png" data-filename="1240" height="347" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [2]" type="image/png" data-filename="1240" height="291" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="parent_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">1 基本概念</strong>
<div style="margin:0px;padding:0px;"> <a name="child_1_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">1.1 并发</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">同时拥有两个或者多个线程，如果程序在单核处理器上运行多个线程将交替地换入或者换出内存,这些线程是同时“存在&quot;的，每个线程都处于执行过程中的某个状态，如果运行在多核处理器上,此时，程序中的每个线程都将分配到一个处理器核上，因此可以同时运行.</p>
<div style="margin:0px;padding:0px;"> <a name="child_1_2" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">1.2 高并发( High Concurrency)</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">互联网分布式系统架构设计中必须考虑的因素之一，通常是指，通过设计保证系统能够同时并行处理很多请求.</p>
<div style="margin:0px;padding:0px;"> <a name="child_1_3" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">1.3 区别与联系</strong>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">并发: 多个线程操作相同的资源，保证线程安全，合理使用资源</li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">高并发:服务能同时处理很多请求，提高程序性能</p>
<div style="margin:0px;padding:0px;"> <a name="parent_2" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">2 CPU</strong>
<div style="margin:0px;padding:0px;"> <a name="child_2_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">2.1 CPU 多级缓存</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [3]" type="image/png" data-filename="1240" height="230" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
</li>
<li style="margin:0px;padding:0px;">为什么需要CPU cache<br/>
CPU的频率太快了，快到主存跟不上<br/>
如此,在处理器时钟周期内，CPU常常需要等待主存，浪费资源。所以cache的出现，是为了缓解CPU和内存之间速度的不匹配问题(结构:cpu-&gt; cache-&gt; memory ).</li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">CPU cache的意义<br/>
1) 时间局部性<br/>
如果某个数据被访问，那么在不久的将来它很可能被再次访问<br/>
2) 空间局部性<br/>
如果某个数据被访问，那么与它相邻的数据很快也可能被访问</p>
<div style="margin:0px;padding:0px;"> <a name="child_2_2" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">2.2 缓存一致性(MESI)</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">用于保证多个 CPU cache 之间缓存共享数据的一致</p>
</li>
<li style="margin:0px;padding:0px;">M-modified被修改<br/>
该缓存行只被缓存在该 CPU 的缓存中,并且是被修改过的,与主存中数据是不一致的,需在未来某个时间点写回主存,该时间是允许在其他CPU 读取主存中相应的内存之前,当这里的值被写入主存之后,该缓存行状态变为 E</li>
<li style="margin:0px;padding:0px;">E-exclusive独享<br/>
缓存行只被缓存在该 CPU 的缓存中,未被修改过,与主存中数据一致<br/>
可在任何时刻当被其他 CPU读取该内存时变成 S 态,被修改时变为 M态</li>
<li style="margin:0px;padding:0px;">S-shared共享<br/>
该缓存行可被多个 CPU 缓存,与主存中数据一致</li>
<li style="margin:0px;padding:0px;">I-invalid无效<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [4]" type="image/png" data-filename="1240" height="378" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/></li>
<li style="margin:0px;padding:0px;">乱序执行优化<br/>
处理器为提高运算速度而做出违背代码原有顺序的优化
<div style="margin:0px;padding:0px;"> <a name="child_2_3" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">并发的优势与风险</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [5]" type="image/png" data-filename="1240" height="391" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="parent_3" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">3 项目准备</strong>
<div style="margin:0px;padding:0px;"> <a name="child_3_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">3.1 项目初始化</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [6]" type="image/png" data-filename="1240" height="422" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="574"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [7]" type="image/png" data-filename="1240" height="254" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [8]" type="image/png" data-filename="1240" height="64" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="child_3_2" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">3.2 并发模拟-Jmeter压测</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [9]" type="image/png" data-filename="1240" height="197" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [10]" type="image/png" data-filename="1240" height="166" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [11]" type="image/png" data-filename="1240" height="196" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="350"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [12]" type="image/png" data-filename="1240" height="360" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [13]" type="image/png" data-filename="1240" height="328" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="child_3_3" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">3.3 并发模拟-代码</strong>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">CountDownLatch</h3>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [14]" type="image/png" data-filename="1240" height="455" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">Semaphore(信号量)</h3>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [15]" type="image/png" data-filename="1240" height="311" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
以上二者通常和线程池搭配</p></li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">下面开始做并发模拟</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">annoations</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">NotThreadSafe</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> lombok</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">extern</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">slf4j</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Slf4j</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">/**
 * @author shishusheng
 * @date 18/4/1
 */</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@Slf4j</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@NotThreadSafe</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">ConcurrencyTest</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 请求总数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">5000</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 同时并发执行的线程数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> threadTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">200</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> count </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> main</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">String</span><span style="color:rgb(102, 102, 0);">[]</span><span style="color:rgb(0, 0, 0);"> args</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">throws</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//定义线程池</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(0, 0, 0);"> executorService </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">newCachedThreadPool</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//定义信号量,给出允许并发的线程数目</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(0, 0, 0);"> semaphore </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">threadTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//统计计数结果</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(0, 0, 0);"> countDownLatch </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">clientTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//将请求放入线程池</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">for</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">&amp;</span><span style="color:rgb(0, 0, 0);">lt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i</span><span style="color:rgb(102, 102, 0);">++)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
            executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">execute</span><span style="color:rgb(102, 102, 0);">(()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">-&amp;</span><span style="color:rgb(0, 0, 0);">gt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(0, 0, 136);">try</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    </span><span style="color:rgb(136, 0, 0);">//信号量的获取</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">acquire</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    add</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    </span><span style="color:rgb(136, 0, 0);">//释放</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">release</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">catch</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">error</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;exception&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
                countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">countDown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
            </span><span style="color:rgb(102, 102, 0);">});</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
        countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">await</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//关闭线程池</span><span style="color:rgb(0, 0, 0);">
        executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">shutdown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">info</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;count:{}&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> count</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 统计方法
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> add</span><span style="color:rgb(102, 102, 0);">()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">++;</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span></code></pre>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">运行发现结果随机,所以非线程安全</p>
<div style="margin:0px;padding:0px;"> <a name="parent_4" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">4线程安全性</strong>
<div style="margin:0px;padding:0px;"> <a name="child_4_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">4.1  线程安全性</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">当多个线程访问某个类时，不管运行时环境采用<code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;font-size:0.92857em;color:rgb(199, 37, 78);background-color:rgb(243, 243, 243);border-radius:3px;text-indent:0px;word-break:break-all;">何种调度方式</code>或者这些进程将如何交替执行，并且在主调代码中<code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;font-size:0.92857em;color:rgb(199, 37, 78);background-color:rgb(243, 243, 243);border-radius:3px;text-indent:0px;word-break:break-all;">不需要任何额外的同步或协同</code>，这个类都能表现出<code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;font-size:0.92857em;color:rgb(199, 37, 78);background-color:rgb(243, 243, 243);border-radius:3px;text-indent:0px;word-break:break-all;">正确的行为</code>，那么就称这个类是线程安全的</p>
<div style="margin:0px;padding:0px;"> <a name="child_4_2" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">4.2 原子性</strong>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.2.1 Atomic 包</h3>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">AtomicXXX:CAS,Unsafe.compareAndSwapInt<br/>
提供了互斥访问，同一时刻只能有一个线程来对它进行操作</li>
</ul>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">example</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">atomic</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">annoations</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ThreadSafe</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> lombok</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">extern</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">slf4j</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Slf4j</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">atomic</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">AtomicLong</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">/**
 * @author shishusheng
 */</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@Slf4j</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@ThreadSafe</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicExample2</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 请求总数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">5000</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 同时并发执行的线程数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> threadTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">200</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 工作内存
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicLong</span><span style="color:rgb(0, 0, 0);"> count </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicLong</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> main</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">String</span><span style="color:rgb(102, 102, 0);">[]</span><span style="color:rgb(0, 0, 0);"> args</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">throws</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(0, 0, 0);"> executorService </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">newCachedThreadPool</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(0, 0, 0);"> semaphore </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">threadTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(0, 0, 0);"> countDownLatch </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">clientTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">for</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">&amp;</span><span style="color:rgb(0, 0, 0);">lt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i</span><span style="color:rgb(102, 102, 0);">++)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
            executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">execute</span><span style="color:rgb(102, 102, 0);">(()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">-&amp;</span><span style="color:rgb(0, 0, 0);">gt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(0, 0, 136);">try</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    </span><span style="color:rgb(102, 0, 102);">System</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">out</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">println</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">acquire</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    add</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">release</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">catch</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">error</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;exception&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
                countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">countDown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
            </span><span style="color:rgb(102, 102, 0);">});</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
        countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">await</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">shutdown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">//主内存</span><span style="color:rgb(0, 0, 0);">
        log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">info</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;count:{}&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">get</span><span style="color:rgb(102, 102, 0);">());</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> add</span><span style="color:rgb(102, 102, 0);">()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">incrementAndGet</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// count.getAndIncrement();</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span></code></pre>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">example</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">atomic</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">annoations</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ThreadSafe</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> lombok</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">extern</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">slf4j</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Slf4j</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">atomic</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">AtomicReference</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">/**
 * @author shishusheng
 * @date 18/4/3
 */</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@Slf4j</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@ThreadSafe</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicExample4</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicReference</span><span style="color:rgb(0, 0, 0);"> count </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">AtomicReference</span><span style="color:rgb(102, 102, 0);">&amp;</span><span style="color:rgb(0, 0, 0);">lt</span><span style="color:rgb(102, 102, 0);">;&amp;</span><span style="color:rgb(0, 0, 0);">gt</span><span style="color:rgb(102, 102, 0);">;(</span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> main</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">String</span><span style="color:rgb(102, 102, 0);">[]</span><span style="color:rgb(0, 0, 0);"> args</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// 2</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">compareAndSet</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">2</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// no</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">compareAndSet</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">1</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// no</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">compareAndSet</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">1</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">3</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// 4</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">compareAndSet</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">2</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">4</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// no</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">compareAndSet</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 102, 102);">3</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">5</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);"> 
        log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">info</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;count:{}&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> count</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">get</span><span style="color:rgb(102, 102, 0);">());</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span></code></pre>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [16]" type="image/png" data-filename="1240" height="28" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">AtomicReference,AtomicReferenceFieldUpdater<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [17]" type="image/png" data-filename="1240" height="406" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/></li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">AtomicBoolean<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [18]" type="image/png" data-filename="1240" height="555" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
</li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">AtomicStampReference : CAS的 ABA 问题</p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.2.2 锁</h3>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">synchronized:依赖 JVM</p>
</li>
<li style="margin:0px;padding:0px;">修饰代码块:大括号括起来的代码，作用于调用的对象</li>
<li style="margin:0px;padding:0px;">修饰方法: 整个方法，作用于调用的对象<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [19]" type="image/png" data-filename="1240" height="324" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/></li>
<li style="margin:0px;padding:0px;">修饰静态方法:整个静态方法，作用于所有对象<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [20]" type="image/png" data-filename="1240" height="319" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/></li>
</ul>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">example</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">count</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">annoations</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ThreadSafe</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> lombok</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">extern</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">slf4j</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Slf4j</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> java</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">util</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrent</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">/**
 * @author shishusheng
 */</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@Slf4j</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@ThreadSafe</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountExample3</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 请求总数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">5000</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 同时并发执行的线程数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> threadTotal </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">200</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> count </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> main</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">String</span><span style="color:rgb(102, 102, 0);">[]</span><span style="color:rgb(0, 0, 0);"> args</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">throws</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 0, 102);">ExecutorService</span><span style="color:rgb(0, 0, 0);"> executorService </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Executors</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">newCachedThreadPool</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(0, 0, 0);"> semaphore </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">Semaphore</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">threadTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">final</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(0, 0, 0);"> countDownLatch </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">CountDownLatch</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">clientTotal</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">for</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 136);">int</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 102, 102);">0</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i </span><span style="color:rgb(102, 102, 0);">&amp;</span><span style="color:rgb(0, 0, 0);">lt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> clientTotal </span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> i</span><span style="color:rgb(102, 102, 0);">++)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
            executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">execute</span><span style="color:rgb(102, 102, 0);">(()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">-&amp;</span><span style="color:rgb(0, 0, 0);">gt</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(0, 0, 136);">try</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">acquire</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    add</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                    semaphore</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">release</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">catch</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">Exception</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">error</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;exception&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> e</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
                countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">countDown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
            </span><span style="color:rgb(102, 102, 0);">});</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
        countDownLatch</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">await</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        executorService</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">shutdown</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
        log</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">info</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 136, 0);">&quot;count:{}&quot;</span><span style="color:rgb(102, 102, 0);">,</span><span style="color:rgb(0, 0, 0);"> count</span><span style="color:rgb(102, 102, 0);">);</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">synchronized</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">void</span><span style="color:rgb(0, 0, 0);"> add</span><span style="color:rgb(102, 102, 0);">()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        count</span><span style="color:rgb(102, 102, 0);">++;</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span></code></pre>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">synchronized 修正计数类方法</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">修饰类:括号括起来的部分，作用于所有对象<br/>
子类继承父类的被 synchronized 修饰方法时,是没有 synchronized 修饰的!!!</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">Lock: 依赖特殊的 CPU 指令,代码实现 </p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.2.3  对比</h3>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">synchronized: 不可中断锁，适合竞争不激烈，可读性好</li>
<li style="margin:0px;padding:0px;">Lock: 可中断锁，多样化同步，竞争激烈时能维持常态</li>
<li style="margin:0px;padding:0px;">Atomic: 竞争激烈时能维持常态，比Lock性能好; 只能同步一<br/>
个值
<div style="margin:0px;padding:0px;"> <a name="child_4_3" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">4.3 可见性</strong>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">一个线程对主内存的修改可以及时的被其他线程观察到</p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.3.1 导致共享变量在线程间不可见的原因</h3></li>
<li style="margin:0px;padding:0px;">线程交叉执行</li>
<li style="margin:0px;padding:0px;">重排序结合线程交叉执行</li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">共享变量更新后的值没有在工作内存与主存间及时更新</p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.3.2 可见性之synchronized</h3>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">JMM关于synchronized的规定</p>
</li>
<li style="margin:0px;padding:0px;">线程解锁前，必须把共享变量的最新值刷新到主内存</li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">线程加锁时，将清空工作内存中共享变量的值，从而使<br/>
用共享变量时需要从主内存中重新读取最新的值(<code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;font-size:0.92857em;color:rgb(199, 37, 78);background-color:rgb(243, 243, 243);border-radius:3px;text-indent:0px;word-break:break-all;">加锁与解锁是同一把锁</code>)</p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.3.3 可见性之volatile</h3>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">通过加入内存屏障和禁止重排序优化来实现</p>
</li>
<li style="margin:0px;padding:0px;">对volatile变量写操作时，会在写操作后加入一条store<br/>
屏障指令，将本地内存中的共享变量值刷新到主内存</li>
<li style="margin:0px;padding:0px;">对volatile变量读操作时，会在读操作前加入一条load<br/>
屏障指令，从主内存中读取共享变量<br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [21]" type="image/png" data-filename="1240" height="298" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [22]" type="image/png" data-filename="1240" height="314" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [23]" type="image/png" data-filename="1240" height="547" style="border:0px;margin:10px 0px -16px;max-width:576px;position:static;cursor:pointer;display:inline;" title="漫谈Java高并发方案_" width="576"/></li>
<li style="margin:0px;padding:0px;">volatile使用</li>
</ul>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">volatile</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">boolean</span><span style="color:rgb(0, 0, 0);"> inited </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">false</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">//线程1:</span><span style="color:rgb(0, 0, 0);">
context </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> loadContext</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
inited</span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">true</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">// 线程2:</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">while</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">!</span><span style="color:rgb(0, 0, 0);">inited </span><span style="color:rgb(102, 102, 0);">){</span><span style="color:rgb(0, 0, 0);">
    sleep</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
doSomethingWithConfig</span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">context</span><span style="color:rgb(102, 102, 0);">)</span></code></pre>
<div style="margin:0px;padding:0px;"> <a name="child_4_4" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">4.4 有序性</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">一个线程观察其他线程中的指令执行顺序，由于指令重排序的存在，该观察结果一般杂乱无序</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">JMM允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，却会影响到多线程并发执行的正确性</p>
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">4.4.1 happens-before 规则</h3>
<div style="margin:0px;padding:0px;"> <a name="parent_5" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">5发布对象</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [24]" type="image/png" data-filename="1240" height="148" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [25]" type="image/png" data-filename="1240" height="418" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [26]" type="image/png" data-filename="1240" height="589" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="child_5_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">5.1 安全发布对象</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [27]" type="image/png" data-filename="1240" height="209" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [28]" type="image/png" data-filename="1240" height="680" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [29]" type="image/png" data-filename="1240" height="484" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [30]" type="image/png" data-filename="1240" height="612" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">example</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">singleton</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(0, 0, 136);">import</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">annoations</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(102, 0, 102);">NotThreadSafe</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

</span><span style="color:rgb(136, 0, 0);">/**
 * 懒汉模式 -》 双重同步锁单例模式
 * 单例实例在第一次使用时进行创建
 * @author shishusheng
 */</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 102, 102);">@NotThreadSafe</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 私有构造函数
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(102, 102, 0);">()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">// 1、memory = allocate() 分配对象的内存空间</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(136, 0, 0);">// 2、ctorInstance() 初始化对象</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(136, 0, 0);">// 3、instance = memory 设置instance指向刚分配的内存</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">// JVM和cpu优化，发生了指令重排</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">// 1、memory = allocate() 分配对象的内存空间</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(136, 0, 0);">// 3、instance = memory 设置instance指向刚分配的内存</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(136, 0, 0);">// 2、ctorInstance() 初始化对象</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 单例对象
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">private</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(0, 0, 0);"> instance </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">null</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">

    </span><span style="color:rgb(136, 0, 0);">/**
     * 静态的工厂方法
     *
     * @return
     */</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(0, 0, 136);">public</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">static</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(0, 0, 0);"> getInstance</span><span style="color:rgb(102, 102, 0);">()</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(136, 0, 0);">// 双重检测机制 // B</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">if</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">instance </span><span style="color:rgb(102, 102, 0);">==</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">null</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">        
            </span><span style="color:rgb(136, 0, 0);">// 同步锁</span><span style="color:rgb(0, 0, 0);">
            </span><span style="color:rgb(0, 0, 136);">synchronized</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 136);">class</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);"> 
                </span><span style="color:rgb(0, 0, 136);">if</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">(</span><span style="color:rgb(0, 0, 0);">instance </span><span style="color:rgb(102, 102, 0);">==</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">null</span><span style="color:rgb(102, 102, 0);">)</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 102, 0);">{</span><span style="color:rgb(0, 0, 0);">
                    </span><span style="color:rgb(136, 0, 0);">// A - 3</span><span style="color:rgb(0, 0, 0);">
                    instance </span><span style="color:rgb(102, 102, 0);">=</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(0, 0, 136);">new</span><span style="color:rgb(0, 0, 0);"> </span><span style="color:rgb(102, 0, 102);">SingletonExample4</span><span style="color:rgb(102, 102, 0);">();</span><span style="color:rgb(0, 0, 0);"> 
                </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
            </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
        </span><span style="color:rgb(0, 0, 136);">return</span><span style="color:rgb(0, 0, 0);"> instance</span><span style="color:rgb(102, 102, 0);">;</span><span style="color:rgb(0, 0, 0);">
    </span><span style="color:rgb(102, 102, 0);">}</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">}</span></code></pre>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [31]" type="image/png" data-filename="1240" height="513" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/><br/>
<img src="漫谈Java高并发方案_慕课手记_files/1240 [32]" type="image/png" data-filename="1240" height="636" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<div style="margin:0px;padding:0px;"> <a name="parent_6" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:25px;padding-bottom:8px;">7 AQS</strong>
<div style="margin:0px;padding:0px;"> <a name="child_6_1" style="outline:0px;"></a></div> <strong style="font-style:inherit;font-weight:700;margin-top:2px;display:block;font-size:22px;margin:22px 0 10px;">7.1 介绍</strong>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;"><img src="漫谈Java高并发方案_慕课手记_files/1240 [33]" type="image/png" data-filename="1240" height="290" style="border:0px;margin:10px auto 14px;position:static;max-width:576px;cursor:pointer;display:block;transform:none;" title="漫谈Java高并发方案_" width="576"/></p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">使用Node实现FIFO队列，可以用于构建锁或者其他同步装置的基础框架</li>
<li style="margin:0px;padding:0px;">利用了一个int类型表示状态</li>
<li style="margin:0px;padding:0px;">使用方法是继承</li>
<li style="margin:0px;padding:0px;">子类通过继承并通过实现它的方法管理其状态{acquire 和release} 的方法操纵状态</li>
<li style="margin:0px;padding:0px;">可以同时实现排它锁和共享锁模式(独占、共享)<br/>
同步组件
<h3 style="padding:0px;line-height:32px;margin:22px 0px 10px;font-size:1.14286em;font-weight:700;font-family:inherit;">CountDownLatch</h3>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(0, 0, 136);">package</span><span style="color:rgb(0, 0, 0);"> com</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">mmall</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">concurrency</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">example</span><span style="color:rgb(102, 102, 0);">.</span><span style="color:rgb(0, 0, 0);">aqs</span><span style="color:rgb(102, 102, 0);">;</span></code></pre></li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import lombok.extern.slf4j.Slf4j;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import java.util.concurrent.CountDownLatch;<br/>
import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">/**</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">@author shishusheng<br/>
*/<br/>
@Slf4j<br/>
public class CountDownLatchExample1 {</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private final static int threadCount = 200;</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">public static void main(String[] args) throws Exception {</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;">ExecutorService exec = Executors.newCachedThreadPool();

final CountDownLatch countDownLatch = new CountDownLatch(threadCount);

for (int i = 0; i &amp;lt; threadCount; i++) {
    final int threadNum = i;
    exec.execute(() -&amp;gt; {
        try {
            test(threadNum);
        } catch (Exception e) {
            log.error(&quot;exception&quot;, e);
        } finally {
            countDownLatch.countDown();
        }
    });
}
countDownLatch.await();
log.info(&quot;finish&quot;);
exec.shutdown();</code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">}</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static void test(int threadNum) throws Exception {<br/>
Thread.sleep(100);<br/>
log.info(&quot;{}&quot;, threadNum);<br/>
Thread.sleep(100);<br/>
}<br/>
}</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"></code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">package com.mmall.concurrency.example.aqs;</p>
</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import lombok.extern.slf4j.Slf4j;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import java.util.concurrent.CountDownLatch;<br/>
import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;<br/>
import java.util.concurrent.TimeUnit;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">/**</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">指定时间内处理任务</li>
<li style="margin:0px;padding:0px;">
</li>
<li style="margin:0px;padding:0px;">@author shishusheng </li>
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">*/<br/>
@Slf4j<br/>
public class CountDownLatchExample2 {</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private final static int threadCount = 200;</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">public static void main(String[] args) throws Exception {</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;">ExecutorService exec = Executors.newCachedThreadPool();

final CountDownLatch countDownLatch = new CountDownLatch(threadCount);

for (int i = 0; i &amp;lt; threadCount; i++) {
    final int threadNum = i;
    exec.execute(() -&amp;gt; {
        try {
            test(threadNum);
        } catch (Exception e) {
            log.error(&quot;exception&quot;, e);
        } finally {
            countDownLatch.countDown();
        }
    });
}
countDownLatch.await(10, TimeUnit.MILLISECONDS);
log.info(&quot;finish&quot;);
exec.shutdown();</code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">}</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static void test(int threadNum) throws Exception {<br/>
Thread.sleep(100);<br/>
log.info(&quot;{}&quot;, threadNum);<br/>
}<br/>
}</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(136, 0, 0);">##Semaphore用法</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-e6cbcd4254c642c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-dbefbf2c76ad5a2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-41f5f5a5fd135804.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">##CycliBarrier</span></code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">package com.mmall.concurrency.example.aqs;</p>
</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import lombok.extern.slf4j.Slf4j;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import java.util.concurrent.CyclicBarrier;<br/>
import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">/**</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">@author shishusheng<br/>
*/<br/>
@Slf4j<br/>
public class CyclicBarrierExample1 {</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static CyclicBarrier barrier = new CyclicBarrier(5);</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">public static void main(String[] args) throws Exception {</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;">ExecutorService executor = Executors.newCachedThreadPool();

for (int i = 0; i &amp;lt; 10; i++) {
    final int threadNum = i;
    Thread.sleep(1000);
    executor.execute(() -&amp;gt; {
        try {
            race(threadNum);
        } catch (Exception e) {
            log.error(&quot;exception&quot;, e);
        }
    });
}
executor.shutdown();</code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">}</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static void race(int threadNum) throws Exception {<br/>
Thread.sleep(1000);<br/>
log.info(&quot;{} is ready&quot;, threadNum);<br/>
barrier.await();<br/>
log.info(&quot;{} continue&quot;, threadNum);<br/>
}<br/>
}</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-4fb51fa4926fd70e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">package com.mmall.concurrency.example.aqs;</p>
</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import lombok.extern.slf4j.Slf4j;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import java.util.concurrent.CyclicBarrier;<br/>
import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;<br/>
import java.util.concurrent.TimeUnit;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">/**</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">@author shishusheng<br/>
*/<br/>
@Slf4j<br/>
public class CyclicBarrierExample2 {</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static CyclicBarrier barrier = new CyclicBarrier(5);</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">public static void main(String[] args) throws Exception {</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;">ExecutorService executor = Executors.newCachedThreadPool();

for (int i = 0; i &amp;lt; 10; i++) {
    final int threadNum = i;
    Thread.sleep(1000);
    executor.execute(() -&amp;gt; {
        try {
            race(threadNum);
        } catch (Exception e) {
            log.error(&quot;exception&quot;, e);
        }
    });
}
executor.shutdown();</code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">}</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static void race(int threadNum) throws Exception {<br/>
Thread.sleep(1000);<br/>
log.info(&quot;{} is ready&quot;, threadNum);<br/>
try {<br/>
barrier.await(2000, TimeUnit.MILLISECONDS);<br/>
} catch (Exception e) {<br/>
log.warn(&quot;BarrierException&quot;, e);<br/>
}<br/>
log.info(&quot;{} continue&quot;, threadNum);<br/>
}<br/>
}</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(102, 102, 0);">![</span><span style="color:rgb(0, 0, 0);">await </span><span style="color:rgb(102, 102, 0);">超时导致程序抛异常](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-0f899c23531f8ee8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">package com.mmall.concurrency.example.aqs;</p>
</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import lombok.extern.slf4j.Slf4j;</p>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">import java.util.concurrent.ExecutorService;<br/>
import java.util.concurrent.Executors;<br/>
import java.util.concurrent.Semaphore;<br/>
/**</p>
<ul style="padding:0px;margin:0.8em 0px;list-style:disc;padding-left:30px;">
<li style="margin:0px;padding:0px;">
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin:0.6em 0px;margin-top:0px;">@author shishusheng<br/>
*/<br/>
@Slf4j<br/>
public class SemaphoreExample3 {</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private final static int threadCount = 20;</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">public static void main(String[] args) throws Exception {</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;">ExecutorService exec = Executors.newCachedThreadPool();

final Semaphore semaphore = new Semaphore(3);

for (int i = 0; i &amp;lt; threadCount; i++) {
    final int threadNum = i;
    exec.execute(() -&amp;gt; {
        try {
            // 尝试获取一个许可
            if (semaphore.tryAcquire()) {
                test(threadNum);
                // 释放一个许可
                semaphore.release();
            }
        } catch (Exception e) {
            log.error(&quot;exception&quot;, e);
        }
    });
}
exec.shutdown();</code></pre>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">}</p>
<p style="padding:0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;margin:0.6em 0px;">private static void test(int threadNum) throws Exception {<br/>
log.info(&quot;{}&quot;, threadNum);<br/>
Thread.sleep(1000);<br/>
}</p>
</li>
</ul>
<p style="padding:0px;margin:0.8em 0px;text-indent:0px;line-height:1.75;color:rgb(28, 31, 33);overflow-x:auto;margin-bottom:14px;margin-top:0px;">}</p>
<pre style="word-wrap:break-word;margin:0.8em 0px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;display:block;font-size:0.92857em;line-height:1.3;color:rgb(51, 51, 51);word-break:break-all;padding:10px;border-radius:4px;text-indent:0px;position:relative;border:none;overflow:auto;margin-top:25px;background-color:rgb(238, 238, 238);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;margin:0px;font-style:normal;font-weight:400;padding:0px;color:rgb(199, 37, 78);border-radius:3px;text-indent:0px;word-break:break-all;font-size:1em;background-color:transparent;"><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">#9 线程池</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">##9.1 newCachedThreadPool</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-1122da7a48223ba1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">##9.2 newFixedThreadPool</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-0ea942bf12e5210f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">##9.3 newSingleThreadExecutor</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">看出是顺序执行的</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-989d59429f589403.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">##9.4 newScheduledThreadPool</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-f7536ec7a1cf6ecc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-c90e09d5bfe707e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(136, 0, 0);">#10 死锁</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-461f6a4251ae8ca4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span><span style="color:rgb(0, 0, 0);">
</span><span style="color:rgb(102, 102, 0);">![](</span><span style="color:rgb(0, 0, 0);">https</span><span style="color:rgb(102, 102, 0);">:</span><span style="color:rgb(136, 0, 0);">//upload-images.jianshu.io/upload_images/4685968-46d58773e597195f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</span></code></pre></div>
					<div style="margin:0px;padding:0px;">
						<div style="margin:0px;padding:0px;"></div>
						
					</div>
				</div>
				
												<div style="margin:0px;padding:0px;margin-top:24px;width:100%;text-align:center;">
					<div style="margin:0px;padding:0px;display:inline-block;">
																		<a href="https://www.imooc.com/article/tag/3" style="margin-right:12px;text-decoration:none;float:left;outline:0px;display:inline-block;color:rgb(84, 92, 99);padding:4px 12px;background:rgba(84, 92, 99, 0.1);border-radius:12px;font-size:12px;line-height:16px;" target="_blank">JAVA</a>
																		<a href="https://www.imooc.com/article/tag/67" style="margin-right:12px;text-decoration:none;float:left;outline:0px;display:inline-block;color:rgb(84, 92, 99);padding:4px 12px;background:rgba(84, 92, 99, 0.1);border-radius:12px;font-size:12px;line-height:16px;" target="_blank">面试</a>
																		<a href="https://www.imooc.com/article/tag/76" style="margin-right:12px;text-decoration:none;float:left;outline:0px;display:inline-block;color:rgb(84, 92, 99);padding:4px 12px;background:rgba(84, 92, 99, 0.1);border-radius:12px;font-size:12px;line-height:16px;" target="_blank">架构</a>
											<span style="display:block;height:0px;clear:both;visibility:hidden;"> </span></div>
											<div style="margin:0px;padding:0px;">
							<p style="margin:0px;padding:0px;margin-top:8px;text-align:center;font-size:12px;color:rgb(145, 153, 161);line-height:18px;display:inline-block;">本文原创发布于慕课网 ，转载请注明出处，谢谢合作</p>    
						</div>                    
					                    				</div>
								 
				<div style="padding:0px;margin:48px 0px 0px;position:relative;width:100%;text-align:center;">
										
										<div style="margin:0px;padding:0px;margin-top:4px;font-size:14px;color:rgb(84, 92, 99);line-height:22px;cursor:pointer;"><em style="font-style:normal;font-weight:400;">16</em>人点赞</div>
					
				</div>
				
			</div>

			
		</div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 