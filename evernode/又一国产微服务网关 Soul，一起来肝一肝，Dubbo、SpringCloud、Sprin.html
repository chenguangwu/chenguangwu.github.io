<html>
<head>
  <title>又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、SpringBoot 全支持！</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="15439"/>
<h1>又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、SpringBoot 全支持！</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/5/27 14:30</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247492169&idx=1&sn=4c9f3109ccb5a923031016c5d7268caf&chksm=fa4a9df8cd3d14ee818f8db11e78517ffa5646070a9038d2e81bcb89a8cc2cdaba1aaecbc16c#rd"><i>http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247492169&amp;idx=1&amp;sn=4c9f3109ccb5a923031016c5d7268caf&amp;chksm=fa4a9df8cd3d14ee818f8db11e78517ffa5646070a9038d2e81bcb89a8cc2cdaba1aaecbc16c#rd</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div><div><div><div><h1> 又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、SpringBoot 全支持！ </h1><div><div></div></div></div>
                <div>
                                                                
                                                                                            <span>
                                                                    老艿艿
                                                            </span>
                                                                
                                        
                    <em>昨天</em>
                </div>

                
                                                                

                
                                


                
                
                
                
                                                
                                                                
                                
                

                
                                
                
                
                    

                    

                    
                    
                    <br/><br/><blockquote><p>摘要: 原创出处 http://www.iocoder.cn/Soul/install/ 「芋道源码」欢迎转载，保留摘要，谢谢！</p></blockquote><ul><li><div>1. 概述</div></li><li><div>2. 单机部署</div></li><li><div>3. 接入 Dubbo 应用</div></li><li><div>4. 接入 Spring Boot 应用</div></li><li><div>5. 接入 Spring Cloud 应用</div></li><li><div>6. rateLimiter 插件</div></li><li><div>7. hystrix 插件</div></li><li><div>666. 彩蛋</div></li></ul><hr/><h1>1. 概述</h1><p>Soul 是基于 WebFlux 实现的<strong>响应式</strong>的 API 网关，具有异步、高性能、跨语言等特点。</p><blockquote><p>作者：我希望能够有一样东西像<strong>灵魂</strong>一样，保护您的微服务。在参考了 Kong、Spring Cloud Gateway 等优秀的网关后，站在巨人的肩膀上，Soul 由此诞生！</p><p>作者是艿艿的大表弟，胖友信么？！</p></blockquote><p>目前 Soul 功能列表如下：</p><ul><li><div><p>支持各种语言，无缝集成到 Dubbo、Spring Cloud、Spring Boot 中。</p><blockquote><p>Soul 是极其少支持 Dubbo 的 API 网关，通过 Dubbo 泛化调用 实现。</p></blockquote></div></li><li><div><p>丰富的<strong>插件</strong>支持，鉴权，限流，熔断，防火墙等等。</p></div></li><li><div><p>网关多种规则动态配置，支持各种策略配置。</p></div></li><li><div><p>插件热插拔，易扩展。</p></div></li><li><div><p>支持集群部署，支持 A/B Test。</p></div></li></ul><p>整体架构如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640.png" type="image/png" data-filename="640.png" height="379" width="576"/></div><div>架构图</div></div><p>是不是看着就贼酷炫，实际一脸懵逼。不要慌~我们先来搭建 Soul 网关。</p><h1>2. 单机部署</h1><p>本小节，我们来单机部署一个 Soul 服务，适合<strong>测试</strong>环境。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [1].png" type="image/png" data-filename="640.png" height="253" width="576"/></div><div>Soul 单机部署</div></div><h2>2.1 MySQL 安装</h2><p>相信大家都会，艿艿就不瞎哔哔了。嘿嘿~注意，目前最好安装 <strong>5.X</strong> 版本，艿艿一开始用 8.X 存在报错的情况。</p><p>安装完成后，创建 <code>soul</code> 数据库。</p><h2>2.2 Soul Admin 安装</h2><p>Soul Admin <strong>控制台</strong>，负责维护网关的元数据、<strong>配置</strong>等等，并提供给 Soul Bootstrap <strong>网关服务</strong>读取。</p><blockquote><p>友情提示：后续推荐胖友阅读如下两篇文章，搞懂 Soul Admin 和 Soul Bootstrap 的同步的原理：</p><ul><li><div>《Soul 文档 —— 数据配置流程》</div></li><li><div>《Soul 文档 —— 数据同步原理》</div></li></ul></blockquote><p>① 从 https://yu199195.github.io/jar/soul-admin.jar 下载<strong>启动 jar 包</strong>。</p><pre><code># 创建目录<br/>$ mkdir -p /Users/yunai/Soul<br/>$ cd /Users/yunai/Soul<br/><br/># 下载<br/>$ wget  https://yu199195.github.io/jar/soul-admin.jar<br/></code></pre><p>② 通过 <code>java -jar soul-admin.jar</code> 命令启动 Soul Admin 控制台。完整命令如下：</p><pre><code>$ java -jar soul-admin.jar --spring.datasource.url=&quot;jdbc:mysql://s1.iocoder.cn:3306/soul?useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;failOverReadOnly=false&amp;autoReconnect=true&amp;useSSL=false&quot; --spring.datasource.username='root' --spring.datasource.password='3WLiVUBEwTbvAfsh'<br/></code></pre><ul><li><div><code>--spring.datasource.url</code> 配置项，修改成胖友的数据库<strong>地址</strong>。</div></li><li><div><code>--spring.datasource.username</code> 配置项，修改成胖友的数据库<strong>账号</strong>。</div></li><li><div><code>--spring.datasource.password</code> 配置项，修改成胖友的数据库<strong>密码</strong>。</div></li></ul><p>Soul Admin 会<strong>自动</strong>创建数据库，以及表结构，并初始化默认数据。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [2].png" type="image/png" data-filename="640.png" height="221" width="576"/></div><div><code>soul</code> 数据库</div></div><blockquote><p>友情提示：具体的数据库设计，后续可以看看《Soul 文档 —— 数据库设计》。</p></blockquote><p>③ 启动完成后，我们可以通过日志看到 Soul Admin 启动在 <strong>9095</strong> 端口。使用浏览器，访问 http://127.0.0.1:9095/ 地址，进入登录页。</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [3].png" type="image/png" data-filename="640.png" height="182" width="576"/></div><div>Soul Admin - 登录页</div></div><p>默认内置管理员账号「<strong>admin/123456</strong>」。输入账号密码，进入首页。</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [4].png" type="image/png" data-filename="640.png" height="247" width="576"/></div><div>Soul Admin - 首页</div></div><p>胖友可以自己随便点点，简单了解下有哪些功能。</p><h2>2.3 Soul Bootstrap 安装</h2><p>Soul Bootstrap <strong>网关服务</strong>，负责启动网关，并转发请求到后端服务。</p><p>① 从 https://yu199195.github.io/jar/soul-bootstrap.jar 下载<strong>启动 jar 包</strong>。</p><pre><code>$ wget https://yu199195.github.io/jar/soul-bootstrap.jar<br/></code></pre><p>② 直接通过 <code>java -jar soul-bootstrap.jar</code> 命令启动 Soul Bootstrap 网关服务。完整命令如下：</p><pre><code>$ java -jar soul-bootstrap.jar --soul.sync.websocket.url=&quot;ws://localhost:9095/websocket&quot;<br/></code></pre><ul><li><div><code>--spring.datasource.url</code> 配置项，修改成胖友的 Soul Admin 地址。</div></li></ul><p>同时，我们在 Soul <strong>Admin</strong> 的日志输出如下日志，说明 Soul <strong>Bootstrap</strong> 成功连接上。</p><pre><code>2020-05-22 20:32:48.005  INFO 48891 --- [0.0-9095-exec-1] o.d.s.a.l.websocket.WebsocketCollector   : websocket on open successful....<br/></code></pre><p>③ 启动完成后，我们可以通过日志看到 Soul Bootstrap 启动在 <strong>9195</strong> 端口。使用浏览器，访问 http://127.0.0.1:9195/ 地址，返回如下结果，说明启动成功。</p><pre><code>{<br/>    &quot;code&quot;: -100,<br/>    &quot;message&quot;: &quot;您的参数错误,请检查相关文档!&quot;,<br/>    &quot;data&quot;: null<br/>}<br/></code></pre><h2>2.4 下一步</h2><p>至此，我们已经完成了 Soul 服务的单机部署，是不是挺简单的。下面，胖友可以根据自己的需要，阅读如下小节：</p><ul><li><div>「3. 接入 Dubbo 应用」</div></li><li><div>「4. 接入 Spring Boot 应用」</div></li><li><div>「5. 接入 Spring Cloud 应用」</div></li></ul><h1>3. 接入 Dubbo 应用</h1><blockquote><p>示例代码对应仓库：<code>lab-60-soul-dubbo-demo-user-service</code></p></blockquote><p>本小节，我们参考《Soul 文档 —— Dubbo 用户接入》文章，接入 Soul 服务网关。整个示例架构如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [5].png" type="image/png" data-filename="640.png" height="297" width="576"/></div><div>示例的整体架构</div></div><p>下面，我们来开始正式接入 Dubbo 应用。</p><h2>3.1 设置 dubbo 插件</h2><p>先需要设置 dubbo 插件 的<strong>注册中心</strong>，因为 Soul Bootstrap 服务网关需要从<strong>注册中心</strong>获取到 Dubbo 服务的实例列表。</p><p>① 使用浏览器，访问 http://127.0.0.1:9095/#/system/plugin 地址，进入「系统管理 -&gt; 插件管理」菜单，可以看到 dubbo 插件。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [6].png" type="image/png" data-filename="640.png" height="269" width="576"/></div><div>系统管理 -&gt; 插件管理</div></div><p>② 点击 dubbo 插件的「编辑」按钮，设置注册中心的配置。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [7].png" type="image/png" data-filename="640.png" height="522" width="576"/></div><div>系统管理 -&gt; 插件管理 -&gt; 编辑</div></div><ul><li><div>因为我们将使用 Nacos 作为 Dubbo 服务的注册中心，所以这里设置为 <code>{&quot;register&quot;:&quot;nacos://localhost:8848&quot;}</code>。</div></li><li><div>如果胖友使用 Zookeeper 作为 Dubbo 服务的注册中心，所以这里设置为 <code>{&quot;register&quot;:&quot;zookeeper://localhost:2181&quot;}</code>。</div></li></ul><blockquote><p>友情提示：注册中心的地址，记得要填写正确哈~</p></blockquote><p>③ 因为 Soul Bootstrap 和 Soul Admin 暂时不支持插件修改的<strong>自动加载</strong>，所以我们此时需要<strong>手动重启</strong>下。</p><h2>3.2 搭建 Dubbo 示例项目</h2><p>先快速搭建一个 Dubbo 示例项目，暂未接入 Soul 网关。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [8].png" type="image/png" data-filename="640.png" height="323" width="576"/></div><div>项目结构</div></div><ul><li><div><code>lab-60-soul-dubbo-demo-user-service-api</code></div></li><li><div><code>lab-60-soul-dubbo-demo-user-service</code></div></li></ul><blockquote><p>友情提示：如果胖友对 Dubbo + Nacos 不了解的胖友，可以阅读《芋道 Spring Boot Dubbo 入门》文章。</p></blockquote><p>下面，我们来将它改造接入 Soul 网关。</p><h3>3.2.1 引入依赖</h3><p>修改 <code>pom.xml</code> 文件，引入 <code>soul-client-apache-dubbo</code> 依赖，它是 Soul 对 Apache Dubbo <strong>2.7.X</strong> 的集成支持。</p><pre><code>&lt;!-- 引入 Soul 针对 Dubbo 的集成的依赖 --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.dromara&lt;/groupId&gt;<br/>    &lt;artifactId&gt;soul-client-apache-dubbo&lt;/artifactId&gt;<br/>    &lt;version&gt;2.1.2-RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;<br/></code></pre><blockquote><p>友情提示：如果胖友使用 Alibaba Dubbo <strong>2.6.X</strong> 的话，引入 <code>soul-client-alibaba-dubbo</code> 依赖。</p></blockquote><h3>3.2.2 配置文件</h3><p>修改 <code>application.yaml</code> 配置文件，添加 Soul 配置项如下：</p><pre><code>soul:<br/>  # Soul 针对 Dubbo 的配置项，对应 DubboConfig 配置类<br/>  dubbo:<br/>    admin-url: http://127.0.0.1:9095 # Soul Admin 地址<br/>    context-path: /user-api # 设置在 Soul 网关的路由前缀，例如说 /order、/product 等等。<br/>                            # 后续，网关会根据该 context-path 来进行路由<br/>    app-name: user-service # 应用名。未配置情况下，默认使用 Dubbo 的应用名<br/></code></pre><p><code>soul.dubbo</code> 配置项，Soul 对 Dubbo 的配置项，对应 DubboConfig 配置类。具体每个配置项的作用，胖友自己看配置项后的注释。</p><h3>3.2.3 UserServiceImpl</h3><p>需要在 Dubbo Service <strong>实现类</strong>的<strong>方法上</strong>，添加 <code>@SoulClient</code> 注解，用于设置每个 Dubbo 方法对应的<strong>请求路径</strong>。这里，我们修改 UserServiceImpl 类，添加该注解。代码如下：</p><pre><code>@org.apache.dubbo.config.annotation.Service(version = &quot;1.0.0&quot;)<br/>public class UserServiceImpl implements UserService {<br/><br/>private Logger logger = LoggerFactory.getLogger(getClass());<br/><br/>@Override<br/>    @SoulClient(path = &quot;/user/get&quot;, desc = &quot;获得用户详细&quot;)<br/>    public String getUser(Integer id) {<br/>        return &quot;User:&quot; + id;<br/>    }<br/><br/>@Override<br/>    @SoulClient(path = &quot;/user/create&quot;, desc = &quot;创建用户&quot;)<br/>    public Integer createUser(UserCreateDTO createDTO) {<br/>        logger.info(&quot;[createUser][username({}) password({})]&quot;, createDTO.getNickname(), createDTO.getGender());<br/>        return 1;<br/>    }<br/><br/>}<br/></code></pre><p><code>@SoulClient</code> 注解一共有三个属性：</p><ul><li><div><code>path</code>：映射的 HTTP 接口的请求路径。</div></li><li><div><code>desc</code>：接口的描述，便于知道其用途。</div></li><li><div><code>enable</code>：是否开启，默认为 <code>true</code> 开启。</div></li></ul><p>后续，在 Dubbo 服务启动时，Soul Client 会自动解析 <code>@SoulClient</code> 注解的 Dubbo 方法，写入方法的<strong>元数据</strong>到 Soul Admin 控制台，最终通知到 Soul Bootstrap 服务网关上。</p><h2>3.3 简单测试</h2><p>① 执行 UserServiceApplication 启动 Dubbo 服务。在 IDEA 控制台可以看到如下日志，看到写入 Dubbo 方法的<strong>元数据</strong>到 Soul Admin 控制台。</p><pre><code>2020-05-23 01:27:56.682  INFO 54370 --- [pool-2-thread-1] .d.s.c.d.s.DubboServiceBeanPostProcessor : dubbo client register success :{} {&quot;appName&quot;:&quot;user-service&quot;,&quot;path&quot;:&quot;/user-api/user/get&quot;,&quot;pathDesc&quot;:&quot;获得用户详细&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;cn.iocoder.springboot.lab60.userservice.api.UserService&quot;,&quot;methodName&quot;:&quot;getUser&quot;,&quot;parameterTypes&quot;:&quot;java.lang.Integer&quot;,&quot;rpcExt&quot;:&quot;{\&quot;version\&quot;:\&quot;1.0.0\&quot;}&quot;,&quot;enabled&quot;:true}<br/>2020-05-23 01:27:56.944  INFO 54370 --- [pool-2-thread-1] .d.s.c.d.s.DubboServiceBeanPostProcessor : dubbo client register success :{} {&quot;appName&quot;:&quot;user-service&quot;,&quot;path&quot;:&quot;/user-api/user/create&quot;,&quot;pathDesc&quot;:&quot;创建用户&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;cn.iocoder.springboot.lab60.userservice.api.UserService&quot;,&quot;methodName&quot;:&quot;createUser&quot;,&quot;parameterTypes&quot;:&quot;cn.iocoder.springboot.lab60.userservice.api.dto.UserCreateDTO&quot;,&quot;rpcExt&quot;:&quot;{\&quot;version\&quot;:\&quot;1.0.0\&quot;}&quot;,&quot;enabled&quot;:true}<br/></code></pre><p>② 使用浏览器，访问 http://127.0.0.1:9095/#/system/metadata 地址，进入「系统管理 -&gt; 元数据」菜单，可以看到上述注册的元数据。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [9].png" type="image/png" data-filename="640.png" height="206" width="576"/></div><div>系统管理 -&gt; 元数据</div></div><p>③ 使用浏览器，访问 http://127.0.0.1:9095/#/plug/dubbo 地址，进入「插件列表 -&gt; Dubbo」菜单，看到<strong>选择器</strong>和<strong>规则</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [10].png" type="image/png" data-filename="640.png" height="177" width="576"/></div><div>插件列表 -&gt; Dubbo</div></div><p>点击<strong>选择器</strong> <code>/user-api</code> 的「编辑」按钮，查看该选择器的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [11].png" type="image/png" data-filename="640.png" height="426" width="576"/></div><div>插件列表 -&gt; Dubbo -&gt; 选择器</div></div><p>点击<strong>规则</strong> <code>/user-api/user/get</code> 的「编辑」按钮，查看该规则的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [12].png" type="image/png" data-filename="640.png" height="385" width="576"/></div><div>插件列表 -&gt; Dubbo -&gt; 规则</div></div><p>④ 使用 Postman 模拟请求 http://127.0.0.1:9195/user-api/user/get 地址，调用 <code>UserServiceImpl#getUser(Integer id)</code> 方法。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [13].png" type="image/png" data-filename="640.png" height="281" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>POST</code>。</div></li><li><div>请求内容类型为 <code>application/json</code>。</div></li><li><div>因为 <code>UserServiceImpl#getUser(Integer id)</code> 方法是<strong>非 Bean</strong> 参数类型，所以直接在 Request <strong>Body</strong> 输入具体值即可。</div></li></ul><p>⑤ 使用 Postman 模拟请求 http://127.0.0.1:9195/user-api/user/create 地址，调用 <code>UserServiceImpl#createUser(UserCreateDTO createDTO)</code> 方法。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [14].png" type="image/png" data-filename="640.png" height="335" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>POST</code>。</div></li><li><div>请求内容类型为 <code>application/json</code>。</div></li><li><div>因为 <code>UserServiceImpl#createUser(UserCreateDTO createDTO)</code> 方法是 <strong>Bean</strong> 参数类型，所以直接在 Request <strong>Body</strong> 输入 JSON 数据格式。</div></li></ul><p>至此，我们已经完成了 Soul 网关接入 Dubbo 应用，并进行相应的而测试。</p><blockquote><p>友情提示：实际上，我们<strong>也</strong>可以参考《Soul 文档 —— dubbo 插件》，<strong>手动</strong>在 Soul Admin 控制台配置 Dubbo 接口方法的<strong>元数据</strong>，以及进行 dubbo 插件的<strong>选择器</strong>和<strong>规则</strong>的设置，实现 Soul Bootstrap 服务网关转发请求到 Dubbo 服务，<strong>无需</strong>在 Dubbo 项目中引入 <code>soul-client-apache-dubbo</code> 依赖。</p><p>也就是说，引入 <code>soul-client-apache-dubbo</code> 依赖的目的，是为了实现<strong>自动化</strong>，毕竟<strong>手工</strong>配置比较麻烦，并且容易出错。</p></blockquote><h1>4. 接入 Spring Boot 应用</h1><blockquote><p>示例代码对应仓库：<code>lab-60-soul-spring-boot-demo</code></p></blockquote><p>本小节，我们参考《Soul 文档 —— http 用户接入》文章，接入 Soul 服务网关。整个示例架构如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [15].png" type="image/png" data-filename="640.png" height="290" width="576"/></div><div>示例的整体架构</div></div><p>下面，我们来开始正式接入 Spring Boot 应用。</p><h2>4.1 设置 divide 插件</h2><p>需要设置 divide 插件 为<strong>开启</strong>。该插件实现 HTTP <strong>正向</strong>代理的功能，所有 HTTP 类型的请求你，都由它进行<strong>负载均衡</strong>的调用。</p><p>使用浏览器，访问 http://127.0.0.1:9095/#/system/plugin 地址，进入「系统管理 -&gt; 插件管理」菜单，可以看到 divide 插件。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [16].png" type="image/png" data-filename="640.png" height="186" width="576"/></div><div>系统管理 -&gt; 插件管理</div></div><p>默认情况下，divide 插件已经是<strong>开启</strong>状态，所以无需开启。</p><h2>4.2 安装 Zookeeper</h2><p>因为 Soul 网关需要知道后端 Spring Boot 应用的 <strong>host + port</strong> 地址，所以 Soul Client 实现使用 <strong>Zookeeper</strong> 作为注册中心，让 Spring Boot 应用注册到其上，从而使得 Soul 网关能够知道具体转发的地址。</p><p>① 参考《芋道 Zookeeper 极简入门》文章，先来搭建一个 Zookeeper 服务。</p><p>② 重启 Soul Admin 控制台，设置 <code>--soul.http.zookeeper-url</code> 配置项为 Zookeeper 地址。完整命令如下：</p><pre><code>java -jar soul-admin.jar --spring.datasource.url=&quot;jdbc:mysql://s1.iocoder.cn:3306/soul?useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;failOverReadOnly=false&amp;autoReconnect=true&amp;useSSL=false&quot; --spring.datasource.username='root' --spring.datasource.password='3WLiVUBEwTbvAfsh' --soul.http.register=true  --soul.http.zookeeper-url=127.0.0.1:2181<br/></code></pre><h2>4.3 搭建 Spring Boot 示例项目</h2><p>先快速搭建一个 Spring Boot 示例项目，暂未接入 Soul 网关。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [17].png" type="image/png" data-filename="640.png" height="311" width="576"/></div><div>项目结构</div></div><ul><li><div><code>lab-60-soul-spring-boot-demo</code></div></li></ul><h3>4.3.1 引入依赖</h3><p>修改 <code>pom.xml</code> 文件，引入 <code>soul-client-springmvc</code> 依赖，它是 Soul 对 SpringMVC 的集成支持。</p><pre><code>&lt;!-- 引入 Soul 针对 SpringMVC 的集成的依赖 --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.dromara&lt;/groupId&gt;<br/>    &lt;artifactId&gt;soul-client-springmvc&lt;/artifactId&gt;<br/>    &lt;version&gt;2.1.2-RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;<br/></code></pre><h3>4.3.2 配置文件</h3><p>修改 <code>application.yaml</code> 配置文件，添加 Soul 配置项如下：</p><pre><code>soul:<br/>  # Soul 针对 SpringMVC 的配置项，对应 SoulHttpConfig 配置类<br/>  http:<br/>    admin-url: http://127.0.0.1:9095 # Soul Admin 地址<br/>    context-path: /sb-demo-api # 设置在 Soul 网关的路由前缀，例如说 /order、/product 等等。<br/>                               # 后续，网关会根据该 context-path 来进行路由<br/>    app-name: sb-demo-service # 应用名。未配置情况下，默认使用 `spring.application.name` 配置项<br/>    zookeeper-url: 127.0.0.1:2181 # 使用 Zookeeper 作为注册中心的地址<br/></code></pre><p><code>soul.http</code> 配置项，Soul 对 SpringMVC 的配置项，对应 SoulHttpConfig 配置类。具体每个配置项的作用，胖友自己看配置项后的注释。</p><h3>4.3.3 UserController</h3><p>需要在 Controller 的 <strong>HTTP API 方法上</strong>，添加 <code>@SoulClient</code> 注解，用于设置每个 API 方法对应的<strong>请求路径</strong>。这里，我们修改 UserController 类，添加该注解。代码如下：</p><pre><code>@RestController<br/>@RequestMapping(&quot;/user&quot;)<br/>public class UserController {<br/><br/>private Logger logger = LoggerFactory.getLogger(getClass());<br/><br/>@GetMapping(&quot;/get&quot;)<br/>    @SoulClient(path = &quot;/user/get&quot;, desc = &quot;获得用户详细&quot;)<br/>    public String getUser(@RequestParam(&quot;id&quot;) Integer id) {<br/>        return &quot;DEMO:&quot; + id;<br/>    }<br/><br/>@PostMapping(&quot;/create&quot;)<br/>    @SoulClient(path = &quot;/user/create&quot;, desc = &quot;创建用户&quot;)<br/>    public Integer createUser(@RequestBody UserCreateDTO createDTO) {<br/>        logger.info(&quot;[createUser][username({}) password({})]&quot;, createDTO.getNickname(), createDTO.getGender());<br/>        return 1;<br/>    }<br/><br/>}<br/></code></pre><p><code>@SoulClient</code> 注解一共有三个属性：</p><ul><li><div><code>path</code>：映射的 HTTP 接口的请求路径。</div></li><li><div><code>desc</code>：接口的描述，便于知道其用途。</div></li><li><div><code>enable</code>：是否开启，默认为 <code>true</code> 开启。</div></li></ul><p>后续，在 Spring Boot 应用启动时，Soul Client 会自动解析 <code>@SoulClient</code> 注解的 API 方法，写入方法的<strong>元数据</strong>到 Soul Admin 控制台，最终通知到 Soul Bootstrap 服务网关上。</p><h2>4.4 简单测试</h2><p>① 执行 DemoApplication 启动 Spring Boot 应用。在 IDEA 控制台可以看到如下日志，看到写入 HTTP API 方法的<strong>元数据</strong>到 Soul Admin 控制台。</p><pre><code>// 注册到 Zookeeper<br/>2020-05-23 10:50:39.587  INFO 62682 --- [           main] o.d.s.c.s.s.ApplicationStartListener     : soul-http-client服务注册成功,context-path:/sb-demo-api, ip:port:10.171.1.115:8080<br/><br/>// 写入元数据<br/>2020-05-23 10:50:39.911  INFO 62682 --- [pool-1-thread-1] o.d.s.c.s.s.SoulClientBeanPostProcessor  : springMvc client register success :{} {&quot;appName&quot;:&quot;sb-demo-service&quot;,&quot;path&quot;:&quot;/sb-demo-api/user/get&quot;,&quot;pathDesc&quot;:&quot;获得用户详细&quot;,&quot;rpcType&quot;:&quot;http&quot;,&quot;serviceName&quot;:&quot;UserController&quot;,&quot;methodName&quot;:&quot;getUser&quot;,&quot;parameterTypes&quot;:&quot;java.lang.Integer&quot;,&quot;rpcExt&quot;:&quot;&quot;,&quot;enabled&quot;:true}<br/>2020-05-23 10:50:40.212  INFO 62682 --- [pool-1-thread-1] o.d.s.c.s.s.SoulClientBeanPostProcessor  : springMvc client register success :{} {&quot;appName&quot;:&quot;sb-demo-service&quot;,&quot;path&quot;:&quot;/sb-demo-api/user/create&quot;,&quot;pathDesc&quot;:&quot;创建用户&quot;,&quot;rpcType&quot;:&quot;http&quot;,&quot;serviceName&quot;:&quot;UserController&quot;,&quot;methodName&quot;:&quot;createUser&quot;,&quot;parameterTypes&quot;:&quot;cn.iocoder.springboot.lab60.dto.UserCreateDTO&quot;,&quot;rpcExt&quot;:&quot;&quot;,&quot;enabled&quot;:true}<br/></code></pre><p>② 使用浏览器，访问 http://127.0.0.1:9095/#/system/metadata 地址，进入「系统管理 -&gt; 元数据」菜单，可以看到上述注册的元数据。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [18].png" type="image/png" data-filename="640.png" height="146" width="576"/></div><div>系统管理 -&gt; 元数据</div></div><p>③ 使用浏览器，访问 http://127.0.0.1:9095/#/plug/divide 地址，进入「插件列表 -&gt; Divide」菜单，看到<strong>选择器</strong>和<strong>规则</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [19].png" type="image/png" data-filename="640.png" height="162" width="576"/></div><div>插件列表 -&gt; Divide</div></div><p>点击<strong>选择器</strong> <code>/sb-demo-api</code> 的「编辑」按钮，查看该选择器的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [20].png" type="image/png" data-filename="640.png" height="463" width="576"/></div><div>插件列表 -&gt; Divide -&gt; 选择器</div></div><p>点击<strong>规则</strong> <code>/sb-demo-api/user/get</code> 的「编辑」按钮，查看该规则的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [21].png" type="image/png" data-filename="640.png" height="321" width="576"/></div><div>插件列表 -&gt; Divide -&gt; 规则</div></div><p>④ 使用 Postman 模拟请求 http://127.0.0.1:9195/sb-demo-api/user/get?id=1 地址，转发到 <code>GET /user/get</code> 接口上。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [22].png" type="image/png" data-filename="640.png" height="343" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>GET</code>。</div></li><li><div>请求参数，直接带在 URL 后面。</div></li></ul><p>⑤ 使用 Postman 模拟请求 http://127.0.0.1:9195/sb-demo-api/user/create 地址，转发到 <code>POST /user/create</code> 接口上。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [23].png" type="image/png" data-filename="640.png" height="537" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>POST</code>。</div></li><li><div>请求内容类型为 <code>application/json</code>。</div></li><li><div>因为 <code>POST /user/create</code> 使用 JSON 接参，所以直接在 Request <strong>Body</strong> 输入 JSON 数据格式。</div></li></ul><p>至此，我们已经完成了 Soul 网关接入 Spring Boot 应用，并进行相应的而测试。</p><blockquote><p>友情提示：实际上，我们<strong>也</strong>可以参考《Soul 文档 —— divide 插件》，<strong>手动</strong>在 Soul Admin 控制台配置 API 接口方法的<strong>元数据</strong>，以及进行 divide 插件的<strong>选择器</strong>和<strong>规则</strong>的设置，实现 Soul Bootstrap 服务网关转发请求到 Spring Boot 应用，<strong>无需</strong>在 Spring Boot 应用中引入 <code>soul-client-springmvc</code> 依赖。</p><p>也就是说，引入 <code>soul-client-springmvc</code> 依赖的目的，是为了实现<strong>自动化</strong>，毕竟<strong>手工</strong>配置比较麻烦，并且容易出错。</p><p>当然，这样也就无法使用 Zookeeper 作为注册中心，需要在 Soul Admin 中<strong>手动</strong>维护应用的实例列表，会比较麻烦~</p></blockquote><h1>5. 接入 Spring Cloud 应用</h1><blockquote><p>示例代码对应仓库：<code>lab-60-soul-spring-cloud-demo</code></p></blockquote><p>本小节，我们参考《Soul 文档 —— springcloud 用户接入》文章，接入 Soul 服务网关。整个示例架构如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [24].png" type="image/png" data-filename="640.png" height="302" width="576"/></div><div>示例的整体架构</div></div><p>下面，我们来开始正式接入 Spring Cloud 应用。</p><h2>5.1 设置 springcloud 插件</h2><p>需要设置 springcloud 插件 为<strong>开启</strong>。该插件实现从 Spring Cloud 注册中心获取服务的示例列表，后续使用 Ribbon 实现<strong>负载均衡</strong>的调用。</p><p>使用浏览器，访问 http://127.0.0.1:9095/#/system/plugin 地址，进入「系统管理 -&gt; 插件管理」菜单，可以看到 springcloud 插件。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [25].png" type="image/png" data-filename="640.png" height="269" width="576"/></div><div>系统管理 -&gt; 插件管理</div></div><p>默认情况下，springcloud 插件已经是<strong>开启</strong>状态，所以无需开启。</p><h2>5.2 安装 Nacos</h2><p>我们使用 Nacos 作为 Spring Cloud 应用的注册中心，所有胖友可以参照《Nacos 极简入门》文章，搭建一个 Nacos 注册中心。</p><blockquote><p>友情提示：如果想要 Eureka 作为 Spring Cloud 应用注册中心的胖友，可以参照《芋道 Spring Cloud Netflix 注册中心 Eureka 入门》文章，搭建一个 Eureka 注册中心。</p></blockquote><h2>5.3 修改 Soul Bootstrap 接入 Nacos</h2><p>因为 Soul Bootstrap 需要从注册中心获取 Spring Cloud 应用的实例列表，所以需要集成 Spring Cloud 注册中心。目前，<strong>默认</strong>情况下 Soul Bootstrap 网关服务提供的 <code>soul-bootstrap.jar</code> 包，并未引入相关依赖，所以我们需要<strong>自己</strong>修改源码，并进行打包。</p><p>① 使用 IDEA 从 https://gitee.com/shuaiqiyu/soul 仓库中，下载最新的源码。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640.webp" type="image/webp" data-filename="640.webp" height="288" width="576"/></div><div>soul 源码</div></div><p>② 修改 <code>application.yml</code> 配置文件，添加 <code>spring.cloud.nacos.discovery.server-addr</code> 配置项为 Nacos 注册中心的地址。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [26].png" type="image/png" data-filename="640.png" height="242" width="576"/></div><div><code>application.yml</code> 配置文件</div></div><p>③ 修改 <code>pom.xml</code> 文件，引入 <code>spring-cloud-starter-alibaba-nacos-discovery</code> 依赖，集成 Nacos 作为 Spring Cloud 的注册中心。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [27].png" type="image/png" data-filename="640.png" height="226" width="576"/></div><div><code>pom.xml</code> 文件</div></div><blockquote><p>友情提示：如果想要 Eureka 作为 Spring Cloud 应用注册中心的胖友，也是修改配置文件，和引入依赖。</p></blockquote><p>④ 关闭 <code>soul-bootstrap.jar</code> 启动的服务网关，在 IDEA 中执行 <strong>SoulBootstrapApplication</strong> 启动服务网关。美滋滋~</p><blockquote><p>友情提示：启动时，会报 <code>Connection refused: localhost/127.0.0.1:6379</code> 错误，这是 Soul 限流功能需要使用到 Redis，可以暂时忽略。</p></blockquote><h2>5.4 搭建 Spring Cloud 示例项目</h2><p>先快速搭建一个 Spring Cloud 示例项目，暂未接入 Soul 网关。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [28].png" type="image/png" data-filename="640.png" height="315" width="576"/></div><div>项目结构</div></div><ul><li><div><code>lab-60-soul-spring-cloud-demo</code></div></li></ul><h3>5.4.1 引入依赖</h3><p>修改 <code>pom.xml</code> 文件，引入 <code>soul-client-springcloud</code> 依赖，它是 Soul 对 Spring Cloud 的集成支持。</p><pre><code>&lt;!-- 引入 Soul 针对 Spring Cloud 的集成的依赖 --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.dromara&lt;/groupId&gt;<br/>    &lt;artifactId&gt;soul-client-springcloud&lt;/artifactId&gt;<br/>    &lt;version&gt;2.1.2-RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;<br/></code></pre><h3>5.4.2 配置文件</h3><p>修改 <code>application.yaml</code> 配置文件，添加 Soul 配置项如下：</p><pre><code>soul:<br/>  # Soul 针对 SpringMVC 的配置项，对应 SoulSpringCloudConfig 配置类<br/>  springcloud:<br/>    admin-url: http://127.0.0.1:9095 # Soul Admin 地址<br/>    context-path: /sc-user-service-api # 设置在 Soul 网关的路由前缀，例如说 /order、/product 等等。<br/>                               # 后续，网关会根据该 context-path 来进行路由<br/>    app-name: sc-user-service # 应用名。未配置情况下，默认使用 `spring.application.name` 配置项<br/></code></pre><p><code>soul.springcloud</code> 配置项，Soul 对 Spring Cloud 的配置项，对应 SoulSpringCloudConfig 配置类。具体每个配置项的作用，胖友自己看配置项后的注释。</p><h3>5.4.3 UserController</h3><p>需要在 Controller 的 <strong>HTTP API 方法上</strong>，添加 <code>@SoulClient</code> 注解，用于设置每个 API 方法对应的<strong>请求路径</strong>。这里，我们修改 UserController 类，添加该注解。代码如下：</p><pre><code>@RestController<br/>@RequestMapping(&quot;/user&quot;)<br/>public class UserController {<br/><br/>private Logger logger = LoggerFactory.getLogger(getClass());<br/><br/>@GetMapping(&quot;/get&quot;)<br/>    @SoulClient(path = &quot;/user/get&quot;, desc = &quot;获得用户详细&quot;)<br/>    public String getUser(@RequestParam(&quot;id&quot;) Integer id) {<br/>        return &quot;DEMO:&quot; + id;<br/>    }<br/><br/>@PostMapping(&quot;/create&quot;)<br/>    @SoulClient(path = &quot;/user/create&quot;, desc = &quot;创建用户&quot;)<br/>    public Integer createUser(@RequestBody UserCreateDTO createDTO) {<br/>        logger.info(&quot;[createUser][username({}) password({})]&quot;, createDTO.getNickname(), createDTO.getGender());<br/>        return 1;<br/>    }<br/><br/>}<br/></code></pre><p><code>@SoulClient</code> 注解一共有三个属性：</p><ul><li><div><code>path</code>：映射的 HTTP 接口的请求路径。</div></li><li><div><code>desc</code>：接口的描述，便于知道其用途。</div></li><li><div><code>enable</code>：是否开启，默认为 <code>true</code> 开启。</div></li></ul><p>后续，在 Spring Cloud 应用启动时，Soul Client 会自动解析 <code>@SoulClient</code> 注解的 API 方法，写入方法的<strong>元数据</strong>到 Soul Admin 控制台，最终通知到 Soul Bootstrap 服务网关上。</p><h2>5.5 简单测试</h2><p>① 执行 DemoApplication 启动 Spring Boot 应用。在 IDEA 控制台可以看到如下日志，看到写入 HTTP API 方法的<strong>元数据</strong>到 Soul Admin 控制台。</p><pre><code>2020-05-23 17:00:26.711  INFO 67422 --- [pool-1-thread-1] s.SoulSpringCloudClientBeanPostProcessor : springCloud client register success :{} {&quot;appName&quot;:&quot;sc-user-service&quot;,&quot;path&quot;:&quot;/sc-user-service-api/user/get&quot;,&quot;pathDesc&quot;:&quot;获得用户详细&quot;,&quot;rpcType&quot;:&quot;springCloud&quot;,&quot;serviceName&quot;:&quot;UserController&quot;,&quot;methodName&quot;:&quot;getUser&quot;,&quot;parameterTypes&quot;:&quot;java.lang.Integer&quot;,&quot;rpcExt&quot;:&quot;&quot;,&quot;enabled&quot;:true}<br/>2020-05-23 17:00:27.110  INFO 67422 --- [pool-1-thread-1] s.SoulSpringCloudClientBeanPostProcessor : springCloud client register success :{} {&quot;appName&quot;:&quot;sc-user-service&quot;,&quot;path&quot;:&quot;/sc-user-service-api/user/create&quot;,&quot;pathDesc&quot;:&quot;创建用户&quot;,&quot;rpcType&quot;:&quot;springCloud&quot;,&quot;serviceName&quot;:&quot;UserController&quot;,&quot;methodName&quot;:&quot;createUser&quot;,&quot;parameterTypes&quot;:&quot;cn.iocoder.springcloud.lab60.dto.UserCreateDTO&quot;,&quot;rpcExt&quot;:&quot;&quot;,&quot;enabled&quot;:true}<br/></code></pre><p>② 使用浏览器，访问 http://127.0.0.1:9095/#/system/metadata 地址，进入「系统管理 -&gt; 元数据」菜单，可以看到上述注册的元数据。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [1].webp" type="image/webp" data-filename="640.webp" height="145" width="576"/></div><div>系统管理 -&gt; 元数据</div></div><p>③ 使用浏览器，访问 http://127.0.0.1:9095/#/plug/divide 地址，进入「插件列表 -&gt; Divide」菜单，看到<strong>选择器</strong>和<strong>规则</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [2].webp" type="image/webp" data-filename="640.webp" height="214" width="576"/></div><div>插件列表 -&gt; springcloud</div></div><p>点击<strong>选择器</strong> <code>/sc-user-service-api</code> 的「编辑」按钮，查看该选择器的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [3].webp" type="image/webp" data-filename="640.webp" height="477" width="576"/></div><div>插件列表 -&gt; springcloud -&gt; 选择器</div></div><p>点击<strong>规则</strong> <code>/sc-user-service-api/user/get</code> 的「编辑」按钮，查看该规则的具体信息。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [29].png" type="image/png" data-filename="640.png" height="365" width="576"/></div><div>插件列表 -&gt; Divide -&gt; 规则</div></div><p>④ 使用 Postman 模拟请求 http://127.0.0.1:9195/sc-user-service-api/user/get?id=1 地址，转发到 <code>GET /user/get</code> 接口上。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [30].png" type="image/png" data-filename="640.png" height="377" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>GET</code>。</div></li><li><div>请求参数，直接带在 URL 后面。</div></li></ul><p>⑤ 使用 Postman 模拟请求 http://127.0.0.1:9195/sb-demo-api/user/create 地址，转发到 <code>POST /user/create</code> 接口上。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [31].png" type="image/png" data-filename="640.png" height="470" width="576"/></div><div>Postman 模拟</div></div><ul><li><div>使用 Request <strong>Method</strong> 为 <code>POST</code>。</div></li><li><div>请求内容类型为 <code>application/json</code>。</div></li><li><div>因为 <code>POST /user/create</code> 使用 JSON 接参，所以直接在 Request <strong>Body</strong> 输入 JSON 数据格式。</div></li></ul><p>至此，我们已经完成了 Soul 网关接入 Spring Cloud 应用，并进行相应的而测试。</p><blockquote><p>友情提示：实际上，我们<strong>也</strong>可以参考《Soul 文档 —— springcloud 插件》，<strong>手动</strong>在 Soul Admin 控制台配置 API 接口方法的<strong>元数据</strong>，以及进行 springcloud 插件的<strong>选择器</strong>和<strong>规则</strong>的设置，实现 Soul Bootstrap 服务网关转发请求到 Spring Cloud 应用，<strong>无需</strong>在 Spring Cloud 应用中引入 <code>soul-client-springcloud</code> 依赖。</p><p>也就是说，引入 <code>soul-client-springcloud</code> 依赖的目的，是为了实现<strong>自动化</strong>，毕竟<strong>手工</strong>配置比较麻烦，并且容易出错。</p></blockquote><h1>6. rateLimiter 插件</h1><p>本小节，我们参考《Soul 文档 —— rateLimiter 插件》文章，使用 <strong>rateLimiter</strong> 插件，实现 Soul 网关的<strong>限流</strong>功能。该插件是基于令牌桶算法 + Redis 存储计数，实现<strong>分布式</strong>限流。整体设计如下图：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [32].png" type="image/png" data-filename="640.png" height="282" width="576"/></div><div>原理</div></div><p>下面，我们在「3. 接入 Dubbo 应用」小节的基础上，对 <code>user-api/user/get</code> 实现<strong>限流</strong>的功能。</p><h2>6.1 安装 Redis</h2><p>相信大家都会，艿艿就不瞎哔哔了。嘿嘿~</p><h2>6.2 设置 rateLimiter 插件</h2><p>先需要设置 rateLimiter 插件 的 Redis 配置，目前支持单机、哨兵、集群模式。</p><p>① 使用浏览器，访问 http://127.0.0.1:9095/#/system/plugin 地址，进入「系统管理 -&gt; 插件管理」菜单，可以看到 rateLimiter 插件。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [4].webp" type="image/webp" data-filename="640.webp" height="166" width="576"/></div><div>系统管理 -&gt; 插件管理</div></div><p>② 点击 rateLimiter 插件的「编辑」按钮，设置 Redis 的配置，并设置该插件为<strong>开启</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [33].png" type="image/png" data-filename="640.png" height="776" width="576"/></div><div>系统管理 -&gt; 插件管理 -&gt; 编辑</div></div><blockquote><p>友情提示：Redis 的地址，记得要填写正确哈~</p></blockquote><p>③ 因为 Soul Bootstrap 和 Soul Admin 暂时不支持插件修改的<strong>自动加载</strong>，所以我们此时需要<strong>手动重启</strong>下。</p><h2>6.3 设置 rateLimiter 限流规则</h2><p>① 使用浏览器，访问 http://127.0.0.1:9095/#/plug/rate_limiter 地址，进入「插件列表 -&gt; rate_limiter」菜单，进行限流规则的配置。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [34].png" type="image/png" data-filename="640.png" height="142" width="576"/></div><div>插件列表 -&gt; rate_limiter</div></div><p>② 点击「添加选择器」按钮，添加一个<strong>选择器</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [35].png" type="image/png" data-filename="640.png" height="424" width="576"/></div><div>插件列表 -&gt; rate_limiter -&gt; 添加选择器</div></div><p>③ 点击「添加规则」按钮，给该选择器添加一个<strong>规则</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [36].png" type="image/png" data-filename="640.png" height="357" width="576"/></div><div>插件列表 -&gt; rate_limiter -&gt; 添加规则</div></div><ul><li><div>对请求地址 <code>/user-api/user/get</code> 进行限流，对应 UserService 的 <code>#getUser(Integer id)</code> 方法。</div></li><li><div><strong>速率</strong>：是你允许用户每秒执行多少请求，而丢弃任何请求。这是令牌桶的填充速率。</div></li><li><div><strong>容量</strong>：是允许用户在一秒钟内执行的最大请求数。这是令牌桶可以保存的令牌数。</div></li></ul><blockquote><p>友情提示：可能胖友对 Soul 定义的<strong>选择器</strong>与<strong>规则</strong>的概念有点不了解，可以看看《Soul 文档 —— 选择器规则详解》文章。</p></blockquote><h2>6.4 简单测试</h2><p>执行 UserServiceApplication 启动 Dubbo 服务。</p><p><strong>快速</strong>且<strong>多次</strong>使用 Postman 模拟请求 http://127.0.0.1:9195/user-api/user/get 地址，调用 <code>UserServiceImpl#getUser(Integer id)</code> 方法，最终被<strong>限流</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [37].png" type="image/png" data-filename="640.png" height="708" width="576"/></div><div>Postman 模拟</div></div><h1>7. hystrix 插件</h1><p>本小节，我们参考《Soul 文档 —— hystrix 插件》文章，使用 <strong>hystrix</strong> 插件，使用 Hystrix 框架，实现 Soul 网关的<strong>熔断器</strong>功能。</p><blockquote><p>友情提示：对 Hystrix 不了解的胖友，可以后续阅读《芋道 Spring Boot 服务容错 Hystrix 入门》文章进行学习。</p></blockquote><p>下面，我们在「3. 接入 Dubbo 应用」小节的基础上，对 <code>user-api/user/get</code> 实现<strong>熔断器</strong>的功能。</p><h2>7.1 设置 hystrix 插件</h2><p>需要设置 hystrix 插件 为<strong>开启</strong>。</p><p>使用浏览器，访问 http://127.0.0.1:9095/#/system/plugin 地址，进入「系统管理 -&gt; 插件管理」菜单，可以看到 hystrix 插件。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [38].png" type="image/png" data-filename="640.png" height="276" width="576"/></div><div>系统管理 -&gt; 插件管理</div></div><p>默认情况下，hystrix 插件已经是<strong>开启</strong>状态，所以无需开启。</p><h2>7.2 设置 rateLimiter 限流规则</h2><p>① 使用浏览器，访问 http://127.0.0.1:9095/#/plug/hystrix 地址，进入「插件列表 -&gt; hystrix」菜单，进行熔断器规则的配置。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [39].png" type="image/png" data-filename="640.png" height="213" width="576"/></div><div>插件列表 -&gt; hystrix</div></div><p>② 点击「添加选择器」按钮，添加一个<strong>选择器</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [40].png" type="image/png" data-filename="640.png" height="433" width="576"/></div><div>插件列表 -&gt; hystrix -&gt; 添加选择器</div></div><p>③ 点击「添加规则」按钮，给该选择器添加一个<strong>规则</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [41].png" type="image/png" data-filename="640.png" height="418" width="576"/></div><div>插件列表 -&gt; hystrix -&gt; 添加规则</div></div><ul><li><div>对请求地址 <code>/user-api/user/get</code> 进行熔断保护，对应 UserService 的 <code>#getUser(Integer id)</code> 方法。</div></li></ul><blockquote><p>友情提示：可能胖友对 Soul 定义的<strong>选择器</strong>与<strong>规则</strong>的概念有点不了解，可以看看《Soul 文档 —— 选择器规则详解》文章。</p></blockquote><h2>7.3 简单测试</h2><p><strong>不要</strong>执行 UserServiceApplication 启动 Dubbo 服务，模拟其<strong>故障</strong>。</p><p><strong>快速</strong>且<strong>多次</strong>使用 Postman 模拟请求 http://127.0.0.1:9195/user-api/user/get 地址，调用 <code>UserServiceImpl#getUser(Integer id)</code> 方法，最终被<strong>熔断</strong>。如下图所示：</p><div><div><img src="又一国产微服务网关 Soul，一起来肝一肝，Dubbo、SpringCloud、Sprin_files/640 [42].png" type="image/png" data-filename="640.png" height="661" width="576"/></div><div>Postman 模拟</div></div><p>此时，我们在 Soul Bootstrap 网关的日志可以看到，Hystrix 熔断器已经打开。日志内容如下：</p><pre><code>2020-05-23 20:52:28.786 ERROR 69264 --- [work-threads-20] o.d.s.web.plugin.hystrix.HystrixPlugin   : hystrix execute have circuitBreaker is Open! groupKey:user-service,commandKey:cn.iocoder.springboot.lab60.userservice.api.UserService<br/></code></pre><h1>666. 彩蛋</h1><p>至此，我们已经完成了 Soul 网关的学习，后续胖友可以阅读《Soul 文档》，了解本文暂时并未写到的内容。</p><p>例如<strong>插件</strong>相关：</p><ul><li><div>monitor 插件：实现监控数据的收集，后续可以使用 Grafana 实现监控仪表盘。</div></li><li><div>waf 插件：实现黑名单功能，禁止恶意 IP 的访问。</div></li><li><div>sign 插件：实现请求签名功能，保证接口的安全性。</div></li><li><div>rewrite 插件：对请求 URI 进行重写。</div></li><li><div>websocket 插件：实现对 Websocket 进行代理转发。</div></li><li><div>自定义插件：自己实现插件，进一步拓展自己的插件。</div></li></ul><p>例如<strong>功能</strong>相关：</p><ul><li><div><p>自定义 filter：自定义 Filter，可以拓展安全认证等等功能。</p></div></li><li><div><p>文件上传下载：提供的文件上传和下载功能。</p><blockquote><p>友情提示：建议文件上传不要经过 API 网关，而是先上传到文件服务器，然后提交 URL 到 API 网关。</p></blockquote></div></li><li><div><p>自定义 host 与 ip：考虑到 API 网关的前面都有 Nginx，所以需要拓展保证解析到正确的用户 IP。</p></div></li><li><div><p>自定义返回结果：每个公司的统一返回格式可能有差异，最好自己拓展下。</p></div></li></ul></div></div></div><br/></div></span>
</div></body></html> 