<html>
<head>
  <title>Java 中的并发工具类</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3226"/>
<h1>Java 中的并发工具类</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/10/29 9:31</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://blog.wuwii.com/juc-utils.html"><i>https://blog.wuwii.com/juc-utils.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="font-family:sans-serif;text-size-adjust:100%;"><div style="font-family:Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;line-height:2;color:rgb(85, 85, 85);background:rgb(255, 255, 255);backface-visibility:hidden;"><div><span><div><div><div><div><div style="opacity:1;box-shadow:rgba(202, 203, 203, 0.5) 0px 0px 5px;transform:translateY(0px);"><div style="display:block;"><h2 style="margin:20px 0px 10px;padding:0px;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-weight:400;font-size:26px;text-align:center;word-break:break-word;position:relative;"><span style="font-weight:400;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:26px;text-align:center;display:none;"></span>Java 中的并发工具类</h2><div style="margin:3px 0px 60px;color:rgb(153, 153, 153);font-family:Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:12px;text-align:center;margin-top:5px;margin-bottom:60px;"><span><span style="margin-right:3px;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> </span><span>发表于</span> <span title="创建于">2018-05-20 </span></span><span><span style="margin:0px 0.5em;">|</span> <span style="margin-right:3px;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> </span><span>分类于</span> <span><a href="https://blog.wuwii.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="index" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;"><span>学习笔记</span></a></span></span><div style="display:block;"><span style="margin-right:3px;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> </span><span>字数统计</span> <span title="字数统计">3,983 </span><span style="margin:0px 0.5em;">|</span> <span style="margin-right:3px;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> </span><span>阅读时长</span> <span title="阅读时长">17</span></div></div></div><div style="font-family:Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;"><p style="margin:0px 0px 25px;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">java.util.concurrent</code> 下提供了一些辅助类来帮助我们在并发编程的设计。</p><p style="margin:0px 0px 25px;">学习了 AQS 后再了解这些工具类，就非常简单了。</p><p style="margin:0px 0px 25px;"><em>jdk 1.8</em></p><a style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;"></a><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E7%AD%89%E5%BE%85%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AE%8C%E6%88%90%E7%9A%84CountDownLatch" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="等待多线程完成的CountDownLatch"></a>等待多线程完成的CountDownLatch</h3><p style="margin:0px 0px 25px;">在 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">concurrent</code> 包下面提供了 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">CountDownLatch</code> 类，它提供了计数器的功能，能够实现让一个线程等待其他线程执行完毕才能进入运行状态。</p><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="源码分析"></a>源码分析</h4><ol><li><p style="margin:0px 0px 25px;">首先看下最关键的地方它的自定义同步器的实现，非常简单：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">  <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">Sync</span> <span style="color:rgb(137, 89, 168);">extends</span> <span style="color:rgb(62, 153, 159);">AbstractQueuedSynchronizer</span> </span>{</div><div style="height:20px;">      <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">long</span> serialVersionUID = <span style="color:rgb(113, 140, 0);">4982264981922014374L</span>;</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 1. 初始化 state 资源变量</span></div><div style="height:20px;">      Sync(<span style="color:rgb(137, 89, 168);">int</span> count) {</div><div style="height:20px;">          setState(count);</div><div style="height:20px;">      }</div><div style="height:20px;">   </div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">getCount</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">return</span> getState();</div><div style="height:20px;">      }</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 尝试获取贡献模式下的资源，</span></div><div style="height:20px;">      <span style="color:rgb(142, 144, 140);">// 定义返回值小于 0 的时候获取资源失败</span></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">tryAcquireShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> acquires)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">return</span> (getState() == <span style="color:rgb(113, 140, 0);">0</span>) ? <span style="color:rgb(113, 140, 0);">1</span> : -<span style="color:rgb(113, 140, 0);">1</span>;</div><div style="height:20px;">      }</div><div style="height:20px;">   </div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">boolean</span> <span style="color:rgb(62, 153, 159);">tryReleaseShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> releases)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(142, 144, 140);">// Decrement count; signal when transition to zero</span></div><div style="height:20px;">          <span style="color:rgb(142, 144, 140);">// 自旋。</span></div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> c = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (c == <span style="color:rgb(113, 140, 0);">0</span>)</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> <span style="color:rgb(137, 89, 168);">false</span>;</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> nextc = c - <span style="color:rgb(113, 140, 0);">1</span>; <span style="color:rgb(142, 144, 140);">// 每次释放资源，硬编码减一个资源</span></div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (compareAndSetState(c, nextc))</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> nextc == <span style="color:rgb(113, 140, 0);">0</span>; <span style="color:rgb(142, 144, 140);">// 知道为 0 的时候才释放成功，也就是所有线程必须都执行释放操作说明才释放成功。</span></div><div style="height:20px;">           </div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;">  }</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">在这里查看构造器的源码得知，<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">CountDownLatch</code> 内部使用的是 内部类<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">Sync</code> 继承了 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">AQS</code> ，将我们传入进来的 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">count</code> 数值当作 AQS state。感觉这个是不是和可重入锁实现是一样的，只不过开始指定了线程获取的锁的次数。</p><p style="margin:0px 0px 25px;">在上面我也发现了几个特点，第一次看这个代码其实还是不好理解，因为它相对前面的 AQS 和 TwinsLock 就是一个反着设计的代码：</p><ol><li>首先获取资源的时候，线程全部都是先进入等待队列，而且在这一步骤中，不改变 state 资源的数量；</li><li>释放资源的时候，每次固定减少一个资源，直到资源为 0 的时候才表示释放资源成功，所以加入我们有 5 个资源，但是只有四个线程执行，如果只释放四次（总共执行 countDown 四次），就永远也释放不成功，await 一直在阻塞。</li><li>经过上面的分析，发现了 state 的资源数量每次进行 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">countDown</code> 都去减少一个，没有方法去增加数量，所以它是不可逆的，它的计数器是不可以重复使用的。</li></ol></li><li><p style="margin:0px 0px 25px;">看下 await 的实现，发现它最终实现的是 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">doAcquireSharedInterruptibly</code> ：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">   <span style="color:rgb(142, 144, 140);">// 仔细看这个代码，和前面的共享模式中的 doAcquireShared 方法基本一摸一样，只不过是当它遇到线程中断信号的时候，立刻抛出中断异常，仔细想想也是的，比如，自己在这里等别人吃饭，不想等了，也懒得管别人做什么了，剩下的吃饭的事情也没必要继续下去了。</span></div><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">doAcquireSharedInterruptibly</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> arg)</span></span></div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">throws</span> InterruptedException {</div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">final</span> Node node = addWaiter(Node.SHARED);</div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">boolean</span> failed = <span style="color:rgb(137, 89, 168);">true</span>;</div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">           <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">final</span> Node p = node.predecessor();</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">if</span> (p == head) {</div><div style="height:20px;">                   <span style="color:rgb(137, 89, 168);">int</span> r = tryAcquireShared(arg);</div><div style="height:20px;">                   <span style="color:rgb(137, 89, 168);">if</span> (r &gt;= <span style="color:rgb(113, 140, 0);">0</span>) {</div><div style="height:20px;">                       setHeadAndPropagate(node, r);</div><div style="height:20px;">                       p.next = <span style="color:rgb(137, 89, 168);">null</span>; <span style="color:rgb(142, 144, 140);">// help GC</span></div><div style="height:20px;">                       failed = <span style="color:rgb(137, 89, 168);">false</span>;</div><div style="height:20px;">                       <span style="color:rgb(137, 89, 168);">return</span>;</div><div style="height:20px;">                   }</div><div style="height:20px;">               }</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div style="height:20px;">                   parkAndCheckInterrupt())</div><div style="height:20px;">                   <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> InterruptedException();</div><div style="height:20px;">           }</div><div style="height:20px;">       } <span style="color:rgb(137, 89, 168);">finally</span> {</div><div style="height:20px;">           <span style="color:rgb(137, 89, 168);">if</span> (failed)</div><div style="height:20px;">               cancelAcquire(node);</div><div style="height:20px;">       }</div><div style="height:20px;">   }</div><div style="height:20px;">	<span style="color:rgb(142, 144, 140);">// 需要注意的是它重写了尝试获取资源的方法，当资源全部消耗完，才能够让你去获取资源，现在才豁然开朗，await 阻塞的线程就是这么被唤醒的。</span></div><div style="height:20px;">       <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">tryAcquireShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> acquires)</span> </span>{</div><div style="height:20px;">           <span style="color:rgb(137, 89, 168);">return</span> (getState() == <span style="color:rgb(113, 140, 0);">0</span>) ? <span style="color:rgb(113, 140, 0);">1</span> : -<span style="color:rgb(113, 140, 0);">1</span>;</div><div style="height:20px;">       }</div></pre></td></tr></tbody></table></div></li></ol><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="使用场景"></a>使用场景</h4><p style="margin:0px 0px 25px;">CountDownLatch允许一个或多个线程等待其他线程完成操作。</p><p style="margin:0px 0px 25px;">比如经典问题：</p><blockquote style="margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);"><p style="margin:0px 0px 25px;">有Thread1、Thread2、Thread3、Thread4四条线程分别统计C、D、E、F四个盘的大小，所有线程都统计完毕交给Thread5线程去做汇总，应当如何实现？</p></blockquote><p style="margin:0px 0px 25px;">这个问题关键就是要知道<strong style="font-weight:700;">四条线程何时执行完。</strong></p><p style="margin:0px 0px 25px;">下面是我的解决思路：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div><div style="height:20px;">39</div><div style="height:20px;">40</div><div style="height:20px;">41</div><div style="height:20px;">42</div><div style="height:20px;">43</div><div style="height:20px;">44</div><div style="height:20px;">45</div><div style="height:20px;">46</div><div style="height:20px;">47</div><div style="height:20px;">48</div><div style="height:20px;">49</div><div style="height:20px;">50</div><div style="height:20px;">51</div><div style="height:20px;">52</div><div style="height:20px;">53</div><div style="height:20px;">54</div><div style="height:20px;">55</div><div style="height:20px;">56</div><div style="height:20px;">57</div><div style="height:20px;">58</div><div style="height:20px;">59</div><div style="height:20px;">60</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(142, 144, 140);">/**</span></div><div style="height:20px;"> * 如有Thread1、Thread2、Thread3、Thread4四条线程分别统计C、D、E、F四个盘的大小，</div><div style="height:20px;"> * 所有线程都统计完毕交给Thread5线程去做汇总，应当如何实现？</div><div style="height:20px;"> *</div><div style="height:20px;"> * Created by KronChan on 2018/5/14 17:00.</div><div style="height:20px;"> */</div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">public</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">CountDownLatchDemo</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">main</span><span style="color:rgb(245, 135, 31);">(String[] args)</span> <span style="color:rgb(137, 89, 168);">throws</span> InterruptedException </span>{</div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 初始化计数器，设置总量i，调用一次countDown(）方法后i的值会减1。</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 在一个线程中如果调用了await()方法，这个线程就会进入到等待的状态，当参数i为0的时候这个线程才继续执行。</span></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">final</span> CountDownLatch countDownLatch = <span style="color:rgb(137, 89, 168);">new</span> CountDownLatch(<span style="color:rgb(113, 140, 0);">4</span>);</div><div style="height:20px;">        Runnable thread1 = () -&gt; {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                TimeUnit.SECONDS.sleep(<span style="color:rgb(113, 140, 0);">2</span>);</div><div style="height:20px;">                System.out.println(<span style="color:rgb(113, 140, 0);">&quot;统计 C 盘大小&quot;</span>);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">            <span style="color:rgb(142, 144, 140);">// 统计完成计数器 -1</span></div><div style="height:20px;">            countDownLatch.countDown();</div><div style="height:20px;">        };</div><div style="height:20px;">        Runnable thread2 = () -&gt; {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                TimeUnit.SECONDS.sleep(<span style="color:rgb(113, 140, 0);">2</span>);</div><div style="height:20px;">                System.out.println(<span style="color:rgb(113, 140, 0);">&quot;统计 D 盘大小&quot;</span>);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">            countDownLatch.countDown();</div><div style="height:20px;">        };</div><div style="height:20px;">        Runnable thread3 = () -&gt; {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                TimeUnit.SECONDS.sleep(<span style="color:rgb(113, 140, 0);">2</span>);</div><div style="height:20px;">                System.out.println(<span style="color:rgb(113, 140, 0);">&quot;统计 E 盘大小&quot;</span>);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">            countDownLatch.countDown();</div><div style="height:20px;">        };</div><div style="height:20px;">        Runnable thread4 = () -&gt; {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                TimeUnit.SECONDS.sleep(<span style="color:rgb(113, 140, 0);">2</span>);</div><div style="height:20px;">                System.out.println(<span style="color:rgb(113, 140, 0);">&quot;统计 F 盘大小&quot;</span>);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">            countDownLatch.countDown();</div><div style="height:20px;">        };</div><div style="height:20px;"></div><div style="height:20px;">        ExecutorService pool = Executors.newFixedThreadPool(<span style="color:rgb(113, 140, 0);">4</span>);</div><div style="height:20px;">        pool.execute(thread1);</div><div style="height:20px;">        pool.execute(thread2);</div><div style="height:20px;">        pool.execute(thread3);</div><div style="height:20px;">        pool.execute(thread4);</div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 等待 i 值为 0 ，等待四条线程执行完毕。</span></div><div style="height:20px;">        countDownLatch.await();</div><div style="height:20px;">        System.out.println(<span style="color:rgb(113, 140, 0);">&quot;统计完成&quot;</span>);</div><div style="height:20px;">        pool.shutdown();</div><div style="height:20px;">    }</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E5%90%8C%E6%AD%A5%E5%B1%8F%E9%9A%9CCyclicBarrier" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="同步屏障CyclicBarrier"></a>同步屏障CyclicBarrier</h3><p style="margin:0px 0px 25px;">CyclicBarrier的字面意思是可循环使用（Cyclic）的屏障（Barrier）。它要做的事情是，让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续运行。</p><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="源码分析"></a>源码分析</h4><h5 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E5%B1%9E%E6%80%A7" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="属性"></a>属性</h5><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">final</span> ReentrantLock lock = <span style="color:rgb(137, 89, 168);">new</span> ReentrantLock();</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 线程协作</span></div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">final</span> Condition trip = lock.newCondition();</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 必须同时到达barrier的线程个数。</span></div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">int</span> parties;</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// parties个线程到达barrier时，会执行的动作，会让到达屏障中的任意一个线程去执行这个动作。</span></div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">final</span> Runnable barrierCommand;</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 控制屏障的循环使用，它是可重复使用的，每次使用CyclicBarrier，本次所有线程同属于一代，即同一个Generation</span></div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> Generation generation = <span style="color:rgb(137, 89, 168);">new</span> Generation();</div><div style="height:20px;"> <span style="color:rgb(142, 144, 140);">// 处在等待状态的线程个数。</span></div><div style="height:20px;"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">int</span> count;</div></pre></td></tr></tbody></table></div><h5 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E4%B8%BB%E8%A6%81%E7%9A%84%E6%96%B9%E6%B3%95" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="主要的方法"></a>主要的方法</h5><h6 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="构造函数"></a>构造函数</h6><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(62, 153, 159);">CyclicBarrier</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> parties)</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">this</span>(parties, <span style="color:rgb(137, 89, 168);">null</span>);</div><div style="height:20px;">}</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 构造函数主要实现了，设置一组线程的数量，到达屏障时候的临界点，可以设置到达屏障的时候需要处理的动作，后面屏障允许它们通过。</span></div><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(62, 153, 159);">CyclicBarrier</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> parties, Runnable barrierAction)</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">if</span> (parties &lt;= <span style="color:rgb(113, 140, 0);">0</span>) <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> IllegalArgumentException();</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">this</span>.parties = parties;</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">this</span>.count = parties;</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">this</span>.barrierCommand = barrierAction;</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><h6 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#await" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="await"></a>await</h6><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div><div style="height:20px;">39</div><div style="height:20px;">40</div><div style="height:20px;">41</div><div style="height:20px;">42</div><div style="height:20px;">43</div><div style="height:20px;">44</div><div style="height:20px;">45</div><div style="height:20px;">46</div><div style="height:20px;">47</div><div style="height:20px;">48</div><div style="height:20px;">49</div><div style="height:20px;">50</div><div style="height:20px;">51</div><div style="height:20px;">52</div><div style="height:20px;">53</div><div style="height:20px;">54</div><div style="height:20px;">55</div><div style="height:20px;">56</div><div style="height:20px;">57</div><div style="height:20px;">58</div><div style="height:20px;">59</div><div style="height:20px;">60</div><div style="height:20px;">61</div><div style="height:20px;">62</div><div style="height:20px;">63</div><div style="height:20px;">64</div><div style="height:20px;">65</div><div style="height:20px;">66</div><div style="height:20px;">67</div><div style="height:20px;">68</div><div style="height:20px;">69</div><div style="height:20px;">70</div><div style="height:20px;">71</div><div style="height:20px;">72</div><div style="height:20px;">73</div><div style="height:20px;">74</div><div style="height:20px;">75</div><div style="height:20px;">76</div><div style="height:20px;">77</div><div style="height:20px;">78</div><div style="height:20px;">79</div><div style="height:20px;">80</div><div style="height:20px;">81</div><div style="height:20px;">82</div><div style="height:20px;">83</div><div style="height:20px;">84</div><div style="height:20px;">85</div><div style="height:20px;">86</div><div style="height:20px;">87</div><div style="height:20px;">88</div><div style="height:20px;">89</div><div style="height:20px;">90</div><div style="height:20px;">91</div><div style="height:20px;">92</div><div style="height:20px;">93</div><div style="height:20px;">94</div><div style="height:20px;">95</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">await</span><span style="color:rgb(245, 135, 31);">()</span> <span style="color:rgb(137, 89, 168);">throws</span> InterruptedException, BrokenBarrierException </span>{</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">return</span> dowait(<span style="color:rgb(137, 89, 168);">false</span>, <span style="color:rgb(113, 140, 0);">0L</span>);</div><div style="height:20px;">    } <span style="color:rgb(137, 89, 168);">catch</span> (TimeoutException toe) {</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> Error(toe); <span style="color:rgb(142, 144, 140);">// cannot happen;</span></div><div style="height:20px;">    }</div><div style="height:20px;">}</div><div style="height:20px;"></div><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">dowait</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">boolean</span> timed, <span style="color:rgb(137, 89, 168);">long</span> nanos)</span></span></div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">throws</span> InterruptedException, BrokenBarrierException,</div><div style="height:20px;">           TimeoutException {</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">final</span> ReentrantLock lock = <span style="color:rgb(137, 89, 168);">this</span>.lock;</div><div style="height:20px;">    <span style="color:rgb(142, 144, 140);">// 独占锁</span></div><div style="height:20px;">    lock.lock();</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 保存当前的generation</span></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">final</span> Generation g = generation;</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// generation broken，不允许使用，则抛出异常。</span></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">if</span> (g.broken)</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> BrokenBarrierException();</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 如果当前线程被中断，则通过breakBarrier()终止CyclicBarrier，唤醒CyclicBarrier中所有等待线程。</span></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">if</span> (Thread.interrupted()) {</div><div style="height:20px;">            breakBarrier();</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> InterruptedException();</div><div style="height:20px;">        }</div><div style="height:20px;"></div><div style="height:20px;">       <span style="color:rgb(142, 144, 140);">// 等待的计数器减一</span></div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">int</span> index = --count;</div><div style="height:20px;">       <span style="color:rgb(142, 144, 140);">// 如果计数器的 count 正好为0， 说明已经有parties个线程到达barrier了。执行预定的Runnable任务后，更新换代，准备下一次使用。</span></div><div style="height:20px;">       <span style="color:rgb(137, 89, 168);">if</span> (index == <span style="color:rgb(113, 140, 0);">0</span>) {  <span style="color:rgb(142, 144, 140);">// tripped</span></div><div style="height:20px;">           <span style="color:rgb(137, 89, 168);">boolean</span> ranAction = <span style="color:rgb(137, 89, 168);">false</span>;</div><div style="height:20px;">           <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">               <span style="color:rgb(142, 144, 140);">// 如果barrierCommand不为null，则执行该动作。</span></div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">final</span> Runnable command = barrierCommand;</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">if</span> (command != <span style="color:rgb(137, 89, 168);">null</span>)</div><div style="height:20px;">                   command.run();</div><div style="height:20px;">               ranAction = <span style="color:rgb(137, 89, 168);">true</span>;</div><div style="height:20px;">               <span style="color:rgb(142, 144, 140);">// 唤醒所有等待线程，并更新generation，准备下一次使用</span></div><div style="height:20px;">               nextGeneration();</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">return</span> <span style="color:rgb(113, 140, 0);">0</span>;</div><div style="height:20px;">           } <span style="color:rgb(137, 89, 168);">finally</span> {</div><div style="height:20px;">               <span style="color:rgb(137, 89, 168);">if</span> (!ranAction)</div><div style="height:20px;">                   breakBarrier();</div><div style="height:20px;">           }</div><div style="height:20px;">       }</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 当前线程一直阻塞，</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 1. 有parties个线程到达barrier</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 2. 当前线程被中断</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 3. 超时</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 直到上面三者之一发生，就唤醒所有线程继续执行下去</span></div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 自旋</span></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                <span style="color:rgb(142, 144, 140);">// 如果不是超时等待，则调用awati()进行等待；否则，调用awaitNanos()进行等待。</span></div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">if</span> (!timed)</div><div style="height:20px;">                    trip.await();</div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">else</span> <span style="color:rgb(137, 89, 168);">if</span> (nanos &gt; <span style="color:rgb(113, 140, 0);">0L</span>)</div><div style="height:20px;">                    nanos = trip.awaitNanos(nanos);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException ie) {</div><div style="height:20px;">                <span style="color:rgb(142, 144, 140);">// 如果等待过程中，线程被中断，通过breakBarrier()终止CyclicBarrier，唤醒CyclicBarrier中所有等待线</span></div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">if</span> (g == generation &amp;&amp; ! g.broken) {</div><div style="height:20px;">                    breakBarrier();</div><div style="height:20px;">                    <span style="color:rgb(137, 89, 168);">throw</span> ie;</div><div style="height:20px;">                } <span style="color:rgb(137, 89, 168);">else</span> {</div><div style="height:20px;">                    Thread.currentThread().interrupt();</div><div style="height:20px;">                }</div><div style="height:20px;">            }</div><div style="height:20px;"></div><div style="height:20px;">            <span style="color:rgb(142, 144, 140);">// borken</span></div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">if</span> (g.broken)</div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> BrokenBarrierException();</div><div style="height:20px;"></div><div style="height:20px;">            <span style="color:rgb(142, 144, 140);">// 如果generation已经换代，则返回index。</span></div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">if</span> (g != generation)</div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">return</span> index;</div><div style="height:20px;"></div><div style="height:20px;">            <span style="color:rgb(142, 144, 140);">// 超时，则通过breakBarrier()终止CyclicBarrier，唤醒CyclicBarrier中所有等待线程。</span></div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">if</span> (timed &amp;&amp; nanos &lt;= <span style="color:rgb(113, 140, 0);">0L</span>) {</div><div style="height:20px;">                breakBarrier();</div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> TimeoutException();</div><div style="height:20px;">            }</div><div style="height:20px;">        }</div><div style="height:20px;">    } <span style="color:rgb(137, 89, 168);">finally</span> {</div><div style="height:20px;">        lock.unlock(); <span style="color:rgb(142, 144, 140);">// 释放独占锁</span></div><div style="height:20px;">    }</div><div style="height:20px;">}</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// barrier被broken后，调用breakBarrier方法，将generation.broken设置为true，并使用signalAll通知所有等待的线程。</span></div><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">breakBarrier</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">    generation.broken = <span style="color:rgb(137, 89, 168);">true</span>;</div><div style="height:20px;">    count = parties;</div><div style="height:20px;">    trip.signalAll();</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="使用场景"></a>使用场景</h4><p style="margin:0px 0px 25px;">CyclicBarrier可以用于多线程计算数据，最后合并计算结果的场景，然后四条线程又可以分别去干自己的事情了。</p><p style="margin:0px 0px 25px;">现在我将上面的统计磁盘的任务 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">CountDownLatch</code> 中改下，统计完统计最终后，每个线程要发出退出信号。</p><p style="margin:0px 0px 25px;">下面是我的实现代码：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div><div style="height:20px;">39</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(137, 89, 168);">public</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">CyclicBarrierDemo</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">main</span><span style="color:rgb(245, 135, 31);">(String[] args)</span> </span>{</div><div style="height:20px;">        String[] drivers = {<span style="color:rgb(113, 140, 0);">&quot;C&quot;</span>, <span style="color:rgb(113, 140, 0);">&quot;D&quot;</span>, <span style="color:rgb(113, 140, 0);">&quot;E&quot;</span>, <span style="color:rgb(113, 140, 0);">&quot;F&quot;</span>};</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">int</span> length = drivers.length;</div><div style="height:20px;">        ExecutorService pool = Executors.newFixedThreadPool(length);</div><div style="height:20px;">        <span style="color:rgb(142, 144, 140);">// 如果线程都到达barrier状态后，会从四个线程中选择一个线程去执行Runnable。</span></div><div style="height:20px;">        CyclicBarrier cyclicBarrier = <span style="color:rgb(137, 89, 168);">new</span> CyclicBarrier(length, () -&gt; {</div><div style="height:20px;">            System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;%s 线程告诉你，统计完毕，待继续执行%n&quot;</span>, Thread.currentThread().getName());</div><div style="height:20px;">        });</div><div style="height:20px;">        Stream.of(drivers).forEach((d) -&gt; {</div><div style="height:20px;">            pool.execute(<span style="color:rgb(137, 89, 168);">new</span> StatisticsDemo(d, cyclicBarrier));</div><div style="height:20px;">        });</div><div style="height:20px;">        pool.shutdown();</div><div style="height:20px;">    }</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">static</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">StatisticsDemo</span> <span style="color:rgb(137, 89, 168);">implements</span> <span style="color:rgb(62, 153, 159);">Runnable</span> </span>{</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">private</span> String driveName;</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">private</span> CyclicBarrier cyclicBarrier;</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(62, 153, 159);">StatisticsDemo</span><span style="color:rgb(245, 135, 31);">(String driveName, CyclicBarrier cyclicBarrier)</span> </span>{</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">this</span>.driveName = driveName;</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">this</span>.cyclicBarrier = cyclicBarrier;</div><div style="height:20px;">        }</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">@Override</span></div><div style="height:20px;">        <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">run</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                TimeUnit.SECONDS.sleep((<span style="color:rgb(137, 89, 168);">int</span>) (Math.random() * <span style="color:rgb(113, 140, 0);">10</span>));</div><div style="height:20px;">                System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;%s 线程统计 %s 盘大小%n&quot;</span>, Thread.currentThread().getName(), driveName);</div><div style="height:20px;">                cyclicBarrier.await();</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException | BrokenBarrierException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">            System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;%s 准备退出%n&quot;</span>, driveName);</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">执行结果：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">pool-<span style="color:rgb(113, 140, 0);">1</span>-thread-<span style="color:rgb(113, 140, 0);">1</span> 线程统计 C 盘大小</div><div style="height:20px;">pool-<span style="color:rgb(113, 140, 0);">1</span>-thread-<span style="color:rgb(113, 140, 0);">2</span> 线程统计 D 盘大小</div><div style="height:20px;">pool-<span style="color:rgb(113, 140, 0);">1</span>-thread-<span style="color:rgb(113, 140, 0);">3</span> 线程统计 E 盘大小</div><div style="height:20px;">pool-<span style="color:rgb(113, 140, 0);">1</span>-thread-<span style="color:rgb(113, 140, 0);">4</span> 线程统计 F 盘大小</div><div style="height:20px;">pool-<span style="color:rgb(113, 140, 0);">1</span>-thread-<span style="color:rgb(113, 140, 0);">4</span> 线程告诉你，统计完毕，待继续执行</div><div style="height:20px;">F 准备退出</div><div style="height:20px;">E 准备退出</div><div style="height:20px;">D 准备退出</div><div style="height:20px;">C 准备退出</div></pre></td></tr></tbody></table></div><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%8E%A7%E5%88%B6%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B%E6%95%B0%E7%9A%84Semaphore" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="控制并发线程数的Semaphore"></a>控制并发线程数的Semaphore</h3><blockquote style="margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);"><p style="margin:0px 0px 25px;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">Semaphore</code>（信号量）是用来控制同时访问特定资源的线程数量（许可证数），它通过协调各个线程，以保证合理的使用公共资源。</p></blockquote><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="源码分析"></a>源码分析</h4><h5 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-1" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="构造函数"></a>构造函数</h5><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(62, 153, 159);">Semaphore</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> permits)</span> </span>{</div><div style="height:20px;">     sync = <span style="color:rgb(137, 89, 168);">new</span> NonfairSync(permits);</div><div style="height:20px;">}</div><div style="height:20px;"><span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(62, 153, 159);">Semaphore</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> permits, <span style="color:rgb(137, 89, 168);">boolean</span> fair)</span> </span>{</div><div style="height:20px;">    sync = fair ? <span style="color:rgb(137, 89, 168);">new</span> FairSync(permits) : <span style="color:rgb(137, 89, 168);">new</span> NonfairSync(permits);</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">具有公平锁的特性，<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">permits</code> 指定许可数量，就是资源数量 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">state</code>。</p><h5 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E5%90%8C%E6%AD%A5%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="同步器的实现"></a>同步器的实现</h5><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div><div style="height:20px;">39</div><div style="height:20px;">40</div><div style="height:20px;">41</div><div style="height:20px;">42</div><div style="height:20px;">43</div><div style="height:20px;">44</div><div style="height:20px;">45</div><div style="height:20px;">46</div><div style="height:20px;">47</div><div style="height:20px;">48</div><div style="height:20px;">49</div><div style="height:20px;">50</div><div style="height:20px;">51</div><div style="height:20px;">52</div><div style="height:20px;">53</div><div style="height:20px;">54</div><div style="height:20px;">55</div><div style="height:20px;">56</div><div style="height:20px;">57</div><div style="height:20px;">58</div><div style="height:20px;">59</div><div style="height:20px;">60</div><div style="height:20px;">61</div><div style="height:20px;">62</div><div style="height:20px;">63</div><div style="height:20px;">64</div><div style="height:20px;">65</div><div style="height:20px;">66</div><div style="height:20px;">67</div><div style="height:20px;">68</div><div style="height:20px;">69</div><div style="height:20px;">70</div><div style="height:20px;">71</div><div style="height:20px;">72</div><div style="height:20px;">73</div><div style="height:20px;">74</div><div style="height:20px;">75</div><div style="height:20px;">76</div><div style="height:20px;">77</div><div style="height:20px;">78</div><div style="height:20px;">79</div><div style="height:20px;">80</div><div style="height:20px;">81</div><div style="height:20px;">82</div><div style="height:20px;">83</div><div style="height:20px;">84</div><div style="height:20px;">85</div><div style="height:20px;">86</div><div style="height:20px;">87</div><div style="height:20px;">88</div><div style="height:20px;">89</div><div style="height:20px;">90</div><div style="height:20px;">91</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">  <span style="color:rgb(137, 89, 168);">abstract</span> <span style="color:rgb(137, 89, 168);">static</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">Sync</span> <span style="color:rgb(137, 89, 168);">extends</span> <span style="color:rgb(62, 153, 159);">AbstractQueuedSynchronizer</span> </span>{</div><div style="height:20px;">      <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">long</span> serialVersionUID = <span style="color:rgb(113, 140, 0);">1192457210091910933L</span>;</div><div style="height:20px;"></div><div style="height:20px;">      Sync(<span style="color:rgb(137, 89, 168);">int</span> permits) {</div><div style="height:20px;">          setState(permits);</div><div style="height:20px;">      }</div><div style="height:20px;"></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">getPermits</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">return</span> getState();</div><div style="height:20px;">      }</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 非公平的方式获取共享锁</span></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">nonfairTryAcquireShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> acquires)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(142, 144, 140);">// 获取资源数量</span></div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> available = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> remaining = available - acquires; <span style="color:rgb(142, 144, 140);">// 本次请求获取锁需要的资源的数量</span></div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (remaining &lt; <span style="color:rgb(113, 140, 0);">0</span> ||</div><div style="height:20px;">                  compareAndSetState(available, remaining)) <span style="color:rgb(142, 144, 140);">// 如果资源足够，尝试 CAS 获取锁</span></div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> remaining;</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 释放锁</span></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">boolean</span> <span style="color:rgb(62, 153, 159);">tryReleaseShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> releases)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> current = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> next = current + releases; <span style="color:rgb(142, 144, 140);">// 释放锁的时候，返还资源</span></div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (next &lt; current) <span style="color:rgb(142, 144, 140);">// overflow</span></div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> Error(<span style="color:rgb(113, 140, 0);">&quot;Maximum permit count exceeded&quot;</span>);</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (compareAndSetState(current, next)) <span style="color:rgb(142, 144, 140);">// CAS 操作，避免其他的线程也在释放资源</span></div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> <span style="color:rgb(137, 89, 168);">true</span>;</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 减少资源数量</span></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">reducePermits</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> reductions)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> current = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> next = current - reductions;</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (next &gt; current) <span style="color:rgb(142, 144, 140);">// underflow</span></div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">throw</span> <span style="color:rgb(137, 89, 168);">new</span> Error(<span style="color:rgb(113, 140, 0);">&quot;Permit count underflow&quot;</span>);</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (compareAndSetState(current, next))</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span>;</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;"><span style="color:rgb(142, 144, 140);">// 清空资源，返回历史资源数量</span></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">drainPermits</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> current = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (current == <span style="color:rgb(113, 140, 0);">0</span> || compareAndSetState(current, <span style="color:rgb(113, 140, 0);">0</span>))</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> current;</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;">  }</div><div style="height:20px;"></div><div style="height:20px;">  <span style="color:rgb(142, 144, 140);">/**</span></div><div style="height:20px;">   * NonFair version</div><div style="height:20px;">   */</div><div style="height:20px;">  <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">NonfairSync</span> <span style="color:rgb(137, 89, 168);">extends</span> <span style="color:rgb(62, 153, 159);">Sync</span> </span>{</div><div style="height:20px;">      <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">long</span> serialVersionUID = -<span style="color:rgb(113, 140, 0);">2694183684443567898L</span>;</div><div style="height:20px;"></div><div style="height:20px;">      NonfairSync(<span style="color:rgb(137, 89, 168);">int</span> permits) {</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">super</span>(permits);</div><div style="height:20px;">      }</div><div style="height:20px;"></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">tryAcquireShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> acquires)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">return</span> nonfairTryAcquireShared(acquires);</div><div style="height:20px;">      }</div><div style="height:20px;">  }</div><div style="height:20px;"></div><div style="height:20px;">  <span style="color:rgb(142, 144, 140);">/**</span></div><div style="height:20px;">   * Fair version</div><div style="height:20px;">   */</div><div style="height:20px;">  <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">FairSync</span> <span style="color:rgb(137, 89, 168);">extends</span> <span style="color:rgb(62, 153, 159);">Sync</span> </span>{</div><div style="height:20px;">      <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> <span style="color:rgb(137, 89, 168);">long</span> serialVersionUID = <span style="color:rgb(113, 140, 0);">2014338818796000944L</span>;</div><div style="height:20px;"></div><div style="height:20px;">      FairSync(<span style="color:rgb(137, 89, 168);">int</span> permits) {</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">super</span>(permits);</div><div style="height:20px;">      }</div><div style="height:20px;"></div><div style="height:20px;">      <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">protected</span> <span style="color:rgb(137, 89, 168);">int</span> <span style="color:rgb(62, 153, 159);">tryAcquireShared</span><span style="color:rgb(245, 135, 31);">(<span style="color:rgb(137, 89, 168);">int</span> acquires)</span> </span>{</div><div style="height:20px;">          <span style="color:rgb(137, 89, 168);">for</span> (;;) {</div><div style="height:20px;">              <span style="color:rgb(142, 144, 140);">// 同样的公平锁情况下，判断该线程前面有没有线程等待获取锁</span></div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (hasQueuedPredecessors())</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> -<span style="color:rgb(113, 140, 0);">1</span>;</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> available = getState();</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">int</span> remaining = available - acquires;</div><div style="height:20px;">              <span style="color:rgb(137, 89, 168);">if</span> (remaining &lt; <span style="color:rgb(113, 140, 0);">0</span> ||</div><div style="height:20px;">                  compareAndSetState(available, remaining))</div><div style="height:20px;">                  <span style="color:rgb(137, 89, 168);">return</span> remaining;</div><div style="height:20px;">          }</div><div style="height:20px;">      }</div><div style="height:20px;">  }</div></pre></td></tr></tbody></table></div><h5 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:16px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%8F%90%E4%BE%9B%E5%85%B6%E4%BB%96%E7%9A%84%E6%96%B9%E6%B3%95" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="提供其他的方法"></a>提供其他的方法</h5><ul style="list-style-type:disc;"><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">availablePermits</code>：获取此信号量中当前可用的许可证数（还能有多少个线程执行）；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">drainPermits</code>：立刻使用完所有可用的许可证；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">reducePermits</code>：减少相应数量的许可证，是一个 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">protected</code> 方法；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">isFair</code>：是否是公平状态；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">hasQueuedThreads</code>：等待队列中是否有线程，等待获取许可证；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">getQueueLength</code>：等待队列中等待获取许可证的线程数量；</li><li style="list-style:disc;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">getQueuedThreads</code>：<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">protected</code> 方法，获取等待队列中的线程。</li></ul><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-2" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="使用场景"></a>使用场景</h4><p style="margin:0px 0px 25px;"><strong style="font-weight:700;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">Semaphore</code>可以用于做流量控制，特别是公用资源有限的应用场景</strong>，比如我们有五台机器，有十名工人，每个工人需要一台机器才能工作，一名工人工作完了就可以休息了，机器让其他没工作过的工人使用。</p><p style="margin:0px 0px 25px;">下面是我的实现代码：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(137, 89, 168);">public</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">SemaphoreDemo</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">main</span><span style="color:rgb(245, 135, 31);">(String[] args)</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">int</span> num = <span style="color:rgb(113, 140, 0);">10</span>;</div><div style="height:20px;">        Semaphore machines = <span style="color:rgb(137, 89, 168);">new</span> Semaphore(<span style="color:rgb(113, 140, 0);">5</span>);</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">for</span> (<span style="color:rgb(137, 89, 168);">int</span> i = <span style="color:rgb(113, 140, 0);">0</span>; i &lt; num; i++) {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">new</span> Thread(<span style="color:rgb(137, 89, 168);">new</span> Worker(i, machines)).start();</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">static</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">Worker</span> <span style="color:rgb(137, 89, 168);">extends</span> <span style="color:rgb(62, 153, 159);">Thread</span> </span>{</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">private</span> Semaphore machines;</div><div style="height:20px;"></div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">int</span> worker;</div><div style="height:20px;"></div><div style="height:20px;">        Worker(<span style="color:rgb(137, 89, 168);">int</span> worker, Semaphore semaphore) {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">this</span>.worker = worker;</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">this</span>.machines = semaphore;</div><div style="height:20px;">        }</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">@Override</span></div><div style="height:20px;">        <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">run</span><span style="color:rgb(245, 135, 31);">()</span> </span>{</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                machines.acquire();</div><div style="height:20px;">                System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;工人 %d 开始使用机器工作了 %n&quot;</span>, worker);</div><div style="height:20px;">                TimeUnit.SECONDS.sleep((<span style="color:rgb(137, 89, 168);">int</span>) (Math.random() * <span style="color:rgb(113, 140, 0);">10</span>));</div><div style="height:20px;">                System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;工人 %d 干完活了，让出机器了%n&quot;</span>, worker);</div><div style="height:20px;">                machines.release();</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (Exception e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;"></div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">执行一下结果：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">0</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">4</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">3</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">2</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">1</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">1</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">5</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">5</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">6</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">2</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">7</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">4</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">8</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">0</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">9</span> 开始使用机器工作了 </div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">8</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">6</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">3</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">9</span> 干完活了，让出机器了</div><div style="height:20px;">工人 <span style="color:rgb(113, 140, 0);">7</span> 干完活了，让出机器了</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">虽然上面有 10 个工人（线程）一起并发，但是，它同时只有五个工人能够是执行的。</p><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E7%BA%BF%E7%A8%8B%E9%97%B4%E4%BA%A4%E6%8D%A2%E6%95%B0%E6%8D%AE%E7%9A%84Exchanger" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="线程间交换数据的Exchanger"></a>线程间交换数据的Exchanger</h3><p style="margin:0px 0px 25px;">Exchanger（交换者）是一个用于线程间协作的工具类。Exchanger 用于两个工作线程间的数据交换。</p><p style="margin:0px 0px 25px;">具体上来说，Exchanger类允许在两个线程之间定义同步点。当两个线程都到达同步点时，他们交换数据结构，因此第一个线程的数据进入到第二个线程中，第二个线程的数据进入到第一个线程中，这要就完成了一个“交易”的环节。</p><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-3" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="源码分析"></a>源码分析</h4><p style="margin:0px 0px 25px;">源码很难看懂，主要还是</p><p style="margin:0px 0px 25px;"><a href="https://www.jianshu.com/p/c523826b2c94" rel="external nofollow noopener noreferrer" style="background-color:transparent;text-decoration:none;word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);color:rgb(5, 147, 211);border-bottom:1px solid rgb(5, 147, 211);" target="_blank">【死磕Java并发】—–J.U.C之并发工具类：Exchanger</a></p><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-3" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="使用场景"></a>使用场景</h4><p style="margin:0px 0px 25px;"><strong style="font-weight:700;">Exchanger 可以用于遗传算法</strong>。遗传算法里需要选出两个人作为交配对象，这时候会交换两人的数据。</p><p style="margin:0px 0px 25px;">下面做一个卖书买书的例子：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div><div style="height:20px;">7</div><div style="height:20px;">8</div><div style="height:20px;">9</div><div style="height:20px;">10</div><div style="height:20px;">11</div><div style="height:20px;">12</div><div style="height:20px;">13</div><div style="height:20px;">14</div><div style="height:20px;">15</div><div style="height:20px;">16</div><div style="height:20px;">17</div><div style="height:20px;">18</div><div style="height:20px;">19</div><div style="height:20px;">20</div><div style="height:20px;">21</div><div style="height:20px;">22</div><div style="height:20px;">23</div><div style="height:20px;">24</div><div style="height:20px;">25</div><div style="height:20px;">26</div><div style="height:20px;">27</div><div style="height:20px;">28</div><div style="height:20px;">29</div><div style="height:20px;">30</div><div style="height:20px;">31</div><div style="height:20px;">32</div><div style="height:20px;">33</div><div style="height:20px;">34</div><div style="height:20px;">35</div><div style="height:20px;">36</div><div style="height:20px;">37</div><div style="height:20px;">38</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;"><span style="color:rgb(137, 89, 168);">public</span> <span><span style="color:rgb(137, 89, 168);">class</span> <span style="color:rgb(62, 153, 159);">ExchangerDemo</span> </span>{</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> Exchanger&lt;String&gt; EXCHANGER = <span style="color:rgb(137, 89, 168);">new</span> Exchanger&lt;&gt;();</div><div style="height:20px;">    <span style="color:rgb(137, 89, 168);">private</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">final</span> ExecutorService POOLS = Executors.newFixedThreadPool(<span style="color:rgb(113, 140, 0);">2</span>);</div><div style="height:20px;"></div><div style="height:20px;">    <span style="color:rgb(66, 113, 174);"><span style="color:rgb(137, 89, 168);">public</span> <span style="color:rgb(137, 89, 168);">static</span> <span style="color:rgb(137, 89, 168);">void</span> <span style="color:rgb(62, 153, 159);">main</span><span style="color:rgb(245, 135, 31);">(String[] args)</span> <span style="color:rgb(137, 89, 168);">throws</span> InterruptedException </span>{</div><div style="height:20px;">        POOLS.execute(() -&gt; {</div><div style="height:20px;">            String bookName = <span style="color:rgb(113, 140, 0);">&quot;浮生六记&quot;</span>;</div><div style="height:20px;">            System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;饭饭要卖一本%s。%n&quot;</span>, bookName);</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                String pay = EXCHANGER.exchange(bookName);</div><div style="height:20px;">                System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;饭饭卖出一本%s赚了%s￥。%n&quot;</span>, bookName, pay);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">        });</div><div style="height:20px;"></div><div style="height:20px;">        TimeUnit.SECONDS.sleep(<span style="color:rgb(113, 140, 0);">5</span>);</div><div style="height:20px;">        System.out.println(<span style="color:rgb(113, 140, 0);">&quot;》》》》》》》》饭饭先到了交易地点 睡了 5 s，七巧来了&quot;</span>);</div><div style="height:20px;">        System.out.println(<span style="color:rgb(113, 140, 0);">&quot;》》》》》》》》准备交易&quot;</span>);</div><div style="height:20px;"></div><div style="height:20px;">        POOLS.execute(() -&gt; {</div><div style="height:20px;">            String pay = <span style="color:rgb(113, 140, 0);">&quot;23&quot;</span>;</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">try</span> {</div><div style="height:20px;">                String bookName = EXCHANGER.exchange(pay);</div><div style="height:20px;">                System.out.printf(<span style="color:rgb(113, 140, 0);">&quot;七巧付了%s￥买了一本%s。%n&quot;</span>, pay, bookName);</div><div style="height:20px;">            } <span style="color:rgb(137, 89, 168);">catch</span> (InterruptedException e) {</div><div style="height:20px;">                e.printStackTrace();</div><div style="height:20px;">            }</div><div style="height:20px;">        });</div><div style="height:20px;">        POOLS.shutdown();</div><div style="height:20px;">        <span style="color:rgb(137, 89, 168);">for</span> (; ; ) {</div><div style="height:20px;">            <span style="color:rgb(137, 89, 168);">if</span> (POOLS.isTerminated()) {</div><div style="height:20px;">                System.out.println(<span style="color:rgb(113, 140, 0);">&quot;交易结束！&quot;</span>);</div><div style="height:20px;">                <span style="color:rgb(137, 89, 168);">return</span>;</div><div style="height:20px;">            }</div><div style="height:20px;">        }</div><div style="height:20px;">    }</div><div style="height:20px;">}</div></pre></td></tr></tbody></table></div><p style="margin:0px 0px 25px;">执行结果：</p><div style="background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);display:block;overflow:auto;padding:9.5px;font-size:13px;color:rgb(51, 51, 51);margin:0px 0px 10px;line-height:1.45;border-radius:4px;border:none;position:relative;word-break:break-all;word-wrap:break-word;"><table style="font-weight:inherit;font-style:inherit;font-variant:inherit;font-size:14px;border-collapse:collapse;border-spacing:0px;table-layout:fixed;margin:0px;width:auto;border:none;"><tbody><tr style="background-color:rgb(249, 249, 249);"><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);user-select:none;padding:0px;border:none;"><pre style="padding-left:10px;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;display:block;background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;position:relative;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;text-align:right;background-color:rgb(239, 242, 243);color:rgb(134, 145, 148);"><div style="height:20px;">1</div><div style="height:20px;">2</div><div style="height:20px;">3</div><div style="height:20px;">4</div><div style="height:20px;">5</div><div style="height:20px;">6</div></pre></td><td style="text-align:left;vertical-align:middle;font-weight:400;border-bottom:3px solid rgb(221, 221, 221);border-right:1px solid rgb(238, 238, 238);padding:0px;border:none;"><pre style="width:100%;overflow:auto;font-size:13px;word-wrap:break-word;word-break:break-all;color:rgb(51, 51, 51);background:url(https://zqnight.gitee.io/kaimz.github.io/image/hexo-sys/blueprint.png) 0% 0% / 30px, 0% 0% / 30px rgb(246, 246, 246);line-height:1.45;display:block;font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;position:relative;border-radius:4px;border:none;padding:10px 0px;margin:0px;padding-right:10px;background-color:rgb(247, 247, 247);padding-left:10px;"><div style="height:20px;">饭饭要卖一本浮生六记。</div><div style="height:20px;">》》》》》》》》饭饭先到了交易地点 睡了 <span style="color:rgb(113, 140, 0);">5</span> s，七巧来了</div><div style="height:20px;">》》》》》》》》准备交易</div><div style="height:20px;">七巧付了<span style="color:rgb(113, 140, 0);">23</span>￥买了一本浮生六记。</div><div style="height:20px;">饭饭卖出一本浮生六记赚了<span style="color:rgb(113, 140, 0);">23</span>￥。</div><div style="height:20px;">交易结束！</div></pre></td></tr></tbody></table></div><h4 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:18px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E6%80%BB%E7%BB%93" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="总结"></a>总结</h4><p style="margin:0px 0px 25px;"><code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">Exchanger</code>主要完成的是两个工作线程之间的数据交换，如果有一个线程没有执行 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">exchange()</code>方法，则会一直等待。还可以设置最大等待时间<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">exchange（V v, TimeUnit unit）</code></p><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#CyclicBarrier%E5%92%8CCountDownLatch%E7%9A%84%E5%8C%BA%E5%88%AB" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="CyclicBarrier和CountDownLatch的区别"></a>CyclicBarrier和CountDownLatch的区别</h3><blockquote style="margin:0px;padding:0px 15px;color:rgb(102, 102, 102);border-left:4px solid rgb(221, 221, 221);"><p style="margin:0px 0px 25px;">CountDownLatch的计数器只能使用一次，而CyclicBarrier的计数器可以使用reset()方法重置。所以CyclicBarrier能处理更为复杂的业务场景。例如，如果计算发生错误，可以重置计数器，并让线程重新执行一次。</p><p style="margin:0px 0px 25px;">CyclicBarrier还提供其他有用的方法，比如<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">getNumberWaiting</code>方法可以获得 <code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">CyclicBarrier</code>阻塞的线程数量。<code style="font-family:&quot;Source Code Pro&quot;, Consolas, Menlo, Monaco, &quot;Courier New&quot;, monospace;font-size:90%;padding:2px 4px;word-wrap:break-word;color:rgb(199, 37, 78);background:rgb(238, 238, 238);border-radius:4px;background-color:rgb(249, 242, 244);">isBroken()</code>方法用来了解阻塞的线程是否被中断。</p></blockquote><h3 style="margin:20px 0px 10px;padding:0px;font-weight:700;line-height:1.5;font-family:&quot;Roboto Slab&quot;, Monda, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:20px;padding-top:10px;"><a href="https://blog.wuwii.com/juc-utils.html#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" style="background-color:transparent;color:rgb(100, 154, 182);text-decoration:none;border-bottom:none;word-wrap:break-word;" title="参考文章"></a>参考文章</h3><ul style="list-style-type:disc;"><li style="list-style:disc;">《Java 并发编程的艺术》</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:14px;">------本文结束  感谢阅读------</div></div></div><div></div><div></div><div></div><div style="display:block;"><div style="margin-top:40px;text-align:left;"><a href="https://blog.wuwii.com/tags/java/" rel="tag" style="font-size:13px;color:rgb(100, 154, 182);text-decoration:none;word-wrap:break-word;display:inline-block;margin-right:10px;border-bottom:none;padding:1px 5px;background:rgb(245, 245, 245);box-shadow:rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;font-family:&quot;Comic Sans MS&quot;, sans-serif;transition:0.2s ease-out;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> java</a> <a href="https://blog.wuwii.com/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" rel="tag" style="font-size:13px;color:rgb(100, 154, 182);text-decoration:none;word-wrap:break-word;display:inline-block;margin-right:10px;border-bottom:none;padding:1px 5px;background:rgb(245, 245, 245);box-shadow:rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;font-family:&quot;Comic Sans MS&quot;, sans-serif;transition:0.2s ease-out;"><i style="display:inline-block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:FontAwesome;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:inherit;"></span></i> 并发编程</a></div><div style="display:table;width:100%;border-top:1px solid rgb(238, 238, 238);margin-top:40px;"><div style="display:table-cell;padding:10px 0px 0px;width:45%;vertical-align:top;"><a href="https://blog.wuwii.com/java-aqs.html" rel="next" style="position:relative;background-color:transparent;text-decoration:none;word-wrap:break-word;border-bottom-color:rgb(204, 204, 204);border-bottom:none;color:rgb(85, 85, 85);display:block;line-height:25px;font-size:14px;padding-left:15px;" title="Java 并发编程同步器 AQS"><i style="font-family:FontAwesome;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;font-style:normal;-webkit-font-smoothing:antialiased;text-rendering:auto;font-size:12px;position:absolute;top:8px;left:0px;"><span style="font-style:normal;font-variant:normal;font-weight:normal;line-height:1;font-family:FontAwesome;font-size:12px;"></span></i> Java 并发编程同步器 AQS</a></div><span style="display:table-cell;width:10%;"></span><div style="display:table-cell;padding:10px 0px 0px;width:45%;vertical-align:top;text-align:right;"></div></div></div></div></div></div></div></div></span></div></div></div></div>
</div>
</span>
</div></body></html> 