<html>
<head>
  <title>知乎容器化构建系统设计和实践</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="474"/>
<h1>知乎容器化构建系统设计和实践</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/6/11 10:07</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://zhuanlan.zhihu.com/p/45694823"><i>https://zhuanlan.zhihu.com/p/45694823</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-family:-apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(26, 26, 26);background:rgb(255, 255, 255);-webkit-tap-highlight-color:rgba(26, 26, 26, 0);"><div><div><span><div style="background:rgb(255, 255, 255);"><div style="box-sizing:border-box;overflow:hidden;"><div style="overflow:hidden;width:690px;margin:0px auto;"><h1 style="margin:24px 0px;font:inherit;font-weight:600;font-size:24px;line-height:1.22;overflow-wrap:break-word;">知乎容器化构建系统设计和实践</h1><div style="display:flex;-webkit-box-align:center;align-items:center;"><div style="display:flex;-webkit-box-align:center;align-items:center;-webkit-box-flex:1;flex:1 1 0%;white-space:nowrap;overflow:hidden;"><span><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/amylewis777" style="color:inherit;text-decoration:none;" target="_blank"><img src="知乎容器化构建系统设计和实践_files/v2-ae5845426cc20fb4d2c5bd90215715d3_xs.jpg" type="image/jpeg" data-filename="v2-ae5845426cc20fb4d2c5bd90215715d3_xs.jpg" alt="Amyyyyy" height="38" style="background:rgb(255, 255, 255);border-radius:50%;vertical-align:top;" width="38"/></a></div></div></span><div style="-webkit-box-flex:1;flex:1 1 0%;margin-left:14px;overflow:hidden;"><div style="display:flex;-webkit-box-align:center;align-items:center;font-size:15px;line-height:1.1;flex-shrink:0;"><span style="font-weight:600;color:rgb(68, 68, 68);"><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/amylewis777" style="color:inherit;text-decoration:none;" target="_blank">Amyyyyy</a></div></div></span></div><div style="overflow:hidden;color:rgb(100, 100, 100);"><div style="display:flex;-webkit-box-align:center;align-items:center;margin-top:2px;font-size:14px;"><div style="word-break:break-word;line-height:1.6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgb(100, 100, 100);">Plunge boldly into the thick of life</div></div></div></div></div></div><div><span style="color:rgb(133, 144, 166);display:block;margin-top:14px;font-size:14px;"></span></div></div><div style="overflow:visible;width:690px;margin:0px auto;"><div style="word-break:break-word;line-height:1.6;margin-top:20px;"><p style="margin:1.4em 0px;margin-top:0px;"><b style="font-weight:600;">Table of Content:</b></p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>关于</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>背景</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>完整的生命周期</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>达到的目标以及中间遇到的问题</li><ul style="padding:0px;margin:0px;display:table-row;"><span style="display:table-cell;"></span><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>较低的接入成本，较高的定制能力</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>语言开放性</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>减少不稳定构建，降低问题复现成本</li><ul style="padding:0px;margin:0px;display:table-row;"><span style="display:table-cell;"></span><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>缓存的设计</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>依赖获取稳定性</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>更低的排查错误的成本</li></ul><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>规范和标准的落地抓手</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>高可用和可扩展的集群</li><ul style="padding:0px;margin:0px;display:table-row;"><span style="display:table-cell;"></span><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Job 调度策略</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>集群设计和故障恢复</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>监控报警</li></ul></ul><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>后续的计划</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>参考资料</li></ul><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">关于</b></h2><p style="margin:1.4em 0px;">知乎应用平台团队基于 Jenkins Pipeline 和 Docker 打造了一套持续集成系统。Jenkins Master 和 Slave 基于 Docker 部署，每次构建也是在容器中进行。目前有三千个 Jenkins Job，支撑着整个团队每日近万次的构建和部署量。</p><p style="margin:1.4em 0px;">整个系统的设计目标是具备以下的能力：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>较低的应用接入成本，较高的定制能力：写一个构建系统配置文件成本要尽可能简单方便，或者可以通过模板一键创建，但又要能满足应用的各种定制化的需求。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>具备语言开放性和部署多样性：平台需要能支撑业务技术选型上的多语言，同时，要能满足应用不同的部署类型，如单纯的打包发布，或者进一步部署到物理机、容器、离线任务平台等。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>构建快和稳定，复现问题成本低：每次构建都在干净的容器中，减少非应用本身问题带来的构建异常。同时，如果构建出现问题，在权限控制的前提下，要能方便开发者自己调试和排查。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>推动业界标准以及最佳实践，同时在代码合并之前就能更好把控住质量。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>整个集群高可用，可扩展，以及具备较低的运维成本。</li></ul><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">背景</b></h2><p style="margin:1.4em 0px;">知乎选用 Jenkins 作为构建方案，因其强大和灵活，且有非常丰富的插件可供使用和扩展。</p><p style="margin:1.4em 0px;">早期，应用数量较少时，每个开发者都手动创建并维护着几个 Job，各自编写 Jenkins Job 的配置，以及手动触发构建。随着服务化以及业务类型，开发者以及 Jenkins Job 数量的增加，我们面临了以下的问题：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>每个开发者都需要去理解 Jenkins 的基本配置和触发逻辑，使得配置创建和维护成本高。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>构建在物理机上进行，每个应用可能有着不同的版本依赖，构建时会遇到版本冲突，甚至上线之后发现行为不一致导致故障等。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>构建一旦失败，需要开发者能登录 Jenkins Slave 所在的物理机进行调试，权限控制成为了一个问题</li></ul><p style="margin:1.4em 0px;">于是，一个能方便应用接入构建部署的系统，成为了必须。</p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">完整的生命周期</b></h2><p style="margin:1.4em 0px;">知乎的构建工作流主要是以下两种场景：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>只有 Master 分支的代码可以用于线上部署，但支持指定任意的分支进行构建</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>所有对 Master 分支的修改必须通过 Merge Request 来进行。为了避免潜在代码冲突导致测试结果不准的情况，对 Merge Request 上的代码进行构建前，会模拟跟 Master 分支的代码做一次合并。</li></ul><p style="margin:1.4em 0px;">一个 Commit 从提交到最后部署，会经历以下的环节：</p><div style="margin:1.4em 0px;"><img src="知乎容器化构建系统设计和实践_files/v2-6b5f8ce11e87012986069c4a5a16117b_hd.jpg" type="image/jpeg" data-filename="v2-6b5f8ce11e87012986069c4a5a16117b_hd.jpg" height="471" style="margin:0px auto;display:block;max-width:100%;cursor:zoom-in;" width="1638"/></div><ol style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">1</span>开发者提交代码到 GitLab。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">2</span>GitLab 通过 Webhook 通知到 ZAE (Zhihu App Engine， 知乎的私有云平台)。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">3</span>ZAE 将构建的上下文信息，如 GitLab 仓库 ID，ZAE 应用信息给到构建系统 Lavie。目前只处理用户提交 MR 以及合并到 Master 分支的事件。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">4</span>构建系统 Lavie 读取应用仓库中的配置文件后生成配置，触发一个构建。在构建过程中获取动态生成的 Jenkinsfile，生成 Dockerfile 构建出应用的镜像，并跑起容器，在容器中执行构建，测试等应用指定的步骤。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">5</span>测试成功之后，分别往物理机部署平台，容器部署平台，离线任务平台上传 Artifact，注册待发布版本的信息，并 Slack 通知用户结果。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">6</span>构建结束，用户在 ZAE 上可以进行后续操作，如选择一个候选版本进行部署。</li></ol><p style="margin:1.4em 0px;">每个应用的拉取代码，准备数据库，处理测试覆盖率，发送消息，候选版本的注册等通用的部分，都会由构建系统统一处理，而接入构建系统的应用，只需要在代码仓库中包含一个约定格式的配置文件。</p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">达到的目标以及中间遇到的问题</b></h2><ol style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;text-align:right;white-space:pre;">1</span><b style="font-weight:600;">较低的接入成本，较高的定制能力</b></li></ol><p style="margin:1.4em 0px;">构建系统去理解应用要做的事情靠的是约定格式的 yaml 配置文件，而我们希望这个配置文件能足够简单，声明上必要的部分，如环境、构建、测试步骤就能开始构建。</p><p style="margin:1.4em 0px;">同时，也要有能力提供更多的定制功能让应用可以使用，如选择系统依赖和版本，缓存的路径，是否需要构建系统提供 MySQL 以及需要的 MySQL 版本等。以及可以根据应用的类别自动生成配置文件。</p><p style="margin:1.4em 0px;">一个最简单的应用场景:</p><div style="margin:1em 0px;"><pre style="margin:0px;padding:0.88889em;font-size:0.9em;word-break:normal;overflow-wrap:normal;white-space:pre;overflow:auto;background:rgb(246, 246, 246);border-radius:4px;"><code style="margin:0px;padding:0px;border-radius:0px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:inherit;background-color:inherit;">base_image<span>:</span><span style="color:rgb(191, 191, 191);"> </span>python2/jessie<span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);"></span>build<span>:</span><span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);">  </span>-<span style="color:rgb(191, 191, 191);"> </span>buildout<span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);"></span>test<span>:</span><span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);">  </span>unittest<span>:</span><span style="color:rgb(191, 191, 191);">
</span><span style="color:rgb(191, 191, 191);">    </span>-<span style="color:rgb(191, 191, 191);"> </span>bin/test<span style="color:rgb(191, 191, 191);"> </span>--cover-package=pin<span style="color:rgb(191, 191, 191);"> </span>--with-xunit<span style="color:rgb(191, 191, 191);"> </span>--with-coverage<span style="color:rgb(191, 191, 191);"> </span>--cover-xml</code></pre></div><p style="margin:1.4em 0px;">一个更多定制化的场景:</p><div style="margin:1em 0px;"><pre style="margin:0px;padding:0.88889em;font-size:0.9em;word-break:normal;overflow-wrap:normal;white-space:pre;overflow:auto;background:rgb(246, 246, 246);border-radius:4px;"><code style="margin:0px;padding:0px;border-radius:0px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:inherit;background-color:inherit;">base_image: py_node/jessie
deps:
  - libffi-dev
build:
  - buildout
  - cd admin &amp;&amp; npm install &amp;&amp; gulp
test:
  deps:
    - mysql:5.7
  unittest:
    - bin/test --cover-package=lived,liveweb --with-xunit --with-coverage
  coverage_test:
    report_fpath: coverage.xml
post_build:
  scripts:
    - /bin/bash scripts/release_sentry.sh
artifacts:
  targets:
    - docker
    - tarball
cache:
  directories:
    - admin/static/components
    - admin/node_modules</code></pre></div><p style="margin:1.4em 0px;">为了尽可能满足多样化的业务场景，我们主要将配置文件分为三部分：声明环境和依赖、构建相关核心环节、声明 Artifact 类型。</p><p style="margin:1.4em 0px;"><u style="text-decoration:none;border-bottom:1px dashed grey;">声明环境和依赖</u></p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">image</code>，基础镜像，需要指明已提前准备好的语言镜像</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">deps</code>，dependencies 的简写, 声明使用的系统依赖以及对应的版本</li></ul><p style="margin:1.4em 0px;"><u style="text-decoration:none;border-bottom:1px dashed grey;">构建相关核心环节</u></p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">build</code>，构建的步骤，如 buildout, npm install ，或者执行一个脚本</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">test</code>，测试环节，应用需要声明构建的步骤，也可以在这里定制使用的 MySQL 以及对应的版本。构建系统会每次为其创建新的数据库，将关键信息 export 为环境变量。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">post build</code>，最后一个环节，如发包，发 Slack 、邮件通知，或发布一个 Sentry release 等</li></ul><p style="margin:1.4em 0px;"><u style="text-decoration:none;border-bottom:1px dashed grey;">声明 Artifact 类型</u></p><p style="margin:1.4em 0px;">artifact，用于选择部署的类型, 目前支持的有：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">tarball</code>：构建系统会将整个应用 Workspace 打包上传到 HDFS 用于后续的物理机部署</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">docker</code>：镜像会被 push 到私有的 Docker Registry 用于容器部署</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">static</code>：应用指定的路径打包后会被上传到 HDFS，用于后续的静态资源部署</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span><code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">offline</code>:  应用指定的文件会被上传到离线平台，用于离线任务的执行</li></ul><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">2. 语言开放性</b></h2><p style="margin:1.4em 0px;">早期所有的构建都在物理机上进行，构建之前需要提前在物理机上安装好对应的系统依赖，而如果遇到所需要的版本不同时，调度和维护的成本就高了很多。随着团队业务数量和种类的增加，技术选型的演进，这样的挑战越来越大。于是构建系统整体的优化方向由物理机向 Docker 容器化前进，如今，所有构建都容器中进行，基础的语言镜像由应用自己选择。</p><p style="margin:1.4em 0px;">目前镜像管理的方式是:</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>我们会事先准备好系统的基础镜像</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>在系统镜像的基础上，会构建出不同的语言镜像供应用使用，如 Python，Golang，Java，Node，Rust 的各种版本以及混合语言的镜像。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>在应用指定的<code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">image</code>语言镜像之上，会安装上 <code style="margin:0px 2px;padding:3px 4px;border-radius:3px;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;font-size:0.9em;background-color:rgb(246, 246, 246);">deps</code> 指定的系统依赖，再构建出应用的镜像，应用会在这个环境里面进行构建测试等。</li></ul><div style="margin:1.4em 0px;"><img src="知乎容器化构建系统设计和实践_files/v2-70e626008ffcdc8b7a6a691b36fa5f28_hd.jpg" type="image/jpeg" data-filename="v2-70e626008ffcdc8b7a6a691b36fa5f28_hd.jpg" height="433" style="margin:0px auto;display:block;max-width:100%;cursor:zoom-in;" width="1202"/></div><p style="margin:1.4em 0px;"><br/>语言这一层的 Dockerfile 会被严格 review，通过的镜像才能被使用，以更好了解和支持业务技术选型和使用场景。</p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">3. 减少不稳定构建，降低问题复现成本</b></h2><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">缓存的设计</b></h2><p style="margin:1.4em 0px;">最开始构建的缓存是落在对应的 Jenkins Slave 上的，随着 Slave 数量的增多，应用构建被分配到不同 Slave 带来的代价也越来越大。</p><p style="margin:1.4em 0px;">为了让 Slave 的管理更加灵活以及构建速度和 Slave 无关，我们最后将缓存按照应用使用的镜像和系统依赖作为缓存的标识，上传到 HDFS。在每次构建前拉取，构建之后再上传更新。</p><p style="margin:1.4em 0px;">针对镜像涉及到的语言，我们会对常见的依赖进行缓存，如 eggs, node_modules, .ivy2/cache, .ivy2/repository。应用如果有其他的文件想要缓存，也支持在配置文件中指定。</p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">依赖获取稳定性</b></h2><p style="margin:1.4em 0px;">在对整个构建时间的开销和不稳定因素的观察中，我们发现拉取外部依赖是个非常耗时且失败率较高的环节。</p><p style="margin:1.4em 0px;">为了让这个过程更加稳定，我们做了以下的事情：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>完善内部不同语言的源</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>在不同语言的基础镜像中放入优先使用内部源的配置</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>搭建 HTTP Proxy，提供给以上覆盖不到的场景</li></ul><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">更低的排查错误的成本</b></h2><p style="margin:1.4em 0px;">本地开发和构建环境存在明显的差异，可能会出现本地构建成功但是在构建系统失败的情况。</p><p style="margin:1.4em 0px;">为了让用户能够快速重现，我们在项目 <u style="text-decoration:none;border-bottom:1px dashed grey;"><a href="https://link.zhihu.com/?target=https%3A//github.com/alash3al/dockssh" rel="nofollow noreferrer" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid grey;" target="_blank">docker-ssh</a></u> 的基础上做了二次开发，支持直接 ssh 到容器进行调试。由于容器环境与其他人的构建相隔离，我们不必担心 ssh 权限导致的各种安全问题。构建失败的容器会多保留一天，之后便被回收。</p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">4. 规范和标准的落地抓手</b></h2><p style="margin:1.4em 0px;">我们希望能给接入到构建系统的提高效率的同时，也希望能推动一些标准或者好的实践，比如完善测试。</p><p style="margin:1.4em 0px;">围绕着测试和测试覆盖率，我们做了以下的事情：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>配置文件中强制要有测试环节。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>应用测试结束之后，取到代码覆盖率的报告并打点。在提交的 Merge Request 评论中会给出现在的值和主分支的值的比较，以及最近主分支代码覆盖率的变化趋势。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>在知乎有应用重要性的分级，对于重要的应用，构建系统会对其要求有测试覆盖率报告，以及更高的测试覆盖率。</li></ul><div style="margin:1.4em 0px;"><img src="知乎容器化构建系统设计和实践_files/v2-b0fdafa005acee7e27dabb3cee1e04a3_hd.jpg" type="image/jpeg" data-filename="v2-b0fdafa005acee7e27dabb3cee1e04a3_hd.jpg" height="111" style="margin:0px auto;display:block;max-width:100%;cursor:zoom-in;" width="1020"/></div><p style="margin:-0.8em 0px;"><br/></p><p style="margin:1.4em 0px;">对于团队内或者业界的基础库，如果发现有更稳定版本或者发现有严重问题，构建系统会按照应用的重要性，从低到高提示应用去升级或者去掉对应依赖。</p><div style="margin:1.4em 0px;"><img src="知乎容器化构建系统设计和实践_files/v2-73b8b33cf384a682006ac232a54cc473_hd.jpg" type="image/jpeg" data-filename="v2-73b8b33cf384a682006ac232a54cc473_hd.jpg" height="120" style="margin:0px auto;display:block;max-width:100%;cursor:zoom-in;" width="1478"/></div><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">5. 高可用和可扩展的集群</b></h2><p style="margin:1.4em 0px;"><b style="font-weight:600;">Job 调度策略</b></p><p style="margin:1.4em 0px;">Jenkins Master 只进行任务的调度，而实际执行是在不同的 Jenkins Node 上。</p><p style="margin:1.4em 0px;">每个 Node 会被赋予一些 label 用于任务调度，比如：mysql:5.6, mysql:5.7, common 等。构建系统会根据应用的类型分配到不同的 label，由 Jenkins Master 去进一步调度任务到对应的 Node 上。</p><p style="margin:-0.8em 0px;"><br/></p><p style="margin:1.4em 0px;"><b style="font-weight:600;">高可用设计</b></p><p style="margin:1.4em 0px;">集群的设计如下，一个 Node 对应的是一台物理机，上面跑了 Jenkins Slave （分别连 Master 和 Master Standby），Docker Deamon 和 MySQL（为应用提供测试的 MySQL）。</p><div style="margin:1.4em 0px;"><img src="知乎容器化构建系统设计和实践_files/v2-3914e13b5424ad6c68d3aa4609b84294_hd.jpg" type="image/jpeg" data-filename="v2-3914e13b5424ad6c68d3aa4609b84294_hd.jpg" height="350" style="margin:0px auto;display:block;max-width:100%;cursor:zoom-in;" width="1420"/></div><p style="margin:1.4em 0px;">Slave 连接 Master 等待被调度，而当 Jenkins Slave 出现故障时，只需摘掉这台 Slave 的 label，后续将不会有任务调度调度上来。</p><p style="margin:1.4em 0px;">而当 Jenkins Master 故障时，如果不能短时间启动起来时，集群可能就处于不可用状态了，从而影响整个构建部署。为了减少这种情况带来的不可用，我们采用了双 Master 模型，一台作为 Standby，如果其中一台出现异常就切换到另一台健康的 Master。</p><p style="margin:1.4em 0px;"><b style="font-weight:600;">监控和报警</b></p><p style="margin:1.4em 0px;">为了更好监控集群的运行状态，及时发现集群故障，我们加了一系列的监控报警，如：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>两个 Jenkins Master 是否可用，当前的排队数量情况。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>集群里面所有 Jenkins Node 的在线状态，Node 被命中的情况。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Jenkins Job 的执行时间，是否有不合理的过长构建或者卡住。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>以及集群机器的 CPU，内存，磁盘使用情况。</li></ul><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">后续的计划</b></h2><p style="margin:1.4em 0px;">在未来我们还希望完善以下的方面：</p><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Jenkins Slave 能更根据集群的负载情况进行动态扩容。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>一个节点故障时能自动下掉并重新分配已经在上面执行的任务。一个 Master down 掉能被主动探测到并发生切换。</li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>在 Merge Request 的构建环节推动更多的质量保证标准实施，如更多的接口自动化测试，减少有问题的代码被合并到主分支。</li></ul><p style="margin:-0.8em 0px;"><br/></p><p style="margin:1.4em 0px;">主要开发者（排名不分先后）： <span><span><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/e31e190766535fdf201ddf5e4916fe94" style="color:rgb(23, 81, 153);text-decoration:none;" target="_blank">@Amyyyyy</a></div></div></span></span> <span><span><div style="position:relative;display:inline-block;"><div><a href="https://www.zhihu.com/people/5098d0c05bf6e7789f853f607f1755c9" style="color:rgb(23, 81, 153);text-decoration:none;" target="_blank">@Cosven</a></div></div></span></span> </p><h2 style="margin:0px;font:inherit;clear:left;margin-top:2.33333em;margin-bottom:1.16667em;font-size:1.2em;line-height:1.5;font-weight:600;"><b style="font-weight:600;">参考资料</b></h2><ul style="padding:0px;margin:1.4em 0px;display:table;"><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Jenkinsfile 相关文档 <u style="text-decoration:none;border-bottom:1px dashed grey;"><a href="https://link.zhihu.com/?target=https%3A//jenkins.io/doc/book/pipeline/jenkinsfile/" rel="nofollow noreferrer" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid grey;" target="_blank"><span style="font:0px/0 a;color:transparent;text-shadow:none;background-color:transparent;">https://</span><span>jenkins.io/doc/book/pip</span><span style="font:0px/0 a;color:transparent;text-shadow:none;background-color:transparent;">eline/jenkinsfile/</span><span><span style="">...</span></span></a></u></li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Jenkins  Logo： <a href="https://link.zhihu.com/?target=https%3A//jenkins.io/" rel="nofollow noreferrer" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid grey;" target="_blank"><span style="font:0px/0 a;color:transparent;text-shadow:none;background-color:transparent;">https://</span><span>jenkins.io/</span><span style="font:0px/0 a;color:transparent;text-shadow:none;background-color:transparent;"></span></a></li><li style="list-style-type:none;display:table-row;list-style:none;"><span style="list-style-type:none;list-style:none;display:table-cell;white-space:pre;">•  </span>Docker Logo:  <a href="https://link.zhihu.com/?target=https%3A//www.docker.com/legal/brand-guidelines" rel="nofollow noreferrer" style="color:inherit;text-decoration:none;cursor:pointer;border-bottom:1px solid grey;" target="_blank">Brand Guidelines</a></li></ul><p style="margin:1.4em 0px;"></p><p style="margin:1.4em 0px;"></p><p style="margin:1.4em 0px;"></p><p style="margin:1.4em 0px;"></p><p style="margin:1.4em 0px;"></p><p style="margin:1.4em 0px;margin-bottom:0px;"></p></div></div><div style="font-size:14px;color:rgb(133, 144, 166);padding:16px 0px;overflow:hidden;width:690px;margin:0px auto;">编辑于 2018-10-01</div><div style="overflow:hidden;width:690px;margin:0px auto;display:flex;"><div style="display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-flow:row wrap;-webkit-box-align:center;align-items:center;margin-bottom:-10px;padding:16px 0px;"><div style="position:relative;display:inline-block;height:33px;padding:0px 12px;font-size:13px;line-height:33px;color:rgb(0, 132, 255);vertical-align:top;border-radius:100px;background:rgba(0, 132, 255, 0.1);margin-right:5px;overflow:hidden;margin-bottom:10px;"><span><a href="https://www.zhihu.com/topic/19578413" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>系统架构</div></div></a></span></div><div style="position:relative;display:inline-block;height:33px;padding:0px 12px;font-size:13px;line-height:33px;color:rgb(0, 132, 255);vertical-align:middle;border-radius:100px;background:rgba(0, 132, 255, 0.1);margin-right:5px;overflow:hidden;margin-bottom:10px;"><span><a href="https://www.zhihu.com/topic/19950993" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>Docker</div></div></a></span></div><div style="position:relative;display:inline-block;height:33px;padding:0px 12px;font-size:13px;line-height:33px;color:rgb(0, 132, 255);vertical-align:middle;border-radius:100px;background:rgba(0, 132, 255, 0.1);overflow:hidden;margin-bottom:10px;"><span><a href="https://www.zhihu.com/topic/19615961" style="color:inherit;text-decoration:none;" target="_blank"><div style="position:relative;display:inline-block;"><div>容器</div></div></a></span></div></div></div><div style="overflow:hidden;width:690px;margin:0px auto;"><div style="position:fixed;z-index:2;-webkit-font-smoothing:subpixel-antialiased;box-sizing:border-box;animation:0.2s ease 0s 1 normal none running slideInUp;background:rgb(255, 255, 255);width:1904px;bottom:0px;left:598.5px;border-bottom:env(safe-area-inset-bottom) solid transparent;color:rgb(100, 100, 100);"><div style="display:flex;-webkit-box-align:center;align-items:center;padding:10px 20px;margin:0px -20px -10px;color:rgb(100, 100, 100);background:rgb(255, 255, 255);clear:both;position:relative;"><span style="flex-shrink:0;"></span><div style="position:relative;display:inline-block;flex-shrink:0;"><div></div></div><div style="flex-shrink:0;margin-left:24px;"><div style="position:relative;display:inline-block;"><div></div></div></div></div><div><div><div style="position:fixed;left:calc((100vw - 958px) / 2);height:0px;pointer-events:none;margin:auto;top:106px;opacity:1;"><div style="position:relative;display:inline-block;"><div></div></div></div></div></div></div><div style="visibility:hidden;position:static;top:auto;right:auto;bottom:0px;left:0px;display:block;float:none;margin:0px 0px 10px;height:54px;"></div></div></div></div></span></div></div></div></div></div><br/></div></span>
</div></body></html> 