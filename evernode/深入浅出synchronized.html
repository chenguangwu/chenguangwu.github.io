<html>
<head>
  <title>深入浅出synchronized</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7309"/>
<h1>深入浅出synchronized</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/8/8 11:03</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.jianshu.com/p/19f861ab749e"><i>https://www.jianshu.com/p/19f861ab749e</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;position: relative;"><div style="box-sizing:border-box;font-family:sans-serif;text-size-adjust:100%;font-size:10px;-webkit-tap-highlight-color:transparent;"><div style="box-sizing:border-box;font-size:17px;line-height:1.42857;background-color:rgb(255, 255, 255);min-width:768px;color:rgb(51, 51, 51);font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;">
        <h1 style="box-sizing:border-box;color:inherit;margin-top:20px;margin-bottom:10px;font-size:34px;margin:20px 0px 0px;font-family:-apple-system, &quot;SF UI Display&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-weight:700;line-height:1.3;word-break:break-word;">深入浅出synchronized</h1>

        
        <div style="box-sizing:border-box;margin:30px 0px 40px;">
          <a href="https://www.jianshu.com/u/90ab66c248e6" style="box-sizing:border-box;background-color:transparent;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;width:48px;height:48px;display:inline-block;vertical-align:middle;">
            <img src="深入浅出synchronized_files/96" type="image/png" data-filename="96" height="46" style="box-sizing:border-box;vertical-align:middle;border:1px solid rgb(221, 221, 221);width:100%;height:100%;border-radius:50%;" width="46"/>
</a>          <div style="box-sizing:border-box;vertical-align:middle;display:inline-block;margin-left:8px;">
            <span style="box-sizing:border-box;margin-right:3px;font-size:16px;vertical-align:middle;"><a href="https://www.jianshu.com/u/90ab66c248e6" style="box-sizing:border-box;background-color:transparent;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;">占小狼</a></span>
              <img src="深入浅出synchronized_files/595a1b60-08f6-4beb-998f-2bf55e230555" type="image/png" data-filename="595a1b60-08f6-4beb-998f-2bf55e230555" height="20" style="box-sizing:border-box;vertical-align:middle;border:0px;margin-right:5px;width:20px;height:20px;border-radius:0px;" title="" width="20"/>
            
            <a style="cursor:pointer;box-sizing:border-box;border:1px solid rgba(151, 151, 151, 0.6);text-decoration:none;white-space:nowrap;margin-bottom:0px;text-align:center;vertical-align:middle;touch-action:manipulation;color:rgb(140, 140, 140);display:inline-block;font-weight:400;user-select:none;border-radius:40px;line-height:normal;background:none;font-size:12px;padding:0px 7px 0px 5px;"><i style="box-sizing:border-box;font-size:inherit;font-style:normal;-webkit-font-smoothing:antialiased;font-family:iconfont;font-weight:400;"><span style="font-size:inherit;font-style:normal;font-family:iconfont;font-weight:400;"></span></i><span style="box-sizing:border-box;margin-left:2px;display:inline;">已关注</span></a>
            
            <div style="box-sizing:border-box;margin-top:5px;font-size:12px;color:rgb(150, 150, 150);">
              
                <span style="box-sizing:border-box;padding-right:5px;" title="">2016.07.06 20:39*</span>
              <span style="box-sizing:border-box;padding-right:5px;">字数 2630</span>
            <span style="box-sizing:border-box;padding-right:5px;">阅读 19542</span><span style="box-sizing:border-box;padding-right:5px;">评论 43</span><span style="box-sizing:border-box;padding-right:5px;">喜欢 142</span><span style="box-sizing:border-box;padding-right:5px;">赞赏 2</span></div>
          </div>
          
        </div>


        
        <div style="box-sizing:border-box;color:rgb(47, 47, 47);font-size:16px;font-weight:400;line-height:1.7;word-break:break-word;">
          <div style="box-sizing:border-box;">
            <blockquote style="box-sizing:border-box;margin:0px 0px 20px;padding:20px;font-size:16px;border-left:6px solid rgb(180, 180, 180);margin-bottom:25px;background-color:rgb(247, 247, 247);font-weight:400;line-height:30px;word-break:break-word;">
<p style="box-sizing:border-box;margin:0px 0px 25px;font-size:16px;font-weight:400;line-height:1.7;margin-bottom:0px;word-break:break-word;">简书 <a href="https://www.jianshu.com/users/90ab66c248e6/latest_articles" style="box-sizing:border-box;background-color:transparent;text-decoration:none;cursor:pointer;color:rgb(49, 148, 208);" target="_blank">占小狼</a><br style="box-sizing:border-box;"/>
转载请注明原创出处，谢谢！</p>
</blockquote>
<blockquote style="box-sizing:border-box;margin:0px 0px 20px;padding:20px;font-size:16px;border-left:6px solid rgb(180, 180, 180);margin-bottom:25px;background-color:rgb(247, 247, 247);font-weight:400;line-height:30px;word-break:break-word;">
<p style="box-sizing:border-box;margin:0px 0px 25px;font-size:16px;font-weight:400;line-height:1.7;margin-bottom:0px;word-break:break-word;">synchronized可以保证方法或代码块在运行时，同一时刻只有一个线程可以进入到临界区（互斥性），同时它还保证了共享变量的内存可见性。</p>
</blockquote>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">Java中的每个对象都可以作为锁。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">普通同步方法，锁是当前实例对象。</li>
<li style="box-sizing:border-box;line-height:30px;">静态同步方法，锁是当前类的class对象。</li>
<li style="box-sizing:border-box;line-height:30px;">同步代码块，锁是括号中的对象。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">先看一个场景<br style="box-sizing:border-box;"/>
<strong style="box-sizing:border-box;font-weight:700;">等待 / 通知机制</strong><br style="box-sizing:border-box;"/>
直接上代码：</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> java.util.concurrent.TimeUnit;

<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">/**
 * Created by j_zhan on 2016/7/6.
 */</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">WaitNotify</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">boolean</span> flag = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">true</span>;
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> Object lock = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Object();

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">main</span><span style="box-sizing:border-box;">(String[] args)</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">throws</span> InterruptedException </span>{
        Thread A = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Thread(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Wait(), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;wait thread&quot;</span>);
        A.start();
        TimeUnit.SECONDS.sleep(<span style="box-sizing:border-box;color:rgb(209, 154, 102);">2</span>);
        Thread B = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Thread(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Notify(), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;notify thread&quot;</span>);
        B.start();
    }

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Wait</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">implements</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Runnable</span> </span>{
        <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
        <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">run</span><span style="box-sizing:border-box;">()</span> </span>{
            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> (lock) {
                <span style="box-sizing:border-box;color:rgb(198, 120, 221);">while</span> (flag) {
                    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">try</span> {
                        System.out.println(Thread.currentThread() + <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot; flag is true&quot;</span>);
                        lock.wait();
                    } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">catch</span> (InterruptedException e) {

                    }
                }
                System.out.println(Thread.currentThread() + <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot; flag is false&quot;</span>);
            }
        }
    }

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Notify</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">implements</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Runnable</span> </span>{
        <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
        <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">run</span><span style="box-sizing:border-box;">()</span> </span>{
            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> (lock) {
                flag = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">false</span>;
                lock.notifyAll();
                <span style="box-sizing:border-box;color:rgb(198, 120, 221);">try</span> {
                    TimeUnit.SECONDS.sleep(<span style="box-sizing:border-box;color:rgb(209, 154, 102);">7</span>);
                } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">其相关方法定义在java.lang.Object上，线程A在获取锁后调用了对象lock的wait方法进入了等待状态，线程B调用对象lock的notifyAll()方法，线程A收到通知后从wait方法处返回继续执行，线程B对共享变量flag的修改对线程A来说是可见的。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">整个运行过程需要注意一下几点：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">使用wait()、notify()和notifyAll()时需要先对调用对象加锁，调用wait()方法后会释放锁。</li>
<li style="box-sizing:border-box;line-height:30px;">调用wait()方法之后，线程状态由RUNNING变为WAITING，并将当前线程放置到对象的等待队列中。</li>
<li style="box-sizing:border-box;line-height:30px;">notify()或notifyAll()方法调用后，等待线程不会立刻从wait()中返回，需要等该线程释放锁之后，才有机会获取锁之后从wait()返回。</li>
<li style="box-sizing:border-box;line-height:30px;">notify()方法将等待队列中的一个等待线程从等待队列中移动到同步队列中；notifyAll()方法则是把等待队列中的所有线程都移动到同步队列中；被移动的线程状态从WAITING变为BLOCKED。</li>
<li style="box-sizing:border-box;line-height:30px;">从wait()方法返回的前提是，改线程获得了调用对象的锁。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">那么，它是如何实现线程之间的互斥性和可见性？</p>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">互斥性</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">先看一段代码：</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">SynchronizedTest</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> Object object = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Object();
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">main</span><span style="box-sizing:border-box;">(String[] args)</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">throws</span> Exception</span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span>(object) {
            
        }
    }
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">m</span><span style="box-sizing:border-box;">()</span> </span>{}
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">上述代码中，使用了同步代码块和同步方法，通过使用javap工具查看生成的class文件信息来分析synchronized关键字的实现细节。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;">  <span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> void main(java.lang.String[]) throws java.lang.<span style="box-sizing:border-box;color:rgb(198, 120, 221);">Exception</span>;
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">2</span>, locals=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">3</span>, args_size=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>: getstatic     <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">#2                  // Field object:Ljava/lang/Object</span>

         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">3</span>: dup
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">4</span>: astore_1
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">5</span>: monitorenter            <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">//监视器进入，获取锁</span>
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">6</span>: aload_1
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">7</span>: monitorexit              <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">//监视器退出，释放锁</span>
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">8</span>: <span style="box-sizing:border-box;color:rgb(198, 120, 221);">goto</span>          <span style="box-sizing:border-box;color:rgb(209, 154, 102);">16</span>
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">11</span>: astore_2
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">12</span>: aload_1
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">13</span>: monitorexit
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">14</span>: aload_2
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">15</span>: athrow
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">16</span>: <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span>
     
   <span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> synchronized void m();
   descriptor: ()V
   flags: ACC_PUBLIC, ACC_STATIC, ACC_SYNCHRONIZED
   Code:
     stack=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>, locals=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>, args_size=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>: <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span>
     LineNumberTable:
       line <span style="box-sizing:border-box;color:rgb(209, 154, 102);">9</span>: <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">从生成的class信息中，可以清楚的看到</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">同步代码块使用了 <strong style="box-sizing:border-box;font-weight:700;">monitorenter</strong> 和 <strong style="box-sizing:border-box;font-weight:700;">monitorexit</strong> 指令实现。</li>
<li style="box-sizing:border-box;line-height:30px;">同步方法中依靠方法修饰符上的 <strong style="box-sizing:border-box;font-weight:700;">ACC_SYNCHRONIZED</strong> 实现。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">无论哪种实现，本质上都是对指定对象相关联的monitor的获取，这个过程是互斥性的，也就是说同一时刻只有一个线程能够成功，其它失败的线程会被阻塞，并放入到同步队列中，进入BLOCKED状态。</p>
<hr style="border-left-color:initial;box-sizing:content-box;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;height:0px;border-image:initial;border-top-style:solid;margin-bottom:20px;margin-top:20px;border-top-color:rgb(238, 238, 238);border-top:1px solid rgb(221, 221, 221);margin:0px 0px 20px;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">我们继续深入了解一下锁的内部机制<br style="box-sizing:border-box;"/>
一般锁有4种状态：无锁状态，偏向锁状态，轻量级锁状态，重量级锁状态。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">在进一步深入之前，我们先认识下两个概念：对象头和monitor。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"><strong style="box-sizing:border-box;font-weight:700;">什么是对象头？</strong><br style="box-sizing:border-box;"/>
在hotspot虚拟机中，对象在内存的分布分为3个部分：对象头，实例数据，和对齐填充。<br style="box-sizing:border-box;"/>
mark word被分成两部分，lock word和标志位。<br style="box-sizing:border-box;"/>
Klass ptr指向Class字节码在虚拟机内部的对象表示的地址。<br style="box-sizing:border-box;"/>
Fields表示连续的对象实例字段。<br style="box-sizing:border-box;"/>
</p><div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear;margin:0px auto;max-width:484px;max-height:334px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:69.01%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="深入浅出synchronized_files/484" type="image/png" data-filename="484" height="334" style="transition:all 0.15s linear;border:0px;vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;z-index:100;filter:blur(0px);opacity:1;display:block;cursor:zoom-in;" width="484"/></div>
</div>
<div style="padding:10px;box-sizing:border-box;max-width:80%;min-height:22px;display:inline-block;min-width:20%;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">对象.png</div>
</div><p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"></p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">mark word 被设计为非固定的数据结构，以便在及小的空间内存储更多的信息。比如：在32位的hotspot虚拟机中：如果对象处于未被锁定的情况下。mark  word 的32bit空间中有25bit存储对象的哈希码、4bit存储对象的分代年龄、2bit存储锁的标记位、1bit固定为0。而在其他的状态下（轻量级锁、重量级锁、GC标记、可偏向）下对象的存储结构为</p>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear;margin:0px auto;max-width:700px;max-height:188px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:21.39%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="深入浅出synchronized_files/700" type="image/png" data-filename="700" height="150" style="transition:all 0.15s linear;border:0px;vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;z-index:100;filter:blur(0px);opacity:1;display:block;cursor:zoom-in;" width="700"/></div>
</div>
<div style="padding:10px;box-sizing:border-box;max-width:80%;min-height:22px;display:inline-block;min-width:20%;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">Paste_Image.png</div>
</div>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"><strong style="box-sizing:border-box;font-weight:700;">什么是monitor？</strong><br style="box-sizing:border-box;"/>
monitor是线程私有的数据结构，每一个线程都有一个可用monitor列表，同时还有一个全局的可用列表，先来看monitor的内部<br style="box-sizing:border-box;"/>
</p><div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear;margin:0px auto;max-width:347px;max-height:479px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:138.04000000000002%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="深入浅出synchronized_files/347" type="image/png" data-filename="347" height="479" style="transition:all 0.15s linear;border:0px;vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;z-index:100;filter:blur(0px);opacity:1;display:block;cursor:zoom-in;" width="347"/></div>
</div>
<div style="padding:10px;box-sizing:border-box;max-width:80%;min-height:22px;display:inline-block;min-width:20%;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">Paste_Image.png</div>
</div><p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"></p>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding-left:0px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">Owner：初始时为NULL表示当前没有任何线程拥有该monitor，当线程成功拥有该锁后保存线程唯一标识，当锁被释放时又设置为NULL；</li>
<li style="box-sizing:border-box;line-height:30px;">EntryQ：关联一个系统互斥锁（semaphore），阻塞所有试图锁住monitor失败的线程。</li>
<li style="box-sizing:border-box;line-height:30px;">RcThis：表示blocked或waiting在该monitor上的所有线程的个数。</li>
<li style="box-sizing:border-box;line-height:30px;">Nest：用来实现重入锁的计数。</li>
<li style="box-sizing:border-box;line-height:30px;">HashCode：保存从对象头拷贝过来的HashCode值（可能还包含GC age）。</li>
<li style="box-sizing:border-box;line-height:30px;">Candidate：用来避免不必要的阻塞或等待线程唤醒，因为每一次只有一个线程能够成功拥有锁，如果每次前一个释放锁的线程唤醒所有正在阻塞或等待的线程，会引起不必要的上下文切换（从阻塞到就绪然后因为竞争锁失败又被阻塞）从而导致性能严重下降。Candidate只有两种可能的值：0表示没有需要唤醒的线程，1表示要唤醒一个继任线程来竞争锁。</li>
</ul>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">那么monitor的作用是什么呢？在 java 虚拟机中，线程一旦进入到被synchronized修饰的方法或代码块时，指定的锁对象通过某些操作将对象头中的LockWord指向monitor 的起始地址与之关联，同时monitor 中的Owner存放拥有该锁的线程的唯一标识，确保一次只能有一个线程执行该部分的代码，线程在获取锁之前不允许执行该部分的代码。</p>
<hr style="border-left-color:initial;box-sizing:content-box;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-bottom-color:initial;height:0px;border-image:initial;border-top-style:solid;margin-bottom:20px;margin-top:20px;border-top-color:rgb(238, 238, 238);border-top:1px solid rgb(221, 221, 221);margin:0px 0px 20px;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">接下去，我们可以深入了解下在锁各个状态下，底层是如何处理多线程之间对锁的竞争。</p>
<h6 style="box-sizing:border-box;font-family:inherit;margin-top:10px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:16px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">偏向锁</h6>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">下述代码中，当线程访问同步方法method1时，会在对象头（SynchronizedTest.class对象的对象头）和栈帧的锁记录中存储锁偏向的线程ID，下次该线程在进入method2，只需要判断对象头存储的线程ID是否为当前线程，而不需要进行CAS操作进行加锁和解锁（因为CAS原子指令虽然相对于重量级锁来说开销比较小但还是存在非常可观的本地延迟）。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">/**
 * Created by j_zhan on 2016/7/6.
 */</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">SynchronizedTest</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> Object lock = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Object();
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">main</span><span style="box-sizing:border-box;">(String[] args)</span> </span>{
        method1();
        method2();
    }
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">method1</span><span style="box-sizing:border-box;">()</span> </span>{}
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">method2</span><span style="box-sizing:border-box;">()</span> </span>{}
}
</code></pre>
<h6 style="box-sizing:border-box;font-family:inherit;margin-top:10px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:16px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">轻量级锁</h6>
<blockquote style="box-sizing:border-box;margin:0px 0px 20px;padding:20px;font-size:16px;border-left:6px solid rgb(180, 180, 180);margin-bottom:25px;background-color:rgb(247, 247, 247);font-weight:400;line-height:30px;word-break:break-word;">
<p style="box-sizing:border-box;margin:0px 0px 25px;font-size:16px;font-weight:400;line-height:1.7;margin-bottom:0px;word-break:break-word;">利用了CPU原语Compare-And-Swap(CAS，汇编指令CMPXCHG)。</p>
</blockquote>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">线程可以通过两种方式锁住一个对象：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">通过膨胀一个处于无锁状态（状态位001）的对象获得该对象的锁；</li>
<li style="box-sizing:border-box;line-height:30px;">对象处于膨胀状态（状态位00），但LockWord指向的monitor的Owner字段为NULL，则可以直接通过CAS原子指令尝试将Owner设置为自己的标识来获得锁。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">获取锁（monitorenter）的大概过程：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">对象处于无锁状态时（LockWord的值为hashCode等，状态位为001），线程首先从monitor列表中取得一个空闲的monitor，初始化Nest和Owner值为1和线程标识，一旦monitor准备好，<strong style="box-sizing:border-box;font-weight:700;">通过CAS替换monitor起始地址到LockWord</strong>进行膨胀。如果存在其它线程竞争锁的情况而导致CAS失败，则回到monitorenter重新开始获取锁的过程即可。</li>
<li style="box-sizing:border-box;line-height:30px;">对象已经膨胀，monitor中的Owner指向当前线程，这是重入锁的情况（reentrant），将Nest加1，不需要CAS操作，效率高。</li>
</ol>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding-left:0px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">对象已经膨胀，monitor中的Owner为NULL，此时多个线程通过CAS指令试图将Owner设置为自己的标识获得锁，竞争失败的线程则进入第4种情况。</li>
<li style="box-sizing:border-box;line-height:30px;">对象已经膨胀，同时Owner指向别的线程，在调用操作系统的重量级的互斥锁之前自旋一定的次数，当达到一定的次数如果仍然没有获得锁，则开始准备进入阻塞状态，将rfThis值原子加1，由于在加1的过程中可能被其它线程破坏对象和monitor之间的联系，所以在加1后需要再进行一次比较确保lock word的值没有被改变，当发现被改变后则要重新进行monitorenter过程。同时再一次观察Owner是否为NULL，如果是则调用CAS参与竞争锁，锁竞争失败则进入到阻塞状态。</li>
</ul>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">释放锁（monitorexit）的大概过程：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">检查该对象是否处于膨胀状态并且该线程是这个锁的拥有者，如果发现不对则抛出异常。</li>
</ol>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding-left:0px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">检查Nest字段是否大于1，如果大于1则简单的将Nest减1并继续拥有锁，如果等于1，则进入到步骤3。</li>
<li style="box-sizing:border-box;line-height:30px;">检查rfThis是否大于0，设置Owner为NULL然后唤醒一个正在阻塞或等待的线程再一次试图获取锁，如果等于0则进入到步骤4。</li>
<li style="box-sizing:border-box;line-height:30px;">缩小（deflate）一个对象，通过将对象的LockWord置换回原来的HashCode等值来解除和monitor之间的关联来释放锁，同时将monitor放回到线程私有的可用monitor列表。</li>
</ul>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">/**
 * Created by j_zhan on 2016/7/6.
 */</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">SynchronizedTest</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">implements</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Runnable</span> </span>{

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> Object lock = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Object();
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">main</span><span style="box-sizing:border-box;">(String[] args)</span> </span>{
        Thread A = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Thread(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> SynchronizedTest(), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;A&quot;</span>);
        A.start();
    
        Thread B = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Thread(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> SynchronizedTest(), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;B&quot;</span>);
        B.start();
    }

    <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">run</span><span style="box-sizing:border-box;">()</span> </span>{
        method1();
        method2();
    }
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">method1</span><span style="box-sizing:border-box;">()</span> </span>{}
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">method2</span><span style="box-sizing:border-box;">()</span> </span>{}
}
</code></pre>
<h6 style="box-sizing:border-box;font-family:inherit;margin-top:10px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:16px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">重量级锁</h6>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">当锁处于这个状态下，其他线程试图获取锁都会被阻塞住，当持有锁的线程释放锁之后会唤醒这些线程。</p>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">内存可见性</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">对java内存模型不熟悉的同学，可以参考这边文章<a href="https://www.jianshu.com/p/d3fda02d4cae" style="box-sizing:border-box;background-color:transparent;text-decoration:none;cursor:pointer;color:rgb(49, 148, 208);" target="_blank">java内存模型</a>。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">线程释放锁时，JMM会把该线程对应的本地内存中的共享变量刷新到主内存中。</li>
<li style="box-sizing:border-box;line-height:30px;">线程获取锁时，JMM会把该线程对应的本地内存置为无效，从而使得被监视器保护的临界区代码必须从主内存中读取共享变量。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">END。<br style="box-sizing:border-box;"/>
我是占小狼。<br style="box-sizing:border-box;"/>
在魔都艰苦奋斗，白天是上班族，晚上是知识服务工作者。<br style="box-sizing:border-box;"/>
读完我的文章有收获，记得关注和点赞哦，如果非要打赏，我也是不会拒绝的啦！</p>

          </div>
        </div>
    </div></div></div></div></div></div>
</div>
</span>
</div></body></html> 