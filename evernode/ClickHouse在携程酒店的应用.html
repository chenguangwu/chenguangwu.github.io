<html>
<head>
  <title>ClickHouse在携程酒店的应用</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="12558"/>
<h1>ClickHouse在携程酒店的应用</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/6/26 21:02</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://mp.weixin.qq.com/s/cqbzH9x5aESPBVG8NiaqjQ"><i>https://mp.weixin.qq.com/s/cqbzH9x5aESPBVG8NiaqjQ</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="text-size-adjust:100%;line-height:1.6;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);background-color:rgb(242, 242, 242);letter-spacing:0.034em;line-height:1.6;font-size:16px;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div><div style="overflow-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div>

                
                <h2 style="font-weight:400;font-size:22px;margin:0px;padding:0px;line-height:1.4;margin-bottom:14px;">
                    
                    
                    
            干货 | 每天十亿级数据更新，秒出查询结果，ClickHouse在携程酒店的应用
                      </h2>
                <div style="margin:0px;padding:0px;margin-bottom:22px;line-height:20px;font-size:0px;overflow-wrap:break-word;word-break:break-all;position:relative;z-index:1;">
                                                            <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);margin-right:0px;color:rgba(0, 0, 0, 0.3);">原创：</span>
                                                            <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);">
                                                蔡岳毅
                                            </span>
                                        
                                        <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);position:relative;">
                      <a href="#" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);">
                        携程技术中心                      </a>
                      
                    </span>


                    <em style="margin:0px 10px 10px 0px;padding:0px;font-style:normal;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);">今天</em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(51, 51, 51);font-size:17px;overflow-wrap:break-word;text-align:justify;position:relative;z-index:0;">
                    

                    

                    
                    
                    <div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;padding-right:1em;padding-left:1em;display:inline-block;text-align:center;"><span style="margin:0px;padding:0.3em 0.5em;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;border-radius:0.5em;font-size:14px;text-shadow:rgb(204, 204, 204) 4px 3px;color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">作者简介</strong></p></span></div><div style="margin:0px;padding:20px 10px 10px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:-1em;border-width:1px;border-style:solid;border-color:rgb(192, 200, 209);text-align:center;background-color:rgb(239, 239, 239);"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;text-align:left;font-size:12px;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:14px;line-height:1.6;">蔡岳毅，携程酒店大数据高级研发经理，负责酒店数据智能平台研发，大数据技术创新工作。喜欢探索研究大数据的开源技术框架。</span></p></div></div></div></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;text-align:left;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;border-radius:3px 3px 0px 0px;margin-right:3px;color:rgb(255, 255, 255);font-size:17px;padding-left:6px;padding-right:6px;background-color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">一、背景</span></strong></p></div><img src="ClickHouse在携程酒店的应用_files/640.webp" type="image/webp" data-filename="640.webp" height="26" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;display:inline-block;vertical-align:bottom;width:0.8em !important;visibility:visible !important;" width="13"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;font-size:0px;margin-top:-2px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;width:100%;margin-right:-6px;border-bottom:2px solid rgb(32, 119, 218);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;margin-top:-2px;width:6px;height:6px;border-radius:50%;background-color:rgb(32, 119, 218);"></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">1）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">携程酒店每天有上千表，累计十多亿数据更新，如何保证数据更新过程中生产应用高可用；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">2）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">每天有将近百万次数据查询请求，用户可以从粗粒度国家省份城市汇总不断下钻到酒店，房型粒度的数据，我们往往无法对海量的明细数据做进一步层次的预聚合，大量的关键业务数据都是好几亿数据关联权限，关联基础信息，根据用户场景获取不同维度的汇总数据；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">为了让用户无论在app端还是pc端查询数据提供秒出的效果，我们需要不断的探索，研究找到最合适的技术框架。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">对此，我们尝试过关系型数据库，但千万级表关联数据库基本上不太可能做到秒出，考虑过Sharding，但数据量大，各种成本都很高。热数据存储到ElasticSearch，但无法跨索引关联，导致不得不做宽表，因为权限，酒店信息会变，所以每次要刷全量数据，不适用于大表更新，维护成本也很高。Redis键值对存储无法做到实时汇总，也测试过Presto，GreenPlum，kylin，真正让我们停下来深入研究，不断的扩展使用场景的是ClickHouse。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;text-align:left;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;border-radius:3px 3px 0px 0px;margin-right:3px;color:rgb(255, 255, 255);font-size:17px;padding-left:6px;padding-right:6px;background-color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">二、ClickHouse介绍</span></strong></p></div><img src="ClickHouse在携程酒店的应用_files/640 [1].webp" type="image/webp" data-filename="640.webp" height="26" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;display:inline-block;vertical-align:bottom;width:0.8em !important;visibility:visible !important;" width="13"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;font-size:0px;margin-top:-2px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;width:100%;margin-right:-6px;border-bottom:2px solid rgb(32, 119, 218);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;margin-top:-2px;width:6px;height:6px;border-radius:50%;background-color:rgb(32, 119, 218);"></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">ClickHouse</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">是一款用于大数据实时分析的列式数据库管理系统，而非数据库。通过向量化执行以及对cpu底层指令集（SIMD）的使用，它可以对海量数据进行并行处理，从而加快数据的处理速度。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">主要优点有：</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">1）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">为了高效的使用CPU，数据不仅仅按列存储，同时还按向量进行处理；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">2）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">数据压缩空间大，减少io；处理单查询高吞吐量每台服务器每秒最多数十亿行；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">索引非B树结构，不需要满足最左原则；只要过滤条件在索引列中包含即可；即使在使用的数据不在索引中，由于各种并行处理机制ClickHouse全表扫描的速度也很快；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">4）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">写入速度非常快，50-200M/s，对于大量的数据更新非常适用；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">ClickHouse</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">并非万能的，正因为ClickHouse处理速度快，所以也是需要为“快”付出代价。选择ClickHouse需要有下面注意以下几点：</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">1）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">不支持事务，不支持真正的删除/更新；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">2）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">不支持高并发，官方建议qps为100，可以通过修改配置文件增加连接数，但是在服务器足够好的情况下；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">sql满足日常使用80%以上的语法，join写法比较特殊；最新版已支持类似sql的join，但性能不好；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">4）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">尽量做1000条以上批量的写入，避免逐行insert或小批量的insert，update，delete操作，因为ClickHouse底层会不断的做异步的数据合并，会影响查询性能，这个在做实时数据写入的时候要尽量避开；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">5）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">Clickhouse快是因为采用了并行处理机制，即使一个查询，也会用服务器一半的cpu去执行，所以ClickHouse不能支持高并发的使用场景，默认单查询使用cpu核数为服务器核数的一半，安装时会自动识别服务器核数，可以通过配置文件修改该参数；</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;text-align:left;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;border-radius:3px 3px 0px 0px;margin-right:3px;color:rgb(255, 255, 255);font-size:17px;padding-left:6px;padding-right:6px;background-color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">三、ClickHouse在酒店数据智能平台的实践</span></strong></p></div><img src="ClickHouse在携程酒店的应用_files/640 [2].webp" type="image/webp" data-filename="640.webp" height="26" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;display:inline-block;vertical-align:bottom;width:0.8em !important;visibility:visible !important;" width="13"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;font-size:0px;margin-top:-2px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;width:100%;margin-right:-6px;border-bottom:2px solid rgb(32, 119, 218);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;margin-top:-2px;width:6px;height:6px;border-radius:50%;background-color:rgb(32, 119, 218);"></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;transform:rotate(0deg);-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;line-height:1;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;opacity:0.6;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;line-height:1.2;padding-left:3px;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:17px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">3.1 </span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">数据更新</span></strong></span></p></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">我们的主要数据源是Hive到ClickHouse，现在主要采用如下两种方式：</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">1</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">）Hive到MySql，再导入到ClickHouse</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">初期在DataX不支持hive到ClickHouse的数据导入，我们是通过DataX将数据先导入mysql，再通过ClickHouse原生api将数据从mysql导入到ClickHouse。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">为此我们设计了一套完整的数据导入流程，保证数据从hive到mysql再到ClickHouse能自动化，稳定的运行，并保证数据在同步过程中线上应用的高可用。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [3].webp" type="image/webp" data-filename="640.webp" height="272" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">2</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">）Hive到ClickHouse</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">DataX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">现在支持hive到ClickHouse，我们部分数据是通过DataX直接导入ClickHouse。但DataX暂时只支持导入，因为要保证线上的高可用，所以仅仅导入是不够的，还需要继续依赖我们上面的一套流程来做ReName，增量数据更新等操作。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">针对数据高可用，我们对数据更新机制做了如下设计：</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3.1.1</span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">全量数据导入流程</span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [4].webp" type="image/webp" data-filename="640.webp" height="635" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:424px !important;visibility:visible !important;" width="424"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">全量数据的导入过程比较简单，仅需要将数据先导入到临时表中，导入完成之后，再通过对正式表和临时表进行ReName操作，将对数据的读取从老数据切换到新数据上来。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3.1.2</span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">增量数据的导入过程</span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [5].webp" type="image/webp" data-filename="640.webp" height="662" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:499px !important;visibility:visible !important;" width="499"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">增量数据的导入过程，我们使用过两个版本。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">由于ClickHouse的delete操作过于沉重，所以最早是通过删除指定分区，再把增量数据导入正式表的方式来实现的。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">这种方式存在如下问题：一是在增量数据导入的过程中，数据的准确性是不可保证的，如果增量数据越多，数据不可用的时间就越长；二是ClickHouse删除分区的动作，是在接收到删除指令之后内异步执行，执行完成时间是未知的。如果增量数据导入后，删除指令也还在异步执行中，会导致增量数据也会被删除。最新版的更新日志说已修复这个问题。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">针对以上情况，我们修改了增量数据的同步方案。在增量数据从Hive同步到ClickHouse的临时表之后，将正式表中数据反写到临时表中，然后通过ReName方法切换正式表和临时表。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">通过以上流程，基本可以保证用户对数据的导入过程是无感知的。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;transform:rotate(0deg);-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;line-height:1;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;opacity:0.6;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;line-height:1.2;padding-left:3px;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:17px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">3.2 </span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">数据导入过程的监控与预警</span></strong></span></p></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">由于数据量大，数据同步的语句经常性超时。为保证数据同步的每一个过程都是可监控的，我们没有使用ClickHouse提供的JDBC来执行数据同步语句，所有的数据同步语句都是通过调用ClickHouse的RestfulAPI来实现的。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">调用RestfulAPI的时候，可以指定本次查询的QueryID。在数据同步语句超时的情况下，通过轮询来获得某QueryID的执行进度。这样保证了整个查询过程的有序运行。在轮询的过程中，会对异常情况进行记录，如果异常情况出现的频次超过阈值，JOB会通过短信给相关人员发出预警短信。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;transform:rotate(0deg);-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;line-height:1;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;opacity:0.6;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:0px;display:inline-block;border-left:0.6em solid rgb(32, 119, 218);border-top:0.5em solid transparent !important;border-bottom:0.5em solid transparent !important;"> </span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;line-height:1.2;padding-left:3px;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:17px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">3.3 </span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">服务器分布与运维</span></strong></span></p></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">现在主要根据场景分国内，海外/供应商，实时数据，风控数据4个集群。每个集群对应的两到三台服务器，相互之间做主备，程序内部将查询请求分散到不同的服务器上做负载均衡。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">假如某一台服务器出现故障，通过配置界面修改某个集群的服务器节点，该集群的请求就不会落到有故障的服务器上。如果在某个时间段某个特定的数据查询量比较大，组建虚拟集群，将所有的请求分散到其他资源富于的物理集群上。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">下半年计划把每个集群的两台机器分散到不同的机房，可以继续起到现有的主备，负载均衡的作用还能起到dr的作用。同时为了保障线上应用的高可用，我们会实现自动健康检测机制，针对突发异常的服务器自动拉出我们的虚拟集群。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [6].webp" type="image/webp" data-filename="640.webp" height="146" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:579px !important;visibility:visible !important;" width="579"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">我们会监控每台服务器每天的查询量，每个语句的执行时间，服务器CPU，内存相关指标，以便于及时调整服务器上查询量比较高的请求到其他服务器。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [7].webp" type="image/webp" data-filename="640.webp" height="382" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [8].webp" type="image/webp" data-filename="640.webp" height="367" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"></span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;text-align:left;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;border-radius:3px 3px 0px 0px;margin-right:3px;color:rgb(255, 255, 255);font-size:17px;padding-left:6px;padding-right:6px;background-color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">四、ClickHouse使用探索</span></strong></p></div><img src="ClickHouse在携程酒店的应用_files/640 [9].webp" type="image/webp" data-filename="640.webp" height="26" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;display:inline-block;vertical-align:bottom;width:0.8em !important;visibility:visible !important;" width="13"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;font-size:0px;margin-top:-2px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;width:100%;margin-right:-6px;border-bottom:2px solid rgb(32, 119, 218);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;margin-top:-2px;width:6px;height:6px;border-radius:50%;background-color:rgb(32, 119, 218);"></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">我们在使用ClickHouse的过程中遇到过各种各样的问题，总结出来供大家参考。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">1）关闭Linux虚拟内存。在一次ClickHouse服务器内存耗尽的情况下，我们Kill掉占用内存最多的Query之后发现，这台ClickHouse服务器并没有如预期的那样恢复正常，所有的查询依然运行的十分缓慢。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">通过查看服务器的各项指标，发现虚拟内存占用量异常。因为存在大量的物理内存和虚拟内存的数据交换，导致查询速度十分缓慢。关闭虚拟内存，并重启服务后，应用恢复正常。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">2）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">为每一个账户添加join_use_nulls配置。ClickHouse的SQL语法是非标准的，默认情况下，以Left Join为例，如果左表中的一条记录在右表中不存在，右表的相应字段会返回该字段相应数据类型的默认值，而不是标准SQL中的Null值。对于习惯了标准SQL的我们来说，这种返回值经常会造成困扰。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">3）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">JOIN操作时一定要把数据量小的表放在右边，ClickHouse中无论是Left Join 、Right Join还是Inner Join永远都是拿着右表中的每一条记录到左表中查找该记录是否存在，所以右表必须是小表。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">4）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">通过ClickHouse官方的JDBC向ClickHouse中批量写入数据时，必须控制每个批次的数据中涉及到的分区的数量，在写入之前最好通过Order By语句对需要导入的数据进行排序。无序的数据或者数据中涉及的分区太多，会导致ClickHouse无法及时的对新导入的数据进行合并，从而影响查询性能。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">5）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">尽量减少JOIN时的左右表的数据量，必要时可以提前对某张表进行聚合操作，减少数据条数。有些时候，先GROUP BY再JOIN比先JOIN再GROUP BY查询时间更短。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">6）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">ClickHouse版本迭代很快，建议用去年的稳定版，不能太激进，新版本我们在使用过程中遇到过一些bug，内存泄漏，语法不兼容但也不报错，配置文件并发数修改后无法生效等问题。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">7）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">避免使用分布式表，ClickHouse的分布式表性能上性价比不如物理表高，建表分区字段值不宜过多，太多的分区数据导入过程磁盘可能会被打满。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">8）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">服务器CPU一般在50%左右会出现查询波动，CPU达到70%会出现大范围的查询超时，所以ClickHouse最关键的指标CPU要非常关注。我们内部对所有ClickHouse查询都有监控，当出现查询波动的时候会有邮件预警。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">9）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">查询测试Case有：6000W数据关联1000W数据再关联2000W数据sum一个月间夜量返回结果：190ms；2.4亿数据关联2000W的数据group by一个月的数据大概390ms。但ClickHouse并非无所不能，查询语句需要不断的调优，可能与查询条件有关，不同的查询条件表是左join还是右join也是很有讲究的。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:16px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-top:10px;margin-bottom:10px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;text-align:left;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;border-radius:3px 3px 0px 0px;margin-right:3px;color:rgb(255, 255, 255);font-size:17px;padding-left:6px;padding-right:6px;background-color:rgb(32, 119, 218);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑, sans-serif;">五、总结</span></strong></p></div><img src="ClickHouse在携程酒店的应用_files/640 [10].webp" type="image/webp" data-filename="640.webp" height="26" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;display:inline-block;vertical-align:bottom;width:0.8em !important;visibility:visible !important;" width="13"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;width:100%;font-size:0px;margin-top:-2px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;width:100%;margin-right:-6px;border-bottom:2px solid rgb(32, 119, 218);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;display:inline-block;vertical-align:top;margin-top:-2px;width:6px;height:6px;border-radius:50%;background-color:rgb(32, 119, 218);"></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">酒店数据智能平台从去年7月份试点，到现在80%以上的业务都已接入ClickHouse。<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">满足每天十多亿的数据更新和近百万次的数据查询，支撑app性能98.3%在1秒内返回结果，pc端98.5%在3秒内返回结果。</strong></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">从使用的角度，查询性能不是数据库能相比的，从成本上也是远低于关系型数据库成本的，单机支撑40亿以上的数据查询毫无压力。与ElasticSearch，Redis相比ClickHouse可以满足我们大部分使用场景。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;">我们会继续更深入的研究ClickHouse，跟进最新的版本，同时也会继续保持对外界更好的开源框架的研究，尝试，寻找到更合适我们的技术框架。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:27.2px;">【推荐阅读】</strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:27.2px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></strong></p><ul style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;padding-left:2.2em;list-style-type:square;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&amp;mid=2697268580&amp;idx=1&amp;sn=e383a33e7df3ad31ce45976f819fbcc5&amp;chksm=8376f250b4017b46c0a480ca3ebe069e20c33aecceedfa8ff386d9951614633daa09f93eed4d&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">强化学习在携程酒店推荐排序中的应用探索</a></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&amp;mid=2697268580&amp;idx=2&amp;sn=a7e306d4096c3d760519d773c2d6b0ee&amp;chksm=8376f250b4017b4655d18899a280b0f786711d12fe617a1111baebc309d649e381d89ed68101&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">携程机票Sketch插件开发实践</a></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&amp;mid=2697268538&amp;idx=1&amp;sn=1d5981f1604916e2116168ef898141b9&amp;chksm=8376f20eb4017b18d3e8f71e06bfd3a580e0a4f268402b9146f3faf02d442cca51663255dc7d&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">携程机票 App Kotlin Multiplatform 初探</a><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&amp;mid=2697268526&amp;idx=1&amp;sn=98c0b32a141a7d4becf3b45518ebd260&amp;chksm=8376f21ab4017b0cc91e9f3f9a66b3fa1dc731d290cfc4d92044e04519f09c5be04cace2ed8d&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">快速融入云原生，携程开源 Dubbo for Go 版本</a></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDI3MjA5MQ==&amp;mid=2697268526&amp;idx=2&amp;sn=b97cf355ff2016faf8e0b9fea32eefe5&amp;chksm=8376f21ab4017b0cdbdc1a1c9addba59a72cd6d4db0374e7448cf8ad3463fe546d5332b02655&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">当你在携程搜索时，背后的推荐系统是如何工作的</a></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;text-align:center;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;white-space:normal;text-align:center;"><img src="ClickHouse在携程酒店的应用_files/640 [11].webp" type="image/webp" data-filename="640.webp" height="435" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:600px !important;visibility:visible !important;" width="600"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-family:微软雅黑,sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p>
                </div>
                

                
  


                
                

                
                                

                
                                
                
                            </div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 