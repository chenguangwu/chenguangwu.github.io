<html>
<head>
  <title>java实现简单的单点登录 - J2EE社区 - BlogJava</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6773"/>
<h1>java实现简单的单点登录 - J2EE社区 - BlogJava</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/2/16 14:29</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.blogjava.net/xcp/archive/2010/04/13/318125.html"><i>http://www.blogjava.net/xcp/archive/2010/04/13/318125.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-size:13px;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;word-wrap:break-word;background-color:rgb(217, 214, 203);"><div><table style="background-color:rgb(238, 238, 238);"><tbody><tr><td style="font-size:12px;vertical-align:top;background-color:white;"><div><div>
		<div style="border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:rgb(204, 204, 204);padding:4px;color:rgb(68, 68, 68);font-size:9px;background-image:url(&quot;images/PostHeaderBg.gif&quot;);background-color:rgb(238, 238, 238);background-position:50% 100%;background-repeat:repeat-x;">
			<h2 style="font-size:13px;margin:0px;">
				<a href="http://www.blogjava.net/xcp/archive/2010/04/13/318125.html" style="text-decoration:none;color:rgb(34, 51, 85);">java实现简单的单点登录</a>
			</h2>
 			Posted on 2010-04-13 10:28 <a href="http://www.blogjava.net/xcp/" style="color:rgb(34, 51, 85);text-decoration:none;">xcp</a> 阅读(148953) <a href="http://www.blogjava.net/xcp/archive/2010/04/13/318125.html#Post" style="color:rgb(34, 51, 85);text-decoration:none;">评论(0)</a>  <a href="http://www.blogjava.net/xcp/admin/EditPosts.aspx?postid=318125" style="color:rgb(34, 51, 85);text-decoration:none;">编辑</a>  <a href="http://www.blogjava.net/xcp/AddToFavorite.aspx?id=318125" style="color:rgb(34, 51, 85);text-decoration:none;">收藏</a>  所属分类: <a href="http://www.blogjava.net/xcp/category/33476.html" style="color:rgb(34, 51, 85);text-decoration:none;">JAVA</a> 
			<img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/Image.png" type="image/png" data-filename="Image.png" height="1" style="border:0px;" width="1"/>
			


		</div>
		<div style="padding:4px;margin-bottom:14px;font-size:13px;"><span style="line-height:21px;">
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><span style="font-size:12pt;">摘要</span></strong><span style="font-size:12pt;">：单点登录（</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">）的技术被越来越广泛地运用到各个领域的软件系统当中。本文从业务的角度分析了单点登录的需求和应用领域；从技术本身的角度分析了单点登录技术的内部机制和实现手段，并且给出</span><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">和桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的实现、源代码和详细讲解；还从安全和性能的角度对现有的实现技术进行进一步分析，指出相应的风险和需要改进的方面。本文除了从多个方面和角度给出了对单点登录（</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">）的全面分析，还并且讨论了如何将现有的应用和</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">服务结合起来，能够帮助应用架构师和系统分析人员从本质上认识单点登录，从而更好地设计出符合需要的安全架构。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><span style="font-size:12pt;">关键字</span></strong><span style="font-size:12pt;">：</span><span style="font-size:12pt;">SSO, Java, J2EE, JAAS</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">1 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">什么是单点登陆</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">单点登录（</span><span style="font-size:12pt;">Single Sign On</span><span style="font-size:12pt;">），简称为 </span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，是目前比较流行的企业业务整合的解决方案之一。</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">较大的企业内部，一般都有很多的业务支持系统为其提供相应的管理和</span><span style="font-size:12pt;">IT</span><span style="font-size:12pt;">服
务。例如财务系统为财务人员提供财务的管理、计算和报表服务；人事系统为人事部门提供全公司人员的维护服务；各种业务系统为公司内部不同的业务提供不同的
服务等等。这些系统的目的都是让计算机来进行复杂繁琐的计算工作，来替代人力的手工劳动，提高工作效率和质量。这些不同的系统往往是在不同的时期建设起来
的，运行在不同的平台上；也许是由不同厂商开发，使用了各种不同的技术和标准。如果举例说国内一著名的</span><span style="font-size:12pt;">IT</span><span style="font-size:12pt;">公司（名字隐去），内部共有</span><span style="font-size:12pt;">60</span><span style="font-size:12pt;">多个业务系统，这些系统包括两个不同版本的</span><span style="font-size:12pt;">SAP</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">ERP</span><span style="font-size:12pt;">系统，</span><span style="font-size:12pt;">12</span><span style="font-size:12pt;">个不同类型和版本的数据库系统，</span><span style="font-size:12pt;">8</span><span style="font-size:12pt;">个不同类型和版本的操作系统，以及使用了</span><span style="font-size:12pt;">3</span><span style="font-size:12pt;">种不同的防火墙技术，还有数十种互相不能兼容的协议和标准，你相信吗？不要怀疑，这种情况其实非常普遍。每一个应用系统在运行了数年以后，都会成为不可替换的企业</span><span style="font-size:12pt;">IT</span><span style="font-size:12pt;">架构的一部分，如下图所示。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image002.gif" type="image/gif" data-filename="image002.gif" alt="" height="430" style="border:0px;border-width:0px;" width="554"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">随
着企业的发展，业务系统的数量在不断的增加，老的系统却不能轻易的替换，这会带来很多的开销。其一是管理上的开销，需要维护的系统越来越多。很多系统的数
据是相互冗余和重复的，数据的不一致性会给管理工作带来很大的压力。业务和业务之间的相关性也越来越大，例如公司的计费系统和财务系统，财务系统和人事系
统之间都不可避免的有着密切的关系。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">为了降低管理的消耗，最大限度的重用已有投资的系统，很多企业都在进行着企业应用集成（</span><span style="font-size:12pt;">EAI</span><span style="font-size:12pt;">）。
企业应用集成可以在不同层面上进行：例如在数据存储层面上的“数据大集中”，在传输层面上的“通用数据交换平台”，在应用层面上的“业务流程整合”，和用
户界面上的“通用企业门户”等等。事实上，还用一个层面上的集成变得越来越重要，那就是“身份认证”的整合，也就是“单点登录”。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">通常来说，每个单独的系统都会有自己的安全体系和身份认证系统。整合以前，进入每个系统都需要进行登录，这样的局面不仅给管理上带来了很大的困难，在安全方面也埋下了重大的隐患。下面是一些著名的调查公司显示的统计数据：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">用户每天平均 <strong>16 </strong>分钟花在身份验证任务上 <strong>- </strong><em style="font-style:italic;">资料来源： IDS</em></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">频繁的 <strong>IT </strong>用户平均有 <strong>21 </strong>个密码 <strong>- </strong><em style="font-style:italic;">资料来源： NTA Monitor Password Survey</em></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><strong><span style="font-size:10pt;color:black;">49% </span></strong><span style="font-size:10pt;color:black;">的人写下了其密码，而 <strong>67% </strong>的人很少改变它们</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">每 <strong>79 </strong>秒出现一起身份被窃事件 <strong>- </strong><em style="font-style:italic;">资料来源：National Small Business Travel Assoc</em></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">全球欺骗损失每年约 <strong>12B - </strong><em style="font-style:italic;">资料来源：Comm Fraud Control Assoc</em></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">到 <strong>2007 </strong>年，身份管理市场将成倍增长至 <strong>$4.5B - </strong><em style="font-style:italic;">资料来源：IDS</em></span></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">使用“单点登录”整合后，只需要登录一次就可以进入多个系统，而不需要重新登录，这不仅仅带来了更好的用户体验，更重要的是降低了安全的风险和管理的消耗。请看下面的统计数据：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">提高 <strong>IT </strong>效率：对于每 <strong>1000 </strong>个受管用户，每用户可节省<strong>$70K</strong></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">帮助台呼叫减少至少<strong>1/3</strong>，对于 <strong>10K </strong>员工的公司，每年可以节省每用户 <strong>$75</strong>，或者合计 <strong>$648K</strong></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:10pt;color:black;">生产力提高：每个新员工可节省 <strong>$1K</strong>，每个老员工可节省 <strong>$350 </strong></span><strong><span style="font-size:10pt;color:black;"></span></strong><em style="font-style:italic;"><span style="font-size:10pt;color:black;">资料来源：Giga</span></em></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><strong><span style="font-size:10pt;color:black;">ROI </span></strong><span style="font-size:10pt;color:black;">回报：<strong>7.5 </strong>到 <strong>13 </strong>个月 </span><span style="font-size:10pt;color:black;"></span><em style="font-style:italic;"><span style="font-size:10pt;color:black;">资料来源：Gartner</span></em></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">另外，使用“单点登录”还是</span><span style="font-size:12pt;">SOA</span><span style="font-size:12pt;">时代的需求之一。在面向服务的架构中，服务和服务之间，程序和程序之间的通讯大量存在，服务之间的安全认证是</span><span style="font-size:12pt;">SOA</span><span style="font-size:12pt;">应用的难点之一，应此建立“单点登录”的系统体系能够大大简化</span><span style="font-size:12pt;">SOA</span><span style="font-size:12pt;">的安全问题，提高服务之间的合作效率。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">2 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">单点登陆的技术实现机制</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">随着</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">技术的流行，</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的产品也是满天飞扬。所有著名的软件厂商都提供了相应的解决方案。在这里我并不想介绍自己公司（</span><span style="font-size:12pt;">Sun Microsystems</span><span style="font-size:12pt;">）的产品，而是对</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">技术本身进行解析，并且提供自己开发这一类产品的方法和简单演示。有关我写这篇文章的目的，请参考我的博客（</span><span style="font-size:12pt;"><a href="http://yuwang881.blog.sohu.com/" style="color:#770000;text-decoration:none;"><span style="font-size:10pt;">http://yuwang881.blog.sohu.com/3184816.html</span></a></span><span style="font-size:12pt;">）。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">单
点登录的机制其实是比较简单的，用一个现实中的例子做比较。颐和园是北京著名的旅游景点，也是我常去的地方。在颐和园内部有许多独立的景点，例如“苏州
街”、“佛香阁”和“德和园”，都可以在各个景点门口单独买票。很多游客需要游玩所有德景点，这种买票方式很不方便，需要在每个景点门口排队买票，钱包拿
进拿出的，容易丢失，很不安全。于是绝大多数游客选择在大门口买一张通票（也叫套票），就可以玩遍所有的景点而不需要重新再买票。他们只需要在每个景点门
口出示一下刚才买的套票就能够被允许进入每个独立的景点。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">单点登录的机制也一样，如下图所示，当用户第一次访问应用系统</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">的时候，因为还没有登录，会被引导到认证系统中进行登录（</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">）；根据用户提供的登录信息，认证系统进行身份效验，如果通过效验，应该返回给用户一个认证的凭据－－</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">2</span><span style="font-size:12pt;">）；用户再访问别的应用的时候（</span><span style="font-size:12pt;">3</span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">5</span><span style="font-size:12pt;">）就会将这个</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">带上，作为自己认证的凭据，应用系统接受到请求之后会把</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">送到认证系统进行效验，检查</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">的合法性（</span><span style="font-size:12pt;">4</span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">6</span><span style="font-size:12pt;">）。如果通过效验，用户就可以在不用再次登录的情况下访问应用系统</span><span style="font-size:12pt;">2</span><span style="font-size:12pt;">和应用系统</span><span style="font-size:12pt;">3</span><span style="font-size:12pt;">了。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image004.gif" type="image/gif" data-filename="image004.gif" alt="" height="262" style="border:0px;border-width:0px;" width="470"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">从上面的视图可以看出，要实现</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，需要以下主要的功能：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">所有应用系统共享一个身份认证系统。</span><span style="font-size:12pt;"><br/>
    </span><span style="font-size:12pt;">统一的认证系统是</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的前提之一。认证系统的主要功能是将用户的登录信息和用户信息库相比较，对用户进行登录认证；认证成功后，认证系统应该生成统一的认证标志（</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">），返还给用户。另外，认证系统还应该对</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">进行效验，判断其有效性。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">所有应用系统能够识别和提取</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">信息</span><span style="font-size:12pt;"><br/>
    </span><span style="font-size:12pt;">要实现</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能，让用户只登录一次，就必须让应用系统能够识别已经登录过的用户。应用系统应该能对</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">进行识别和提取，通过与认证系统的通讯，能自动判断当前用户是否登录过，从而完成单点登录的功能。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">上面的功能只是一个非常简单的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">架构，在现实情况下的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">有着更加复杂的结构。有两点需要指出的是：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">单一的用户信息数据库并不是必须的，有许多系统不能将所有的用户信息都集中存储，应该允许用户信息放置在不同的存储中，如下图所示。事实上，只要统一认证系统，统一</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">的产生和效验，无论用户信息存储在什么地方，都能实现单点登录。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;"> <img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image006.gif" type="image/gif" data-filename="image006.gif" alt="" height="235" style="border:0px;border-width:0px;" width="503"/></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">统一的认证系统并不是说只有单个的认证服务器，如下图所示，整个系统可以存在两个以上的认证服务器，这些服务器甚至可以是不同的产品。认证服务器之间要通过标准的通讯协议，互相交换认证信息，就能完成更高级别的单点登录。如下图，当用户在访问应用系统</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">时，由第一个认证服务器进行认证后，得到由此服务器产生的</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">。当他访问应用系统</span><span style="font-size:12pt;">4</span><span style="font-size:12pt;">的时候，认证服务器</span><span style="font-size:12pt;">2</span><span style="font-size:12pt;">能够识别此</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">是由第一个服务器产生的，通过认证服务器之间标准的通讯协议（例如</span><span style="font-size:12pt;">SAML</span><span style="font-size:12pt;">）来交换认证信息，仍然能够完成</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;"> <img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image008.gif" type="image/gif" data-filename="image008.gif" alt="" height="277" style="border:0px;border-width:0px;" width="556"/></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">3 WEB-SSO</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">的实现</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">随着互联网的高速发展，</span><span style="font-size:12pt;">WEB</span><span style="font-size:12pt;">应用几乎统治了绝大部分的软件应用系统，因此</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">是</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">应用当中最为流行。</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">有其自身的特点和优势，实现起来比较简单易用。很多商业软件和开源软件都有对</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">的实现。其中值得一提的是</span><span style="font-size:12pt;">OpenSSO </span><span style="font-size:12pt;">（</span><span style="font-size:12pt;"><a href="https://opensso.dev.java.net/" style="color:#770000;text-decoration:none;">https://opensso.dev.java.net</a></span><span style="font-size:12pt;">），为用</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">实现</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">提供架构指南和服务指南，为用户自己来实现</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">提供了理论的依据和实现的方法。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">为什么说</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">比较容易实现呢？这是有</span><span style="font-size:12pt;">WEB</span><span style="font-size:12pt;">应用自身的特点决定的。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">众所周知，</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">协议（也就是</span><span style="font-size:12pt;">HTTP</span><span style="font-size:12pt;">）是一个无状态的协议。一个</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用由很多个</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">页面组成，每个页面都有唯一的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">来定义。用户在浏览器的地址栏输入页面的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">，浏览器就会向</span><span style="font-size:12pt;">Web Server</span><span style="font-size:12pt;">去发送请求。如下图，浏览器向</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器发送了两个请求，申请了两个页面。这两个页面的请求是分别使用了两个单独的</span><span style="font-size:12pt;">HTTP</span><span style="font-size:12pt;">连接。所谓无状态的协议也就是表现在这里，浏览器和</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器会在第一个请求完成以后关闭连接通道，在第二个请求的时候重新建立连接。</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器并不区分哪个请求来自哪个客户端，对所有的请求都一视同仁，都是单独的连接。这样的方式大大区别于传统的（</span><span style="font-size:12pt;">Client/Server</span><span style="font-size:12pt;">）</span><span style="font-size:12pt;">C/S</span><span style="font-size:12pt;">结构</span><span style="font-size:12pt;">,</span><span style="font-size:12pt;">在那样的应用中，客户端和服务器端会建立一个长时间的专用的连接通道。正是因为有了无状态的特性，每个连接资源能够很快被其他客户端所重用，一台</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器才能够同时服务于成千上万的客户端。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image010.gif" type="image/gif" data-filename="image010.gif" alt="" height="191" style="border:0px;border-width:0px;" width="554"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">但是我们通常的应用是有状态的。先不用提不同应用之间的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，在同一个应用中也需要保存用户的登录身份信息。例如用户在访问页面</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">的时候进行了登录，但是刚才也提到，客户端的每个请求都是单独的连接，当客户再次访问页面</span><span style="font-size:12pt;">2</span><span style="font-size:12pt;">的时候，如何才能告诉</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器，客户刚才已经登录过了呢？浏览器和服务器之间有约定：通过使用</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">技术来维护应用的状态。</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">是可以被</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器设置的字符串，并且可以保存在浏览器中。如下图所示，当浏览器访问了页面</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">时，</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">服务器设置了一个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，并将这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">和页面</span><span style="font-size:12pt;">1</span><span style="font-size:12pt;">一起返回给浏览器，浏览器接到</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">之后，就会保存起来，在它访问页面</span><span style="font-size:12pt;">2</span><span style="font-size:12pt;">的时候会把这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">也带上，</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器接到请求时也能读出</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的值，根据</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">值的内容就可以判断和恢复一些用户的信息状态。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image012.gif" type="image/gif" data-filename="image012.gif" alt="" height="171" style="border:0px;border-width:0px;" width="553"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">完全可以利用</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">结束来完成用户登录信息的保存，将浏览器中的</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">和上文中的</span><span style="font-size:12pt;">Ticket</span><span style="font-size:12pt;">结合起来，完成</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">为了完成一个简单的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能，需要两个部分的合作：</span></div>
<ol style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="1">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">统一的身份认证服务。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">修改</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用，使得每个应用都通过这个统一的认证服务来进行身份效验。</span></li>
</ol>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><span style="font-size:13.5pt;">3.1 Web SSO </span></strong><strong><span style="font-size:13.5pt;">的样例</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">根据上面的原理，我用</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">的技术（</span><span style="font-size:12pt;">JSP</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">）完成了一个具有</span><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">的简单样例。样例包含一个身份认证的服务器和两个简单的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用，使得这两个 </span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用通过统一的身份认证服务来完成</span><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">的功能。此样例所有的源代码和二进制代码都可以从网站地址</span><span style="font-size:12pt;"><a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/</a> </span><span style="font-size:12pt;">下载。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><span style="font-size:12pt;">样例下载、安装部署和运行指南：</span></strong></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">的样例是由三个标准</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用组成，压缩成三个</span><span style="font-size:12pt;">zip</span><span style="font-size:12pt;">文件，从</span><span style="font-size:12pt;"><a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/web-sso</a>/</span><span style="font-size:12pt;">中下载。其中</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;"><a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/web-sso/SSOAuth.zip</a></span><span style="font-size:12pt;">）是身份认证服务；</span><span style="font-size:12pt;">SSOWebDemo1</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;"><a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/web-sso/SSOWebDemo1.zip</a></span><span style="font-size:12pt;">）和</span><span style="font-size:12pt;">SSOWebDemo2</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;"><a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/web-sso/SSOWebDemo2.zip</a></span><span style="font-size:12pt;">）是两个用来演示单点登录的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用。这三个</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用之所以没有打成</span><span style="font-size:12pt;">war</span><span style="font-size:12pt;">包，是因为它们不能直接部署，根据读者的部署环境需要作出小小的修改。样例部署和运行的环境有一定的要求，需要符合</span><span style="font-size:12pt;">Servlet2.3</span><span style="font-size:12pt;">以上标准的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">容器才能运行（例如</span><span style="font-size:12pt;">Tomcat5,Sun Application Server 8, Jboss 4</span><span style="font-size:12pt;">等）。另外，身份认证服务需要</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">的运行环境。之所以要用</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">是因为笔者使用了一个线程安全的高性能的</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">集合类“</span><span style="font-size:12pt;">ConcurrentMap”</span><span style="font-size:12pt;">，只有在</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">中才有。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">这三个</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用完全可以单独部署，它们可以分别部署在不同的机器，不同的操作系统和不同的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">的产品上，它们完全是标准的和平台无关的应用。但是有一个限制，那两台部署应用（</span><span style="font-size:12pt;">demo1</span><span style="font-size:12pt;">、</span><span style="font-size:12pt;">demo2</span><span style="font-size:12pt;">）的机器的域名需要相同，这在后面的章节中会解释到</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">domain</span><span style="font-size:12pt;">的关系以及如何制作跨域的</span><span style="font-size:12pt;">WEB-SSO</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">解压缩</span><span style="font-size:12pt;">SSOAuth.zip</span><span style="font-size:12pt;">文件，在</span><span style="font-size:12pt;">/WEB-INF/</span><span style="font-size:12pt;">下的</span><span style="font-size:12pt;">web.xml</span><span style="font-size:12pt;">中请修改“</span><span style="font-size:12pt;">domainname”</span><span style="font-size:12pt;">的属性以反映实际的应用部署情况，</span><span style="font-size:12pt;">domainname</span><span style="font-size:12pt;">需要设置为两个单点登录的应用（</span><span style="font-size:12pt;">demo1</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">demo2</span><span style="font-size:12pt;">）所属的域名。这个</span><span style="font-size:12pt;">domainname</span><span style="font-size:12pt;">和当前</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">服务部署的机器的域名没有关系。我缺省设置的是“</span><span style="font-size:12pt;">.sun.com”</span><span style="font-size:12pt;">。如果你部署</span><span style="font-size:12pt;">demo1</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">demo2</span><span style="font-size:12pt;">的机器没有域名，请输入</span><span style="font-size:12pt;">IP</span><span style="font-size:12pt;">地址或主机名（如</span><span style="font-size:12pt;">localhost</span><span style="font-size:12pt;">），但是如果使用</span><span style="font-size:12pt;">IP</span><span style="font-size:12pt;">地址或主机名也就意味着</span><span style="font-size:12pt;">demo1</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">demo2</span><span style="font-size:12pt;">需要部署到一台机器上了。设置完后，根据你所选择的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">容器，可能需要将</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">这个目录压缩打包成</span><span style="font-size:12pt;">war</span><span style="font-size:12pt;">文件。用“</span><span style="font-size:12pt;">jar -cvf SSOAuth.war SSOAuth/”</span><span style="font-size:12pt;">就可以完成这个功能。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">解压缩</span><span style="font-size:12pt;">SSOWebDemo1</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOWebDemo2</span><span style="font-size:12pt;">文件，分别在它们</span><span style="font-size:12pt;">/WEB-INF/</span><span style="font-size:12pt;">下找到</span><span style="font-size:12pt;">web.xml</span><span style="font-size:12pt;">文件，请修改其中的几个初始化参数</span><span style="font-size:12pt;"><br/>
    &lt;init-param&gt;<br/>
    &lt;param-name&gt;SSOServiceURL&lt;/param-name&gt;<br/>
    &lt;param-value&gt;<a href="http://wangyu.prc.sun.com:8080/SSOAuth/SSOAuth" style="color:#770000;text-decoration:none;">http://wangyu.prc.sun.com:8080/SSOAuth/SSOAuth</a>&lt;/param-value&gt;<br/>
    &lt;/init-param&gt;<br/>
    &lt;init-param&gt;<br/>
    &lt;param-name&gt;SSOLoginPage&lt;/param-name&gt;<br/>
    &lt;param-value&gt;<a href="http://wangyu.prc.sun.com:8080/SSOAuth/login.jsp" style="color:#770000;text-decoration:none;">http://wangyu.prc.sun.com:8080/SSOAuth/login.jsp</a>&lt;/param-value&gt;<br/>
    &lt;/init-param&gt;<br/>
    </span><span style="font-size:12pt;">将其中的</span><span style="font-size:12pt;">SSOServiceURL</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOLoginPage</span><span style="font-size:12pt;">修改成部署</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">应用的机器名、端口号以及根路径（缺省是</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">）以反映实际的部署情况。设置完后，根据你所选择的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">容器，可能需要将</span><span style="font-size:12pt;">SSOWebDemo1</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOWebDemo2</span><span style="font-size:12pt;">这两个目录压缩打包成两个</span><span style="font-size:12pt;">war</span><span style="font-size:12pt;">文件。用“</span><span style="font-size:12pt;">jar -cvf SSOWebDemo1.war SSOWebDemo1/”</span><span style="font-size:12pt;">就可以完成这个功能。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">请输入第一个</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">应用的测试</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">test.jsp</span><span style="font-size:12pt;">）</span><span style="font-size:12pt;">,</span><span style="font-size:12pt;">例如</span><span style="font-size:12pt;">http://wangyu.prc.sun.com:8080/ SSOWebDemo1/test.jsp</span><span style="font-size:12pt;">，如果是第一次访问，便会自动跳转到登录界面，如下图</span><span style="font-size:12pt;"><br/>
    <br/>
    <img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image014.gif" type="image/gif" data-filename="image014.gif" alt="" height="307" style="border:0px;border-width:0px;" width="554"/></span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">使用系统自带的三个帐号之一登录（例如，用户名：</span><span style="font-size:12pt;">wangyu,</span><span style="font-size:12pt;">密码：</span><span style="font-size:12pt;">wangyu</span><span style="font-size:12pt;">），便能成功的看到</span><span style="font-size:12pt;">test.jsp</span><span style="font-size:12pt;">的内容：显示当前用户名和欢迎信息。</span><span style="font-size:12pt;"><br/>
    <img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image016.gif" type="image/gif" data-filename="image016.gif" alt="" height="307" style="border:0px;border-width:0px;" width="554"/></span></li>
</ul>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">请接着在同一个浏览器中输入第二个</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">应用的测试</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">test.jsp</span><span style="font-size:12pt;">）</span><span style="font-size:12pt;">,</span><span style="font-size:12pt;">例如</span><span style="font-size:12pt;">http://wangyu.prc.sun.com:8080/ SSOWebDemo2/test.jsp</span><span style="font-size:12pt;">。你会发现，不需要再次登录就能看到</span><span style="font-size:12pt;">test.jsp</span><span style="font-size:12pt;">的内容，同样是显示当前用户名和欢迎信息，而且欢迎信息中明确的显示当前的应用名称（</span><span style="font-size:12pt;">demo2</span><span style="font-size:12pt;">）。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 12pt;">             <img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image018.gif" type="image/gif" data-filename="image018.gif" alt="" height="307" style="border:0px;border-width:0px;" width="554"/></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><span style="font-size:13.5pt;">3.2 WEB-SSO</span></strong><strong><span style="font-size:13.5pt;">代码讲解</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><strong><span style="font-size:12pt;">3.2.1</span></strong><strong><span style="font-size:12pt;">身份认证服务代码解析</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">的源代码可以从网站地址</span><span style="font-size:12pt;">http://gceclub.sun.com.cn/wangyu/web-sso/websso_src.zip</span><span style="font-size:12pt;">下载。身份认证服务是一个标准的</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">应用，包括一个名为</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">，一个</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">文件和一个</span><span style="font-size:12pt;">failed.html</span><span style="font-size:12pt;">。身份认证的所有服务几乎都由</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">来实现了；</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">用来显示登录的页面（如果发现用户还没有登录过）；</span><span style="font-size:12pt;">failed.html</span><span style="font-size:12pt;">是用来显示登录失败的信息（如果用户的用户名和密码与信息数据库中的不一样）。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的代码如下面的列表显示，结构非常简单，先看看这个</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">的主体部分<strong>：</strong></span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">package DesktopSSO;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.io.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.net.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.text.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.util.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.util.concurrent.*;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import javax.servlet.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import javax.servlet.http.*;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">public class SSOAuth extends HttpServlet {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">static private ConcurrentMap accounts;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">static private ConcurrentMap SSOIDs;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">String cookiename=&quot;WangYuDesktopSSOID&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">String domainname;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">public void init(ServletConfig config) throws ServletException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">super.init(config);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">domainname= config.getInitParameter(&quot;domainname&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">cookiename = config.getInitParameter(&quot;cookiename&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">SSOIDs = new ConcurrentHashMap();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">accounts=new ConcurrentHashMap();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">accounts.put(&quot;wangyu&quot;, &quot;wangyu&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">accounts.put(&quot;paul&quot;, &quot;paul&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">accounts.put(&quot;carol&quot;, &quot;carol&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">protected void processRequest(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">PrintWriter out = response.getWriter();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String action = request.getParameter(&quot;action&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String result=&quot;failed&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (action==null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">handlerFromLogin(request,response);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} else if (action.equals(&quot;authcookie&quot;)){</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">String myCookie = request.getParameter(&quot;cookiename&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (myCookie != null) result = authCookie(myCookie);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">out.print(result);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">out.close();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} else if (action.equals(&quot;authuser&quot;)) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">           </span><span style="font-size:12pt;">result=authNameAndPasswd(request,response);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">out.print(result);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">out.close();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} else if (action.equals(&quot;logout&quot;)) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">String myCookie = request.getParameter(&quot;cookiename&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">logout(myCookie);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">out.close();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">.....</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">从代码很容易看出，</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">就是一个简单的</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">。其中有两个静态成员变量：</span><span style="font-size:12pt;">accounts</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOIDs</span><span style="font-size:12pt;">，这两个成员变量都使用了</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">中线程安全的</span><span style="font-size:12pt;">MAP</span><span style="font-size:12pt;">类： ConcurrentMap</span><span style="font-size:12pt;">，所以这个样例一定要</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">才能运行。</span><span style="font-size:12pt;">Accounts</span><span style="font-size:12pt;">用来存放用户的用户名和密码，在</span><span style="font-size:12pt;">init()</span><span style="font-size:12pt;">的方法中可以看到我给系统添加了三个合法的用户。在实际应用中，</span><span style="font-size:12pt;">accounts</span><span style="font-size:12pt;">应该是去数据库中或</span><span style="font-size:12pt;">LDAP</span><span style="font-size:12pt;">中获得，为了简单起见，在本样例中我使用了</span><span style="font-size:12pt;">ConcurrentMap</span><span style="font-size:12pt;">在内存中用程序创建了三个用户。而</span><span style="font-size:12pt;">SSOIDs</span><span style="font-size:12pt;">保存了在用户成功的登录后所产生的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">和用户名的对应关系。它的功能显而易见：当用户成功登录以后，再次访问别的系统，为了鉴别这个用户请求所带的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的有效性，需要到</span><span style="font-size:12pt;">SSOIDs</span><span style="font-size:12pt;">中检查这样的映射关系是否存在。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">在主要的请求处理方法</span><span style="font-size:12pt;">processRequest()</span><span style="font-size:12pt;">中，可以很清楚的看到</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的所有功能</span></div>
<ol style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="1">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">如果用户还没有登录过，是第一次登录本系统，会被跳转到</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">页面（在后面会解释如何跳转）。用户在提供了用户名和密码以后，就会用</span><span style="font-size:12pt;">handlerFromLogin()</span><span style="font-size:12pt;">这个方法来验证。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">如果用户已经登录过本系统，再访问别的应用的时候，是不需要再次登录的。因为浏览器会将第一次登录时产生的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">和请求一起发送。效验</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的有效性是</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的主要功能之一。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">还能直接效验非</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">页面过来的用户名和密码的效验请求。这个功能是用于非</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">应用的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，这在后面的桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">中会用到。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">还提供</span><span style="font-size:12pt;">logout</span><span style="font-size:12pt;">服务。</span></li>
</ol>
<div align="left"> </div>
<div align="left"><span style="font-size:12pt;">下面看看几个主要的功能函数：</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span><span style="font-size:12pt;">private void handlerFromLogin(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String username = request.getParameter(&quot;username&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String password = request.getParameter(&quot;password&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String pass = (String)accounts.get(username);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if ((pass==null)||(!pass.equals(password)))</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">getServletContext().getRequestDispatcher(&quot;/failed.html&quot;).forward(request, response);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">else {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">String gotoURL = request.getParameter(&quot;goto&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">String newID = createUID();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">SSOIDs.put(newID, username);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">Cookie wangyu = new Cookie(cookiename, newID);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">wangyu.setDomain(domainname);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">wangyu.setMaxAge(60000);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">wangyu.setValue(newID);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">wangyu.setPath(&quot;/&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">response.addCookie(wangyu);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">System.out.println(&quot;login success, goto back url:&quot; + gotoURL);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (gotoURL != null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">PrintWriter out = response.getWriter();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">response.sendRedirect(gotoURL);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">out.close();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}  </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">handlerFromLogin()</span><span style="font-size:12pt;">这个方法是用来处理来自</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">的登录请求。它的逻辑很简单：将用户输入的用户名和密码与预先设定好的用户集合（存放在</span><span style="font-size:12pt;">accounts</span><span style="font-size:12pt;">中）相比较，如果用户名或密码不匹配的话，则返回登录失败的页面（</span><span style="font-size:12pt;">failed.html</span><span style="font-size:12pt;">），如果登录成功的话，需要为用户当前的</span><span style="font-size:12pt;">session</span><span style="font-size:12pt;">创建一个新的</span><span style="font-size:12pt;">ID</span><span style="font-size:12pt;">，并将这个</span><span style="font-size:12pt;">ID</span><span style="font-size:12pt;">和用户名的映射关系存放到</span><span style="font-size:12pt;">SSOIDs</span><span style="font-size:12pt;">中，最后还要将这个</span><span style="font-size:12pt;">ID</span><span style="font-size:12pt;">设置为浏览器能够保存的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">值。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">登录成功后，浏览器会到哪个页面呢？那我们回顾一下我们是如何使用身份认证服务的。一般来说我们不会直接访问身份服务的任何</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">，包括</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">。身份服务是用来保护其他应用服务的，用户一般在访问一个受</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">保护的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用的某个</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">时，当前这个应用会发现当前的用户还没有登录，便强制将也页面转向</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">，让用户登录。如果登录成功后，应该自动的将用户的浏览器指向用户最初想访问的那个</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">。在</span><span style="font-size:12pt;">handlerFromLogin()</span><span style="font-size:12pt;">这个方法中，我们通过接收</span><span style="font-size:12pt;">“</span><span style="font-size:12pt;">goto”</span><span style="font-size:12pt;">这个参数来保存用户最初访问的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">，成功后便重新定向到这个页面中。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">另外一个要说明的是，在设置</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的时候，我使用了一个setMaxAge(6000)</span><span style="font-size:12pt;">的方法。这个方法是用来设置</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的有效期，单位是秒。如果不使用这个方法或者参数为负数的话，当浏览器关闭的时候，这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">就失效了。在这里我给了很大的值（</span><span style="font-size:12pt;">1000</span><span style="font-size:12pt;">分钟），导致的行为是：当你关闭浏览器（或者关机），下次再打开浏览器访问刚才的应用，只要在</span><span style="font-size:12pt;">1000</span><span style="font-size:12pt;">分钟之内，就不需要再登录了。我这样做是下面要介绍的桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">中所需要的功能。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">其他的方法更加简单，这里就不多解释了。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><strong><span style="font-size:12pt;">3.2.2</span></strong><strong><span style="font-size:12pt;">具有</span></strong><strong><span style="font-size:12pt;">SSO</span></strong><strong><span style="font-size:12pt;">功能的</span></strong><strong><span style="font-size:12pt;">web</span></strong><strong><span style="font-size:12pt;">应用源代码解析</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">要实现</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">的功能，只有身份认证服务是不够的。这点很显然，要想使多个应用具有单点登录的功能，还需要每个应用本身的配合：将自己的身份认证的服务交给一个统一的身份认证服务－</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">。</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">服务中提供的各个方法就是供每个加入</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用来调用的。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">一般来说，</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用需要</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能，应该通过以下的交互过程来调用身份认证服务的提供的认证服务：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用中每一个需要安全保护的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">在访问以前，都需要进行安全检查，如果发现没有登录（没有发现认证之后所带的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">），就重新定向到</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">中的</span><span style="font-size:12pt;">login.jsp</span><span style="font-size:12pt;">进行登录。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">登录成功后，系统会自动给你的浏览器设置</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，证明你已经登录过了。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">当你再访问这个应用的需要保护的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">的时候，系统还是要进行安全检查的，但是这次系统能够发现相应的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">有了这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，还不能证明你就一定有权限访问。因为有可能你已经</span><span style="font-size:12pt;">logout,</span><span style="font-size:12pt;">或者</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">已经过期了，或者身份认证服务重起过，这些情况下，你的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">都可能无效。应用系统拿到这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，还需要调用身份认证的服务，来判断</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">时候真的有效，以及当前的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">对应的用户是谁。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">如果</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">效验成功，就允许用户访问当前请求的资源。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">以上这些功能，可以用很多方法来实现：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">在每个被访问的资源中（</span><span style="font-size:12pt;">JSP</span><span style="font-size:12pt;">或</span><span style="font-size:12pt;">Servlet</span><span style="font-size:12pt;">）中都加入身份认证的服务，来获得</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，并且判断当前用户是否登录过。不过这个笨方法没有人会用</span><span style="font-size:12pt;">:-)</span><span style="font-size:12pt;">。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">可以通过一个</span><span style="font-size:12pt;">controller</span><span style="font-size:12pt;">，将所有的功能都写到一个</span><span style="font-size:12pt;">servlet</span><span style="font-size:12pt;">中，然后在</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">映射的时候，映射到所有需要保护的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">集合中（例如</span><span style="font-size:12pt;">*.jsp</span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">/security/*</span><span style="font-size:12pt;">等）。这个方法可以使用，不过，它的缺点是不能重用。在每个应用中都要部署一个相同的</span><span style="font-size:12pt;">servlet</span><span style="font-size:12pt;">。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">是比较好的方法。符合</span><span style="font-size:12pt;">Servlet2.3</span><span style="font-size:12pt;">以上的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">容器就具有部署</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">的功能。（</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">的使用可以参考</span><span style="font-size:12pt;">JavaWolrd</span><span style="font-size:12pt;">的文章</span><span style="font-size:12pt;">http://www.javaworld.com/javaworld/jw-06-2001/jw-0622-filters.html</span><span style="font-size:12pt;">）</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">是一个具有很好的模块化，可重用的编程</span><span style="font-size:12pt;">API</span><span style="font-size:12pt;">，用在</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">正合适不过。本样例就是使用一个</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">来完成以上的功能。</span></li>
</ul>
<div align="left"> </div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">package SSO;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.io.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.net.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.util.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import java.text.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import javax.servlet.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import javax.servlet.http.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import javax.servlet.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import org.apache.commons.httpclient.*;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">import org.apache.commons.httpclient.methods.GetMethod;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">public class SSOFilter implements Filter {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private FilterConfig filterConfig = null;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private String cookieName=&quot;WangYuDesktopSSOID&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private String SSOServiceURL= &quot;http://wangyu.prc.sun.com:8080/SSOAuth/SSOAuth&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private String SSOLoginPage= &quot;http://wangyu.prc.sun.com:8080/SSOAuth/login.jsp&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">public void init(FilterConfig filterConfig) {</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">this.filterConfig = filterConfig;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (filterConfig != null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (debug) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">log(&quot;SSOFilter:Initializing filter&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}       </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">cookieName = filterConfig.getInitParameter(&quot;cookieName&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">SSOServiceURL = filterConfig.getInitParameter(&quot;SSOServiceURL&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">SSOLoginPage = filterConfig.getInitParameter(&quot;SSOLoginPage&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">} </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">.....</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">.....</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">以上的初始化的源代码有两点需要说明：一是有两个需要配置的参数</span><span style="font-size:12pt;">SSOServiceURL</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOLoginPage</span><span style="font-size:12pt;">。因为当前的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用很可能和身份认证服务（</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">）不在同一台机器上，所以需要让这个</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">知道身份认证服务部署的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">，这样才能去调用它的服务。另外一点就是由于身份认证的服务调用是要通过</span><span style="font-size:12pt;">http</span><span style="font-size:12pt;">协议来调用的（在本样例中是这样设计的，读者完全可以设计自己的身份服务，使用别的调用协议，如</span><span style="font-size:12pt;">RMI</span><span style="font-size:12pt;">或</span><span style="font-size:12pt;">SOAP</span><span style="font-size:12pt;">等等），所有笔者引用了</span><span style="font-size:12pt;">apache</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">commons</span><span style="font-size:12pt;">工具包（详细信息情访问</span><span style="font-size:12pt;">apache </span><span style="font-size:12pt;">的网站</span><span style="font-size:12pt;">http://jakarta.apache.org/commons/index.html</span><span style="font-size:12pt;">），其中的</span><span style="font-size:12pt;">“</span><span style="font-size:12pt;">httpclient”</span><span style="font-size:12pt;">可以大大简化</span><span style="font-size:12pt;">http</span><span style="font-size:12pt;">调用的编程。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">下面看看</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">的主体方法</span><span style="font-size:12pt;">doFilter():</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (debug) log(&quot;SSOFilter:doFilter()&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpServletRequest request = (HttpServletRequest) req;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpServletResponse response = (HttpServletResponse) res;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String result=&quot;failed&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String url = request.getRequestURL().toString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String qstring = request.getQueryString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (qstring == null) qstring =&quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">//</span><span style="font-size:12pt;">检查</span><span style="font-size:12pt;">http</span><span style="font-size:12pt;">请求的</span><span style="font-size:12pt;">head</span><span style="font-size:12pt;">是否有需要的</span><span style="font-size:12pt;">cookie</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String cookieValue =&quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">javax.servlet.http.Cookie[] diskCookies = request.getCookies();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (diskCookies != null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">for (int i = 0; i &lt; diskCookies.length; i++) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">if(diskCookies[i].getName().equals(cookieName)){</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                    </span><span style="font-size:12pt;">cookieValue = diskCookies[i].getValue();</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                    </span><span style="font-size:12pt;">//</span><span style="font-size:12pt;">如果找到了相应的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">则效验其有效性</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                    </span><span style="font-size:12pt;">result = SSOService(cookieValue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                    </span><span style="font-size:12pt;">if (debug) log(&quot;found cookies!&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">if (result.equals(&quot;failed&quot;)) { //</span><span style="font-size:12pt;">效验失败或没有找到</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，则需要登录</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">response.sendRedirect(SSOLoginPage+&quot;?goto=&quot;+url);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} else if (qstring.indexOf(&quot;logout&quot;) &gt; 1) {//logout</span><span style="font-size:12pt;">服务</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (debug) log(&quot;logout action!&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">logoutService(cookieValue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">response.sendRedirect(SSOLoginPage+&quot;?goto=&quot;+url);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} else {//</span><span style="font-size:12pt;">效验成功</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">request.setAttribute(&quot;SSOUser&quot;,result);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">Throwable problem = null;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">chain.doFilter(req, res);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">} catch(Throwable t) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">problem = t;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">t.printStackTrace();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">}      </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (problem != null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">if (problem instanceof ServletException) throw (ServletException)problem;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">if (problem instanceof IOException) throw (IOException)problem;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">                </span><span style="font-size:12pt;">sendProcessingError(problem, res);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}  </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">doFilter()</span><span style="font-size:12pt;">方法的逻辑也是非常简单的，在接收到请求的时候，先去查找是否存在期望的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">值，如果找到了，就会调用</span><span style="font-size:12pt;">SSOService(cookieValue)</span><span style="font-size:12pt;">去效验这个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的有效性。如果</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">效验不成功或者</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">根本不存在，就会直接转到登录界面让用户登录；如果</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">效验成功，就不会做任何阻拦，让此请求进行下去。在配置文件中，有下面的一个节点表示了此</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">映射关系：只拦截所有的</span><span style="font-size:12pt;">jsp</span><span style="font-size:12pt;">请求。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">&lt;filter-mapping&gt;<br/>
&lt;filter-name&gt;SSOFilter&lt;/filter-name&gt;<br/>
&lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;<br/>
&lt;/filter-mapping&gt;</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left"><span style="font-size:12pt;">下面还有几个主要的函数需要说明：</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private String SSOService(String cookievalue) throws IOException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String authAction = &quot;?action=authcookie&amp;cookiename=&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpClient httpclient = new HttpClient();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">GetMethod httpget = new GetMethod(SSOServiceURL+authAction+cookievalue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try { </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpclient.executeMethod(httpget);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">String result = httpget.getResponseBodyAsString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">return result;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} finally {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpget.releaseConnection();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">private void logoutService(String cookievalue) throws IOException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String authAction = &quot;?action=logout&amp;cookiename=&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpClient httpclient = new HttpClient();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">GetMethod httpget = new GetMethod(SSOServiceURL+authAction+cookievalue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpclient.executeMethod(httpget);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpget.getResponseBodyAsString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} finally {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpget.releaseConnection();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">这两个函数主要是利用</span><span style="font-size:12pt;">apache</span><span style="font-size:12pt;">中的</span><span style="font-size:12pt;">httpclient</span><span style="font-size:12pt;">访问</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">提供的认证服务来完成效验</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">logout</span><span style="font-size:12pt;">的功能。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">其他的函数都很简单，有很多都是我的</span><span style="font-size:12pt;">IDE</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">NetBeans</span><span style="font-size:12pt;">）替我自动生成的。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">4 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">当前方案的安全局限性</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">当前这个</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">的方案是一个比较简单的雏形，主要是用来演示</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的概念和说明</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">技术的实现方式。有很多方面还需要完善，其中安全性是非常重要的一个方面。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">我们说过，采用</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">技术的主要目的之一就是加强安全性，降低安全风险。因为采用了</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，在网络上传递密码的次数减少，风险降低是显然的，但是当前的方案却有其他的安全风险。由于</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">是一个用户登录的唯一凭据，对</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的保护措施是系统安全的重要环节：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的长度和复杂度</span><span style="font-size:12pt;"><br/>
    </span><span style="font-size:12pt;">在本方案中，</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">是有一个固定的字符串（我的姓名）加上当前的时间戳。这样的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">很容易被伪造和猜测。怀有恶意的用户如果猜测到合法的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">就可以被当作已经登录的用户，任意访问权限范围内的资源</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的效验和保护</span><span style="font-size:12pt;"><br/>
    </span><span style="font-size:12pt;">在本方案中，虽然密码只要传输一次就够了，可</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">在网络中是经常传来传去。一些网络探测工具（如</span><span style="font-size:12pt;">sniff, snoop,tcpdump</span><span style="font-size:12pt;">等）可以很容易捕获到</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的数值。在本方案中，并没有考虑</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">在传输时候的保护。另外对</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的效验也过于简单，并不去检查发送</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的来源究竟是不是</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">最初的拥有者，也就是说无法区分正常的用户和仿造</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的用户。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">当其中一个应用的安全性不好，其他所有的应用都会受到安全威胁</span><span style="font-size:12pt;"><br/>
    </span><span style="font-size:12pt;">因为有</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，所以当某个处于 </span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的应用被黒客攻破，那么很容易攻破其他处于同一个</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">保护的应用。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">这些安全漏洞在商业的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">解决方案中都会有所考虑，提供相关的安全措施和保护手段，例如</span><span style="font-size:12pt;">Sun</span><span style="font-size:12pt;">公司的</span><span style="font-size:12pt;">Access Manager</span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的复杂读和对</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的保护都做得非常好。另外在</span><span style="font-size:12pt;">OpneSSO </span><span style="font-size:12pt;">（</span><span style="font-size:12pt;"><a href="https://opensso.dev.java.net/" style="color:#770000;text-decoration:none;">https://opensso.dev.java.net</a></span><span style="font-size:12pt;">）的架构指南中也给出了部分安全措施的解决方案。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">5 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">当前方案的功能和性能局限性</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">除了安全性，当前方案在功能和性能上都需要很多的改进：</span></div>
<ul style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="disc">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">当前所提供的登录认证模式只有一种：用户名和密码，而且为了简单，将用户名和密码放在内存当中。事实上，用户身份信息的来源应该是多种多样的，可以是来自数据库中，</span><span style="font-size:12pt;">LDAP</span><span style="font-size:12pt;">中，甚至于来自操作系统自身的用户列表。还有很多其他的认证模式都是商务应用不可缺少的，因此</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的解决方案应该包括各种认证的模式，包括数字证书，</span><span style="font-size:12pt;">Radius</span><span style="font-size:12pt;">， </span><span style="font-size:12pt;">SafeWord </span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">MemberShip</span><span style="font-size:12pt;">，</span><span style="font-size:12pt;">SecurID</span><span style="font-size:12pt;">等多种方式。最为灵活的方式应该允许可插入的</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">框架来扩展身份认证的接口</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">我们编写的</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">只能用于</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">的应用，而对于大量非</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用，却无法提供</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">服务。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">在将</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">应用到</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用的时候，需要对容器上的每一个应用都要做相应的修改，重新部署。而更加流行的做法是</span><span style="font-size:12pt;">Agent</span><span style="font-size:12pt;">机制：为每一个应用服务器安装一个</span><span style="font-size:12pt;">agent</span><span style="font-size:12pt;">，就可以将</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">功能应用到这个应用服务器中的所有应用。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">当前的方案不能支持分别位于不同</span><span style="font-size:12pt;">domain</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用进行</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">。这是因为浏览器在访问</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">服务器的时候，仅仅会带上和当前</span><span style="font-size:12pt;">web</span><span style="font-size:12pt;">服务器具有相同</span><span style="font-size:12pt;">domain</span><span style="font-size:12pt;">名称的那些</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">。要提供跨域的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的解决方案有很多其他的方法，在这里就不多说了。</span><span style="font-size:12pt;">Sun</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Access Manager</span><span style="font-size:12pt;">就具有跨域的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的功能。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">另外，</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">的性能问题也是需要重视的方面。因为</span><span style="font-size:12pt;">Filter</span><span style="font-size:12pt;">会截获每一个符合</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">映射规则的请求，获得</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">，验证其有效性。这一系列任务是比较消耗资源的，特别是验证</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">有效性是一个远程的</span><span style="font-size:12pt;">http</span><span style="font-size:12pt;">的调用，来访问</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的认证服务，有一定的延时。因此在性能上需要做进一步的提高。例如在本样例中，如果将</span><span style="font-size:12pt;">URL</span><span style="font-size:12pt;">映射从“</span><span style="font-size:12pt;">.jsp</span><span style="font-size:12pt;">”</span><span style="font-size:12pt;">改成“</span><span style="font-size:12pt;">/*</span><span style="font-size:12pt;">”</span><span style="font-size:12pt;">，也就是说</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">对所有的请求都起作用，整个应用会变得非常慢。这是因为，页面当中包含了各种静态元素如</span><span style="font-size:12pt;">gif</span><span style="font-size:12pt;">图片，</span><span style="font-size:12pt;">css</span><span style="font-size:12pt;">样式文件，和其他</span><span style="font-size:12pt;">html</span><span style="font-size:12pt;">静态页面，这些页面的访问都要通过</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">去验证。而事实上，这些静态元素没有什么安全上的需求，应该在</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">中进行判断，不去效验这些请求，性能会好很多。另外，如果在</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">中加上一定的</span><span style="font-size:12pt;">cache</span><span style="font-size:12pt;">，而不需要每一个</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">效验请求都去远端的身份认证服务中执行，性能也能大幅度提高。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:disc;"><span style="font-size:12pt;">另外系统还需要很多其他的服务，如在内存中定时删除无用的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">映射等等，都是一个严肃的解决方案需要考虑的问题。</span></li>
</ul>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">6 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">桌面</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">SSO</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">的实现</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">从</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">的概念延伸开，我们可以把</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的技术拓展到整个桌面的应用，不仅仅局限在浏览器。</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的概念和原则都没有改变，只需要再做一点点的工作，就可以完成桌面 </span><span style="font-size:12pt;">SSO </span><span style="font-size:12pt;">的应用。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">一样，关键的技术也在于如何在用户登录过后保存登录的凭据。在</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">中，登录的凭据是靠浏览器的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">机制来完成的；在桌面应用中，可以将登录的凭证保存到任何地方，只要所有</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的桌面应用都共享这个凭证。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">从网站可以下载一个简单的桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的样例</span><span style="font-size:12pt;">(<a href="http://gceclub.sun.com.cn/wangyu/" style="color:#770000;text-decoration:none;">http://gceclub.sun.com.cn/wangyu/desktop-sso/desktopsso.zip)</a></span><span style="font-size:12pt;">和全部源码（</span><span style="font-size:12pt;">http://gceclub.sun.com.cn/wangyu/desktop-sso/desktopsso_src.zip</span><span style="font-size:12pt;">），虽然简单，但是它具有桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">大多数的功能，稍微加以扩充就可以成为自己的解决方案。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><strong><span style="font-size:12pt;">6.1</span></strong><strong><span style="font-size:12pt;">桌面样例的部署</span></strong></div>
<ol style="margin:5px 0px 5px 35px;padding:0px;list-style-type:none;" type="1">
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">运行此桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">需要三个前提条件：</span><span style="font-size:12pt;"><br/>
    a) WEB-SSO</span><span style="font-size:12pt;">的身份认证应用应该正在运行，因为我们在桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">当中需要用到统一的认证服务</span><span style="font-size:12pt;"><br/>
    b) </span><span style="font-size:12pt;">当前桌面需要运行</span><span style="font-size:12pt;">Mozilla</span><span style="font-size:12pt;">或</span><span style="font-size:12pt;">Netscape</span><span style="font-size:12pt;">浏览器，因为我们将</span><span style="font-size:12pt;">ticket</span><span style="font-size:12pt;">保存到</span><span style="font-size:12pt;">mozilla</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">文件中</span><span style="font-size:12pt;"><br/>
    c) </span><span style="font-size:12pt;">必须在</span><span style="font-size:12pt;">JDK1.4</span><span style="font-size:12pt;">以上运行。（</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">需要</span><span style="font-size:12pt;">JDK1.5</span><span style="font-size:12pt;">以上）</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">解开</span><span style="font-size:12pt;">desktopsso.zip</span><span style="font-size:12pt;">文件，里面有两个目录</span><span style="font-size:12pt;">bin</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">lib</span><span style="font-size:12pt;">。</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">bin</span><span style="font-size:12pt;">目录下有一些脚本文件和配置文件，其中</span><span style="font-size:12pt;">config.properties</span><span style="font-size:12pt;">包含了三个需要配置的参数：</span><span style="font-size:12pt;"><br/>
    a) SSOServiceURL</span><span style="font-size:12pt;">要指向</span><span style="font-size:12pt;">WebSSO</span><span style="font-size:12pt;">部署的身份认证的</span><span style="font-size:12pt;">URL<br/>
    b) SSOLoginPage</span><span style="font-size:12pt;">要指向</span><span style="font-size:12pt;">WebSSO</span><span style="font-size:12pt;">部署的身份认证的登录页面</span><span style="font-size:12pt;">URL<br/>
    c) cookiefilepath</span><span style="font-size:12pt;">要指向当前用户的</span><span style="font-size:12pt;">mozilla</span><span style="font-size:12pt;">所存放</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">的文件</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">在</span><span style="font-size:12pt;">bin</span><span style="font-size:12pt;">目录下还有一个</span><span style="font-size:12pt;">login.conf</span><span style="font-size:12pt;">是用来配置</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">登录模块，本样例提供了两个，读者可以任意选择其中一个（也可以都选），再重新运行程序，查看登录认证的变化</span></li>
    <li style="margin:0px;padding:2px 0px;text-align:left;list-style-type:decimal;"><span style="font-size:12pt;">在</span><span style="font-size:12pt;">bin</span><span style="font-size:12pt;">下的运行脚本可能需要作相应的修改</span><span style="font-size:12pt;"><br/>
    a) </span><span style="font-size:12pt;">如果是在</span><span style="font-size:12pt;">unix</span><span style="font-size:12pt;">下，各个</span><span style="font-size:12pt;">jar</span><span style="font-size:12pt;">文件需要用“</span><span style="font-size:12pt;">:</span><span style="font-size:12pt;">”</span><span style="font-size:12pt;">来隔开，而不是“</span><span style="font-size:12pt;">;</span><span style="font-size:12pt;">”</span><span style="font-size:12pt;"><br/>
    b) java </span><span style="font-size:12pt;">运行程序需要放置在当前运行的路径下，否则需要加上</span><span style="font-size:12pt;">java</span><span style="font-size:12pt;">的路径全名。</span></li>
</ol>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><strong><span style="font-size:12pt;">6.2</span></strong><strong><span style="font-size:12pt;">桌面样例的运行</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">样例程序包含三个简单的</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">控制台程序，这三个程序单独运行都需要登录。如果运行第一个命叫“</span><span style="font-size:12pt;">GameSystem</span><span style="font-size:12pt;">”</span><span style="font-size:12pt;">的程序，提示需要输入用户名和密码：</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image020.gif" type="image/gif" data-filename="image020.gif" alt="" height="337" style="border:0px;border-width:0px;" width="554"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">效验成功以后，便会显示当前登录的用户的基本信息等等。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image022.gif" type="image/gif" data-filename="image022.gif" alt="" height="337" style="border:0px;border-width:0px;" width="554"/></span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> <span style="font-size:12pt;">这时候再运行第二个桌面</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">应用（</span><span style="font-size:12pt;">mailSystem</span><span style="font-size:12pt;">）的时候，就不需要再登录了，直接就显示出来刚才登录的用户。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image024.gif" type="image/gif" data-filename="image024.gif" alt="" height="355" style="border:0px;border-width:0px;" width="553"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">第三个应用是</span><span style="font-size:12pt;">logout</span><span style="font-size:12pt;">，运行它之后，用户便退出系统。再访问的时候，又需要重新登录了。请读者再制裁执行完</span><span style="font-size:12pt;">logout</span><span style="font-size:12pt;">之后，重新验证一下前两个应用的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">：先运行第二个应用，再运行第一个，会看到相同的效果。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">我们的样例并没有在这里停步，事实上，本样例不仅能够和在几个</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">应用之间</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，还能和浏览器进行</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，也就是将浏览器也当成是桌面的一部分。这对一些行业有着不小的吸引力。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">这时候再打开</span><span style="font-size:12pt;">Mozilla</span><span style="font-size:12pt;">浏览器，访问以前提到的那两个</span><span style="font-size:12pt;">WEB</span><span style="font-size:12pt;">应用，会发现只要桌面应用如果登录过，</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用就不用再登录了，而且能显示刚才登录的用户的信息。读者可以在几个桌面和</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用之间进行登录和</span><span style="font-size:12pt;">logout</span><span style="font-size:12pt;">的试验，看看它们之间的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;"><img src="java实现简单的单点登录 - J2EE社区 - BlogJava [2]_files/image026.gif" type="image/gif" data-filename="image026.gif" alt="" height="287" style="border:0px;border-width:0px;" width="554"/></span></div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><strong><span style="font-size:12pt;">6.3</span></strong><strong><span style="font-size:12pt;">桌面样例的源码分析</span></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt 36pt;"><span style="font-size:12pt;">桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的样例使用了</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">（要了解</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">的详细的信息请参考</span><span style="font-size:12pt;">http://java.sun.com/products/jaas</span><span style="font-size:12pt;">）。</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">是对</span><span style="font-size:12pt;">PAM</span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">Pluggable Authentication Module</span><span style="font-size:12pt;">）的</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">实现，来完成 </span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">应用可插拔的安全认证模块。使用</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">作为</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">应用的安全认证模块有很多好处，最主要的是不需要修改源代码就可以更换认证方式。例如原有的</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">应用如果使用</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">的认证，如果需要应用</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">，只需要修改</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">的配置文件就行了。现在在流行的</span><span style="font-size:12pt;">J2EE</span><span style="font-size:12pt;">和其他 </span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">的产品中，用户的身份认证都是通过</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">来完成的。在样例中，我们就展示了这个功能。请看配置文件</span><span style="font-size:12pt;">login.conf</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">DesktopSSO {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">desktopsso.share.PasswordLoginModule required;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">desktopsso.share.DesktopSSOLoginModule required;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">};</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">当我们注解掉第二个模块的时候，只有第一个模块起作用。在这个模块的作用下，只有</span><span style="font-size:12pt;">test</span><span style="font-size:12pt;">用户（密码是</span><span style="font-size:12pt;">12345</span><span style="font-size:12pt;">）才能登录。当我们注解掉第一个模块的时候，只有第二个模块起作用，桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">才会起作用。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left"><span style="font-size:12pt;">所有的</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">桌面样例程序都是标准</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">应用，熟悉</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">的程序员会很快了解。</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">中主要的是登录模块（</span><span style="font-size:12pt;">LoginModule</span><span style="font-size:12pt;">）。下面是</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">登录模块的源码：</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span><span style="font-size:12pt;">public class DesktopSSOLoginModule implements LoginModule {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">..........</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">private String SSOServiceURL = &quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">private String SSOLoginPage = &quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">private static String cookiefilepath = &quot;&quot;;  </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">.........</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left"> </div>
<div align="left"><span style="font-size:12pt;">在</span><span style="font-size:12pt;">config.properties</span><span style="font-size:12pt;">的文件中，我们配置了它们的值：</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:10pt;">SSOServiceURL=http://wangyu.prc.sun.com:8080/SSOAuth/SSOAuth</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:10pt;">SSOLoginPage=http://wangyu.prc.sun.com:8080/SSOAuth/login.jsp</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">cookiefilepath=C:\\Documents and Settings\\yw137672\\Application Data\\Mozilla\\Profiles\\default\\hog6z1ji.slt\\cookies.txt</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">SSOServiceURL</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">SSOLoginPage</span><span style="font-size:12pt;">成员变量指向了在</span><span style="font-size:12pt;">Web-SSO</span><span style="font-size:12pt;">中用过的身份认证模块：</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">，这就说明在桌面系统中我们试图和</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用共用一个认证服务。而</span><span style="font-size:12pt;">cookiefilepath</span><span style="font-size:12pt;">成员变量则泄露了一个“天机”：我们使用了</span><span style="font-size:12pt;">Mozilla</span><span style="font-size:12pt;">浏览器的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">文件来保存登录的凭证。换句话说，和</span><span style="font-size:12pt;">Mozilla</span><span style="font-size:12pt;">共用了一个保存登录凭证的机制。之所以用</span><span style="font-size:12pt;">Mozilla</span><span style="font-size:12pt;">是应为它的</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">文件格式简单，很容易编程访问和修改任意的</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">值。（我试图解析</span><span style="font-size:12pt;">Internet Explorer</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">文件但没有成功。）</span></div>
<div align="left"><span style="font-size:12pt;">下面是登录模块DesktopSSOLoginModule的主体：</span><span style="font-size:12pt;">login()</span><span style="font-size:12pt;">方法。逻辑也是非常简单：先用</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">来登陆，如果成功，则直接就进入系统，否则需要用户输入用户名和密码来登录系统。</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">public boolean login() throws LoginException{</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">if (Cookielogin()) return true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} catch (IOException ex) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">ex.printStackTrace();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">if (passwordlogin()) return true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">throw new FailedLoginException();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left"><span style="font-size:12pt;">下面是Cookielogin()</span><span style="font-size:12pt;">方法的实体，它的逻辑是：</span><span style="font-size:12pt;">先从</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">文件中获得相应的</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">值，通过身份效验服务效验</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">的有效性。如果</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">有效</span><span style="font-size:12pt;">就算登录成功；如果不成功或</span><span style="font-size:12pt;">Cookie</span><span style="font-size:12pt;">不存在，用</span><span style="font-size:12pt;">cookie</span><span style="font-size:12pt;">登录就算失败。</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">public boolean Cookielogin() throws LoginException,IOException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">String cookieValue=&quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">int cookieIndex =foundCookie();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">if (cookieIndex&lt;0)</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">return false;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">else</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">cookieValue = getCookieValue(cookieIndex);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">     </span><span style="font-size:12pt;">username = cookieAuth(cookieValue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">     </span><span style="font-size:12pt;">if (! username.equals(&quot;failed&quot;)) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">         </span><span style="font-size:12pt;">loginSuccess = true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">         </span><span style="font-size:12pt;">return true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">     </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">     </span><span style="font-size:12pt;">return false;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left"><span style="font-size:12pt;">用用户名和密码登录的方法要复杂一些，通过</span><span style="font-size:12pt;">Callback</span><span style="font-size:12pt;">的机制和屏幕输入输出进行信息交互，完成用户登录信息的获取；获取信息以后通过</span><span style="font-size:12pt;">userAuth</span><span style="font-size:12pt;">方法来调用远端</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">的服务来判定当前登录的有效性。</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span><span style="font-size:12pt;">public boolean passwordlogin() throws LoginException {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">//</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">// Since we need input from a user, we need a callback handler</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">if (callbackHandler == null) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">       </span><span style="font-size:12pt;">throw new LoginException(&quot;No CallbackHandler defined&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">Callback[] callbacks = new Callback[2];</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">callbacks[0] = new NameCallback(&quot;Username&quot;);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">callbacks[1] = new PasswordCallback(&quot;Password&quot;, false);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">//</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">// Call the callback handler to get the username and password</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">callbackHandler.handle(callbacks);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">username = ((NameCallback)callbacks[0]).getName();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">char[] temp = ((PasswordCallback)callbacks[1]).getPassword();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">password = new char[temp.length];</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">System.arraycopy(temp, 0, password, 0, temp.length);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">((PasswordCallback)callbacks[1]).clearPassword();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">} catch (IOException ioe) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">throw new LoginException(ioe.toString());</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">} catch (UnsupportedCallbackException uce) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">      </span><span style="font-size:12pt;">throw new LoginException(uce.toString());</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">System.out.println();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">String authresult =&quot;&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">authresult = userAuth(username, password);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">} catch (IOException ex) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">ex.printStackTrace();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">if (! authresult.equals(&quot;failed&quot;)) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">loginSuccess= true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">clearPassword();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">updateCookie(authresult);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} catch (IOException ex) {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">ex.printStackTrace();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">return true;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">  </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">loginSuccess = false;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">username = null;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">clearPassword();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">System.out.println( &quot;Login: PasswordLoginModule FAIL&quot; );</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">throw new FailedLoginException();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;"> </span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left"><span style="font-size:12pt;">CookieAuth</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">userAuth</span><span style="font-size:12pt;">方法都是利用</span><span style="font-size:12pt;">apahce</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">httpclient</span><span style="font-size:12pt;">工具包和远程的</span><span style="font-size:12pt;">SSOAuth</span><span style="font-size:12pt;">进行</span><span style="font-size:12pt;">http</span><span style="font-size:12pt;">连接，获取服务。</span></div>
<table border="1" cellpadding="0" cellspacing="0" style="width:100%;" width="100%">
    <tbody>
        <tr>
            <td style="font-size:12px;padding:3.75pt;background-color:#eeeeee;width:100%;" width="100%">
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">private String cookieAuth(String cookievalue) throws IOException{</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String result = &quot;failed&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">       </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpClient httpclient = new HttpClient();      </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">GetMethod httpget = new GetMethod(SSOServiceURL+Action1+cookievalue);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpclient.executeMethod(httpget);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">result = httpget.getResponseBodyAsString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} finally {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpget.releaseConnection();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">return result;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"> </div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">private String userAuth(String username, char[] password) throws IOException{</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String result = &quot;failed&quot;;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">String passwd= new String(password);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">HttpClient httpclient = new HttpClient();      </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">GetMethod httpget = new GetMethod(SSOServiceURL+Action2+username+&quot;&amp;password=&quot;+passwd);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">passwd = null;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">   </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">try {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpclient.executeMethod(httpget);</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">result = httpget.getResponseBodyAsString();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">} finally {</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">            </span><span style="font-size:12pt;">httpget.releaseConnection();</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">}</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">        </span><span style="font-size:12pt;">return result;</span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">       </span></div>
            <div align="left" style="text-align:left;"><span style="font-size:12pt;">    </span><span style="font-size:12pt;">}</span></div>
            </td>
        </tr>
    </tbody>
</table>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">还有一个地方需要补充说明的是，在本样例中，用户名和密码的输入都会在屏幕上显示明文。如果希望用掩码形式来显示密码，以提高安全性，请参考：</span><span style="font-size:12pt;">http://java.sun.com/developer/technicalArticles/Security/pwordmask/</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">7 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">真正安全的全方位</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">SSO</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">解决方案：</span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">Kerberos</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">我们的样例程序（桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">WEB-SSO</span><span style="font-size:12pt;">）都有一个共性：要想将一个应用集成到我们的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">解决方案中，或多或少的需要修改应用程序。</span><span style="font-size:12pt;">Web</span><span style="font-size:12pt;">应用需要配置一个我们预制的</span><span style="font-size:12pt;">filter</span><span style="font-size:12pt;">；桌面应用需要加上我们桌面</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">模块（至少要修改</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">的配置文件）。可是有很多程序是没有源代码和无法修改的，例如常用的远程通讯程序</span><span style="font-size:12pt;">telnet</span><span style="font-size:12pt;">和</span><span style="font-size:12pt;">ftp</span><span style="font-size:12pt;">等等一些操作系统自己带的常用的应用程序。这些程序是很难修改加入到我们的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的解决方案中。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">事实上有一种全方位的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">解决方案能够解决这些问题，这就是</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">协议（</span><span style="font-size:12pt;">RFC 1510</span><span style="font-size:12pt;">）。</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">是网络安全应用标准</span><span style="font-size:12pt;">(<a href="http://web.mit.edu/kerberos/" style="color:#770000;text-decoration:none;">http://web.mit.edu/kerberos/</a>)</span><span style="font-size:12pt;">，由</span><span style="font-size:12pt;">MIT</span><span style="font-size:12pt;">学校发明，被主流的操作系统所采用。在采用</span><span style="font-size:12pt;">kerberos</span><span style="font-size:12pt;">的平台中，登录和认证是由操作系统本身来维护，认证的凭证也由操作系统来保存，这样整个桌面都可以处于同一个</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的系统保护中。操作系统中的各个应用（如</span><span style="font-size:12pt;">ftp,telnet</span><span style="font-size:12pt;">）只需要通过配置就能加入到</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">中。另外使用</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">最大的好处在于它的安全性。通过密钥算法的保证和密钥中心的建立，可以做到用户的密码根本不需要在网络中传输，而传输的信息也会十分的安全。</span></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">目前支持</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">的操作系统包括</span><span style="font-size:12pt;">Solaris, windows,Linux</span><span style="font-size:12pt;">等等主流的平台。只不过要搭建一个</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">的环境比较复杂，</span><span style="font-size:12pt;">KDC</span><span style="font-size:12pt;">（密钥分发中心）的建立也需要相当的步骤。</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">拥有非常成熟的</span><span style="font-size:12pt;">API</span><span style="font-size:12pt;">，包括</span><span style="font-size:12pt;">Java</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">API</span><span style="font-size:12pt;">。使用</span><span style="font-size:12pt;">Java Generic Security Services(GSS) API</span><span style="font-size:12pt;">并且使用</span><span style="font-size:12pt;">JAAS</span><span style="font-size:12pt;">中对</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">的支持（详细信息请参见</span><span style="font-size:12pt;">Sun</span><span style="font-size:12pt;">的</span><span style="font-size:12pt;">Java&amp;Kerberos</span><span style="font-size:12pt;">教程</span><span style="font-size:12pt;">http://java.sun.com/ j2se/1.5.0/docs/guide/security/jgss/tutorials/index.html</span><span style="font-size:12pt;">），要将我们这个样例改造成对</span><span style="font-size:12pt;">Kerberos</span><span style="font-size:12pt;">的支持也是不难的。 值得一提的是在</span><span style="font-size:12pt;">JDK6.0 </span><span style="font-size:12pt;">（</span><span style="font-size:12pt;">http://www.java.net/download/jdk6</span><span style="font-size:12pt;">）当中直接就包含了对</span><span style="font-size:12pt;">GSS</span><span style="font-size:12pt;">的支持，不需要单独下载</span><span style="font-size:12pt;">GSS</span><span style="font-size:12pt;">的包。</span></div>
<div align="left" style="margin:0cm 0cm 12pt;"> </div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><strong><em style="font-style:italic;"><span style="font-size:14pt;">8 </span></em></strong><strong><em style="font-style:italic;"><span style="font-size:14pt;">总结</span></em></strong></div>
<div align="left" style="margin:0cm 0cm 5.95pt;"><span style="font-size:12pt;">本文的主要目的是阐述</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的基本原理，并提供了一种实现的方式。通过对源代码的分析来掌握开发</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">服务的技术要点和充分理解</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的应用范围。但是，本文仅仅说明了身份认证的服务，而另外一个和身份认证密不可分的服务</span><span style="font-size:12pt;">----</span><span style="font-size:12pt;">权限效验，却没有提到。要开发出真正的</span><span style="font-size:12pt;">SSO</span><span style="font-size:12pt;">的产品，在功能上、性能上和安全上都必须有更加完备的考虑。</span></div>
</span>
<br/><br/><hr/>

<p align="left" style="margin:0px 0px 14px;"><font color="#71685f" size="2">名称:</font> <font color="#ffcc00" size="2">♪4C.ESL | .↗Evon</font> <br/><font color="#71685f" size="2">口号:</font> <font color="#ffcc00" size="2"><font size="3"><span style="font-size:8pt;"><font color="#ffcc00" size="2"><font size="2">遇到新问题♪先要寻找一个方案乄而不是创造一个方案こ</font></font><br/></span></font></font><font color="#ffcc00" size="2"><font color="#71685f" size="2">mail:</font> <a href="http://www.blogjava.net/xcp/archive/2010/04/13/318125.htmlmailto:414906270@qq.com" style="text-decoration:none;color:rgb(29, 88, 209);">联系我</a></font> </p>
<hr/></div>
	</div></div></td></tr></tbody></table></div></div></div></div><br/></div></span>
</div></body></html> 