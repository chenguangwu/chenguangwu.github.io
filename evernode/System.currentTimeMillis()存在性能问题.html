<html>
<head>
  <title>System.currentTimeMillis()存在性能问题</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="13056"/>
<h1>System.currentTimeMillis()存在性能问题</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/10/30 15:03</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2019/10/30 15:07</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.toutiao.com/a6731991358308876804/?tt_from=weixin&utm_campaign=client_share&wxshare_count=1&timestamp=1572408028&app=news_article&utm_source=weixin&utm_medium=toutiao_ios&req_id=20191030120027010026076085330BC2E7&group_id=6731991358308876804"><i>https://www.toutiao.com/a6731991358308876804/?tt_from=weixin&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;timestamp=1572408028&amp;app=news_article&amp;utm_source=weixin&amp;utm_medium=toutiao_ios&amp;req_id=20191030120027010026076085330BC2E7&amp;group_id=6731991358308876804</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="line-height:1.15;text-size-adjust:100%;-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size:12px;line-height:1.5;color:rgb(101, 113, 128);background-color:rgb(255, 255, 255);-webkit-font-smoothing:antialiased;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;zoom:1;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"><h1 style="font-size:34px;margin:0px;-webkit-tap-highlight-color:transparent;box-sizing:border-box;padding:0px;font-weight:700;line-height:44px;color:rgb(34, 34, 34);">不敢相信？System.currentTimeMillis()存在性能问题</h1> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;margin-top:12px;margin-bottom:20px;font-size:13px;"> <span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(119, 119, 119);margin-right:2px;">java互联网架构</span> <span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(119, 119, 119);margin-right:2px;">2019-09-02 16:44:41</span></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;margin-bottom:24px;font-size:16px;line-height:28px;color:rgb(34, 34, 34);overflow-wrap:break-word;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;font-size:16px;line-height:28px;color:rgb(34, 34, 34);overflow-wrap:break-word;"><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">System.currentTimeMillis()是极其常用的基础Java API，广泛地用来获取时间戳或测量代码执行时长等，在我们的印象中应该快如闪电。但实际上在并发调用或者特别频繁调用它的情况下（比如一个业务繁忙的接口，或者吞吐量大的需要取得时间戳的流式程序），其性能表现会令人大跌眼镜。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">直接看代码</p><pre style="font-family:Consolas, Menlo, Courier, monospace;font-size:16px;-webkit-tap-highlight-color:transparent;box-sizing:border-box;white-space:pre-wrap;position:relative;line-height:1.5;color:rgb(153, 153, 153);margin:1em 0px;padding:12px 10px;background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);">public class CurrentTimeMillisPerfDemo {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private static final int COUNT = 100;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> public static void main(String[] args) throws Exception {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> long beginTime = System.nanoTime();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> for (int i = 0; i &lt; COUNT; i++) {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> System.currentTimeMillis();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> long elapsedTime = System.nanoTime() - beginTime;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> System.out.println(&quot;100 System.currentTimeMillis() serial calls: &quot; + elapsedTime + &quot; ns&quot;);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> CountDownLatch startLatch = new CountDownLatch(1);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> CountDownLatch endLatch = new CountDownLatch(COUNT);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> for (int i = 0; i &lt; COUNT; i++) {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> new Thread(() -&gt; { <br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> try {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> startLatch.await();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> System.currentTimeMillis();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> } catch (InterruptedException e) {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> e.printStackTrace();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> } finally {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> endLatch.countDown();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }).start();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> beginTime = System.nanoTime();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> startLatch.countDown();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> endLatch.await();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> elapsedTime =System.nanoTime() - beginTime;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> System.out.println(&quot;100 System.currentTimeMillis() parallel calls: &quot; +elapsedTime + &quot; ns&quot;);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>}<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/></pre><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">执行结果如下图。</p><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;"><img src="System.currentTimeMillis()存在性能问题_files/219728335de74b919eeb44ee85dba399.jpg" type="image/jpeg" data-filename="219728335de74b919eeb44ee85dba399.jpg" alt="不敢相信？System.currentTimeMillis()存在性能问题" height="165" style="border-style:none;-webkit-tap-highlight-color:transparent;box-sizing:border-box;max-width:100%;display:block;margin:10px auto;" width="640"/><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;text-align:center;font-size:12px;color:rgb(119, 119, 119);line-height:16px;margin-top:0px;"></p></div><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">可见，并发调用System.currentTimeMillis()一百次，耗费的时间是单线程调用一百次的250倍。如果单线程的调用频次增加（比如达到每毫秒数次的地步），也会观察到类似的情况。实际上在极端情况下，System.currentTimeMillis()的耗时甚至会比创建一个简单的对象实例还要多，看官可以自行将上面线程中的语句换成new HashMap&lt;&gt;之类的试试看。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;"><strong style="font-weight:700;-webkit-tap-highlight-color:transparent;box-sizing:border-box;">为什么会这样？</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">来到HotSpot源码的hotspot/src/os/linux/vm/os_linux.cpp文件中，有一个javaTimeMillis()方法，这就是System.currentTimeMillis()的native实现。</p><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;"><img src="System.currentTimeMillis()存在性能问题_files/f096a65aeb9d4db8b5e99ca26a99a6b5.jpg" type="image/jpeg" data-filename="f096a65aeb9d4db8b5e99ca26a99a6b5.jpg" alt="不敢相信？System.currentTimeMillis()存在性能问题" height="136" style="border-style:none;-webkit-tap-highlight-color:transparent;box-sizing:border-box;max-width:100%;display:block;margin:10px auto;" width="589"/><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;text-align:center;font-size:12px;color:rgb(119, 119, 119);line-height:16px;margin-top:0px;"></p></div><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">挖源码就到此为止，因为已经有国外大佬深入到了汇编的级别来探究，详情可以参见《The Slow currentTimeMillis()》这篇文章。简单来讲就是：</p><ul style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:20px 30px;list-style:square outside;color:rgb(34, 34, 34);"><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;list-style:inherit;">调用gettimeofday()需要从用户态切换到内核态；</li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;list-style:inherit;">gettimeofday()的表现受Linux系统的计时器（时钟源）影响，在HPET计时器下性能尤其差；</li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;list-style:inherit;">系统只有一个全局时钟源，高并发或频繁访问会造成严重的争用。</li></ul><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">HPET计时器性能较差的原因是会将所有对时间戳的请求串行执行。TSC计时器性能较好，因为有专用的寄存器来保存时间戳。缺点是可能不稳定，因为它是纯硬件的计时器，频率可变（与处理器的CLK信号有关）。关于HPET和TSC的细节可以参见https://en.wikipedia.org/wiki/HighPrecisionEventTimer与https://en.wikipedia.org/wiki/TimeStamp_Counter。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">另外，可以用以下的命令查看和修改时钟源。</p><pre style="font-family:Consolas, Menlo, Courier, monospace;font-size:16px;-webkit-tap-highlight-color:transparent;box-sizing:border-box;white-space:pre-wrap;position:relative;line-height:1.5;color:rgb(153, 153, 153);margin:1em 0px;padding:12px 10px;background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);">~ cat /sys/devices/system/clocksource/clocksource0/available_clocksource<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>tsc hpet acpi_pm<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>~ cat /sys/devices/system/clocksource/clocksource0/current_clocksource<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>tsc<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>~ echo 'hpet' &gt; /sys/devices/system/clocksource/clocksource0/current_clocksource<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/></pre><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;"><strong style="font-weight:700;-webkit-tap-highlight-color:transparent;box-sizing:border-box;">如何解决这个问题？</strong></p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">最常见的办法是用单个调度线程来按毫秒更新时间戳，相当于维护一个全局缓存。其他线程取时间戳时相当于从内存取，不会再造成时钟资源的争用，代价就是牺牲了一些精确度。具体代码如下。</p><pre style="font-family:Consolas, Menlo, Courier, monospace;font-size:16px;-webkit-tap-highlight-color:transparent;box-sizing:border-box;white-space:pre-wrap;position:relative;line-height:1.5;color:rgb(153, 153, 153);margin:1em 0px;padding:12px 10px;background:rgb(244, 245, 246);border:1px solid rgb(232, 232, 232);">public class CurrentTimeMillisClock {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private volatile long now;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private CurrentTimeMillisClock() {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> this.now = System.currentTimeMillis();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> scheduleTick();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private void scheduleTick() {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> new ScheduledThreadPoolExecutor(1, runnable -&gt; {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> Thread thread = new Thread(runnable, &quot;current-time-millis&quot;);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> thread.setDaemon(true);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> return thread;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }).scheduleAtFixedRate(() -&gt; {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> now = System.currentTimeMillis();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }, 1, 1, TimeUnit.MILLISECONDS);<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> public long now() {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> return now;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> public static CurrentTimeMillisClock getInstance() {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> return SingletonHolder.INSTANCE;<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private static class SingletonHolder {<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> private static final CurrentTimeMillisClock INSTANCE = new <br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>CurrentTimeMillisClock();<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/> }<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/>}<br style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;"/></pre><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">使用的时候，直接 CurrentTimeMillisClock.getInstance().now()就可以了。</p><p style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:16px 0px;padding:0px;">不过，在System.currentTimeMillis()的效率没有影响程序整体的效率时，就完全没有必要做这种优化，这只是为极端情况准备的。</p></div></div>  <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:block;zoom:1;margin-bottom:28px;"><span style="display:table;"></span><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;float:left;"><i style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-size:21px;display:inline-block;line-height:1;speak:none;font-weight:400;font-variant:normal;text-transform:none;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:tticons;vertical-align:middle;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;font-variant:normal;text-transform:none;font-family:tticons;"></span></i> <ul style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;list-style:none;display:inline-block;vertical-align:middle;"><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);"></span><a href="https://www.toutiao.com/search/?keyword=Linux" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(64, 101, 153);background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease 0s;" target="_blank">Linux</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(64, 101, 153);background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease 0s;" target="_blank">操作系统</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=Java" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(64, 101, 153);background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease 0s;" target="_blank">Java</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=%E8%99%9A%E6%8B%9F%E6%9C%BA" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(64, 101, 153);background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease 0s;" target="_blank">虚拟机</a></li><li style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-right:8px;font-size:14px;"><span style="font-size:14px;padding-right:10px;color:rgb(224, 224, 224);">/</span><a href="https://www.toutiao.com/search/?keyword=%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80" style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(64, 101, 153);background:0px 0px;text-decoration:none;outline:0px;cursor:pointer;transition:color 0.2s ease 0s;" target="_blank">汇编语言</a></li></ul></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;float:right;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;cursor:pointer;line-height:18px;"><i style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-size:18px;display:inline-block;line-height:1;speak:none;font-weight:400;font-variant:normal;text-transform:none;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:tticons;vertical-align:middle;width:18px;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;font-variant:normal;text-transform:none;font-family:tticons;"></span></i><span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(153, 153, 153);font-size:14px;padding-left:7px;vertical-align:middle;">收藏</span></div> <div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;margin-left:10px;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;margin:0px;padding:0px;display:inline-block;cursor:pointer;line-height:18px;"><i style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;font-style:normal;font-size:14px;display:inline-block;line-height:1;speak:none;font-weight:400;font-variant:normal;text-transform:none;text-rendering:auto;-webkit-font-smoothing:antialiased;font-family:tticons;vertical-align:middle;width:14px;margin-right:7px;color:rgb(202, 202, 202);"><span style="font-style:normal;font-size:12px;line-height:1;font-weight:400;font-variant:normal;text-transform:none;font-family:tticons;"></span></i><span style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;color:rgb(153, 153, 153);font-size:14px;vertical-align:middle;">举报</span></div> </div></div><span style="display:block;visibility:hidden;font-size:0px;height:0px;clear:both;"></span></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 