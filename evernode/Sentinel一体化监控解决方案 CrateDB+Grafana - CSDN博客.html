<html>
<head>
  <title>Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="4321"/>
<h1>Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/9/7 9:44</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://blog.csdn.net/huyong1990/article/details/82392386"><i>https://blog.csdn.net/huyong1990/article/details/82392386</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="outline:0px;box-sizing:border-box;"><div style="box-sizing:inherit;outline:0px;font-family:&quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;line-height:1.57143;background-color:rgb(245, 246, 247);color:rgb(51, 51, 51);"><div style="outline:0px;box-sizing:border-box;"><span style="box-sizing:inherit;outline:0px;"><div style="box-sizing:inherit;outline:0px;background:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 2px 4px 0px;"><div style="box-sizing:inherit;outline:0px;"><div style="box-sizing:inherit;outline:0px;word-break:break-all;"><div style="box-sizing:inherit;outline:0px;font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun;word-break:break-all;">
                <p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;"></p><div style="outline:0px;box-sizing:border-box;word-break:break-all;padding:0px;margin:0px 0px 24px;font-size:16px;line-height:24px;"><div style="outline:0px;box-sizing:border-box;word-break:break-all;padding:0px;margin:0px 0px 24px;font-size:16px;line-height:24px;">
<ul style="outline:0px;list-style:none;box-sizing:border-box;word-break:break-all;padding:0px;margin:0px 0px 8px;">
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#sentinel%E4%B8%80%E4%BD%93%E5%8C%96%E7%9B%91%E6%8E%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">Sentinel一体化监控解决方案</a><ul style="outline:0px;list-style:none;box-sizing:border-box;word-break:break-all;padding:0px;margin:0px 0px 8px;">
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#sentinel%E6%98%AF%E4%BB%80%E4%B9%88" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">Sentinel是什么？</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">使用过程中遇到的问题</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E7%9A%84%E5%8A%9E%E6%B3%95" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">解决问题的办法</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">动手实践</a><ul style="outline:0px;list-style:none;box-sizing:border-box;word-break:break-all;padding:0px;margin:0px 0px 8px;">
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E7%AC%AC%E4%B8%80%E6%AD%A5%E6%96%B0%E5%BB%BA%E8%A1%A8" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">第一步：新建表</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">第二步：持久化数据</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E7%AC%AC%E4%B8%89%E6%AD%A5%E5%9C%A8grafana%E4%B8%8A%E5%88%B6%E5%9B%BE" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">第三步：在Grafana上制图</a></li>
</ul>
</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E9%81%97%E7%95%99%E9%97%AE%E9%A2%98" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">遗留问题</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E6%94%B9%E8%BF%9B%E7%82%B9" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">改进点</a></li>
<li style="outline:0px;padding:0px;box-sizing:border-box;word-break:break-all;margin:8px 0px 0px 24px;list-style-type:none;"><a href="https://blog.csdn.net/huyong1990/article/details/82392386#%E6%9C%80%E5%90%8E" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_self">最后</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;"></p>



<h1 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:28px;color:rgb(79, 79, 79);font-weight:700;line-height:36px;word-break:break-all;"><a name="t0" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>Sentinel一体化监控解决方案</h1>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t1" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>Sentinel是什么？</h2>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;"><a href="https://github.com/alibaba/Sentinel" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_blank">Sentinel</a>是阿里巴巴在今年7月下旬开源的限流组件，该组件能依照<strong style="outline:0px;box-sizing:border-box;font-weight:700;word-break:break-all;">动态配置</strong>的规则对服务进行限流熔断和降级操作。sentinel-dashboard作为该组件的核心控制台目前具有实时监控、规则配置、应用服务器列表查看等功能。</p>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t2" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>使用过程中遇到的问题</h2>

<ul style="outline:0px;list-style:none;box-sizing:border-box;padding:0px;margin:0px 0px 24px;word-break:break-all;">
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">dashboard实时监控仅能查看5分钟内的metric数据</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">图表显示有那么一点点问题</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">监控数据分散，无法和公司其他监控数据统一</li>
</ul>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t3" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>解决问题的办法</h2>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">以上提出的3个问题，处理的办法无非就是<strong style="outline:0px;box-sizing:border-box;font-weight:700;word-break:break-all;">数据落地</strong>和<strong style="outline:0px;box-sizing:border-box;font-weight:700;word-break:break-all;">统一监控</strong>。 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
思路：首先我们要将之前缓存在内存中的metric数据进行持久化, 然后在<a href="https://grafana.com/" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_blank">Grafana</a>上绑定数据源，制作对应的监控图表。 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
使用到的工具</p>

<table style="outline:0px;font-size:inherit;font-style:inherit;font-variant:inherit;font-weight:inherit;border-spacing:0px;box-sizing:border-box;border-collapse:collapse;display:table;width:100%;text-align:center;margin-bottom:24px;word-break:break-all;">
<thead style="outline:0px;box-sizing:border-box;word-break:break-all;">
<tr style="border-right-color:initial;background-color:rgb(255, 255, 255);outline:0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;box-sizing:border-box;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);word-break:break-all;">
  <th style="font-size:14px;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:700;text-align:left;box-sizing:border-box;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;background-color:rgb(239, 243, 245);">工具名称</th>
  <th style="font-size:14px;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:700;text-align:left;box-sizing:border-box;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;background-color:rgb(239, 243, 245);">作用</th>
</tr>
</thead>
<tbody style="outline:0px;box-sizing:border-box;border:0px;word-break:break-all;"><tr style="border-right-color:initial;background-color:rgb(255, 255, 255);outline:0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;box-sizing:border-box;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);word-break:break-all;">
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">CrateDB</td>
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">NO SQL数据库</td>
</tr>
<tr style="border-right-color:initial;word-break:break-all;outline:0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;box-sizing:border-box;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);">
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">Druid</td>
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">数据库连接池</td>
</tr>
<tr style="border-right-color:initial;background-color:rgb(255, 255, 255);outline:0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;box-sizing:border-box;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);word-break:break-all;">
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">Grafana</td>
  <td style="text-align:left;word-break:normal;outline:0px;padding:8px;margin:0px;font-weight:normal;box-sizing:border-box;font-size:14px;color:rgb(79, 79, 79);line-height:22px;border:1px solid rgb(221, 221, 221);word-wrap:break-word;vertical-align:middle;">监控数据UI展示</td>
</tr>
</tbody></table>




<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t4" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>动手实践</h2>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">接下来我会一步步介绍如何将metric数据进行持久化并在Grafana上进行展示</p>



<h3 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:22px;color:rgb(79, 79, 79);font-weight:700;line-height:30px;word-break:break-all;"><a name="t5" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>第一步：新建表</h3>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">新建<code style="outline:0px;box-sizing:border-box;font-family:Consolas, Inconsolata, Courier, monospace;font-size:14px;line-height:22px;color:rgb(199, 37, 78);background-color:rgb(249, 242, 244);border-radius:2px;padding:4px 2px 0px;word-break:break-all;">metric</code>分区表，为什么建分区表而不是普通表？因为监控数据体量很大，而且很多天以前的数据没用了就要删掉，如果不建分区表，删除数据的时候想死的心都有。</p>



<pre style="margin:0px 0px 24px;word-break:break-all;overflow-y:hidden;overflow-x:auto;box-sizing:border-box;outline:0px;color:rgb(0, 0, 0);position:relative;font-family:Consolas, Inconsolata, Courier, monospace;font-size:14px;line-height:22px;padding:8px 16px 4px 56px;background-color:rgb(246, 248, 250);border:none;"><code style="font-size:14px;word-wrap:normal;outline:0px;display:block;padding:0px;color:rgb(0, 0, 0);font-family:Consolas, Inconsolata, Courier, monospace;box-sizing:border-box;line-height:22px;background-color:rgb(246, 248, 250);border-radius:4px;overflow-x:auto;white-space:pre;word-break:break-all;"><span style="outline:0px;box-sizing:border-box;word-break:break-all;"><span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">CREATE</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">TABLE</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">IF</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">NOT</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">EXISTS</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;doc&quot;</span>.<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;metric&quot;</span> ( 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;app&quot;</span> STRING, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;blocked_qps&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;count&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;day&quot;</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">TIMESTAMP</span> GENERATED ALWAYS <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">AS</span> date_trunc(<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">'day'</span>, <span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">'+08:00'</span>, <span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;timestamp&quot;</span>), 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;exception&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;gmt_create&quot;</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">TIMESTAMP</span>, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;gmt_modified&quot;</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">TIMESTAMP</span>, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;id&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;passed_qps&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;resource&quot;</span> STRING, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;resource_code&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;rt&quot;</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">DOUBLE</span>, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;success_qps&quot;</span> LONG, 
<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;timestamp&quot;</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">TIMESTAMP</span> 
) 
CLUSTERED <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">INTO</span> <span style="outline:0px;box-sizing:border-box;color:rgb(0, 102, 102);word-break:break-all;">6</span> SHARDS 
PARTITIONED <span style="outline:0px;box-sizing:border-box;color:rgb(0, 0, 136);word-break:break-all;">BY</span> (<span style="outline:0px;box-sizing:border-box;color:rgb(0, 153, 0);word-break:break-all;">&quot;day&quot;</span>)</span></code><ul style="position:absolute;word-break:break-all;outline:0px;box-sizing:border-box;margin:0px;list-style:none;padding:8px 0px;width:48px;background-color:rgb(238, 240, 244);top:0px;left:0px;text-align:right;"><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">1</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">2</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">3</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">4</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">5</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">6</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">7</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">8</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">9</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">10</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">11</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">12</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">13</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">14</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">15</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">16</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">17</li><li style="outline:0px;box-sizing:border-box;list-style-type:disc;word-break:break-all;padding:0px 8px;margin:0px;list-style:none;color:rgb(153, 153, 153);">18</li></ul></pre>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">表建好以后在CrateDB Admin上看到的大概就是这样的 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70.png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="435" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/></p>



<h3 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:22px;color:rgb(79, 79, 79);font-weight:700;line-height:30px;word-break:break-all;"><a name="t6" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>第二步：持久化数据</h3>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">在我自己的<a href="https://github.com/YoungHu/Sentinel/tree/metric_presistent" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_blank">GitHub</a>分支上，已经完成了数据持久化的代码。当时这个代码是基于mysql实现的，修改成CrateDB实现也是非常简单的，只需要做好如下几点： <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
1. 将mysql的JDBC驱动包换成CrateDB的JDBC驱动包，具体操作包下载地址请见<a href="https://crate.io/docs/clients/jdbc/en/latest/index.html" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_blank">CrateDB官网</a> <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
2. 将mysql的驱动类改为CrateDB的驱动类 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
3. 将mysql的url地址改为你CrateDB的地址 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
4. 去掉<code style="outline:0px;box-sizing:border-box;font-family:Consolas, Inconsolata, Courier, monospace;font-size:14px;line-height:22px;color:rgb(199, 37, 78);background-color:rgb(249, 242, 244);border-radius:2px;padding:4px 2px 0px;word-break:break-all;">MetricRepository.xml</code>文件中的<code style="outline:0px;box-sizing:border-box;font-family:Consolas, Inconsolata, Courier, monospace;font-size:14px;line-height:22px;color:rgb(199, 37, 78);background-color:rgb(249, 242, 244);border-radius:2px;padding:4px 2px 0px;word-break:break-all;">useGeneratedKeys=&quot;true&quot; keyProperty=&quot;id&quot;</code>因为CrateDB不支持自增主键</p>



<h3 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:22px;color:rgb(79, 79, 79);font-weight:700;line-height:30px;word-break:break-all;"><a name="t7" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>第三步：在Grafana上制图</h3>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">这里不会详细讲Grafana如何制作图表，新手请见官网<a href="http://docs.grafana.org/guides/getting_started/" rel="nofollow" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;" target="_blank">快速入门</a>。</p>

<blockquote style="outline:0px;box-sizing:border-box;padding:16px;margin:0px 0px 24px;display:block;border-left:8px solid rgb(221, 223, 228);background:rgb(238, 240, 244);overflow:auto;word-wrap:normal;word-break:break-all;"><span style=""></span>
  <p style="font-size:14px;margin-bottom:0px;outline:0px;padding:0px;margin:0px 0px 16px;box-sizing:border-box;color:rgb(153, 153, 153);font-weight:400;line-height:22px;text-align:justify;word-break:break-all;">注意：配置CrateDB数据源需要事先安装好Crate插件。</p>
<span style=""></span></blockquote>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">Grafana有模板的概念，只要配置了模板，然后动态传入参数即可快速生成多个使用相同模板的不同指标数据的图表。</p>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">首先添加模板 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70 [1].png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="754" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/> <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70 [2].png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="336" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/> <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
然后配置SQL执行查询，即时可看到效果 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70 [3].png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="628" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/> <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70 [4].png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="446" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/> <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
配置好以后使用模板功能查看多个接口的流控指标监控 <br style="outline:0px;box-sizing:border-box;word-break:break-all;"/>
<img src="Sentinel一体化监控解决方案 CrateDB+Grafana - CSDN博客_files/70 [5].png" type="image/png" data-filename="70.png" alt="这里写图片描述" height="470" style="outline:0px;box-sizing:border-box;margin:24px 0px;word-break:break-all;max-width:100%;cursor:zoom-in;" title="" width="852"/></p>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t8" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>遗留问题</h2>

<ul style="outline:0px;list-style:none;box-sizing:border-box;padding:0px;margin:0px 0px 24px;word-break:break-all;">
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">sentinel-dashboard目前每隔一秒从所有的客户端同步一次数据, 集群庞大的情况下效率很低且不稳定</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">sentinel-dashboard收集到数据以后直接插入数据库没有缓冲，存在安全隐患</li>
</ul>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t9" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>改进点</h2>

<ul style="outline:0px;list-style:none;box-sizing:border-box;padding:0px;margin:0px 0px 24px;word-break:break-all;">
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">sentinel客户端间隔固定时间自动推送metric数据到sentinel-server(分布式部署)</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">sentinel-server将数据缓冲到kafka等消息中间件中</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">sentinel-server将数据从kafka中取出然后进行持久化</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">dashboard移除metric相关feature只做规则配置和分发相关工作</li>
<li style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 0px 32px;list-style-type:disc;word-break:break-all;">或者直接将dashboard规则配置分发功能移植到公司内部配置管理系统中，形成统一管理</li>
</ul>



<h2 style="outline:0px;padding:0px;box-sizing:border-box;margin:8px 0px 16px;font-size:24px;color:rgb(79, 79, 79);font-weight:700;line-height:32px;word-break:break-all;"><a name="t10" style="outline:0px;cursor:pointer;box-sizing:border-box;color:rgb(78, 161, 219);text-decoration:none;word-break:break-all;"></a>最后</h2>

<p style="outline:0px;padding:0px;box-sizing:border-box;margin:0px 0px 16px;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;text-align:justify;word-break:break-all;">本文仅展示了基于JDBC协议的存储方案，其实还有很多存储方案可以选择，例如Elasticsearch, influxDB,Prometheus等。实现的思路都是将数据落地，然后结合grafana进行展示，只是具体的实现细节有些许差异而已。</p>

<hr style="outline:0px;box-sizing:border-box;margin:24px 0px;border-top:none;border-right:none;border-left:none;border-image:initial;border-bottom:1px solid rgb(221, 221, 221);word-break:break-all;"/>            </div></div></div></div></span></div></div></div></div><br/></div></span>
</div></body></html> 