<html>
<head>
  <title>从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="15033"/>
<h1>从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/4/20 10:22</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.infoq.cn/article/lTtyNrJRdrHZxWq44cTQ"><i>https://www.infoq.cn/article/lTtyNrJRdrHZxWq44cTQ</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="font-family:Avenir, &quot;Helvetica Neue&quot;, Helvetica, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;\\5FAE软雅黑&quot;, Arial, sans-serif;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);background:rgb(255, 255, 255);"><div style="font:400 1em/1.8 Avenir, Tahoma, Arial, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, Helvetica, sans-serif;-webkit-font-smoothing:antialiased;text-size-adjust:100%;background:rgb(255, 255, 255);"><div style="background:rgb(246, 247, 248);"><div style="flex:1 1 0%;flex-direction:column;transition:padding-top 0.3s ease 0s;"><div style="background:rgb(255, 255, 255);"><div style="justify-content:space-between;"><div><div><h1 style="margin:0px;padding:0px;font-size:28px;font-weight:500;line-height:36px;color:rgb(20, 20, 20);">从 MongoDB 迁移到 ES 后，我们减少了 80% 的服务器</h1> <div style="padding:9px 0px 18px;line-height:24px;font-size:18px;font-weight:400;"></div> <div style="display:flex;justify-content:flex-start;padding-top:10px;line-height:1;font-size:14px;font-weight:400;color:rgb(130, 138, 146);"><ul style="margin:0px;padding:0px;list-style:none;display:flex;flex-wrap:wrap;"><span style="list-style:none;">作者：</span><li style="margin:0px;padding:0px;margin-right:4px;color:rgb(20, 20, 20);"><span style="color:rgb(20, 20, 20);"> </span><a style="transition:all 0.3s ease 0s;text-decoration:none;overflow-wrap:break-word;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgb(48, 48, 48);position:relative;cursor:pointer;" target="_blank">dbaplus社群</a></li></ul>  </div>   <div style="display:flex;justify-content:flex-start;padding-top:10px;line-height:1;font-size:14px;font-weight:400;color:rgb(130, 138, 146);"><p style="margin:0px;padding:0px;position:relative;display:flex;margin-right:15px;"><span style="position:relative;padding-right:31px;"><span style="top:2px;display:block;position:absolute;right:15px;width:1px;height:8px;background:rgb(130, 138, 146);"> </span>阅读数：1919</span> <span>2020 年 4 月 19 日 14:06</span></p></div> <div style="width:100%;padding:20px 0px 40px;"></div> <div style="line-height:2.1;text-align:justify;font-weight:400;color:rgb(74, 74, 74);"><p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><strong style="font-weight:700;color:rgb(0, 0, 0);">本文由 dbaplus 社群授权转载。</strong></p>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">序言</h2>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/b59fef4f1b50be4c385e5602e4f37d2f.png" type="image/png" data-filename="b59fef4f1b50be4c385e5602e4f37d2f.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="308" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="840"/></p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">图示：MongoDB 与 Elasticsearch 热度排名</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">本文内容涉及到 MongoDB 与 Elasticsearch 两大阵营，可能会引起口水之争，仅代表个人经验之谈，非阵营之说，围绕两个话题展开：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">为什么要从 MongoDB 迁移到 Elasticsearch？</li>
<li style="margin:0px;padding:0px;">如何从 MongoDB 迁移到 Elasticsearch？</li>
</ul>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">现状背景</h2>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">MongoDB 本身定位与关系型数据库竞争，但工作中几乎没有见到哪个项目会将核心业务系统的数据放在上面，依然选择传统的关系型数据库。</p>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">1、项目背景项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">公司所在物流速运行业，业务系统复杂且庞大，用户操作者很多，每日有大量业务数据产生，同时业务数据会有很多次流转状态变化，为了便于记录追踪分析，系统操作日志记录项目应运而生，考虑到原有的日均数据量，操作日志数据基于 MongoDB 存储。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">操作日志记录系统需要记录两种数据，如下说明：</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">1）变更主数据，什么人在什么时间在系统哪个模块做了什么操作，数据编号是什么，操作跟踪编号是什么。</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">{</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;dataId&quot;</span>: <span style="color:rgb(0, 92, 197);">1</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;traceId&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;abc&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;moduleCode&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;crm_01&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">5</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operateTime&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;2019-11-11 12:12:12&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">6</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationId&quot;</span>: <span style="color:rgb(0, 92, 197);">100</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">7</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 张三 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">8</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;departmentId&quot;</span>: <span style="color:rgb(0, 92, 197);">1000</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">9</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;departmentName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 客户部 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">10</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationContent&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 拜访客户。。。&quot;</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">11</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">}</div></td></tr></tbody></table></code></pre>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">2）变更从数据，实际变更数据的变化前后，此类数据条数很多，一行数据多个字段变更就记录多条。</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">[</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  {</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;dataId&quot;</span>: <span style="color:rgb(0, 92, 197);">1</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;traceId&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;abc&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">5</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;moduleCode&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;crm_01&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">6</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operateTime&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;2019-11-11 12:12:12&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">7</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationId&quot;</span>: <span style="color:rgb(0, 92, 197);">100</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">8</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 张三 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">9</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;departmentId&quot;</span>: <span style="color:rgb(0, 92, 197);">1000</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">10</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;departmentName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 客户部 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">11</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationContent&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 拜访客户 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">12</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"> </div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">13</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;beforeValue&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;20&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">14</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;afterValue&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;30&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">15</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;columnName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;customerType&quot;</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">16</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  },</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">17</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  {</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">18</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;dataId&quot;</span>: <span style="color:rgb(0, 92, 197);">1</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">19</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;traceId&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;abc&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">20</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;moduleCode&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;crm_01&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">21</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operateTime&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;2019-11-11 12:12:12&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">22</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationId&quot;</span>: <span style="color:rgb(0, 92, 197);">100</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">23</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 张三 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">24</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;departmentId&quot;</span>: <span style="color:rgb(0, 92, 197);">1000</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">25</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;departmentName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 客户部 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">26</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;operationContent&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 拜访客户 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">27</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"> </div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">28</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;beforeValue&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;2019-11-02&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">29</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;afterValue&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;2019-11-10&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">30</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(111, 66, 193);">&quot;columnName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;lastVisitDate&quot;</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">31</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  }</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">32</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">]</div></td></tr></tbody></table></code></pre>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">2、项目架构项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">项目架构描述如下：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">业务系统新增或者编辑数据，产生操作日志记录发送到 Kafka 集群，基于 dataid 字段作为 key；</li>
<li style="margin:0px;padding:0px;">新增或编辑数据实际存储到 MySQL 数据库；</li>
<li style="margin:0px;padding:0px;">canal 集群订阅 MySQL 集群，按照业务系统模块配置监控的数据库与表；</li>
<li style="margin:0px;padding:0px;">canal 将监控到的变更业务数据发送到 Kafka 集群，基于 dataid 字段作为 key；</li>
<li style="margin:0px;padding:0px;">操作日志系统从 Kafka 获取主记录数据与从记录数据；</li>
<li style="margin:0px;padding:0px;">操作日志系统写入数据到 MongoDB，同时需要反查询。</li>
</ul>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/a542e4d2dd1a5a582092b1b5935d592a.png" type="image/png" data-filename="a542e4d2dd1a5a582092b1b5935d592a.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="303" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="622"/></p>
<center>图示：操作日志记录业务流程说明</center>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">3、MongoDB 架构项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">集群架构说明：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">服务器配置 8c/32gb/500gb ssd；</li>
<li style="margin:0px;padding:0px;">Router 路由服务器部署了 3 个节点；</li>
<li style="margin:0px;padding:0px;">Config 配置服务器部署了 3 个节点；</li>
<li style="margin:0px;padding:0px;">Shard 分片服务器部署了 9 个节点；</li>
<li style="margin:0px;padding:0px;">主操作记录设计 3 个分片；</li>
<li style="margin:0px;padding:0px;">从操作记录设计 3 个分片。</li>
</ul>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/241c65d5aaa883b87662a5fc05c64fc6.png" type="image/png" data-filename="241c65d5aaa883b87662a5fc05c64fc6.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="440" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="620"/></p>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">问题说明</h2>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">MongoDB 的信徒们可能怀疑我们没有使用好，或者我们的运维能力欠缺，或者认为我们有 Elasticsearch 的高手在。不是这样的，弃用 MongoDB 选择 Elasticsearch 其实并非技术偏见问题，而是我们的实际场景需求，原因如下：</p>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">1、搜索查询项目背景</h3>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">MongoDB 内部采用 B-Tree 作为索引结构，此索引基于最左优先原则，且必须保证查询顺序与索引字段的顺序一致才有效，这个即是优点，但在现在复杂业务场景也是致命的；</li>
<li style="margin:0px;padding:0px;">业务系统查询操作日志记录会有很多过滤条件，且查询条件是任意组合的，现有 MongoDB 是不支持的，或者说所有关系型数据库都不支持，如果要支持，得创建好多组合的 B+ 数索引，想法很不理智，这个我们已经在<a href="https://mp.weixin.qq.com/s?__biz=MzI2NDExNTk5Mg==&amp;mid=2247490796&amp;idx=1&amp;sn=ea9ff9bd3e244ad1eac47e083c54b983&amp;scene=21#wechat_redirect" rel="noopener nofollow" style="transition:all 0.3s ease 0s;text-decoration:none;overflow-wrap:break-word;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgb(20, 88, 212);" target="_blank">《DB 与 ES 混合之应用系统场景分析探讨》</a>文中探讨过，详细可以阅读；</li>
<li style="margin:0px;padding:0px;">同时主记录与从记录中有很多字符类的数据，这些数据查询即要支持精确查询，也要支持全文检索，这几个方面 MongoDB 功能很单一，性能也很糟糕，业务系统查询时经常超时，反倒是 Elasticsearch 非常合适。</li>
</ul>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">2、技术栈成熟度项目背景</h3>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">分片与副本实现问题，MongoDB 集合数据在设计时是需要绑定到具体的机器实例的，哪些分片分布在哪些节点上，哪些副本分布在哪些节点上，这些都需要在配置集群时就要绑定死，跟传统的关系型数据库做分库分表本质上没有什么两样，其实现在很多数据产品的集群还是这种模式偏多，比如 Redis-cluster，ClickHouse 等。而 Elasticsearc 的集群与分片和副本没有直接的绑定关系，可以任意的平衡调整，且节点的性能配置也可以很容易差异化；</li>
<li style="margin:0px;padding:0px;">操作日志数据量增加很快，单日写入超过千万条，不用多久，运维人员就需要对服务器进行扩容，且相对 Elasticsearch 复杂很多；</li>
<li style="margin:0px;padding:0px;">MongoDB 单集合数据量超过 10 亿条，此情况下即使简单条件查询性能也不理想，不如 Elasticsearch 倒排索引快；</li>
<li style="margin:0px;padding:0px;">公司对于 ES 与 MongoDB 技术栈的经验积累不同，Elasticsearc 在很多项目中运用，非常核心的项目也是大量运用，对于其技术与运维经验更丰富，而 MongoDB 如果除去核心业务场景，几乎找不到合适的切入口，实际没有人敢在核心项目中使用 MongoDB，这就很尴尬。</li>
</ul>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">3、文档格式相同项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">MongoDB 与 Elasticsearch 都属于文档型数据库 ，Bson 类同与 Json，_objectid 与 _id 原理一样，所以主数据与从数据迁移到 Elasticsearch 平台，数据模型几乎无需变化。</p>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">迁移方案</h2>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">异构数据系统迁移，主要围绕这两大块内容展开：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">上层应用系统迁移，原来是针对 MongoDB 的语法规则，现在要修改为面向 Elasticsearch 语法规则；</li>
<li style="margin:0px;padding:0px;">下层 MongoDB 数据迁移到 Elasticsearch。</li>
</ul>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">1、Elastic 容量评估项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">原有 MongoDB 集群采用了 15 台服务器，其中 9 台是数据服务器，迁移到 Elastic 集群需要多少台服务器？我们采取简单推算办法，如假设生产环境上某个 MongoDB 集合的数据有 10 亿条数据, 我们先在测试环境上从 MongoDB 到 ES 上同步 100 万条数据，假设这 100 万条数据占用磁盘 10G，那生产上环境上需要 1 个 T 磁盘空间，然后根据业务预期增加量扩展一定冗余。根据初步评估，Elastic 集群设置 3 台服务器， 配置 8c/16g 内存 /2T 机械磁盘。服务器数量一下从 15 台缩减到 3 台，且配置也降低不少。</p>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">2、Elastic 索引规则项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">系统操作日志是时序性数据，写完整后基本上无需再次修改。操作日志记录查询主要是当月的居多，后续的历史性数据查询频率很低，根据评估，核心数据索引按月创建生成， 业务查询时候必须带上操作时间范围，后端根据时间反推需要查询哪些索引，Elastic-Api 支持多索引匹配查询，完美利用 Elastic 的特性解决跨多个月份的查询合并。对于非核心数据索引，按年创建索引生成足以。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/40636f44f24fb426bc130713f20892b0.png" type="image/png" data-filename="40636f44f24fb426bc130713f20892b0.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="439" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="650"/></p>
<center>图示：Elastic 操作日志索引创建规则</center>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">3、核心实现逻辑设计项目背景</h2>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">Elasticsearch 不是关系型数据库，不具备事务的机制。操作日志系统的数据来源都是 Kafka，消费数据是有顺序机制的，有 2 种场景特别注意，如下：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">主数据先到操作日志系统，从数据后到，从数据写的时候先拼凑主数据记录和 Binlog 字段数据；</li>
<li style="margin:0px;padding:0px;">从数据先到操作日志系统，主数据后到，主数据更新从索引的相关的索引字段。</li>
</ul>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">Elasticsearch 索引数据更新是近实时的刷新机制，数据提交后不能马上通过 Search-Api 查询到，主记录的数据如何更新到从记录呢？而且业务部门不规范的使用，多条主记录的 dataId 和 tracId 可能一样。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">由于主数据与从数据关联字段是 dataId 和 traceId。如果主数据与从数据在同时达到操作日志系统，基于 update_by_query 命令肯定失效不 准确， 主从数据也可能是多对多的关联关系，dataId 和 traceId 不能唯一决定一条记录。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">Elasticsearch 其实也是一个 NoSQL 数据库， 可以做 key-value 缓存。这时新建一个 Elastic 索引作为中间缓存， 原则是主数据与从数据谁先到缓存谁，索引的 _id=（dataId+traceId） ， 通过这个中间索引可以找到主数据记录的 Id 或者从记录 Id， 索引数据模型多如下，detailId 为从索引的 _id 的数组记录。</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">{</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;dataId&quot;</span>: <span style="color:rgb(0, 92, 197);">1</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;traceId&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;abc&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;moduleCode&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;crm_01&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">5</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationId&quot;</span>: <span style="color:rgb(0, 92, 197);">100</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">6</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 张三 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">7</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;departmentId&quot;</span>: <span style="color:rgb(0, 92, 197);">1000</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">8</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;departmentName&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 客户部 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">9</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;operationContent&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot; 拜访客户 &quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">10</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(111, 66, 193);">&quot;detailId&quot;</span>: [</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">11</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">1</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">12</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">2</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">13</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">3</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">14</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">4</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">15</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">5</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">16</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">    <span style="color:rgb(0, 92, 197);">6</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">17</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  ]</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">18</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">}</div></td></tr></tbody></table></code></pre>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">前面我们讲过主记录和从记录都是一个 Kafka 的分区上，我们拉一批数据的时候，操作 ES 用的用到的核心 API：</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(150, 152, 150);">#批量获取从索引的记录</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">_mget</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(150, 152, 150);">#批量插入</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">bulk</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">5</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(150, 152, 150);">#批量删除中间临时索引</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">6</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">_delete_by_query</div></td></tr></tbody></table></code></pre>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">迁移过程</h2>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">1、数据迁移项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">选择 DataX 作为数据同步工具由以下几个因素：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">历史型数据。操作日志记录数据属于历史性的数据，记录产生之后几乎无需二次修改，等同于离线数据；</li>
<li style="margin:0px;padding:0px;">非持续性迁移。项目全部完工之后，原有的 MongoDB 集群会全部销毁，不会有二次迁移需求；</li>
<li style="margin:0px;padding:0px;">数据量问题。原有 MongoDB 操作日志数据量有几十亿条，迁移过程不能太快也不能太慢，速度太快，MongoDB 集群会出现性能问题，速度太慢，项目周期太长，增加运维的成本与复杂度。否则可以选择 Hadoop 作为中转平台的迁移；</li>
<li style="margin:0px;padding:0px;">DataX 源码特定场景改造。如日期类型的转换、索引主键 _id 的生成、索引主键 _id 映射，支持重复同步；</li>
<li style="margin:0px;padding:0px;">多实例多线程并行。主数据同步部署多个实例，从数据同步也部署多个实例，单实例中配置多个 Channel。</li>
</ul>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/3b1364eadf9a8726a43b7ddbe6ce4269.png" type="image/png" data-filename="3b1364eadf9a8726a43b7ddbe6ce4269.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="314" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="756"/></p>
<center>图示：DataX 同步数据示意图</center>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">2、迁移索引设置项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">临时修改索引的一些设置，当数据同步完之后再修改回来，如下：</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(3, 47, 98);">&quot;index.number_of_replicas&quot;</span>: <span style="color:rgb(0, 92, 197);">0</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(3, 47, 98);">&quot;index.refresh_interval&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;30s&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(3, 47, 98);">&quot;index.translog.flush_threshold_size&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;1024M&quot;</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(3, 47, 98);">&quot;index.translog.durability&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;async&quot;</span>,</div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">5</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;">  <span style="color:rgb(3, 47, 98);">&quot;index.translog.sync_interval&quot;</span>: <span style="color:rgb(3, 47, 98);">&quot;5s&quot;</span></div></td></tr></tbody></table></code></pre>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">3、应用迁移项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">操作日志项目采用 Springboot 构建，增加了自定义配置项，如下：</p>
<div style="position:relative;"><div style="transition:all 0.3s ease 0s;position:absolute;z-index:10;top:15px;right:24px;line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);opacity:1;cursor:pointer;"><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span><span style="font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-webkit-text-stroke-width:0.2px;font-family:iconfont;position:relative;top:2px;"></span>复制代码<div style="transition:all 0.3s ease 0s;position:absolute;z-index:11;top:-24px;left:50%;width:50px;padding:4px 8px;background:rgba(0, 0, 0, 0.6);border-radius:2px;line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);opacity:0;transform:translateX(-50%) scale(0.9);"><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;"></span><span style="line-height:1;font-size:12px;font-weight:400;text-align:center;color:rgb(255, 255, 255);transition:all 0.3s ease 0s;position:absolute;bottom:-10px;left:50%;z-index:11;width:0px;height:0px;margin-left:-5px;border-width:5px;border-style:solid;border-color:rgba(0, 0, 0, 0.6) transparent transparent;border-image:initial;"> </span></div><span style="line-height:1;font-size:12px;font-weight:400;color:rgb(130, 138, 146);cursor:pointer;transition:all 0.3s ease 0s;"></span></div></div><pre style="margin:0px;padding:0px;font-family:Courier, &quot;Courier New&quot;, monospace;display:block;font-weight:400;margin-bottom:1.5rem;background:rgb(249, 250, 252);border-radius:5px;overflow:hidden;"><code style="margin:0px;padding:30px 25px 15px;font-style:normal;font-weight:400;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace, serif;background:rgb(249, 250, 252);position:relative;display:block;color:rgb(51, 51, 51);overflow-x:auto;"><table style="border-collapse:collapse;border-spacing:0px;font-weight:400;margin-bottom:0px;width:100%;line-height:1.8;font-size:13px;text-size-adjust:none;"><tbody><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">1</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(150, 152, 150);">#应用写入 mongodb 标识</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">2</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(111, 66, 193);">writeflag.mongodb:</span> <span style="color:rgb(0, 134, 179);">true</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">3</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(150, 152, 150);">#应用写入 elasticsearch 标识</span></div></td></tr><tr><td style="margin:0px;padding:0px;border:none;"><div style="white-space:pre;"><span style="white-space:pre;">4</span></div></td><td style="margin:0px;padding:0px;border:none;"><div style="padding-left:10px;white-space:pre;"><span style="color:rgb(111, 66, 193);">writeflag.elasticsearch:</span> <span style="color:rgb(0, 134, 179);">true</span></div></td></tr></tbody></table></code></pre>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">项目改造说明：</p>
<ul style="margin:0px;padding:0px;list-style:disc;font-weight:400;margin-bottom:1.5rem;margin-left:1.3em;">
<li style="margin:0px;padding:0px;">第一次上线的时候，先将 2 个写入标识设置为 true，双写 MongoDB 和 ES；</li>
<li style="margin:0px;padding:0px;">对于读，提供 2 个不同接口，前端自由的切换；</li>
<li style="margin:0px;padding:0px;">等数据迁移完，没有差异的时候，重新更改 flag 的值。</li>
</ul>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><img src="从MongoDB迁移到ES后，我们减少了80%的服务器 - InfoQ_files/609de871d3e5025508862cbfbfe07b8d.png" type="image/png" data-filename="609de871d3e5025508862cbfbfe07b8d.png" alt="从MongoDB迁移到ES后，我们减少了80%的服务器" height="359" style="border:0px;max-width:100%;display:block;margin:0px auto;" width="539"/></p>
<center>图示：应用平衡迁移</center>
<h2 style="margin:0px;padding:0px;font-size:22px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">结语</h2>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">1、迁移效果项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">弃用 MongoDB 使用 ElasticSearch 作为存储数据库，服务器从原来的 15 台 MongoDB，变成了 3 台 ElasticSearch，每月为公司节约了一大笔费用。同时查询性能提高了 10 倍以上，而且更好的支持了各种查询，得到了业务部门的使用者，运维团队和领导的一致赞赏。</p>
<h3 style="margin:0px;padding:0px;font-size:18px;font-weight:500;line-height:1.35;font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Verdana, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;color:rgb(53, 53, 53);margin-top:1.2em;margin-bottom:0.6em;">2、经验总结项目背景</h3>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;">整个项目前后历经几个月，多位同事参与，设计、研发，数据迁移、测试、数据验证、压测等各个环节。技术方案不是一步到位，中间也踩了很多坑，最终上线了。ES 的技术优秀特点很多，灵活的使用，才能发挥最大的威力。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><strong style="font-weight:700;color:rgb(0, 0, 0);">作者介绍</strong>：</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><strong style="font-weight:700;color:rgb(0, 0, 0);">李猛 (ynuosoft)</strong>，Elastic-stack 产品深度用户，ES 认证工程师，2012 年接触 Elasticsearch，对 Elastic-Stack 开发、架构、运维等方面有深入体验，实践过多种 Elasticsearch 项目，最暴力的大数据分析应用，最复杂的业务系统应用；业余为企业提供 Elastic-stack 咨询培训以及调优实施。</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><strong style="font-weight:700;color:rgb(0, 0, 0);">原文链接</strong>：</p>
<p style="margin:0px;padding:0px;font-weight:400;margin-bottom:1.5rem;word-break:break-word;"><a href="https://mp.weixin.qq.com/s?__biz=MzI4NTA1MDEwNg==&amp;mid=2650787182&amp;idx=1&amp;sn=d3543f9a62ec56c58fe72a0d63e35999&amp;chksm=f3f978fbc48ef1ed23736de22fd812ca195acdb16c3869ddab8b2c29aa3ca50f0f35042f5d71&amp;scene=27#wechat_redirect" rel="noopener nofollow" style="transition:all 0.3s ease 0s;text-decoration:none;overflow-wrap:break-word;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgb(20, 88, 212);" target="_blank"> https://mp.weixin.qq.com/s?__biz=MzI4NTA1MDEwNg==&amp;mid=2650787182&amp;idx=1&amp;sn=d3543f9a62ec56c58fe72a0d63e35999&amp;chksm=f3f978fbc48ef1ed23736de22fd812ca195acdb16c3869ddab8b2c29aa3ca50f0f35042f5d71&amp;scene=27#wechat_redirect </a></p>
</div></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 