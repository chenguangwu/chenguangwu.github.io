<html>
<head>
  <title>Hadoop技术博文</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7365"/>
<h1>Hadoop技术博文</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/8/2 8:59</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://mp.weixin.qq.com/s/Fb1cW0oN7xYeb1oI2ixtgQ"><i>https://mp.weixin.qq.com/s/Fb1cW0oN7xYeb1oI2ixtgQ</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;position: relative;"><div style="text-size-adjust:100%;line-height:1.6;"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);letter-spacing:0.034em;background-color:rgb(255, 255, 255);"><div><div style="word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div><div style="overflow:hidden;color:rgb(51, 51, 51);font-size:17px;word-wrap:break-word;text-align:justify;">
                    

                    

                    
                    
                    <p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:12px;">本文由 </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:12px;text-decoration:underline;">美图数据技术团队</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:12px;"> 授权转载，原文 https://mp.weixin.qq.com/s/jllAegJMYh_by95FhHt0jA</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;letter-spacing:0.544px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;letter-spacing:0.544px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);">本文从编程模型、任务调度、时间机制、Kafka 动态分区的感知、容错及处理语义、背压等几个方面对比 Spark Stream  与 Flink，希望对有实时处理需求业务的企业端用户在框架选型有所启发。本文篇幅较长，建议先收藏～</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="color:rgb(255, 255, 255);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background-color:rgb(255, 47, 146);padding:0px;font-family:Optima-Regular, PingFangTC-light;font-size:18px;letter-spacing:0.5px;font-weight:600;text-align:center;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);text-align:center;"><span style="background-color:rgb(255, 47, 146);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;color:rgb(255, 255, 255);font-family:Optima-Regular, PingFangTC-light;font-size:18px;letter-spacing:0.5px;font-weight:600;"> / 编程模型对比 / </span></p><h3 style="font-weight:600;font-size:1.25em;margin:5px 8px 10px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;font-family:Optima-Regular, PingFangTC-light;color:rgb(255, 47, 146);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></h3><h3 style="font-weight:600;font-size:1.25em;margin:5px 8px 10px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;font-family:Optima-Regular, PingFangTC-light;color:rgb(255, 47, 146);">运行角色</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></h3><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Spark Streaming 运行时的角色(standalone 模式)主要有：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Master</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">:主要负责整体集群资源的管理和应用程序调度；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Worker</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">:负责单个节点的资源管理，driver 和 executor 的启动等；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Driver</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">:用户入口程序执行的地方，即 SparkContext 执行的地方，主要是 DGA 生成、stage 划分、task 生成及调度；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Executor</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">:负责执行 task，反馈执行状态和执行结果。</span></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Flink 运行时的角色(standalone 模式)主要有:</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Jobmanager</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 协调分布式执行，他们调度任务、协调 checkpoints、协调故障恢复等。至少有一个 JobManager。高可用情况下可以启动多个 JobManager，其中一个选举为 leader，其余为 standby；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Taskmanager</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 负责执行具体的 tasks、缓存、交换数据流，至少有一个 TaskManager；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Slot</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 每个 task slot 代表 TaskManager 的一个固定部分资源，Slot 的个数代表着 taskmanager 可并行执行的 task 数。</span></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></strong></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;color:rgb(255, 47, 146);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;">生态</span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);text-align:center;"><img src="Hadoop技术博文_files/640" type="image/webp" data-filename="640" height="204" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:12px;color:rgb(136, 136, 136);">图 1：Spark Streaming 生态，via Spark 官网</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:12px;color:rgb(136, 136, 136);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);text-align:center;"><img src="Hadoop技术博文_files/640 [1]" type="image/webp" data-filename="640" height="216" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:12px;color:rgb(136, 136, 136);">图 2：Flink 生态，via Flink官网</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:12px;color:rgb(136, 136, 136);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;font-size:16px;color:rgb(255, 47, 146);">运行模型</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">Spark Streaming 是</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">微批处理</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">，运行的时候需要指定批处理的时间，每次运行 job 时处理一个批次的数据，流程如图 3 所示：</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);text-align:center;"><img src="Hadoop技术博文_files/640 [2]" type="image/webp" data-filename="640" height="139" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;">图 3，via Spark 官网</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Flink 是基于<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">事件</strong>驱动的，事件可以理解为消息。事件驱动的应用程序是一种状态应用程序，它会从一个或者多个流中注入事件，通过触发计算更新状态，或外部动作对注入的事件作出反应。</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [3]" type="image/webp" data-filename="640" height="186" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:491px !important;" width="491"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);">图 4，via Fink 官网</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-right:8px;margin-left:8px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="letter-spacing:0.5px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;font-weight:600;font-family:Optima-Regular, PingFangTC-light;font-size:18px;background-color:rgb(255, 47, 146);color:rgb(255, 255, 255);"> / 编程模型对比 / </span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">编程模型对比，主要是对比 flink 和 Spark Streaming 两者在代码编写上的区别。</span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;font-size:16px;color:rgb(255, 47, 146);">Spark Streaming</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">Spark Streaming 与 kafka 的结合主要是两种模型：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">基于 receiver dstream；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">基于 direct dstream。</span></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-bottom:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">以上两种模型编程机构近似，只是在 api 和内部数据获取有些区别，新版本的已经取消了基于 receiver 这种模式，企业中通常采用基于 direct Dstream 的模式。</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;">val <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Array</span>(brokers, topics) = args<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//    创建一个批处理时间是2s的context    </span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val sparkConf = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> SparkConf().setAppName(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;DirectKafkaWordCount&quot;</span>)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val ssc = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> StreamingContext(sparkConf, Seconds(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">2</span>))    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//    使用broker和topic创建DirectStream    </span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val topicsSet = topics.split(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;,&quot;</span>).toSet    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val kafkaParams = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Map</span>[<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>](<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;metadata.broker.list&quot;</span> -&gt; brokers)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val messages = KafkaUtils.createDirectStream[<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>]( ssc, LocationStrategies.PreferConsistent,    ConsumerStrategies.Subscribe[<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">String</span>](topicsSet, kafkaParams))  <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// Get the lines, split them into words, count the words and print    </span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val lines = messages.map(_.value)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val words = lines.flatMap(_.split(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot; &quot;</span>))    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>val wordCounts = words.map(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">x</span> =&gt;</span> (x, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">1</span>L)).reduceByKey(_ + _)   <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>wordCounts.print()     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//    启动流    </span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>ssc.start()    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>ssc.awaitTermination()<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></code></pre></div><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-bottom:16px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-bottom:16px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">通过以上代码我们可以 get 到：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">设置批处理时间</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">创建数据流</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">编写transform</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">编写action</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">启动执行</span></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(255, 47, 146);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:16px;">Flink</span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">接下来看 flink 与 kafka 结合是如何编写代码的。Flink 与 kafka 结合是事件驱动，大家可能对此会有疑问，消费 kafka 的数据调用 poll 的时候是批量获取数据的(可以设置批处理大小和超时时间)，这就不能叫做事件触发了。而实际上，flink 内部对 poll 出来的数据进行了整理，然后逐条 emit，形成了事件触发的机制。 下面的代码是 flink 整合 kafka 作为 data source 和 data sink：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.getConfig().disableSysoutLogging();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.getConfig().setRestartStrategy(RestartStrategies.fixedDelayRestart(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">4</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">10000</span>));<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// create a checkpoint every 5 seconds</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.enableCheckpointing(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">5000</span>); <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// make parameters available in the web interface</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.getConfig().setGlobalJobParameters(parameterTool); <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//  ExecutionConfig.GlobalJobParameters</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.getConfig().setGlobalJobParameters(null);    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>DataStream&lt;KafkaEvent&gt; input = env<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           .addSource(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> FlinkKafkaConsumer010&lt;&gt;(<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                   parameterTool.getRequired(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;input-topic&quot;</span>),  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> KafkaEventSchema(),<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                   parameterTool.getProperties())<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           .assignTimestampsAndWatermarks(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> CustomWatermarkExtractor()))<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           .setParallelism(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">1</span>).rebalance()<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           .keyBy(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;word&quot;</span>)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           .<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">map</span>(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> RollingAdditionMapper()).setParallelism(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>input.addSink(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> FlinkKafkaProducer010&lt;&gt;(parameterTool.getRequired(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;output-topic&quot;</span>), <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> KafkaEventSchema(),<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>        parameterTool.getProperties()));<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>env.execute(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;Kafka 0.10 Example&quot;</span>);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-bottom:16px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">从 Flink 与 kafka 结合的代码可以 get 到：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">注册数据 source</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">编写运行逻辑</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">注册数据 sink</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:14px;font-family:Optima-Regular, PingFangTC-light;color:rgb(63, 63, 63);letter-spacing:0.5px;">调用 env.execute 相比于 Spark Streaming 少了设置批处理时间，还有一个显著的区别是 flink 的所有算子都是 lazy 形式的，调用 env.execute 会构建 jobgraph。client 端负责 Jobgraph 生成并提交它到集群运行；而 Spark Streaming的操作算子分 action 和 transform，其中仅有 transform 是 lazy 形式，而且 DGA 生成、stage 划分、任务调度是在 driver 端进行的，在 client 模式下 driver 运行于客户端处。</span></p></li></ul><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);text-align:center;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:18px;color:rgb(255, 255, 255);background-color:rgb(255, 47, 146);"> / 任务调度原理 / </span></strong></p><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="color:rgb(63, 63, 63);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;text-align:justify;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-weight:600;letter-spacing:0.5px;font-size:16px;color:rgb(255, 47, 146);">Spark 任务调度</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">Spark Streaming 任务如上文提到的是基于微批处理的，实际上每个批次都是一个 Spark Core 的任务。对于编码完成的 Spark Core 任务在生成到最终执行结束主要包括以下几个部分：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">构建 DGA 图；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">划分 stage；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">生成 taskset；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">调度 task。</span></p></li></ul><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">具体可参考图 5：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [4]" type="image/webp" data-filename="640" height="321" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="599"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-size:12px;font-family:Optima-Regular, PingFangTC-light;">图 5：Spark 任务调度</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">对于 job 的调度执行有 fifo 和 fair 两种模式，Task 是根据<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">数据本地性</strong>调度执行的。 假设每个 Spark Streaming 任务消费的 kafka topic 有四个分区，中间有一个 transform操作（如 map）和一个 reduce 操作，如图 6 所示：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [5]" type="image/webp" data-filename="640" height="286" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;">图 6 </span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">假设有两个 executor，其中每个 executor 三个核，那么每个批次相应的 task 运行位置是固定的吗？是否能预测？ 由于数据本地性和调度不确定性，每个批次对应 kafka 分区生成的 task 运行位置并不是固定的。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;color:rgb(255, 47, 146);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;">Flink 任务调度</span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">对于 flink 的流任务客户端首先会生成 StreamGraph，接着生成 JobGraph，然后将 jobGraph 提交给 Jobmanager 由它完成 jobGraph 到 ExecutionGraph 的转变，最后由 jobManager 调度执行。</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [6]" type="image/webp" data-filename="640" height="400" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;">图 7</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">如图 7 所示有一个由 data source、MapFunction和 ReduceFunction 组成的程序，data source 和 MapFunction 的并发度都为 4，而 ReduceFunction 的并发度为 3。一个数据流由 Source-Map-Reduce 的顺序组成，在具有 2 个TaskManager、每个 TaskManager 都有 3 个 Task Slot 的集群上运行。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">可以看出 flink 的拓扑生成提交执行之后，除非故障，否则拓扑部件执行位置不变，并行度由每一个算子并行度决定，类似于 storm。而 spark Streaming 是每个批次都会根据数据本地性和资源情况进行调度，无固定的执行拓扑结构。 flink 是数据在拓扑结构里流动执行，而 Spark Streaming 则是对数据缓存批次并行处理。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:18px;color:rgb(255, 255, 255);background-color:rgb(255, 47, 146);"> / 时间机制对比 / </span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;font-size:16px;color:rgb(255, 47, 146);">流处理的时间</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">流处理程序在时间概念上总共有三个时间概念：</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">处理时间</span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">处理时间是指<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">每台机器的</strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">系统时间</strong>，当流程序采用处理时间时将使用运行各个运算符实例的机器时间。处理时间是最简单的时间概念，不需要流和机器之间的协调，它能提供最好的性能和最低延迟。然而在分布式和异步环境中，处理时间不能提供消息事件的时序性保证，因为它受到消息传输延迟，消息在算子之间流动的速度等方面制约。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">事件时间</span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">事件时间是指事件在其<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">设备</strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">上发生的时间</strong>，这个时间在事件进入 flink 之前已经嵌入事件，然后 flink 可以提取该时间。基于事件时间进行处理的流程序可以保证事件在处理的时候的顺序性，但是基于事件时间的应用程序必须要结合 watermark 机制。基于事件时间的处理往往有一定的滞后性，因为它需要等待后续事件和处理无序事件，对于时间敏感的应用使用的时候要慎重考虑。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">注入时间</span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">注入时间是<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">事件注入到 flink 的时间</strong>。事件在 source 算子处获取 source 的当前时间作为事件注入时间，后续的基于时间的处理算子会使用该时间处理数据。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">相比于事件时间，注入时间不能够处理无序事件或者滞后事件，但是应用程序无序指定如何生成 watermark。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">在内部注入时间程序的处理和事件时间类似，但是时间戳分配和 watermark 生成都是自动的。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">图 8 可以清晰地看出三种时间的区别：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [7]" type="image/webp" data-filename="640" height="298" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-size:12px;">图 8</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;letter-spacing:0.5px;font-weight:600;color:rgb(255, 47, 146);font-size:16px;font-family:Optima-Regular, PingFangTC-light;">Spark 时间机制</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">Spark Streaming 只支持处理时间，</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">Structured streaming 支持处理时间和事件时间，同时支持 watermark 机制处理滞后数据。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(255, 47, 146);font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;">Flink 时间机制</span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">flink 支持三种时间机制：事件时间，注入时间，处理时间，同时支持 watermark 机制处理滞后数据。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(255, 255, 255);background-color:rgb(255, 47, 146);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;letter-spacing:0.5px;font-family:Optima-Regular, PingFangTC-light;font-size:18px;"> / kafka 动态分区检测 / </span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;font-size:16px;color:rgb(255, 47, 146);">Spark Streaming</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">对于有实时处理业务需求的企业，随着业务增长数据量也会同步增长，将导致原有的 kafka 分区数不满足数据写入所需的并发度，需要扩展 kafka 的分区或者增加 kafka 的 topic，这时就要求实时处理程序，如 SparkStreaming、flink 能检测到 kafka 新增的 topic 、分区及消费新增分区的数据。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">接下来结合源码分析，Spark Streaming 和 flink 在 kafka 新增 topic 或 partition 时能否动态发现新增分区并消费处理新增分区的数据。 Spark Streaming 与 kafka 结合有两个区别比较大的版本，如图 9 所示是官网给出的对比数据：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [8]" type="image/webp" data-filename="640" height="279" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);">图 9</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">其中确认的是 Spark Streaming 与 kafka 0.8 版本结合不支持动态分区检测，与 0.10 版本结合支持，接着通过源码分析。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">Spark Streaming 与 kafka 0.8 版本结合</span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-size:12px;color:rgb(214, 214, 214);">*源码分析只针对分区检测</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">入口是 DirectKafkaInputDStream 的 compute：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//    改行代码会计算这个job，要消费的每个kafka分区的最大偏移</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">override</span> def compute(validTime: Time): Option[KafkaRDD[K, V, U, T, R]] = {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">//    构建KafkaRDD，用指定的分区数和要消费的offset范围</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> untilOffsets = clamp(latestLeaderOffsets(maxRetries))<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> rdd = KafkaRDD[K, V, U, T, R](<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// Report the record number and metadata of this batch interval to InputInfoTracker.</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     context.sparkContext, kafkaParams, currentOffsets, untilOffsets, messageHandler)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> offsetRanges = currentOffsets.map { case (tp, fo) =&gt;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> uo = untilOffsets(tp)      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     OffsetRange(tp.topic, tp.partition, fo, uo.offset)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   }    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> description = offsetRanges.filter { offsetRange =&gt;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// Don't display empty ranges.</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     offsetRange.fromOffset != offsetRange.untilOffset<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   }.map { offsetRange =&gt;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// Copy offsetRanges to immutable.List to prevent from being modified by the user</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;topic: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;">${offsetRange.topic}</span>\tpartition: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;">${offsetRange.partition}</span>\t&quot;</span> +<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;offsets: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;">${offsetRange.fromOffset}</span> to <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;">${offsetRange.untilOffset}</span>&quot;</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   }.mkString(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;\n&quot;</span>)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> metadata = Map(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;offsets&quot;</span> -&gt; offsetRanges.toList,      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>        StreamInputInfo.METADATA_KEY_DESCRIPTION -&gt; description)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> inputInfo = StreamInputInfo(id, rdd.count, metadata)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   ssc.scheduler.inputInfoTracker.reportInfo(validTime, inputInfo)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   currentOffsets = untilOffsets.map(kv =&gt; kv._1 -&gt; kv._2.offset)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   Some(rdd)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>}</code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">第一行就是计算得到该批次生成 KafkaRDD 每个分区要消费的最大 offset。 接着看 latestLeaderOffsets(maxRetries)</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// 可以看到的是用来指定获取最大偏移分区的列表还是只有currentOffsets，没有发现关于新增的分区的内容。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">@tailrec</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">protected</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">final</span> def latestLeaderOffsets(retries: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Int</span>): Map[TopicAndPartition, LeaderOffset] = {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> o = kc.getLatestLeaderOffsets(currentOffsets.keySet)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// Either.fold would confuse @tailrec, do it manually</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (o.isLeft) {      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> err = o.left.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">get</span>.toString      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (retries &lt;= <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span>) {        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>        <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">throw</span> new SparkException(err)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>      } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">else</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       logError(err)        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       Thread.sleep(kc.config.refreshLeaderBackoffMs)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       latestLeaderOffsets(retries - <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">1</span>)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">else</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     o.right.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">get</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/> }</code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">其中 </span><code style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">protected var currentOffsets = fromOffsets</span></code><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">，这个仅仅是在构建 DirectKafkaInputDStream 的时候初始化，并在 compute 里面更新：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(51, 51, 51);"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:0px;margin-bottom:0px;background-image:none;background-color:initial;"><p style="margin-right:8px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;overflow-x:auto;min-height:1em;padding:6px;margin-left:8px;border-radius:4px;font-size:0.85em;background:rgb(40, 44, 52);color:rgb(171, 178, 191);clear:both;white-space:nowrap;"><span style="color:rgb(209, 154, 102);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;background:rgba(0, 0, 0, 0);display:inline;width:101px;text-decoration-style:solid;text-decoration-color:rgb(209, 154, 102);">currentOffsets</span> = until<span style="color:rgb(86, 182, 194);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;background:rgba(0, 0, 0, 0);display:inline;width:21px;text-decoration-style:solid;text-decoration-color:rgb(86, 182, 194);">Off</span>sets.map(kv =&gt; kv._1 -&gt; kv._2.<span style="color:rgb(86, 182, 194);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;background:rgba(0, 0, 0, 0);display:inline;width:22px;text-decoration-style:solid;text-decoration-color:rgb(86, 182, 194);">off</span>set)</p></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">中间没有检测 kafka 新增 topic 或者分区的代码，所以可以确认 Spark Streaming 与 kafka 0.8 的版本结合不支持动态分区检测。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">Spark Streaming 与 kafka 0.10 版本结合</span></strong></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">入口同样是 DirectKafkaInputDStream 的 compute 方法，捡主要的部分说，Compute 里第一行也是计算当前 job 生成 kafkardd 要消费的每个分区的最大 offset：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(51, 51, 51);"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:0px;margin-bottom:0px;background-image:none;background-color:initial;"><p style="margin-right:8px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;overflow-x:auto;min-height:1em;padding:6px;margin-left:8px;border-radius:4px;font-size:0.85em;background:rgb(40, 44, 52);color:rgb(171, 178, 191);clear:both;white-space:nowrap;"><span style="background:rgba(0, 0, 0, 0);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(92, 99, 112);padding:0px;display:inline;width:387px;text-decoration-style:solid;text-decoration-color:rgb(92, 99, 112);font-style:italic;">//    获取当前生成job，要用到的KafkaRDD每个分区最大消费偏移值</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/>   val untilOffsets = clamp(latestOffsets())</p></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">具体检测 kafka 新增 topic 或者分区的代码在 </span><code style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">latestOffsets()</span></code></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">/**   <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>* Returns the latest (highest) available offsets, taking new partitions into account.   <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>*/</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>protected def latestOffsets(): <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Map</span>[TopicPartition, Long] = {    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   val c = consumer<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   paranoidPoll(c)    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// 获取所有的分区信息</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// make sure new partitions are reflected in currentOffsets</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   val parts = c.assignment().asScala    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// 做差获取新增的分区信息</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   val newPartitions = parts.diff(currentOffsets.keySet)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// position for new partitions determined by auto.offset.reset if no commit</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// 新分区消费位置，没有记录的化是由auto.offset.reset决定</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   currentOffsets = currentOffsets ++ newPartitions.map(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">tp</span> =&gt;</span> tp -&gt; c.position(tp)).toMap    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// don't want to consume messages, so pause</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   c.pause(newPartitions.asJava)    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// find latest available offsets</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   c.seekToEnd(currentOffsets.keySet.asJava)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   parts.map(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">tp</span> =&gt;</span> tp -&gt; c.position(tp)).toMap<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>}</code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><code style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span></code><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">该方法内有获取 kafka 新增分区，并将其更新到 currentOffsets 的过程，所以可以验证 Spark Streaming 与 kafka 0.10 版本结合支持动态分区检测。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;font-size:16px;color:rgb(255, 47, 146);">Flink</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">入口类是 FlinkKafkaConsumerBase，该类是所有 flink 的 kafka 消费者的父类。</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [9]" type="image/webp" data-filename="640" height="273" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;">图 10</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">在 FlinkKafkaConsumerBase 的 run 方法中，创建了 kafkaFetcher，实际上就是消费者：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">this</span>.kafkaFetcher = createFetcher(<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       sourceContext,<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       subscribedPartitionsToStartOffsets,<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       periodicWatermarkAssigner,<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       punctuatedWatermarkAssigner,<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       (StreamingRuntimeContext) getRuntimeContext(),<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       offsetCommitMode,<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       getRuntimeContext().getMetricGroup().addGroup(KAFKA_CONSUMER_METRICS_GROUP),<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       useMetrics);</code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">接是创建了一个线程，该线程会定期检测 kafka 新增分区，然后将其添加到 kafkaFetcher 里。</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (discoveryIntervalMillis != PARTITION_DISCOVERY_DISABLED) {      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">final</span> AtomicReference&lt;Exception&gt; discoveryLoopErrorRef = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> AtomicReference&lt;&gt;();      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">this</span>.discoveryLoopThread = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> Thread(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">new</span> Runnable() {        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">@Override</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;color:inherit;line-height:inherit;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(54, 161, 102);word-break:inherit !important;">run</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">()</span> </span>{          <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>          <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">try</span> {            <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>          <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// --------------------- partition discovery loop ---------------------</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           List&lt;KafkaTopicPartition&gt; discoveredPartitions;            <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// throughout the loop, we always eagerly check if we are still running before</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// performing the next operation, so that we can escape the loop as soon as possible</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">while</span> (running) {              <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (LOG.isDebugEnabled()) {                <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               LOG.debug(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;Consumer subtask {} is trying to discover new partitions ...&quot;</span>, getRuntimeContext().getIndexOfThisSubtask());<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             }              <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">try</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               discoveredPartitions = partitionDiscoverer.discoverPartitions();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">catch</span> (AbstractPartitionDiscoverer.WakeupException | AbstractPartitionDiscoverer.ClosedException e) { <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// the partition discoverer may have been closed or woken up before or during the discovery;</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// this would only happen if the consumer was canceled; simply escape the loop</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">break</span>;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             } <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// no need to add the discovered partitions if we were closed during the meantime</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (running &amp;&amp; !discoveredPartitions.isEmpty()) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               kafkaFetcher.addDiscoveredPartitions(discoveredPartitions);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             } <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// do not waste any time sleeping if we're not running anymore</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (running &amp;&amp; discoveryIntervalMillis != <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span>) {                <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">try</span> {                  <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                 Thread.sleep(discoveryIntervalMillis);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">catch</span> (InterruptedException iex) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// may be interrupted if the consumer was canceled midway; simply escape the loop</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">break</span>;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>               }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">catch</span> (Exception e) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           discoveryLoopErrorRef.set(e);<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">finally</span> {            <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// calling cancel will also let the fetcher loop escape</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// (if not running, cancel() was already called)</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (running) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>             cancel();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>           }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     }, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;Kafka Partition Discovery for &quot;</span> + getRuntimeContext().getTaskNameWithSubtasks());<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>}<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>discoveryLoopThread.start();<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>kafkaFetcher.runFetchLoop();</code></pre></div><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">上面，就是 flink 动态发现 kafka 新增分区的过程。不过与 Spark 无需做任何配置不同的是，flink 动态发现 kafka 新增分区，这个功能需要被使能的。也很简单，需要将 flink.partition-discovery.interval-millis 该属性设置为大于 0 即可。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="font-family:Optima-Regular, PingFangTC-light;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;letter-spacing:0.5px;font-weight:600;font-size:18px;background-color:rgb(255, 47, 146);color:rgb(255, 255, 255);"> / 容错机制及处理语义 / </span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">本节内容主要是想对比两者在故障恢复及如何保证仅一次的处理语义。这个时候适合抛出一个问题：实时处理的时候，如何保证数据仅一次处理语义？</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px;color:rgb(255, 47, 146);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;">Spark Streaming 保证仅一次处理</span></strong></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">对于 Spark Streaming 任务，我们可以设置 checkpoint，然后假如发生故障并重启，我们可以从上次 checkpoint 之处恢复，但是这个行为只能使得数据不丢失，可能会重复处理，不能做到恰一次处理语义。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">对于 Spark Streaming 与 kafka 结合的 direct Stream 可以自己维护 offset 到 zookeeper、kafka 或任何其它外部系统，每次提交完结果之后再提交 offset，这样故障恢复重启可以利用上次提交的 offset 恢复，保证数据不丢失。但是假如故障发生在提交结果之后、提交 offset 之前会导致数据多次处理，这个时候我们需要保证处理结果多次输出不影响正常的业务。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">由此可以分析，假设要保证数据恰一次处理语义，那么结果输出和 offset 提交必须在一个事务内完成。在这里有以下两种做法：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:5px 8px 10px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;color:rgb(36, 41, 46);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">repartition(1) Spark Streaming 输出的 action 变成仅一个 partition，这样可以利用事务去做：</span></p></li></ul><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(51, 51, 51);"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:0px;margin-bottom:0px;background-image:none;background-color:initial;"><p style="margin-right:8px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;overflow-x:auto;min-height:1em;padding:6px;margin-left:8px;border-radius:4px;font-size:0.85em;background:rgb(40, 44, 52);color:rgb(171, 178, 191);clear:both;white-space:nowrap;">Dstream.foreachRDD(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:36px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:22px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);">rdd</span>=&gt;</span>{<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/>   rdd.repartition(<span style="color:rgb(209, 154, 102);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;background:rgba(0, 0, 0, 0);display:inline;width:8px;text-decoration-style:solid;text-decoration-color:rgb(209, 154, 102);">1</span>).foreachPartition(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:79px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:65px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);">partition</span>=&gt;</span>{    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>        <span style="background:rgba(0, 0, 0, 0);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(92, 99, 112);padding:0px;display:inline;width:92px;text-decoration-style:solid;text-decoration-color:rgb(92, 99, 112);font-style:italic;">//    开启事务</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/>       partition.foreach(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:43px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background:rgba(0, 0, 0, 0);display:inline;width:29px;text-decoration-style:solid;text-decoration-color:rgb(171, 178, 191);">each</span>=&gt;</span>{<span style="background:rgba(0, 0, 0, 0);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(92, 99, 112);padding:0px;display:inline;width:120px;text-decoration-style:solid;text-decoration-color:rgb(92, 99, 112);font-style:italic;">//提交数据</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/>       })    <span style="background:rgba(0, 0, 0, 0);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(92, 99, 112);padding:0px;display:inline;width:77px;text-decoration-style:solid;text-decoration-color:rgb(92, 99, 112);font-style:italic;">//  提交事务</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/>   })<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/> })</p></pre></div><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;margin-top:5px;margin-bottom:10px;color:rgb(51, 51, 51);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">将结果和 offset 一起提交</span></p></li></ul><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">也就是结果数据包含 offset。这样提交结果和提交 offset 就是一个操作完成，不会数据丢失，也不会重复处理。故障恢复的时候可以利用上次提交结果带的 offset。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;color:rgb(255, 47, 146);font-size:16px;">Flink 与 kafka 0.11 保证仅一次处理</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">若要 sink 支持仅一次语义，必须以事务的方式写数据到 Kafka，这样当提交事务时两次 checkpoint 间的所有写入操作作为一个事务被提交。这确保了出现故障或崩溃时这些写入操作能够被回滚。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">在一个分布式且含有多个并发执行 sink 的应用中，仅仅执行单次提交或回滚是不够的，因为所有组件都必须对这些提交或回滚达成共识，这样才能保证得到一致性的结果。Flink 使用两阶段提交协议以及预提交(pre-commit)阶段来解决这个问题。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">本例中的 Flink 应用如图 11 所示包含以下组件：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">一个source，从Kafka中读取数据（即KafkaConsumer）</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">一个时间窗口化的聚会操作</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">一个sink，将结果写回到Kafka（即KafkaProducer）</span></p></li></ul><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [10]" type="image/webp" data-filename="640" height="342" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-size:12px;font-family:Optima-Regular, PingFangTC-light;">图 11</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">下面详细讲解 flink 的两段提交思路：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [11]" type="image/webp" data-filename="640" height="318" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;font-size:12px;">图 12</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;font-size:12px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">如图 12 所示，Flink checkpointing 开始时便进入到 pre-commit 阶段。具体来说，一旦 checkpoint 开始，Flink 的 JobManager 向输入流中写入一个 checkpoint barrier ，将流中所有消息分割成属于本次 checkpoint 的消息以及属于下次 checkpoint 的，barrier 也会在操作算子间流转。对于每个 operator 来说，该 barrier 会触发 operator 状态后端为该 operator 状态打快照。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">data source 保存了 Kafka 的 offset，之后把 checkpoint barrier 传递到后续的 operator。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">这种方式仅适用于 operator 仅有它的内部状态。内部状态是指 Flink state backends 保存和管理的内容（如</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">第二个 operator 中 window 聚合算出来的 sum）。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">当一个进程仅有它的内部状态的时候，除了在 checkpoint 之前将需要将数据更改写入到 state backend，不需要在预提交阶段做其他的动作。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">在 checkpoint 成功的时候，Flink 会正确的提交这些写入，在 checkpoint 失败的时候会终止提交，过程可见图 13。</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [12]" type="image/webp" data-filename="640" height="358" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;"></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;font-size:12px;">图 13</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">当结合外部系统的时候，外部系统必须要支持可与两阶段提交协议捆绑使用的事务。显然本例中的 sink 由于引入了 kafka sink，因此在预提交阶段 data sink 必须预提交外部事务。如下图：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [13]" type="image/webp" data-filename="640" height="341" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-family:Optima-Regular, PingFangTC-light;font-size:12px;">图 14</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">当 barrier 在所有的算子中传递一遍，并且触发的快照写入完成，预提交阶段完成。所有的触发状态快照都被视为 checkpoint 的一部分，也可以说 checkpoint 是整个应用程序的状态快照，包括预提交外部状态。出现故障可以从 checkpoint 恢复。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;">下一步就是通知所有的操作算子 checkpoint 成功。该阶段 jobmanager 会为每个 operator 发起 checkpoint 已完成的回调逻辑。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">本例中 data source 和窗口操作无外部状态，因此该阶段，这两个算子无需执行任何逻辑，但是 data sink 是有外部状态的，因此，此时我们必须提交外部事务，如下图：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [14]" type="image/webp" data-filename="640" height="305" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(136, 136, 136);font-size:12px;font-family:Optima-Regular, PingFangTC-light;">图 15</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">以上就是 flink 实现恰一次处理的基本逻辑。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;text-align:center;"><span style="letter-spacing:0.5px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding:0px;font-weight:600;font-size:18px;font-family:Optima-Regular, PingFangTC-light;background-color:rgb(255, 47, 146);color:rgb(255, 255, 255);"> / Back pressure / </span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">消费者消费的速度低于生产者生产的速度，为了使应用正常，消费者会反馈给生产者来调节生产者生产的速度，以使得消费者需要多少，生产者生产多少。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;color:rgb(214, 214, 214);font-size:12px;">*back pressure 后面一律称为背压。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(63, 63, 63);font-family:Optima-Regular, PingFangTC-light;font-size:14px;letter-spacing:0.5px;font-weight:600;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;letter-spacing:0.5px;font-weight:600;color:rgb(255, 47, 146);font-size:16px;">Spark Streaming 的背压</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">Spark Streaming 跟 kafka 结合是存在背压机制的，目标是根据当前 job 的处理情况来调节后续批次的获取 kafka 消息的条数。为了达到这个目的，Spark Streaming 在原有的架构上加入了一个 RateController，利用的算法是 PID，需要的反馈数据是任务处理的结束时间、调度时间、处理时间、消息条数，这些数据是通过 SparkListener 体系获得，然后通过 PIDRateEsimator 的 compute 计算得到一个速率，进而可以计算得到一个 offset，然后跟限速设置最大消费条数比较得到一个最终要消费的消息最大 offset。</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">PIDRateEsimator 的 compute 方法如下：</span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;color:rgb(62, 62, 62);line-height:1.6;letter-spacing:0px;"><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:inherit;color:inherit;line-height:inherit;margin-top:0px;margin-bottom:0px;"><code style="letter-spacing:0px;margin:0px;word-break:normal !important;display:block !important;word-wrap:normal !important;margin-right:2px;margin-left:2px;line-height:18px;padding:0.5em;font-family:Consolas, Inconsolata, Courier, monospace;border-radius:0px;background:rgb(34, 34, 27);color:rgb(146, 145, 129);box-sizing:border-box;max-width:100%;overflow:auto !important;">def compute(time: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Long</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// in milliseconds</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     numElements: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Long</span>,      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     processingDelay: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Long</span>, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// in milliseconds</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     schedulingDelay: <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Long</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// in milliseconds</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   ): Option[<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">Double</span>] = {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   logTrace(s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;\ntime = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$time</span>, # records = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$numElements</span>, &quot;</span> +<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;processing time = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$processingDelay</span>, scheduling delay = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$schedulingDelay</span>&quot;</span>)    <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">this</span>.synchronized {      <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (time &gt; latestTime &amp;&amp; numElements &gt; <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span> &amp;&amp; processingDelay &gt; <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span>) {        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> delaySinceUpdate = (time - latestTime).toDouble / <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">1000</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> processingRate = numElements.toDouble / processingDelay * <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">1000</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> error = latestRate - processingRate        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> historicalError = schedulingDelay.toDouble * processingRate / batchIntervalMillis        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(135, 133, 115);word-break:inherit !important;">// in elements/(second ^ 2)</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> dError = (error - latestError) / delaySinceUpdate       <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">val</span> newRate = (latestRate - proportional * error -<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                                   integral * historicalError -<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                                   derivative * dError).max(minRate)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       logTrace(s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;&quot;&quot;  | latestRate = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$latestRate</span>, error = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$error</span>            <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                      | latestError = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$latestError</span>, historicalError = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$historicalError</span>            <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                      | delaySinceUpdate = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$delaySinceUpdate</span>, dError = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$dError</span>           <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>                 &quot;&quot;&quot;</span>.stripMargin)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       latestTime = time        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">if</span> (firstRun) {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         latestRate = processingRate<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         latestError = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">0</span>D<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         firstRun = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(174, 115, 19);word-break:inherit !important;">false</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         logTrace(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;First run, rate estimation skipped&quot;</span>)         <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         None<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">else</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         latestRate = newRate<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         latestError = error<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         logTrace(s<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;New rate = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(186, 98, 54);word-break:inherit !important;">$newRate</span>&quot;</span>)          <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>         Some(newRate)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     } <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(95, 145, 130);word-break:inherit !important;">else</span> {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       logTrace(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:inherit !important;font-size:inherit;line-height:inherit;color:rgb(125, 151, 38);word-break:inherit !important;">&quot;Rate estimation skipped&quot;</span>)        <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>       None<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>     }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>   }<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/> }</code></pre></div><h4 style="font-weight:600;font-size:16px;margin:5px 8px 10px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></h4><h4 style="font-weight:600;font-size:16px;margin:5px 8px 10px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(255, 47, 146);font-family:Optima-Regular, PingFangTC-light;">Flink 的背压</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></h4><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">与 Spark Streaming 的背压不同的是，Flink 背压是 jobmanager 针对每一个 task 每 50ms 触发 100 次 Thread.getStackTrace() 调用，求出阻塞的占比。过程如图 16 所示：</span></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><img src="Hadoop技术博文_files/640 [15]" type="image/webp" data-filename="640" height="264" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="661"/></p><p style="clear:both;margin:0px;max-width:100%;color:rgb(51, 51, 51);margin-left:8px;padding:0px;min-height:1em;margin-right:8px;word-wrap:break-word;box-sizing:border-box;text-align:center;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:12px;color:rgb(136, 136, 136);">图 16</span></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:5px 8px 10px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">阻塞占比在 web 上划分了三个等级：</span></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">OK</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 0 &lt;= Ratio &lt;= 0.10，表示状态良好；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">LOW</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 0.10 &lt; Ratio &lt;= 0.5，表示有待观察；</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">HIGH</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">: 0.5 &lt; Ratio &lt;= 1，表示要处理了。</span></p></li></ul><h2 style="word-wrap:break-word;font-weight:600;margin:0px;padding:0px;max-width:100%;box-sizing:border-box;font-size:1.2em;margin-top:1.66667em;margin-bottom:0.83333em;font-variant-numeric:inherit;font-variant-east-asian:inherit;font-stretch:inherit;line-height:1.5;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">深圳地区福利！</span></h2><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:1em;margin-bottom:1em;color:rgb(26, 26, 26);"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">美图的大数据团队在近几年的发展中，逐步演进和发展出美图的大数据体系，以及在美图业务场景下数据技术应用的最佳实践。8月11日我们将在深圳开设一场技术沙龙，我们邀请了来自美图公司的大数据负责人、架构师、魅族公司的数据技术专家、以及来自 Apache kylin 的 PMC。美图的大数据技术负责人和架构师会为大家分享美图在大数据技术上的探索、大数据的架构、以及数据技术的应用落地。魅族的数据技术专家会为大家介绍魅族的 DMP 系统的架构设计以及系统的演进历程。来自 Apache 顶级项目 kylin 的架构师会为大家分享 kylin 的技术原理与应用实践。四位技术专家会从多个角度不同层次，为大家分享各自在大数据技术上的实践经验。</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:5px;margin-bottom:10px;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:Optima-Regular, PingFangTC-light;font-size:14px;color:rgb(63, 63, 63);letter-spacing:0.5px;">报名链接点击下面<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">阅读原文</strong>。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(51, 51, 51);"><div style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;text-align:inherit;padding:0px;border-style:solid;border-color:rgb(0, 187, 236);font-family:inherit;font-weight:inherit;text-decoration:inherit;background-color:rgb(239, 239, 239);"><div style="margin-right:16px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:-1em;padding:0px;margin-left:16px;font-size:1em;border-width:initial;border-style:none;border-color:initial;line-height:1.4;"><span style="color:rgb(255, 255, 255);margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;display:inline-block;border-radius:4px;padding:3px 8px;text-align:center;font-family:inherit;font-weight:inherit;text-decoration:inherit;border-color:rgb(0, 187, 236);background-color:rgb(0, 187, 236);font-size:14px;"><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-family:inherit;font-weight:inherit;text-decoration:inherit;letter-spacing:0.544px;">猜你喜欢</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></div></span></div><div style="margin:0px;padding:16px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;line-height:1.4;font-family:inherit;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">欢迎关注本公众号：<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(217, 33, 66);text-decoration:underline;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">iteblog_hadoop</strong></span>:</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">回复 <strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">spark_summit_201806</strong> 下载 Spark Summit North America 201806 全部PPT</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">0、回复 <strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(217, 33, 66);background-color:rgb(212, 250, 0);">电子书</span></strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(2, 30, 170);"> </span></strong>获取 <strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(2, 30, 170);">本站所有可下载的电子书</span></strong></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">1、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650714979&amp;idx=1&amp;sn=a46db858bb837b98d7e1c355a66d97f7&amp;chksm=887dae15bf0a27039ffdb014e2b9178077c7ada6de96e74cc1b3d7ed926bb1cd6dfdf7dbcb0f&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">Apache Spark 统一内存管理模型详解</a></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">2、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650715246&amp;idx=1&amp;sn=94fa9b95a00fa62349784b3b6bbde5e7&amp;chksm=887da918bf0a200ee77a4ed5179b778f70a3551f05b97296d7f6efdb7ea39fb3ed0debbe460c&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">Elasticsearch 6.3 发布，你们要的 SQL 功能来了</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">3、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650715250&amp;idx=1&amp;sn=4af6bc5bad1bde6136044d0fa88ded5d&amp;chksm=887da904bf0a2012bf5dda9e677d6824e4952a96131ef53f91396f80abdbeece5df353d577b4&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">Spark Summit North America 201806 全部PPT下载[共147个]</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">4、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650715071&amp;idx=1&amp;sn=0128d50e83e5e85e6069763f6cfa5a1a&amp;chksm=887daec9bf0a27dfef88711a6e97efd57504edf451272dd18305df7b25a7e234b01dd63fbd6b&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">干货 | 深入理解 Spark Structured Streaming</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">5、</span><a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650714737&amp;idx=1&amp;sn=74f23fd7666fc6b534c545b98e3c8bb4&amp;chksm=887daf07bf0a2611e8c3343a2e14ae51d76f4db6c8399d14edf465a5836061a63e361afca134&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(67, 149, 245);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;" target="_blank"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">Apache Spark 黑名单(Blacklist)机制介绍</span></a></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">6、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650715048&amp;idx=1&amp;sn=856363bb1024ec3696a219deaf8173fc&amp;chksm=887daedebf0a27c88bfbad9e20a42d9b8f56de4c9c82de56a493c5537dc5282aafab02011472&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">Kafka分区分配策略(Partition Assignment Strategy)</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">7、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650715047&amp;idx=1&amp;sn=d0214293b0a9d2f791a10ba600e9ea5c&amp;chksm=887daed1bf0a27c79467c4afe5d22508b767a34714b904bf7a2a3b5225dcc8e93156df808700&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">Spark SQL 你需要知道的十件事</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">8、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650714936&amp;idx=1&amp;sn=ad7f9fc9b5ea233dcacaa97d42e81578&amp;chksm=887dae4ebf0a2758227098e073cfb25b29f541a5d8520df446ab4207be6c420adc178768b5af&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">干货 | Apache Spark 2.0 作业优化技巧</a></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">9、<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650714687&amp;idx=1&amp;sn=482b757e5f51c01b7c9f30bc11a80804&amp;chksm=887daf49bf0a265f144e4bbbf725dcddcef9171db65e906682fc32b303f4ae77cc6c4c8298df&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(67, 149, 245);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">[干货]大规模数据处理的演变(2003-2017)</a></span></span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;white-space:pre-wrap;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">10、<a href="http://mp.weixin.qq.com/s?__biz=MzA5MTc0NTMwNQ==&amp;mid=2650714952&amp;idx=1&amp;sn=3324e15825a0d4e3bb96856dac85cd22&amp;chksm=887dae3ebf0a2728e7149b575ec44397c593ad471296c8ad658fbf598ca9dc7918af895b3e01&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" target="_blank">干货 | 如何使用功能强大的 Apache Flink SQL</a></span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">11、更多大数据文章欢迎访问<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;text-decoration:underline;color:rgb(2, 30, 170);">https://www.iteblog.com</span>及本公众号(<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(217, 33, 66);">iteblog_hadoop</span></strong>)</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">12、Flink中文文档：</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;text-decoration:underline;color:rgb(2, 30, 170);">http://flink.iteblog.com</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;">13、Carbondata 中文文档<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(2, 30, 170);">：</span></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:12px;text-decoration:underline;color:rgb(2, 30, 170);">http://carbondata.iteblog.com</span></div></div></div></div><p style="margin:0px;padding:0px;max-width:100%;clear:both;box-sizing:border-box;word-wrap:break-word;min-height:1em;color:rgb(51, 51, 51);"><img src="Hadoop技术博文_files/640 [16]" type="image/webp" data-filename="640" height="529" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="auto"/></p>
                </div></div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 