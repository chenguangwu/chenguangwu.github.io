<html>
<head>
  <title>RPC 服务器之【多进程描述符传递】高阶模型 - 掘金</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="535"/>
<h1>RPC 服务器之【多进程描述符传递】高阶模型 - 掘金</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/5/28 14:49</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2019/5/28 14:53</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://juejin.im/post/5b8c9559f265da43606eaeb1"><i>https://juejin.im/post/5b8c9559f265da43606eaeb1</i></a></td></tr>
</table>
</div>
<br/>

<div>
<span><div style="-evernote-webclip:true;"><div><br/></div><div style="text-size-adjust: 100%; font-size: 12px; text-rendering: optimizeLegibility; background-color: rgb(244, 245, 245); word-break: break-word;"><div style="font-size: 12px; word-break: break-word;"><div style="overflow-x:initial;"><div style="box-shadow:rgba(0, 0, 0, 0.05) 0px 1px 2px 0px;background-color:rgb(255, 255, 255);border-radius:2px;box-sizing:border-box;"><div><h1 style="font-size: 2.5rem; margin: 0.67em 0px;"><span style="font-size: 16px; display: inline-block;"><span style="font-size: 2.5rem; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.5; font-weight: 700;">RPC 服务器之【多进程描述符传递】高阶模型</span></span></h1><div style="word-break: break-word; font-size: 15px; overflow-x: hidden;"><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">今天老师要给大家介绍一个比较特别的 RPC 服务器模型，这个模型不同于 Nginx、不同于 Redis、不同于 Apache、不同于 Tornado、不同于 Netty，它的原型是 Node Cluster 的多进程并发模型。这种并发模型 Java 同学看完后是很忧伤的，因为他们永远享受不了。</span></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.5; font-weight: 400;">Nginx 并发模型</span></h2><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">我们知道 Nginx 的并发模型是一个多进程并发模型，它的 Master 进程在绑定监听地址端口后 fork 出了多个 Slave 进程共同竞争处理这个服务端套接字接收到的很多客户端连接。</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1.webp" type="image/webp" data-filename="1.webp" height="381" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="652"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">这多个 Slave 进程会共享同一个处于操作系统内核态的套接字队列，操作系统的网络模块在处理完三次握手后就会将套接字塞进这个队列。这是一个生产者消费者模型，生产者是操作系统的网络模块，消费者是多个 Slave 进程，队列中的对象是客户端套接字。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">这种模型在负载均衡上有一个缺点，那就是套接字分配不均匀，形成了类似于贫富分化的局面，也就是「闲者愈闲，忙者愈忙」的状态。这是因为当多个进程竞争同一个套接字队列时，操作系统采用了 LIFO 的策略，最后一个来 accept 的进程最优先拿到 套接字。越是繁忙的进程越是有更多的机会调用 accept，它能拿到的套接字也就越多。</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1 [1].webp" type="image/webp" data-filename="1.webp" height="250" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="652"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.5; font-weight: 400;">Node Cluster 并发模型</span></h2><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">Node Cluster 为了解决负载均衡问题，它采用了不同的策略。它也是多进程并发模型，Master 进程会 fork 出多个子进程来处理客户端套接字。但是不存在竞争问题，因为负责 accept 套接字的只能是 Master 进程，Slave 进程只负责处理客户端套接字请求。那就存在一个问题，Master 进程拿到的客户端套接字如何传递给 Slave 进程。</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1 [2].webp" type="image/webp" data-filename="1.webp" height="432" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="652"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">这时，神奇的 sendmsg 登场了。它是操作系统提供的系统调用，可以在不同的进程之间传递文件描述符。sendmsg 会搭乘一个特殊的「管道」将 Master 进程的套接字描述符传递到 Slave 进程，Slave 进程通过 recvmsg 系统调用从这个「管道」中将描述符取出来。这个「管道」比较特殊，它是 Unix 域套接字。普通的套接字可以跨机器传输消息，Unix 域套接字只能在同一个机器的不同进程之间传递消息。同管道一样，Unix 域套接字也分为有名套接字和无名套接字，有名套接字会在文件系统指定一个路径名，无关进程之间都可以通过这个路径来访问 Unix 域套接字。而无名套接字一般用于父子进程之间，父进程会通过 socketpair 调用来创建套接字，然后 fork 出来子进程，这样子进程也会同时持有这个套接字的引用。后续父子进程就可以通过这个套接字互相通信。</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1 [3].webp" type="image/webp" data-filename="1.webp" height="472" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="652"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">注意这里的传递描述符，本质上不是传递，而是复制。父进程的描述符并不会在 sendmsg 自动关闭自动消失，子进程收到的描述符和父进程的描述符也不是同一个整数值。但是父子进程的描述符都会指向同一个内核套接字对象。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">有了描述符的传递能力，父进程就可以将 accept 到的客户端套接字轮流传递给多个 Slave 进程，负载均衡的目标就可以顺利实现了。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">接下来我们就是用 Python 代码来撸一遍 Node Cluster 的并发模型。因为 sendmsg 和 recvmsg 方法到了 Python3.5 才内置进来，所以下面的代码需要使用 Python3.5+才可以运行。</span></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">我们看 sendmsg 方法的定义</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="bash" style="font-size: 1rem; padding: 18px 15px 12px; word-break: normal; border-radius: 2px; overflow-x: auto; margin: 0px; background: rgb(255, 245, 245);"><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">socket.sendmsg(buffers[, ancdata[, flags[, address]]])</span></div><div><span style="position: absolute; top: 6px; right: 15px; font-size: 12px; cursor: pointer; transition: color 0.1s ease 0s; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1; font-weight: 400;">复制代码</span></div></div></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">我们只需要关心第二个参数 ancdata，描述符是通过ancdata 参数传递的，它的意思是 「辅助数据」，而 buffers 表示需要传递的消息内容，因为消息内容这里没有意义，所以这个字段可以任意填写，但是必须要有内容，如果没有内容，sendmsg 方法就是一个空调用。</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="bash" style="font-size: 1rem; padding: 18px 15px 12px; word-break: normal; border-radius: 2px; overflow-x: auto; margin: 0px; background: rgb(255, 245, 245);"><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">import socket, struct</span></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def send_fds(sock, fd):</span></div><div><span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">return</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">sock.sendmsg([b</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'x'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">], [(socket.SOL_SOCKET, socket.SCM_RIGHTS, struct.pack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;i&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, fd))])</span></div><div><span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># ancdata 参数是一个三元组的列表，三元组的第一个参数表示网络协议栈级别 level，第二个参数表示辅助数据的类型 type，第三个参数才是携带的数据，level=SOL_SOCKET 表示传递的数据处于 TCP 协议层级，type=SCM_RIGHTS 就表示携带的数据是文件描述符。我们传递的描述符 fd 是一个整数，需要使用 struct 包将它序列化成二进制。</span></div><div><span style="position: absolute; top: 6px; right: 15px; font-size: 12px; cursor: pointer; transition: color 0.1s ease 0s; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1; font-weight: 400;">复制代码</span></div></div></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">再看 recvmsg 方法的定义</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="bash" style="font-size: 1rem; padding: 18px 15px 12px; word-break: normal; border-radius: 2px; overflow-x: auto; margin: 0px; background: rgb(255, 245, 245);"><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">msg, ancdata, flags, addr = socket.recvmsg(bufsize[, ancbufsize[, flags]])</span></div><div><span style="position: absolute; top: 6px; right: 15px; font-size: 12px; cursor: pointer; transition: color 0.1s ease 0s; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1; font-weight: 400;">复制代码</span></div></div></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">同样，我们只需要关心返回的 ancdata 数据，它里面包含了我们需要的文件描述符。但是需要提供消息体的长度和辅助数据的长度参数。辅助数据的长度比较特殊，需要使用 CMSG_LEN 方法来计算，因为辅助数据里面还有我们看不到的额外的头部信息。</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="bash" style="font-size: 1rem; padding: 18px 15px 12px; word-break: normal; border-radius: 2px; overflow-x: auto; margin: 0px; background: rgb(255, 245, 245);"><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">bufsize = 1</span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 消息内容的长度</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">ancbufsize = socket.CMSG_LEN(struct.calcsize(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'i'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">))</span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 辅助数据的长度</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">msg, ancdata, flags, addr = socket.recvmsg(bufsize, ancbufsize)</span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 收取消息</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">level,</span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">type</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, fd_bytes = ancdata[0]</span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 取第一个元祖，注意发送消息时我们传递的是一个三元组的列表</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">fd = struct.unpack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'i'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, fd_bytes)</span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 反序列化</span></div><div><span style="position: absolute; top: 6px; right: 15px; font-size: 12px; cursor: pointer; transition: color 0.1s ease 0s; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1; font-weight: 400;">复制代码</span></div></div></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.5; font-weight: 400;">代码实现</span></h2><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">下面我来献上完整的服务器代码，为了简单起见，我们在 Slave 进程中处理 RPC 请求使用同步模型。</span></div><div style="font-size: 1em; overflow: auto; position: relative;"><div lang="bash" style="font-size: 1rem; padding: 18px 15px 12px; word-break: normal; border-radius: 2px; overflow-x: auto; margin: 0px; background: rgb(255, 245, 245);"><div><span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># coding: utf</span></div><div><span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># sendmsg recvmsg python3.5+才可以支持</span></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">import os</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">import json</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">import struct</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">import socket</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def handle_conn(conn, addr, handlers):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">print</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">(addr,</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;comes&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">while</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">True:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 简单起见，这里就没有使用循环读取了</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        length_prefix = conn.recv(4)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">not length_prefix:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">print</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">(addr,</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;bye&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            conn.close()</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">break</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"> </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 关闭连接，继续处理下一个连接</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        length, = struct.unpack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;I&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, length_prefix)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        body = conn.recv(length)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        request = json.loads(body)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        in_ = request[</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'in'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        params = request[</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'params'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">print</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">(in_, params)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        handler = handlers[in_]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        handler(conn, params)</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def loop_slave(pr, handlers):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">while</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">True:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        bufsize = 1</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        ancsize = socket.CMSG_LEN(struct.calcsize(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'i'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">))</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        msg, ancdata, flags, addr = pr.recvmsg(bufsize, ancsize)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        cmsg_level, cmsg_type, cmsg_data = ancdata[0]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        fd = struct.unpack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'i'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, cmsg_data)[0]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, fileno=fd)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        handle_conn(sock, sock.getpeername(), handlers)</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def ping(conn, params):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    send_result(conn,</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;pong&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, params)</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def send_result(conn, out, result):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    response = json.dumps({</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;out&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">: out,</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;result&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">: result}).encode(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'utf-8'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    length_prefix = struct.pack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;I&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, len(response))</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    conn.sendall(length_prefix)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    conn.sendall(response)</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def loop_master(serv_sock, pws):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    idx = 0</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">while</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">True:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        sock, addr = serv_sock.accept()</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        pw = pws[idx % len(pws)]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 消息数据，whatever</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        msg = [b</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'x'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 辅助数据，携带描述符</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        ancdata = [(</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            socket.SOL_SOCKET,</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            socket.SCM_RIGHTS,</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            struct.pack(</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'i'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, sock.fileno()))]</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        pw.sendmsg(msg, ancdata)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        sock.close() </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 关闭引用</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        idx += 1</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">def prefork(serv_sock, n):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    pws = []</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">for</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">i</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">in</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">range(n):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 开辟父子进程通信「管道」</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        pr, pw = socket.socketpair()</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        pid = os.fork()</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pid &lt; 0: </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># fork error</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">return</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pws</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pid &gt; 0:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 父进程</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            pr.close() </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 父进程不用读</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            pws.append(pw)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">continue</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pid == 0:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 子进程</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            serv_sock.close() </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 关闭引用</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            pw.close() </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># 子进程不用写</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">return</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pr</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(0, 134, 179); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">return</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pws</span></div><div><br/></div><div><br/></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">__name__ ==</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'__main__'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    serv_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    serv_sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    serv_sock.bind((</span><span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;localhost&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">, 8080))</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    serv_sock.listen(1)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">    pws_or_pr = prefork(serv_sock, 10)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">hasattr(pws_or_pr,</span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">'__len__'</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">):</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">if</span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">pws_or_pr:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            loop_master(serv_sock, pws_or_pr)</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">       </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">else</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(153, 153, 136); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;"># fork 全部失败，没有子进程，Game Over</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">            serv_sock.close()</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">   </span> <span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 700;">else</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">:</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        handlers = {</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">           </span> <span style="font-size: 1rem; color: rgb(221, 17, 68); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">&quot;ping&quot;</span><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">: ping</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        }</span></div><div><span style="font-size: 1rem; color: rgb(51, 51, 51); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1.75; font-weight: 400;">        loop_slave(pws_or_pr, handlers)</span></div><div><span style="position: absolute; top: 6px; right: 15px; font-size: 12px; cursor: pointer; transition: color 0.1s ease 0s; color: rgba(140, 140, 140, 0.8); font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; line-height: 1; font-weight: 400;">复制代码</span></div></div></div><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">父进程使用 fork 调用创建了多个子进程，然后又使用 socketpair 调用为每一个子进程都创建一个无名套接字用来传递描述符。父进程使用 roundrobin 策略平均分配接收到的客户端套接字。子进程接收到的是一个描述符整数，需要将描述符包装成套接字对象后方可读写。打印对比发送和接收到的描述符，你会发现它们俩的值并不相同，这是因为 sendmsg 将描述符发送到内核后，内核给描述符指向的内核套接字又重新分配了一个新的描述符对象。</span></div><h2 style="margin-top: 35px; margin-bottom: 10px; padding-bottom: 12px; font-size: 24px; border-bottom: 1px solid rgb(236, 236, 236);"><span style="font-size: 24px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.5; font-weight: 400;">思考题</span></h2><ol style="padding-left:28px;"><li style="margin-bottom:0px;list-style:inherit;padding-left:6px;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">sendmsg/recvmsg 除了可以发送描述符外还可以用来干什么？</span></div></li><li style="margin-bottom:0px;list-style:inherit;padding-left:6px;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">sendmsg/recvmsg 发送接收描述符在内核态具体是如何工作的？</span></div></li></ol><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">本文节选之在线技术小册</span><a href="https://juejin.im/book/5af56a3c518825426642e004" style="margin: initial; background-color: transparent; border-bottom: 1px solid rgb(209, 233, 255); cursor: pointer; font-size: 15px; font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400; color: rgb(2, 105, 200); text-decoration: none;" target="_blank">《深入理解 RPC》</a><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">，感兴趣的读者请继续阅读</span><a href="https://juejin.im/book/5af56a3c518825426642e004" style="margin: initial; background-color: transparent; border-bottom: 1px solid rgb(209, 233, 255); cursor: pointer; font-size: 15px; font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400; color: rgb(2, 105, 200); text-decoration: none;" target="_blank">《深入理解 RPC》</a><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">全书内容。</span></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1 [4].webp" type="image/webp" data-filename="1.webp" height="348" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="652"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin: 22px auto; text-align: center;"><div><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;"><img src="RPC 服务器之【多进程描述符传递】高阶模型 - 掘金_files/1 [5].webp" type="image/webp" data-filename="1.webp" height="258" style="width:auto;height:auto;border-style:none;margin:0px;max-width:100%;visibility:visible;background-color:transparent;background-position:50% center;background-repeat:no-repeat;background-image:none;cursor:zoom-in;max-height:none;" width="258"/></span></div><div style="text-align: center; font-size: 1rem; line-height: 1.6; color: rgb(144, 144, 144); margin-top: 2px;"></div></div><p style="line-height:inherit;margin-top:22px;margin-bottom:22px;"></p><div style="margin-top: 22px; margin-bottom: 22px;"><span style="font-size: 15px; color: rgb(51, 51, 51); font-family: -apple-system, system-ui, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.75; font-weight: 400;">阅读更多深度技术文章，微信扫一扫上面的二维码或者搜索关注公众号「码洞」或 「codehole」</span></div></div></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 