<html>
<head>
  <title>MySQL索引与Index Condition Pushdown</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3340"/>
<h1>MySQL索引与Index Condition Pushdown</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/10/12 14:03</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.codinglabs.org/articles/index-condition-pushdown.html"><i>http://blog.codinglabs.org/articles/index-condition-pushdown.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="font-family:sans-serif;text-size-adjust:100%;"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, &quot;WenQuanYi Micro Hei&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, sans-serif;"><div><div><div>
            <p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">大约在两年前，我写了<a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html" style="text-decoration:none;color:rgb(0, 136, 204);">一篇关于MySQL索引的文章</a>。最近有同学在文章的评论中对文章的内容提出质疑，质疑主要集中在联合索引的使用方式上。在那篇文章中，我说明联合索引是将各个索引字段做字符串连接后作为key，使用时将整体做前缀匹配。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">而这名同学在<a href="https://mariadb.com/kb/en/index-condition-pushdown/" style="text-decoration:none;color:rgb(0, 136, 204);">这个页面</a>找到了如下一句话：index condition pushdown is usually useful with multi-column indexes: the first component(s) is what index access is done for, the subsequent have columns that we read and check conditions on。从而认为联合索引的使用方式与文中不符。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">实际上，这个页面所讲述的是在MariaDB 5.3.3（MySQL是在5.6）开始引入的一种叫做Index Condition Pushdown（以下简称ICP）的查询优化方式。由于本身不是一个层面的东西，前文中说的是Index Access，而这里是Query Optimization，所以并不构成对前文正确性的影响。在写前文时，MySQL还没有ICP，所以文中没有涉及相关内容，但考虑到新版本的MariaDB或MySQL中ICP的启用确实影响了一些查询行为的外在表现。所以决定写这篇文章详细讲述一下ICP的原理以及对索引使用方式的优化。</p>
<h1 style="font-size:2em;font-weight:normal;color:rgb(42, 42, 42);">实验</h1>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">先从一个简单的实验开始直观认识ICP的作用。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">安装数据库</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">首先需要安装一个支持ICP的MariaDB或MySQL数据库。我使用的是MariaDB 5.5.34，如果是使用MySQL则需要5.6版本以上。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">Mac环境下可以通过brew安装：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">brew install mairadb</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">其它环境下的安装请参考<a href="https://www.mariadb.com/kb/en/getting-installing-and-upgrading-mariadb/" style="text-decoration:none;color:rgb(0, 136, 204);">MariaDB官网关于下载安装的文档</a>。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">导入示例数据</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">与前文一样，我们使用<a href="https://launchpad.net/test-db/" style="text-decoration:none;color:rgb(0, 136, 204);">Employees Sample Database</a>，作为示例数据库。完整示例数据库的下载地址为：<a href="https://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2" style="text-decoration:none;color:rgb(0, 136, 204);">https://launchpad.net/test-db/employees-db-1/1.0.6/+download/employees_db-full-1.0.6.tar.bz2</a>。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">将下载的压缩包解压后，会看到一系列的文件，其中employees.sql就是导入数据的命令文件。执行</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">mysql </span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(38, 139, 210);">h</span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">host</span><span style="color:rgb(131, 148, 150);">]</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(38, 139, 210);">u</span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">user</span><span style="color:rgb(131, 148, 150);">]</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(38, 139, 210);">p </span><span style="color:rgb(131, 148, 150);">&lt;</span><span style="color:rgb(38, 139, 210);"> employees</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">sql</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">就可以完成建库、建表和load数据等一系列操作。此时数据库中会多一个叫做employees的数据库。库中的表如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(181, 137, 0);">MariaDB</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">]&gt;</span><span style="color:rgb(38, 139, 210);"> SHOW TABLES</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+---------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Tables_in_employees</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+---------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> departments         </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> dept_emp            </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> dept_manager        </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> employees           </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> salaries            </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> titles              </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+---------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">6</span><span style="color:rgb(38, 139, 210);"> rows </span><span style="color:rgb(203, 75, 22);">in</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">0.00</span><span style="color:rgb(38, 139, 210);"> sec</span><span style="color:rgb(131, 148, 150);">)</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">我们将使用employees表做实验。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">建立联合索引</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">employees表包含雇员的基本信息，表结构如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(181, 137, 0);">MariaDB</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">]&gt;</span><span style="color:rgb(38, 139, 210);"> DESC employees</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------------+---------------+------+-----+---------+-------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Field</span><span style="color:rgb(38, 139, 210);">      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Type</span><span style="color:rgb(38, 139, 210);">          </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Null</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Key</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Default</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Extra</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------------+---------------+------+-----+---------+-------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> emp_no     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">int</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">11</span><span style="color:rgb(131, 148, 150);">)</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> PRI </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> birth_date </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> date          </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> varchar</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">14</span><span style="color:rgb(131, 148, 150);">)</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> last_name  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> varchar</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">16</span><span style="color:rgb(131, 148, 150);">)</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> gender     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">enum</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">'M'</span><span style="color:rgb(131, 148, 150);">,</span><span style="color:rgb(42, 161, 152);">'F'</span><span style="color:rgb(131, 148, 150);">)</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> hire_date  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> date          </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NO   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> NULL    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------------+---------------+------+-----+---------+-------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">6</span><span style="color:rgb(38, 139, 210);"> rows </span><span style="color:rgb(203, 75, 22);">in</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">0.01</span><span style="color:rgb(38, 139, 210);"> sec</span><span style="color:rgb(131, 148, 150);">)</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这个表默认只有一个主索引，因为ICP只能作用于二级索引，所以我们建立一个二级索引：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">ALTER TABLE employees</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">employees ADD INDEX first_name_last_name </span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(38, 139, 210);">first_name</span><span style="color:rgb(131, 148, 150);">,</span><span style="color:rgb(38, 139, 210);"> last_name</span><span style="color:rgb(131, 148, 150);">);</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这样就建立了一个first_name和last_name的联合索引。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">查询</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">为了明确看到查询性能，我们启用profiling并关闭query cache：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">SET profiling </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">SET query_cache_type </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">SET GLOBAL query_cache_size </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0</span><span style="color:rgb(131, 148, 150);">;</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">然后我们看下面这个查询：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(181, 137, 0);">MariaDB</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">]&gt;</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+--------+------------+------------+-----------+--------+------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> emp_no </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> birth_date </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> last_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> gender </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> hire_date  </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+--------+------------+------------+-----------+--------+------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">254642</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1959</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">01</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">17</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Botman</span><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> M      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1989</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">11</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">24</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">471495</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1960</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">09</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">24</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Dymetman</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> M      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1988</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">06</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">09</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">211941</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1962</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">08</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">11</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Hofman</span><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> M      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1993</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">12</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">30</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">217707</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1962</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">09</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">05</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Lichtman</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> F      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1987</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">11</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">20</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">486361</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1957</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">10</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">15</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Oberman</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> M      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1988</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">09</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">06</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">457469</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1959</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">07</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">15</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Mary</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Weedman</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> M      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">1996</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">11</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">21</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+--------+------------+------------+-----------+--------+------------+</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">根据MySQL索引的前缀匹配原则，两者对索引的使用是一致的，即只有first_name采用索引，last_name由于使用了模糊前缀，没法使用索引进行匹配。我将查询联系执行三次，结果如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Query_ID</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Duration</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Query</span><span style="color:rgb(38, 139, 210);">                                                                     </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">38</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.00084400</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">39</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.00071800</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">40</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.00089600</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">然后我们关闭ICP：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">SET optimizer_switch</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'index_condition_pushdown=off'</span><span style="color:rgb(131, 148, 150);">;</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">在运行三次相同的查询，结果如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Query_ID</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Duration</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Query</span><span style="color:rgb(38, 139, 210);">                                                                     </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">42</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.00264400</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">43</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.01418900</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(42, 161, 152);">44</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">0.00234200</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+----------+------------+---------------------------------------------------------------------------+</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">有意思的事情发生了，关闭ICP后，同样的查询，耗时是之前的三倍以上。下面我们用explain看看两者有什么区别：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(181, 137, 0);">MariaDB</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">]&gt;</span><span style="color:rgb(38, 139, 210);"> EXPLAIN SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-----------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> id   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> select_type </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> table     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> type </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> possible_keys        </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> key                  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> key_len </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">ref</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> rows </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Extra</span><span style="color:rgb(38, 139, 210);">                 </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-----------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(42, 161, 152);">1</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SIMPLE      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> employees </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">ref</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name_last_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name_last_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">44</span><span style="color:rgb(38, 139, 210);">      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">const</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(42, 161, 152);">224</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Using</span><span style="color:rgb(38, 139, 210);"> index condition </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-----------------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">1</span><span style="color:rgb(38, 139, 210);"> row </span><span style="color:rgb(203, 75, 22);">in</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">0.00</span><span style="color:rgb(38, 139, 210);"> sec</span><span style="color:rgb(131, 148, 150);">)</span></li></ol></pre>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(181, 137, 0);">MariaDB</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">[</span><span style="color:rgb(38, 139, 210);">employees</span><span style="color:rgb(131, 148, 150);">]&gt;</span><span style="color:rgb(38, 139, 210);"> EXPLAIN SELECT </span><span style="color:rgb(131, 148, 150);">*</span><span style="color:rgb(38, 139, 210);"> FROM employees WHERE first_name</span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(42, 161, 152);">'Mary'</span><span style="color:rgb(38, 139, 210);"> AND last_name LIKE </span><span style="color:rgb(42, 161, 152);">'%man'</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> id   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> select_type </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> table     </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> type </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> possible_keys        </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> key                  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> key_len </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">ref</span><span style="color:rgb(38, 139, 210);">   </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> rows </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Extra</span><span style="color:rgb(38, 139, 210);">       </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(42, 161, 152);">1</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> SIMPLE      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> employees </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">ref</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name_last_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> first_name_last_name </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">44</span><span style="color:rgb(38, 139, 210);">      </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">const</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);">  </span><span style="color:rgb(42, 161, 152);">224</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Using</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">where</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">|</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">+------+-------------+-----------+------+----------------------+----------------------+---------+-------+------+-------------+</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">1</span><span style="color:rgb(38, 139, 210);"> row </span><span style="color:rgb(203, 75, 22);">in</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">0.00</span><span style="color:rgb(38, 139, 210);"> sec</span><span style="color:rgb(131, 148, 150);">)</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">前者是开启ICP，后者是关闭ICP。可以看到区别在于Extra，开启ICP时，用的是Using index condition；关闭ICP时，是Using where。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">其中Using index condition就是ICP提高查询性能的关键。下一节说明ICP提高查询性能的原理。</p>
<h1 style="font-size:2em;font-weight:normal;color:rgb(42, 42, 42);">原理</h1>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">ICP的原理简单说来就是将可以利用索引筛选的where条件在存储引擎一侧进行筛选，而不是将所有index access的结果取出放在server端进行where筛选。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">以上面的查询为例，在没有ICP时，首先通过索引前缀从存储引擎中读出224条first_name为Mary的记录，然后在server段用where筛选last_name的like条件；而启用ICP后，由于last_name的like筛选可以通过索引字段进行，那么存储引擎内部通过索引与where条件的对比来筛选掉不符合where条件的记录，这个过程不需要读出整条记录，同时只返回给server筛选后的6条记录，因此提高了查询性能。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">下面通过图两种查询的原理详细解释。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">关闭ICP</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="MySQL索引与Index Condition Pushdown_files/Image.png" type="image/png" data-filename="Image.png" height="335" style="border:0px;" width="608"/></p>

<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">在不支持ICP的系统下，索引仅仅作为data access使用。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">开启ICP</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="MySQL索引与Index Condition Pushdown_files/Image [1].png" type="image/png" data-filename="Image.png" height="335" style="border:0px;" width="590"/></p>

<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">在ICP优化开启时，在存储引擎端首先用索引过滤可以过滤的where条件，然后再用索引做data access，被index condition过滤掉的数据不必读取，也不会返回server端。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">注意事项</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">有几个关于ICP的事情要注意：</p>
<ul>
<li style="line-height:1.8em;margin:7px 0px;color:rgb(90, 90, 90);">ICP只能用于二级索引，不能用于主索引。</li>
<li style="line-height:1.8em;margin:7px 0px;color:rgb(90, 90, 90);">也不是全部where条件都可以用ICP筛选，如果某where条件的字段不在索引中，当然还是要读取整条记录做筛选，在这种情况下，仍然要到server端做where筛选。</li>
<li style="line-height:1.8em;margin:7px 0px;color:rgb(90, 90, 90);">ICP的加速效果取决于在存储引擎内通过ICP筛选掉的数据的比例。</li>
</ul>
<h1 style="font-size:2em;font-weight:normal;color:rgb(42, 42, 42);">参考</h1>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">[1] <a href="https://mariadb.com/kb/en/index-condition-pushdown/" style="text-decoration:none;color:rgb(0, 136, 204);">https://mariadb.com/kb/en/index-condition-pushdown/</a></p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">[2] <a href="http://dev.mysql.com/doc/refman/5.6/en/index-condition-pushdown-optimization.html" style="text-decoration:none;color:rgb(0, 136, 204);">http://dev.mysql.com/doc/refman/5.6/en/index-condition-pushdown-optimization.html</a></p>

        </div></div></div></div></div></div>
</div>
</span>
</div></body></html> 