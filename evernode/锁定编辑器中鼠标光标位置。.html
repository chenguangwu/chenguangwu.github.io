<html>
<head>
  <title>锁定编辑器中鼠标光标位置。</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8712"/>
<h1>锁定编辑器中鼠标光标位置。</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/3/7 16:53</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2018/3/7 17:16</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div>&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;<a href="http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</a>&quot;&gt;</div><div>&lt;html xmlns=&quot;<a href="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</a>&quot;&gt;</div><div>&lt;head&gt;</div><div>    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</div><div>    &lt;title&gt;无标题文档&lt;/title&gt;</div><div>    &lt;script type=&quot;text/javascript&quot; src=&quot;<a href="http://www.w3school.com.cn/jquery/jquery.js">http://www.w3school.com.cn/jquery/jquery.js</a></div><div>&quot;&gt;&lt;/script&gt;</div><div>    &lt;style&gt;</div><div>        p{ margin:0; padding:0;}</div><div>        img{ outline:none;}</div><div>        #o{ width:300px!important; height:auto!important; border:1px solid #333;</div><div>            overflow-x: hidden;word-wrap: break-word;outline:0px; min-height:220px;}</div><div>    &lt;/style&gt;</div><div>    &lt;script&gt;</div><div>        $(function(){</div><div>            $('#btn').click(function(){</div><div>                $('#o').focus();</div><div>                var str=&quot;SS:AA182/Y/21MAR/PVGLAX/NN1 &lt;br&gt;SS:AA183/Y/01APR/LAXPVG/NN1&quot;;</div><div>                _insertStr(str);</div><div>                </div><div>            });</div><div><br/></div><div>            $('#t').click(function(){</div><div>                $('#div1').html($('#o').html());</div><div>            });</div><div>            $('#ttbtn').click(function(){</div><div>                alert($('#tt').val());</div><div>            });</div><div>            $(&quot;#img&quot;).click(function(){</div><div>            });</div><div>            $(&quot;#o&quot;).bind({</div><div>                mouseup:saveRange,</div><div>                change:saveRange</div><div>            })</div><div>        });</div><div>        var _range;</div><div>        function saveRange(){</div><div>            var selection= window.getSelection ? window.getSelection() : document.selection;</div><div>            var range= selection.createRange ? selection.createRange() : selection.getRangeAt(0);</div><div>            _range = range;</div><div>        }</div><div>        //锁定编辑器中鼠标光标位置。。</div><div>        function _insertStr(str){</div><div>            if (!window.getSelection){</div><div>                document.getElementById('o').focus();</div><div>                var selection= window.getSelection ? window.getSelection() : document.selection;</div><div>                var range= selection.createRange ? selection.createRange() : selection.getRangeAt(0);</div><div>                range.pasteHTML(str);</div><div>                range.collapse(false);</div><div>                range.select();</div><div>            }else{</div><div>                document.getElementById('o').focus();</div><div>                var selection= window.getSelection ? window.getSelection() : document.selection;</div><div>                selection.addRange(_range);</div><div>                range = _range;</div><div>                range.collapse(false);</div><div>                var hasR = range.createContextualFragment(str);</div><div>                var hasR_lastChild = hasR.lastChild;</div><div>                while (hasR_lastChild &amp;&amp; hasR_lastChild.nodeName.toLowerCase() == &quot;br&quot; &amp;&amp; hasR_lastChild.previousSibling &amp;&amp; hasR_lastChild.previousSibling.nodeName.toLowerCase() == &quot;br&quot;) {</div><div>                    var e = hasR_lastChild;</div><div>                    hasR_lastChild = hasR_lastChild.previousSibling;</div><div>                    hasR.removeChild(e)</div><div>                }</div><div>                range.insertNode(hasR);</div><div>                if (hasR_lastChild) {</div><div>                    range.setEndAfter(hasR_lastChild);</div><div>                    range.setStartAfter(hasR_lastChild)</div><div>                }</div><div>                selection.removeAllRanges();</div><div>                selection.addRange(range)</div><div>            }</div><div>        }</div><div>        //监控粘贴(ctrl+v),如果是粘贴过来的东东，则替换多余的html代码，只保留&lt;br&gt;</div><div>        function pasteHandler(){</div><div>            setTimeout(function(){</div><div>                var content = document.getElementById(&quot;o&quot;).innerHTML;</div><div>                valiHTML=[&quot;br&quot;];</div><div>                content=content.replace(/_moz_dirty=&quot;&quot;/gi, &quot;&quot;).replace(/\[/g, &quot;[[-&quot;).replace(/\]/g, &quot;-]]&quot;).replace(/&lt;\/ ?tr[^&gt;]*&gt;/gi, &quot;[br]&quot;).replace(/&lt;\/ ?td[^&gt;]*&gt;/gi, &quot;&amp;nbsp;&amp;nbsp;&quot;).replace(/&lt;(ul|dl|ol)[^&gt;]*&gt;/gi, &quot;[br]&quot;).replace(/&lt;(li|dd)[^&gt;]*&gt;/gi, &quot;[br]&quot;).replace(/&lt;p [^&gt;]*&gt;/gi, &quot;[br]&quot;).replace(new RegExp(&quot;&lt;(/?(?:&quot; + valiHTML.join(&quot;|&quot;) + &quot;)[^&gt;]*)&gt;&quot;, &quot;gi&quot;), &quot;[$1]&quot;).replace(new RegExp('&lt;span([^&gt;]*class=&quot;?at&quot;?[^&gt;]*)&gt;', &quot;gi&quot;), &quot;[span$1]&quot;).replace(/&lt;[^&gt;]*&gt;/g, &quot;&quot;).replace(/\[\[\-/g, &quot;[&quot;).replace(/\-\]\]/g, &quot;]&quot;).replace(new RegExp(&quot;\\[(/?(?:&quot; + valiHTML.join(&quot;|&quot;) + &quot;|img|span)[^\\]]*)\\]&quot;, &quot;gi&quot;), &quot;&lt;$1&gt;&quot;);</div><div>                if(!/firefox/.test(navigator.userAgent.toLowerCase())){</div><div>                    content=content.replace(/\r?\n/gi, &quot;&lt;br&gt;&quot;);</div><div>                }</div><div>                document.getElementById(&quot;o&quot;).innerHTML=content;</div><div>            },1)</div><div>        }</div><div>    &lt;/script&gt;</div><div>&lt;/head&gt;</div><div>&lt;body&gt;</div><div>&lt;div id=&quot;o&quot; contenteditable=&quot;true&quot; onblur=&quot;blur(this);&quot;&gt;&lt;/div&gt;</div><div>&lt;input type=&quot;button&quot; value=&quot;查看&quot; id=&quot;btn&quot;/&gt;</div><div>&lt;div id=&quot;div1&quot;&gt;&lt;/div&gt;</div><div>&lt;textarea id=&quot;tt&quot; style=&quot;width:200px; height:200px;&quot;&gt;&lt;/textarea&gt;</div><div>&lt;input type=&quot;button&quot; id=&quot;ttbtn&quot; value=&quot;测试&quot;&gt;&lt;/body&gt;</div><div>&lt;script type=&quot;text/javascript&quot;&gt;</div><div>    var edt = document.getElementById(&quot;o&quot;);</div><div>    if(edt.addEventListener){</div><div>        edt.addEventListener(&quot;paste&quot;,pasteHandler,false);</div><div>    }else{</div><div>        edt.attachEvent(&quot;onpaste&quot;,pasteHandler);</div><div>    }</div><div>&lt;/script&gt;</div><div>&lt;/body&gt;</div><div>&lt;/html&gt;</div></span>
</div></body></html> 