<html>
<head>
  <title>你真的很熟分布式和事务吗？ - foreach_break - 博客园</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5711"/>
<h1>你真的很熟分布式和事务吗？ - foreach_break - 博客园</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/12/15 15:17</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_0"><i>http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_0</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-family:&quot;PingFang SC&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color:rgb(0, 0, 0);background:rgb(242, 242, 242);font-size:14px;"><div><div style="text-align:left;overflow:hidden;min-width:auto;"><div style="text-overflow:ellipsis;overflow:hidden;word-break:break-all;"><div><div><div style="text-overflow:ellipsis;overflow:hidden;word-break:break-all;background:rgb(248, 248, 248);border-radius:7px;color:rgb(51, 51, 51);"><div>
		<h1 style="margin:0px;padding:0px;clear:both;font-size:1.2em;font-weight:bold;line-height:2em;width:100%;margin-left:0px;border-bottom:1px dashed rgb(153, 153, 153);float:left;">
			<a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html" style="margin:0px;padding:0px;text-decoration:none;color:rgb(47, 47, 47);transition:all 0.2s linear 0s;">你真的很熟分布式和事务吗？</a>
		</h1>
		<div style="margin:0px;padding:0px;clear:both;"></div>
		<div style="margin:0px;padding:15px 2px 5px 5px;line-height:1.5;color:rgb(0, 0, 0);border-bottom:1px solid rgb(204, 204, 204);"><div style="margin:0px;padding:4px 10px;border:1px solid rgb(204, 204, 204);background:rgb(238, 238, 238);min-width:200px;font-size:12px;"><p style="margin:0px;padding:5px 0px;text-indent:2em;">	<b style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;cursor:pointer;" title="收起">本文目录 [-点此收起]</b></p><div style="margin:0px;padding:0px;padding-left:2em;display:block;"> <li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_0" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">微吐槽</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_1" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">集群中存活的节点与同步</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_2" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">一个bigdata问题</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_3" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">最多处理一次（At most once）</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_4" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">最少处理一次（At least once）</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_5" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">仅处理一次（Exactly once） </a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_6" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:20px;">Transaction</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_7" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:20px;">Opaque-Transaction</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_8" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:20px;">两阶段提交</a></li><li style="margin:0px;padding:0px;list-style:none;list-style-type:none;margin-bottom:0px;line-height:160%;"><a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#_9" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;line-height:160%;margin-left:0px;">结语</a></li></div></div>
			<div style="margin:0px;padding:0px;margin-bottom:20px;word-break:break-word;"><h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">微吐槽</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">hello,world.</p>
<hr style="border-right-color:initial;margin:2em 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;padding:0px;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);"/>
<p style="padding:0px;margin:10px auto;text-indent:0px;">不想了，我等码农，还是看看怎么来处理分布式系统中的事务这个老大难吧！</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">本文略长，读者需要有一定耐心，如果你是高级码农或者架构师级别，你可以跳过。<br style="margin:0px;padding:0px;"/>
本文注重实战或者实现，不涉及CAP，略提ACID。<br style="margin:0px;padding:0px;"/>
本文适合基础分布式程序员：</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">本文会涉及集群中节点的failover和recover问题.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">本文会涉及事务及不透明事务的问题.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">本文会提到微博和tweeter，并引出一个大数据问题.</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">由于分布式这个话题太大，事务这个话题也太大，我们从一个集群的一个小小节点开始谈起。</p>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">集群中存活的节点与同步</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">分布式系统中，如何判断一个节点（node）是否存活？<br style="margin:0px;padding:0px;"/>
kafka这样认为：</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">此节点和zookeeper能喊话.（Keep sessions with zookeeper through heartbeats.）</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">此节点如果是个从节点，必须能够尽可能忠实地反映主节点的数据变化。<br style="margin:0px;padding:0px;"/>
也就是说，必须能够在主节点写了新数据后，及时复制这些变化的数据，所谓及时，不能拉下太多哦.</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">那么，符合上面两个条件的节点就可以认为是存活的，也可以认为是同步的（in-sync）.</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">关于第1点，大家对心跳都很熟悉，那么我们可以这样认为某个节点不能和zookeeper喊话了：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;">zookeeper-node:
var timer = 
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">timer</span>()
.<span style="margin:0px;padding:0px;">setInterval</span>(<span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">10</span>sec)
.<span style="margin:0px;padding:0px;">onTime</span>(slave-nodes,<span style="margin:0px;padding:0px;">function</span>(slave-nodes){
    slave-nodes.<span style="margin:0px;padding:0px;">forEach</span>( node -&gt; {
        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">boolean</span></span> isAlive = node.<span style="margin:0px;padding:0px;">heartbeatACK</span>(<span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">15</span>sec);
        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(!isAlive) {
            node.<span style="margin:0px;padding:0px;">numNotAlive</span> += <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">1</span></span>;
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(node.<span style="margin:0px;padding:0px;">numNotAlive</span> &gt;= <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">3</span></span>) {
                node.<span style="margin:0px;padding:0px;">declareDeadOrFailed</span>();
                slave-nodes.<span style="margin:0px;padding:0px;">remove</span>(node);
                
                <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//回调也可 leader-node-app.notifyNodeDeadOrFailed(node)</span></span>
                
            }
        }<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">else</span></span> 
        node.<span style="margin:0px;padding:0px;">numNotAlive</span> = <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">0</span></span>;
    });
});

timer.<span style="margin:0px;padding:0px;">run</span>();

<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//你可以回调也可以像下面这样简单的计时判断</span></span>
leader-node-app:
var timer = 
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">timer</span>()
.<span style="margin:0px;padding:0px;">setInterval</span>(<span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">10</span>sec)
.<span style="margin:0px;padding:0px;">onTime</span>(slave-nodes,<span style="margin:0px;padding:0px;">function</span>(slave-nodes){
    slave-nodes.<span style="margin:0px;padding:0px;">forEach</span>(node -&gt; {
        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(node.<span style="margin:0px;padding:0px;">isDeadOrFailed</span>) {

        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//node不能和zookeeper喊话了</span></span>
            
        }
    });
});

timer.<span style="margin:0px;padding:0px;">run</span>();</code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">关于第二点，要稍微复杂点了，怎么搞呢？<br style="margin:0px;padding:0px;"/>
来这么分析：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">数据 messages.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">操作 op-log.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">偏移 position/offset.</li>
</ul>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">// 1. 先考虑messages</span></span>
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">// 2. 再考虑log的postion或者offset</span></span>
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">// 3. 考虑msg和off都记录在同源数据库或者存储设备上.(database or storage-device.)</span></span>
var timer = 
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">timer</span>()
.<span style="margin:0px;padding:0px;">setInterval</span>(<span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">10</span>sec)
.<span style="margin:0px;padding:0px;">onTime</span>(slave-nodes,<span style="margin:0px;padding:0px;">function</span>(nodes){
    var core-of-cpu = <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">8</span></span>;
    <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//嫌慢就并发呗 mod hash go!</span></span>
    nodes.<span style="margin:0px;padding:0px;">groupParallel</span>(core-of-cpu)
    .<span style="margin:0px;padding:0px;">forEach</span>(node -&gt; {
        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">boolean</span></span> nodeSucked = <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">false</span></span>;

        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(node.<span style="margin:0px;padding:0px;">ackTimeDiff</span> &gt; <span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">30</span>sec) {
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//30秒内没有回复，node卡住了</span></span>
            nodeSucked = <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">true</span></span>;
        }
        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(node.<span style="margin:0px;padding:0px;">logOffsetDiff</span> &gt; <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">100</span></span>) {
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//node复制跟不上了，差距超过100条数据</span></span>
            nodeSucked = <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">true</span></span>;
        }

        <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">if</span></span>(nodeSucked) {
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//总之node“死”掉了，其实到底死没死，谁知道呢？network-error在分布式系统中或者节点失败这个事情是正常现象.</span></span>
            node.<span style="margin:0px;padding:0px;">declareDeadOrFailed</span>();
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//不和你玩啦，集群不要你了</span></span>
            nodes.<span style="margin:0px;padding:0px;">remove</span>(node);
            <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">//该怎么处理呢，抛个事件吧.</span></span>
            fire-event-<span style="margin:0px;padding:0px;">NodeDeadOrFailed</span>(node);
        }
    });
});

timer.<span style="margin:0px;padding:0px;">run</span>();</code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">上面的节点的状态管理一般由zookeeper来做，leader或者master节点也会维护那么点状态。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">那么应用中的leader或者master节点，只需要从zookeeper拉状态就可以，同时，上面的实现是不是一定最佳呢？不是的，而且多数操作可以合起来，但为了描述节点是否存活这个事儿，咱们这么写没啥问题。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">节点死掉、失败、不同步了，咋处理呢？</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">好嘛，终于说到failover和recover了，那failover比较简单，因为还有其它的slave节点在，不影响数据读取。</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">同时多个slave节点失败了？<br style="margin:0px;padding:0px;"/>
没有100%的可用性.数据中心和机房瘫痪、网络电缆切断、hacker入侵删了你的根，总之你rp爆表了.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">如果主节点失败了，那master-master不行嘛？<br style="margin:0px;padding:0px;"/>
keep-alived或者LVS或者你自己写failover吧.<br style="margin:0px;padding:0px;"/>
高可用架构（HA）又是个大件儿了，此文不展开了。</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">我们来关注下recover方面的东西，这里把视野打开点，不仅关注slave节点重启后追log来同步数据，我们看下在实际应用中，数据请求（包括读、写、更新）失败怎么办？</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">大家可能都会说，重试（retry）呗、重放（replay）呗或者干脆不管了呗！<br style="margin:0px;padding:0px;"/>
行，都行，这些都是策略，但具体怎么个搞法，你真的清楚了？</p>
<hr style="border-right-color:initial;margin:2em 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;padding:0px;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);"/>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">一个bigdata问题</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">我们先摆个探讨的背景：</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">问题：消息流，比如微博的微博（真绕），源源不断地流进我们的应用中，要处理这些消息，有个需求是这样的：<br style="margin:0px;padding:0px;"/><br style="margin:0px;padding:0px;"/>
Reach is the number of unique people exposed to a URL on Twitter.<br style="margin:0px;padding:0px;"/>
<br style="margin:0px;padding:0px;"/>那么，统计一下3小时内的本条微博（url）的reach总数。</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">怎么解决呢？</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">把某时间段内转发过某条微博（url）的人拉出来，把这些人的粉丝拉出来，去掉重复的人，然后求总数，就是要求的reach.</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">为了简单，我们忽略掉日期，先看看这个方法行不行：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/** ---------------------------------</span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* 1. 求出转发微博(url)的大V. </span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* __________________________________*/</span></span>

方法 ：getUrlToTweetersMap(String url_id)

SQL ： <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 数据库A，表url_user存储了转发某url的user */</span></span>
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">SELECT</span></span> url_user.user_id <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">as</span></span> tweeter_id
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">FROM</span></span> url_user
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">WHERE</span></span> url_user.url_id = ${url_id}

返回 ：[user_1,...,user_m]</code></pre></div>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;">

<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/** ---------------------------------</span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* 2. 求出大V的粉丝 </span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* __________________________________*/</span></span>

方法 : getFollowers(String tweeter_id);

SQL :   <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 数据库B */</span></span>
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">SELECT</span></span> <span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">users</span>.<span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">id</span> <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">as</span></span> user_id
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">FROM</span></span> <span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">users</span>
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">WHERE</span></span> <span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">users</span>.followee_id = ${tweeter_id}

返回：tweeter的粉丝</code></pre></div>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;">
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/** ---------------------------------</span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* 3. 求出Reach</span></span><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">
</span><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">* __________________________________*/</span></span>

var url = queryArgs.getUrl();
var tweeters = getUrlToTweetersMap();
var result = <span style="margin:0px;padding:0px;">new</span> HashMap&lt;String,Integer&gt;();
tweeters.forEach(t -&gt; {
    // 你可以批量in + 并发读来优化下面方法的性能
    var followers = getFollowers(t.tweeter_id);

    followers.forEach(f -&gt; {
        //hash去重
        result.put(f.user_id,<span style="margin:0px;padding:0px;">1</span>);
    });
});

//Reach
<span style="margin:0px;padding:0px;">return</span> result.size();</code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">顶呱呱，无论如何，求出了Reach啊！</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">其实这又引出了一个很重要的问题，也是很多大谈框架、设计、模式却往往忽视的问题：性能和数据库建模的关系。</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">数据量有多大？<br style="margin:0px;padding:0px;"/>
不知道读者有木有对这个问题的数据库I/O有点想法，或者虎躯一震呢？<br style="margin:0px;padding:0px;"/>
Computing reach is too intense for a single machine – it can require thousands of database calls and tens of millions of tuples.<br style="margin:0px;padding:0px;"/>
在上面的数据库设计中避免了JOIN，为了提高求大V粉丝的性能，可以将一批大V作为batch/bulk，然后多个batch并发读，誓死搞死数据库。<br style="margin:0px;padding:0px;"/>
这里将微博到转发者表所在的库，与粉丝库分离，如果数据更大怎么办？<br style="margin:0px;padding:0px;"/>
库再分表...<br style="margin:0px;padding:0px;"/>
OK，假设你已经非常熟悉传统关系型数据库的分库分表及数据路由（读路径的聚合、写路径的分发）、或者你对于sharding技术也很熟悉、或者你良好的结合了HBase的横向扩展能力并有一致性策略来解决其二级索引问题.<br style="margin:0px;padding:0px;"/>
总之，存储和读取的问题假设你已经解决了，那么分布式计算呢？</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">微博这种应用，人与人之间的关系成图状（网），你怎么建模存储？而不仅仅对应这个问题，比如：<br style="margin:0px;padding:0px;"/>
<em style="margin:0px;padding:0px;">某人的好友的好友可能和某人有几分相熟？</em></li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">看看用storm怎么来解决分布式计算，并提供流式计算的能力：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">// url到大V -&gt; 数据库1</span></span>
TridentState urlToTweeters =
    topology.<span style="margin:0px;padding:0px;">newStaticState</span>(<span style="margin:0px;padding:0px;">getUrlToTweetersState</span>());
<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">// 大V到粉丝 -&gt; 数据库2</span></span>
TridentState tweetersToFollowers =
    topology.<span style="margin:0px;padding:0px;">newStaticState</span>(<span style="margin:0px;padding:0px;">getTweeterToFollowersState</span>());

topology.<span style="margin:0px;padding:0px;">newDRPCStream</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;reach&quot;</span></span>)
    .<span style="margin:0px;padding:0px;">stateQuery</span>(urlToTweeters, <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;args&quot;</span></span>), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">MapGet</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;tweeters&quot;</span></span>))
    .<span style="margin:0px;padding:0px;">each</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;tweeters&quot;</span></span>), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">ExpandList</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;tweeter&quot;</span></span>))
    .<span style="margin:0px;padding:0px;">shuffle</span>() <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 大V的粉丝很多，所以需要分布式处理*/</span></span>
    .<span style="margin:0px;padding:0px;">stateQuery</span>(tweetersToFollowers, <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;tweeter&quot;</span></span>), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">MapGet</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;followers&quot;</span></span>))
    .<span style="margin:0px;padding:0px;">parallelismHint</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">200</span></span>) <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 粉丝很多，所以需要高并发 */</span></span> 
    .<span style="margin:0px;padding:0px;">each</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;followers&quot;</span></span>), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">ExpandList</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;follower&quot;</span></span>))
    .<span style="margin:0px;padding:0px;">groupBy</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;follower&quot;</span></span>))
    .<span style="margin:0px;padding:0px;">aggregate</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">One</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;one&quot;</span></span>)) <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 去重 */</span></span>
    .<span style="margin:0px;padding:0px;">parallelismHint</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(0, 167, 207);">20</span></span>)
    .<span style="margin:0px;padding:0px;">aggregate</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Count</span>(), <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(255, 198, 109);font-weight:normal;">new</span></span> <span style="margin:0px;padding:0px;">Fields</span>(<span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(249, 38, 114);">&quot;reach&quot;</span></span>)); <span style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;color:rgb(136, 136, 136);">/* 计算reach数 */</span></span></code></pre></div>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">最多处理一次（At most once）</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">回到主题，引出上面的例子，一是为了引出一个有关分布式（存储+计算）的问题，二是透漏这么点意思：<br style="margin:0px;padding:0px;"/>
码农，就应该关注设计和实现的东西，比如Jay Kreps是如何发明Kafka这个轮子的 : ]</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果你还是码农级别，咱来务点实吧，前面我们说到<code style="background-color:rgb(35, 35, 35);color:rgb(255, 255, 255);vertical-align:middle;display:inline-block;margin:1px 5px;box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;line-height:1.8;font-family:&quot;Courier New&quot;, sans-serif;font-size:12px;border:1px solid rgb(204, 204, 204);padding:0px 5px;border-radius:3px;">recover</code>，节点恢复的问题，那么我们恢复几个东西？</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">基本的：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">节点状态</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">节点数据</li>
</ul>
<p style="padding:0px;margin:10px auto;text-indent:0px;">本篇从数据上来讨论下这个问题，为使问题再简单点，我们考虑写数据的场景，如果我们用<code style="background-color:rgb(35, 35, 35);color:rgb(255, 255, 255);vertical-align:middle;display:inline-block;margin:1px 5px;box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;line-height:1.8;font-family:&quot;Courier New&quot;, sans-serif;font-size:12px;border:1px solid rgb(204, 204, 204);padding:0px 5px;border-radius:3px;">write-ahead-log</code>的方式来保证数据复制和一致性，那么我们会怎么处理一致性问题呢？</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">主节点有新数据写入.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">从节点追log,准备复制这批新数据。从节点做两件事：<br style="margin:0px;padding:0px;"/>
(1). 把数据的id偏移写入log;<br style="margin:0px;padding:0px;"/>
(2). 正要处理数据本身，从节点挂了。</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">那么根据上文的节点存活条件，这个从节点挂了这件事被探测到了，从节点由维护人员手动或者其自己恢复了，那么在加入集群和小伙伴们继续玩耍之前，它要同步自己的状态和数据。<br style="margin:0px;padding:0px;"/>
问题来了：</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果根据log内的数据偏移来同步数据，那么，因为这个节点在处理数据之前就把偏移写好了，可是那批数据lost-datas没有得到处理，如果追log之后的数据来同步，那么那批数据lost-datas就丢了。<br style="margin:0px;padding:0px;"/>
<br style="margin:0px;padding:0px;"/>在这种情况下，就叫作数据最多处理一次，也就是说数据会丢失。</p>
</blockquote>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">最少处理一次（At least once）</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">好吧，丢失数据不能容忍，那么我们换种方式来处理：</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">主节点有新数据写入.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">从节点追log,准备复制这批新数据。从节点做两件事：<br style="margin:0px;padding:0px;"/>
(1). 先处理数据；<br style="margin:0px;padding:0px;"/>
(2). 正要把数据的id偏移写入log，从节点挂了。</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">问题又来了：</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果从节点追log来同步数据，那么因为那批数据duplicated-datas被处理过了，而数据偏移没有反映到log中，如果这样追，会导致这批数据重复。<br style="margin:0px;padding:0px;"/><br style="margin:0px;padding:0px;"/>
这种场景，从语义上来讲，就是数据最少处理一次，意味着数据处理会重复。</p>
</blockquote>
<hr style="border-right-color:initial;margin:2em 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;padding:0px;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);"/>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">仅处理一次（Exactly once） </strong></h2>
<h3 style="padding:0px;font-size:16px;font-weight:bold;line-height:1.5;margin:10px 0px;"><strong style="margin:0px;padding:0px;">Transaction</strong></h3>
<p style="padding:0px;margin:10px auto;text-indent:0px;">好吧，数据重复也不能容忍？要求挺高啊。<br style="margin:0px;padding:0px;"/>
大家都追求的强一致性保证（这里是最终一致性），怎么来搞呢？<br style="margin:0px;padding:0px;"/>
换句话说，在更新数据的时候，事务能力如何保障呢？<br style="margin:0px;padding:0px;"/>
假设一批数据如下：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">新到数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">4</span>
    <span style="margin:0px;padding:0px;">urlId:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">5</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">现在要更新这批数据到库里或者log里，那么原来的情况是：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">老数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId：3</span>
    <span style="margin:0px;padding:0px;">urlId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">3</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果说可以保证如下三点：</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">事务ID的生成是强有序的.（隔离性，串行）</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">同一个事务ID对应的一批数据相同.（幂等性，多次操作一个结果）</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">单条数据会且仅会出现在某批数据中.（一致性，无遗漏无重复）</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">那么，放心大胆的更新好了：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">更新后数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId：4</span>
    <span style="margin:0px;padding:0px;">urlId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">//</span><span style="margin:0px;padding:0px;">3</span> <span style="margin:0px;padding:0px;">+</span> <span style="margin:0px;padding:0px;">5</span> <span style="margin:0px;padding:0px;">=</span> <span style="margin:0px;padding:0px;">8</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">8</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">注意到这个更新是<strong style="margin:0px;padding:0px;">ID偏移和数据一起更新</strong>的，那么这个操作靠什么来保证：<strong style="margin:0px;padding:0px;">原子性</strong>。<br style="margin:0px;padding:0px;"/>
你的数据库不提供原子性？后文略有提及。</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这里是更新成功了。如果更新的时候，节点挂了，那么库里或者log里的id偏移不写，数据也不处理，等节点恢复，就可以放心去同步，然后加入集群玩耍了。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">所以说，要保证数据仅处理一次，还是挺困难的吧？</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">上面的保障“仅处理一次”这个语义的实现有什么问题呢？</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">性能问题。</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">这里已经使用了batch策略来减少到库或磁盘的Round-Trip Time，那么这里的性能问题是什么呢？<br style="margin:0px;padding:0px;"/></p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">考虑一下，采用master-master架构来保证主节点的可用性，但是一个主节点失败了，到另一个主节点主持工作，是需要时间的。<br style="margin:0px;padding:0px;"/>
假设从节点正在同步，啪！主节点挂了！因为要保证仅处理一次的语义，所以原子性发挥作用，失败，回滚，然后从主节点拉失败的数据（你不能就近更新，因为这批数据可能已经变化了，或者你根本没缓存本批数据），结果是什么呢？<br style="margin:0px;padding:0px;"/>
<br style="margin:0px;padding:0px;"/>老主节点挂了， 新的主节点还没启动，所以这次事务就卡在这里，直到数据同步的源——主节点可以响应请求。</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果不考虑性能，就此作罢，这也不是什么大事。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">你似乎意犹未尽？来吧，看看“银弹”是什么？</p>
<h3 style="padding:0px;font-size:16px;font-weight:bold;line-height:1.5;margin:10px 0px;"><strong style="margin:0px;padding:0px;">Opaque-Transaction</strong></h3>
<p style="padding:0px;margin:10px auto;text-indent:0px;">现在，我们来追求这样一种效果：</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">某条数据在一批数据中（这批数据对应着一个事务），很可能会失败，但是它会在另一批数据中成功。<br style="margin:0px;padding:0px;"/>
换句话说，一批数据的事务ID一定相同。</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">来看看例子吧，老数据不变，只是多了个字段：<code style="background-color:rgb(35, 35, 35);color:rgb(255, 255, 255);vertical-align:middle;display:inline-block;margin:1px 5px;box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;line-height:1.8;font-family:&quot;Courier New&quot;, sans-serif;font-size:12px;border:1px solid rgb(204, 204, 204);padding:0px 5px;border-radius:3px;">prevReach</code>。</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">老数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId：3</span>
    <span style="margin:0px;padding:0px;">urlId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">//注意这里多了个字段，表示之前的reach的值</span>
    <span style="margin:0px;padding:0px;">prevReach:</span><span style="margin:0px;padding:0px;">2</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">3</span>
<span style="margin:0px;padding:0px;">}</span>


<span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">新到数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">4</span>
    <span style="margin:0px;padding:0px;">urlId:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">5</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这种情况，新事务的ID更大、更靠后，表明新事务可以执行，还等什么，直接更新，更新后数据如下：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">新到数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">4</span>
    <span style="margin:0px;padding:0px;">urlId:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">//注意这里更新为之前的值</span>
    <span style="margin:0px;padding:0px;">prevReach:</span><span style="margin:0px;padding:0px;">3</span>
    <span style="margin:0px;padding:0px;">//</span><span style="margin:0px;padding:0px;">3</span> <span style="margin:0px;padding:0px;">+</span> <span style="margin:0px;padding:0px;">5</span> <span style="margin:0px;padding:0px;">=</span> <span style="margin:0px;padding:0px;">8</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">8</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">现在来看下另外的情况：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">老数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId：3</span>
    <span style="margin:0px;padding:0px;">urlId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">prevReach:</span><span style="margin:0px;padding:0px;">2</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">3</span>
<span style="margin:0px;padding:0px;">}</span>

<span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">新到数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">//注意事务ID为3，和老数据中的事务ID相同</span>
    <span style="margin:0px;padding:0px;">transactionId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">3</span>
    <span style="margin:0px;padding:0px;">urlId:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">5</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这种情况怎么处理？是跳过吗？因为新数据的事务ID和库里或者log里的事务ID相同，按事务要求这次数据应该已经处理过了，跳过？<br style="margin:0px;padding:0px;"/>
不，这种事不能靠猜的，想想我们有的几个性质，其中关键一点就是：</p>
<blockquote style="padding-left:1.5em;background:none;padding:5px 10px;margin-top:10px;margin-bottom:10px;margin:0px;border:2px solid rgb(239, 239, 239);border-radius:0px;margin-left:0px;border-width:0px 0px 0px 4px;border-style:solid;border-color:rgb(239, 239, 239) rgb(239, 239, 239) rgb(239, 239, 239) rgba(170, 170, 170, 0.498039);border-image:initial;">
<p style="padding:0px;margin:10px auto;text-indent:0px;">给定一批数据，它们所属的事务ID相同。<br style="margin:0px;padding:0px;"/>
<br style="margin:0px;padding:0px;"/>仔细体会下，上面那句话和下面这句话的差别：<br style="margin:0px;padding:0px;"/>
给定一个事务ID，任何时候，其所关联的那批数据相同。</p>
</blockquote>
<p style="padding:0px;margin:10px auto;text-indent:0px;">我们应该这么做，考虑到新到数据的事务ID和存储中的事务ID一致，所以这批数据可能被分别或者异步处理了，但是，这批数据对应的事务ID永远是同一个，那么，即使这批数据中的A部分先处理了，由于大家都是一个事务ID，那么A部分的前值是可靠的。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">所以，我们将<strong style="margin:0px;padding:0px;">依靠prevReach而不是Reach的值</strong>来更新：</p>
<div style="margin:0px;padding:0px;"><pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;margin-top:10px;margin-bottom:10px;"><code style="font-family:Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;text-size-adjust:none;font-size:0.9em;display:block;color:rgb(225, 230, 220);box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;margin:auto;vertical-align:middle;overflow-x:auto;background:rgb(255, 255, 255);height:auto;border:1px solid rgb(204, 204, 204);border-radius:3px;background-color:rgb(35, 35, 35);line-height:1.8;padding:5px;"><span style="margin:0px;padding:0px;">//</span> <span style="margin:0px;padding:0px;">更新后数据</span>
<span style="margin:0px;padding:0px;">{</span>
    <span style="margin:0px;padding:0px;">transactionId</span><span style="margin:0px;padding:0px;">:</span><span style="margin:0px;padding:0px;">3</span>
    <span style="margin:0px;padding:0px;">urlId:</span><span style="margin:0px;padding:0px;">99</span>
    <span style="margin:0px;padding:0px;">//这个值不变</span>
    <span style="margin:0px;padding:0px;">prevReach:</span><span style="margin:0px;padding:0px;">2</span>
    <span style="margin:0px;padding:0px;">//</span><span style="margin:0px;padding:0px;">2</span> <span style="margin:0px;padding:0px;">+</span> <span style="margin:0px;padding:0px;">5</span> <span style="margin:0px;padding:0px;">=</span> <span style="margin:0px;padding:0px;">7</span>
    <span style="margin:0px;padding:0px;">reach:</span><span style="margin:0px;padding:0px;">7</span>
<span style="margin:0px;padding:0px;">}</span></code></pre></div>
<p style="padding:0px;margin:10px auto;text-indent:0px;">你发现了什么呢？<br style="margin:0px;padding:0px;"/>
不同的事务ID，导致了不同的值：</p>
<ol style="margin:0px;padding:0px;padding-left:40px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">当事务ID为4，大于存储中的事务ID3，Reach更新为3+5 = 8.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:decimal;">当事务ID为3，等于存储中的事务ID3，Reach更新为2+5 = 7.</li>
</ol>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这就是<code style="background-color:rgb(35, 35, 35);color:rgb(255, 255, 255);vertical-align:middle;display:inline-block;margin:1px 5px;box-shadow:rgba(0, 0, 0, 0.0588235) 0px 0px 10px;line-height:1.8;font-family:&quot;Courier New&quot;, sans-serif;font-size:12px;border:1px solid rgb(204, 204, 204);padding:0px 5px;border-radius:3px;">Opaque Transaction</code>.</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这种事务能力是最强的了，可以保证事务异步提交。所以不用担心被卡住了，如果说集群中：</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">Transaction：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">数据是分批处理的，每个事务ID对应一批确定、相同的数据.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">保证事务ID的产生是强有序的.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">保证分批的数据不重复、不遗漏.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">如果事务失败，数据源丢失，那么后续事务就卡住直到数据源恢复.</li>
</ul>
<p style="padding:0px;margin:10px auto;text-indent:0px;">Opaque-Transaction：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">数据是分批处理的，每批数据有确定而唯一的事务ID.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">保证事务ID的产生是强有序的.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">保证分批的数据不重复、不遗漏.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">如果事务失败，数据源丢失，不影响后续事务，除非后续事务的数据源也丢了.</li>
</ul>
<p style="padding:0px;margin:10px auto;text-indent:0px;">其实这个全局ID的设计也是门艺术：</p>
<ul style="margin:0px;padding:0px;word-break:break-all;margin-left:30px;padding-left:0px;">
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">冗余关联表的ID，以减少join，做到O(1)取ID.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">冗余日期（long型）字段，以避免order by.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">冗余过滤字段，以避免无二级索引（HBase）的尴尬.</li>
<li style="margin:0px;padding:0px;list-style:none;margin-bottom:0em;list-style-type:disc;">存储mod-hash的值，以方便分库、分表后，应用层的数据路由书写.</li>
</ul>
<p style="padding:0px;margin:10px auto;text-indent:0px;">这个内容也太多，话题也太大，就不在此展开了。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">你现在知道twitter的snowflake生成全局唯一且有序的ID的重要性了。</p>
<hr style="border-right-color:initial;margin:2em 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;padding:0px;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);"/>
<h3 style="padding:0px;font-size:16px;font-weight:bold;line-height:1.5;margin:10px 0px;"><strong style="margin:0px;padding:0px;">两阶段提交</strong></h3>
<p style="padding:0px;margin:10px auto;text-indent:0px;">现在用zookeeper来做两阶段提交已经是入门级技术，所以也不展开了。</p>
<p style="padding:0px;margin:10px auto;text-indent:0px;">如果你的数据库不支持原子操作，那么考虑两阶段提交吧。</p>
<hr style="border-right-color:initial;margin:2em 0px;border-width:1px 0px 0px;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;padding:0px;border-bottom-color:initial;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);"/>
<h2 style="padding:0px;font-size:1.2em;font-weight:bold;line-height:1.5em;margin:10px 0px;"><strong style="margin:0px;padding:0px;">结语</strong></h2>
<p style="padding:0px;margin:10px auto;text-indent:0px;">To be continued.</p>
</div><div style="display:block;margin:0px;padding:5px;border:1px dashed rgb(204, 204, 204);">【版权所有@foreach_break】
【博客地址 <a href="http://www.cnblogs.com/foreach-break" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;">http://www.cnblogs.com/foreach-break</a>】
 可以转载，但必须注明出处并保持博客超链接</div>
<div style="margin:0px;padding:0px;clear:both;"></div>
<div style="margin:0px;padding:0px;margin-top:20px;">
<div style="margin:0px;padding:0px;margin-bottom:10px;">分类: <a href="http://www.cnblogs.com/foreach-break/category/708199.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">java</a>,<a href="http://www.cnblogs.com/foreach-break/category/708198.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">storm</a>,<a href="http://www.cnblogs.com/foreach-break/category/686136.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">架构.设计</a>,<a href="http://www.cnblogs.com/foreach-break/category/685544.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">深度.分析</a>,<a href="http://www.cnblogs.com/foreach-break/category/715368.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">数据之路-厚积薄发</a></div>
<div style="margin:0px;padding:0px;font-size:9pt;color:rgb(102, 102, 102);margin-top:0px;">标签: <a href="http://www.cnblogs.com/foreach-break/tag/%E5%88%86%E5%B8%83%E5%BC%8F/" style="margin:0px;padding:0px;text-decoration:underline;margin-left:5px;color:rgb(102, 102, 102);">分布式</a>, <a href="http://www.cnblogs.com/foreach-break/tag/%E4%BA%8B%E5%8A%A1/" style="margin:0px;padding:0px;text-decoration:underline;margin-left:5px;color:rgb(102, 102, 102);">事务</a>, <a href="http://www.cnblogs.com/foreach-break/tag/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="margin:0px;padding:0px;text-decoration:underline;margin-left:5px;color:rgb(102, 102, 102);">大数据</a>, <a href="http://www.cnblogs.com/foreach-break/tag/%E4%B8%80%E8%87%B4%E6%80%A7/" style="margin:0px;padding:0px;text-decoration:underline;margin-left:5px;color:rgb(102, 102, 102);">一致性</a></div>
<div style="margin:0px;padding:0px;"><div style="margin:0px;padding:10px 0px;margin-bottom:10px;margin-top:10px;border:1px dashed silver;font-size:12px;width:320px;text-align:center;">
        <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(45, 174, 191);color:rgb(255, 255, 255);border:none;">好文要顶</a>
            <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(227, 49, 0);color:rgb(255, 255, 255);border:none;">关注我</a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 8px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:rgba(0, 0, 0, 0.498039) 0px 1px 3px;text-shadow:rgba(0, 0, 0, 0.247059) 0px -1px 1px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D&quot;) repeat-x;background-color:rgb(255, 181, 21);color:rgb(255, 255, 255);border:none;">收藏该文</a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 2px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:none;text-shadow:none;background:none;color:rgb(255, 255, 255);border:none;" title="分享至新浪微博"><img src="你真的很熟分布式和事务吗？ - foreach_break - 博客园_files/icon_weibo_24.png" type="image/png" data-filename="icon_weibo_24.png" alt="" height="24" style="margin:0px;padding:0px;height:auto;border:none;vertical-align:middle;margin-left:5px;box-shadow:none;max-width:300px;" width="24"/></a>
    <a href="#" style="margin-right:10px;margin:0px;border-radius:10px;padding:3px 2px;text-decoration:none;font-weight:bold;cursor:pointer;display:inline-block;vertical-align:middle;box-shadow:none;text-shadow:none;background:none;color:rgb(255, 255, 255);border:none;" title="分享至微信"><img src="你真的很熟分布式和事务吗？ - foreach_break - 博客园_files/wechat.png" type="image/png" data-filename="wechat.png" alt="" height="24" style="margin:0px;padding:0px;border:medium none;width:24px;height:24px;box-shadow:none;margin-left:5px;vertical-align:middle;max-width:300px;" width="24"/></a>
</div>
<div style="margin:0px;padding:0px;float:left;width:280px;margin-top:0px;margin-bottom:10px;color:rgb(0, 0, 0);margin-left:0px;font-size:12px;">
    <div style="margin:0px;padding:0px;float:left;line-height:18px;">
            <a href="http://home.cnblogs.com/u/foreach-break/" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank"><img src="你真的很熟分布式和事务吗？ - foreach_break - 博客园_files/20150501213416.png.jpg" type="image/jpeg" data-filename="20150501213416.png.jpg" alt="" height="48" style="margin:0px;padding:0px;height:auto;border:0px;vertical-align:top;float:left;margin-right:5px;padding-top:5px;padding-left:2px;max-width:300px;" width="48"/></a>
        <div style="margin:0px;padding:0px;float:left;line-height:18px;">
            <a href="http://home.cnblogs.com/u/foreach-break/" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;">foreach_break</a><br style="margin:0px;padding:0px;"/>
            <a href="http://home.cnblogs.com/u/foreach-break/followees" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;">关注 - 4</a><br style="margin:0px;padding:0px;"/>
            <a href="http://home.cnblogs.com/u/foreach-break/followers" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;">粉丝 - 814</a>
        </div>
    </div>
    <div style="margin:0px;padding:0px;clear:both;"></div>
    <div style="margin:0px;padding:0px;">荣誉：<a href="http://www.cnblogs.com/expert/" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" target="_blank">推荐博客</a></div>
    <div style="margin:0px;padding:0px;">
                <a href="#" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;">+加关注</a>
    </div>
</div>
<div style="margin:0px;float:right;margin-right:0px;font-size:12px;width:82px;text-align:center;margin-top:10px;margin-bottom:10px;padding:0px;position:fixed;z-index:1000;bottom:0px;right:40px;opacity:1;">
    <div style="margin:0px;padding:0px;float:left;width:82px;height:52px;background:url(&quot;http://images.cnblogs.com/cnblogs_com/foreach-break/688769/o_b.gif&quot;) 50% 50% no-repeat;text-align:center;cursor:pointer;margin-top:20px;padding-top:5px;">
        <span style="margin:0px;padding:0px;font-size:14px;color:rgb(7, 93, 179);font-family:Verdana;line-height:1.5em;">19</span>
    </div>
    
    <div style="margin:0px;padding:0px;clear:both;"></div>
    
</div>
</div>
<div style="margin:0px;padding:0px;clear:both;"></div>
<div style="margin:0px;padding:0px;line-height:1.8;font-size:12px;"><a href="http://www.cnblogs.com/foreach-break/p/dig_NoClassDefFound_Exception_inside_JVM.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;">« </a> 上一篇：<a href="http://www.cnblogs.com/foreach-break/p/dig_NoClassDefFound_Exception_inside_JVM.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" title="发布于2015-07-07 04:36">【hello,world 也打脸】记storm-starter在某知名IDE下的悲催调试经历</a><br style="margin:0px;padding:0px;"/><a href="http://www.cnblogs.com/foreach-break/p/learn_bigdata_from_twitter_hadoop_tuning.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:none;">» </a> 下一篇：<a href="http://www.cnblogs.com/foreach-break/p/learn_bigdata_from_twitter_hadoop_tuning.html" style="margin:0px;padding:0px;color:rgb(202, 0, 0);text-decoration:underline;" title="发布于2015-07-15 16:12">学习笔记：Twitter核心数据类库团队的Hadoop优化经验</a><br style="margin:0px;padding:0px;"/></div>
</div>


		</div>
		<div style="margin:0px;padding:0px;clear:both;line-height:2.5em;float:right;width:100%;text-align:right;padding-right:5px;color:rgb(102, 102, 102);margin-top:5px;">posted @ <span style="margin:0px;padding:0px;">2015-07-08 21:00</span> <a href="http://www.cnblogs.com/foreach-break/" style="margin:0px;padding:0px;text-decoration:none;color:rgb(102, 102, 102);">foreach_break</a> 阅读(<span style="margin:0px;padding:0px;">10032</span>) 评论(<span style="margin:0px;padding:0px;">11</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=4631324" rel="nofollow" style="margin:0px;padding:0px;text-decoration:none;color:rgb(102, 102, 102);">编辑</a> <a href="http://www.cnblogs.com/foreach-break/p/distributed_system_and_transaction.html#" style="margin:0px;padding:0px;text-decoration:none;color:rgb(102, 102, 102);">收藏</a></div>
	</div></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 