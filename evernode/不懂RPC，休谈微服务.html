<html>
<head>
  <title>不懂RPC，休谈微服务</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5106"/>
<h1>不懂RPC，休谈微服务</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/5/30 0:19</i></td></tr>
<tr><td><b>标签：</b></td><td><i>微信</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&mid=2247484311&idx=1&sn=6eebf034f35680a786e7046474fec72b&chksm=9bf4b322ac833a343e3fc83e0ede6ec00595a0031dad1635f77277be77de8548350dfa193593&mpshare=1&scene=1&srcid=0530knLQe3KAkrVkvvjq6VDj#rd"><i>http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247484311&amp;idx=1&amp;sn=6eebf034f35680a786e7046474fec72b&amp;chksm=9bf4b322ac833a343e3fc83e0ede6ec00595a0031dad1635f77277be77de8548350dfa193593&amp;mpshare=1&amp;scene=1&amp;srcid=0530knLQe3KAkrVkvvjq6VDj#rd</i></a></td></tr>
</table>
</div>
<br/>

<div><span style="margin:0px;"><div style="padding:8px 0px;margin:8px auto;max-width:700px;"> <div style="background-color:#fff;padding:20px 16px 12px;margin:0"><div style="margin:0;padding:0"><h2 style="font-weight:400;margin:0;padding:0;font-size:22px;line-height:1.4;margin-bottom:14px"></h2><div style="margin:0;padding:0;margin-bottom:22px;line-height:20px;font-size:0"><span style="padding:0;display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;color:rgba(0,0,0,0.3)"> Hosee </span><span style="padding:0;display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;position:relative"><a style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)"> Java架构沉思录 </a></span><em style="padding:0;font-style:normal;display:inline-block;vertical-align:middle;margin:0 10px 10px 0;font-size:15px;color:rgba(0,0,0,0.3)"></em></div><div lang="=&quot;en&quot;" style="margin:0;padding:0;overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;white-space:normal;min-height:1em;color:rgb(51,51,51);text-align:center;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(127,127,127);font-size:14px;line-height:24.5px">点击上方“</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;line-height:24.5px;color:rgb(87,107,149);font-size:15px">Java架构沉思录</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(127,127,127);font-size:14px;line-height:24.5px">”，选择“置顶公众号”。</span></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;white-space:normal;min-height:1em;color:rgb(51,51,51);text-align:center;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(127,127,127);font-size:14px">有内涵、有价值的文章第一时间送达！</span></p><pre style="padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;font-size:1em;line-height:1.2em;margin:1.2em 0"><code style="max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas,Inconsolata,Courier,monospace;margin:0 0.15em;background-color:rgb(248,248,248);white-space:pre;overflow:auto;border-radius:3px;border-width:1px;border-style:solid;border-color:rgb(204,204,204);padding:0.5em 0.7em;display:block !important">原文地址：https://my.oschina.net/hosee/blog/711632</code></pre><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">在学校期间大家都写过不少程序，比如写个hello world服务类，然后本地调用下，如下所示。这些程序的特点是服务消费方和服务提供方是本地调用关系。</p><pre style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;overflow-x:auto;padding:2px;background-color:rgb(63,63,63);color:rgb(220,220,220);border-radius:3px;line-height:1.4;font-size:13px"><p style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;display:block;overflow-x:auto;padding:10px;background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;border-radius:4px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">public</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">class</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">Test</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></span>{     <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">static</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">void</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">main</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(String[] args)</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></span>{         HelloWorldService helloWorldService = <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">new</span> HelloWorldServiceImpl();         helloWorldService.sayHello(<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">&quot;test&quot;</span>);     } }</p></pre><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">而一旦踏入公司尤其是大型互联网公司就会发现，公司的系统都由成千上万大大小小的服务组成，各服务部署在不同的机器上，由不同的团队负责。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">这时就会遇到两个问题：</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">要搭建一个新服务，免不了需要依赖他人的服务，而现在他人的服务都在远端，怎么调用？</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">其它团队要使用我们的新服务，我们的服务该怎么发布以便他人调用？下文将对这两个问题展开探讨。</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h2 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:22px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.  如何调用他人的远程服务？</h2><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">由于各服务部署在不同机器，服务间的调用免不了网络通信过程，服务消费方每调用一个服务都要写一坨网络通信相关的代码，不仅复杂而且极易出错。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">如果有一种方式能让我们像调用本地服务一样调用远程服务，而让调用者对网络通信这些细节透明，那么将大大提高生产力，比如服务消费方在执行helloWorldService.sayHello(&quot;test&quot;)时，实质上调用的是远端的服务。这种方式其实就是RPC（Remote Procedure Call Protocol），在各大互联网公司中被广泛使用，如阿里巴巴的hsf、dubbo（开源）、Facebook的thrift（开源）、Google grpc（开源）、Twitter的finagle（开源）等。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">要让网络通信细节对使用者透明，我们需要对通信细节进行封装，我们先看下一个RPC调用的流程涉及到哪些通信细节：</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;text-align:center;margin-top:10px;margin-bottom:10px;line-height:1.75em"><img src="不懂RPC，休谈微服务_files/640.jpg" type="image/jpeg" data-filename="640.jpg" style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important"/></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">服务消费方（client）调用以本地调用方式调用服务；</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">client stub找到服务地址，并将消息发送到服务端；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">server stub收到消息后进行解码；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">server stub根据解码结果调用本地的服务；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">本地服务执行并将结果返回给server stub；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">server stub将返回结果打包成消息并发送至消费方；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">client stub接收到消息，并进行解码；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">服务消费方得到最终结果。</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">RPC的目标就是要2~8这些步骤都封装起来，让用户对这些细节透明。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h3 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:20px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.1 怎么做到透明化远程服务调用？</h3><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">怎么封装通信细节才能让用户像以本地调用方式调用远程服务呢？对java来说就是使用代理！java代理有两种方式：</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">jdk 动态代理</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">字节码生成</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">（关于动态代理，可以看下沉思君之前写过的文章：<a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247483825&amp;idx=1&amp;sn=370ebe37cb9327f5e455799a0c39ed65&amp;chksm=9bf4b104ac8338120396ecc1e963ff9ab888ddbf4eaf13b4df584841eba826685ecaf72cf33a&amp;scene=21#wechat_redirect" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0);max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important" target="_blank">聊聊Java动态代理（上）</a>和<a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247483851&amp;idx=1&amp;sn=ae0638f5d335a3b13105c34afc5c0731&amp;chksm=9bf4b17eac833868b8bba9bdb23e011dd29bd3ae287a88b6dd37780160e763c11b6080786aed&amp;scene=21#wechat_redirect" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0);max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important" target="_blank">聊聊Java动态代理（下）</a>）</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">尽管字节码生成方式实现的代理更为强大和高效，但代码维护不易，大部分公司实现RPC框架时还是选择动态代理方式。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">下面简单介绍下动态代理怎么实现我们的需求。我们需要实现RPCProxyClient代理类，代理类的invoke方法中封装了与远端服务通信的细节，消费方首先从RPCProxyClient获得服务提供方的接口，当执行helloWorldService.sayHello(&quot;test&quot;)方法时就会调用invoke方法。</p><pre style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;overflow-x:auto;padding:2px;background-color:rgb(63,63,63);color:rgb(220,220,220);border-radius:3px;line-height:1.4;font-size:13px"><p style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;display:block;overflow-x:auto;padding:10px;background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;border-radius:4px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">public</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">class</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">RPCProxyClient</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">implements</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">java</span>.<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">lang</span>.<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">reflect</span>.<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">InvocationHandler</span></span>{    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">private</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span> obj;    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">RPCProxyClient</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span> obj)</span></span>{        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">this</span>.obj=obj;    }    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">/**     * 得到被代理对象;     */</span>    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">static</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">getProxy</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span> obj)</span></span>{        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">return</span> java.lang.reflect.Proxy.newProxyInstance(obj.getClass().getClassLoader(),                obj.getClass().getInterfaces(), <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">new</span> RPCProxyClient(obj));    }    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">/**     * 调用此方法执行     */</span>    <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">invoke</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span> proxy, Method method, <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span>[] args)</span>            <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">throws</span> Throwable </span>{        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">//结果参数;</span>        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span> result = <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">new</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">Object</span>();        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">// ...执行通信相关逻辑</span>        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">// ...</span>        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">return</span> result;    } }</p></pre><pre style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;overflow-x:auto;padding:2px;background-color:rgb(63,63,63);color:rgb(220,220,220);border-radius:3px;line-height:1.4;font-size:13px"><p style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;display:block;overflow-x:auto;padding:10px;background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;border-radius:4px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">public</span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">class</span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)">Test</span></span>{     <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">static</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">void</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">main</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(String[] args)</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></span>{         HelloWorldService helloWorldService = (HelloWorldService)RPCProxyClient.getProxy(HelloWorldService.<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">class</span>);         helloWorldService.sayHello(<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(204,147,147)">&quot;test&quot;</span>);     } }</p></pre><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h3 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:20px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.2  怎么对消息进行编码和解码？</h3><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h4 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:18px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.2.1 确定消息数据结构</h4><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">上节讲了invoke里需要封装通信细节（通信细节再后面几章详细探讨），而通信的第一步就是要确定客户端和服务端相互通信的消息结构。客户端的请求消息结构一般需要包括以下内容：</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">1）接口名称</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">在我们的例子里接口名是“HelloWorldService”，如果不传，服务端就不知道调用哪个接口了；</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">2）方法名</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">一个接口内可能有很多方法，如果不传方法名服务端也就不知道调用哪个方法；</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">3）参数类型&amp;参数值</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">参数类型有很多，比如有bool、int、long、double、string、map、list，甚至如struct（class）；以及相应的参数值；</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">4）超时时间</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">5）requestID，标识唯一请求id，在下面一节会详细描述requestID的用处。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">同理服务端返回的消息结构一般包括以下内容。</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:lower-roman"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">返回值</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">状态code</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">requestID </p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h4 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:18px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.2.2 序列化</h4><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">一旦确定了消息的数据结构后，下一步就是要考虑序列化与反序列化了。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">什么是序列化？序列化就是将数据结构或对象转换成二进制串的过程，也就是编码的过程。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">什么是反序列化？将在序列化过程中所生成的二进制串转换成数据结构或者对象的过程。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">为什么需要序列化？转换为二进制串后才好进行网络传输嘛！</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">为什么需要反序列化？将二进制转换为对象才好进行后续处理！</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">现如今序列化的方案越来越多，每种序列化方案都有优点和缺点，它们在设计之初有自己独特的应用场景，那到底选择哪种呢？从RPC的角度上看，主要看三点：</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">通用性，比如是否能支持Map等复杂的数据结构；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">性能，包括时间复杂度和空间复杂度，由于RPC框架将会被公司几乎所有服务使用，如果序列化上能节约一点时间，对整个公司的收益都将非常可观，同理如果序列化上能节约一点内存，网络带宽也能省下不少；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">可扩展性，对互联网公司而言，业务变化飞快，如果序列化协议具有良好的可扩展性，支持自动增加新的业务字段，而不影响老的服务，这将大大提供系统的灵活度。</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">目前互联网公司广泛使用Protobuf、Thrift、Avro等成熟的序列化解决方案来搭建RPC框架，这些都是久经考验的解决方案。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h3 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:20px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.3  通信</h3><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">消息数据结构被序列化为二进制串后，下一步就要进行网络通信了。目前有两种常用IO通信模型：1）BIO；2）NIO。一般RPC框架需要支持这两种IO模型。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">如何实现RPC的IO通信框架呢？</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">使用java nio方式自研，这种方式较为复杂，而且很有可能出现隐藏bug，但也见过一些互联网公司使用这种方式；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">基于mina，mina在早几年比较火热，不过这些年版本更新缓慢；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">基于netty，现在很多RPC框架都直接基于netty这一IO通信框架，省力又省心，比如阿里巴巴的HSF、dubbo，Twitter的finagle等。</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h3 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:20px;margin-top:10px;margin-bottom:10px;line-height:1.75em">1.4  <strong style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">消息里为什么要有requestID？</strong></h3><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">如果使用netty的话，一般会用channel.writeAndFlush()方法来发送消息二进制串，这个方法调用后对于整个远程调用(从发出请求到接收到结果)来说是一个异步的，即对于当前线程来说，将请求发送出来后，线程就可以往后执行了，至于服务端的结果，是服务端处理完成后，再以消息的形式发送给客户端的。于是这里出现以下两个问题：</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">怎么让当前线程“暂停”，等结果回来后，再向后执行？</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">如果有多个线程同时进行远程方法调用，这时建立在client server之间的socket连接上会有很多双方发送的消息传递，前后顺序也可能是随机的，server处理完结果后，将结果消息发送给client，client收到很多消息，怎么知道哪个消息结果是原先哪个线程调用的？</p></li></ol><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">举个例子，线程A和线程B同时向client socket发送请求requestA和requestB，socket先后将requestB和requestA发送至server，而server可能将responseA先返回，尽管requestA请求到达时间更晚。我们需要一种机制保证responseA丢给ThreadA，responseB丢给ThreadB。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">怎么解决呢？</p><ol style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em;list-style-type:decimal"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">client线程每次通过socket调用一次远程接口前，生成一个唯一的ID，即requestID（requestID必需保证在一个Socket连接里面是唯一的），一般常常使用AtomicLong从0开始累计数字生成唯一ID；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">将处理结果的回调对象callback，存放到全局ConcurrentHashMap里面put(requestID, callback)；</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">当线程调用channel.writeAndFlush()发送消息后，紧接着执行callback的get()方法试图获取远程返回的结果。在get()内部，则使用synchronized获取回调对象callback的锁，再先检测是否已经获取到结果，如果没有，然后调用callback的wait()方法，释放callback上的锁，让当前线程处于等待状态。</p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em">服务端接收到请求并处理后，将response结果（此结果中包含了前面的requestID）发送给客户端，客户端socket连接上专门监听消息的线程收到消息，分析结果，取到requestID，再从前面的ConcurrentHashMap里面get(requestID)，从而找到callback对象，再用synchronized获取callback上的锁，将方法调用结果设置到callback对象里，再调用callback.notifyAll()唤醒前面处于等待状态的线程。</p></li></ol><pre style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;overflow-x:auto;padding:2px;background-color:rgb(63,63,63);color:rgb(220,220,220);border-radius:3px;line-height:1.4;font-size:13px"><p style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;display:block;overflow-x:auto;padding:10px;background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;border-radius:4px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">public</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"> Object </span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">get</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">()</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></span>{        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">synchronized</span> (<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">this</span>) { <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">// 旋锁</span>            <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">while</span> (!isDone) { <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">// 是否有结果了</span>                wait(); <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">//没结果是释放锁，让当前线程处于等待状态</span>            }        } }</p></pre><pre style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;overflow-x:auto;padding:2px;background-color:rgb(63,63,63);color:rgb(220,220,220);border-radius:3px;line-height:1.4;font-size:13px"><p style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;display:block;overflow-x:auto;padding:10px;background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;border-radius:4px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">private</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">void</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(239,239,143)"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">setDone</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent">(Response res)</span></span></span><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></span>{        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">this</span>.res = res;        isDone = <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">true</span>;        <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">synchronized</span> (<span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(227,206,171)">this</span>) { <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">//获取锁，因为前面wait()已经释放了callback的锁了</span>            notifyAll(); <span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;color:rgb(127,159,127)">// 唤醒处于等待的线程</span>        }    }</p></pre><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent"></span></p><h2 style="font-weight:400;margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;font-size:22px;margin-top:10px;margin-bottom:10px;line-height:1.75em">2 如何发布自己的服务？</h2><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">如何让别人使用我们的服务呢？有同学说很简单嘛，告诉使用者服务的IP以及端口就可以了啊。确实是这样，这里问题的关键在于是自动告知还是人肉告知。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">人肉告知的方式：如果你发现你的服务一台机器不够，要再添加一台，这个时候就要告诉调用者我现在有两个ip了，你们要轮询调用来实现负载均衡；调用者咬咬牙改了，结果某天一台机器挂了，调用者发现服务有一半不可用，他又只能手动修改代码来删除挂掉那台机器的ip。现实生产环境当然不会使用人肉方式。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">有没有一种方法能实现自动告知，即机器的增添、剔除对调用方透明，调用者不再需要写死服务提供方地址？当然可以，现如今zookeeper被广泛用于实现服务自动注册与发现功能！</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">简单来讲，zookeeper可以充当一个</span><code style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;font-size:13px"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">服务注册表</span></code><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">（Service Registry），让多个</span><code style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;font-size:13px"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">服务提供者</span></code><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">形成一个集群，让</span><code style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;font-size:13px"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">服务消费者</span></code><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:16px">通过服务注册表获取具体的服务访问地址（ip+端口）去访问具体的服务提供者。如下图所示：</span></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;text-align:center;margin-top:10px;margin-bottom:10px;line-height:1.75em"><img src="不懂RPC，休谈微服务_files/640 [1].jpg" type="image/jpeg" data-filename="640.jpg" style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important"/></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">具体来说，zookeeper就是个分布式文件系统，每当一个服务提供者部署后都要将自己的服务注册到zookeeper的某一路径上: /{service}/{version}/{ip:port}, 比如我们的HelloWorldService部署到两台机器，那么zookeeper上就会创建两条目录：分别为/HelloWorldService/1.0.0/100.19.20.01:16888，  /HelloWorldService/1.0.0/100.19.20.02:16888。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">zookeeper提供了“心跳检测”功能，它会定时向各个服务提供者发送一个请求（实际上建立的是一个 Socket 长连接），如果长期没有响应，服务中心就认为该服务提供者已经“挂了”，并将其剔除，比如100.19.20.02这台机器如果宕机了，那么zookeeper上的路径就会只剩/HelloWorldService/1.0.0/100.19.20.01:16888。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">服务消费者会去监听相应路径（/HelloWorldService/1.0.0），一旦路径上的数据有任务变化（增加或减少），zookeeper都会通知服务消费方服务提供者地址列表已经发生改变，从而进行更新。</p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;-webkit-tap-highlight-color:transparent;margin-top:10px;margin-bottom:10px;line-height:1.75em">更为重要的是zookeeper与生俱来的容错容灾能力（比如leader选举），可以确保服务注册表的高可用性。</p><div style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(51,51,51)"><div style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;margin-top:8.5px;margin-bottom:8.5px;padding:8.5px;width:518.4px;text-align:center"><div style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding:10px;box-shadow:rgba(159,160,160,0.498) 0 0 10px;display:inline-block;vertical-align:top"><div style="margin:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding:7px;box-shadow:rgba(0,0,0,0.29) 0 0 10px inset"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:17px"><span style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;font-size:18px"><strong style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important">Java架构沉思录</strong></span></p><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:17px">一码不扫，何扫天下<br style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"/></p><div style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;border-color:rgb(51,51,51);border-style:none;border-width:0"><div style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><img src="不懂RPC，休谈微服务_files/640 [2].jpg" type="image/jpeg" data-filename="640.jpg" border="0" style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;vertical-align:middle;visibility:visible !important;width:258px !important" title="undefined" width="258"/></div></div></div></div></div></div><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em"><br style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"/></p><ul style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;padding-left:2.2em"><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:17px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247484275&amp;idx=1&amp;sn=e48f52a67ded20a03cd1b0e285544f0c&amp;chksm=9bf4b3c6ac833ad03bf9fde50b506c4ba3ef351f9a871c482893ab2f1f04de3ab58afe5bc86b&amp;scene=21#wechat_redirect" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0);max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important" target="_blank">大家都在说的前后端分离到底是什么</a><br style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"/></p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:17px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247484283&amp;idx=1&amp;sn=36fbef86f889d39cbbcdab1c4c566f9b&amp;chksm=9bf4b3ceac833ad80989a51d1c8f8e9b65b0f85df79250de56be96206edaeae83502809db006&amp;scene=21#wechat_redirect" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0);max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important" target="_blank">缓存的正确使用方式，你都会了吗</a><br style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"/></p></li><li style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important"><p style="margin:0;padding:0;max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:17px;margin-top:10px;margin-bottom:10px;line-height:1.75em"><a href="http://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247484297&amp;idx=1&amp;sn=684acfd4d54b397fe3711bd98082b076&amp;chksm=9bf4b33cac833a2a62eb629d11d706f0ff88520f4d62aeb3858598b8ee008ccdd2a9846a5164&amp;scene=21#wechat_redirect" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0);max-width:100% !important;box-sizing:border-box !important;-webkit-box-sizing:border-box !important;word-wrap:break-word !important" target="_blank">谈谈高并发下的幂等性处理</a></p></li></ul></div></div><ul style="margin:0;padding:0"></ul><div style="margin:0;padding:0"><a href="https://mp.weixin.qq.com/s?__biz=MzAxNjM2MTk0Ng==&amp;mid=2247484311&amp;idx=1&amp;sn=6eebf034f35680a786e7046474fec72b&amp;chksm=9bf4b322ac833a343e3fc83e0ede6ec00595a0031dad1635f77277be77de8548350dfa193593&amp;mpshare=1&amp;scene=1&amp;srcid=0530knLQe3KAkrVkvvjq6VDj##" style="margin:0;padding:0;color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)">阅读原文</a></div></div></div></span>
</div></body></html> 