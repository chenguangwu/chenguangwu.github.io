<html>
<head>
  <title>7 张图讲清楚ZooKeeper分布式锁实现原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2848"/>
<h1>7 张图讲清楚ZooKeeper分布式锁实现原理</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/12/13 10:22</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://mp.weixin.qq.com/s/smuIGalT7Qvjy8evVA2mBg"><i>https://mp.weixin.qq.com/s/smuIGalT7Qvjy8evVA2mBg</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="text-size-adjust:100%;line-height:1.6;"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);letter-spacing:0.034em;background-color:rgb(255, 255, 255);"><div><div style="word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div>

                
                <h2 style="margin:0px;padding:0px;font-weight:400;font-size:22px;line-height:1.4;margin-bottom:14px;">
                    
                    
                    7 张图讲清楚ZooKeeper分布式锁实现原理

                                                                                </h2>
                <div style="margin:0px;padding:0px;margin-bottom:22px;line-height:20px;font-size:0px;word-wrap:break-word;word-break:break-all;position:relative;z-index:1;">
                                                                                <span style="padding:0px;margin:0px 10px 10px 0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);">
                                                中华石杉
                                            </span>
                                        
                                        <span style="padding:0px;margin:0px 10px 10px 0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);position:relative;">
                      <a href="#" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);">
                        占小狼的博客                      </a>
                      
                    </span>


                    <em style="padding:0px;margin:0px 10px 10px 0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);font-style:normal;">1周前</em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(51, 51, 51);font-size:17px;word-wrap:break-word;text-align:justify;position:relative;">
                    

                    

                    
                    
                    <p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;line-height:1.5em;letter-spacing:1px;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="color:rgb(64, 118, 0);margin:0px;text-align:justify;letter-spacing:1px;font-size:14px;padding:0px;font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;word-wrap:break-word;box-sizing:border-box;max-width:100%;background-color:rgb(255, 255, 255);">本文来源：石杉的架构笔记（shishan100）</span></p><p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;margin-top:10px;line-height:1.5em;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;letter-spacing:1px;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;">这篇文章再给大家聊一下ZooKeeper实现分布式锁的原理。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;">同理，我是直接基于比较常用的</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;">Curator</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;">这个开源框架，聊一下这个框架对ZooKeeper（</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;color:rgb(241, 136, 35);">以下简称zk</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:15px;letter-spacing:2px;">）分布式锁的实现。</span></p><p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;line-height:1.5em;letter-spacing:1px;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></span></p><p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;line-height:1.5em;letter-spacing:1px;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">一般除了大公司是自行封装分布式锁框架之外，建议大家用这些开源框架封装好的分布式锁实现，这是一个比较快捷省事儿的方式。</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-bottom:20px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:1px;white-space:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:18px;color:rgb(64, 118, 0);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:inherit;font-size:18px;white-space:normal;border-color:rgb(170, 166, 149);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">ZooKeeper分布式锁机制</strong></strong></span></strong></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;font-size:15px;">接下来我们一起来看看，多客户端获取及释放zk分布式</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;font-size:15px;">锁的整个流程及背后的原理。</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">首先大家看看下面的图，如果现在有两个客户端一起要争抢zk上的一把分布式锁，会是个什么场景？</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640" type="image/webp" data-filename="640" height="255" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:496px !important;visibility:visible !important;" width="496"/></p><p style="font-family:-apple-system-font, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei UI, Microsoft YaHei, Arial, sans-serif;margin:0px;max-width:100%;box-sizing:border-box !important;line-height:2em;margin-right:8px;min-height:1em;white-space:normal;color:rgb(51, 51, 51);padding:0px;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;letter-spacing:1px;margin-left:8px;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 179, 230);font-size:15px;letter-spacing:2px;">如果大家对zk还不太了解，建议先百度一下，快速了解一些基本概念，比如zk有哪些节点类型等等。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">参见上图。zk里有一把锁，这个锁就是zk上的一个节点。然后呢，两个客户端都要来获取这个锁，<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;font-size:15px;color:rgb(241, 136, 35);">具体是怎么来获取呢？</span></span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">咱们就假设客户端A抢先一步，对zk发起了加分布式锁的请求，这个加锁请求是用到了zk中的一个特殊的概念，叫做<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">“临时顺序节点”。</strong></span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">简单来说，就是直接在&quot;my_lock&quot;这个锁节点下，创建一个顺序节点，这个顺序节点有zk内部自行维护的一个节点序号。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">比如说，第一个客户端来搞一个顺序节点，zk内部会给起个名字叫做：xxx-000001。然后第二个客户端来搞一个顺序节点，zk可能会起个名字叫做：xxx-000002。大家注意一下，<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">最后一个数字都是依次递增的</strong>，从1开始逐次递增。zk会维护这个顺序。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">所以这个时候，假如说客户端A先发起请求，就会搞出来一个顺序节点，大家看下面的图，Curator框架大概会弄成如下的样子：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [1]" type="image/webp" data-filename="640" height="198" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">大家看，客户端A发起一个加锁请求，先会在你要加锁的node下搞一个临时顺序节点，这一大坨长长的名字都是Curator框架自己生成出来的。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">然后，那个最后一个数字是&quot;1&quot;。大家注意一下，因为客户端A是第一个发起请求的，所以给他搞出来的顺序节点的序号是&quot;1&quot;。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">接着客户端A创建完一个顺序节点。还没完，</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Microsoft YaHei&quot;;">他会查一下&quot;<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">my_lock</strong>&quot;这个锁节点下的所有子节点，并且这些子节点</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Microsoft YaHei&quot;;">是按照</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Microsoft YaHei&quot;;">序号排序的，这个时候他大概会拿到这么一个集合：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [2]" type="image/webp" data-filename="640" height="94" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:587px !important;visibility:visible !important;" width="587"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">接着客户端A会走一个关键性的判断，就是说：<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;background-color:initial;color:rgb(64, 179, 230);">唉！兄弟，这个集合里，我创建的那个顺序节点，是不是排在第一个啊？</span></span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">如果是的话，那我就可以加锁了啊！因为明明我就是第一个来创建顺序节点的人，所以我就是第一个尝试加分布式锁的人啊！</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">bingo！</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">加锁成功</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">！大家看下面的图，再来直观的感受一下整个过程。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [3]" type="image/webp" data-filename="640" height="271" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">接着假如说，客户端A都加完锁了，客户端B过来想要加锁了，这个时候他会干一样的事儿：先是在&quot;<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">my_lock</strong>&quot;这个锁节点下创建一个<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">临时顺序节点</strong>，此时名字会变成类似于：</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [4]" type="image/webp" data-filename="640" height="100" style="margin:0px;padding:0px;max-width:100% !important;box-sizing:border-box;word-wrap:break-word;height:auto !important;text-align:center;white-space:normal;width:auto !important;visibility:visible !important;" width="591"/></span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:left;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">大家看看下面的图：</strong><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [5]" type="image/webp" data-filename="640" height="271" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;background-color:initial;letter-spacing:2px;">客户端B因为是第二个来创建顺序节点的，所以zk内部会维护序号为&quot;2&quot;。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">接着客户端B会走加锁判断逻辑，查询&quot;</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">my_lock</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">&quot;锁节点下的所有子节点，按序号顺序排列，此时他看到的类似于：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;background-color:initial;letter-spacing:2px;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [6]" type="image/webp" data-filename="640" height="121" style="margin:0px;padding:0px;max-width:100% !important;box-sizing:border-box;word-wrap:break-word;height:auto !important;text-align:center;white-space:normal;width:auto !important;visibility:visible !important;" width="595"/></span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:left;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;"> 同时检查自己创建的顺序节点，是不是集合中的第一个？</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;color:rgb(64, 179, 230);">明显不是啊</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">，此时第一个是客户端A创建的那个顺序节点，序号为&quot;01&quot;的那个。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;color:rgb(201, 56, 28);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">所以加锁失败</strong></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">！</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">加锁失败以后，客户端B就会通过ZK的API，</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">对他的</strong><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">上一个顺序节点加一个监听器。</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">zk天然就可以实现对某个节点的监听。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">我们举例说明，客户端B的顺序节点是：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [7]" type="image/webp" data-filename="640" height="100" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:591px !important;visibility:visible !important;" width="591"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">他的上一个顺序节点，不就是下面这个吗？</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [8]" type="image/webp" data-filename="640" height="100" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:591px !important;visibility:visible !important;" width="591"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;font-size:15px;letter-spacing:2px;">也就是客户端A创建的那个顺序节点！</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">所以，客户端B会对：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [9]" type="image/webp" data-filename="640" height="100" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:591px !important;visibility:visible !important;" width="591"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;font-size:15px;letter-spacing:2px;">这个节点加一个监听器，监听这个节点是否被删除等变化！</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">说了那么多，老规矩，给大家来一张图，直观的感受一下：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [10]" type="image/webp" data-filename="640" height="335" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">接着，客户端A加锁之后，可能处理了一些代码逻辑，然后就会释放锁。那么，<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;background-color:initial;color:rgb(64, 179, 230);">释放锁是个什么过程呢</span>？</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">其实很简单，就是把自己在zk里创建的那个顺序节点，也就是：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [11]" type="image/webp" data-filename="640" height="100" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:591px !important;visibility:visible !important;" width="591"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">这个节点给删除。</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;"></span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">删除了那个节点之后，zk会负责通知监听这个节点的监听器，也就是客户端B之前加的那个监听器，说：</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;color:rgb(64, 179, 230);">兄弟，你监听的那个节点被删除了，有人释放了锁</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">我们一起来看看下面的图，体会一下这个过程：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [12]" type="image/webp" data-filename="640" height="365" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">此时客户端B的监听器感知到了上一个顺序节点被删除，也就是排在他之前的某个客户端释放了锁。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">此时，就会通知客户端B重新尝试去获取锁，也就是获取&quot;</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">my_lock</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">&quot;节点下的子节点集合，此时为：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [13]" type="image/webp" data-filename="640" height="94" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:572px !important;visibility:visible !important;" width="572"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;margin-left:8px;margin-right:8px;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">集合里此时只有客户端B创建的唯一的一个顺序节点了！</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">然后呢，客户端B一判断，</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;color:rgb(201, 56, 28);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">发现自己居然是集合中的第一个顺序节点</strong></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">，bingo！可以加锁了！</span><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">直接完成加锁</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">，运行后续的业务代码即可，运行完了之后再次释放锁。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">最后，再给大家来一张图，大伙儿顺着图仔细的捋一捋这整个过程：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [14]" type="image/webp" data-filename="640" height="394" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:677px !important;visibility:visible !important;" width="677"/></p><p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;line-height:1.5em;letter-spacing:1px;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei UI, Microsoft YaHei, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;white-space:normal;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:18px;color:rgb(64, 118, 0);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:inherit;border-color:rgb(170, 166, 149);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">总结</strong></strong></span></strong></p><p style="color:rgb(51, 51, 51);margin:0px;max-width:100%;box-sizing:border-box !important;margin-top:15px;line-height:1.5em;min-height:1em;white-space:normal;padding:0px;font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size:17px;background-color:rgb(255, 255, 255);text-align:left;letter-spacing:1px;clear:both;word-wrap:break-word;overflow-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">其实如果有客户端C、客户端D等N个客户端争抢一个zk分布式锁，原理都是类似的。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:disc;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">大家都是上来直接创建一个锁节点下的一个接一个的临时顺序节点</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">如果自己不是第一个节点，就对自己上一个节点加监听器</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;">只要上一个节点释放锁，自己就排到前面去了，相当于是一个排队机制。</span></p></li></ul><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">而且用</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;color:rgb(64, 179, 230);">临时顺序节点的另外一个用意就是</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">，如果某个客户端创建临时顺序节点之后，不小心自己宕机了也没关系，zk感知到那个客户端宕机，会自动删除对应的临时顺序节点，相当于自动释放锁，或者是自动取消自己的排队。</span></p><p style="clear:both;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">最后，咱们来看下用Curator框架进行加锁和释放锁的一个过程：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [15]" type="image/webp" data-filename="640" height="356" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:100% !important;visibility:visible !important;" width="677"/></p><p style="min-height:1em;margin:0px;margin-right:8px;margin-left:8px;background-color:initial;display:block;padding:0px;clear:both;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;font-size:15px;">其实用开源框架就是这点好，方便。这个Curator框架的zk分布式锁的加锁和释放锁的实现原理，其实就是上<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:2px;background-color:initial;">面我们说的那样子。</span></span></p><p style="min-height:1em;margin:0px;line-height:2em;margin-right:8px;margin-left:8px;background-color:initial;padding:0px;display:block;clear:both;word-wrap:break-word;box-sizing:border-box;max-width:100%;margin-top:10px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:15px;letter-spacing:2px;">但是如果你要手动实现一套那个代码的话。还是有点麻烦的，要考虑到各种细节，异常处理等等。所以大家如果考虑用zk分布式锁，可以参考下本文的思路。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="min-height:1em;margin:0px;margin-right:8px;margin-left:8px;background-color:initial;display:block;padding:0px;clear:both;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:2em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background-color:initial;letter-spacing:2px;font-size:15px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:left;"><span style="color:rgb(64, 118, 0);margin:0px;text-align:justify;letter-spacing:1px;font-size:14px;padding:0px;font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;word-wrap:break-word;box-sizing:border-box;max-width:100%;background-color:rgb(255, 255, 255);">中华石</span><span style="color:rgb(64, 118, 0);margin:0px;text-align:justify;letter-spacing:1px;font-size:14px;padding:0px;font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;word-wrap:break-word;box-sizing:border-box;max-width:100%;background-color:rgb(255, 255, 255);">杉</span><span style="color:rgb(64, 118, 0);margin:0px;text-align:justify;letter-spacing:1px;font-size:14px;padding:0px;font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;word-wrap:break-word;box-sizing:border-box;max-width:100%;background-color:rgb(255, 255, 255);">，十余年BAT架构经验倾囊相授。个人微信公众号：石杉的架构笔记（ID：shishan100）</span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:left;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="letter-spacing:0.544px;margin:15px 8px;max-width:100%;box-sizing:border-box;word-wrap:break-word;clear:both;min-height:1em;padding:0px;white-space:normal;background-color:rgb(255, 255, 255);color:rgb(62, 62, 62);font-family:Helvetica, Arial, sans-serif;font-size:15px;line-height:1.75em;text-align:center;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;letter-spacing:1px;color:rgb(64, 118, 0);">-END-</span></strong></p><p style="font-family:-apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;margin:5px 8px;max-width:100%;box-sizing:border-box;word-wrap:break-word;clear:both;min-height:1em;padding:0px;letter-spacing:0.544px;text-align:justify;white-space:normal;background-color:rgb(255, 255, 255);font-size:16px;color:rgb(62, 62, 62);word-spacing:2px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(255, 255, 255);background-color:rgb(64, 118, 0);"> </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(255, 255, 255);background-color:rgb(64, 118, 0);font-size:15px;">近期热文：</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484720&amp;idx=2&amp;sn=1bf6609004171d2e69e8f21cca154074&amp;chksm=96cd457ca1bacc6a1fe95e1bda3818111e82066a9174dd940b6fdf9a5a96221bb0dbeb9ba6d5&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">缓存穿透、缓存并发、缓存失效之思路变迁</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484940&amp;idx=1&amp;sn=f369b13599b8680675ea0f441b4de7be&amp;chksm=96cd4640a1bacf566c14c16bf52072c51b8956ebd1597466cedc5059a8b79f3a42bdd19f3e52&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">Redis分布式锁要这样实现才牛逼</a><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484923&amp;idx=1&amp;sn=250ddc59d358075f2d7a8bbe21a300da&amp;chksm=96cd45b7a1bacca10b3001643c6a3ceedb02dc707daddbdc0b00cd25e5b0d86fc2a05a8b3f02&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">图解elasticsearch原理</a><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484909&amp;idx=1&amp;sn=c23ecd81f3bdb6ab65a132f0c0dd2bc4&amp;chksm=96cd45a1a1baccb7b30b0e45ea06e80a3abe9f523156659026a968f474c0b2dd3906fd733e7f&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">阿里员工都是这样排查Java问题的，附工具单</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484884&amp;idx=1&amp;sn=721c8d7461a481e06784972ac3c9e2f8&amp;chksm=96cd4598a1bacc8ed313c3f1e926e78b709cd297e6e3face48b5bcbcf18a0694ace9121d8753&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">如何使用MAT进行JVM内存泄露分析</a><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484751&amp;idx=1&amp;sn=8616aece193d174c12757d22e3e04924&amp;chksm=96cd4503a1bacc154aceaaa89cdb8eeb4c2a83a459df0edb2c5380579aa46a946a94bfa1dac1&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">来之不易的美团面试，结果居然挂了...（附面试答案）</a><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484715&amp;idx=1&amp;sn=de8d79aaf675cf1b2b26b1f48fc3472c&amp;chksm=96cd4567a1bacc7140d5ac0ba970568036cdf3c4bca5ba80247881738e41b262bebd39b68022&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">一文带你了解Java Agent</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484695&amp;idx=1&amp;sn=b1b07370e72d8a8a5e16c2d689fbe6de&amp;chksm=96cd455ba1bacc4de41b31ec79176fb5cd6f031ae2761dd46ad66ab5c868d8c98253a640a1b5&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">优秀开源框架的扩展机制，原来都是这样实现的...</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484669&amp;idx=1&amp;sn=5b79f5c3a7c62323e36b72091c2df502&amp;chksm=96cd44b1a1bacda7eeffd506293e6d59c4edd2cc6afe56c0addbd552c36a532594f4b1b56fdc&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">蚂蚁金服中间件，一大波面经来袭！</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484619&amp;idx=1&amp;sn=8f4470aca7e0a817d53b2283b5811d49&amp;chksm=96cd4487a1bacd91a7e59b16163423485bd39a44075ea83c56462c4b7c1580963231228f1f14&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">【第二弹】21个让程序员泪流满面的瞬间</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484783&amp;idx=2&amp;sn=d22116d6e9562e15a240bded40383e22&amp;chksm=96cd4523a1bacc35f7eacfcc3d3d4dcd13947d6d612d9299256dc50a47e2d868a4d302bc9fb0&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">又发生频繁FGC，这次是谁的锅？</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484767&amp;idx=1&amp;sn=bcb48e4df05c296b33b27369a560a2cb&amp;chksm=96cd4513a1bacc058afbda2aee55f2df7d6beb7428aa39a2dea520865ad7f153a64cc4fa8b44&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:underline;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;" target="_blank">算法面试，如何在100 亿URL中判断某个URL是否存在？</a></h2></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><h2 style="margin:0px;padding:0px;font-weight:400;font-size:16px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:14px;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MzIwMzY1OTU1NQ==&amp;mid=2247484774&amp;idx=1&amp;sn=e588f5925213c115a13deac2be300e68&amp;chksm=96cd452aa1bacc3cc15d82f92e9014147c42e092b606604d68ba248b5419739e6a3ac923cf61&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;word-wrap:break-word;" target="_blank">百万并发下的Nginx性能优化之道，值得看！！！</a></span></h2></li></ul><p style="text-indent:0em;margin:5px 8px;max-width:100%;box-sizing:border-box;word-wrap:break-word;clear:both;min-height:1em;letter-spacing:0.544px;padding:0px;background-color:rgb(255, 255, 255);font-size:16px;word-spacing:2px;text-align:center;white-space:pre-line;color:rgb(74, 74, 74);font-family:Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height:1.75em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/><img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/640 [16]" type="image/webp" data-filename="640" height="258" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;visibility:visible !important;width:258px !important;" width="258"/></p>
                </div>
                

                
                
                
                
                

                
                                

                
                                
                
                                <a href="https://mp.weixin.qq.com/s/smuIGalT7Qvjy8evVA2mBg##" style="text-decoration:none;margin:20px 0px;padding:1.17em 0px;color:rgb(51, 51, 51);-webkit-tap-highlight-color:rgba(0, 0, 0, 0);display:block;border:1px solid rgb(234, 234, 234);border-width:0px;position:relative;"><span style="color:rgb(51, 51, 51);position:absolute;left:0px;top:0px;right:0px;height:1px;border-top:1px solid rgb(223, 223, 223);transform-origin:0px 0px 0px;transform:scaleY(0.5);"> </span>
                    <div style="margin:0px;display:flex;-webkit-box-align:center;align-items:center;padding:0px;font-size:14px;">
                        <div style="margin:0px;padding:0px;-webkit-box-flex:1;flex:1 1 0%;width:auto;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-wrap:normal;">
                          <p style="margin:0px;padding:0px;color:rgba(0, 0, 0, 0.3);">文章转载自公众号</p>
                        </div>
                        <div style="margin:0px;padding:0px;font-size:14px;color:rgb(136, 136, 136);padding-left:1em;white-space:nowrap;">
                            <span style="margin:0px;display:inline-block;background-color:rgb(255, 255, 255);border-radius:50%;overflow:hidden;vertical-align:middle;padding:0px;width:20px;height:20px;margin-right:0.2em;">
                                                                <img src="7 张图讲清楚ZooKeeper分布式锁实现原理_files/0" type="image/jpeg" data-filename="0" height="20" style="margin:0px;padding:0px;display:block;width:100%;border-radius:50%;background-color:rgb(238, 238, 238);height:100%;" width="20"/>
                                                            </span>
                            <strong style="overflow:hidden;margin:0px;padding:0px;vertical-align:middle;font-weight:400;width:auto;display:inline-block;text-overflow:ellipsis;white-space:nowrap;word-wrap:normal;max-width:8em;color:rgb(0, 0, 0);">
                              石杉的架构笔记
                            </strong>
                        <span style="font-size:14px;color:rgb(136, 136, 136);white-space:nowrap;display:inline-block;height:8px;width:8px;border-width:1px 1px 0px 0px;border-color:rgb(203, 202, 208);border-style:solid;transform:matrix(0.71, 0.71, -0.71, 0.71, 0, 0);position:relative;top:0px;margin-right:4px;"> </span></div>
                    </div>
                <span style="color:rgb(51, 51, 51);position:absolute;left:0px;bottom:0px;right:0px;height:1px;border-bottom:1px solid rgb(223, 223, 223);transform-origin:0px 100% 0px;transform:scaleY(0.5);"> </span></a>
                            </div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 