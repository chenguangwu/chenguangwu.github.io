<html>
<head>
  <title>手把手教你用Strace诊断问题 | 火丁笔记</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8689"/>
<h1>手把手教你用Strace诊断问题 | 火丁笔记</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/3/13 9:23</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://huoding.com/2015/10/16/474"><i>https://huoding.com/2015/10/16/474</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;"><div style="vertical-align:baseline;font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-style:normal;font-weight:300;outline:0px;font-size:15px;background:rgb(226, 226, 226);line-height:1.625;color:rgb(55, 55, 55);font-variant:normal;font-stretch:normal;"><div style="font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;background:rgb(255, 255, 255);"><div style="font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;"><div style="font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;"><div style="font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;"><div>
	<div style="display:block;margin:0px auto;width:68.9%;">
		<h1 style="vertical-align:baseline;border:0px;font-family:inherit;font-style:inherit;padding:0px;margin:0px;outline:0px;clear:both;padding-bottom:0.3em;padding-top:15px;text-decoration:none;font-weight:bold;font-size:28px;padding-right:0px;color:rgb(0, 0, 0);line-height:48px;">手把手教你用Strace诊断问题</h1>

				<div style="vertical-align:baseline;border:0px;font-family:inherit;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;font-size:12px;color:rgb(102, 102, 102);clear:both;line-height:18px;padding-right:0px;position:absolute;top:0px;left:0px;">
			<span style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;">发表于</span><a href="https://huoding.com/2015/10/16/474" rel="bookmark" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;" title="14:22:42"><span>2015-10-16</span></a>		</div>
			</div>

	<div style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;outline:0px;vertical-align:baseline;padding:1.625em 0px 0px;margin:0px auto;width:68.9%;">
		<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">早些年，如果你知道有个 strace 命令，就很牛了，而现在大家基本都知道 strace 了，如果你遇到性能问题求助别人，十有八九会建议你用 strace 挂上去看看，不过当你挂上去了，看着满屏翻滚的字符，却十有八九看不出个所以然。本文通过一个简单的案例，向你展示一下在用 strace 诊断问题时的一些套路。</p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;"><span style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;"></span></p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">如下真实案例，如有雷同，实属必然！让我们看一台高负载服务器的 top 结果：</p>
<div style="outline:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:9px;margin-top:0.4em;background:rgb(238, 238, 238);margin-bottom:1.625em;max-width:1386px;"><a href="https://huoding.com/wp-content/uploads/2015/10/top.jpg" style="margin:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;color:rgb(25, 130, 209);text-decoration:none;"><img src="手把手教你用Strace诊断问题  火丁笔记_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" alt="top" height="1176" style="border:1px solid rgb(221, 221, 221);max-width:calc(100% - 14px);height:auto;width:auto;display:block;padding:6px;border-color:rgb(238, 238, 238);" width="1376"/></a><p style="outline:0px;border:0px;vertical-align:baseline;font-style:inherit;font-weight:inherit;margin:0px;font-family:Georgia, serif;padding:10px 0px 5px 40px;font-size:12px;margin-bottom:0.6em;color:rgb(102, 102, 102);position:relative;"><span style="font-family:Georgia, serif;font-size:14px;font-style:normal;font-weight:bold;color:rgb(102, 102, 102);margin-right:5px;position:absolute;left:10px;top:7px;">—</span>top</p></div>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">技巧：运行 top 时，按「1」打开 CPU 列表，按「shift+p」以 CPU 排序。</p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">在本例中大家很容易发现 CPU 主要是被若干个 PHP 进程占用了，同时 PHP 进程占用的比较多的内存，不过系统内存尚有结余，SWAP 也不严重，这并不是问题主因。</p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">不过在 CPU 列表中能看到 CPU 主要消耗在内核态「sy」，而不是用户态「us」，和我们的经验不符。Linux 操作系统有很多用来跟踪程序行为的工具，内核态的函数调用跟踪用「strace」，用户态的函数调用跟踪用「ltrace」，所以这里我们应该用「strace」：</p>
<pre style="padding:0.75em 1.625em;border:0px;font-size:13px;font-style:normal;font-weight:normal;margin:0px;outline:0px;font-family:&quot;Courier 10 Pitch&quot;, Courier, monospace;vertical-align:baseline;background:rgb(244, 244, 244);font-variant:normal;font-stretch:normal;line-height:1.5;margin-bottom:1.625em;overflow:auto;">shell&gt; strace -p &lt;PID&gt;</pre>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">不过如果直接用 strace 跟踪某个进程的话，那么等待你的往往是满屏翻滚的字符，想从这里看出问题的症结并不是一件容易的事情，好在 strace  可以按操作汇总时间：</p>
<pre style="padding:0.75em 1.625em;border:0px;font-size:13px;font-style:normal;font-weight:normal;margin:0px;outline:0px;font-family:&quot;Courier 10 Pitch&quot;, Courier, monospace;vertical-align:baseline;background:rgb(244, 244, 244);font-variant:normal;font-stretch:normal;line-height:1.5;margin-bottom:1.625em;overflow:auto;">shell&gt; strace -cp &lt;PID&gt;</pre>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">通过「c」选项用来汇总各个操作的总耗时，运行后的结果大概如下图所示：</p>
<div style="outline:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:9px;margin-top:0.4em;background:rgb(238, 238, 238);margin-bottom:1.625em;max-width:1090px;"><a href="https://huoding.com/wp-content/uploads/2015/10/strace1.jpg" style="margin:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;color:rgb(25, 130, 209);text-decoration:none;"><img src="手把手教你用Strace诊断问题  火丁笔记_files/Image [1].jpg" type="image/jpeg" data-filename="Image.jpg" alt="strace -cp <PID>" height="600" style="border:1px solid rgb(221, 221, 221);max-width:calc(100% - 14px);height:auto;width:auto;display:block;padding:6px;border-color:rgb(238, 238, 238);" width="1080"/></a><p style="outline:0px;border:0px;vertical-align:baseline;font-style:inherit;font-weight:inherit;margin:0px;font-family:Georgia, serif;padding:10px 0px 5px 40px;font-size:12px;margin-bottom:0.6em;color:rgb(102, 102, 102);position:relative;"><span style="font-family:Georgia, serif;font-size:14px;font-style:normal;font-weight:bold;color:rgb(102, 102, 102);margin-right:5px;position:absolute;left:10px;top:7px;">—</span>strace -cp</p></div>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">很明显，我们能看到 CPU 主要被 clone 操作消耗了，还可以单独跟踪一下 clone：</p>
<pre style="padding:0.75em 1.625em;border:0px;font-size:13px;font-style:normal;font-weight:normal;margin:0px;outline:0px;font-family:&quot;Courier 10 Pitch&quot;, Courier, monospace;vertical-align:baseline;background:rgb(244, 244, 244);font-variant:normal;font-stretch:normal;line-height:1.5;margin-bottom:1.625em;overflow:auto;">shell&gt; strace -T -e clone -p &lt;PID&gt;</pre>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">通过「T」选项可以获取操作实际消耗的时间，通过「e」选项可以跟踪某个操作：</p>
<div style="outline:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;font-family:inherit;vertical-align:baseline;padding:9px;margin-top:0.4em;background:rgb(238, 238, 238);margin-bottom:1.625em;max-width:1750px;"><a href="https://huoding.com/wp-content/uploads/2015/10/strace2.jpg" style="margin:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;color:rgb(25, 130, 209);text-decoration:none;"><img src="手把手教你用Strace诊断问题  火丁笔记_files/Image [2].jpg" type="image/jpeg" data-filename="Image.jpg" alt="strace -T -e clone -p <PID>" height="410" style="border:1px solid rgb(221, 221, 221);max-width:calc(100% - 14px);height:auto;width:auto;display:block;padding:6px;border-color:rgb(238, 238, 238);" width="1740"/></a><p style="outline:0px;border:0px;vertical-align:baseline;font-style:inherit;font-weight:inherit;margin:0px;font-family:Georgia, serif;padding:10px 0px 5px 40px;font-size:12px;margin-bottom:0.6em;color:rgb(102, 102, 102);position:relative;"><span style="font-family:Georgia, serif;font-size:14px;font-style:normal;font-weight:bold;color:rgb(102, 102, 102);margin-right:5px;position:absolute;left:10px;top:7px;">—</span>strace -T -e clone -p</p></div>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">很明显，一个 clone 操作需要几百毫秒，至于 clone 的含义，参考 man 文档：</p>
<blockquote style="border:0px;font-family:Georgia, &quot;Bitstream Charter&quot;, serif;font-size:100%;font-style:italic;font-weight:normal;margin:0px 3em;outline:0px;padding:0px;vertical-align:baseline;quotes:&quot;&quot; &quot;&quot;;"><span style="font-family:Georgia, &quot;Bitstream Charter&quot;, serif;font-size:100%;font-style:italic;font-weight:normal;quotes:&quot;&quot; &quot;&quot;;"></span><p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">clone() creates a new process, in a manner similar to fork(2). It is actually a library function layered on top of the underlying clone() system call, hereinafter referred to as sys_clone. A description of sys_clone is given towards the end of this page.</p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">Unlike fork(2), these calls allow the child process to share parts of its execution context with the calling process, such as the memory space, the table of file descriptors, and the table of signal handlers. (Note that on this manual page, “calling process” normally corresponds to “parent process”. But see the description of CLONE_PARENT below.)</p><span style="font-family:Georgia, &quot;Bitstream Charter&quot;, serif;font-size:100%;font-style:italic;font-weight:normal;quotes:&quot;&quot; &quot;&quot;;"></span></blockquote>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">简单来说，就是创建一个新进程。那么在 PHP 里什么时候会出现此类系统调用呢？查询业务代码看到了 <a href="http://php.net/manual/en/function.exec.php" rel="noopener" style="margin:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;color:rgb(25, 130, 209);text-decoration:none;" target="_blank">exec</a> 函数，通过如下命令验证它确实会导致 clone 系统调用：</p>
<pre style="padding:0.75em 1.625em;border:0px;font-size:13px;font-style:normal;font-weight:normal;margin:0px;outline:0px;font-family:&quot;Courier 10 Pitch&quot;, Courier, monospace;vertical-align:baseline;background:rgb(244, 244, 244);font-variant:normal;font-stretch:normal;line-height:1.5;margin-bottom:1.625em;overflow:auto;">shell&gt; strace -eclone php -r 'exec(&quot;ls&quot;);'</pre>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">最后再考大家一个题：如果我们用 strace 跟踪一个进程，输出结果很少，是不是说明进程很空闲？其实试试 ltrace，可能会发现别有洞天。记住有内核态和用户态之分。</p>
<p style="border:0px;font-family:inherit;font-size:100%;font-style:inherit;font-weight:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;margin-bottom:1.625em;">推荐阅读：<a href="https://blog.packagecloud.io/eng/2015/11/15/strace-cheat-sheet/" rel="noopener" style="margin:0px;border:0px;font-size:100%;font-style:inherit;font-weight:inherit;font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;color:rgb(25, 130, 209);text-decoration:none;" target="_blank">strace cheat sheet</a></p>
			</div>

	<div style="display:block;color:rgb(102, 102, 102);clear:both;font-size:12px;line-height:18px;margin:0px auto;width:68.9%;">
		此条目由<a href="https://huoding.com/author/laowang" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;">老王</a>发表在<a href="https://huoding.com/category/technical" rel="category tag" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;">Technical</a>分类目录，并贴了<a href="https://huoding.com/tag/linux" rel="tag" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;">Linux</a>、<a href="https://huoding.com/tag/strace" rel="tag" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;">Strace</a>标签。将<a href="https://huoding.com/2015/10/16/474" rel="bookmark" style="margin:0px;border:0px;font-size:100%;font-style:inherit;color:rgb(25, 130, 209);font-family:inherit;outline:0px;padding:0px;vertical-align:baseline;text-decoration:none;font-weight:bold;" title="链向手把手教你用Strace诊断问题的固定链接">固定链接</a>加入收藏夹。		
			</div>
</div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 