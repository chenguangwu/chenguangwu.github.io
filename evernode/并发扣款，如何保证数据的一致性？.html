<html>
<head>
  <title>并发扣款，如何保证数据的一致性？</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="12864"/>
<h1>并发扣款，如何保证数据的一致性？</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/8/29 19:53</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651962738&idx=1&sn=d2d91a380bad06af9f7b9f7a80db26b3&chksm=bd2d08ae8a5a81b8a7f044af52c5e6e77ec3df2bb4a9c91cd450c3fd932e8dade56afb09f784#rd"><i>http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651962738&amp;idx=1&amp;sn=d2d91a380bad06af9f7b9f7a80db26b3&amp;chksm=bd2d08ae8a5a81b8a7f044af52c5e6e77ec3df2bb4a9c91cd450c3fd932e8dade56afb09f784#rd</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="text-size-adjust:100%;line-height:1.6;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);background-color:rgb(242, 242, 242);letter-spacing:0.034em;line-height:1.6;font-size:16px;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div><div style="overflow-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div>

                
                <h2 style="font-weight:400;font-size:22px;margin:0px;padding:0px;line-height:1.4;margin-bottom:14px;">
                    
                    
                    
            并发扣款，如何保证数据的一致性？
                      </h2>
                <div style="margin:0px;padding:0px;margin-bottom:22px;line-height:20px;font-size:0px;overflow-wrap:break-word;word-break:break-all;position:relative;z-index:1;">
                                                            <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);margin-right:0px;color:rgba(0, 0, 0, 0.3);">原创：</span>
                                                                                        <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);">
                                                        58沈剑
                                                    </span>
                                                                
                                        <span style="margin:0px 10px 10px 0px;padding:0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);position:relative;">
                      <a href="#" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);">
                        架构师之路                      </a>
                      
                    </span>


                    <em style="margin:0px 10px 10px 0px;padding:0px;font-style:normal;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);">今天</em>





                </div>

                
                
                                
                
                
                
                                                
                                                                
                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(51, 51, 51);font-size:17px;overflow-wrap:break-word;text-align:justify;position:relative;z-index:0;">
                    

                    

                    
                    
                    <div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">继续解答星球水友提问。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>===<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>沈老师，我们有个业务，同一个用户在<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">并发</span>“查询，逻辑计算，扣款”的情况下，余额可能出现不一致，请问有什么优化方法么？<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>===<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">扣款的业务场景是怎样的？</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">用户购买商品的过程中，要对余额进行查询与修改，大致的业务流程如下：</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">第一步</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，从数据库</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">查询</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">用户现有余额：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;">SELECT money FROM t_yue WHERE uid=$uid;</span></em><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>不妨设查询出来的$old_money=100元。</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">第二步</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，业务层实施</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">业务逻辑计算</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，比如：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>（1）先查询购买商品的价格，例如是80元；<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>（2）再查询产品是否有活动，以及活动折扣，例如是9折；<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>（3）比对余额是否足够，足够时才往下走；</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;line-height:normal;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;">if($old_money&gt; 80*0.9){<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>    $new_money=$old_money-80*0.9=28<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>} else {<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>    return &quot;Not enough minerals&quot;;<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>}</span></em></span><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></em></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">第三步</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，将数据库中的余额进行</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">修改</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">UPDATE t_yue SET money=$new_money WHERE uid=$uid;</em></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">在并发量低的情况下，这个流程没有任何问题，原有金额100元，购买了80元的九折商品（72元），剩余28元。</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">同一个用户，并发扣款可能出现什么问题？<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></strong></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">在分布式环境中，如果并发量很大，这种“查询+修改”的业务有一定概率出现数据不一致。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>极限情况下，可能出现这样的异常流程：</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">步骤一</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，业务1和业务2并发查询余额，是100元。</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;color:rgb(0, 82, 255);"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><img src="并发扣款，如何保证数据的一致性？_files/640.webp" type="image/webp" data-filename="640.webp" height="167" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:220px !important;visibility:visible !important;" width="220"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></em></span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;color:rgb(0, 82, 255);"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;color:rgb(0, 82, 255);font-size:15px;letter-spacing:1px;">画外音：这些并发查询，是在不同的站点实例/服务实例上完成的，进程内互斥锁肯定解决不了。</span></em></span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">步骤二</strong>，业务1和业务2并发进行逻辑计算，算出各自业务的余额，假设业务1算出的余额是28元，业务2算出的余额是38元。</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><img src="并发扣款，如何保证数据的一致性？_files/640 [1].webp" type="image/webp" data-filename="640.webp" height="76" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:203px !important;visibility:visible !important;" width="203"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">步骤三</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，业务1对数据库中的余额先进行修改，设置成28元。</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">业务2对数据库中的余额后进行修改，设置成38元。</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><img src="并发扣款，如何保证数据的一致性？_files/640 [2].webp" type="image/webp" data-filename="640.webp" height="153" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;width:411px !important;visibility:visible !important;" width="411"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">此时异常出现了，原有金额100元，业务1扣除了72元，业务2扣除了62元，最后剩余38元。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(0, 82, 255);"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">画外音：</em><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">假设业务1先写回余额，业务2再写回余额。</em></span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">常见的解决方案？</span></strong></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">对于此案例，同一个用户，并发扣款时，有小概率会出现异常，可以对每一个用户进行</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">分布式锁互斥</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，例如：在redis/zk里抢到一个key才能继续操作，否则禁止操作。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>这种<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">悲观锁</strong>方案确实可行，但要引入额外的组件(redis/zk)，并且会降低吞吐量。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">对于小概率的不一致，有没有乐观锁的方案呢？</strong></span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">对并发扣款进行进一步的分析发现：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">（1）业务1写回时，旧余额100，这是一个</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">初始状态</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">；新余额28，这是一个</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">结束状态</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">。理论上只有在旧余额为100时，新余额才应该写回成功。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>而业务1并发写回时，旧余额确实是100，理应写回成功。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">（2）业务2写回时，<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">旧余额100，这是一个</span></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">初始状态</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">；新余额28，这是一个</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">结束状态</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">。理论上只有在旧余额为100时，新余额才应该写回成功。</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>可实际上，这个时候数据库中的金额已经变为28了，所以业务2的并发写回，不应该成功。</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">如何低成本实施乐观锁？</span></strong></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">在set写回的时候，加上初始状态的条件compare，只有初始状态不变时，才允许set写回成功，</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;">Compare And Set</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">（CAS），是一种常见的降低读写锁冲突，保证数据一致性的方法。</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">此时业务要怎么改？</span></strong></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">使用CAS解决高并发时数据一致性问题，只需要在进行set操作时，compare初始值，如果初始值变换，不允许set成功。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">具体到这个case，只需要将：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">UPDATE t_yue SET money=$new_money WHERE uid=$uid;</em></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>升级为：</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;">UPDATE t_yue SET money=$new_money WHERE uid=$uid </span></em></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:12px;color:rgb(255, 76, 0);"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:12px;letter-spacing:1px;">AND money=$old_money</span></em></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;">;</span></em></span><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>即可。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span></em></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>并发操作发生时：</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">业务1执行：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">UPDATE t_yue SET money=28 WHERE uid=$uid AND money=100;</em></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>业务2执行：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">UPDATE t_yue SET money=38 WHERE uid=$uid AND money=100;</em></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">这两个操作同时进行时，只可能有一个执行成功。</span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">怎么判断哪个并发执行成功，哪个并发执行失败呢？</span></strong></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">set操作，其实无所谓成功或者失败，业务能</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;color:rgb(255, 76, 0);">通过affect rows来判断</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">：</span></div><ul style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;padding-left:2.2em;list-style-type:disc;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">写回成功的，affect rows为1</span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">写回失败的，affect rows为0</span></p></li></ul><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">总结</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">高并发“查询并修改”的场景，可以用CAS</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;">（Compare and Set）</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">的方式解决数据一致性问题。对应到业务，即在set的时候，加上初始条件的比对即可。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>优化不难，只改了半行SQL，但确实能解决问题。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>但希望大家有收获<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;">，思路比结论重要</strong>。<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;"></span></span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;text-align:center;color:rgb(51, 51, 51);clear:both;background-color:transparent;line-height:1.75em;"><img src="并发扣款，如何保证数据的一致性？_files/640 [3].webp" type="image/webp" data-filename="640.webp" height="189" style="margin:0px;padding:0px;max-width:677px;box-sizing:border-box;overflow-wrap:break-word;height:auto !important;visibility:visible !important;width:317px !important;" width="317"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;background-color:rgb(255, 255, 255);clear:both;color:rgb(51, 51, 51);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">欢迎大家继续提问，有问必答。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;padding-bottom:0px;padding-left:0px;padding-right:0px;padding-top:0px;word-wrap:break-word;"/></span></div><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;clear:both;min-height:1em;background-color:rgb(255, 255, 255);color:rgb(51, 51, 51);"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;padding-bottom:0px;padding-left:0px;padding-right:0px;padding-top:0px;word-wrap:break-word;"/></p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;background-color:transparent;color:rgb(51, 51, 51);"></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;background-color:transparent;clear:both;color:rgb(51, 51, 51);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:15px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;padding-bottom:0px;padding-left:0px;padding-right:0px;padding-top:0px;word-wrap:break-word;">答球友问</strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;text-align:justify;color:rgb(0, 0, 0);text-transform:none;text-indent:0px;letter-spacing:1px;">：</span></span></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;text-align:justify;color:rgb(0, 0, 0);text-transform:none;text-indent:0px;font-size:15px;letter-spacing:1px;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651962667&amp;idx=1&amp;sn=7cb8c095550f9cd777da13bdbc02c8b8&amp;chksm=bd2d08f78a5a81e198424bcba45d16bc696073485204aca49e3e5cd8854aabe1491c463ec5fb&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;padding-bottom:0px;padding-left:0px;padding-right:0px;padding-top:0px;word-wrap:break-word;" target="_blank">用DB自增键生成uid了，还能分库吗？</a>》</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;text-align:justify;color:rgb(0, 0, 0);text-transform:none;text-indent:0px;font-size:15px;letter-spacing:1px;">《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651962693&amp;idx=1&amp;sn=03c8aa29078a4321d18f5ee1369aa408&amp;chksm=bd2d08998a5a818fb837de67d378b3f6085bb2e0a19334e000b4e6640ff8d0282ba390deb6e5&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">粉丝关系链，10亿数据，如何设计？</a>》<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651962701&amp;idx=1&amp;sn=19a3bb1c5c4ca4025bfa5a500817341e&amp;chksm=bd2d08918a5a8187ed1a0d77f1aa5bcdc686799b3f9d61a33612f5596286e34a7558feec7365&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">几万条群离线消息，如何高效拉取？</a>》<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/>《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651962726&amp;idx=1&amp;sn=852d19052f55c163e8e7682513ccf6f8&amp;chksm=bd2d08ba8a5a81ac00bcde40963f24801b3ad223520a71c148fa29636825877f954cb8887d74&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);max-width:100%;box-sizing:border-box;overflow-wrap:break-word;" target="_blank">每秒30W次的点赞业务，怎么优化？</a>》</span></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></div><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">作业</span></strong><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-size:15px;letter-spacing:1px;">，为什么不能使用：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"/></span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;letter-spacing:1px;font-size:12px;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;font-style:italic;">UPDATE t_yue SET money=money-$diff;</em></span></div>
                </div>
                

                
  


                
                

                
                                

                
                            </div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 