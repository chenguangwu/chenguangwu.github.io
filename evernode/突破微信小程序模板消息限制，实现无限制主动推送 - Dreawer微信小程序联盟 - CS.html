<html>
<head>
  <title>突破微信小程序模板消息限制，实现无限制主动推送 - Dreawer微信小程序联盟 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="532"/>
<h1>突破微信小程序模板消息限制，实现无限制主动推送 - Dreawer微信小程序联盟 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/5/30 11:20</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://blog.csdn.net/rolan1993/article/details/79398362"><i>https://blog.csdn.net/rolan1993/article/details/79398362</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="box-sizing:border-box;outline:0px;"><div style="-webkit-font-smoothing:antialiased;min-width:1200px;box-sizing:inherit;outline:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:14px;line-height:1.57143;background-color:rgb(245, 246, 247);color:rgb(51, 51, 51);"><div style="box-sizing:border-box;outline:0px;"><span style="box-sizing:inherit;outline:0px;"><div style="background:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 2px 4px 0px;box-sizing:inherit;outline:0px;">
  <div style="border-bottom:1px solid rgb(224, 224, 224);padding-top:16px;z-index:9;background-color:rgb(255, 255, 255);box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
    <div style="box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
      <div style="margin-bottom:8px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
        <span style="display:inline-block;width:26px;height:26px;line-height:26px;text-align:center;font-size:12px;border-radius:50%;color:rgb(134, 202, 94);border:1px solid rgb(231, 244, 223);margin-top:4px;margin-right:8px;box-sizing:inherit;outline:0px;float:left;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">转</span>        <h1 style="font-size:24px;overflow-wrap:break-word;box-sizing:inherit;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">突破微信小程序模板消息限制，实现无限制主动推送</h1>
      </div>
      <div style="padding-bottom:14px;position:relative;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
        <div style="color:rgb(133, 133, 133);width:88%;height:26px;overflow:hidden;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
                                                  <span style="margin-right:14px;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">2018年02月28日 11:32:01</span>
          <a href="https://me.csdn.net/rolan1993" style="color:rgb(120, 165, 241);margin-right:14px;box-sizing:inherit;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">极乐叔</a>
          <span style="margin-right:14px;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">阅读数：34834</span>
          
                          <span style="margin-right:14px;margin-bottom:8px;font-size:12px;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">
                <span style="margin-right:14px;color:rgb(77, 77, 77);box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">标签：</span>
                                  <a href="https://so.csdn.net/so/search/s.do?q=%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F&amp;t=blog" style="color:rgb(77, 77, 77);margin-right:8px;padding:0px 8px;height:21px;min-width:24px;line-height:21px;border:1px solid rgb(204, 204, 204);border-radius:100px;text-align:center;margin-bottom:4px;display:inline-block;overflow-wrap:break-word;box-sizing:inherit;outline:0px;text-decoration:none;cursor:pointer;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">微信小程序                                    </a><a href="https://so.csdn.net/so/search/s.do?q=%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81&amp;t=blog" style="color:rgb(77, 77, 77);margin-right:8px;padding:0px 8px;height:21px;min-width:24px;line-height:21px;border:1px solid rgb(204, 204, 204);border-radius:100px;text-align:center;margin-bottom:4px;display:inline-block;overflow-wrap:break-word;box-sizing:inherit;outline:0px;text-decoration:none;cursor:pointer;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">消息推送                                  </a>
              <span style="margin-right:0px;font-size:12px;color:rgb(51, 153, 234);letter-spacing:0px;line-height:20px;cursor:pointer;background-color:rgb(255, 255, 255);top:0px;right:101px;width:45px;display:inline-block;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">更多</span></span>
                                      <div style="margin-bottom:0px;font-size:12px;margin-top:6px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
                <span style="margin-right:14px;color:rgb(77, 77, 77);box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">个人分类：</span>
                                  <a href="https://blog.csdn.net/rolan1993/article/category/6928109" style="color:rgb(121, 165, 229);display:inline-block;margin-right:24px;overflow-wrap:break-word;box-sizing:inherit;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">微信小程序                                  </a>
              </div>
                                          </div>
        <div style="position:absolute;top:0px;right:0px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
                  </div>
      </div>
    </div>
  </div>
  <div style="position:relative;padding-top:16px;box-sizing:inherit;outline:0px;display:block;margin:0px;padding:0px;">
    <div style="overflow-wrap:break-word;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
            
                              
          <div style="overflow-wrap:break-word;position:relative;min-height:70px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun;">
            <h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t0" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>需求背景</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">基于微信的通知渠道，微信小程序为开发者提供了可以高效触达用户的模板消息能力，在用户本人与小程序页面有交互行为后触发，通过微信聊天列表中的服务通知可快捷进入查看消息，点击查看详情还能跳转到下发消息的小程序的指定页面。</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">微信小程序允许下发模板消息的条件分为两类：支付或者提交表单。通过提交表单来下发模板消息的限制为“允许开发者向用户在7天内推送有限条数的模板消息（1次提交表单可下发1条，多次提交下条数独立，相互不影响）”。</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">然而，用户1次触发7天内推送1条通知是明显不够用的。比如，签到功能利用模板消息的推送来提醒用户每天签到，只能在用户前一天签到的情况下，获取一次推送模板消息的机会，然后用于第二天向该用户发送签到提醒。但是很多情况下，用户在某一天忘记签到，系统便失去了提醒用户的权限，导致和用户断开了联系；再比如，系统想主动告知用户即将做某活动，然而由于微信小程序被动触发通知的限制，系统将无法主动推送消息。</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t1" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>如何突破模板消息的推送限制？</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">突破口：“1次提交表单可下发1条，多次提交下发条数独立，相互不影响”</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">为了突破模板消息的推送限制，实现7天内任性推送，只需收集到足够的推送码，即每次提交表单时获取到的formId。一个formId代表着开发者有向当前用户推送模板消息的一次权限。</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t2" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>客户端</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t3" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>收集推送码</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">当表单组件中的属性report-submit=true时表示发送模板消息，提交表单便可以获取formId。接下来只要对原先的页面进行改造，将用户原先绑定了点击事件的界面用表单组件中的button按钮组件来代替，即把用户的交互点击的bindtap事件由表单bindsubmit来代替，从而捕获用户的点击事件来生成更多的推送码。</p><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;color:rgb(51,51,51);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;"><pre style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:8px;margin:0px 0px 24px;position:relative;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;white-space:pre-wrap;overflow-x:auto;font-size:14px;line-height:22px;color:rgb(0, 0, 0);background:rgb(246,246,246);"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:8px;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;border-radius:4px;display:block;line-height:22px;overflow-x:auto;white-space:pre;font-size:14px;"><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"></span>// 收集推送码
Page({
   formSubmit: funcition(e) {
let formId = e.detail.formId;
this.collectFormIds(formId); //保存推送码
let type = e.detail.target.dataset.type; // 根据type执行点击事件
},

   collectFormIds: function(formId) { 
let formIds = app.globalData.globalFormIds; // 获取全局推送码数组
if (!formIds)
           formIds = [];
let data = {
           formId: formId,
           expire: new Data().getTime() + 60480000 // 7天后的过期时间戳
}
       formIds.push(data);
       app.globalData.globalFormIds = formIds;
},
})
</code></pre></div><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t4" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>上报推送码</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">等待用户下一次发起网络请求时，将globalFormIds发送给服务器。</p><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;color:rgb(51,51,51);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;"><pre style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:8px;margin:0px 0px 24px;position:relative;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;white-space:pre-wrap;overflow-x:auto;font-size:14px;line-height:22px;color:rgb(0, 0, 0);background:rgb(246,246,246);"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:8px;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;border-radius:4px;display:block;line-height:22px;overflow-x:auto;white-space:pre;font-size:14px;"><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"></span>// 上报推送码
Page({
   onLoad: funcition(e) {
this.uploadFormIds(); //上传推送码
},

   collectFormIds: function(formId) { 
var formIds = app.globalData.globalFormIds; // 获取全局推送码
if (formIds.length) {
            formIds = JSON.stringify(formIds); // 转换成JSON字符串
            app.globalData.gloabalFomIds = ''; // 清空当前全局推送码
}
       wx.request({ // 发送到服务器
           url: 'http://xxx',
           method: 'POST',
           data: {
               openId: 'openId',
               formIds: formIds
},
           success: function(res) {
}
});
},
})
</code></pre></div><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t5" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>服务端</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">存储推送码</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">高频IO，采用Redis来存储推送码。</p><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;color:rgb(51,51,51);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;"><pre style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:8px;margin:0px 0px 24px;position:relative;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;white-space:pre-wrap;overflow-x:auto;font-size:14px;line-height:22px;color:rgb(0, 0, 0);background:rgb(246,246,246);"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:8px;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;border-radius:4px;display:block;line-height:22px;overflow-x:auto;white-space:pre;font-size:14px;"><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"></span>/**
* 收集用户推送码
*
* @param openId        用户的openid
* @param formTemplates 用户的表单模板
*/
public void collect(String openId, List&lt;FormTemplateVO&gt; formTemplates) {
   redisTemplate.opsForList().rightPushAll(&quot;mina:openid:&quot; + openId, formTemplates);
}
</code></pre></div><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><h2 style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:8px 0px 16px;font-size:24px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(51,51,51);font-weight:400;line-height:inherit;"><a name="t6" style="color:rgb(78, 161, 219);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"></a>推送模板消息</h2><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">下面实现了群发的功能，针对特定用户类似。</p><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;color:rgb(51,51,51);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;"><pre style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:8px;margin:0px 0px 24px;position:relative;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;white-space:pre-wrap;overflow-x:auto;font-size:14px;line-height:22px;color:rgb(0, 0, 0);background:rgb(246,246,246);"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:8px;font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;border-radius:4px;display:block;line-height:22px;overflow-x:auto;white-space:pre;font-size:14px;"><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"></span>/**
* 推送消息
*
* @param templateId 模板消息id
* @param page       跳转页面
* @param keyWords   模板内容
*/
public void push(String templateId, String page, String keyWords) {
String logPrefix = &quot;推送消息&quot;;

// 获取access token
String accessToken = this.getAccessToken();

// 创建消息通用模板
MsgTemplateVO msgTemplateVO = MsgTemplateVO.builder().template_id(templateId).build();
// 跳转页面
   msgTemplateVO.setPage(StringUtils.isNotBlank(page) ? page : &quot;&quot;);
// 模板内容
if (StringUtils.isNotBlank(keyWords)) {
String[] keyWordArr = keyWords.split(BaseConsts.COMMA_STR);
Map&lt;String, MsgTemplateVO.KeyWord&gt; keyWordMap = new HashMap&lt;&gt;(8);
for (int i = 0; i &lt; keyWordArr.length; i++) {
MsgTemplateVO.KeyWord keyWord = msgTemplateVO.new KeyWord(keyWordArr[i]);
           keyWordMap.put(MsgTemplateVO.KEYWORD + (i + 1), keyWord);
}
       msgTemplateVO.setData(keyWordMap);
} else {
       msgTemplateVO.setData(Collections.emptyMap());
}

// 获取所有用户
List&lt;String&gt; openIdList = minaRedisDao.getAllOpenIds();

for (String openId : openIdList) {
// 获取有效推送码
String formId = minaRedisDao.getValidFormId(openId);
if (StringUtils.isBlank(formId)) {
           LOGGER.error(&quot;{}&gt;&gt;&gt;openId={}&gt;&gt;&gt;已无有效推送码[失败]&quot;, logPrefix, openId);
continue;
}

// 指派消息
MsgTemplateVO assignMsgTemplateVO = msgTemplateVO.assign(openId, formId);

// 发送消息
Map&lt;String, Object&gt; resultMap;
try {
String jsonBody = JsonUtils.getObjectMapper().writeValueAsString(assignMsgTemplateVO);

String resultBody = OkHttpUtils.getInstance().postAsString(messageUrl + accessToken, jsonBody);
           resultMap = JsonUtils.getObjectMapper().readValue(resultBody, Map.class);
} catch (IOException e) {
           LOGGER.error(&quot;{}&gt;&gt;&gt;openId={}&gt;&gt;&gt;{}[失败]&quot;, logPrefix, openId, e.getMessage(), e);
continue;
}

if ((int) resultMap.get(ResponseConsts.Mina.CODE) != 0) {
           LOGGER.error(&quot;{}&gt;&gt;&gt;openId={}&gt;&gt;&gt;{}[失败]&quot;, logPrefix, openId, resultMap.get(ResponseConsts.Mina.MSG));
continue;
}

       LOGGER.info(&quot;{}&gt;&gt;&gt;openId={}&gt;&gt;&gt;[成功]&quot;, logPrefix, openId);
}
}

/**
* 根据用户获取有效的推送码
*
* @param openId 用户的openid
* @return 推送码
*/
public String getValidFormId(String openId) {
List&lt;FormTemplateVO&gt; formTemplates = redisTemplate.opsForList().range(&quot;mina:openid:&quot; + openId, 0, -1);

String validFormId = &quot;&quot;;
int trimStart = 0;

int size;
for (int i = 0; i &lt; (size = formTemplates.size()); i++) {
if (formTemplates.get(i).getExpire() &gt; System.currentTimeMillis()) {
           validFormId = formTemplates.get(i).getFormId();
           trimStart = i + 1;
break;
}
}

// 移除本次使用的和已过期的
   redisTemplate.opsForList().trim(KEY_MINA_PUSH + openId, trimStart == 0 ? size : trimStart, -1);

return validFormId;
}
</code></pre></div><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;">以上方案可以实现在用户最后一次使用小程序后的7天内，对用户发送多条模板消息唤回用户。</p><p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;color:rgb(51,51,51);font-weight:400;line-height:26px;overflow-x:auto;"><br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/></p><blockquote style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:16px 16px 0px;margin:0px 0px 24px;display:block;border-left:4px solid rgb(226,227,228);background:rgb(238, 240, 244);overflow:auto;word-break:normal;color:rgb(51,51,51);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:14px;"><span style=""></span><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">作者：Joker_Coding <br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/>链接：<a href="http://link.zhihu.com/?target=https%3A//www.jianshu.com/p/3b02d75ef0dc" rel="nofollow" style="color:rgb(34,85,153);overflow-wrap:break-word;box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;border-bottom:1px solid rgba(68,68,68,.721569);border-top-color:rgba(133,144,166,.721569);border-right-color:rgba(133,144,166,.721569);border-left-color:rgba(133,144,166,.721569);" target="_blank"><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:a;font-style:normal;font-size:0px;line-height:0;">https://www.</span><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">jianshu.com/p/3b02d75ef</span><span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:a;font-style:normal;font-size:0px;line-height:0;">0dc</span><span style="position:relative;line-height:1.5em;max-height:3em;overflow:hidden;overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;"><span style="line-height:1.5em;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;position:absolute;z-index:1;bottom:0px;right:0px;width:24px;padding-left:8px;box-sizing:border-box;background:linear-gradient(to right, transparent, rgb(255, 255, 255) 40%);">...</span><span style="line-height:1.5em;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;display:inline-block;position:absolute;z-index:2;width:100%;height:100%;background-color:rgb(255, 255, 255);"></span></span></a> <br style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;"/>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</span><span style=""></span></blockquote>          </div>
                  <span style="display:block;height:0px;visibility:hidden;clear:both;"></span></div>
  </div>
</div></span></div></div></div></div><br/></div></span>
</div></body></html> 