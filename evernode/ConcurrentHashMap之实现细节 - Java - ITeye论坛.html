<html>
<head>
  <title>ConcurrentHashMap之实现细节 - Java - ITeye论坛</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8171"/>
<h1>ConcurrentHashMap之实现细节 - Java - ITeye论坛</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2015/10/17 23:32</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.iteye.com/topic/344876"><i>http://www.iteye.com/topic/344876</i></a></td></tr>
</table>
</div>
<br/>

<div><span><br/><div style="font-size: 16px"><div><div style="text-align:center;font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:12px;line-height:1.5;color:black;background:white;"><div style="text-align:center;background:white;"><div style="text-align:left;"><div>
          



          




<div style="display:block;">
  <div style="float:left;font-size:1.1em;color:rgb(0, 102, 153);">
    <a href="http://www.iteye.com/forums" style="color:rgb(0, 102, 153);text-decoration:underline;margin-left:5px;">论坛首页</a> <span style="font-weight:normal;font-size:0.9em;color:rgb(153, 153, 153);margin-left:5px;">→</span>
    <a href="http://www.iteye.com/forums/board/Java" style="color:rgb(0, 102, 153);text-decoration:underline;margin-left:5px;">Java企业应用论坛</a> <span style="font-weight:normal;font-size:0.9em;color:rgb(153, 153, 153);margin-left:5px;">→</span>
    <h1 style="line-height:1.5em;margin:0px 0px 0.5em;padding:0px;font-size:1em;color:rgb(0, 102, 153);font-weight:normal;display:inline;">ConcurrentHashMap之实现细节</h1>
  </div>
<span style="display:block;height:0px;clear:both;visibility:hidden;">.</span></div>


  <div style="height:20px;width:100%;margin:10px 0px 0px 25px;">
    <a href="http://www.iteye.com/forums/board/Java" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">全部</a>
          <a href="http://www.iteye.com/forums/tag/Hibernate" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Hibernate</a>
          <a href="http://www.iteye.com/forums/tag/Spring" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Spring</a>
          <a href="http://www.iteye.com/forums/tag/Struts" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Struts</a>
          <a href="http://www.iteye.com/forums/tag/iBATIS" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">iBATIS</a>
          <a href="http://www.iteye.com/forums/tag/%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">企业应用</a>
          <a href="http://www.iteye.com/forums/tag/Lucene" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Lucene</a>
          <a href="http://www.iteye.com/forums/tag/SOA" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">SOA</a>
              <a href="http://www.iteye.com/forums/tag/Java%E7%BB%BC%E5%90%88" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Java综合</a>
          <a href="http://www.iteye.com/forums/tag/Tomcat" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">Tomcat</a>
          <a href="http://www.iteye.com/forums/tag/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">设计模式</a>
          <a href="http://www.iteye.com/forums/tag/OO" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">OO</a>
          <a href="http://www.iteye.com/forums/tag/JBoss" style="color:rgb(0, 102, 153);text-decoration:underline;line-height:100%;padding:2px 7px;">JBoss</a>
      </div>


<div style="height:30px;margin:10px 0px 5px;">
  <div style="float:left;"></div>
  <div style="width:750px;float:right;">
    <div style="float:left;margin-top:5px;"></div>
    <div style="padding:5px;float:right;"><span style="padding:2px 5px;margin:2px;border:1px solid rgb(238, 238, 238);color:rgb(221, 221, 221);">« 上一页</span> <span style="padding:2px 5px;margin:2px;border:1px solid rgb(0, 102, 153);font-weight:bold;color:rgb(255, 255, 255);background-color:rgb(0, 102, 153);">1</span> <a href="http://www.iteye.com/topic/344876?page=2" rel="next" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">2</a> <a href="http://www.iteye.com/topic/344876?page=3" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">3</a> <a href="http://www.iteye.com/topic/344876?page=2" rel="next" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">下一页 »</a></div>
    <div style="float:right;margin:5px 25px 0px 0px;">浏览 124794 次</div>
  </div>
</div>



<table cellspacing="1" style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;width:100%;border:2px solid rgb(0, 102, 153);border-collapse:separate;background-color:rgb(255, 255, 255);">
  <thead>
    <tr>
      <th colspan="2" style="font-weight:bold;text-align:left;border-width:1px 1px 4px;border-style:solid;border-color:white white rgb(209, 215, 220);background-color:rgb(222, 227, 231);">
        <div style="padding:3px 0px;float:left;font-size:14px;width:660px;text-align:center;overflow:hidden;"><span style="color:gray;">锁定老帖子</span> <a href="http://www.iteye.com/topic/344876" style="color:rgb(0, 102, 153);text-decoration:none;">主题：ConcurrentHashMap之实现细节</a></div>
        <div style="padding:3px 5px 3px 0px;float:right;font-weight:normal;"><strong style="font-weight:bold;text-decoration:none;color:rgb(226, 136, 34);">该帖已经被评为良好帖</strong></div>
      </th>
    </tr>
    <tr>
      <td style="border-top-style:solid;font-size:1.1em;color:rgb(255, 163, 79);font-weight:bold;text-align:center;border-top-width:1px;padding:5px;border-top-color:white;background-image:url(http://www.iteye.com/images/bg_cel2.gif);border-left-width:1px;border-left-style:solid;border-left-color:white;">作者</td>
      <td style="border-top-style:solid;font-size:1.1em;color:rgb(255, 163, 79);font-weight:bold;text-align:center;border-top-width:1px;padding:5px;border-top-color:white;background-image:url(http://www.iteye.com/images/bg_cel2.gif);border-right-width:1px;border-right-style:solid;border-right-color:white;">正文
      
      </td>
    </tr>
  </thead>
  <tbody>
    <tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">marlonyao</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/star2.gif" type="image/gif" data-filename="star2.gif" alt="二星会员" height="14" style="border:0px;" title="二星会员" width="28"/></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo.gif" type="image/gif" data-filename="user-logo.gif" alt="marlonyao的博客" height="120" style="border:0px;width:120px;" title="marlonyao的博客: marlonyao"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1.gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 37</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 200</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 北京</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline.gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-06  
        最后修改：2009-04-14
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
        
              
    <div style="font-size:12px;line-height:1.5;border:1px solid rgb(204, 204, 204);padding:4px;margin-bottom:10px;float:left;width:557px;background:rgb(255, 255, 255);">
      <span style="margin-right:5px;">
        <a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;border:1px solid #ccc;padding:0 3px;size:13px;">&lt;</a>
        <a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;border:1px solid #ccc;padding:0 3px;size:13px;">&gt;</a>
      </span>
      猎头职位: <span><a href="http://www.iteye.com/jobs/2509" style="color:#000;text-decoration:underline;" target="_blank"><span style="font-weight:bold;">上海: </span> Junior Product Manager</a></span>
      
    </div>

        
      
                                            <div style="overflow:hidden;float:right;margin:0px 5px;border:1px dashed gray;width:200px;padding:5px;cursor:move;background-color:rgb(253, 251, 219);font-size:12px;line-height:1.5;position:relative;">相关文章: <span style="margin-left:125px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;padding:4px;background-image:url(http://www.iteye.com/images/icon_close.jpg);background-position:50% 50%;background-repeat:no-repeat;" title="关闭"> </a></span>
              <ul style="margin:0px 0px 1.5em;padding:0px;">
                                  <li style="padding:0px;margin:5px 5px 5px 15px;list-style:square;"><a href="http://www.iteye.com/topic/1103980" style="color:rgb(0, 102, 153);text-decoration:underline;" target="_blank" title="Java并发编程之ConcurrentHashMap">Java并发编程之ConcurrentHashMap</a></li>
                                  <li style="padding:0px;margin:5px 5px 5px 15px;list-style:square;"><a href="http://www.iteye.com/topic/1120843" style="color:rgb(0, 102, 153);text-decoration:underline;" target="_blank" title="说一说java里面的hashcode–Object.hashcode()">说一说java里面的hashcode–Object.hashcode()</a></li>
                                  <li style="padding:0px;margin:5px 5px 5px 15px;list-style:square;"><a href="http://www.iteye.com/topic/977348" style="color:rgb(0, 102, 153);text-decoration:underline;" target="_blank" title="java.util.concurrent 之ConcurrentHashMap 源码分析">java.util.concurrent 之ConcurrentHashMap 源码分析</a></li>
                              </ul>
              <br/><span>推荐群组: <a href="http://hllvm.group.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:underline;" target="_blank">高级语言虚拟机</a></span>
              <br/><a href="http://www.iteye.com/wiki/topic/344876" style="color:rgb(0, 102, 153);text-decoration:underline;" target="_blank">更多相关推荐</a>
            </div>
            
                          
      
      <p style="margin:0px;padding:0px;">ConcurrentHashMap是Java 5中支持高并发、高吞吐量的线程安全HashMap实现。在这之前我对ConcurrentHashMap只有一些肤浅的理解，仅知道它采用了多个锁，大概也足够了。但是在经过一次惨痛的面试经历之后，我觉得必须深入研究它的实现。面试中被问到读是否要加锁，因为读写会发生冲突，我说必须要加锁，我和面试官也因此发生了冲突，结果可想而知。还是闲话少说，通过仔细阅读源代码，现在总算理解ConcurrentHashMap实现机制了，其实现之精巧，令人叹服，与大家共享之。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span><strong style="font-weight:bold;"><span style="font-size:small;">实现原理</span>
<span style="font-size:x-small;"><br/></span>
</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span><strong style="font-weight:bold;"><span style="font-size:x-small;">锁分离 (Lock Stripping)</span>
</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">ConcurrentHashMap允许多个修改操作并发进行，其关键在于使用了锁分离技术。它使用了多个锁来控制对hash表的不同部分进行的修改。ConcurrentHashMap内部使用段(Segment)来表示这些不同的部分，每个段其实就是一个小的hash table，它们有自己的锁。只要多个修改操作发生在不同的段上，它们就可以并发进行。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">有些方法需要跨段，比如size()和containsValue()，它们可能需要锁定整个表而而不仅仅是某个段，这需要按顺序锁定所有段，操作完毕后，又按顺序释放所有段的锁。这里“按顺序”是很重要的，否则极有可能出现死锁，在ConcurrentHashMap内部，段数组是final的，并且其成员变量实际上也是final的，但是，仅仅是将数组声明为final的并不保证数组成员也是final的，这需要实现上的保证。这可以确保不会出现死锁，因为获得锁的顺序是固定的。不变性是多线程编程占有很重要的地位，下面还要谈到。</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image.png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;"> * The segments, each of which is a specialized hash table</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;"> */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> Segment&lt;K,V&gt;[] segments;  </span></span></li></ol></div>
 
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span><strong style="font-weight:bold;">不变(Immutable)和易变(Volatile)</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">ConcurrentHashMap完全允许多个读操作并发进行，读操作并不需要加锁。如果使用传统的技术，如HashMap中的实现，如果允许可以在hash链的中间添加或删除元素，读操作不加锁将得到不一致的数据。ConcurrentHashMap实现技术是保证HashEntry几乎是不可变的。HashEntry代表每个hash链中的一个节点，其结构如下所示：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [1].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">static</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">class</span><span style="color:black;"> HashEntry&lt;K,V&gt; {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> K key;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">volatile</span><span style="color:black;"> V value;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> HashEntry&lt;K,V&gt; next;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;">可以看到除了value不是final的，其它值都是final的，这意味着不能从hash链的中间或尾部添加或删除节点，因为这需要修改next引用值，所有的节点的修改只能从头部开始。对于put操作，可以一律添加到Hash链的头部。但是对于remove操作，可能需要从中间删除一个节点，这就需要将要删除节点的前面所有节点整个复制一遍，最后一个节点指向要删除结点的下一个结点。这在讲解删除操作时还会详述。为了确保读操作能够看到最新的值，将value设置成volatile，这避免了加锁。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><br/><span style="font-size:x-small;"><strong style="font-weight:bold;">其它</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">为了加快定位段以及段中hash槽的速度，每个段hash槽的的个数都是2^n，这使得通过位运算就可以定位段和段中hash槽的位置。当并发级别为默认值16时，也就是段的个数，hash值的高4位决定分配在哪个段中。但是我们也不要忘记《算法导论》给我们的教训：hash槽的的个数不应该是2^n，这可能导致hash槽分配不均，这需要对hash值重新再hash一次。（这段似乎有点多余了<img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_sad.gif" type="image/gif" data-filename="icon_sad.gif" height="19" style="border:0px;" width="19"/>
）</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">这是重新hash的算法，还比较复杂，我也懒得去理解了。</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [2].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">private</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">static</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash(</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> h) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// Spread bits to regularize both segment and index locations,</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// using variant of single-word Wang/Jenkins hash.</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    h += (h &lt;&lt;  <span style="color:rgb(192, 0, 0);">15</span><span style="color:black;">) ^ </span><span style="color:rgb(192, 0, 0);">0xffffcd7d</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    h ^= (h &gt;&gt;&gt; <span style="color:rgb(192, 0, 0);">10</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    h += (h &lt;&lt;   <span style="color:rgb(192, 0, 0);">3</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    h ^= (h &gt;&gt;&gt;  <span style="color:rgb(192, 0, 0);">6</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    h += (h &lt;&lt;   <span style="color:rgb(192, 0, 0);">2</span><span style="color:black;">) + (h &lt;&lt; </span><span style="color:rgb(192, 0, 0);">14</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> h ^ (h &gt;&gt;&gt; </span><span style="color:rgb(192, 0, 0);">16</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">这是定位段的方法：</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [3].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> Segment&lt;K,V&gt; segmentFor(</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> segments[(hash &gt;&gt;&gt; segmentShift) &amp; segmentMask];  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
 
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span style="font-size:small;"><strong style="font-weight:bold;">数据结构</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">关于Hash表的基础数据结构，这里不想做过多的探讨。Hash表的一个很重要方面就是如何解决hash冲突，ConcurrentHashMap和HashMap使用相同的方式，都是将hash值相同的节点放在一个hash链中。与HashMap不同的是，ConcurrentHashMap使用多个子Hash表，也就是段(Segment)。下面是ConcurrentHashMap的数据成员：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [4].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">public</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">class</span><span style="color:black;"> ConcurrentHashMap&lt;K, V&gt; </span><span style="color:rgb(127, 0, 85);font-weight:bold;">extends</span><span style="color:black;"> AbstractMap&lt;K, V&gt;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">implements</span><span style="color:black;"> ConcurrentMap&lt;K, V&gt;, Serializable {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     * Mask value for indexing into segments. The upper bits of a</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     * key's hash code are used to choose the segment.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> segmentMask;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     * Shift value for indexing within segments.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> segmentShift;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     * The segments, each of which is a specialized hash table</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">     */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> Segment&lt;K,V&gt;[] segments;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">所有的成员都是final的，其中segmentMask和segmentShift主要是为了定位段，参见上面的segmentFor方法。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">每个Segment相当于一个子Hash表，它的数据成员如下：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [5].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:black;">    </span><span style="color:rgb(127, 0, 85);font-weight:bold;">static</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">class</span><span style="color:black;"> Segment&lt;K,V&gt; </span><span style="color:rgb(127, 0, 85);font-weight:bold;">extends</span><span style="color:black;"> ReentrantLock </span><span style="color:rgb(127, 0, 85);font-weight:bold;">implements</span><span style="color:black;"> Serializable {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">private</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">static</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">long</span><span style="color:black;"> serialVersionUID = 2249069246763182397L;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * The number of elements in this segment's region.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">transient</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">volatile</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> count;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * Number of updates that alter the size of the table. This is</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * used during bulk-read methods to make sure they see a</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * consistent snapshot: If modCounts change during a traversal</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * of segments computing size or checking containsValue, then</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * we might have an inconsistent view of state so (usually)</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * must retry.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">transient</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> modCount;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * The table is rehashed when its size exceeds this threshold.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * (The value of this field is always &lt;tt&gt;(int)(capacity *</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * loadFactor)&lt;/tt&gt;.)</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">transient</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> threshold;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * The per-segment table.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">transient</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">volatile</span><span style="color:black;"> HashEntry&lt;K,V&gt;[] table;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">/**</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * The load factor for the hash table.  Even though this value</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * is same for all segments, it is replicated to avoid needing</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * links to outer object.</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         * @serial</span> </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">         */</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">float</span><span style="color:black;"> loadFactor;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;">
count用来统计该段数据的个数，它是volatile，它用来协调修改和读取操作，以保证读取操作能够读取到几乎最新的修改。协调方式是这样的，每次修改操作做了结构上的改变，如增加/删除节点(修改节点的值不算结构上的改变)，都要写count值，每次读取操作开始都要读取count的值。这利用了Java 5中对volatile语义的增强，对同一个volatile变量的写和读存在happens-before关系。modCount统计段结构改变的次数，主要是为了检测对多个段进行遍历过程中某个段是否发生改变，在讲述跨段操作时会还会详述。threashold用来表示需要进行rehash的界限值。table数组存储段中节点，每个数组元素是个hash链，用HashEntry表示。table也是volatile，这使得能够读取到最新的table值而不需要同步。loadFactor表示负载因子。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span style="font-size:small;"><strong style="font-weight:bold;">实现细节</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><strong style="font-weight:bold;"><span style="font-size:x-small;">修改操作</span>
</strong>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">先来看下删除操作remove(key)。</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [6].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">public</span><span style="color:black;"> V remove(Object key) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"> hash = hash(key.hashCode());  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> segmentFor(hash).remove(key, hash, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;">整个操作是先定位到段，然后委托给段的remove操作。当多个删除操作并发进行时，只要它们所在的段不相同，它们就可以同时进行。下面是Segment的remove方法实现：</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [7].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:black;">V remove(Object key, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash, Object value) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    lock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">try</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> c = count - </span><span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt;[] tab = table;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> index = hash &amp; (tab.length - </span><span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; first = tab[index];  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; e = first;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;"> &amp;&amp; (e.hash != hash || !key.equals(e.key)))  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            e = e.next;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        V oldValue = <span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            V v = e.value;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (value == </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;"> || value.equals(v)) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                oldValue = v;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// All entries following removed node can stay</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// in list, but all preceding ones need to be</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// cloned.</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                ++modCount;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                HashEntry&lt;K,V&gt; newFirst = e.next;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (HashEntry&lt;K,V&gt; p = first; p != e; p = p.next)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    newFirst = <span style="color:rgb(127, 0, 85);font-weight:bold;">new</span><span style="color:black;"> HashEntry&lt;K,V&gt;(p.key, p.hash,  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                                                  newFirst, p.value);  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                tab[index] = newFirst;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                count = c; <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// write-volatile</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> oldValue;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    } <span style="color:rgb(127, 0, 85);font-weight:bold;">finally</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        unlock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> 整个操作是在持有段锁的情况下执行的，空白行之前的行主要是定位到要删除的节点e。接下来，如果不存在这个节点就直接返回null，否则就要将e前面的结点复制一遍，尾结点指向e的下一个结点。e后面的结点不需要复制，它们可以重用。下面是个示意图，我直接从<a href="http://www.ibm.com/developerworks/java/library/j-jtp08223/" style="color:rgb(0, 102, 153);text-decoration:underline;">这个网站</a>
上复制的（画这样的图实在是太麻烦了，如果哪位有好的画图工具，可以推荐一下）。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">删除元素之前：</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" alt="a hash chain before an element is removed" height="80" style="border:0px;" width="481"/></p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">删除元素3之后：</p>
<p style="margin:0px;padding:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [1].jpg" type="image/jpeg" data-filename="Image.jpg" alt="the chain with element 3 removed" height="167" style="border:0px;" width="468"/></p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">第二个图其实有点问题，复制的结点中应该是值为2的结点在前面，值为1的结点在后面，也就是刚好和原来结点顺序相反，还好这不影响我们的讨论。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">整个remove实现并不复杂，但是需要注意如下几点。第一，当要删除的结点存在时，删除的最后一步操作要将count的值减一。这必须是最后一步操作，否则读取操作可能看不到之前对段所做的结构性修改。第二，remove执行的开始就将table赋给一个局部变量tab，这是因为table是volatile变量，读写volatile变量的开销很大。编译器也不能对volatile变量的读写做任何优化，直接多次访问非volatile实例变量没有多大影响，编译器会做相应优化。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">接下来看put操作，同样地put操作也是委托给段的put方法。下面是段的put方法：</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [8].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:black;">V put(K key, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash, V value, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">boolean</span><span style="color:black;"> onlyIfAbsent) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    lock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">try</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> c = count;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (c++ &gt; threshold) </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// ensure capacity</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            rehash();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt;[] tab = table;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> index = hash &amp; (tab.length - </span><span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; first = tab[index];  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; e = first;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;"> &amp;&amp; (e.hash != hash || !key.equals(e.key)))  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            e = e.next;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        V oldValue;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            oldValue = e.value;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (!onlyIfAbsent)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                e.value = value;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">else</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            oldValue = <span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            ++modCount;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            tab[index] = <span style="color:rgb(127, 0, 85);font-weight:bold;">new</span><span style="color:black;"> HashEntry&lt;K,V&gt;(key, hash, first, value);  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            count = c; <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// write-volatile</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> oldValue;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    } <span style="color:rgb(127, 0, 85);font-weight:bold;">finally</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        unlock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;">该方法也是在持有段锁的情况下执行的，首先判断是否需要rehash，需要就先rehash。接着是找是否存在同样一个key的结点，如果存在就直接替换这个结点的值。否则创建一个新的结点并添加到hash链的头部，这时一定要修改modCount和count的值，同样修改count的值一定要放在最后一步。put方法调用了rehash方法，reash方法实现得也很精巧，主要利用了table的大小为2^n，这里就不介绍了。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">修改操作还有putAll和replace。putAll就是多次调用put方法，没什么好说的。replace甚至不用做结构上的更改，实现要比put和delete要简单得多，理解了put和delete，理解replace就不在话下了，这里也不介绍了。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><strong style="font-weight:bold;"><span style="font-size:x-small;">获取操作</span>
</strong>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">首先看下get操作，同样ConcurrentHashMap的get操作是直接委托给Segment的get方法，直接看Segment的get方法：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [9].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:black;">V get(Object key, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (count != </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) { </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// read-volatile</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; e = getFirst(hash);  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (e.hash == hash &amp;&amp; key.equals(e.key)) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                V v = e.value;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (v != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> v;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> readValueUnderLock(e); </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// recheck</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            e = e.next;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">get操作不需要锁。第一步是访问count变量，这是一个volatile变量，由于所有的修改操作在进行结构修改时都会在最后一步写count变量，通过这种机制保证get操作能够得到几乎最新的结构更新。对于非结构更新，也就是结点值的改变，由于HashEntry的value变量是volatile的，也能保证读取到最新的值。接下来就是对hash链进行遍历找到要获取的结点，如果没有找到，直接访回null。对hash链进行遍历不需要加锁的原因在于链指针next是final的。但是头指针却不是final的，这是通过getFirst(hash)方法返回，也就是存在table数组中的值。这使得getFirst(hash)可能返回过时的头结点，例如，当执行get方法时，刚执行完getFirst(hash)之后，另一个线程执行了删除操作并更新头结点，这就导致get方法中返回的头结点不是最新的。这是可以允许，通过对count变量的协调机制，get能读取到几乎最新的数据，虽然可能不是最新的。要得到最新的数据，只有采用完全的同步。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">最后，如果找到了所求的结点，判断它的值如果非空就直接返回，否则在有锁的状态下再读一次。这似乎有些费解，理论上结点的值不可能为空，这是因为put的时候就进行了判断，如果为空就要抛NullPointerException。空值的唯一源头就是HashEntry中的默认值，因为HashEntry中的value不是final的，非同步读取有可能读取到空值。仔细看下put操作的语句：tab[index] = new HashEntry&lt;K,V&gt;(key, hash, first, value)，在这条语句中，HashEntry构造函数中对value的赋值以及对tab[index]的赋值可能被重新排序，这就可能导致结点的值为空。这种情况应当很罕见，一旦发生这种情况，ConcurrentHashMap采取的方式是在持有锁的情况下再读一遍，这能够保证读到最新的值，并且一定不会为空值。</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [10].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:black;">V readValueUnderLock(HashEntry&lt;K,V&gt; e) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    lock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">try</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> e.value;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    } <span style="color:rgb(127, 0, 85);font-weight:bold;">finally</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        unlock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
 
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">另一个操作是containsKey，这个实现就要简单得多了，因为它不需要读取值：</p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [11].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">boolean</span><span style="color:black;"> containsKey(Object key, </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> hash) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (count != </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) { </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// read-volatile</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        HashEntry&lt;K,V&gt; e = getFirst(hash);  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (e != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (e.hash == hash &amp;&amp; key.equals(e.key))  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">true</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            e = e.next;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">false</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
 
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><span style="font-size:x-small;"><strong style="font-weight:bold;">跨段操作</strong>
<br/></span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">有些操作需要涉及到多个段，比如说size(), containsValaue()。先来看下size()方法：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [12].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">public</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> size() {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> Segment&lt;K,V&gt;[] segments = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">this</span><span style="color:black;">.segments;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">long</span><span style="color:black;"> sum = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">long</span><span style="color:black;"> check = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;">[] mc = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">new</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;">[segments.length];  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// Try a few times to get accurate count. On failure due to</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// continuous async changes in table, resort to locking.</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> k = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; k &lt; RETRIES_BEFORE_LOCK; ++k) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        check = <span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        sum = <span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> mcsum = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            sum += segments[i].count;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            mcsum += mc[i] = segments[i].modCount;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (mcsum != </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                check += segments[i].count;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (mc[i] != segments[i].modCount) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    check = -<span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">; </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// force retry</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    <span style="color:rgb(127, 0, 85);font-weight:bold;">break</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (check == sum)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">break</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (check != sum) { </span><span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// Resort to locking all segments</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        sum = <span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            segments[i].lock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            sum += segments[i].count;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            segments[i].unlock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (sum &gt; Integer.MAX_VALUE)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> Integer.MAX_VALUE;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">else</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;">)sum;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">size方法主要思路是先在没有锁的情况下对所有段大小求和，如果不能成功（这是因为遍历过程中可能有其它线程正在对已经遍历过的段进行结构性更新），最多执行RETRIES_BEFORE_LOCK次，如果还不成功就在持有所有段锁的情况下再对所有段大小求和。在没有锁的情况下主要是利用Segment中的modCount进行检测，在遍历过程中保存每个Segment的modCount，遍历完成之后再检测每个Segment的modCount有没有改变，如果有改变表示有其它线程正在对Segment进行结构性并发更新，需要重新计算。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">其实这种方式是存在问题的，在第一个内层for循环中，在这两条语句sum += segments[i].count; mcsum += mc[i] = segments[i].modCount;之间，其它线程可能正在对Segment进行结构性的修改，导致segments[i].count和segments[i].modCount读取的数据并不一致。这可能使size()方法返回任何时候都不曾存在的大小，很奇怪javadoc居然没有明确标出这一点，可能是因为这个时间窗口太小了吧。size()的实现还有一点需要注意，必须要先segments[i].count，才能segments[i].modCount，这是因为segment[i].count是对volatile变量的访问，接下来segments[i].modCount才能得到几乎最新的值（前面我已经说了为什么只是“几乎”了）。这点在containsValue方法中得到了淋漓尽致的展现：</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [13].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">public</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">boolean</span><span style="color:black;"> containsValue(Object value) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (value == </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">throw</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">new</span><span style="color:black;"> NullPointerException();  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// See explanation of modCount use above</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> Segment&lt;K,V&gt;[] segments = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">this</span><span style="color:black;">.segments;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;">[] mc = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">new</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;">[segments.length];  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// Try a few times without locking</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> k = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; k &lt; RETRIES_BEFORE_LOCK; ++k) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> sum = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> mcsum = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> c = segments[i].count;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            mcsum += mc[i] = segments[i].modCount;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (segments[i].containsValue(value))  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">true</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">boolean</span><span style="color:black;"> cleanSweep = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">true</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (mcsum != </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> c = segments[i].count;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (mc[i] != segments[i].modCount) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    cleanSweep = <span style="color:rgb(127, 0, 85);font-weight:bold;">false</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    <span style="color:rgb(127, 0, 85);font-weight:bold;">break</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (cleanSweep)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">false</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(0, 130, 0);padding:0px;margin:0px;width:auto;border:0px;">// Resort to locking all segments</span><span style="color:black;">  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        segments[i].lock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">boolean</span><span style="color:black;"> found = </span><span style="color:rgb(127, 0, 85);font-weight:bold;">false</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">try</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (segments[i].containsValue(value)) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                found = <span style="color:rgb(127, 0, 85);font-weight:bold;">true</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">break</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    } <span style="color:rgb(127, 0, 85);font-weight:bold;">finally</span><span style="color:black;"> {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> i = </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; i &lt; segments.length; ++i)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            segments[i].unlock();  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;"> found;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
 
<p style="margin:0px;padding:0px;">同样注意内层的第一个for循环，里面有语句int c = segments[i].count; 但是c却从来没有被使用过，即使如此，编译器也不能做优化将这条语句去掉，因为存在对volatile变量count的读取，这条语句存在的唯一目的就是保证segments[i].modCount读取到几乎最新的值。关于containsValue方法的其它部分就不分析了，它和size方法差不多。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">跨段方法中还有一个isEmpty()方法，其实现比size()方法还要简单，也不介绍了。最后简单地介绍下迭代方法，如keySet(), values(), entrySet()方法，这些方法都返回相应的迭代器，所有迭代器都继承于Hash_Iterator类(提交时居然提醒我不能包含sh It，只得加了下划线)，里实现了主要的方法。其结构是：</p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [14].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">abstract</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">class</span><span style="color:black;"> Hash_Iterator{  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> nextSegmentIndex;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> nextTableIndex;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    HashEntry&lt;K,V&gt;[] currentTable;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    HashEntry&lt;K, V&gt; nextEntry;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    HashEntry&lt;K, V&gt; lastReturned;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> nextSegmentIndex是段的索引，nextTableIndex是nextSegmentIndex对应段中中hash链的索引，currentTable是nextSegmentIndex对应段的table。调用next方法时主要是调用了advance方法：</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<div style="font-family:Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', Consolas, 'Courier New', monospace;font-size:12px;width:97%;overflow:auto;margin-left:9px;padding:1px;word-break:break-all;word-wrap:break-word;background-color:transparent;"><div><div style="padding:3px;text-align:left;margin:0px;color:black;font-weight:bold;">Java代码 <div></div> <a href="#" style="color:rgb(0, 102, 153);text-decoration:underline;" title="收藏这段代码"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [15].png" type="image/png" data-filename="Image.png" alt="收藏代码" height="14" style="border:0px;" width="15"/></a></div></div><ol start="1" style="font-size:1em;line-height:1.4em;margin:0px 0px 1px;padding:2px 0px;border:1px solid rgb(209, 215, 220);list-style:decimal;color:rgb(43, 145, 175);background-color:rgb(255, 255, 255);"><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;"><span style="color:rgb(127, 0, 85);font-weight:bold;">final</span><span style="color:black;"> </span><span style="color:rgb(127, 0, 85);font-weight:bold;">void</span><span style="color:black;"> advance() {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (nextEntry != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;"> &amp;&amp; (nextEntry = nextEntry.next) != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (nextTableIndex &gt;= </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> ( (nextEntry = currentTable[nextTableIndex--]) != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">)  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    <span style="color:rgb(127, 0, 85);font-weight:bold;">while</span><span style="color:black;"> (nextSegmentIndex &gt;= </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        Segment&lt;K,V&gt; seg = segments[nextSegmentIndex--];  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> (seg.count != </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            currentTable = seg.table;  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            <span style="color:rgb(127, 0, 85);font-weight:bold;">for</span><span style="color:black;"> (</span><span style="color:rgb(127, 0, 85);font-weight:bold;">int</span><span style="color:black;"> j = currentTable.length - </span><span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">; j &gt;= </span><span style="color:rgb(192, 0, 0);">0</span><span style="color:black;">; --j) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                <span style="color:rgb(127, 0, 85);font-weight:bold;">if</span><span style="color:black;"> ( (nextEntry = currentTable[j]) != </span><span style="color:rgb(127, 0, 85);font-weight:bold;">null</span><span style="color:black;">) {  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    nextTableIndex = j - <span style="color:rgb(192, 0, 0);">1</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                    <span style="color:rgb(127, 0, 85);font-weight:bold;">return</span><span style="color:black;">;  </span></span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">                }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">            }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">        }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">    }  </span></li><li style="font-size:1em;padding:0px;margin:0px 0px 0px 38px;border-left-width:1px;border-left-style:solid;border-left-color:rgb(209, 215, 220);padding-left:10px;line-height:18px;background-color:rgb(250, 250, 250);"><span style="color:black;">}  </span></li></ol></div>
<p style="margin:0px;padding:0px;">不想再多介绍了，唯一需要注意的是跳到下一个段时，一定要先读取下一个段的count变量。 </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">这种迭代方式的主要效果是不会抛出ConcurrentModificationException。一旦获取到下一个段的table，也就意味着这个段的头结点在迭代过程中就确定了，在迭代过程中就不能反映对这个段节点并发的删除和添加，对于节点的更新是能够反映的，因为节点的值是一个volatile变量。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"><br/><span style="font-size:small;"><strong style="font-weight:bold;">结束语</strong>
</span>
</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">ConcurrentHashMap是一个支持高并发的高性能的HashMap实现，它支持完全并发的读以及一定程度并发的写。ConcurrentHashMap的实现也是很精巧，充分利用了最新的JMM规范，值得学习，却不值得模仿。最后由于本人水平有限，对大师的作品难免有误解，如果存在，还望大牛们不吝指出。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">参考文章：</p>
<p style="margin:0px;padding:0px;">http://www.ibm.com/developerworks/java/library/j-jtp08223/，这个是讨论的是Doug Lea's util.concurrent包中的ConcurrentHashMap的实现，不过大致思想是一致的。</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">http://floatingpoint.tinou.com/2008/09/performance-optimization-in-concurrenthashmap.html</p>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;"> </p>
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

          <div style="padding:10px 0px;color:gray;border-bottom-width:1px;border-bottom-style:inset;border-bottom-color:gray;">声明：ITeye文章版权属于作者，受法律保护。没有作者书面许可不得转载。 </div>
      <div style="color:gray;margin-top:5px;padding-top:5px;"><span>推荐链接</span><ul style="margin:0px 0px 1.5em;padding:0px;"></ul></div>
              <div style="padding:0px 0px 5px 5px;"></div>
        </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://marlonyao.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://marlonyao.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
              </div>
                    </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">for_cyan</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://cyan.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [16].png" type="image/png" data-filename="Image.png" alt="for_cyan的博客" height="120" style="border:0px;width:120px;" title="for_cyan的博客: Cyan的自由天空"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [1].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 16</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 30</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 厦门</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [1].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      我想知道在什么样情况下用到什么类型的hashmap，而concurrenthashmap会用的频繁吗？谢谢
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://cyan.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://cyan.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=for_cyan" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://cyan.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=for_cyan" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#916842" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="for_cyan回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">aws</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://aws.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo [1].gif" type="image/gif" data-filename="user-logo.gif" alt="aws的博客" height="120" style="border:0px;width:120px;" title="aws的博客: aws"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [2].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 698</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 10</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 上海</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [2].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      需要同步的情况，个人一般是直接用hashtable
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://aws.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://aws.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=aws" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://aws.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=aws" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#916876" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="aws回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">云中苍月</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://sky-810-126-com.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo [2].gif" type="image/gif" data-filename="user-logo.gif" alt="云中苍月的博客" height="120" style="border:0px;width:120px;" title="云中苍月的博客:"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [3].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 157</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 0</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 南京</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [3].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      concurrenthashmap是一个非常好的map实现，在高并发操作的场景下会有非常好的效率。实现的目的主要是为了避免同步操作时对整个map对象进行锁定从而提高并发访问能力。楼主对这个实现已经讲得很详细了。
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://sky-810-126-com.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://sky-810-126-com.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=%E4%BA%91%E4%B8%AD%E8%8B%8D%E6%9C%88" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://sky-810-126-com.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=%E4%BA%91%E4%B8%AD%E8%8B%8D%E6%9C%88" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#916947" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="云中苍月回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">dlovek</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [17].png" type="image/png" data-filename="Image.png" alt="dlovek的博客" height="120" style="border:0px;width:120px;" title="dlovek的博客: dlovek"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [4].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 52</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 34</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: TJ</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [4].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      <div style="font-weight:bold;padding:5px;margin:5px 0px 0px 15px;">marlonyao 写道</div>
<div style="border:1px solid rgb(204, 204, 204);margin:0px 5px 5px 15px;padding:3px;background:rgb(250, 250, 250);">
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">其实这种方式是存在问题的，在第一个内层for循环中，在这两条语句sum += segments[i].count; mcsum += mc[i] = segments[i].modCount;之间，其它线程可能正在对Segment进行结构性的修改，导致segments[i].count和segments[i].modCount读取的数据并不一致。这可能使size()方法返回任何时候都不曾存在的大小，很奇怪javadoc居然没有明确标出这一点，可能是因为这个时间窗口太小了吧。size()的实现还有一点需要注意，<span style="color:#ff0000;">必须要先segments[i].count，才能segments[i].modCount，这是因为segment[i].count是对volatile变量的访问，接下来segments[i].modCount才能得到几乎最新的值</span>（前面我已经说了为什么只是“几乎”了）。</p>
</div>
<p style="margin:0px;padding:0px;">楼主写的非常好，又使我明白的不少东西。这个地方还是不理解，为什么需要首先调用一次volatile变量才使的modCount几乎可以得到最新的值?</p>
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://dlovek.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://dlovek.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917017" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="dlovek回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">marlonyao</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/star2 [1].gif" type="image/gif" data-filename="star2.gif" alt="二星会员" height="14" style="border:0px;" title="二星会员" width="28"/></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo [3].gif" type="image/gif" data-filename="user-logo.gif" alt="marlonyao的博客" height="120" style="border:0px;width:120px;" title="marlonyao的博客: marlonyao"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [5].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 37</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 200</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 北京</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [5].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        最后修改：2009-03-09
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      <div style="font-weight:bold;padding:5px;margin:5px 0px 0px 15px;">dlovek 写道</div><div style="border:1px solid rgb(204, 204, 204);margin:0px 5px 5px 15px;padding:3px;background:rgb(250, 250, 250);">
<br/>marlonyao 写道
<br/>
<br/>&amp;nbsp;
<br/>其实这种方式是存在问题的，在第一个内层for循环中，在这两条语句sum += segments[i].count; mcsum += mc[i] = segments[i].modCount;之间，其它线程可能正在对Segment进行结构性的修改，导致segments[i].count和segments[i].modCount读取的数据并不一致。这可能使size()方法返回任何时候都不曾存在的大小，很奇怪javadoc居然没有明确标出这一点，可能是因为这个时间窗口太小了吧。size()的实现还有一点需要注意，必须要先segments[i].count，才能segments[i].modCount，这是因为segment[i].count是对volatile变量的访问，接下来segments[i].modCount才能得到几乎最新的值（前面我已经说了为什么只是“几乎”了）。
<br/>
<br/>楼主写的非常好，又使我明白的不少东西。这个地方还是不理解，为什么需要首先调用一次volatile变量才使的modCount几乎可以得到最新的值?
<br/></div>
<br/>
<br/>写volatile变量和它之前的读写操作是不能reorder的，读volatile变量和它之后的读写操作也是不能reorder的。
<br/>修改modCount发生在修改count之前，由于count是volatile变量，修改modCount不能和写count的操作reorder，读取count和它之后的操作，比如读取modCount，不能reorder。有了这两个不能reorder才能保证读取了count之后，能读到线程在写count之前的写入的modCount值，这个modCount值是几乎最新的。
<br/>如果在读modCount之前不读count，读modCount甚至可能会reorder到写modCount之前。
<br/>
<br/>用reorder解释总是太复杂了，不如用happens-before来得简洁。当一个线程I对count的读时，它读到的值必定是另一个线程，假设是线程II，最近对count的写。这个两个操作存在happens-before关系，即线程II对count的写happens-before线程I对count的读，记作：II：W(count) &lt; I：R(count)。单线程的happens-before规则，又有II：W(modCount) &lt; II：(count)（查看源代码会发现在写count之前必定有写modCount），以及 I：R(count) &lt; I：R(modCount)，根据传递规则有，II：(modCount) &lt; I：(modCount)，这就是说线程I至少能够读取到线程II写count之前的modCount值。我曾经写了一篇关于happens-before的文章，有些表达可能有误，但大致还是对的，http://www.iteye.com/topic/260515。
<br/>
<br/>
<br/>不理解的话，也只能告诉你结论了，如果没有对count的写的话（对volatile的写是一种同步操作），读modCount可能读到很久很久很久以前的值（初始值0都有可能）。
<br/>
<br/>期待高人做更简洁的解释吧。
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://marlonyao.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://marlonyao.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917170" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="marlonyao回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">dlovek</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [18].png" type="image/png" data-filename="Image.png" alt="dlovek的博客" height="120" style="border:0px;width:120px;" title="dlovek的博客: dlovek"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [6].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 52</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 34</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: TJ</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [6].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      恩，我有看到在Segment的删除/添加方法都是先修改了modCount然后修改了volatile的count值。<br/>在containsValue方法中，“内层的第一个for循环，里面有语句int c = segments[i].count; 但是c却从来没有被使用过，即使如此，编译器也不能做优化将这条语句去掉，因为存在对volatile变量count的读取，这条语句存在的唯一目的就是保证segments[i].modCount读取到几乎最新的值”，这个就不理解了。
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://dlovek.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://dlovek.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917223" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="dlovek回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">marlonyao</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/star2 [2].gif" type="image/gif" data-filename="star2.gif" alt="二星会员" height="14" style="border:0px;" title="二星会员" width="28"/></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo [4].gif" type="image/gif" data-filename="user-logo.gif" alt="marlonyao的博客" height="120" style="border:0px;width:120px;" title="marlonyao的博客: marlonyao"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [7].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 37</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 200</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 北京</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [7].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      <div style="font-weight:bold;padding:5px;margin:5px 0px 0px 15px;">dlovek 写道</div><div style="border:1px solid rgb(204, 204, 204);margin:0px 5px 5px 15px;padding:3px;background:rgb(250, 250, 250);">恩，我有看到在Segment的删除/添加方法都是先修改了modCount然后修改了volatile的count值。
<br/>在containsValue方法中，“内层的第一个for循环，里面有语句int c = segments[i].count; 但是c却从来没有被使用过，即使如此，编译器也不能做优化将这条语句去掉，因为存在对volatile变量count的读取，这条语句存在的唯一目的就是保证segments[i].modCount读取到几乎最新的值”，这个就不理解了。</div>
<br/>
<br/>见我前面的回复，如果不先读count，就有可能读到modCount很久以前的陈旧值。
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://marlonyao.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://marlonyao.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://marlonyao.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=marlonyao" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917339" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="marlonyao回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">unsid</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/star1.gif" type="image/gif" data-filename="star1.gif" alt="一星会员" height="14" style="border:0px;" title="一星会员" width="14"/></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://unsid.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/user-logo [5].gif" type="image/gif" data-filename="user-logo.gif" alt="unsid的博客" height="120" style="border:0px;width:120px;" title="unsid的博客:"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [8].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 232</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 100</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: 北京</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [8].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      final Segment&lt;K,V&gt;[] segments; 
<br/>
<br/>final Segment&lt;K,V&gt; segmentFor(int hash) {   
<br/>    return segments[(hash &gt;&gt;&gt; segmentShift) &amp; segmentMask];   
<br/>}  
<br/>
<br/>public V remove(Object key) {   
<br/>    hash = hash(key.hashCode());   
<br/>    return segmentFor(hash).remove(key, hash, null);   
<br/>}
<br/>
<br/>我对此处的segments不理解,这里的segments数组是干吗的?我起初还以为相当于HashMap中的Entity[],仔细一看,每个segment里面都有一个HashEntry[],这个应当是真正哈西表按照楼主说的,每个用户操作在不同的segment上不同segment有不同的锁,那让segment[]充当Entity[],而每个segment里仅有一个HashEntry链表,这样只有两个用户删除哈西值相同的元素时才需要同步.
<br/>
<br/>为虾米先要segmentFor(hash)而后在remove方法里又哈西算一次坐标?        
<br/>  int index = hash &amp; (tab.length - 1);   
<br/>  HashEntry&lt;K,V&gt; first = tab[index];  
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://unsid.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://unsid.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=unsid" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://unsid.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=unsid" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917446" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="unsid回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>
<tr>
  <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;">
    <ul style="margin:0px 0px 1.5em;padding:0px;">
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;width:120px;font-weight:bold;overflow:hidden;font-size:1.1em;font-family:Helvetica, Tahoma, Arial, sans-serif;">dlovek</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">等级: 初级会员</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);text-decoration:none;" target="_blank"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/Image [19].png" type="image/png" data-filename="Image.png" alt="dlovek的博客" height="120" style="border:0px;width:120px;" title="dlovek的博客: dlovek"/></a></li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">性别: <img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/icon_minigender_1 [9].gif" type="image/gif" data-filename="icon_minigender_1.gif" height="11" style="border:0px;" title="男" width="11"/></li>      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">文章: 52</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">积分: 34</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;">来自: TJ</li>
      <li style="margin:0px 0px 0.25em 30px;padding:0px;list-style:none;margin-left:0px;"><img src="ConcurrentHashMap之实现细节 - Java - ITeye论坛_files/offline [9].gif" type="image/gif" data-filename="offline.gif" height="26" style="border:0px;" width="89"/></li>
    </ul>
  </td>
  <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
    <div style="border-bottom-style:solid;border-bottom-width:1px;border-color:gray;padding:3px 20px 25px 10px;">
      <div style="color:rgb(0, 102, 153);float:left;width:430px;height:18px;overflow:hidden;">
          
        发表时间：2009-03-09  
        
      </div>
      <div style="width:300px;text-align:right;float:right;">
        
        
          
          
          
        
      </div>
    </div>
    <div style="display:block;padding:20px 0px 1px;font-family:Helvetica, Tahoma, Arial, sans-serif;min-height:120px;width:790px;font-size:14px;line-height:1.8em;">
      
      
      <div style="font-weight:bold;padding:5px;margin:5px 0px 0px 15px;">marlonyao 写道</div>
<div style="border:1px solid rgb(204, 204, 204);margin:0px 5px 5px 15px;padding:3px;background:rgb(250, 250, 250);">
<div style="font-weight:bold;padding:5px;margin:5px 0px 0px 15px;">dlovek 写道</div>
<div style="border:1px solid rgb(204, 204, 204);margin:0px 5px 5px 15px;padding:3px;background:rgb(250, 250, 250);">恩，我有看到在Segment的删除/添加方法都是先修改了modCount然后修改了volatile的count值。<br/>在containsValue方法中，“内层的第一个for循环，里面有语句int c = segments[i].count; 但是c却从来没有被使用过，即使如此，编译器也不能做优化将这条语句去掉，因为存在对volatile变量count的读取，这条语句存在的唯一目的就是保证segments[i].modCount读取到几乎最新的值”，这个就不理解了。</div>
<br/><br/>见我前面的回复，如果不先读count，就有可能读到modCount很久以前的陈旧值。</div>
<p style="margin:0px;padding:0px;"> </p>
<p style="margin:0px;padding:0px;">恩，已经明白了，谢谢。关键点还是因为删除/添加方法是首先对modCount更新然后才更新volatile的count值。</p>
    <span style="font-family:Helvetica, Tahoma, Arial, sans-serif;font-size:14px;line-height:1.8em;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    

            </td>
  </tr>
  <tr>
    <td style="font-size:1em;width:125px;vertical-align:top;background-color:rgb(222, 227, 231);padding:5px;"><a href="http://www.iteye.com/topic/344876#" style="color:rgb(0, 102, 153);text-decoration:none;">返回顶楼</a></td>
    <td style="font-size:1em;vertical-align:top;width:798px;background-color:rgb(239, 239, 239);padding:5px;">
      <div style="float:left;">
        <a href="http://dlovek.iteye.com/" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_www.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者的博客"> </a>
        <a href="http://dlovek.iteye.com/blog/profile" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_profile.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="浏览作者资料"> </a>
        <a href="http://my.iteye.com/messages/new?message%5Breceiver_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_pm.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="发送站内短信"> </a>
        <a href="http://dlovek.iteye.com/blog/guest_book" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_guestbook.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="给作者留言"> </a>
        <a href="http://my.iteye.com/feed?subscription%5Bsubscribed_user_name%5D=dlovek" style="color:rgb(0, 102, 153);background-image:url(http://www.iteye.com/images/icon_feed.gif);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="关注作者"> </a>
                  <a href="http://www.iteye.com/topic/344876#917477" style="color:rgb(0, 102, 153);text-decoration:none;float:left;display:block;width:70px;height:20px;background-repeat:no-repeat;" title="dlovek回帖:ConcurrentHashMap之实现细节">回帖地址</a>
              </div>
                        <div style="width:225px;float:right;"><a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_good.gif);" title="好">0</a> <a href="http://www.iteye.com/topic/344876#" style="color:black;text-decoration:none;line-height:1.4em;margin-left:10px;padding:3px 0px 3px 25px;background-repeat:no-repeat;background-image:url(http://www.iteye.com/images/icon_bad.gif);" title="差">0</a> 请登录后投票</div>              </td>
</tr>
<tr style="height:8px;background-color:rgb(209, 215, 220);"><td colspan="2" style="font-size:1em;padding:5px;"></td></tr>

  </tbody>
</table>


<div style="height:30px;margin:10px 0px 5px;">
  <div style="float:left;"></div>
  <div style="width:750px;float:right;"><div style="padding:5px;float:right;"><span style="padding:2px 5px;margin:2px;border:1px solid rgb(238, 238, 238);color:rgb(221, 221, 221);">« 上一页</span> <span style="padding:2px 5px;margin:2px;border:1px solid rgb(0, 102, 153);font-weight:bold;color:rgb(255, 255, 255);background-color:rgb(0, 102, 153);">1</span> <a href="http://www.iteye.com/topic/344876?page=2" rel="next" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">2</a> <a href="http://www.iteye.com/topic/344876?page=3" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">3</a> <a href="http://www.iteye.com/topic/344876?page=2" rel="next" style="color:rgb(0, 102, 153);text-decoration:none;padding:2px 5px;margin:2px;border:1px solid rgb(170, 170, 221);">下一页 »</a></div></div>
</div>

<div>
  <div style="float:left;font-size:1.1em;color:rgb(0, 102, 153);">
    <a href="http://www.iteye.com/forums" style="color:rgb(0, 102, 153);text-decoration:underline;margin-left:5px;">论坛首页</a> <span style="font-weight:normal;font-size:0.9em;color:rgb(153, 153, 153);margin-left:5px;">→</span>
    <a href="http://www.iteye.com/forums/board/Java" style="color:rgb(0, 102, 153);text-decoration:underline;margin-left:5px;">Java企业应用版</a>
    <br/><br/>跳转论坛:
    
  </div>

  
</div>







        </div></div></div></div></div></div><br/></span>
</div></body></html> 