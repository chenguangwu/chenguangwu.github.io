<html>
<head>
  <title>几种TCP连接中出现RST的情况 - costaxu的个人页面</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8554"/>
<h1>几种TCP连接中出现RST的情况 - costaxu的个人页面</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/3/19 9:38</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://my.oschina.net/costaxu/blog/127394"><i>https://my.oschina.net/costaxu/blog/127394</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="-webkit-tap-highlight-color:transparent;font-family:&quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif;box-sizing:border-box;color:rgb(51, 51, 51);text-size-adjust:100%;font-size:62.5%;"><div style="-webkit-tap-highlight-color:transparent;font-family:&quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif;box-sizing:border-box;color:rgb(51, 51, 51);text-size-adjust:100%;font-size:1.2rem;background:#f8f8f8;"><div style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><div style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased;background:rgb(248, 248, 248);font-size:16px;text-align:center;"><div style="-webkit-tap-highlight-color:transparent;box-sizing:border-box;background:rgb(255, 255, 255);"><div style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;text-align:left;"><div style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;word-wrap:break-word;font-size:1.6rem;font-family:&quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif;color:rgb(61, 70, 77);line-height:28px;"><div style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="display:table;box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
                    <p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 应该没有人会质疑，现在是一个网络时代了。应该不少程序员在编程中需要考虑多机、局域网、广域网的各种问题。所以网络知识也是避免不了学习的。而且笔者一直觉得TCP/IP网络知识在一个程序员知识体系中必需占有一席之地的。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 在TCP协议中RST表示复位，用来异常的关闭连接，在TCP的设计中它是不可或缺的。发送RST包关闭连接时，不必等缓冲区的包都发出去，直接就丢弃缓存区的包发送RST包。而接收端收到RST包后，也不必发送ACK包来确认。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 其实在网络编程过程中，各种RST错误其实是比较难排查和找到原因的。下面我列出几种会出现RST的情况。 </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 1 端口未打开<br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 服务器程序端口未打开而客户端来连接。这种情况是最为常见和好理解的一种了。去telnet一个未打开的TCP的端口可能会出现这种错误。这个和操作系统的实现有关。在某些情况下，操作系统也会完全不理会这些发到未打开端口请求。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 比如在下面这种情况下，主机241向主机114发送一个SYN请求，表示想要连接主机114的40000端口，但是主机114上根本没有打开40000这个端口，于是就向主机241发送了一个RST。这种情况很常见。特别是服务器程序core dump之后重启之前连续出现RST的情况会经常发生。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <img src="几种TCP连接中出现RST的情况 - costaxu的个人页面_files/102501_iHAp_247956.jpg" type="image/jpeg" data-filename="102501_iHAp_247956.jpg" alt="" height="31" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;border:none;margin:auto;max-width:80%;height:auto;" width="640"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 当然在某些操作系统的主机上，未必是这样的表现。比如向一台WINDOWS7的主机发送一个连接不存在的端口的请求，这台主机就不会回应。 </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 2 请求超时 </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 曾经遇到过这样一个情况:一个客户端连接服务器，connect返回-1并且error=EINPROGRESS。 直接telnet发现网络连接没有问题。ping没有出现丢包。用抓包工具查看，客户端是在收到服务器发出的SYN之后就莫名其妙的发送了RST。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 比如像下面这样： </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <img src="几种TCP连接中出现RST的情况 - costaxu的个人页面_files/103527_RRmR_247956.jpg" type="image/jpeg" data-filename="103527_RRmR_247956.jpg" alt="" height="95" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;border:none;margin:auto;max-width:80%;height:auto;" width="640"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 有89、27两台主机。主机89向主机27发送了一个SYN，表示希望连接8888端口，主机27回应了主机89一个SYN表示可以连接。但是主机27却很不友好，莫名其妙的发送了一个RST表示我不想连接你了。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 后来经过排查发现，在主机89上的程序在建立了socket之后，用setsockopt的<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">SO_RCVTIMEO</span>选项设置了recv的超时时间为100ms。而我们看上面的抓包结果表示，从主机89发出SYN到接收SYN的时间多达110ms。（从15:01:27.799961到15:01:27.961886， 小数点之后的单位是微秒）。因此主机89上的程序认为接收超时，所以发送了RST拒绝进一步发送数据。 </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 3 提前关闭 </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 关于TCP，我想我们在教科书里都读到过一句话，'TCP是一种可靠的连接'。 而这可靠有这样一种含义，那就是操作系统接收到的来自TCP连接中的每一个字节，我都会让应用程序接收到。如果应用程序不接收怎么办？你猜对了，RST。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 看两段程序： </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<pre style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><code style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:4px;padding:10px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(127, 159, 127);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(127, 159, 127);">//server.c</span></span>

<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> main(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> argc, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span>** argv)  
{  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> listen_fd, real_fd;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr_in</span></span></span></span> listen_addr, client_addr;  
    socklen_t len = <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr_in</span></span></span></span>);  
    listen_fd = socket(AF_INET, SOCK_STREAM, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(listen_fd == -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;socket failed   &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>;  
    }  
    bzero(&amp;listen_addr,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(listen_addr));  
    listen_addr.sin_family = AF_INET;  
    listen_addr.sin_addr.s_addr = htonl(INADDR_ANY);  
    listen_addr.sin_port = htons(SERV_PORT);  
    bind(listen_fd,(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr</span></span></span></span> *)&amp;listen_addr, len);  
    listen(listen_fd, WAIT_COUNT);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">while</span></span>(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
    {  
        real_fd = accept(listen_fd, (<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr</span></span></span></span>*)&amp;client_addr, &amp;len);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(real_fd == -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
        {  
            perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;accpet fail  &quot;</span></span>);  
            <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>;  
        }  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(fork() == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>)  
        {  
            close(listen_fd);  
            <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span> pcContent[<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>];
            read(real_fd,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>);
            close(real_fd);  
            exit(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);              
        }  
        close(real_fd);  
    }     
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>;  
}</code></pre> 这一段是server的最简单的代码。逻辑很简单，监听一个TCP端口然后当有客户端来连接的时候fork一个子进程来处理。注意看的是这一段fork里面的处理： 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<pre style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><code style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:4px;padding:10px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;">char pcContent[<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>];
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">read</span></span>(real_fd,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>);
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">close</span></span>(real_fd);</code></pre> 每次只是读socket的前4096个字节，然后就关闭掉连接。 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 然后再看一下client的代码： </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<pre style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><code style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:4px;padding:10px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(127, 159, 127);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(127, 159, 127);">//client.c</span></span>
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">main</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">(</span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> argc, </span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">** argv)</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">  
</span></span>{  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> send_sk;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span> sockaddr_in s_addr;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">socklen_t</span></span> len = <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(s_addr);  
    send_sk = socket(AF_INET, SOCK_STREAM, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(send_sk == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;socket failed  &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>;  
    }  
    bzero(&amp;s_addr, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(s_addr));  
    s_addr.sin_family = AF_INET;  

    inet_pton(AF_INET,SER_IP,&amp;s_addr.sin_addr);  
    s_addr.sin_port = htons(SER_PORT);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(connect(send_sk,(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span> sockaddr*)&amp;s_addr,len) == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;connect fail  &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>;  
    }  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span> pcContent[<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">5000</span></span>]={<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>};
    write(send_sk,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">5000</span></span>);
    sleep(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>);
    close(send_sk);
}</code></pre> 这段代码更简单，就是打开一个socket然后连接一个服务器并发送5000个字节。刚才我们看服务器的代码，每次只接收4096个字节，那么就是说客户端发送的剩下的4个字节服务端的应用程序没有接收到，服务器端的socket就被关闭掉，这种情况下会发生什么状况呢，还是抓包看一看。 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <img src="几种TCP连接中出现RST的情况 - costaxu的个人页面_files/112511_6jx3_247956.jpg" type="image/jpeg" data-filename="112511_6jx3_247956.jpg" alt="" height="300" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;border:none;margin:auto;max-width:80%;height:auto;" width="634"/> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 前三行就是TCP的3次握手，从第四行开始看，客户端的49660端口向服务器的9877端口发送了5000个字节的数据，然后服务器端发送了一个ACK进行了确认，紧接着服务器向客户端发送了一个RST断开了连接。和我们的预期一致。 </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 4 在一个已关闭的socket上收到数据 </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 如果某个socket已经关闭，但依然收到数据也会产生RST。 </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 代码如下： </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 客户端： </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> </p> 
<pre style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><code style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:4px;padding:10px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">main</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">(</span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> argc, </span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">** argv)</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;">  
</span></span>{  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> send_sk;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span> sockaddr_in s_addr;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">socklen_t</span></span> len = <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(s_addr);  
    send_sk = socket(AF_INET, SOCK_STREAM, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(send_sk == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;socket failed  &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>;  
    }  
    bzero(&amp;s_addr, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(s_addr));  
    s_addr.sin_family = AF_INET;  

    inet_pton(AF_INET,SER_IP,&amp;s_addr.sin_addr);  
    s_addr.sin_port = htons(SER_PORT);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(connect(send_sk,(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span> sockaddr*)&amp;s_addr,len) == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;connect fail  &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">-1</span></span>;  
    }  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span> pcContent[<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>]={<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>};
    write(send_sk,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>);
    sleep(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>);
    write(send_sk,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>);
    close(send_sk);
} </code></pre> 服务端： 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"></p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> </p> 
<pre style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:3px;padding:2px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><code style="word-wrap:normal;box-sizing:inherit;-webkit-tap-highlight-color:transparent;border-radius:4px;padding:10px;line-height:1.4;overflow-x:auto;display:block;font-size:13px;background:rgb(63, 63, 63);color:rgb(220, 220, 220);font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> main(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> argc, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span>** argv)  
{  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">int</span></span> listen_fd, real_fd;  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr_in</span></span></span></span> listen_addr, client_addr;  
    socklen_t len = <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr_in</span></span></span></span>);  
    listen_fd = socket(AF_INET, SOCK_STREAM, <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(listen_fd == -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
    {  
        perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;socket failed   &quot;</span></span>);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>;  
    }  
    bzero(&amp;listen_addr,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">sizeof</span></span>(listen_addr));  
    listen_addr.sin_family = AF_INET;  
    listen_addr.sin_addr.s_addr = htonl(INADDR_ANY);  
    listen_addr.sin_port = htons(SERV_PORT);  
    bind(listen_fd,(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr</span></span></span></span> *)&amp;listen_addr, len);  
    listen(listen_fd, WAIT_COUNT);  
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">while</span></span>(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
    {  
        real_fd = accept(listen_fd, (<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">struct</span></span></span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"> </span><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(239, 239, 143);">sockaddr</span></span></span></span>*)&amp;client_addr, &amp;len);  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(real_fd == -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>)  
        {  
            perror(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(204, 147, 147);">&quot;accpet fail  &quot;</span></span>);  
            <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> -<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">1</span></span>;  
        }  
        <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">if</span></span>(fork() == <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>)  
        {  
            close(listen_fd);  
            <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">char</span></span> pcContent[<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>];
            read(real_fd,pcContent,<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">4096</span></span>);
            close(real_fd);  
            exit(<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>);              
        }  
        close(real_fd);  
    }     
    <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(227, 206, 171);">return</span></span> <span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);"><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;color:rgb(140, 208, 211);">0</span></span>;  
} </code></pre> 客户端在服务端已经关闭掉socket之后，仍然在发送数据。这时服务端会产生RST。 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"></p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> <img src="几种TCP连接中出现RST的情况 - costaxu的个人页面_files/154737_5Uz3_247956.jpg" type="image/jpeg" data-filename="154737_5Uz3_247956.jpg" alt="" height="379" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;border:none;margin:auto;max-width:80%;height:auto;" width="640"/> </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 总结<br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/> </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 总结，本文讲了几种TCP连接中出现RST的情况。实际上肯定还有无数种的RST发生，我以后会慢慢收集把更多的例子加入这篇文章。 </p> 
<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span>
<h2 style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-size:22px;font-weight:500;margin:1.5em 0px;"> 参考文献： </h2> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 1 从TCP协议的原理来谈谈RST攻击 <a href="http://russelltao.iteye.com/blog/1405349" rel="nofollow" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-family:&quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif;border:none;outline:0px;transition:color 0.3s;text-decoration:none;color:rgb(68, 102, 187);" target="_blank">http://russelltao.iteye.com/blog/1405349</a><span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span> </p> 
<p style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;margin-bottom:16px;"> 2 TCP客户-服务器程序例子<span style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"></span><a href="http://blog.csdn.net/youkuxiaobin/article/details/6917880" rel="nofollow" style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;font-family:&quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif;border:none;outline:0px;transition:color 0.3s;text-decoration:none;color:rgb(68, 102, 187);" target="_blank">http://blog.csdn.net/youkuxiaobin/article/details/6917880</a><br style="box-sizing:inherit;-webkit-tap-highlight-color:transparent;"/>   </p>
                <span style="display:table;box-sizing:inherit;-webkit-tap-highlight-color:transparent;clear:both;"></span></div></div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 