<html>
<head>
  <title>jvm系列(六):Java服务GC参数调优案例</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="11404"/>
<h1>jvm系列(六):Java服务GC参数调优案例</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/4/20 10:38</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&mid=2247484007&idx=1&sn=e8d150bb760d0a92aad594152fc47a9d&chksm=ebf6da18dc81530eedeaff89d746cf48e7b2bdec602239faaeb4e8e490e0a4387e2a8890c327&scene=21#wechat_redirect"><i>http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&amp;mid=2247484007&amp;idx=1&amp;sn=e8d150bb760d0a92aad594152fc47a9d&amp;chksm=ebf6da18dc81530eedeaff89d746cf48e7b2bdec602239faaeb4e8e490e0a4387e2a8890c327&amp;scene=21#wechat_redirect</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%; position: relative;"><div style="text-size-adjust:100%;line-height:1.6;"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;line-height:inherit;background-color:rgb(255, 255, 255);"><div><div style="background-color:rgb(255, 255, 255);font-size:16px;word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div>
                
                <h2 style="margin:0px;padding:0px;font-weight:400;font-size:24px;margin-bottom:14px;line-height:1.4;padding-bottom:10px;border-bottom:1px solid rgb(231, 231, 235);">
                    jvm系列(六):Java服务GC参数调优案例                                    </h2>
                <div style="margin:0px;padding:0px;margin-bottom:18px;line-height:20px;font-size:0px;position:relative;z-index:1;">
                                                            <em style="margin:0px;padding:0px;display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;color:rgb(140, 140, 140);max-width:none;font-style:normal;">2017-09-21</em>

                                        <em style="margin:0px;padding:0px;display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;color:rgb(140, 140, 140);max-width:none;font-style:normal;">channingbj</em>
                                        <a href="http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&amp;mid=2247484007&amp;idx=1&amp;sn=e8d150bb760d0a92aad594152fc47a9d&amp;chksm=ebf6da18dc81530eedeaff89d746cf48e7b2bdec602239faaeb4e8e490e0a4387e2a8890c327&amp;scene=21##" style="margin:0px;padding:0px;color:rgb(96, 127, 166);text-decoration:none;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;max-width:none;display:inline-block;">纯洁的微笑</a>
                    


                    
                </div>
                                
                
                
                
                                                
                                                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(62, 62, 62);min-height:350px;position:relative;">
                    

                    

                    
                    
                    <p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">本文介绍了一次生产环境的JVM GC相关参数的调优过程，通过参数的调整避免了GC卡顿对JAVA服务成功率的影响。</p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">这段时间在整理jvm系列的文章，无意中发现本文，作者思路清晰通过步步分析最终解决问题。我个人特别喜欢这种实战类的内容，经原作者的授权同意，将文章分享于此。<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(80, 97, 109);font-family:Helvetica, Arial, sans-serif;font-size:15px;background-color:rgb(255, 255, 255);">备注部分为本人添加，主要起到说明的作用。</span></p><blockquote style="padding:0px;margin:0px;padding-left:10px;border-left:3px solid rgb(219, 219, 219);max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">原文出处：https://segmentfault.com/a/1190000005174819</p></blockquote><h2 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:22px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">背景以及遇到的问题</h2><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">我们的Java HTTP服务属于OLTP类型，对成功率和响应时间的要求比较高，在生产环境中出现偶现的成功率突然下降然后又自动恢复的情况，如图所示：</p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640" type="image/webp" data-filename="640" height="233" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="640"/></p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">JVM和GC相关的参数如下：</p><pre style="margin-bottom:0px;margin:0px;font-size:10px;box-sizing:border-box;color:rgb(80, 97, 109);margin-top:0px;padding:8px 0px 6px;background-color:rgb(241, 239, 238);border-radius:0px;overflow-y:auto;word-wrap:break-word;max-width:100%;line-height:12px;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:none;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">Xmx22528m</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">Xms22528m</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">NewRatio</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">=</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(223, 83, 32);line-height:20px;font-size:13px !important;white-space:inherit !important;">2</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">UseConcMarkSweepGC</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">UseParNewGC</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">CMSParallelRemarkEnabled</span></code></span></span></p></li></ol></pre><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">总结来说，由于服务中大量使用了Cache，所以堆大小开到了22G。GC算法使用CMS（UseConcMarkSweepGC），开启了降低标记停顿（CMSParallelRemarkEnabled），设置年轻代为并行收集（UseParNewGC），年轻代和老年代的比例为1:2 （NewRatio＝2）.</p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">JVM GC日志相关的参数如下：</p><pre style="margin-bottom:0px;margin:0px;font-size:10px;box-sizing:border-box;color:rgb(80, 97, 109);margin-top:0px;padding:8px 0px 6px;background-color:rgb(241, 239, 238);border-radius:0px;overflow-y:auto;word-wrap:break-word;max-width:100%;line-height:12px;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:none;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">Xloggc</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(123, 151, 38);line-height:20px;font-size:13px !important;white-space:inherit !important;">/data/</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">gc</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">.</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">log</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">GCLogFileSize</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">=</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(223, 83, 32);line-height:20px;font-size:13px !important;white-space:inherit !important;">10M</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">NumberOfGCLogFiles</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">=</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(223, 83, 32);line-height:20px;font-size:13px !important;white-space:inherit !important;">10</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">UseGCLogFileRotation</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">PrintGCDateStamps</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">PrintGCTimeStamps</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">PrintGCDetails</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">DisableExplicitGC</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">verbose</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">gc</span></code></span></span></p></li></ol></pre><h2 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:22px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">问题解决过程</h2><h3 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:18px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">排除应用程序的内存使用问题</h3><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">首先使用jmap查看内存使用情况：</p><pre style="margin-bottom:0px;margin:0px;font-size:10px;box-sizing:border-box;color:rgb(80, 97, 109);margin-top:0px;padding:8px 0px 6px;background-color:rgb(241, 239, 238);border-radius:0px;overflow-y:auto;word-wrap:break-word;max-width:100%;line-height:12px;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:none;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">jmap </span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">histo</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">live PID</span></code></span></span></p></li></ol></pre><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">这个命令把程序中当前的对象按照个数和占用的空间排序以后打印出来。这里没有发现使用异常的对象。</p><h3 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:18px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">排除Cache内容过多的问题</h3><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">如果Cache内容过多也会导致JVM老年代容易被用满导致频繁GC，因此调出GC日志进行查看，发现每次GC以后内存使用一般是从20G降低到5G左右，因此常驻内存的Cache不是导致GC长时间卡顿的根本原因。对于GC LOG的查看有多种方式，使用VisualVM比较直观，需要使用VisualGC：</p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [1]" type="image/webp" data-filename="640" height="366" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="666"/></p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">从图中我们可以看到伊甸园和老年代的空间分配，由于整体内存是20G，设置 -XX:NewRatio=2 因此老年代是14G，伊甸园＋S0+S1=7G</p><h3 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:18px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">调整GC时间点（成功率抖动问题加重）</h3><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">如果GC需要处理的内存量比较大，执行的时间也就比较长，STW （Stop the World）时间也就更长。按照这个思路调整CMS启动的时间点，希望提早GC，也就是让GC变得更加频繁但是期望每次执行的时间较少。添加了下面这两个参数：</p><pre style="margin-bottom:0px;margin:0px;font-size:10px;box-sizing:border-box;color:rgb(80, 97, 109);margin-top:0px;padding:8px 0px 6px;background-color:rgb(241, 239, 238);border-radius:0px;overflow-y:auto;word-wrap:break-word;max-width:100%;line-height:12px;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:none;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">UseCMSInitiatingOccupancyOnly</span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">CMSInitiatingOccupancyFraction</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">=</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(223, 83, 32);line-height:20px;font-size:13px !important;white-space:inherit !important;">50</span></code></span></span></p></li></ol></pre><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">意思是说在Old区使用了50%的时候触发GC。实验后发现GC的频率有所增加，但是每次GC造成的陈功率降低现象并没有减弱，因此弃用这两个参数。</p><h3 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:18px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">调整对象在年轻代内存中驻留的时间（效果不明显）</h3><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">如果能够降低老年代GC的频率也可以达到降低GC影响的目的，因此尝试让对象在年轻代内存中进行更长时间的驻留，提升这些对象在年轻代GC时候被销毁的概率。使用参数 <code style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;background:rgb(243, 241, 241);color:rgb(88, 88, 88);font-size:16px;line-height:18px;"><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">-</span><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">XX</span><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">:</span><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">MaxTenuringThreshold</span><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">=</span><span style="background-repeat:initial;margin:0px;padding-left:2px;box-sizing:border-box;padding-right:2px;background-image:initial;background-position:initial;background-size:initial;padding:0px;background-attachment:initial;background-origin:initial;background-clip:initial;display:inline-block;word-wrap:break-word;max-width:100%;font-size:14px;">31</span></code>调整以后收效不明显。</p><blockquote style="margin-bottom:1.2em;margin:0px;font-family:Helvetica, Arial, sans-serif;box-sizing:border-box;background:rgb(242, 247, 251);padding-left:10px;border-left:3px solid rgb(219, 219, 219);margin-top:1em;padding:15px 15px 15px 1rem;color:rgb(129, 145, 152);border-left-width:6px;border-left-color:rgb(220, 230, 240);font-size:14px;line-height:18px;word-wrap:break-word;max-width:100%;white-space:normal;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;clear:both;min-height:1em;word-wrap:break-word;">备注：<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>1、MaxTenuringThreshold 在1.5.0<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">05之前最大值可以设置为31 ，1.5.0</span>06以后最大值可以设置为15，超过15会被认为无限大。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>2、提升年轻代GC被销毁的概率，只是调整这个参数效果不大，第二次age的值会重新计算。</p></blockquote><h3 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:18px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">CMS-Remark之前强制进行年轻代的GC</h3><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">首先补充一下CMS的相关知识，在CMS整个过程中有两个步骤是STW的，如图红色部分：</p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [2]" type="image/webp" data-filename="640" height="300" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="666"/></p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">CMS并非没有暂停，而是用两次短暂停来替代串行标记整理算法的长暂停，它的收集周期是这样：</p><ul style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:square;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);font-size:14px !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">1、初始标记(CMS-initial-mark),从root对象开始标记存活的对象</span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);font-size:14px !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">2、并发标记(CMS-concurrent-mark)</span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);font-size:14px !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">3、重新标记(CMS-remark),暂停所有应用程序线程，重新标记并发标记阶段遗漏的对象（在并发标记阶段结束后对象状态的更新导致）</span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);font-size:14px !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">4、并发清除(CMS-concurrent-sweep)</span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);font-size:14px !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">5、并发重设状态等待下次CMS的触发(CMS-concurrent-reset)。</span></span></p></li></ul><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">通过GC日志和成功率下降的时间点进行比对发现并不是每一次老年代GC都会导致成功率的下降，但是从中发现了一个规律：</p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [3]" type="image/webp" data-filename="640" height="77" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="536"/></p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">前两次GC CMS-Remark过程在4s左右造成了成功率的下降，但是第三次GC并没有对成功率造成明显的影响,CMS-Remark只有0.18s。Java HTTP 服务是通过Nginx进行反向代理的，nginx设置的超时时间是3s，所以如果GC卡顿在3s以内就不会对成功率造成太大的影响。</p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">从GC日志中又发现一个信息：</p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [4]" type="image/webp" data-filename="640" height="119" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="584"/></p><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">在文档和相关资料中没有找到蓝色部分的含义，猜测是remark处理的内存量，处理的越多就越慢。添加下面两个参数强制在remark阶段和FULL GC阶段之前先在进行一次年轻代的GC，这样需要进行处理的内存量就</p><pre style="margin-bottom:0px;margin:0px;font-size:10px;box-sizing:border-box;color:rgb(80, 97, 109);margin-top:0px;padding:8px 0px 6px;background-color:rgb(241, 239, 238);border-radius:0px;overflow-y:auto;word-wrap:break-word;max-width:100%;line-height:12px;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:none;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">ScavengeBeforeFullGC</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;"> </span></code></span></span></p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(74, 74, 74);display:block;font-size:14px !important;word-break:inherit !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;display:block;word-break:inherit !important;"><code style="overflow:initial;margin:0px;font-family:inherit !important;box-sizing:border-box;word-wrap:normal;margin-left:-20px;display:flex;padding:0px;line-height:12px;border-width:0px;border-style:initial;border-color:initial;font-size:10px;max-width:100%;white-space:pre !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">-</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">XX</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(27, 25, 24);line-height:20px;font-size:13px !important;white-space:inherit !important;">:+</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(64, 126, 231);line-height:20px;font-size:13px !important;white-space:inherit !important;">CMSScavengeBeforeRemark</span></code></span></span></p></li></ol></pre><blockquote style="margin-bottom:1.2em;margin:0px;font-family:Helvetica, Arial, sans-serif;box-sizing:border-box;background:rgb(242, 247, 251);padding-left:10px;border-left:3px solid rgb(219, 219, 219);margin-top:1em;padding:15px 15px 15px 1rem;color:rgb(129, 145, 152);border-left-width:6px;border-left-color:rgb(220, 230, 240);font-size:14px;line-height:18px;word-wrap:break-word;max-width:100%;white-space:normal;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;clear:both;min-height:1em;word-wrap:break-word;">备注：</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;clear:both;min-height:1em;word-wrap:break-word;">1、蓝色部分的含义：remark标记需要清理对象的容量。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;clear:both;min-height:1em;word-wrap:break-word;">2、FULL GC阶段之前先在进行一次年轻代的GC的意义是：Yong区对象引用了Old区的对象，如果在Old区进行清理之前不进行Yong区清理，就会导致Old区被Yong区引用的对象无法释放。</p></blockquote><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">调优以后效果很明显，下面是两台配置完全相同的服务器在同一时间段的成功率和响应时间监控图，第一个没有添加强制年轻代GC的参数。</p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [5]" type="image/webp" data-filename="640" height="144" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:auto !important;visibility:visible !important;" width="668"/></p><p style="margin-top:15px;margin:0px;white-space:normal;box-sizing:border-box;font-size:15px;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-bottom:15px;min-height:1em;clear:both;word-wrap:break-word;max-width:100%;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [6]" type="image/webp" data-filename="640" height="143" style="border-width:2px;margin:0px;width:auto !important;box-sizing:border-box;border-radius:6px;height:auto !important;padding:0px;border-style:solid;border-color:rgb(238, 238, 238);word-wrap:break-word;max-width:100%;visibility:visible !important;" width="666"/><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h2 style="word-wrap:break-word;font-weight:400;margin:0px;padding:0px;line-height:1.35;box-sizing:border-box;font-size:22px;margin-top:1.5rem;margin-bottom:1rem;color:rgb(21, 153, 87);max-width:100%;white-space:normal;">结论</h2><p style="min-height:1em;margin:0px;font-size:15px;box-sizing:border-box;font-family:Helvetica, Arial, sans-serif;color:rgb(80, 97, 109);padding:0px;margin-top:15px;margin-bottom:15px;clear:both;word-wrap:break-word;max-width:100%;white-space:normal;">1、在CMS-remark阶段需要对堆中所有的内存对象进行处理，如果在这个阶段之前强制执行一次年轻代的GC会大量减少remark需要处理的内存数量，进而降低JVM卡顿对成功率的影响。<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/>2、对于Java HTTP服务，JVM的卡顿时间应该小于HTTP客户端的调用超时时间，否则JVM卡顿会对成功率造成影响。</p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [7]" type="image/webp" data-filename="640" height="16" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;width:478px !important;visibility:visible !important;" width="478"/></p></div><p style="margin-top:15px;margin:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word !important;font-family:Helvetica, Arial, sans-serif;min-height:1em;padding:0px;margin-bottom:15px;white-space:normal;background-color:rgb(255, 255, 255);color:rgb(80, 97, 109);clear:both;font-size:15px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">优秀人才不缺工作机会，只缺适合自己的好机会。但是他们往往没有精力从海量机会中找到最适合的那个。 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(0, 122, 170);">100offer</span> 会对平台上的人才和企业进行严格筛选，让「最好的人才」和「最好的公司」相遇。 扫描下方二维码，注册 100offer，谈谈你对下一份工作的期待。一周内，收到 5-10 个满足你要求的好机会！</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="min-height:1em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background-color:rgb(255, 255, 255);padding:0px;color:rgb(62, 62, 62);font-size:16px;white-space:normal;clear:both;text-align:center;"><img src="jvm系列(六)Java服务GC参数调优案例_files/640 [8]" type="image/webp" data-filename="640" height="388" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="668"/></p>
                </div>
                
                
                
                                
                

                
                                
                
                            </div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 