<html>
<head>
  <title>Activiti6简明教程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="10280"/>
<h1>Activiti6简明教程</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/1/23 14:53</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.jianshu.com/p/701056e672a4"><i>https://www.jianshu.com/p/701056e672a4</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="font-family:sans-serif;text-size-adjust:100%;box-sizing:border-box;font-size:10px;-webkit-tap-highlight-color:transparent;"><div style="box-sizing:border-box;font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:17px;line-height:1.42857;background-color:rgb(255, 255, 255);min-width:768px;color:rgb(51, 51, 51);"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;color:rgb(47, 47, 47);font-size:16px;font-weight:400;line-height:1.7;word-break:break-word;"><div style="box-sizing:border-box;">
            <h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">一、为什么选择Activiti</h4>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:700px;max-height:379px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:41.6%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp.webp" type="image/webp" data-filename="webp.webp" height="291" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="700"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">工作流引擎对比</div>
</div>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">二、核心7大接口、28张表</h4>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:232px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:41.88%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [1].webp" type="image/webp" data-filename="webp.webp" height="232" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">7大接口</div>
</div>
<h6 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:16px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">（一）7大接口</h6>
<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">RepositoryService：提供一系列管理流程部署和流程定义的API。</li>
<li style="box-sizing:border-box;line-height:30px;">RuntimeService：在流程运行时对流程实例进行管理与控制。</li>
<li style="box-sizing:border-box;line-height:30px;">TaskService：对流程任务进行管理，例如任务提醒、任务完成和创建任务等。</li>
<li style="box-sizing:border-box;line-height:30px;">IdentityService：提供对流程角色数据进行管理的API，这些角色数据包括用户组、用户及它们之间的关系。</li>
<li style="box-sizing:border-box;line-height:30px;">ManagementService：提供对流程引擎进行管理和维护的服务。</li>
<li style="box-sizing:border-box;line-height:30px;">HistoryService：对流程的历史数据进行操作，包括查询、删除这些历史数据。</li>
<li style="box-sizing:border-box;line-height:30px;">FormService：表单服务。</li>
</ol>
<h6 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:16px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">（二）28张表</h6>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:505px;max-height:407px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:80.58999999999999%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [2].webp" type="image/webp" data-filename="webp.webp" height="407" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="505"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">28张表</div>
</div><br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">1、act_ge_   通用数据表，ge是general的缩写<br style="box-sizing:border-box;"/>
2、act_hi_   历史数据表，hi是history的缩写，对应HistoryService接口<br style="box-sizing:border-box;"/>
3、act_id_   身份数据表，id是identity的缩写，对应IdentityService接口<br style="box-sizing:border-box;"/>
4、act_re_   流程存储表，re是repository的缩写，对应RepositoryService接口，存储流程部署和流程定义等静态数据<br style="box-sizing:border-box;"/>
5、act_ru_   运行时数据表，ru是runtime的缩写，对应RuntimeService接口和TaskService接口，存储流程实例和用户任务等动态数据</p>

<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">三、创建BPMN业务流程模型</h4>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">1.将Activiti提供的流程设计器应用activiti-app.war部署到Tomcat的webapps目录。<br style="box-sizing:border-box;"/>
2.创建新的MySql数据库。修改activiti-app\WEB-INF\classes\META-INF\activiti-app目录下的activiti-app.properties配置文件，默认使用H2内存数据库，创建的模型重启后会丢失，改成使用MySql数据库。<br style="box-sizing:border-box;"/>
3.浏览器访问<a href="http://localhost:8080/activiti-app" rel="nofollow" style="background-color:transparent;box-sizing:border-box;color:rgb(49, 148, 208);text-decoration:none;cursor:pointer;" target="_blank">http://localhost:8080/activiti-app</a>，登录账户：admin：test<br style="box-sizing:border-box;"/>
4.创建一个请假审批流程图<br style="box-sizing:border-box;"/>
</p><div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:221px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:39.89%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [3].webp" type="image/webp" data-filename="webp.webp" height="221" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">请假审批流程图</div>
</div><p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"></p>
<ul style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;padding-left:0px;">
<li style="box-sizing:border-box;line-height:30px;">
<p style="box-sizing:border-box;margin:0px 0px 25px;overflow:visible;word-break:break-word;">给每个用户任务指派候选组（有权限执行当前任务的角色）</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;width:auto;margin-left:0px;padding-bottom:25px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:141px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:25.45%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [4].webp" type="image/webp" data-filename="webp.webp" height="141" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">指派候选组</div>
</div>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;width:auto;margin-left:0px;padding-bottom:25px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:396px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:71.48%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [5].webp" type="image/webp" data-filename="webp.webp" height="396" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">指派候选组</div>
</div>
</li>
<li style="box-sizing:border-box;line-height:30px;">
<p style="box-sizing:border-box;margin:0px 0px 25px;overflow:visible;word-break:break-word;">排他网关设置条件分支表达式</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;width:auto;margin-left:0px;padding-bottom:25px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:90px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:16.25%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [6].webp" type="image/webp" data-filename="webp.webp" height="90" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">设置条件分支</div>
</div>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;width:auto;margin-left:0px;padding-bottom:25px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:98px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:17.69%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [7].webp" type="image/webp" data-filename="webp.webp" height="98" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">设置条件分支</div>
</div>
<br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;overflow:visible;word-break:break-word;">5.导出流程图为.bpmn20.xml文件</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;width:auto;margin-left:0px;padding-bottom:25px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:293px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:52.89%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [8].webp" type="image/webp" data-filename="webp.webp" height="293" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">导出xml文件</div>
</div>
</li>
</ul>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">四、Spring Boot与Activiti 6.0整合</h4>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">1.在POM文件中添加依赖</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">dependency</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">groupId</span>&gt;</span>org.activiti<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">groupId</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">artifactId</span>&gt;</span>activiti-spring-boot-starter-basic<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">artifactId</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">version</span>&gt;</span>6.0.0<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">version</span>&gt;</span>
<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">dependency</span>&gt;</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">2.将导出的.bpmn20.xml文件拷贝到项目文件夹/resources/processes下<br style="box-sizing:border-box;"/>
3.application.properties文件添加配置项</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;">spring.activiti.database-schema-update=<span style="box-sizing:border-box;color:rgb(86, 182, 194);">true</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">databaseSchemaUpdate配置项可以设置流程引擎启动和关闭时数据库执行的策略。 databaseSchemaUpdate有以下四个值：</p>
<ul style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;padding-left:0px;">
<li style="box-sizing:border-box;line-height:30px;">false：false为默认值，设置为该值后，Activiti在启动时，会对比数据库表中保存的版本，如果没有表或者版本不匹配时，将在启动时抛出异常。</li>
<li style="box-sizing:border-box;line-height:30px;">true：设置为该值后，Activiti会对数据库中所有的表进行更新，如果表不存在，则Activiti会自动创建。</li>
<li style="box-sizing:border-box;line-height:30px;">create-drop：Activiti启动时，会执行数据库表的创建操作，在Activiti关闭时，执行数据库表的删除操作。</li>
<li style="box-sizing:border-box;line-height:30px;">drop-create：Activiti启动时，执行数据库表的删除操作在Activiti关闭时，会执行数据库表的创建操作。</li>
</ul>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">4.启动应用，会在数据库里创建28张表，表创建好之后停止应用。application.properties文件修改配置项</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">#每次应用启动不检查Activiti数据表是否存在及版本号是否匹配，提升应用启动速度</span>
spring.activiti.database-schema-update=<span style="box-sizing:border-box;color:rgb(86, 182, 194);">false</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">5.application.properties文件增加配置项</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">#保存历史数据级别设置为full最高级别，便于历史数据的追溯</span>
spring.activiti.history-level=full
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">对于历史数据，保存到何种粒度，Activiti提供了history-level属性对其进行配置。history-level属性有点像log4j的日志输出级别，该属性有以下四个值：</p>
<ul style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;padding-left:0px;">
<li style="box-sizing:border-box;line-height:30px;">none：不保存任何的历史数据，因此，在流程执行过程中，这是最高效的。</li>
<li style="box-sizing:border-box;line-height:30px;">activity：级别高于none，保存流程实例与流程行为，其他数据不保存。</li>
<li style="box-sizing:border-box;line-height:30px;">audit：除activity级别会保存的数据外，还会保存全部的流程任务及其属性。audit为history的默认值。</li>
<li style="box-sizing:border-box;line-height:30px;">full：保存历史数据的最高级别，除了会保存audit级别的数据外，还会保存其他全部流程相关的细节数据，包括一些流程参数等。<br style="box-sizing:border-box;"/>
6.完成以上步骤，就可以在程序中使用自动注入的方式，使用Activiti的7大接口。</li>
</ul>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> RuntimeService runtimeService;

<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> TaskService taskService;

<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> IdentityService identityService;

<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> RepositoryService repositoryService;

<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> ProcessEngine processEngine;

<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Autowired</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> HistoryService historyService;
</code></pre>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">五、项目中的用户、角色与Activiti中的用户、用户组整合</h4>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">每个项目都有自己的用户、角色表，Activiti也有自己的用户、用户组表。因此项目中的用户、角色与Activiti中的用户、用户组要做整合。</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//项目中每创建一个新用户，对应的要创建一个Activiti用户</span>
<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//两者的userId和userName一致</span>
User admin=identityService.newUser(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;1&quot;</span>);
admin.setLastName(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;admin&quot;</span>);
identityService.saveUser(admin);

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//项目中每创建一个角色，对应的要创建一个Activiti用户组</span>
Group adminGroup=identityService.newGroup(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;1&quot;</span>);
adminGroup.setName(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;admin&quot;</span>);
identityService.saveGroup(adminGroup);

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//用户与用户组关系绑定</span>
identityService.createMembership(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;1&quot;</span>,<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;1&quot;</span>);
</code></pre>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">六、请假审批流程</h4>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">1.请假申请和请假审批数据库表设计<br style="box-sizing:border-box;"/>
表设计原则：流程数据和业务数据相分离。Activiti相关表只负责流程的跳转、走向等。流程中产生的业务表单数据、审批意见、附件等存储在开发人员定义的业务表中。流程数据和业务数据之间通过processInstanceId(流程实例ID)和业务数据主键相互关联。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">为什么不使用Activiti相关表来存储表单数据和附件？</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:36px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:6.5%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [9].webp" type="image/webp" data-filename="webp.webp" height="36" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">activiti参数表</div>
</div><br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">Activiti为了应用的灵活性和通用性采用了纵表的方式存储表单数据。假设一条请假申请表单数据有10个字段，那就需要10条记录存储原本横表只需要一条记录存储的数据。采用纵表的方式会有如下问题：</p>

<ul style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;padding-left:0px;">
<li style="box-sizing:border-box;line-height:30px;">会有大量的冗余数据并且数据量会急剧的增长</li>
<li style="box-sizing:border-box;line-height:30px;">查询语句复杂，查询效率低</li>
<li style="box-sizing:border-box;line-height:30px;">尤其不适合做后期的统计报表分析</li>
</ul>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:91px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:16.43%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [10].webp" type="image/webp" data-filename="webp.webp" height="91" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">activiti附件表</div>
</div><br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">Activiti存储附件使用Blob数据格式，文件存储在数据库里，数据库的数据文件会变得超大，不利于数据库备份和迁移。<br style="box-sizing:border-box;"/>
请假申请表结构</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:700px;max-height:466px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:56.69%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [11].webp" type="image/webp" data-filename="webp.webp" height="397" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="700"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">请假申请表</div>
</div><br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">请假审批表结构</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:700px;max-height:318px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:38.5%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [12].webp" type="image/webp" data-filename="webp.webp" height="269" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="700"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">请假审批表</div>
</div><br style="box-sizing:border-box;"/>
2.填写请假申请表单，启动流程实例<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:417px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:75.27000000000001%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [13].webp" type="image/webp" data-filename="webp.webp" height="417" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">填写请假申请</div>
</div>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//启动流程实例，字符串&quot;vacation&quot;是BPMN模型文件里process元素的id</span>
ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;vacation&quot;</span>);
<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//流程实例启动后，流程会跳转到请假申请节点</span>
Task vacationApply = taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//设置请假申请任务的执行人</span>
taskService.setAssignee(vacationApply.getId(), req.getUserId().toString());

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//设置流程参数：请假天数和表单ID</span>
<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//流程引擎会根据请假天数days&gt;3判断流程走向</span>
<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//formId是用来将流程数据和表单数据关联起来</span>
<span style="box-sizing:border-box;color:rgb(230, 192, 123);">Map</span>&lt;<span style="box-sizing:border-box;color:rgb(230, 192, 123);">String</span>, <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Object</span>&gt; args = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> HashMap&lt;&gt;();
args.put(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;days&quot;</span>, req.getDays());
args.put(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;formId&quot;</span>, formId);

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//完成请假申请任务</span>
taskService.complete(vacationApply.getId(), args);
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">3.待审批列表</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:61px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:11.01%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [14].webp" type="image/webp" data-filename="webp.webp" height="61" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">待审批列表</div>
</div>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//查出当前登录用户所在的用户组</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">List</span>&lt;Group&gt; groups = identityService.createGroupQuery()
        .groupMember(String.valueOf(userId)).<span style="box-sizing:border-box;color:rgb(198, 120, 221);">list</span>();
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">List</span>&lt;String&gt; groupNames = groups.stream()
        .map(group -&gt; group.getName()).collect(Collectors.toList());

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//查询用户组的待审批请假流程列表</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">List</span>&lt;Task&gt; tasks = taskService.createTaskQuery()
        .processDefinitionKey(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;vacation&quot;</span>)
        .taskCandidateGroupIn(groupNames)
        .listPage(pageNum - <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>, pageSize);

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//根据流程实例ID查询请假申请表单数据</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">List</span>&lt;String&gt; processInstanceIds = tasks.stream()
        .map(task -&gt; task.getProcessInstanceId())
        .collect(Collectors.toList());
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">List</span>&lt;VacationApplyBasicPO&gt; vacationApplyList = 
        vacationRepository.getVacationApplyList(processInstanceIds);
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">4.请假审批功能</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:472px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:85.2%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [15].webp" type="image/webp" data-filename="webp.webp" height="472" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">请假审批</div>
</div>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//查询当前审批节点</span>
Task vacationAudit = taskService.createTaskQuery()
        .taskId(req.getTaskId()).singleResult();

<span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (req.getAuditResult() == <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>) {<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//审批通过</span>
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//设置流程参数：审批ID</span>
    <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Map</span>&lt;<span style="box-sizing:border-box;color:rgb(230, 192, 123);">String</span>, <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Object</span>&gt; args = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> HashMap&lt;&gt;();
    args.put(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;auditId&quot;</span>, auditId);

    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//设置审批任务的执行人</span>
    taskService.claim(vacationAudit.getId(), req.getUserId().toString());
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//完成审批任务</span>
    taskService.complete(vacationAudit.getId(), args);
} <span style="box-sizing:border-box;color:rgb(198, 120, 221);">else</span> {
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//审批不通过，结束流程</span>
    runtimeService.deleteProcessInstance(vacationAudit.getProcessInstanceId(), auditId);
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">5.查看流程图功能</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:554px;max-height:210px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:37.91%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti6简明教程_files/webp [16].webp" type="image/webp" data-filename="webp.webp" height="210" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="554"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">查看流程图</div>
</div>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//controller层代码</span>
<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@RequestMapping</span>(value = <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;/image&quot;</span>, method = RequestMethod.GET)
<span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">image</span><span style="box-sizing:border-box;">(HttpServletResponse response,
 @RequestParam String processInstanceId)</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">try</span> {
        InputStream is = vacationService.getDiagram(processInstanceId);
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (is == <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>)
            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span>;

        response.setContentType(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;image/png&quot;</span>);

        BufferedImage image = ImageIO.read(is);
        OutputStream out = response.getOutputStream();
        ImageIO.write(image, <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;png&quot;</span>, out);

        is.close();
        out.close();
    } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">catch</span> (Exception ex) {
        logger.error(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;查看流程图失败&quot;</span>, ex);
    }
}

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//service层代码</span>
<span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
<span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> InputStream <span style="box-sizing:border-box;color:rgb(97, 174, 238);">getDiagram</span><span style="box-sizing:border-box;">(String processInstanceId)</span> </span>{
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//获得流程实例</span>
    ProcessInstance processInstance = runtimeService.createProcessInstanceQuery()
            .processInstanceId(processInstanceId).singleResult();
    String processDefinitionId = StringUtils.EMPTY;
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (processInstance == <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>) {
        <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//查询已经结束的流程实例</span>
        HistoricProcessInstance processInstanceHistory =
                historyService.createHistoricProcessInstanceQuery()
                        .processInstanceId(processInstanceId).singleResult();
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (processInstanceHistory == <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>)
            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>;
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">else</span>
            processDefinitionId = processInstanceHistory.getProcessDefinitionId();
    } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">else</span> {
        processDefinitionId = processInstance.getProcessDefinitionId();
    }

    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//使用宋体</span>
    String fontName = <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;宋体&quot;</span>;
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//获取BPMN模型对象</span>
    BpmnModel model = repositoryService.getBpmnModel(processDefinitionId);
    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//获取流程实例当前的节点，需要高亮显示</span>
    List&lt;String&gt; currentActs = Collections.EMPTY_LIST;
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (processInstance != <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>)
        currentActs = runtimeService.getActiveActivityIds(processInstance.getId());

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> processEngine.getProcessEngineConfiguration()
            .getProcessDiagramGenerator()
            .generateDiagram(model, <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;png&quot;</span>, currentActs, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> ArrayList&lt;String&gt;(),
                    fontName, fontName, fontName, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">null</span>, <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1.0</span>);
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">最后，spring boot应用打成jar包部署的时候，需要注意：<a href="Activiti6简明教程_files/math"><img src="Activiti6简明教程_files/c282670d54a669b9d107c265a607b66f.png" alt="math"></a>。</p>

          </div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 