<html>
<head>
  <title>多线程查询 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6088"/>
<h1>多线程查询 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/11/7 11:48</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.csdn.net/peerless_hero/article/details/72822883"><i>http://blog.csdn.net/peerless_hero/article/details/72822883</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="box-sizing:border-box;font-family:sans-serif;text-size-adjust:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-size:16px;line-height:24px;color:rgb(51, 51, 51);background-color:rgb(244, 244, 244);font-weight:normal;"><div style="box-sizing:border-box;font-weight:normal;"><span style="box-sizing:border-box;"><div style="box-sizing:border-box;background-color:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.0470588) 0px 2px 4px 0px;">
        <h1 style="margin:0px;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-size:24px;font-weight:bold;line-height:38px;color:rgb(44, 48, 51);padding:0px 29px;">多线程查询</h1>
        <div style="box-sizing:border-box;margin:0px;font-weight:normal;display:block;padding:0px 29px 8px;color:rgb(136, 136, 136);border-bottom:1px solid rgb(229, 229, 229);font-size:14px;line-height:38px;margin-top:5px;"><span style="font-weight:normal;color:rgb(136, 136, 136);font-size:14px;line-height:38px;display:table;"> </span>
            <div style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;float:left;">
                <span style="box-sizing:border-box;margin:0px;font-weight:normal;padding:2px 6px;border:1px solid rgb(228, 235, 244);font-size:14px;color:rgb(120, 144, 156);margin-right:20px;">
                原创                </span>
                <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;display:inline-block;color:rgb(187, 187, 187);font-size:14px;">2017年05月31日 23:47:20</span>
            </div>

            <ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;display:block;float:left;margin-left:26px;background-color:rgb(255, 255, 255);font-size:14px;"><span style="font-weight:normal;list-style:none;font-size:14px;display:table;"> </span>
                <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;color:rgb(187, 187, 187);">标签：</li>


                                                            <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=%E5%A4%9A%E7%BA%BF%E7%A8%8B&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">多线程</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
                                            <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=CountDownL&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">CountDownL</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
                                            <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=Callable&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">Callable</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
                                            <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=Future&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">Future</a> </li>
                                    
            <span style="font-weight:normal;list-style:none;font-size:14px;display:block;clear:both;height:0px;visibility:hidden;">.</span></ul>
            <ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:right;margin-top:5px;">
                <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;margin-left:30px;line-height:28px;"></li>


                
                
            </ul>
        <span style="font-weight:normal;color:rgb(136, 136, 136);font-size:14px;line-height:38px;display:block;clear:both;height:0px;visibility:hidden;">.</span></div>
        <div style="box-sizing:border-box;margin:0px;font-weight:normal;padding:20px 30px 0px;margin-bottom:30px;color:rgb(69, 69, 69);overflow:hidden;">
            <p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">今天遇到下载资金流水记录的场景。下载的数据源于分页查询，一次5000条。当数据量到达十万级的时候，仅仅通过for循环、每次设置pageNum，查询的等待时间超过了容忍的范围。下面示例展示了采用Callable和Future进行多线程查询并使用CountDownLatch进行多线程同步。</p>



<pre style="word-break:break-all;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;white-space:pre-wrap;box-sizing:border-box;display:block;font-weight:normal;margin:0px;line-height:1.42857;color:rgb(51, 51, 51);font-size:13px;word-wrap:break-word;background-color:rgb(245, 245, 245);border-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;border:0px solid rgb(136, 136, 136);padding:2px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0px;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 进行首次查询（略），获取总页数</span>
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">int</span> totalPage;
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 设置计数器，从0开始</span>
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">final</span> CountDownLatch countDownLatch = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">new</span> CountDownLatch(totalPage - <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">1</span>);
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 定义Future数组，数组大小和计数器个数相同</span>
Future&lt;PageResult&lt;FundRecordDTO&gt;&gt;[] futures = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">new</span> Future[totalPage - <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">1</span>];
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">for</span> (<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">int</span> i = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">0</span>; i &lt; totalPage; i++) {
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 重设分页参数，从1开始</span>
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">final</span> PageArg pageArg = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">new</span> PageArg();
    pageArg.setPageSize(ExcelHelper.pageSize);
    pageArg.setPageIndex(i + <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">1</span>);
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 将各个PageResult塞到线程池的各个线程里，返回Future数组</span>
    futures[i] = threadPool.submit(<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">new</span> Callable&lt;PageResult&lt;FundRecordDTO&gt;&gt;() {
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 返回取得的PageResult</span>
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">@Override</span>
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">public</span> PageResult&lt;FundRecordDTO&gt; <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">call</span>() <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">throws</span> Exception {
            PageResult&lt;FundRecordDTO&gt; pageResult = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">new</span> PageResult&lt;FundRecordDTO&gt;();
            <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">try</span> {
                pageResult = fundRecordService.findFundRecordPage(pageArg, fundRecordParam);
            } <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">catch</span> (Exception e) {
                <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">throw</span> e;
            } <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">finally</span> {
                <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 线程完成任务后通过countDownLatch.countDown()来通知CountDownLatch对象，计数器-1</span>
                countDownLatch.countDown();
            }
            <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">return</span> pageResult;
        }
    });
}
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 所有任务执行完毕后触发事件，唤醒await在latch上的主线程</span>
countDownLatch.await();
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 合并记录</span>
<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">for</span> (<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">int</span> j = <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">0</span>; j &lt; totalPage; j++) {
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">if</span> (futures[j] != <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">null</span> &amp;&amp; futures[j].get().getData() != <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">null</span>) {
        fileDataList.addAll(futures[j].get().getData());
    }
}</code></pre>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">上面的例子用到了Callable、Future和CountDownLatch三个常用的多线程工具类，下面我们分别来了解下。</p>

<h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t0" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a><strong style="box-sizing:border-box;font-weight:bold;">Callable和Future</strong></h2>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">Callable是类似于Runnable的接口，实现Callable接口的类和实现Runnable的类都是可被其他线程执行的任务。</p>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">Callable和Runnable的区别如下：</p>

<ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;">
<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;">Callable定义的方法是call，而Runnable定义的方法是run。</li>
<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;">Callable的call方法可以有返回值，而Runnable的run方法不能有返回值。</li>
<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;">Callable的call方法可抛出异常，而Runnable的run方法不能抛出异常。</li>
</ul>



<pre style="word-break:break-all;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;white-space:pre-wrap;box-sizing:border-box;display:block;font-weight:normal;margin:0px;line-height:1.42857;color:rgb(51, 51, 51);font-size:13px;word-wrap:break-word;background-color:rgb(245, 245, 245);border-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;border:0px solid rgb(136, 136, 136);padding:2px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0px;">    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">public</span>
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">interface</span> <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">Runnable</span> {</span>
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">/**
         * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used
         * to create a thread, starting the thread causes the object's
         * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing
         * thread.
         * &lt;p&gt;
         * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may
         * take any action whatsoever.
         *
         *<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;"> @see</span>     java.lang.Thread#run()
         */</span>
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">public</span> <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">abstract</span> <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">void</span> <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">run</span>();
    }</code></pre>



<pre style="word-break:break-all;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;white-space:pre-wrap;box-sizing:border-box;display:block;font-weight:normal;margin:0px;line-height:1.42857;color:rgb(51, 51, 51);font-size:13px;word-wrap:break-word;background-color:rgb(245, 245, 245);border-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;border:0px solid rgb(136, 136, 136);padding:2px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0px;">    public interface Callable&lt;V&gt; {  
        <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">/** 
         * Computes a result, or throws an exception if unable to do so. 
         * 
         * <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">@return</span> computed result 
         * <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">@throws</span> Exception if unable to compute a result 
         */</span>  
        V call() <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">throws</span> Exception;  
    }  </code></pre>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">Future就是对于具体的Runnable或者Callable任务的执行结果进行取消、查询是否完成、获取结果、设置结果操作。</p>



<pre style="word-break:break-all;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;white-space:pre-wrap;box-sizing:border-box;display:block;font-weight:normal;margin:0px;line-height:1.42857;color:rgb(51, 51, 51);font-size:13px;word-wrap:break-word;background-color:rgb(245, 245, 245);border-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;border:0px solid rgb(136, 136, 136);padding:2px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre-wrap;background-color:transparent;border-radius:0px;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">public</span> <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">interface</span> Future&lt;V&gt; {  
    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 可以取消任务的执行，参数为true表示立即中断任务的执行，参数为false表示允许正在运行的任务运行完成。</span>
    boolean cancel(boolean mayInterruptIfRunning);  

    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 查询是否取消掉  </span>
    boolean isCancelled();  

    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 查询是否完成</span>
    boolean isDone();  

    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 等待计算完成，获取计算结果。  </span>
    V <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">get</span>() throws InterruptedException, ExecutionException;  

    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">// 在超时时间内等待计算完成，获取计算结果。 </span>
    V <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">get</span>(<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">long</span> timeout, TimeUnit unit)  
        throws InterruptedException, ExecutionException, TimeoutException;  
} </code></pre>



<h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t1" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a><strong style="box-sizing:border-box;font-weight:bold;">CountDownLatch</strong></h2>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">CountDownLatch是一个同步工具类，它允许一个或多个线程一直等待，直到其他线程的操作执行完后再执行。例如，应用程序的主线程希望在负责启动框架服务的线程已经启动所有的框架服务之后再执行。</p>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">和其它并发工具类，如CyclicBarrier、Semaphore、ConcurrentHashMap和BlockingQueue，它们都存在于java.util.concurrent包下。</p>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">CountDownLatch是通过一个计数器来实现的，计数器的初始值为线程的数量。每当一个线程完成了自己的任务后，计数器的值就会减1。当计数器值到达0时，它表示所有的线程已经完成了任务，然后在闭锁上等待的线程就可以恢复执行任务。这个初始值只能被设置一次，而且CountDownLatch没有提供任何机制去重新设置这个计数值。 <br style="box-sizing:border-box;"/>
<img src="多线程查询 - CSDN博客_files/SouthEast.png" type="image/png" data-filename="SouthEast.png" alt="countDownLatch.countDown" height="338" style="box-sizing:border-box;border:0px;vertical-align:middle;outline:none;max-width:100%;" title="" width="353"/></p>

<p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;word-wrap:break-word;word-break:normal;">与CountDownLatch的第一次交互是主线程等待其他线程。主线程必须在启动其他线程后立即调用CountDownLatch.await()方法。这样主线程的操作就会在这个方法上阻塞，直到其他线程完成各自的任务。</p>        </div>
    </div></span></div></div></div></div><br/></div></span>
</div></body></html> 