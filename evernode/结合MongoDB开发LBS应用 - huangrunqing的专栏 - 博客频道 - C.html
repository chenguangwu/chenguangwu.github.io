<html>
<head>
  <title>结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - CSDN.NET</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="9542"/>
<h1>结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - CSDN.NET</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2016/7/20 15:16</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.csdn.net/huangrunqing/article/details/9112227"><i>http://blog.csdn.net/huangrunqing/article/details/9112227</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px"><div><div style="color:rgb(51, 51, 51);text-align:center;font-size:12px;font-family:Arial, Console, Verdana, 'Courier New';background:url(http://static.blog.csdn.net/skin/default/images/body_bg.gif) 0px 20px repeat-x;"><div style="background:url(http://static.blog.csdn.net/skin/default/images/head_bg.jpg) 50% 0% no-repeat;"><div style="overflow:hidden;border-radius:8px;text-align:left;background:rgb(255, 255, 255);"><div style="overflow:hidden;border-radius:4px;"><div><div style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:23167px;">
    <div style="line-height:30px;display:block;color:rgb(0, 0, 0);font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:20px;margin:5px 0px;font-family:'Microsoft YaHei';border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:33px;">   
         <span style="display:inline-block;width:19px;height:19px;margin:0px 2px 0px 0px;vertical-align:middle;background:url(http://static.blog.csdn.net/images/ico_Repost.gif) 0px 0px no-repeat;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:url(http://static.blog.csdn.net/images/ico_Repost.gif);box-shadow:none;"></span>


    <h1 style="font-family:'Microsoft YaHei';display:inline;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:20px;line-height:30px;font-style:normal;vertical-align:middle;margin:0px;padding:0px;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
        <span style="border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><a href="http://blog.csdn.net/huangrunqing/article/details/9112227" style="color:rgb(0, 0, 0);text-decoration:none;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
        结合MongoDB开发LBS应用            
        </a></span>
    </h1>
<span style="color:rgb(0, 0, 0);font-style:normal;font-variant:normal;font-weight:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';display:block;height:0px;clear:both;visibility:hidden;">.</span></div>

   

        <div style="border-bottom-style:solid;padding:0px 20px 5px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:22px;font-family:Arial;text-align:right;display:block;color:rgb(153, 153, 153);border-bottom-width:1px;border-bottom-color:rgb(237, 237, 237);margin:0px -20px;overflow:hidden;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:22px;">
        <div style="border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:22px;">
            <span style="margin:0px 5px 0px 0px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">2013-06-17 14:36</span>
            <span style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(http://static.blog.csdn.net/images/ico_view.png) 0% 50% no-repeat;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:url(http://static.blog.csdn.net/images/ico_view.png);box-shadow:none;" title="阅读次数">15838人阅读</span>
            <span style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(http://static.blog.csdn.net/images/ico_comm.png) 0% 50% no-repeat;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:url(http://static.blog.csdn.net/images/ico_comm.png);box-shadow:none;" title="评论次数"> <a href="http://blog.csdn.net/huangrunqing/article/details/9112227#comments" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">评论</a>(0)</span>
            <span style="margin:0px 5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"> <a href="#" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" title="收藏">收藏</a></span>
             <span style="margin:0px 5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"> <a href="http://blog.csdn.net/huangrunqing/article/details/9112227#report" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" title="举报">举报</a></span>

        </div>
    <span style="color:rgb(153, 153, 153);font-style:normal;font-variant:normal;font-weight:normal;font-size:12px;line-height:22px;font-family:Arial;text-align:right;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
    
    
    
      <div style="height:46px;display:block;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:rgb(237, 237, 237);padding:0px 20px;margin:0px -20px;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;">
        <div style="display:inline-block;font-size:14px;color:rgb(51, 51, 51);border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:61px;height:17px;">
           <img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/category_icon.jpg" type="image/jpeg" data-filename="category_icon.jpg" height="13" style="vertical-align:middle;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:15px;height:13px;" width="15"/>
            <span style="display:inline-block;vertical-align:middle;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:42px;height:16px;">分类：</span>
        </div>
        <div style="display:inline-block;font-size:14px;color:rgb(223, 52, 52);border:0px none rgb(223, 52, 52);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:91px;height:46px;">
                    <span style="border:0px none rgb(223, 52, 52);display:inline-block;cursor:pointer;line-height:46px;position:relative;margin-left:15px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:76px;height:46px;">
                        <span style="border:0px none rgb(223, 52, 52);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">web<em style="font-style:normal;border:0px none rgb(223, 52, 52);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">（2）</em></span>
                      <img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/arrow_triangle _down.jpg" type="image/jpeg" data-filename="arrow_triangle _down.jpg" height="5" style="border:0px none rgb(223, 52, 52);display:inline;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:10px;height:5px;" width="10"/>
                      
                        
                    </span>                    
        </div>
    <span style="display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
      

  

  
  
     

<div style="clear:both;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:0px;"></div><div style="border:1px solid rgb(204, 204, 204);background:#eee;float:left;min-width:200px;padding:4px 10px;background-color:rgb(238, 238, 238);background-image:none;box-shadow:none;width:200px;height:14px;"><p style="text-align:right;margin:0;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:200px;height:14px;"><span style="float:left;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:39px;height:14px;">目录<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" title="系统根据文章中H1到H6标签自动生成文章目录">(?)</a></span><a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" title="展开">[+]</a></p></div><div style="clear:both;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:0px;"></div><div style="font-family:Arial;margin:20px 0px 0px;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:14px;line-height:26px;font-style:normal;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:22602px;">

<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t0" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>简介</h2>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">随着近几年各类移动终端的迅速普及，基于地理位置的服务（LBS）和相关应用也越来越多，而支撑这些应用的最基础技术之一，就是基于地理位置信息的处理。我所在的项目也正从事相关系统的开发，我们使用的是Symfony2+Doctrine2 ODM+MongoDB的组合。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">我们将这些技术要点整理成文，希望能够通过本文的介绍和案例，详细解释如何使用MongoDB进行地理位置信息的查询和处理。在文章的开头，我们也会先介绍一下业界通常用来处理地理位置信息的一些方案并进行比较，让读者逐步了解使用MongoDB查询及处理地理位置信息的优势。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">本文使用了Symfony2和Doctrine2作为Web应用的开发框架，对于想了解Symfony2的数据库操作的读者来说阅读本文也可以了解和掌握相关的技术和使用方法。</p>
<div style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><br style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"/>
</div>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t1" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>1. LBS类应用特点</h2>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">不管是什么LBS应用，一个共同的特点就是：他们的数据都或多或少包含了地理位置信息。而如何对这些信息进行查询、处理、分析，也就成为了支撑LBS应用的最基础也是最关键的技术问题。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">而由于地理位置信息的特殊性，在开发中经常会有比较难以处理的问题出现，比如：由于用户所在位置的不固定性，用户可能会在很小范围内移动，而此时经纬度值也会随之变化；甚至在同一个位置，通过GPS设备获取到的位置信息也可能不一样。所以如果通过经纬度去获取周边信息时，就很难像传统数据库那样做查询并进行缓存。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">对于这个问题，有读者可能会说有别的处理方案，没错，比如只按经纬度固定的几位小数点做索引，比如按矩阵将用户划分到某固定小范围的区域（可以参考后文将会提到的geohash）等方式，虽然可以绕个弯子解决，但或多或少操作起来比较麻烦，也会牺牲一些精度，甚至无法做到性能的最优化，所以不能算作是最佳的解决办法。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">而最近几年，直接支持地理位置操作的数据库层出不穷，其操作友好、性能高的特性也开始被我们慢慢重视起来，其中的佼佼者当属MongoDB。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">MongoDB在地理位置信息的处理上有什么优势？下面我们通过一个简单的案例来对比一下各种技术方案之间进行进行地理位置信息处理的差异。</p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t2" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>2. 几个地理位置信息处理方案的对比和分析</h2>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t3" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>1. 确定功能需求</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">对于任何LBS应用来说，让用户寻找周围的好友可能都是一个必不可少的功能，我们就以这个功能为例，来看看各种处理方案之间的差异和区别。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">我们假设有如下功能需求：</p>
<ul style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:78px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">显示我附近的人</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">由近到远排序</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">显示距离</li></ul>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t4" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>2. 可能的技术方案</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">排除一些不通用和难以实现的技术，我们罗列出以下几种方案：</p>
<ol style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:104px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">基于MySQL数据库</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">采用GeoHash索引，基于MySQL</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">MySQL空间存储（MySQL Spatial Extensions）</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">使用MongoDB存储地理位置信息</li></ol>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">我们一个个来分析这几种方案。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t5" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>方案1：基于MySQL数据库</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://lib.csdn.net/base/14" style="color:#df3434;text-decoration:none;font-weight:bold;border:0px none rgb(223, 52, 52);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="undefined">MySQL</a>的使用非常简单。对于大部分已经使用MySQL的网站来说，使用这种方案没有任何迁移和部署成本。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">而在MySQL中查询“最近的人”也仅需一条SQL即可,</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">SELECT id, ( 6371 * acos( cos( radians(37) ) * cos( radians( lat ) ) * cos( radians
( lng ) - radians(-122) ) + sin( radians(37) ) * sin( radians( lat ) ) ) ) AS distance
 FROM places HAVING distance &lt; 25 ORDER BY distance LIMIT 0 , 100;</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">注：这条SQL查询的是在lat,lng这个坐标附近的目标，并且按距离正序排列，SQL中的distance单位为公里。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">但使用SQL语句进行查询的缺点也显而易见，每条SQL的计算量都会非常大，性能将会是严重的问题。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">先别放弃，我们尝试对这条SQL做一些优化。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">可以将圆形区域抽象为正方形，如下图</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:459px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/1.jpg" type="image/jpeg" data-filename="1.jpg" alt="" height="459" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:459px;" width="500"/></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">根据维基百科上的球面计算公式，可以根据圆心坐标计算出正方形四个点的坐标。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">然后，查询这个正方形内的目标点。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">SQL语句可以简化如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">SELECT * FROM places WHERE ((lat BETWEEN ? AND ?) AND (lng BETWEEN ? AND ?))</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">这样优化后，虽然数据不完全精确，但性能提升很明显，并且可以通过给lat lng字段做索引的方式进一步加快这条SQL的查询速度。对精度有要求的应用也可以在这个结果上再进行计算，排除那些在方块范围内但不在原型范围内的数据，已达到对精度的要求。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">可是这样查询出来的结果，是没有排序的，除非再进行一些SQL计算。但那又会在查询的过程中产生临时表排序，可能会造成性能问题。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t6" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>方案2：GeoHash索引，基于MySQL</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;"><a href="http://en.wikipedia.org/wiki/Geohash" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">GeoHash</a>是一种地址编码，通过切分地图区域为小方块（切分次数越多，精度越高），它能把二维的经纬度编码成一维的字符串。也就是说，理论上geohash字符串表示的并不是一个点，而是一个矩形区域，只要矩形区域足够小，达到所需精度即可。（其实<a href="http://blog.nosqlfan.com/html/1811.html" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">MongoDB的索引也是基于geohash</a>）</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">如：<a href="http://geohash.org/wtw3ued9m" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">wtw3ued9m</a>就是目前我所在的位置，降低一些精度，就会是<a href="http://geohash.org/wtw3ued" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">wtw3ued</a>，再降低一些精度，就会是<a href="http://geohash.org/wtw3u" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">wtw3u</a>。（点击链接查看坐标编码对应Google地图的位置）</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">所以这样一来，我们就可以在MySQL中用LIKE ‘wtw3u%’来限定区域范围查询目标点，并且可以对结果集做缓存。更不会因为微小的经纬度变化而无法用上数据库的Query Cache。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">这种方案的优点显而易见，仅用一个字符串保存经纬度信息，并且精度由字符串从头到尾的长度决定，可以方便索引。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">但这种方案的缺点是：从geohash的编码算法中可以看出，靠近每个方块边界两侧的点虽然十分接近，但所属的编码会完全不同。实际应用中，虽然可以通过去搜索环绕当前方块周围的8个方块来解决该问题，但一下子将原来只需要1次SQL查询变成了需要查询9次，这样不仅增大了查询量，也将原本简单的方案复杂化了。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">除此之外，这个方案也无法直接得到距离，需要程序协助进行后续的排序计算。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t7" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>方案3：MySQL空间存储</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:104px;">MySQL的空间扩展（MySQL Spatial Extensions），它允许在MySQL中直接处理、保存和分析地理位置相关的信息，看起来这是使用MySQL处理地理位置信息的“官方解决方案”。但恰恰很可惜的是：它却不支持某些最基本的地理位置操作，比如查询在半径范围内的所有数据。它甚至连两坐标点之间的距离计算方法都没有（MySQL Spatial的distance方法在5.*版本中不支持）</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">官方指南的做法是这样的：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">GLength(LineStringFromWKB(LineString(point1, point2)))</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">这条语句的处理逻辑是先通过两个点产生一个LineString的类型的数据，然后调用GLength得到这个LineString的实际长度。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">这么做虽然有些复杂，貌似也解决了距离计算的问题，但读者需要注意的是：这种方法计算的是欧式空间的距离，简单来说，它给出的结果是两个点在三维空间中的直线距离，不是飞机在地球上飞的那条轨迹，而是笔直穿过地球的那条直线。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">所以如果你的地理位置信息是用经纬度进行存储的，你就无法简单的直接使用这种方式进行距离计算。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t8" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>方案4：使用MongoDB存储地理位置信息</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">MongoDB原生支持地理位置索引，可以直接用于位置距离计算和查询。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">另外，它也是如今最流行的NoSQL数据库之一，除了能够很好地支持地理位置计算之外，还拥有诸如面向集合存储、模式自由、高性能、支持复杂查询、支持完全索引等等特性。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">对于我们的需求，在MongoDB只需一个命令即可得到所需要的结果：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">db.runCommand( { geoNear: &quot;places&quot;, near: [ 121.4905, 31.2646 ], num:100 })</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询结果默认将会由近到远排序，而且查询结果也包含目标点对象、距离目标点的距离等信息。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">由于geoNear是MongoDB原生支持的查询函数，所以性能上也做到了高度的优化，完全可以应付生产环境的压力。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t9" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>方案总结</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">基于MongoDB做附近查询是很方便的一件事情。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">MongoDB在地理位置信息方面的表现远远不限于此，它还支持更多更加方便的功能，如范围查询、距离自动计算等。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">接下来，我们结合Symfony2来详细地演示一些使用MongoDB进行地理位置信息处理的例子。</p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t10" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>3. 结合Symfony2演示</h2>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t11" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>运行环境</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">参考环境：Nginx1.2 + PHP5.4 + MongoDB2.4.3 + Symfony2.1</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">建立coordinate和places两个document文件，前者是作为places内的一个embed字段. 为方便演示效果，这里同时设置了两个索引 2d 和 2dsphere</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:1534px;">    Document/Coordinate.php

    /**
     * @MongoDB\EmbeddedDocument
     */
    class Coordinate {
        /**
        * @MongoDB\Field(type=&quot;float&quot;)
        */
        public $longitude;

        /**
        * @MongoDB\Field(type=&quot;float&quot;)
        */
        public $latitude;

        ...
    }

    Document/Place.php

    /**
    * @MongoDB\Document(collection=&quot;places&quot;)
    * @MongoDB\ChangeTrackingPolicy(&quot;DEFERRED_EXPLICIT&quot;)
    * @MongoDB\Indexes({
    *   @MongoDB\Index(keys={&quot;coordinate&quot;=&quot;2d&quot;}),
    *   @MongoDB\Index(keys={&quot;coordinate&quot;=&quot;2dsphere&quot;})
    * })
    */
    class Place
    {
        /**
        *
        * @MongoDB\Id(strategy=&quot;INCREMENT&quot;)
        */
        protected $id;

        /**
        * @MongoDB\Field(type=&quot;string&quot;)
        */
        protected $title;

        /**
        * @MongoDB\Field(type=&quot;string&quot;)
        */
        protected $address;

        /**
        * @MongoDB\EmbedOne(targetDocument=&quot;HenterGEO\GEOBundle\Document\Coordinate&quot;)
        */
        protected $coordinate;

        /**
        * @MongoDB\Distance
        */
        public $distance;

        ...
    }</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">坐标保存以longitude, latitude这个顺序（没有明确的限制和区别，但我们在此遵循官方的推荐）。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">另外，为直观显示查询效果，默认使用百度地图标记查询数据。</p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t12" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>程序说明</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">我们用到的代码包是doctrine/mongodb-odm-bundle（下文称ODM），这个代码包提供了在Symfony2环境下的MongoDB数据库支持，使用这个代码包，可以让我们更加方便的在Symfony2环境下操作MongoDB数据库。。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">ODM封装了MongoDB中常用的一些地理位置函数，如周边搜索和范围搜索。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">ODM中的操作默认距离单位是度，只有geoSphere支持弧度单位（必须在参数中指定spherical(true)）</p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t13" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>4. MongoDB的地理位置查询</h2>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t14" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>注意事项</h3>
<ol style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:156px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:52px;">下文大多数直接对MongoDB的数据库操作将使用Mongo Shell进行演示。在演示网站页面和功能时，将结合Symfony2、Doctrine-MongoDB进行演示。</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">本文演示所用的MongoDB版本为2.4.3，版本号比较新，所以某些查询方式在低版本里面并不支持。</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:78px;">以places这个collection为例，大部分例子都需要类似下面格式的测试数据支持： { &quot;_id&quot; : 2, &quot;coordinate&quot; : { &quot;longitude&quot; : 121.3449, &quot;latitude&quot; : 31.17528 }, &quot;title&quot; : &quot;仅售75元，市场价210元的顶呱呱田鸡火锅3-4人套餐，无餐具费，冬日暖锅，欢迎品尝&quot;, &quot;address&quot; : &quot;闵行区航新路634号&quot; }</li></ol>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t15" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>地理位置索引：</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">MongoDB地理位置索引常用的有两种。</p>
<ul style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:52px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">2d 平面坐标索引，适用于基于平面的坐标计算。也支持球面距离计算，不过官方推荐使用2dsphere索引。</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">2dsphere 几何球体索引，适用于球面几何运算</li></ul>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">关于两个坐标之间的距离，官方推荐2dsphere：</p>
<blockquote style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:52px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:52px;">MongoDB supports rudimentary spherical queries on flat 2d indexes for legacy reasons. In general, spherical calculations should use a 2dsphere index, as described in 2dsphere Indexes.</p>
</blockquote>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">不过，只要坐标跨度不太大（比如几百几千公里），这两个索引计算出的距离相差几乎可以忽略不计。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">建立索引：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">&gt; db.places.ensureIndex({'coordinate':'2d'})
&gt; db.places.ensureIndex({'coordinate':'2dsphere'})</pre>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t16" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>查询方式：</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询方式分三种情况：</p>
<ol style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:78px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">Inclusion。范围查询，如百度地图“视野内搜索”。</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">Inetersection。交集查询。不常用。</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">Proximity。周边查询，如“附近500内的餐厅”。</li></ol>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">而查询坐标参数则分两种：</p>
<ol style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:406px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:170px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:52px;">坐标对（经纬度）根据查询命令的不同，$maxDistance距离单位可能是 弧度 和 平面单位（经纬度的“度”）：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:104px;">  db.&lt;collection&gt;.find( { &lt;location field&gt; :
                   { $nearSphere: [ &lt;x&gt; , &lt;y&gt; ] ,
                     $maxDistance: &lt;distance in radians&gt;
                } } )</pre>
</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:222px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">GeoJson $maxDistance距离单位默认为米：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:182px;">  db.&lt;collection&gt;.find( { &lt;location field&gt; :
                   { $nearSphere :
                     { $geometry :
                        { type : &quot;Point&quot; ,
                          coordinates : [ &lt;longitude&gt; , &lt;latitude&gt; ] } ,
                       $maxDistance : &lt;distance in meters&gt;
             } } } )</pre>
</li></ol>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t17" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>案例A：附近的人</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询当前坐标附近的目标，由近到远排列。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">可以通过$near或$nearSphere，这两个方法类似，但<strong style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">默认</strong>情况下所用到的索引和距离单位不同。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询方式：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">&gt; db.places.find({'coordinate':{$near: [121.4905, 31.2646]}})
&gt; db.places.find({'coordinate':{$nearSphere: [121.4905, 31.2646]}})</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询结果：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:312px;">{ 
    &quot;_id&quot; : 115, 
    &quot;coordinate&quot; : { 
        &quot;longitude&quot; : 121.4915, 
        &quot;latitude&quot; : 31.25933 
    }, 
    &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，
节假日通用，精致生活，品质享受&quot;, 
    &quot;address&quot; : &quot;虹口区天水路90号&quot; 
}

…(100条)</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">上述查询坐标[121.4905, 31.2646]附近的100个点，从最近到最远排序。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">默认返回100条数据，也可以用limit()指定结果数量，如</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">&gt; db.places.find({'coordinate':{$near: [121.4905, 31.2646]}}).limit(2)</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">指定最大距离 $maxDistance</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">&gt; db.places.find({'coordinate':{$near: [121.4905, 31.2646], $maxDistance:2}})</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">结合Symfony2进行演示：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">这里用near，默认以度为单位，公里数除以111（关于该距离单位后文有详细解释）。</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:468px;">/**
 * @Route(&quot;/near&quot;, name=&quot;near&quot;)
 * @Template()
 */
public function nearAction(){

    $longitude = (float)$this-&gt;getRequest()-&gt;get('lon',121.4905);
    $latitude = (float)$this-&gt;getRequest()-&gt;get('lat',31.2646);
    //2km
    $max = (float)$this-&gt;getRequest()-&gt;get('max', 2);

    $places = $this-&gt;getPlaceRepository()-&gt;createQueryBuilder()
        -&gt;field('coordinate')-&gt;near($longitude, $latitude)
        -&gt;maxDistance($max/111)
        -&gt;getQuery()-&gt;toarray();

    return compact('places','max','longitude','latitude');
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过 domain.dev/near 访问，效果如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:320px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/2.png" type="image/png" data-filename="2.png" alt="" height="320" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:320px;" width="500"/></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">longitude: xxx, latitude: xxx为当前位置，我们在地图上显示了周边100条目标记录</p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t18" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>案例B：区域内搜索</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">MongoDB中的范围搜索（Inclusion）主要用$geoWithin这个命令，它又细分为3种不同类型，如下：</p>
<ol style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:78px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">$box 矩形</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">$center 圆（平面），$centerSphere圆（球面）</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">$polygon 多边形</li></ol>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">$center和$centerSphere在小范围内的应用几乎没差别（除非这个圆半径几百上千公里）。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">下面我们介绍一下这三种查询的案例。</p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t19" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>矩形区域</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">这个比较常用，比如百度地图的视野内搜索（矩形）、或搜狗地图的“拉框搜索”</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">定义一个矩形范围，我们需要指定两个坐标，在MongoDB的查询方式如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:234px;">&gt; db.places.find( 
    { 
        coordinate : { 
            $geoWithin : { 
                $box :[ [ 121.44, 31.25 ] , [ 121.5005, 31.2846 ] ] 
            } 
        } 
    } 
)</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询结果：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:338px;">{ 
    &quot;_id&quot; : 90472, 
    &quot;title&quot; : &quot;【鲁迅公园】仅售99元！酒店门市价288元的上海虹元商务宾馆客房一间入住一天（需持本人有效
身份证件办理登记）：大床房/标准房（2选1）！不含早餐！不涉外！2012年9月29日-10月6日
不可使用拉手券！可延迟退房至14:00！&quot;, 
    &quot;address&quot; : &quot;上海市虹口区柳营路8号&quot;, 
    &quot;coordinate&quot; : { 
        &quot;longitude&quot; : 121.47, 
        &quot;latitude&quot; : 31.27145 
    } 
}
...
...</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">Symfony2演示代码：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">指定两个坐标点</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:520px;">/**
 * @Route(&quot;/box&quot;, name=&quot;box&quot;)
 * @Template()
 */
public function boxAction(){
    $request = $this-&gt;getRequest();

    $longitude = (float)$request-&gt;get('lon',121.462035);
    $latitude = (float)$request-&gt;get('lat',31.237641);

    $longitude2 = (float)$request-&gt;get('lon2',121.522098);
    $latitude2 = (float)$request-&gt;get('lat2',31.215284);

    $places = $this-&gt;getPlaceRepository()-&gt;createQueryBuilder()
        -&gt;field('coordinate')-&gt;withinBox($longitude, $latitude, 
$longitude2, $latitude2)
        -&gt;getQuery()-&gt;toarray();

    return compact('places','longitude','latitude', 'longitude2', 'latitude2');
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过 domain.dev/box 访问，效果如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:284px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/3.png" type="image/png" data-filename="3.png" alt="" height="284" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:284px;" width="500"/></p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t20" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>圆形区域</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">应用场景有：地图搜索租房信息</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询以某坐标为圆心，指定半径的圆内的数据。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">前面已提到，圆形区域搜索分为$center和$centerSphere这两种类型，它们的区别主要在于支持的索引和默认距离单位不同。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">2d索引能同时支持$center和$centerSphere，2dsphere索引支持$centerSphere。关于距离单位，$center默认是度，$centerSphere默认距离是弧度。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询方式如下：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:442px;">&gt; db.places.find({'coordinate':{$geoWithin:{$centerSphere:[ [121.4905, 31.2646] ,
0.6/111] }}})
或
&gt; db.places.find({'coordinate':{$geoWithin:{$centerSphere:[ [121.4905, 31.2646] ,
0.6/6371] }}})
查询结果
{ 
    &quot;_id&quot; : 115, 
    &quot;coordinate&quot; : { 
        &quot;longitude&quot; : 121.4915, 
        &quot;latitude&quot; : 31.25933 
    }, 
    &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，节假日通用，
精致生活，品质享受&quot;, 
    &quot;address&quot; : &quot;虹口区天水路90号&quot; 
}
...</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">Symfony2演示代码：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">指定圆心坐标和半径</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:468px;">/**
 * @Route(&quot;/center&quot;, name=&quot;center&quot;)
 * @Template()
 */
public function centerAction(){
    $request = $this-&gt;getRequest();

    $longitude = (float)$request-&gt;get('lon',121.4905);
    $latitude = (float)$request-&gt;get('lat',31.2646);
    //10km
    $max = (float)$request-&gt;get('max', 10);

    $places = $this-&gt;getPlaceRepository()-&gt;createQueryBuilder()
        -&gt;field('coordinate')-&gt;withinCenter($longitude, $latitude, $max/111)
        -&gt;getQuery()-&gt;toarray();

    return compact('places','max','longitude','latitude');
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过 domain.dev/center 访问，效果如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">以longitude: xxx，latitude: xxx为中心点，半径10km的圆内</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:284px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/4.png" type="image/png" data-filename="4.png" alt="" height="284" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:284px;" width="500"/></p>
<h4 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t21" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>多边形</h4>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">复杂区域内的查询，这个应用场景比较少见。指定至少3个坐标点，查询方式如下（五边形）：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:182px;">&gt; db.places.find( { coordinate : { $geoWithin : { $polygon : [ 
    [121.45183 , 31.243816] ,
    [121.533181, 31.24344] ,
    [121.535049, 31.208983] ,
    [121.448955, 31.214913] ,
    [121.440619, 31.228748]
] } } } )</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询结果</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:260px;">{ 
    &quot;_id&quot; : 90078, 
    &quot;title&quot; : &quot;仅售9.9元，市场价38元的燕太太燕窝单人甜品餐，用耐心守候一盅炖品，用爱滋补一生情谊&quot;, 
    &quot;address&quot; : &quot;河南南路489号香港名都购物广场1F125燕太太燕窝&quot;, 
    &quot;coordinate&quot; : { 
        &quot;longitude&quot; : 121.48912, 
        &quot;latitude&quot; : 31.22355 
    } 
}
...</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">Symfony2演示代码（这里为方便，直接写死了5个坐标点）：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:676px;">/**
 * @Route(&quot;/polygon&quot;, name=&quot;polygon&quot;)
 * @Template()
 */
public function polygonAction(){
    $points = [];
    $points[] = [121.45183,31.243816];
    $points[] = [121.533181,31.24344];
    $points[] = [121.535049,31.208983];
    $points[] = [121.448955,31.214913];
    $points[] = [121.440619,31.228748];

    $sumlon = $sumlat = 0;
    foreach($points as $p){
        $sumlon += $p[0];
        $sumlat += $p[1];
    }
    $center = [$sumlon/count($points), $sumlat/count($points)];

    $places = $this-&gt;getPlaceRepository()-&gt;createQueryBuilder()
        -&gt;field('coordinate')-&gt;withinPolygon($points[0], $points[1], $points[2], 
$points[3], $points[4])
        -&gt;getQuery()-&gt;toarray();

    return compact('places','points', 'center');
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过 domain.dev/polygon 访问，效果如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:311px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/5.png" type="image/png" data-filename="5.png" alt="" height="311" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:311px;" width="500"/></p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t22" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>案例C：附近的餐厅</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">我们假设需要以当前坐标为原点，查询附近指定范围内的餐厅，并直接显示距离。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">这个需求用前面提到的$near是可以实现的，但是距离需要二次计算。这里我们用$geoNear这个命令查询。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">$geoNear与$near功能类似，但提供更多功能和返回更多信息，官方文档是这么解释的：</p>
<blockquote style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:52px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:52px;">The geoNear command provides an alternative to the $near operator. In addition to the functionality of $near, geoNear returns additional diagnostic information.</p>
</blockquote>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">查询方式如下（关于下面的示例用到了distanceMultipler函数，后文会详细解释)：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:1170px;">&gt; db.runCommand( { geoNear: &quot;places&quot;, near: [ 121.4905, 31.2646 ], spherical: true,
 maxDistance:1/6371, num:2 })
{
    &quot;ns&quot; : &quot;mongo_test.places&quot;,
    &quot;near&quot; : &quot;1110001100111100001011010110010111001000110011111101&quot;,
    &quot;results&quot; : [
        {
            &quot;dis&quot; : 0.00009318095248858048,
            &quot;obj&quot; : {
                &quot;_id&quot; : 115,
                &quot;coordinate&quot; : {
                    &quot;longitude&quot; : 121.4915,
                    &quot;latitude&quot; : 31.25933
                },
                &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，
节假日通用，精致生活，品质享受&quot;,
                &quot;address&quot; : &quot;虹口区天水路90号&quot;
            }
        },
        {
            &quot;dis&quot; : 0.00010610660597329082,
            &quot;obj&quot; : {
                &quot;_id&quot; : 465,
                &quot;coordinate&quot; : {
                    &quot;longitude&quot; : 121.48406,
                    &quot;latitude&quot; : 31.26202
                },
                &quot;title&quot; : &quot;【四川北路】热烈庆祝康骏会馆成立8周年！仅售169元！市场价399元的
康骏会馆四川北路一店（仅限3星级技师）全身精油按摩一人次！全程约90分钟！
男女不限！仅限四川北路一店使用，非本市所有门店通用！拉手券消费仅限每日19:00前！
健康有道，骏越万里！&quot;,
                &quot;address&quot; : &quot;虹口区四川北路1896号-1904号201室&quot;
            }
        }
    ],
    &quot;stats&quot; : {
        &quot;time&quot; : 0,
        &quot;btreelocs&quot; : 0,
        &quot;nscanned&quot; : 18,
        &quot;objectsLoaded&quot; : 12,
        &quot;avgDistance&quot; : 0.00009964377923093564,
        &quot;maxDistance&quot; : 0.0001064199324957278
    },
    &quot;ok&quot; : 1
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">可以看到返回了很多详细信息，如查询时间、返回数量、最大距离、平均距离等。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">另外，results里面直接返回了距离目标点的距离dis。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">Symfony2演示代码：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:624px;">/**
 * @Route(&quot;/distance&quot;, name=&quot;distance&quot;)
 * @Template()
 */
public function distanceAction(){

    $longitude = (float)$this-&gt;getRequest()-&gt;get('lon',121.4905);
    $latitude = (float)$this-&gt;getRequest()-&gt;get('lat',31.2646);
    //2km
    $max = (float)$this-&gt;getRequest()-&gt;get('max', 2);

    $places = $this-&gt;getPlaceRepository()-&gt;createQueryBuilder()
        -&gt;field('coordinate')
        -&gt;geoNear($longitude, $latitude)
        -&gt;spherical(true)
        -&gt;distanceMultiplier(6371)
        -&gt;maxDistance($max/6371)
        -&gt;limit(100)
        -&gt;getQuery()
        -&gt;execute()
        -&gt;toArray();

    return compact('places','longitude', 'latitude', 'max');
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过 domian.dev/distance 访问，效果如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">距离xxx米</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:284px;"><img src="结合MongoDB开发LBS应用 - huangrunqing的专栏 - 博客频道 - C_files/6.png" type="image/png" data-filename="6.png" alt="" height="284" style="max-width:100%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:500px;height:284px;" width="500"/></p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t23" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>小结</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">前面演示的查询代码中，坐标都是按照 longitude, latitude这个顺序的。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">这个是官方建议的坐标顺序，但是网上很多文档是相反的顺序，经测试发现，只要查询时指定的坐标顺序与数据库内的坐标顺序一致，出来的结果就是正确的，没有特定的先后顺序之分。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">但鉴于官方文档的推荐，我在此还是建议大家按照官方推荐的顺序。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">案例A的$near和案例B的$center从需求上看差不多，但是$center或$centerSphere是属于$geoWithin的类型，$near方法查询后会对结果集对距离进行排序,而$geoWithin是无序的。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">常用的查询方式已经介绍完了，不常用的比如geoIntersect查询，这里不做介绍，但是已经包含在开源的演示程序里了，有兴趣的读者可以自行测试研究。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">下面介绍前文提到的距离单位等问题。</p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t24" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>5. 需要注意的问题</h2>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t25" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>索引</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">$near命令必须要求有索引。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">$geoWithin可以无需索引，但是建议还是建立索引以提升性能。</p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t26" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>距离单位</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">MongoDB查询地理位置默认有3种距离单位：</p>
<ul style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:78px;">
<li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">米(meters)</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">平面单位(flat units，可以理解为经纬度的“一度”)</li><li style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:668px;height:26px;">弧度(radians)。</li></ul>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过GeoJSON格式查询，单位默认是米，通过其它方式则比较混乱，下面详细解释一下。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">下面的查询语句指定距离内的目标：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">&gt; db.places.find({'coordinate':{$near: [121.4905, 31.2646], $maxDistance:2}})</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">现在$maxDistance参数是2，但是如果我要查询如“附近500米内的餐厅”这样的需求，这个参数应该是多少？</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">关于距离计算，MongoDB的官方文档仅仅提到了<a href="http://www.infoq.com/cn/articles/%28http://docs.mongodb.org/manual/tutorial/calculate-distances-using-spherical-geometry-with-2d-geospatial-indexes/" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">弧度计算</a>，未说明水平单位（度）计算。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">关于弧度计算，官方文档的说明是：</p>
<blockquote style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:156px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:156px;">To convert: distance to radians: divide the distance by the radius of the sphere (e.g. the Earth) in the same units as the distance measurement. radians to distance: multiply the radian measure by the radius of the sphere (e.g. the Earth) in the units system
 that you want to convert the distance to. <br style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"/>
<br style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"/>
The radius of the Earth is approximately 3,959 miles or 6,371 kilometers.</p>
</blockquote>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">所以如果用弧度查询，则以公里数除以6371，如“附近500米的餐厅”：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">&gt; db.runCommand( { geoNear: &quot;places&quot;, near: [ 121.4905, 31.2646 ], spherical: true,
 $maxDistance: 0.5/6371 })</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">那如果不用弧度，以水平单位（度）查询时，距离单位如何处理？</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">答案是以公里数除以111（推荐值），原因如下：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">经纬度的一度，分为经度一度和纬度一度。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">地球不同纬度之间的距离是一样的，地球子午线（南极到北极的连线）长度39940.67公里，纬度一度大约110.9公里</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">但是不同纬度的经度一度对应的长度是不一样的：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">在地球赤道，一圈大约为40075KM,除以360度，每一个经度大概是：40075/360=111.32KM</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">上海，大概在北纬31度，对应一个经度的长度是：40075*sin(90-31)/360=95.41KM</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">北京在北纬40度，对应的是85KM</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">前面提到的参数111，这个值只是估算，并不完全准确，任意两点之间的距离，平均纬度越大，这个参数则误差越大。详细原因可以参考wiki上的解释：<a href="http://en.wikipedia.org/wiki/Latitude" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://en.wikipedia.org/wiki/Latitude</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">但是，即便如此，“度”这个单位只用于平面，由于地球是圆的，在大范围使用时会有误差。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">官方建议使用sphere查询方式，也就是说距离单位用弧度。</p>
<blockquote style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:156px;">
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:628px;height:156px;">The current implementation assumes an idealized model of a flat earth, meaning that an arcdegree of latitude (y) and longitude (x) represent the same distance everywhere. This is only true at the equator where they are both about equal to 69 miles or 111km.
 However, at the 10gen offices at { x : -74 , y : 40.74 } one arcdegree of longitude is about 52 miles or 83 km (latitude is unchanged). This means that something 1 mile to the north would seem closer than something 1 mile to the east.</p>
</blockquote>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">$geoNear返回结果集中的dis，如果指定了spherical为true， dis的值为弧度，不指定则为度。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">指定 spherical为true,结果中的dis需要乘以6371换算为km:</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:806px;">&gt; db.runCommand( { geoNear: &quot;places&quot;, near: [ 121.4905, 31.2646 ], 
spherical: true, num:1 })
{
    &quot;ns&quot; : &quot;mongo_test.places&quot;,
    &quot;near&quot; : &quot;1110001100111100001011010110010111001000110011111101&quot;,
    &quot;results&quot; : [
        {
            &quot;dis&quot; : 0.00009318095248858048,
            &quot;obj&quot; : {
                &quot;_id&quot; : 115,
                &quot;coordinate&quot; : {
                    &quot;longitude&quot; : 121.4915,
                    &quot;latitude&quot; : 31.25933
                },
                &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，节假日通用，
精致生活，品质享受&quot;,
                &quot;address&quot; : &quot;虹口区天水路90号&quot;
            }
        }

    ],
    &quot;stats&quot; : {
        &quot;time&quot; : 0,
        &quot;btreelocs&quot; : 0,
        &quot;nscanned&quot; : 18,
        &quot;objectsLoaded&quot; : 12,
        &quot;avgDistance&quot; : 0.00009964377923093564,
        &quot;maxDistance&quot; : 0.0001064199324957278
    },
    &quot;ok&quot; : 1
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">不指定sphericial，结果中的dis需要乘以111换算为km:</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:780px;">&gt; db.runCommand( { geoNear: &quot;places&quot;, near: [ 121.4905, 31.2646 ], num:1 })
{
    &quot;ns&quot; : &quot;mongo_test.places&quot;,
    &quot;near&quot; : &quot;1110001100111100001011010110010111001000110011111101&quot;,
    &quot;results&quot; : [
        {
            &quot;dis&quot; : 0.005364037658335473,
            &quot;obj&quot; : {
                &quot;_id&quot; : 115,
                &quot;coordinate&quot; : {
                    &quot;longitude&quot; : 121.4915,
                    &quot;latitude&quot; : 31.25933
                },
                &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，节假日通用，
精致生活，品质享受&quot;,
                &quot;address&quot; : &quot;虹口区天水路90号&quot;
            }
        }   

    ],
    &quot;stats&quot; : {
        &quot;time&quot; : 0,
        &quot;btreelocs&quot; : 0,
        &quot;nscanned&quot; : 18,
        &quot;objectsLoaded&quot; : 12,
        &quot;avgDistance&quot; : 0.006150808243357531,
        &quot;maxDistance&quot; : 0.00695541352612983
    },
    &quot;ok&quot; : 1
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:78px;">说到这里读者是不是已经有点迷糊了？没关系，在开发中其实你并不需要去知道各种距离单位的历史和使用它的原因，我在此为你总结了一张表，大部分常用的函数和所使用的距离单位都已经被我整理了出来，你只需要参考表上所列的距离单位直接使用即可。</p>
<table style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:212px;">
<thead style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:32px;">
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<th style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">查询命令</th>
<th style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">距离单位</th>
<th style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;">说明</th>
</tr>
</thead>
<tbody style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:180px;">
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$near</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;"><a href="http://docs.mongodb.org/manual/reference/operator/near/" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">官方文档</a>上关于这一点是错的</td>
</tr>
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$nearSphere</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">弧度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;"> </td>
</tr>
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$center</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;"> </td>
</tr>
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$centerSphere</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">弧度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;"> </td>
</tr>
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$polygon</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;"> </td>
</tr>
<tr style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:446px;height:28px;">
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:94px;height:26px;">$geoNear</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:60px;height:26px;">度或弧度</td>
<td style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:278px;height:26px;">指定参数spherical为true则为弧度，否则为度</td>
</tr>
</tbody>
</table>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">如果坐标以GeoJSON格式，则单位都为米。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">当然如果你的操作比较复杂，或者希望知道更加详细的对照关系，也可以参考官方的这个更详细的对比表格：<a href="http://docs.mongodb.org/manual/reference/operator/query-geospatial/" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://docs.mongodb.org/manual/reference/operator/query-geospatial/</a></p>
<h3 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t27" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>单位自动换算</h3>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">如上面两个geoNear示例，结果中的dis，前文已经提过这是与目标点的距离，但是这个距离单位是跟查询单位一致的，需要二次计算，不太方便。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">而其实可以直接在查询时指定 <a href="http://docs.mongodb.org/manual/tutorial/calculate-distances-using-spherical-geometry-with-2d-geospatial-indexes/#distance-multiplier" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
distanceMultiplier</a> ，它会将这个参数乘以距离返回，如指定为6371，返回的就是公里数。</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:884px;">&gt; db.runCommand({ geoNear : &quot;places&quot;, near : [121.4905, 31.2646], spherical : true,
 maxDistance : 1/6371, distanceMultiplier: 6371})
{
    &quot;ns&quot; : &quot;mongo_test.places&quot;,
    &quot;near&quot; : &quot;1110001100111100001011010110010111001000110011111101&quot;,
    &quot;results&quot; : [
        {
            &quot;dis&quot; : 0.5936558483047463,
            &quot;obj&quot; : {
                &quot;_id&quot; : 115,
                &quot;coordinate&quot; : {
                    &quot;longitude&quot; : 121.4915,
                    &quot;latitude&quot; : 31.25933
                },
                &quot;title&quot; : &quot;仅售148元，市场价298元的星程上服假日酒店全日房一间入住一天，节假日通用，
精致生活，品质享受&quot;,
                &quot;address&quot; : &quot;虹口区天水路90号&quot;
            }
        },

        …
        …

    ],
    &quot;stats&quot; : {
        &quot;time&quot; : 0,
        &quot;btreelocs&quot; : 0,
        &quot;nscanned&quot; : 15,
        &quot;objectsLoaded&quot; : 9,
        &quot;avgDistance&quot; : 0.6348305174802911,
        &quot;maxDistance&quot; : 0.0001064199324957278
    },
    &quot;ok&quot; : 1
}</pre>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">注意上面的结果中dis的值，已经是km单位的了。</p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t28" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>结语</h2>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">通过前面的案例演示，相信大家对MongoDB的地理位置特性已经比较了解。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">MongoDB还有很多很酷的功能，地址位置支持仅是其中一项。希望以后能有机会为各位读者介绍如何结合Symfony2使用MongoDB进行应用开发的更多案例。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">文中的演示程序已经发布在了Github上，地址是<a href="https://github.com/henter/HenterGEO" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">https://github.com/henter/HenterGEO</a>，读者可以直接使用。</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;">参考：</p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://docs.mongodb.org/manual/" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://docs.mongodb.org/manual/</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="https://wiki.10gen.com/pages/viewpage.action?pageId=21268367&amp;navigatingVersions=true" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">https://wiki.10gen.com/pages/viewpage.action?pageId=21268367&amp;navigatingVersions=true</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://en.wikipedia.org/wiki/Radian" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://en.wikipedia.org/wiki/Radian</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://www.scribd.com/doc/2569355/Geo-Distance-Search-with-MySQL" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://www.scribd.com/doc/2569355/Geo-Distance-Search-with-MySQL</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://www.phpchina.com/resource/manual/mysql/spatial-extensions-in-mysql.html" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://www.phpchina.com/resource/manual/mysql/spatial-extensions-in-mysql.html</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://derickrethans.nl/spatial-indexes-mysql.html" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://derickrethans.nl/spatial-indexes-mysql.html</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://dev.mysql.com/doc/refman/5.6/en/spatial-extensions.html" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://dev.mysql.com/doc/refman/5.6/en/spatial-extensions.html</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;"><a href="http://dev.mysql.com/doc/refman/4.1/en/functions-that-test-spatial-relationships-between-geometries.html#function_distance" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://dev.mysql.com/doc/refman/4.1/en/functions-that-test-spatial-relationships-between-geometries.html#function_distance</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://blog.nosqlfan.com/html/1811.html" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://blog.nosqlfan.com/html/1811.html</a></p>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:26px;"><a href="http://en.wikipedia.org/wiki/Geohash" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://en.wikipedia.org/wiki/Geohash</a></p>
<h2 style="margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"><a name="t29" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></a>关于作者</h2>
<p style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:52px;">周攀，多年互联网从业经验，精通Symfony2框架，微博阅后即焚应用<a href="http://http//snap.henter.me/" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">SnapWeibo</a>的作者，斯诺克爱好者，养猫达人。读者可以通过他的微博
<a href="http://weibo.com/henter" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">@周攀Henter</a>或邮件（henter at henter dot me）与他取得联系。</p>
   
</div>









<div style="zoom:1;float:right;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:138px;height:28px;">
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="height:16px;color:rgb(51, 51, 51);background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=d754dcc0.png);background-position:0 0 !important;float:left;font-size:12px;padding-left:17px;line-height:16px;text-decoration:none;cursor:pointer;margin:6px 6px 6px 0px;background-repeat:no-repeat;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;"></a>
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="cursor:pointer;color:rgb(51, 102, 153);background-position:0 -52px !important;float:left;font-size:12px;padding-left:17px;line-height:16px;height:16px;text-decoration:none;margin:6px 6px 6px 0px;background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=ba7acbd3.png);background-repeat:no-repeat;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;" title="分享到QQ空间"></a>
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="cursor:pointer;color:rgb(51, 102, 153);background-position:0 -104px !important;float:left;font-size:12px;padding-left:17px;line-height:16px;height:16px;text-decoration:none;margin:6px 6px 6px 0px;background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=ba7acbd3.png);background-repeat:no-repeat;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;" title="分享到新浪微博"></a>
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="cursor:pointer;color:rgb(51, 102, 153);background-position:0 -260px !important;float:left;font-size:12px;padding-left:17px;line-height:16px;height:16px;text-decoration:none;margin:6px 6px 6px 0px;background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=ba7acbd3.png);background-repeat:no-repeat;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;" title="分享到腾讯微博"></a>
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="cursor:pointer;color:rgb(51, 102, 153);background-position:0 -208px !important;float:left;font-size:12px;padding-left:17px;line-height:16px;height:16px;text-decoration:none;margin:6px 6px 6px 0px;background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=ba7acbd3.png);background-repeat:no-repeat;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;" title="分享到人人网"></a>
<a href="http://blog.csdn.net/huangrunqing/article/details/9112227#" style="cursor:pointer;color:rgb(51, 102, 153);background-position:0 -1612px !important;float:left;font-size:12px;padding-left:17px;line-height:16px;height:16px;text-decoration:none;margin:6px 6px 6px 0px;background-image:url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=ba7acbd3.png);background-repeat:no-repeat;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;width:0px;" title="分享到微信"></a>
<span style="visibility:hidden;display:block;height:0px;clear:both;">.</span></div>



   

    








 

        <div style="text-align:center;display:block;width:182px;margin:0px auto;padding:30px 0px 15px;clear:both;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:72px;">
            <dl style="text-align:center;display:inline-block;width:72px;height:72px;overflow:hidden;margin:0px 2px;float:left;background:rgb(153, 153, 153);color:rgb(255, 255, 255);border:0px none rgb(255, 255, 255);background-color:rgb(153, 153, 153);background-image:none;box-shadow:none;">
               
                 <dt style="line-height:30px;margin:0px;color:rgb(255, 255, 255);font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:27px;padding:12px 0px 3px;font-family:'Microsoft YaHei';border:0px none rgb(255, 255, 255);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72px;height:30px;">顶</dt>
                <dd style="line-height:22px;margin:0px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;color:rgb(255, 255, 255);font-family:Arial;border:0px none rgb(255, 255, 255);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72px;height:22px;">1</dd>
            </dl>
           
              
            <dl style="text-align:center;display:inline-block;width:72px;height:72px;overflow:hidden;margin:0px 2px;float:left;background:rgb(153, 153, 153);color:rgb(255, 255, 255);border:0px none rgb(255, 255, 255);background-color:rgb(153, 153, 153);background-image:none;box-shadow:none;">
              
                  <dt style="line-height:30px;margin:0px;color:rgb(255, 255, 255);font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:27px;padding:12px 0px 3px;font-family:'Microsoft YaHei';border:0px none rgb(255, 255, 255);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72px;height:30px;">踩</dt>
                <dd style="line-height:22px;margin:0px;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;color:rgb(255, 255, 255);font-family:Arial;border:0px none rgb(255, 255, 255);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72px;height:22px;">0</dd>               
            </dl>
            
        <span style="text-align:center;display:block;height:0px;clear:both;visibility:hidden;">.</span></div>
     <div style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:14px;"><a href="#" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"> </a>   </div>
    <div style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:14px;"> <a href="#" style="color:rgb(51, 102, 153);text-decoration:none;border:0px none rgb(51, 102, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"> </a></div>
    

   <ul style="float:left;display:block;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:14px;line-height:24px;font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif;clear:both;color:rgb(102, 102, 102);margin:0px 0px 5px;padding:10px 0px 0px;margin-top:30px;border:0px none rgb(102, 102, 102);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:266.406px;height:58px;">
                <li style="list-style-type:none;clear:both;padding:0px 0px 3px;overflow:hidden;border:0px none rgb(102, 102, 102);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:266.406px;height:26px;"><span style="margin-right:7px;display:block;width:52px;padding:0px 0px 0px 27px;height:26px;color:rgb(255, 255, 255);font-size:14px;float:left;background-color:rgb(153, 153, 153);background-image:url(http://static.blog.csdn.net/skin/default/images/blog-page-arr.png);background-position:9px 8px;background-repeat:no-repeat;border:0px none rgb(255, 255, 255);box-shadow:none;">上一篇</span><a href="http://blog.csdn.net/huangrunqing/article/details/9002085" style="border:0px none rgb(51, 51, 51);color:rgb(51, 51, 51);display:block;float:left;font-size:14px;text-decoration:none;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:180.406px;height:24px;">Hadoop MapReduce数据流</a></li>
                <li style="list-style-type:none;clear:both;padding:0px 0px 3px;overflow:hidden;border:0px none rgb(102, 102, 102);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:266.406px;height:26px;"><span style="margin-right:7px;display:block;width:52px;padding:0px 0px 0px 27px;height:26px;color:rgb(255, 255, 255);font-size:14px;float:left;background-color:rgb(153, 153, 153);background-image:url(http://static.blog.csdn.net/skin/default/images/blog-page-arr.png);background-position:9px -22px;background-repeat:no-repeat;border:0px none rgb(255, 255, 255);box-shadow:none;">下一篇</span><a href="http://blog.csdn.net/huangrunqing/article/details/9986293" style="border:0px none rgb(51, 51, 51);color:rgb(51, 51, 51);display:block;float:left;font-size:14px;text-decoration:none;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:150.219px;height:24px;">内存溢出与jvm参数配置</a></li>
    <span style="color:rgb(102, 102, 102);font-style:normal;font-variant:normal;font-weight:normal;font-size:14px;line-height:24px;font-family:'Microsoft YaHei', Arial, Helvetica, sans-serif;display:block;height:0px;clear:both;visibility:hidden;">.</span></ul>

    <div style="clear:both;height:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;"></div>


        <div style="overflow:hidden;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;height:138px;">
                <h4 style="font-size:16px;color:rgb(51, 51, 51);margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:708px;">我的同类文章</h4>
                <div style="border:1px solid rgb(187, 187, 187);margin:20px 0px 0px 0px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:706px;height:97px;">
                    <div style="height:45px;line-height:45px;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:rgb(220, 220, 220);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:706px;">
                                <span style="border:0px none rgb(102, 102, 102);display:inline-block;font-size:16px;color:rgb(102, 102, 102);font-weight:bold;margin-left:25px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72.6563px;height:45px;">
                                    <span style="cursor:pointer;border:0px none rgb(102, 102, 102);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">web<em style="font-style:normal;border:0px none rgb(102, 102, 102);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">（2）</em></span>
                                </span>
                    </div>
                   
                    <div style="max-height:195px;overflow-y:auto;padding:10px 20px;background:rgb(252, 252, 252);border:0px none rgb(51, 51, 51);background-color:rgb(252, 252, 252);background-image:none;box-shadow:none;width:666px;height:31px;">
                        
                        <ul style="float:left;width:326.328px;list-style:none;margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:31px;"><li style="list-style:none;line-height:30px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:326.328px;height:31px;"><em style="font-style:normal;display:inline-block;vertical-align:middle;margin-right:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:4px;height:30px;">•</em><a href="http://blog.csdn.net/huangrunqing/article/details/8553247" style="overflow:hidden;color:rgb(51, 51, 51);display:inline-block;width:163.156px;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;vertical-align:middle;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:30px;" target="_blank" title="JTA 深度历险 – 原理与实现">JTA 深度历险 – 原理与实现</a><span style="font-size:12px;color:rgb(187, 187, 187);display:inline-block;margin-left:9px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:64px;height:30px;">2013-01-29</span><span style="font-size:12px;color:rgb(187, 187, 187);display:inline-block;margin-left:9px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:50px;height:30px;"><i style="font-weight:normal;font-style:normal;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">阅读</i><b style="font-weight:normal;font-style:normal;margin-left:5px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">244</b></span></li> </ul>

                        <ul style="float:right;width:326.328px;list-style:none;margin:0px;padding:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:31px;"><li style="list-style:none;line-height:30px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:326.328px;height:31px;"><em style="font-style:normal;display:inline-block;vertical-align:middle;margin-right:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:4px;height:30px;">•</em><a href="http://blog.csdn.net/huangrunqing/article/details/8552690" style="overflow:hidden;color:rgb(51, 51, 51);display:inline-block;width:163.156px;text-overflow:ellipsis;white-space:nowrap;text-decoration:none;vertical-align:middle;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:30px;" target="_blank" title="java实现简单的单点登录">java实现简单的单点登录</a><span style="font-size:12px;color:rgb(187, 187, 187);display:inline-block;margin-left:9px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:64px;height:30px;">2013-01-29</span><span style="font-size:12px;color:rgb(187, 187, 187);display:inline-block;margin-left:9px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:50px;height:30px;"><i style="font-weight:normal;font-style:normal;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">阅读</i><b style="font-weight:normal;font-style:normal;margin-left:5px;border:0px none rgb(187, 187, 187);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">129</b></span></li> </ul>
                    </div>
                </div>
            </div>    
    
      
</div></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 