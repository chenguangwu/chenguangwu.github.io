<html>
<head>
  <title>mongo aggregate聚合出现没有配置游标问题：The 'cursor' option is required - eleven的博客 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="11747"/>
<h1>mongo aggregate聚合出现没有配置游标问题：The 'cursor' option is required - eleven的博客 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/2/25 15:32</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://blog.csdn.net/LLF_1241352445/article/details/82084548"><i>https://blog.csdn.net/LLF_1241352445/article/details/82084548</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="box-sizing:border-box;outline:0px;"><div style="-webkit-font-smoothing:antialiased;min-width:1200px;background:url(&quot;https://csdnimg.cn/release/phoenix/themes/skin-yellow/images/bg.png&quot;) repeat;box-sizing:inherit;outline:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:14px;line-height:1.57143;color:rgb(51, 51, 51);background-color:rgb(245, 246, 247);"><div style="box-sizing:border-box;outline:0px;"><span style="box-sizing:inherit;outline:0px;"><div style="background:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.05) 0px 2px 4px 0px;box-sizing:inherit;outline:0px;">
	<div style="border-bottom:1px solid rgb(224, 224, 224);padding-top:16px;z-index:9;background-color:rgb(255, 255, 255);box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
		<div style="box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
			<div style="margin-bottom:8px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
				<span style="display:inline-block;margin-top:4px;width:26px;height:26px;line-height:26px;text-align:center;font-size:12px;border-radius:50%;color:rgb(202, 12, 22);border:1px solid rgb(244, 206, 208);margin-right:8px;box-sizing:inherit;outline:0px;float:left;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">原</span>				<h1 style="font-size:24px;overflow-wrap:break-word;box-sizing:inherit;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">mongo aggregate聚合出现没有配置游标问题：The 'cursor' option is required</h1>
			</div>
			<div style="padding-bottom:14px;position:relative;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
				<div style="color:rgb(133, 133, 133);width:88%;height:24px;overflow:hidden;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
																				<span style="margin-right:14px;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">2018年08月26日 21:53:57</span>
					<a href="https://me.csdn.net/LLF_1241352445" style="color:rgb(120, 165, 241);margin-right:14px;box-sizing:inherit;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">llf_1241352445</a>
						<span style="margin-right:14px;box-sizing:inherit;outline:0px;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;">阅读数：1606</span>
						
																															</div>
				<div style="position:absolute;top:0px;right:0px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
									</div>
			</div>
		</div>
	</div>
	<div style="position:relative;padding-top:16px;box-sizing:inherit;outline:0px;display:block;margin:0px;padding:0px;">
		<div style="overflow-wrap:break-word;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
								<div style="overflow-wrap:break-word;font-size:12px;color:rgb(153, 153, 153);margin-bottom:8px;box-sizing:inherit;outline:0px;padding:0px;margin:0px;">
                  					<span style="overflow-wrap:break-word;box-sizing:inherit;outline:0px;width:53px;height:18px;vertical-align:-4px;fill:currentcolor;overflow:hidden;transition:transform 0.1s ease-in-out 0s, fill 0.1s ease-in-out 0s, -webkit-transform 0.1s ease-in-out 0s;margin:0px;padding:0px;" title="CSDN认证原创">
							<span style="overflow-wrap:break-word;box-sizing:inherit;outline:0px;margin:0px;padding:0px;"></span>
					</span>
                  					
					版权声明：本文为博主原创文章，未经博主允许不得转载。					https://blog.csdn.net/LLF_1241352445/article/details/82084548				</div>
								            
						<div style="overflow-wrap:break-word;box-sizing:inherit;outline:0px;padding:0px;margin:0px;font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun;">
                <p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">有时一个月的时间没有写博客了，是最近比较忙，也是自己在学习的阶段，所以花在博客的时间就相对比较少了；最近一个月都是在学mongo的相关内容，包括mongo的map-reduce,聚合管道以及mongo的索引等技术点；今天写的文章内容就是我在学习聚合管道遇到的问题；</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">mongo聚合的java实现，mongo API提供两种的实现方式：</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0px;">          1.基于mongotemplate提供的聚合接口：aggregate（arg1,arg2....）等不同参数的方法，读者可以按需调用；特点是该API封装了mongo底层的聚合操作符，比如$match，$project等，暴露出来的对应为project()、match()等接口；所以这种方法更适合初学者使用；使用该接口不会出现我们标题说的那个错误；</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0px;">          2.基于比较底层提供的DBCollection提供的aggregate接口（arg1,arg2....）；该方法要求对mongo的nosql比较熟悉，因为该接口入参是DBObject，所以需要我们自己写mongo的聚合操作符：$match等操作符，所以要求比较高；和我们这里相关脸的问题是，该接口内部调用mongo底层的数据默认的输出格式是INLINE，所以会出现我们标题的那个错误；后面会分析；</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">Java端实现聚合的时候，通过上面第二种实现方式的时候，出现了标题的那个错误：The 'cursor' option is required, except for aggregate with the explain argument，刚开始遇到这个问题的时候，去查找网上的资料，发现网上国内的资料非常的少，而且内容也大都相似，都是说修改spring-data-mongo的jar包版本，或者修改mongo的驱动版本：mongo-java-dirver版本，但是我都尝试过了，还是解决不了我的问题；但是有查到用的信息是说这个错误是mongo服务升级到3.5以上之后，要求的聚合的时候要配置cursor的，顺着这可能的原因，我就尝试着跟踪源码，看能不能解决我的问题，  终于，最后在源码出找到了解决办法；经过最终的排错，确定是我的mongo server服务已经为3.6.3了；如果你的mongo服务还是3.5以下，或许就不会出现这个问题了，所以先确认你的mongo服务是不是3.5以上的；然后<a href="https://www.baidu.com/s?wd=%E6%9C%80%E7%BB%88%E8%A7%A3%E5%86%B3&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" style="overflow-wrap:break-word;color:rgb(78, 161, 219);box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">最终解决</a>的办法是调用DBCollection的聚合接口中有包含有聚合配置的参数：AggregationOptions的接口，然后配置AggregationOptions的outputModel为CURSOR就可以解决这个问题了；代码如下：</p>

<pre style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:8px;margin:0px 0px 24px;position:relative;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;overflow-x:auto;font-size:14px;line-height:22px;color:rgb(0, 0, 0);"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;border-radius:4px;display:block;line-height:22px;overflow-x:auto;white-space:pre;font-size:14px;background:rgb(40, 42, 54);color:rgb(248, 248, 242);"><ol style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;list-style:none;border-collapse:collapse;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;overflow:hidden;width:1059px;"><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">1</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">List<span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">&lt;<span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;color:rgb(241, 250, 140);font-weight:bold;">DBObject</span>&gt;</span> pipeline = new ArrayList<span style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">&lt;&gt;</span>(); </div></div></li><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">2</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">pipeline.add(xxx)//聚合条件省略，笔者自己添加聚合条件</div></div></li><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">3</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">AggregationOptions <a href="https://www.baidu.com/s?wd=build&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" style="overflow-wrap:break-word;color:rgb(78, 161, 219);box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">build</a> = AggregationOptions.builder()</div></div></li><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">4</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">                .outputMode(AggregationOptions.OutputMode.CURSOR)//指定聚合的输出格式为CURSOR</div></div></li><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">5</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">                .build();</div></div></li><li style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;list-style-type:none;margin-left:0px;margin-top:0px;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;float:left;height:22px;width:24px;border-right:1px solid rgb(197, 197, 197);"><div style="overflow-wrap:normal;box-sizing:border-box;outline:0px;padding:0px;margin:0px;text-align:right;padding-right:8px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;"><span style="text-align:right;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">6</span></div></div><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;margin-left:8px;float:left;height:22px;"><div style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;, Menlo, Monaco, Consolas, Inconsolata, Courier, monospace, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, sans-serif;font-size:14px;">        Cursor aggregate = orderDao.getMt().getCollection(Order.class.getSimpleName().toLowerCase()).aggregate(pipeline, build);</div></div></li></ol></code></pre>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;"><code style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;margin:0px;padding:0px;font-family:&quot;Source Code Pro&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Anonymous Pro&quot;, &quot;Droid Sans Mono&quot;;border-radius:4px;">源码分析如下：</code></p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">步骤1：最开始我调用的接口是只有一个参数的接口：</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0;"><img src="mongo aggregate聚合出现没有配置游标问题：The 'cursor' opti_files/70.png" type="image/png" data-filename="70.png" alt="" height="289" style="overflow-wrap:break-word;cursor:zoom-in;box-sizing:border-box;outline:0px;margin:0px;padding:0px;max-width:100%;" width="967"/></p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">步骤2，紧跟着下一步：</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0;"><img src="mongo aggregate聚合出现没有配置游标问题：The 'cursor' opti_files/70 [1].png" type="image/png" data-filename="70.png" alt="" height="511" style="overflow-wrap:break-word;cursor:zoom-in;box-sizing:border-box;outline:0px;margin:0px;padding:0px;max-width:100%;" width="1200"/></p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">步骤3，下一步，查看commang的生成源码：</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0;"><img src="mongo aggregate聚合出现没有配置游标问题：The 'cursor' opti_files/70 [2].png" type="image/png" data-filename="70.png" alt="" height="722" style="overflow-wrap:break-word;cursor:zoom-in;box-sizing:border-box;outline:0px;margin:0px;padding:0px;max-width:100%;" width="1200"/></p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">从步骤3就可以看出我们这个问题根源了：mongo服务3.5以上要求聚合的时候要配置游标大小，就是每次获取的数据大小；而如果调用步骤1所示的只有聚合管道参数的接口的话，那么在步骤2的就已经内部写死了outputMode为INLINE，所以如果mongo服务已经升级到3.5之后的话，就不能调用步骤一的接口；所以就是查找是否有提供可以配置AggregationOptions的接口；所以，查找后有相关的接口如下：</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:0;"><img src="mongo aggregate聚合出现没有配置游标问题：The 'cursor' opti_files/70 [3].png" type="image/png" data-filename="70.png" alt="" height="342" style="overflow-wrap:break-word;cursor:zoom-in;box-sizing:border-box;outline:0px;margin:0px;padding:0px;max-width:100%;" width="1200"/></p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">所以最终的解决办法就是文章开头提到的，配置options的outputMode为CURSOR即可解决问题；</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">返回的数据接口是Cursor对象，该对象是Iterator的子类，所以获取的方法就是通过迭代器获取；</p>

<p style="overflow-wrap:break-word;box-sizing:border-box;outline:0px;padding:0px;margin:0px 0px 16px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;font-size:16px;color:rgb(79, 79, 79);font-weight:400;line-height:26px;overflow-x:auto;text-indent:50px;">因为发现国内这个问题相关的文章还是<a href="https://www.baidu.com/s?wd=%E5%AF%A5%E5%AF%A5%E6%97%A0%E5%87%A0&amp;tn=24004469_oem_dg&amp;rsv_dl=gh_pl_sl_csd" style="overflow-wrap:break-word;color:rgb(78, 161, 219);box-sizing:border-box;outline:0px;text-decoration:none;cursor:pointer;margin:0px;padding:0px;font-family:&quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif;" target="_blank">寥寥无几</a>，所以特意花时间写下这篇文章和读者分享，希望这篇文章可以解决读者遇到的问题；</p>            </div>
                <span style="display:block;height:0px;visibility:hidden;clear:both;"></span></div>
	</div>
</div></span></div></div></div></div><br/></div></span>
</div></body></html> 