<html>
<head>
  <title>MongoDB的GeoSpatial索引 之 GeoNear命令，取得距离 - 推酷</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="9601"/>
<h1>MongoDB的GeoSpatial索引 之 GeoNear命令，取得距离 - 推酷</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2016/7/7 9:17</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.tuicool.com/articles/MVrqAn"><i>http://www.tuicool.com/articles/MVrqAn</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px"><div style="font-size:14px;background-color:rgb(244, 246, 248);"><div style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-size:1em;line-height:1.5em;color:rgb(51, 51, 51);background-color:rgb(244, 246, 248);box-shadow:none;"><div><div><div style="box-sizing:border-box;background-color:rgb(254, 254, 254);box-shadow:rgba(0, 0, 0, 0.0980392) 0px 4px 10px 0px;background:white;border:0px none rgb(51, 51, 51);background-image:none;width:646.375px;height:3171.56px;">
        <h1 style="margin-bottom:5px;margin:0px 0px 0.5em;font-weight:normal;line-height:1.5em;color:inherit;text-rendering:optimizeLegibility;font-size:24px;font-family:inherit;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;">MongoDB的GeoSpatial索引 之 GeoNear命令，取得距离</h1>
        <div style="border:;color:rgb(153, 153, 153);border-bottom-width:1px;border-bottom-style:dashed;border-bottom-color:rgb(211, 211, 211);font-size:14px;padding-bottom:5px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:74px;">
            <div style="margin-bottom:5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:21px;">
            <span style="margin-right:5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">时间 2012-06-03 01:22:25
            </span>
            <span style="margin-right:5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
                <i style="vertical-align:baseline;font-family:FontAwesome;font-style:normal;text-decoration:inherit;-webkit-font-smoothing:antialiased;display:inline;width:auto;height:auto;line-height:normal;font-weight:normal;margin-top:0px;background-image:none;background-position:0px 0px;background-repeat:repeat;margin-right:0px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);box-shadow:none;"><span style="font-family:FontAwesome;font-weight:normal;font-style:normal;line-height:normal;text-decoration:inherit;display:inline-block;speak:none;"></span></i>
                    <a href="http://www.tuicool.com/sites/7VJryu" style="word-break:keep-all;color:rgb(51, 51, 51);transition:0.25s;outline:none 0px;display:inline;overflow:hidden;white-space:nowrap;text-decoration:none;text-overflow:ellipsis;max-width:28%;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank">Shareach
                    </a>
            </span>
            </div>
            <div style="border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:27px;">
                <i style="font-style:normal;float:left;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:28px;height:21px;">原文</i>  
                <a href="http://www.shareach.com/?p=139&amp;utm_source=tuicool&amp;utm_medium=referral" style="max-width:69%;color:rgb(51, 51, 51);transition:0.25s;outline:none 0px;overflow:hidden;white-space:nowrap;word-break:keep-all;text-overflow:ellipsis;text-decoration:none;display:inline-block;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:212px;height:21px;">http://www.shareach.com/?p=139</a>
            </div>
            <div style="border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:21px;">
                <span style="margin-right:5px;border:0px none rgb(153, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">主题</span>
                <a href="http://www.tuicool.com/topics/11030033" style="color:rgb(51, 51, 51);text-decoration:none;transition:0.25s;outline:none 0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank">
                    <span style="text-decoration:none;display:inline-block;font-size:0.9em;line-height:16px;vertical-align:baseline;white-space:nowrap;color:rgb(120, 120, 120);padding:2px 4px;background-color:rgb(242, 242, 242);margin-right:5px;border:0px none rgb(120, 120, 120);background-image:none;box-shadow:none;width:55px;height:16px;">MongoDB</span>
                </a>
                <a href="http://www.tuicool.com/topics/11000074" style="color:rgb(51, 51, 51);text-decoration:none;transition:0.25s;outline:none 0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank">
                    <span style="text-decoration:none;display:inline-block;font-size:0.9em;line-height:16px;vertical-align:baseline;white-space:nowrap;color:rgb(120, 120, 120);padding:2px 4px;background-color:rgb(242, 242, 242);margin-right:5px;border:0px none rgb(120, 120, 120);background-image:none;box-shadow:none;width:46px;height:16px;">Java EE</span>
                </a>
            </div>
        </div>
        <div style="line-height:1.7em;padding:20px 5px 25px;overflow-x:hidden;word-wrap:break-word;word-break:break-word;min-height:340px;font-size:16px;margin-bottom:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:2011.56px;">
            <div style="font-size:16px;line-height:1.7em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:1999.56px;">
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">
    前面简单的写下了Find方式基于索引的检索，见《
    <a href="http://www.shareach.com/?p=136" style="border-bottom-color:rgb(148, 148, 148);color:rgb(148, 148, 148);transition:0.25s;outline:none 0px;border-bottom-width:1px;border-bottom-style:dashed;text-decoration:none;font-style:italic;font-weight:bold;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">MongoDB的GeoSpatial索引</a>
    》好久没把这个补充完整，刚写完这边整体的检索代码，趁热打铁，写完这篇。
  </p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:81px;">Find查询，仅仅能根据2d坐标按距离排序的POI点，查询出列表以后还得自己计算距离，实际开发的同学肯定会思考这点，既然有了排序功能那么肯定有拿到距离的数据了。</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;">参考这两个视频，蛮好的，英语比较不好，听了好多遍看着文档，弄明白了：</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">
    <a href="http://www.10gen.com/presentations/mongosf-2011/geospatial-indexing-mongodb" style="border-bottom-color:rgb(148, 148, 148);color:rgb(148, 148, 148);transition:0.25s;outline:none 0px;border-bottom-width:1px;border-bottom-style:dashed;text-decoration:none;font-style:italic;font-weight:bold;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://www.10gen.com/presentations/mongosf-2011/geospatial-indexing-mongodb</a>
  </p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;">
    <a href="http://www.10gen.com/presentations/mongosf2011/wordsquared" style="border-bottom-color:rgb(148, 148, 148);color:rgb(148, 148, 148);transition:0.25s;outline:none 0px;border-bottom-width:1px;border-bottom-style:dashed;text-decoration:none;font-style:italic;font-weight:bold;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">http://www.10gen.com/presentations/mongosf2011/wordsquared</a>
  </p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">GeoNear命令，是基于db的command，而不是基于collection的find，也就是需要通过runcommand执行，具体语法如下：</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">
    <em style="font-style:italic;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
      <span style="text-decoration:underline;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">db.runCommand({ geoNear : “collectionName” , near : [120.123456,30.654321], num : 10 } )</span>
    </em>
  </p>
  <pre style="word-wrap:break-word;padding:0.25em;color:rgb(51, 51, 51);border-radius:4px;display:block;margin:0px 0px 0.75em;font-size:1em;line-height:1.5em;word-break:break-all;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;white-space:pre-wrap;border:1px solid rgba(0, 0, 0, 0.14902);background-color:rgb(246, 246, 246);overflow-y:auto;margin-bottom:1.5em;background-image:none;box-shadow:none;width:597.188px;height:18px;">解释下这个命令：就是查询geoNear的collection中，距离near指定点最近的10条记录，简单吧？结果如下：</pre>
  <pre style="word-wrap:break-word;padding:0.25em;color:rgb(51, 51, 51);border-radius:4px;display:block;margin:0px 0px 0.75em;font-size:1em;line-height:1.5em;word-break:break-all;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;white-space:pre-wrap;border:1px solid rgba(0, 0, 0, 0.14902);background-color:rgb(246, 246, 246);overflow-y:auto;margin-bottom:1.5em;background-image:none;box-shadow:none;width:597.188px;height:871.188px;"><span style="color:#808080;border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><code style="display:block;padding:0px;width:590px;border-radius:3px;border:0px none rgb(51, 51, 51);white-space:normal;background-color:rgb(246, 246, 246);font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;overflow-y:auto;font-size:12px;background-image:none;box-shadow:none;color:rgb(51, 51, 51);height:846px;">{
    &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">ns</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(221, 17, 68);border:0px none rgb(221, 17, 68);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">&quot;poi.collectionName&quot;</span></span>,
     &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">near</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(221, 17, 68);border:0px none rgb(221, 17, 68);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">&quot;1100110000001111110000001111110000001111110000001111&quot;</span></span>,
    &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">results</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">[
    {
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">dis</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">0.29646421910687</span></span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">obj</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">{
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">_id</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">92</span></span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">y</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">[
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">120.123456</span>,
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">30.654321</span>
       ]</span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">category</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(221, 17, 68);border:0px none rgb(221, 17, 68);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">&quot;Coffee&quot;</span>
    }</span>
    }</span>,
    {
    &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">dis</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1.21645345345</span></span>,
    &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">obj</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">{
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">_id</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">54</span></span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">y</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">[
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">120.123456</span>,
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">30.654321</span>
       ]
    }</span>
    }</span>,
    {
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">dis</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1.31645345345</span></span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">obj</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">{
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">_id</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">33</span></span>,
       &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">y</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">[
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">120.123456</span>,
          <span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">30.654321</span>
       ]
    }</span>
 }</span>
 ]</span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">stats</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">{
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">time</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">0</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">btreelocs</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">btreelocs</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">nscanned</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">3</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">nscanned</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">3</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">objectsLoaded</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">3</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">objectsLoaded</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">3</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">avgDistance</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1.29646421910687</span>
 }</span></span>,
 &quot;<span style="color:rgb(0, 128, 128);border:0px none rgb(0, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">ok</span>&quot; : <span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:rgb(0, 153, 153);border:0px none rgb(0, 153, 153);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">1</span>
</span></code><span style="border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"></span></span><span style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"><span style="color:#808080;border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">}</span></span><span style="color:#808080;border:0px none rgb(128, 128, 128);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"> </span></pre>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;"> </p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:81px;">这个结果是根据距离排序有距离的记录，但是距离是经纬度的差值，MongoDB 1.8以后提供了Spherical Model，用distanceMultiplier指定地球半径来得到实际的公里或者米的距离，记得加上spherical:true，命令变为：</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">db.runCommand({ geoNear : “collectionName” , near : [120.123456,30.654321], distanceMultiplier: 6378137, num : 10, spherical:true } )</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;">那么查出的结果中距离就是实际的米</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:81px;">
    <span style="color:red;border:0px none rgb(255, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
      【注】我开始用百度坐标，不准，因为国内的地图坐标系都是经过偏移过的，后来采用google map地图的坐标，算出来的距离和google api中提供的距离结果只相差1~2米。
      <br style="border:0px none rgb(255, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;"/>
    </span>
  </p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:81px;">这个num参数是取得记录数目，适合做列表翻页用，但是地图上我们很难说只取多少个点，而是取多大屏幕范围，那么maxDistance参数正好适合,也就是多少范围的；我上面采用的地球半径是米，那么这里查询我统一采用米来计算，命令变为：</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">db.runCommand({ geoNear : “collectionName” , near : [120.123456,30.654321], distanceMultiplier: 6378137, maxDistance:2500/6378137 ,spherical:true} )</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;">也就是查询2500米范围内的poi；</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:27px;">其他参数还有个Query，用于联合查询，如：</p>
  <p style="margin:0px 0px 0.75em;font-size:16px;line-height:1.7em;text-indent:1em;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:606.375px;height:54px;">db.runCommand({ geoNear : “collectionName” , near : [120.123456,30.654321], distanceMultiplier: 6378137, num : 10, spherical:true , query:{Name:”肯德基”}} )</p>
</div>

        </div>
        <div style="margin-bottom:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:247px;">
         <div style="width:70px;height:70px;margin:0px auto;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">
    <div style="vertical-align:middle;width:70px;border-radius:50%;outline:none 0px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);text-align:center;height:70px;border:1px solid rgb(222, 222, 222);background:url(http://static0.tuicool.com/images/social_share.png) 0px -80px no-repeat;background-color:rgba(0, 0, 0, 0);background-image:url(http://static0.tuicool.com/images/social_share.png);box-shadow:none;">  </div>

</div>
        
<div style="height:32px;margin-top:35px;margin-bottom:20px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;">
    <div style="float:left;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:156px;height:32px;">
        <span style="margin-left:15px;color:rgb(120, 120, 120);vertical-align:middle;font-size:14px;margin-right:5px;border:0px none rgb(120, 120, 120);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">分享</span>
        
        
        
    </div>
    <div style="float:right;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:135px;height:26px;">
        
        
    </div>
</div>



            <div style="display:inline-block;text-align:center;margin:0px auto;width:620px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:79px;"><span style="text-align:center;display:table;line-height:0;"></span>
                  <a href="http://blog.daocloud.io/jobs/?utm_source=tuicool&amp;utm_medium=banner&amp;utm_content=hiring&amp;utm_campaign=hirecampaign" style="color:rgb(51, 51, 51);text-decoration:none;transition:0.25s;outline:none 0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank"><img height="80" src="http://static1.tuicool.com/images/ad/daocloud700.jpg" style="max-width:100%;height:79.7031px;vertical-align:middle;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:620px;" width="620"></img></a>

            <span style="text-align:center;display:block;line-height:0;clear:both;height:0px;visibility:hidden;">.</span></div>
        </div>
        <div style="clear:both;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:213px;">
              <div style="margin-right:6px;border-bottom-width:1px;border-bottom-color:rgb(227, 227, 227);color:rgb(0, 0, 0);font-size:18px;padding-bottom:5px;font-weight:bold;margin-left:6px;border-bottom-style:solid;padding-left:5px;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:599.375px;height:21px;">
                <span style="text-decoration:none;display:inline-block;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:73.4531px;height:21px;">推荐文章</span>
              </div>
          <ul style="padding:0px;margin:0px 0px 0.75em 25px;list-style-type:none;margin-left:5px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:186px;">
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    1.<a href="http://www.tuicool.com/articles/NVrAv26" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="MongoDB推出了新型DaaS解决方案“Altas”,提供数据库托管服务">
                    MongoDB推出了新型DaaS解决方案“Altas”,提供数据库托管服务
                    </a>
                </li>
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    2.<a href="http://www.tuicool.com/articles/BveEZvF" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="MongoDB和数据流：实现一个MongoDB Kafka消费者">
                    MongoDB和数据流：实现一个MongoDB Kafka消费者
                    </a>
                </li>
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    3.<a href="http://www.tuicool.com/articles/ayUfEjr" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="缓存穿透、并发和失效、同步中断，最佳实践及优化方案">
                    缓存穿透、并发和失效、同步中断，最佳实践及优化方案
                    </a>
                </li>
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    4.<a href="http://www.tuicool.com/articles/77ZNjez" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="Redis 指南">
                    Redis 指南
                    </a>
                </li>
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    5.<a href="http://www.tuicool.com/articles/QFzYV32" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="深度：微软全球规模分布式数据库NoSQL">
                    深度：微软全球规模分布式数据库NoSQL
                    </a>
                </li>
                <li style="border-bottom-style:dashed;line-height:1.5em;padding-top:4px;padding-bottom:4px;font-size:14px;padding-left:0px;border-bottom-width:1px;list-style-type:none;border-bottom-color:rgb(204, 204, 204);border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:22px;">
                    6.<a href="http://www.tuicool.com/articles/22uQJf6" style="color:rgb(22, 160, 133);text-decoration:none;transition:0.25s;outline:none 0px;font-size:1.1em;border:0px none rgb(22, 160, 133);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" target="_blank" title="snowflake——Twitter 开源的分布式自增 ID 算法">
                    snowflake——Twitter 开源的分布式自增 ID 算法
                    </a>
                </li>
          </ul>
        </div>
        <div style="padding-left:5px;margin-bottom:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;height:226px;"> <div style="margin-right:6px;border-bottom-width:1px;border-bottom-color:rgb(227, 227, 227);color:rgb(0, 0, 0);font-size:18px;padding-bottom:5px;font-weight:bold;margin-left:6px;border-bottom-style:solid;padding-left:5px;border:;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:594.375px;height:21px;"> <span style="text-decoration:none;display:inline-block;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:73.4531px;height:21px;">相关推刊</span></div><ul style="padding:0px;margin:20px auto 0px;list-style-type:none;width:606.375px;padding-top:3px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:0px;">          <li style="float:left;line-height:1.5em;width:166px;height:170px;padding:4px 4px 0px;background:rgb(242, 242, 242);list-style-type:none;margin:5px;border:1px solid rgb(221, 221, 221);background-color:rgb(247, 247, 247);background-image:none;box-shadow:none;">            <a href="http://www.tuicool.com/kans/819248408" style="display:block;color:rgb(0, 0, 0);transition:0.25s;outline:none 0px;position:relative;text-align:center;text-decoration:none;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:166px;height:150px;" target="_blank">              <small style="color:rgb(255, 255, 255);font-size:85%;position:absolute;bottom:0px;width:166px;text-align:center;display:block;background:rgba(92, 92, 92, 0.8);border:0px none rgb(255, 255, 255);background-color:rgba(92, 92, 92, 0.8);background-image:none;box-shadow:none;height:21px;">刊主：wallace5303</small>              <img src="MongoDB的GeoSpatial索引 之 GeoNear命令，取得距离 - 推酷_files/default_kan_cover.png" type="image/png" data-filename="default_kan_cover.png" height="150" style="max-width:100%;height:150px;vertical-align:middle;border:0px none rgb(0, 0, 0);width:165px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" width="165"/>            </a>            <span style="display:block;width:166px;margin-top:10px;font-size:14px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:27px;">              <a href="http://www.tuicool.com/kans/819248408" style="text-overflow:ellipsis;color:rgb(0, 0, 0);transition:0.25s;outline:none 0px;max-width:140px;overflow:hidden;white-space:nowrap;word-break:keep-all;text-decoration:none;margin-left:5px;display:inline-block;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:72px;height:21px;" target="_blank">《mongo》</a>              <i style="border:0px none rgb(153, 153, 153);font-style:normal;margin-right:5px;font-weight:bold;color:rgb(153, 153, 153);float:right;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:8px;height:21px;">1</i>            </span>          </li>                  <li style="float:left;line-height:1.5em;width:166px;height:170px;padding:4px 4px 0px;background:rgb(242, 242, 242);list-style-type:none;margin:5px;border:1px solid rgb(221, 221, 221);background-color:rgb(247, 247, 247);background-image:none;box-shadow:none;">            <a href="http://www.tuicool.com/kans/2079233483" style="display:block;color:rgb(0, 0, 0);transition:0.25s;outline:none 0px;position:relative;text-align:center;text-decoration:none;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:166px;height:150px;" target="_blank">              <small style="color:rgb(255, 255, 255);font-size:85%;position:absolute;bottom:0px;width:166px;text-align:center;display:block;background:rgba(92, 92, 92, 0.8);border:0px none rgb(255, 255, 255);background-color:rgba(92, 92, 92, 0.8);background-image:none;box-shadow:none;height:21px;">刊主：eetuuuu</small>              <img src="MongoDB的GeoSpatial索引 之 GeoNear命令，取得距离 - 推酷_files/neYjYfE.png!kan.png" type="image/png" data-filename="neYjYfE.png!kan.png" height="150" style="max-width:100%;height:150px;vertical-align:middle;border:0px none rgb(0, 0, 0);width:165px;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;" width="165"/>            </a>            <span style="display:block;width:166px;margin-top:10px;font-size:14px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:27px;">              <a href="http://www.tuicool.com/kans/2079233483" style="text-overflow:ellipsis;color:rgb(0, 0, 0);transition:0.25s;outline:none 0px;max-width:140px;overflow:hidden;white-space:nowrap;word-break:keep-all;text-decoration:none;margin-left:5px;display:inline-block;border:0px none rgb(0, 0, 0);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:140px;height:21px;" target="_blank">《MongoDB 3.0 用户创建1》</a>              <i style="border:0px none rgb(153, 153, 153);font-style:normal;margin-right:5px;font-weight:bold;color:rgb(153, 153, 153);float:right;background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:8px;height:21px;">4</i>            </span>          </li>        </ul><i style="font-style:normal;display:block;clear:both;height:0px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:611.375px;"><span style="font-style:normal;display:table;line-height:0;"></span><span style="font-style:normal;display:block;line-height:0;clear:both;height:0px;visibility:hidden;">.</span></i></div>
        
        <div style="float:left;width:616.375px;padding-top:20px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;height:192.5px;">
    <div style="border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:616.375px;height:192.5px;">
    <div style="padding:10px;background:rgb(241, 241, 241);border:0px none rgb(51, 51, 51);background-color:rgb(241, 241, 241);background-image:none;box-shadow:none;width:596.375px;height:172.5px;">
        <h5 style="margin-left:10px;margin:0px 0px 0.5em;font-weight:bold;line-height:1.5em;color:inherit;text-rendering:optimizeLegibility;font-size:18px;font-family:inherit;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:586.375px;">我来评几句</h5>
        
            
            <span style="border-style:solid;display:inline-block;margin-bottom:0px;font-size:14px;line-height:20px;color:rgb(102, 102, 102);text-align:center;text-shadow:rgba(255, 255, 255, 0.74902) 0px 1px 1px;vertical-align:top;cursor:pointer;border-width:1px;padding:5px 10px;border-color:rgb(204, 204, 204);width:70px;box-shadow:rgba(255, 255, 255, 0.2) 0px 1px 0px 0px inset, rgba(0, 0, 0, 0.0470588) 0px 1px 2px 0px;outline:none 0px;background:rgb(255, 255, 255);float:right;border:1px solid rgb(204, 204, 204);background-color:rgb(255, 255, 255);background-image:none;border-radius:0px;height:20px;">登录后评论</span>
        <p style="margin:0px 0px 0.75em;margin-top:5px;margin-left:10px;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;width:586.375px;height:21px;">
            已发表评论数(<span style="font-weight:bold;border:0px none rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0);background-image:none;box-shadow:none;">0</span>)
        </p>
    </div>
    
    
    
    </div>
</div>

    </div></div></div></div></div></div><br/></div></span>
</div></body></html> 