<html>
<head>
  <title>jvm系列(十):教你如何成为Java的OOM Killer</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="11360"/>
<h1>jvm系列(十):教你如何成为Java的OOM Killer</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/4/20 10:39</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&mid=2247484071&idx=1&sn=84604a51fd18b91f73c46507c182540a&chksm=ebf6dad8dc8153cebb029372c0745a3c6570e527e1f95cee2fb9fb33c50d46c64f20722a3d96&scene=21#wechat_redirect"><i>http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&amp;mid=2247484071&amp;idx=1&amp;sn=84604a51fd18b91f73c46507c182540a&amp;chksm=ebf6dad8dc8153cebb029372c0745a3c6570e527e1f95cee2fb9fb33c50d46c64f20722a3d96&amp;scene=21#wechat_redirect</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%; position: relative;"><div style="text-size-adjust:100%;line-height:1.6;"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;line-height:inherit;background-color:rgb(255, 255, 255);"><div><div style="background-color:rgb(255, 255, 255);font-size:16px;word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div>
                
                <h2 style="margin:0px;padding:0px;font-weight:400;font-size:24px;margin-bottom:14px;line-height:1.4;padding-bottom:10px;border-bottom:1px solid rgb(231, 231, 235);">
                    jvm系列(十):教你如何成为Java的OOM Killer                                    </h2>
                <div style="margin:0px;padding:0px;margin-bottom:18px;line-height:20px;font-size:0px;position:relative;z-index:1;">
                                                            <em style="margin:0px;padding:0px;display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;color:rgb(140, 140, 140);max-width:none;font-style:normal;">2017-10-17</em>

                                        <em style="margin:0px;padding:0px;display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;color:rgb(140, 140, 140);max-width:none;font-style:normal;">李艳鹏</em>
                                        <a href="http://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&amp;mid=2247484071&amp;idx=1&amp;sn=84604a51fd18b91f73c46507c182540a&amp;chksm=ebf6dad8dc8153cebb029372c0745a3c6570e527e1f95cee2fb9fb33c50d46c64f20722a3d96&amp;scene=21##" style="margin:0px;padding:0px;color:rgb(96, 127, 166);text-decoration:none;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;max-width:none;display:inline-block;">纯洁的微笑</a>
                    


                    
                </div>
                                
                
                
                
                                                
                                                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(62, 62, 62);min-height:350px;position:relative;">
                    

                    

                    
                    
                    <blockquote style="padding:0px;margin:0px;padding-left:10px;border-left:3px solid rgb(219, 219, 219);max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;">此文出处云时代架构，作者：李艳鹏 </p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwNTQ4MTQ4NQ==&amp;mid=2453559994&amp;idx=1&amp;sn=4859ab4b755890515921e9d5bbeca597&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:rgb(96, 127, 166);text-decoration:none;max-width:100%;box-sizing:border-box;word-wrap:break-word;" target="_blank">教你如何成为Java的OOM Killer</a></p></blockquote><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"> </span></p><p style="margin:0px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1.4em;font-weight:bold;">前言</span></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">虽然事隔半年，当时排查线上OOM事故的过程记忆犹新，每一个步骤都历历在目，感谢业务组、系统部、压测组、监控与应急部对架构组的强力支持，得以让这个Java内存问题水落石出，经过半年多的全面的应用日志 切割方式的改造，现在基本没有OOM的问题了，线上服务运行非常健康，对可用性的保障起到了很大的作用，如果你在经历OOM，读了这个文章会有很大的启发。</p><h2 style="font-weight:bold;font-size:1.4em;margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.3em;margin-bottom:1em;border-bottom:1px solid rgb(238, 238, 238);">Become OOM Killer</h2><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">我们都知道JVM的内存管理是自动化的，Java语言的程序指针也不需要开发人员手工释放，JVM的GC会自动的进行回收，但是，如果编程不当，JVM仍然会发生内存泄露，导致Java程序产生了OutOfMemoryError（OOM）错误。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">产生OutOfMemoryError错误的原因包括：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.lang.OutOfMemoryError: Java heap space</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.lang.OutOfMemoryError: PermGen space及其解决方法</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.lang.OutOfMemoryError: unable to create new native thread</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.lang.OutOfMemoryError：GC overhead limit exceeded</p></li></ol></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第1种异常，表示Java堆空间不够，当应用程序申请更多的内存，而Java堆内存已经无法满足应用程序对内存的需要，将抛出这种异常。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第2种异常，表示Java永久带（方法区）空间不够，永久带用于存放类的字节码和长常量池，类的字节码加载后存放在这个区域，这和存放对象实例的堆区是不同的，大多数JVM的实现都不会对永久带进行垃圾回收，因此，只要类加载的过多就会出现这个问题。一般的应用程序都不会产生这个错误，然而，对于Web服务器来讲，会产生有大量的JSP，JSP在运行时被动态的编译成Java Servlet类，然后加载到方法区，因此，太多的JSP的Web工程可能产生这个异常。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第3种异常，本质原因是创建了太多的线程，而能创建的线程数是有限制的，导致了这种异常的发生。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第4种异常，是在并行或者并发回收器在GC回收时间过长、超过98%的时间用来做GC并且回收了不到2%的堆内存，然后抛出这种异常进行提前预警，用来避免内存过小造成应用不能正常工作。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">下面两个异常与OOM有关系，但是，又没有绝对关系。</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.lang.StackOverflowError …</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">java.net.SocketException: Too many open files</p></li></ol></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第1种异常，是JVM的线程由于递归或者方法调用层次太多，占满了线程堆栈而导致的，线程堆栈默认大小为1M。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">对于第2种异常，是由于系统对文件句柄的使用是有限制的，而某个应用程序使用的文件句柄超过了这个限制，就会导致这个问题。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">上面介绍了OOM相关的基础知识，接下来我们开始讲述笔者经历的一次OOM问题的定位和解决的过程。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-style:italic;">1. 产生问题的现象</em></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">在某一段时间内，我们发现不同的业务服务开始偶发的报OOM的异常，有的时候是白天发生，有的时候是晚上发生，有的时候是基础服务A发生，有的时候是上层服务B发生，有的时候是上层服务C发生，有的时候是下层服务D发生，丝毫看不到一点规律。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">产生问题的异常如下：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">Caused by: java.lang.OutOfMemoryError: unable to create <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">new</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">native</span> thread at java.lang.Thread.start0(Native Method)
at java.lang.Thread.start(Thread.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">597</span>)
at java.util.Timer.&lt;init&gt;(Timer.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">154</span>)</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-style:italic;">2. 解决问题的思路和过程</em></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">经过细心观察发现，产生问题虽然在不同的时间发生在不同的服务池，但是，晚上0点发生的时候概率较大，也有其他时间偶发，但是都在整点。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">这个规律很重要，虽然不是一个时间，但是基本都在整点左右发生，并且晚上0点居多。从这个角度思考，整点或者0点系统是否有定时，与出问题的每个业务系统技术负责人核实，0点没有定时任务，其他时间的整点有定时任务，但是与发生问题的时间不吻合，这个思路行不通。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">到现在为止，从现象的规律上我们已经没法继续分析下去了，那我们回顾一下错误本身：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">java.lang.OutOfMemoryError: unable to create new native thread</p></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">顾名思义，错误产生的原因就是应用不能创建线程了，但是，应用还需要创建线程。为什么程序不能创建线程呢？</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">有两个具体原因造成这个异常:</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">由于线程使用的资源过多，操作系统已经不能再提供给应用资源了。</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">操作系统设置了应用创建线程的最大数量，并且已经达到了最大允许数量。</p></li></ol></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">上面第1条资源指的是内存，而第2条中，在Linux下线程使用轻量级进程实现的，因此线程的最大数量也是操作系统允许的进程的最大数量。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-style:italic;">内存计算</em></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">操作系统中的最大可用内存除去操作系统本身使用的部分，剩下的都可以为某一个进程服务，在JVM进程中，内存又被分为堆、本地内存和栈等三大块，Java堆是JVM自动管理的内存，应用的对象的创建和销毁、类的装载等都发生在这里，本地内存是Java应用使用的一种特殊内存，JVM并不直接管理其生命周期，每个线程也会有一个栈，是用来存储线程工作过程中产生的方法局部变量、方法参数和返回值的，每个线程对应的栈的默认大小为1M。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">Linux和JVM的内存管理示意图如下：</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;text-align:center;"><img src="jvm系列(十)教你如何成为Java的OOM Killer_files/640" type="image/webp" data-filename="640" height="104" style="border-style:solid;margin:0px;width:469px !important;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;border-width:1px;padding:0px;border-color:rgb(238, 237, 235);background-color:rgb(238, 237, 235);background-size:22px;background-position:50% 50%;background-repeat:no-repeat;max-width:100%;visibility:visible !important;" width="467"/></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">因此，从内存角度来看创建线程需要内存空间，如果JVM进程正当一个应用创建线程，而操作系统没有剩余的内存分配给此JVM进程，则会抛出问题中的OOM异常：unable to create new native thread。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">如下公式可以用来从内存角度计算允许创建的最大线程数：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">最大线程数 = （操作系统最大可用内存 - JVM内存 - 操作系统预留内存）/ 线程栈大小</p></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">根据这个公式，我们可以通过剩余内存计算可以创建线程的数量。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">下面是问题出现的时候，从生产机器上执行前面小节介绍的Linux命令free的输出：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">free -m &gt;&gt; /tmp/free.log
             total       used       free     shared    buffers     cached
Mem:          <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7872</span>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7163</span>        <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">709</span>          <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>         <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">31</span>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3807</span>-/+ buffers/cache:       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3324</span>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">4547</span>Swap:         <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">4095</span>        <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">173</span>       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3922</span>Tue Jul <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">5</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">00</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">27</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">51</span> CST <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2016</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">从上面输出可以得出，生产机器8G内存，使用了7G，剩余700M可用，其中操作系统cache使用3.8G。操作系统cache使用的3.8G是用来缓存IO数据的，如果进程内存不够用，这些内存是可以释放出来优先分配给进程使用。然而，我们暂时并不需要考虑这块内存，剩余的700M空间完全可以继续用来创建线程数：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">700M / 1M = 700个线程</p></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">因此，根据内存可用计算，当OOM异常：unable to create new native thread问题发生的时候，还有700M可用内存，可以创建700个线程。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">到现在为止可以证明此次OOM异常不是因为线程吃光所有的内存而导致的。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-style:italic;">线程数对比</em></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">上面提到，有两个具体原因造成这个异常，我们上面已经排除了第1个原因，那我们现在从第2个原因入手，评估是否操作系统设置了应用创建线程的最大数量，并且已经达到了最大允许数量。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">在问题出现的生产机器上使用ulimit -a来显示当前的各种系统对用户使用资源的限制：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">robert@robert-ubuntu1410：~$ ulimit <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-a</span>core file size          (blocks, -c) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>data seg size           (kbytes, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-d</span>) unlimited
scheduling priority             (<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-e</span>) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>file size               (blocks, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-f</span>) unlimited
pending signals                 (-i) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">62819</span>max locked memory       (kbytes, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-l</span>) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">64</span>max memory size         (kbytes, -m) unlimited
open files                      (-n) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">65535</span>pipe size            (<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">512</span> bytes, -p) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span>POSIX message queues     (bytes, -q) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">819200</span>real-time priority              (-r) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>stack size              (kbytes, <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-s</span>) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10240</span>cpu time               (seconds, -t) unlimited
max user processes              (-u) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1024</span>virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">这里面我们看到生产机器设置的允许使用的最大用户进程数为1024：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">max user processes              (-u) <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1024</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">现在，我们必须获得问题出现的时候，用户下创建的线程情况。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">在问题产生的时候，我们使用前面小结介绍的JVM监控命令jstack命令打印出了Java线程情况,jstack命令的示例输出如下：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">robert@robert-ubuntu1410:~$ jstack <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2743</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2017</span>-<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">04</span>-<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">09</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">12</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">06</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">51</span>Full thread dump Java HotSpot(TM) Server VM (<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">25.20</span>-b23 mixed mode):<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;Attach Listener&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#23 daemon prio=9 os_prio=0 tid=0xc09adc00 nid=0xb4c waiting on condition [0x00000000]</span>
   java.lang.Thread.State: RUNNABLE<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;http-nio-8080-Acceptor-0&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#22 daemon prio=5 os_prio=0 tid=0xc3341000 nid=0xb02 runnable [0xbf1bd000]</span>
   java.lang.Thread.State: RUNNABLE
    at sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)
    at sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">241</span>)
    - locked &lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>xcf8938d8&gt; (a java.lang.Object)
    at org.apache.tomcat.util.net.NioEndpoint<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$Acceptor</span>.run(NioEndpoint.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">688</span>)
    at java.lang.Thread.run(Thread.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">745</span>)<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;http-nio-8080-ClientPoller-1&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#21 daemon prio=5 os_prio=0 tid=0xc35bc400 nid=0xb01 runnable [0xbf1fe000]</span>
   java.lang.Thread.State: RUNNABLE
    at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)
    at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">269</span>)
    at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">79</span>)
    at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">86</span>)
    - locked &lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>xcf99b100&gt; (a sun.nio.ch.Util<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$2</span>)
    - locked &lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>xcf99b0f0&gt; (a java.util.Collections<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$UnmodifiableSet</span>)
    - locked &lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>xcf99aff8&gt; (a sun.nio.ch.EPollSelectorImpl)
    at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">97</span>)
    at org.apache.tomcat.util.net.NioEndpoint<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$Poller</span>.run(NioEndpoint.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1052</span>)
    at java.lang.Thread.run(Thread.java:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">745</span>)
......</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">从jstack命令的输出并统计后，我们得知，JVM一共创建了904个线程，但是，这还没有到最大的进程限制1024。</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">robert@robert-ubuntu1410:~$ grep <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;Thread &quot;</span> js.log | wc <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-l</span>
     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">904</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">这是我们思考，除了JVM创建的应用层线程，JVM本身可能会有一些管理线程存在，而且操作系统内用户下可能也会有守护线程在运行。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">我们继续从操作系统的角度来统计线程数，我们使用上面小结介绍的Linux操作系统命令pstack，并得到如下的输出：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">PID   LWP USER     %CPU %MEM CMD    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> /sbin/init    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [kthreadd]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">4</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">4</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [ksoftirqd/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">5</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">5</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [watchdog/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>]    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [ksoftirqd/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [watchdog/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">11</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">11</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">12</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">12</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">13</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">13</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [ksoftirqd/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">14</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">14</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [watchdog/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">15</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">15</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">16</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">16</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [migration/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">17</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">17</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [ksoftirqd/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">18</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">18</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [watchdog/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">19</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">19</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [events/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">20</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">20</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [events/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">21</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">21</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [events/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">22</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">22</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [events/<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">23</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">23</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [cgroup]   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">24</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">24</span> root      <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> [khelper]

 ...... <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7257</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7257</span> zabbix    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> /usr/local/zabbix/sbin/zabbix_agentd: active checks <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#2 [idle 1 sec]</span>
 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7258</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7258</span> zabbix    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> /usr/local/zabbix/sbin/zabbix_agentd: active checks <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#3 [idle 1 sec]</span>
 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7259</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7259</span> zabbix    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> /usr/local/zabbix/sbin/zabbix_agentd: active checks <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">#4 [idle 1 sec]</span>

 ...... <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9040</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9040</span> app       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">30.5</span> /apps/prod/jdk1.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6.0</span>_24/bin/java -Dnop -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Ddbconfigpath=/apps/dbconfig/ -Djava.io.tmpdir=/apps/data/java-tmpdir -server -Xms2048m -Xmx2048m -XX:PermSize=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">128</span>m -XX:MaxPermSize=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">512</span>m -Dcom.sun.management.jmxremote -Djava.rmi.server.hostname=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">192.168</span>.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10.194</span> -Dcom.sun.management.jmxremote.port=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6969</span> -Dcom.sun.management.jmxremote.ssl=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">false</span> -Dcom.sun.management.jmxremote.authenticate=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">false</span> -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -Xshare:off -Dhostname=sjsa-trade04 -Djute.maxbuffer=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">41943040</span> -Djava.net.preferIPv4Stack=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">true</span> -Dfile.encoding=UTF-<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span> -Dworkdir=/apps/data/tomcat-work -Djava.endorsed.dirs=/apps/product/tomcat-trade/endorsed -classpath commonlib:/apps/product/tomcat-trade/bin/bootstrap.jar:/apps/product/tomcat-trade/bin/tomcat-juli.jar -Dcatalina.base=/apps/product/tomcat-trade -Dcatalina.home=/apps/product/tomcat-trade -Djava.io.tmpdir=/apps/data/tomcat-temp/ org.apache.catalina.startup.Bootstrap start <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9040</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9041</span> app       <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0.0</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">30.5</span> /apps/prod/jdk1.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6.0</span>_24/bin/java -Dnop -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Ddbconfigpath=/apps/dbconfig/ -Djava.io.tmpdir=/apps/data/java-tmpdir -server -Xms2048m -Xmx2048m -XX:PermSize=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">128</span>m -XX:MaxPermSize=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">512</span>m -Dcom.sun.management.jmxremote -Djava.rmi.server.hostname=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">192.168</span>.<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10.194</span> -Dcom.sun.management.jmxremote.port=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6969</span> -Dcom.sun.management.jmxremote.ssl=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">false</span> -Dcom.sun.management.jmxremote.authenticate=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">false</span> -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -Xshare:off -Dhostname=sjsa-trade04 -Djute.maxbuffer=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">41943040</span> -Djava.net.preferIPv4Stack=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">true</span> -Dfile.encoding=UTF-<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span> -Dworkdir=/apps/data/tomcat-work -Djava.endorsed.dirs=/apps/product/tomcat-trade/endorsed -classpath commonlib:/apps/product/tomcat-trade/bin/bootstrap.jar:/apps/product/tomcat-trade/bin/tomcat-juli.jar -Dcatalina.base=/apps/product/tomcat-trade -Dcatalina.home=/apps/product/tomcat-trade -Djava.io.tmpdir=/apps/data/tomcat-temp/ org.apache.catalina.startup.Bootstrap start

......</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">通过命令统计用户下已经创建的线程数为1021。</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">$ grep app pthreads.log | wc <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-l</span>
    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1021</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">现在我们确定，1021的数字已经相当的接近1021的最大进程数了，正如前面我们提到，在Linux操作系统里，线程是通过轻量级的进程实现的，因此，限制用户的最大进程数，就是限制用户的最大线程数，至于为什么没有精确达到1024这个最大值就已经报出异常，应该是系统的自我保护功能，在还剩下3个线程的前提下，就开始报错。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">到此为止，我们已经通过分析来找到问题的原因，但是，我们还是不知道为什么会创建这么多的线程，从第一个输出得知，JVM已经创建的应用线程有907个，那么他们都在做什么事情呢？</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">于是，在问题发生的时候，我们又使用JVM的jstack命令，查看输出得知，每个线程都阻塞在打印日志的语句上，log4j中打印日志的代码实现如下：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">public</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">void</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 0, 0);font-weight:bold;">callAppenders</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">(LoggingEvent event)</span> </span>{    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">int</span> writes = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>;    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">for</span>(Category c = <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">this</span>; c != <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">null</span>; c=c.parent) {        <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 136);font-style:italic;">// Protected against simultaneous call to addAppender, removeAppender,...</span>
        <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">synchronized</span>(c) {            <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">if</span>(c.aai != <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">null</span>) {
                writes += c.aai.appendLoopOnAppenders(event);
            }            <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">if</span>(!c.additive) {                <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">break</span>;
            }
        }
    }    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">if</span>(writes == <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>) {
        repository.emitNoAppenderWarning(<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">this</span>);
    }
}</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">在log4j中，打印日志有一个锁，锁的作用是让打印日志可以串行，保证日志在日志文件中的正确性和顺序性。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">那么，新的问题又来了，为什么只有凌晨0点会出现打印日志阻塞，其他时间会偶尔发生呢？这时，我们带着新的线索又回到问题开始的思路，凌晨12点应用没有定时任务，系统会不会有其他的IO密集型的任务，比如说归档日志、磁盘备份等？</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">经过与运维部门碰头，基本确定是每天凌晨0点日志切割导致磁盘IO被占用，于是堵塞打印日志，日志是每个工作任务都必须的，日志阻塞，线程池就阻塞，线程池阻塞就导致线程池被撑大，线程池里面的线程数超过1024就会报错。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">到这里，我们基本确定了问题的原因，但是还需要对日志切割导致IO增大进行分析和论证。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">首先我们使用前面小结介绍的vmstat查看问题发生时IO等待数据：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;">vmstat <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span> &gt;&gt; /tmp/vm.log
procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-weight:bold;">in</span>   cs us sy id wa st <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">177608</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">725636</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">31856</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3899144</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>     <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">10</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>    <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">39</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">59</span>  <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">0</span>    Tue Jul <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">5</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">00</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">27</span>:<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">51</span> CST <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2016</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">可见，问题发生的时候，CPU的IO等待为59%，同时又与运维部门同事复盘，运维同事确认，脚本切割通过cat命令方法，先把日志文件cat后，通过管道打印到另外一个文件，再清空原文件，因此，一定会导致IO的上升。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">其实，问题的过程中，还有一个疑惑，我们认为线程被IO阻塞，线程池被撑开，导致线程增多，于是，我们查看了一下Tomcat线程池的设置，我们发现Tomcat线程池设置了800，按理说，永远不会超过1024。</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 0, 128);">&lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">Connector</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">port</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;8080&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">maxThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;800&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">minSpareThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;25&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">maxSpareThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;75&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">enableLookups</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;false&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">redirectPort</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;8443&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">acceptCount</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;100&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">debug</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;0&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">connectionTimeout</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;20000&quot;</span>      
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">disableUploadTimeout</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;true&quot;</span> /&gt;</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">关键在于，笔者所在的支付平台服务化架构中，使用了两套服务化框架，一个是基于dubbo的框架，一个是点对点的RPC，用来紧急情况下dubbo服务出现问题，服务降级使用。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">每个服务都配置了点对点的RPC服务，并且独享一个线程池：</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 0, 128);">&lt;<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">Connector</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">port</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;8090&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">maxThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;800&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">minSpareThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;25&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">maxSpareThreads</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;75&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">enableLookups</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;false&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">redirectPort</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;8443&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">acceptCount</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;100&quot;</span>     
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">debug</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;0&quot;</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">connectionTimeout</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;20000&quot;</span>      
               <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">disableUploadTimeout</span>=<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;true&quot;</span> /&gt;</span></code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">由于我们在对dubbo服务框架进行定制化的时候，设计了自动降级原则，如果dubbo服务负载变高，会自动切换到点对点的RPC框架，这也符合微服务的失效转移原则，但是设计中没有进行全面的考虑，一旦一部分服务切换到了点对点的RPC，而一部分的服务没有切换，就导致两个现场池都被撑满，于是超过了1024的限制，就出了问题。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">到这里，我们基本可以验证，问题的根源是日志切割导致IO负载增加，然后阻塞线程池，最后发生OOM：unable to create new native thread。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">剩下的任务就是最小化重现的问题，通过实践来验证问题的原因。我们与性能压测部门沟通，提出压测需求：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">Tomcat线程池最大设置为1500.</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">操作系统允许的最大用户进程数1024.</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">在给服务加压的过程中，需要人工制造繁忙的IO操作，IO等待不得低于50%。</p></li></ol></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">经过压测压测部门的一下午努力，环境搞定，结果证明完全可以重现此问题。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">最后，与所有相关部门讨论和复盘，应用解决方案，解决方案包括：</p><blockquote style="margin-top:1.2em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;padding-left:1em;border-left:3px solid rgb(219, 219, 219);padding:0px;margin-bottom:1.2em;padding-right:1em;border-left-width:4px;border-left-color:rgb(221, 221, 221);color:rgb(119, 119, 119);quotes:none;"><ol style="margin:0px;padding:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">全部应用改成按照小时切割，或者直接使用log4j的日志滚动功能。</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">Tomcat线程池的线程数设置与操作系统的线程数设置不合理，适当的减少Tomcat线程池线程数量的大小。</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;">升级log4j日志，使用logback或者log4j2。</p></li></ol></blockquote><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">这次OOM问题的可以归结为“多个因、多个果、多台机器、多个服务池、不同时间”，针对这个问题，与运维部、监控部和性能压测部门的同事奋斗了几天几夜，终于通过在线上抓取信息、分析问题、在性能压测部门同事的帮助下，最小化重现问题并找到问题的根源原因，最后，针对问题产生的根源提供了有效的方案。</p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><em style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-style:italic;">3. 与监控同事现场编写的脚本</em></strong></p><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">本节提供一个笔者在实践过程中解决OOM问题的一个简单脚本，这个脚本是为了解决OOM（unable to create native thread)的问题而在问题机器上临时编写，并临时使用的，脚本并没有写的很专业，笔者也没有进行优化，保持原汁原味的风格，这样能让读者有种身临其境的感觉，只是为了抓取需要的信息并解决问题，但是在线上问题十分火急的情况下，这个脚本会有大用处。</p><pre style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-top:1.2em;margin-bottom:1.2em;font-family:Consolas, Inconsolata, Courier, monospace;font-size:1em;line-height:1.2em;"><code style="border-width:1px;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;margin-right:0.15em;margin-left:0.15em;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;overflow:auto;border-radius:3px;padding:0.5em;border-style:solid;border-color:rgb(204, 204, 204);color:rgb(51, 51, 51);background-image:initial;background-position:initial;background-size:initial;background-repeat:initial;background-attachment:initial;background-origin:initial;background-clip:initial;display:block !important;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(153, 153, 153);font-weight:bold;">#!/bin/bash</span>ps -Leo pid,lwp,user,pcpu,pmem,cmd &gt;&gt; /tmp/pthreads.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;ps -Leo pid,lwp,user,pcpu,pmem,cmd &gt;&gt; /tmp/pthreads.log&quot;</span> &gt;&gt; /tmp/pthreads.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/pthreads.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span>pid=`ps aux|grep tomcat|grep cwh|awk -F <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">' '</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">'{print $2}'</span>`<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;pstack <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span> &gt;&gt; /tmp/pstack.log&quot;</span> &gt;&gt; /tmp/pstack.log
pstack <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span> &gt;&gt; /tmp/pstack.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/pstack.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">3</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;lsof &gt;&gt; /tmp/sys-o-files.log&quot;</span> &gt;&gt; /tmp/sys-o-files.log
lsof &gt;&gt; /tmp/sys-o-files.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/sys-o-files.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">4</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;lsof -p <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span> &gt;&gt; /tmp/service-o-files.log&quot;</span> &gt;&gt; /tmp/service-o-files.log
lsof -p <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span> &gt;&gt; /tmp/service-o-files.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/service-o-files.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">5</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;jstack -l <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span>  &gt;&gt; /tmp/js.log&quot;</span> &gt;&gt; /tmp/js.log
jstack <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">-l</span> -F <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">$pid</span>  &gt;&gt; /tmp/js.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/js.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">6</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;free -m &gt;&gt; /tmp/free.log&quot;</span> &gt;&gt; /tmp/free.log
free -m &gt;&gt; /tmp/free.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/free.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">7</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;vmstat 2 1 &gt;&gt; /tmp/vm.log&quot;</span> &gt;&gt; /tmp/vm.log
vmstat <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">2</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">1</span> &gt;&gt; /tmp/vm.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/vm.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">8</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(221, 17, 68);">&quot;jmap -dump:format=b,file=/tmp/heap.hprof 2743&quot;</span> &gt;&gt; /tmp/jmap.log
jmap -dump:format=b,file=/tmp/heap.hprof &gt;&gt; /tmp/jmap.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> `date` &gt;&gt; /tmp/jmap.log<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 128, 128);">9</span><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 134, 179);">echo</span> end</code></pre><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;margin-bottom:1.2em !important;">如果读者在线上已经遇到了OOM的问题，可以顺着这个看似简陋而又信息满满的Java服务的监控脚本的思路，利用本文提供的各种脚本和命令来深挖问题的根本原因。</p><div style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(62, 62, 62);font-size:16px;white-space:normal;background-color:rgb(255, 255, 255);"><p style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;clear:both;min-height:1em;text-align:center;"><img src="jvm系列(十)教你如何成为Java的OOM Killer_files/640 [1]" type="image/webp" data-filename="640" height="16" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:478px !important;" width="478px"/></p></div><p style="margin-top:15px;margin:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word !important;font-family:Helvetica, Arial, sans-serif;min-height:1em;padding:0px;margin-bottom:15px;white-space:normal;background-color:rgb(255, 255, 255);color:rgb(80, 97, 109);clear:both;font-size:15px;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">优秀人才不缺工作机会，只缺适合自己的好机会。但是他们往往没有精力从海量机会中找到最适合的那个。 <span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:rgb(0, 122, 170);">100offer</span> 会对平台上的人才和企业进行严格筛选，让「最好的人才」和「最好的公司」相遇。 扫描下方二维码，注册 100offer，谈谈你对下一份工作的期待。一周内，收到 5-10 个满足你要求的好机会！</span><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"/></p><p style="min-height:1em;margin:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;background-color:rgb(255, 255, 255);padding:0px;color:rgb(62, 62, 62);font-size:16px;white-space:normal;clear:both;text-align:center;"><img src="jvm系列(十)教你如何成为Java的OOM Killer_files/640 [2]" type="image/webp" data-filename="640" height="388" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;height:auto !important;visibility:visible !important;width:auto !important;" width="auto"/></p>
                </div>
                
                
                
                                
                

                
                                
                
                            </div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 