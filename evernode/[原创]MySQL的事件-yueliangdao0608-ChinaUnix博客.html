<html>
<head>
  <title>[原创]MySQL的事件-yueliangdao0608-ChinaUnix博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="9327"/>
<h1>[原创]MySQL的事件-yueliangdao0608-ChinaUnix博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2016/2/26 11:43</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.chinaunix.net/uid-259788-id-2139296.html"><i>http://blog.chinaunix.net/uid-259788-id-2139296.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><br/><div style="font-size: 16px"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:1;font-family:宋体, Arial;background:rgb(243, 247, 249);"><div style="word-wrap:break-word;text-align:left;color:rgb(86, 86, 86);"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;background:rgb(255, 255, 255);"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;color:rgb(102, 102, 102);line-height:26px;"><div style="word-wrap:break-word;font-size:16px;">
			
										MYSQL的事件是5.1新增加的，如果想体验，建议升级版本。<br style="word-wrap:break-word;"/>至于语法我就不多说了，手册上讲的很详细，我来说说几个要点以及一些实例。<br style="word-wrap:break-word;"/><span style="word-wrap:break-word;color:rgb(255, 1, 2);">注意事项：</span><br style="word-wrap:break-word;color:rgb(255, 1, 2);"/><span style="word-wrap:break-word;color:rgb(255, 1, 2);">1、EVENT权限是针对模式的（在MYSQL中也就是库的级别），不能对单独表来赋予权限。</span><br style="word-wrap:break-word;color:rgb(255, 1, 2);"/><span style="word-wrap:break-word;color:rgb(255, 1, 2);">2、必须在全局开启。</span><br style="word-wrap:break-word;color:rgb(255, 1, 2);"/><span style="word-wrap:break-word;color:rgb(255, 1, 2);">3、性能上的损失一定得考虑到。</span><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;color:rgb(0, 1, 255);"/><span style="word-wrap:break-word;color:rgb(0, 1, 255);">mysql&gt; show variables like '%event%';</span><br style="word-wrap:break-word;"/>+-----------------+-------+<br style="word-wrap:break-word;"/>| Variable_name   | Value |<br style="word-wrap:break-word;"/>+-----------------+-------+<br style="word-wrap:break-word;"/>| event_scheduler | OFF   | <br style="word-wrap:break-word;"/>+-----------------+-------+<br style="word-wrap:break-word;"/>1 row in set (0.00 sec)<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;color:rgb(0, 1, 255);"/><span style="word-wrap:break-word;color:rgb(0, 1, 255);">mysql&gt; set global event_scheduler = on;</span><br style="word-wrap:break-word;color:rgb(0, 1, 255);"/><span style="word-wrap:break-word;color:rgb(0, 1, 2);">Query OK, 0 rows affected (0.00 sec)</span><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>mysql&gt; use event;<br style="word-wrap:break-word;"/>Database changed<br style="word-wrap:break-word;"/><code style="word-wrap:break-word;"><span style="word-wrap:break-word;color:rgb(0, 0, 0);">例子：<br style="word-wrap:break-word;"/>
我们来创建一个简单的文章表：<br style="word-wrap:break-word;"/>
mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">create</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">table</span> article <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>id serial<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>title <span style="word-wrap:break-word;color:rgb(255, 0, 0);">varchar</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>64<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> author_name <span style="word-wrap:break-word;color:rgb(255, 0, 0);">varchar</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>64<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>content <span style="word-wrap:break-word;color:rgb(255, 0, 0);">mediumtext</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> create_time datetime <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>update_time datetime <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">;</span><br style="word-wrap:break-word;"/>
Query OK<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> 0 rows affected <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>0<span style="word-wrap:break-word;color:rgb(0, 0, 204);">.</span>01 sec<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><br style="word-wrap:break-word;"/>
以及统计表：<br style="word-wrap:break-word;"/>
mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">create</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">table</span> report <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>id <span style="word-wrap:break-word;color:rgb(255, 0, 0);">int</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">auto_increment</span> primary key<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> r_date <span style="word-wrap:break-word;color:rgb(255, 0, 0);">date</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>aid <span style="word-wrap:break-word;color:rgb(255, 0, 0);">int</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>total <span style="word-wrap:break-word;color:rgb(255, 0, 0);">int</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">not</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">null</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">;</span><br style="word-wrap:break-word;"/>
Query OK<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> 0 rows affected <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>0<span style="word-wrap:break-word;color:rgb(0, 0, 204);">.</span>01 sec<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span></span></code><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>mysql&gt; 插入测试数据。。。<br style="word-wrap:break-word;"/>我们来建立一个存储过程。<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><p style="word-wrap:break-word;margin:5px;padding:0px;line-height:150%;"><code style="word-wrap:break-word;"><span style="word-wrap:break-word;color:rgb(0, 0, 0);">mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> delimiter <span style="word-wrap:break-word;color:rgb(0, 0, 204);">|</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">|</span><br style="word-wrap:break-word;"/>
mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">create</span> procedure sp_report<span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span>   <br style="word-wrap:break-word;"/>
    -<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> begin<br style="word-wrap:break-word;"/>
    -<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">insert</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">into</span> report<span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>r_date<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>aid<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>total<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">select</span> <span style="word-wrap:break-word;color:rgb(255, 0, 0);">date</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>update_time<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">as</span> r_date<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> id<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span><span style="word-wrap:break-word;color:rgb(0, 0, 255);">count</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>1<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">from</span> article group by <span style="word-wrap:break-word;color:rgb(255, 0, 0);">date</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>create_time<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> order by r_date asc<span style="word-wrap:break-word;color:rgb(0, 0, 204);">;</span><br style="word-wrap:break-word;"/>
    -<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">end</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">|</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">|</span><br style="word-wrap:break-word;"/>
Query OK<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> 0 rows affected <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>0<span style="word-wrap:break-word;color:rgb(0, 0, 204);">.</span>00 sec<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><br style="word-wrap:break-word;"/>
<br style="word-wrap:break-word;"/>
mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> delimiter <span style="word-wrap:break-word;color:rgb(0, 0, 204);">;</span></span></code></p><br style="word-wrap:break-word;"/>创建EVENT;<br style="word-wrap:break-word;"/>在一分钟后执行这个存储过程。<br style="word-wrap:break-word;"/><code style="word-wrap:break-word;"><span style="word-wrap:break-word;color:rgb(0, 0, 0);">mysql<span style="word-wrap:break-word;color:rgb(0, 0, 204);">&gt;</span> <span style="word-wrap:break-word;color:rgb(0, 0, 255);">create</span> event report_dawn on schedule at <span style="word-wrap:break-word;color:rgb(255, 0, 0);">date_add</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span><span style="word-wrap:break-word;color:rgb(255, 0, 0);">now</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span>interval 1 <span style="word-wrap:break-word;color:rgb(255, 0, 0);">minute</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span> on completion preserve do call sp_report<span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span><span style="word-wrap:break-word;color:rgb(0, 0, 204);">;</span><br style="word-wrap:break-word;"/>
Query OK<span style="word-wrap:break-word;color:rgb(0, 0, 204);">,</span> 0 rows affected <span style="word-wrap:break-word;color:rgb(0, 0, 204);">(</span>0<span style="word-wrap:break-word;color:rgb(0, 0, 204);">.</span>00 sec<span style="word-wrap:break-word;color:rgb(0, 0, 204);">)</span></span></code><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>mysql&gt; show processlist;<br style="word-wrap:break-word;"/>|  7 | event_scheduler | localhost         | NULL   | Daemon  |     5 | Waiting for next activation | NULL             | <br style="word-wrap:break-word;"/>mysql&gt; select * from report;<br style="word-wrap:break-word;"/>Empty set (0.00 sec)<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>察看现在的EVENT<br style="word-wrap:break-word;"/>mysql&gt; show create event report_dawn\G<br style="word-wrap:break-word;"/>*************************** 1. row ***************************<br style="word-wrap:break-word;"/>               Event: report_dawn<br style="word-wrap:break-word;"/>            sql_mode: <br style="word-wrap:break-word;"/>           time_zone: SYSTEM<br style="word-wrap:break-word;"/>        Create Event: CREATE EVENT `report_dawn` ON SCHEDULE AT '2008-03-21 15:46:57' ON COMPLETION PRESERVE DISABLE DO call sp_report()<br style="word-wrap:break-word;"/>character_set_client: latin1<br style="word-wrap:break-word;"/>collation_connection: latin1_swedish_ci<br style="word-wrap:break-word;"/>  Database Collation: utf8_general_ci<br style="word-wrap:break-word;"/>1 row in set (0.00 sec)<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>mysql&gt; <br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>我们来查看更新后的结果：<br style="word-wrap:break-word;"/>mysql&gt; select * from report;<br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>| id | r_date     | aid | total |<br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>|  1 | 2008-03-21 |   1 |     3 | <br style="word-wrap:break-word;"/>|  2 | 2008-03-22 |  16 |     1 | <br style="word-wrap:break-word;"/>|  3 | 2008-03-23 |   4 |     2 | <br style="word-wrap:break-word;"/>|  4 | 2008-03-23 |   6 |     2 | <br style="word-wrap:break-word;"/>|  5 | 2008-03-23 |   7 |     1 | <br style="word-wrap:break-word;"/>|  6 | 2008-03-23 |   8 |     2 | <br style="word-wrap:break-word;"/>|  7 | 2008-03-23 |  10 |     2 | <br style="word-wrap:break-word;"/>|  8 | 2008-04-13 |  12 |     1 | <br style="word-wrap:break-word;"/>|  9 | 2008-04-13 |  13 |     2 | <br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>9 rows in set (0.00 sec)<br style="word-wrap:break-word;"/>现在看看这个EVENT的状态，<br style="word-wrap:break-word;"/>mysql&gt; select event_schema,event_name,status from information_schema.events where event_schema = 'event';<br style="word-wrap:break-word;"/>+--------------+-------------+----------+<br style="word-wrap:break-word;"/>| event_schema | event_name  | status   |<br style="word-wrap:break-word;"/>+--------------+-------------+----------+<br style="word-wrap:break-word;"/>| event        | report_dawn | DISABLED | <br style="word-wrap:break-word;"/>+--------------+-------------+----------+<br style="word-wrap:break-word;"/>1 row in set (0.00 sec)<br style="word-wrap:break-word;"/>已经停止运行了。<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>mysql&gt; select * from report;<br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>| id | r_date     | aid | total |<br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>|  1 | 2008-03-21 |   1 |     3 | <br style="word-wrap:break-word;"/>|  2 | 2008-03-22 |  16 |     1 | <br style="word-wrap:break-word;"/>|  3 | 2008-03-23 |   4 |     2 | <br style="word-wrap:break-word;"/>|  4 | 2008-03-23 |   6 |     2 | <br style="word-wrap:break-word;"/>|  5 | 2008-03-23 |   7 |     1 | <br style="word-wrap:break-word;"/>|  6 | 2008-03-23 |   8 |     2 | <br style="word-wrap:break-word;"/>|  7 | 2008-03-23 |  10 |     2 | <br style="word-wrap:break-word;"/>|  8 | 2008-04-13 |  12 |     1 | <br style="word-wrap:break-word;"/>|  9 | 2008-04-13 |  13 |     2 | <br style="word-wrap:break-word;"/>| 10 | 2008-03-21 |   1 |     3 | <br style="word-wrap:break-word;"/>| 11 | 2008-03-22 |  16 |     1 | <br style="word-wrap:break-word;"/>| 12 | 2008-03-23 |   4 |     2 | <br style="word-wrap:break-word;"/>| 13 | 2008-03-23 |   6 |     2 | <br style="word-wrap:break-word;"/>| 14 | 2008-03-23 |   7 |     1 | <br style="word-wrap:break-word;"/>| 15 | 2008-03-23 |   8 |     2 | <br style="word-wrap:break-word;"/>| 16 | 2008-03-23 |  10 |     2 | <br style="word-wrap:break-word;"/>| 17 | 2008-04-13 |  12 |     1 | <br style="word-wrap:break-word;"/>| 18 | 2008-04-13 |  13 |     2 | <br style="word-wrap:break-word;"/>+----+------------+-----+-------+<br style="word-wrap:break-word;"/>18 rows in set (0.00 sec)<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>多了9条记录，<br style="word-wrap:break-word;"/>不过默认修改时间后。<br style="word-wrap:break-word;"/>在运行完毕后没有保存它。<br style="word-wrap:break-word;"/>因为时间已经过去了。<br style="word-wrap:break-word;"/>mysql&gt; select event_schema,event_name,status from information_schema.events where event_schema = 'event';<br style="word-wrap:break-word;"/>Empty set (0.00 sec)<br style="word-wrap:break-word;"/><br style="word-wrap:break-word;"/>ON COMPLETION [NOT]PRESERVE<br style="word-wrap:break-word;"/>这个选项用来确认事件在执行完毕后是否保存其定义。
		
		
		
		
		
		
		
		           </div></div></div></div></div></div></div></div></div></div><br/></span>
</div></body></html> 