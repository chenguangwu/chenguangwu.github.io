<html>
<head>
  <title>一次Mysql死锁排查过程的全纪录 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8316"/>
<h1>一次Mysql死锁排查过程的全纪录 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/4/4 11:48</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601"><i>https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-size:16px;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-weight:400;box-sizing:border-box;background-color:rgb(245, 246, 247);line-height:24px;"><div style="font-weight:400;box-sizing:border-box;"><span><div style="box-shadow:rgba(0, 0, 0, 0.0470588) 0px 2px 4px 0px;background-color:rgb(255, 255, 255);">
        <h1 style="font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;margin:0px;box-sizing:border-box;word-break:break-all;word-wrap:break-word;padding:0px 29px;font-weight:700;color:rgb(44, 48, 51);font-size:24px;line-height:38px;">一次Mysql死锁排查过程的全纪录</h1>
        <div style="margin:0px;font-weight:400;box-sizing:border-box;padding:0px 29px 8px;color:rgb(136, 136, 136);border-bottom:1px solid rgb(229, 229, 229);font-size:14px;line-height:38px;margin-top:5px;">
            <div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;float:left;">
                <span style="margin:0px;font-weight:400;box-sizing:border-box;padding:2px 6px;border:1px solid rgb(228, 235, 244);font-size:14px;color:rgb(120, 144, 156);margin-right:20px;">
                转载                </span>
                <span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;display:inline-block;color:rgb(187, 187, 187);font-size:14px;">2017年09月07日 10:55:09</span>
            </div>

            
            <ul style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:right;margin-top:5px;">
                <li style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;margin-left:30px;line-height:28px;"></li>
                
                
            </ul>
        <span style="font-weight:400;color:rgb(136, 136, 136);font-size:14px;line-height:38px;height:0px;visibility:hidden;display:block;clear:both;">.</span></div>
        <div style="margin:0px;font-weight:400;box-sizing:border-box;padding:20px 30px 0px;word-break:break-all;margin-bottom:30px;color:rgb(69, 69, 69);word-wrap:break-word;overflow:hidden;">
                            <div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;">
                        
<div style="margin:10px 5px;padding:10px;font-weight:400;box-sizing:border-box;background:rgb(246,251,255);color:rgb(51,51,51);border-left:3px solid rgb(59,176,219);font-size:14px;font-family:tahoma, arial, '宋体';">
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;">在测试环境测试给用户并发发送卡券时，出现了死锁，通过查找相关的资料解决了这个，所以想着总结出来，所以下面这篇文章主要是关于一次Mysql死锁排查过程的全纪录，需要的朋友可以参考下，希望大家从中能有所帮助。</div>
</div>
<div style="margin:5px auto;padding:0px;font-weight:400;box-sizing:border-box;text-align:center;font-family:tahoma, arial, '宋体';">
<span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"></span><span style="font-weight:400;height:0px;visibility:hidden;display:block;clear:both;">.</span></div>
<div style="margin:0px 10px;padding:20px 5px 0px;font-weight:400;box-sizing:border-box;line-height:25.2px;clear:both;font-size:14px;overflow:hidden;font-family:tahoma, arial, '宋体';">
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">前言</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
之前接触到的数据库死锁，都是批量更新时加锁顺序不一致而导致的死锁，但是上周却遇到了一个很难理解的死锁。借着这个机会又重新学习了一下mysql的死锁知识以及常见的死锁场景。在多方调研以及和同事们的讨论下终于发现了这个死锁问题的成因，收获颇多。虽然是后端程序员，我们不需要像DBA一样深入地去分析与锁相关的源码，但是如果我们能够掌握基本的死锁排查方法，对我们的日常开发还是大有裨益的。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
PS：本文不会介绍死锁的基本知识，mysql的加锁原理可以参考本文的参考资料提供的链接。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">死锁起因</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
先介绍一下数据库和表情况，因为涉及到公司内部真是的数据，所以以下都做了模拟，不会影响具体的分析。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
我们采用的是5.5版本的mysql数据库，事务隔离级别是默认的RR（Repeatable-Read），采用innodb引擎。假设存在test表：</p>
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;line-height:25.2px;overflow:hidden;clear:both;">
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[sql]</b> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_plain.gif&quot;);" target="_self" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_copy.gif&quot;);" target="_self" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:267px;top:707px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">CREATE</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">TABLE</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> `test` (  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> `id` <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">int</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">(11) unsigned </span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:grey;">NOT</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:grey;">NULL</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> AUTO_INCREMENT,  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> `a` <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">int</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">(11) unsigned </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">DEFAULT</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:grey;">NULL</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">,  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">PRIMARY</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">KEY</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> (`id`),  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">UNIQUE</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">KEY</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> `a` (`a`)  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">) ENGINE=InnoDB AUTO_INCREMENT=100 <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">DEFAULT</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> CHARSET=utf8;  </span></span></li></ol></div>
</div>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
表的结构很简单，一个主键id，另一个唯一索引a。表里的数据如下：</p>
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;line-height:25.2px;overflow:hidden;clear:both;">
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[sql]</b> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_plain.gif&quot;);" target="_self" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_copy.gif&quot;);" target="_self" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:267px;top:918px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">mysql&gt; </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">select</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> * </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">from</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> test;  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">+<span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 130, 0);background-color:inherit;">----+------+</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">| id | a |  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">+<span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 130, 0);background-color:inherit;">----+------+</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">| 1 | 1 |  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">| 2 | 2 |  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">| 4 | 4 |  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">+<span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 130, 0);background-color:inherit;">----+------+</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">3 <span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">rows</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:grey;">in</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> </span><span style="color:rgb(0, 102, 153);margin:0px;border:none;box-sizing:border-box;background:rgb(0, 102, 170);padding:0px;font-size:14px;border-radius:2px;word-wrap:normal;font-weight:700;background-color:inherit;">set</span><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> (0.00 sec)  </span></span></li></ol></div>
</div>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
出现死锁的操作如下：</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<table style="width:100%;font-size:inherit;font-style:inherit;font-variant:inherit;margin-top:.54em;border-collapse:collapse;border:1px solid rgb(204,204,204);font-weight:inherit;text-align:center;border-spacing:0px;box-sizing:border-box;margin-bottom:24px;display:table;clear:both;"><thead style="box-sizing:border-box;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);" width="40">
步骤</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);" width="453">
事务1</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);" width="162">
事务2</th>
</tr></thead><tbody style="box-sizing:border-box;border:0px;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="40">
1</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="453">
 </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="162">
begin</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="40">
2</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="453">
 </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="162">
delete from test where a = 2;</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="40">
3</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="453">
begin</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="162">
 </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="40">
4</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="453">
delete from test where a = 2; （事务1卡住）</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="162">
 </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="40">
5</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="453">
提示出现死锁：ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;" width="162">
insert into test (id, a) values (10, 2);</td>
</tr></tbody></table><p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
然后我们可以通过<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">SHOW
 ENGINE INNODB STATUS;</code>来查看死锁日志：</p>
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;line-height:25.2px;overflow:hidden;clear:both;">
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[plain]</b> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_plain.gif&quot;);" target="_self" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_copy.gif&quot;);" target="_self" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:281px;top:1478px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">------------------------  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">LATEST DETECTED DEADLOCK  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">------------------------  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">170219 13:31:31  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (1) TRANSACTION:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">TRANSACTION 2A8BD, ACTIVE 11 sec starting index read  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">mysql tables in use 1, locked 1  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">MySQL thread id 448218, OS thread handle 0x2abe5fb5d700, query id 18923238 renjun.fangcloud.net 121.41.41.92 root updating  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">delete from test where a = 2  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BD lock_mode X waiting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) TRANSACTION:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">TRANSACTION 2A8BC, ACTIVE 18 sec inserting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">mysql tables in use 1, locked 1  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">4 lock struct(s), heap size 1248, 3 row lock(s), undo log entries 2  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">MySQL thread id 448217, OS thread handle 0x2abe5fd65700, query id 18923239 renjun.fangcloud.net 121.41.41.92 root update  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">insert into test (id,a) values (10,2)  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) HOLDS THE LOCK(S):  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock_mode X locks rec but not gap  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock mode S waiting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** WE ROLL BACK TRANSACTION (1)  </span></li></ol></div>
</div>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">分析</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
阅读死锁日志</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
遇到死锁，第一步就是阅读死锁日志。死锁日志通常分为两部分，上半部分说明了事务1在等待什么锁：</p>
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;line-height:25.2px;overflow:hidden;clear:both;">
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[plain]</b> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_plain.gif&quot;);" target="_self" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_copy.gif&quot;);" target="_self" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:281px;top:2319px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">170219 13:31:31  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (1) TRANSACTION:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">TRANSACTION 2A8BD, ACTIVE 11 sec starting index read  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">mysql tables in use 1, locked 1  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">LOCK WAIT 2 lock struct(s), heap size 376, 1 row lock(s)  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">MySQL thread id 448218, OS thread handle 0x2abe5fb5d700, query id 18923238 renjun.fangcloud.net 121.41.41.92 root updating  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">delete from test where a = 2  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BD lock_mode X waiting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li></ol></div>
</div>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
从日志里我们可以看到事务1当前正在执行<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">delete
 from test where a = 2</code>，该条语句正在申请索引a的X锁，所以提示<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">lock_mode
 X waiting</code>。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
然后日志的下半部分说明了事务2当前持有的锁以及等待的锁：</p>
<div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;line-height:25.2px;overflow:hidden;clear:both;">
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[plain]</b> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_plain.gif&quot;);" target="_self" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="https://blog.csdn.net/sanbingyutuoniao123/article/details/77878601#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;https://csdnimg.cn/release/phoenix/images/ico_copy.gif&quot;);" target="_self" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:281px;top:2736px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) TRANSACTION:  </span></span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">TRANSACTION 2A8BC, ACTIVE 18 sec inserting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">mysql tables in use 1, locked 1  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">4 lock struct(s), heap size 1248, 3 row lock(s), undo log entries 2  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">MySQL thread id 448217, OS thread handle 0x2abe5fd65700, query id 18923239 renjun.fangcloud.net 121.41.41.92 root update  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">insert into test (id,a) values (10,2)  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) HOLDS THE LOCK(S):  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock_mode X locks rec but not gap  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">RECORD LOCKS space id 0 page no 923 n bits 80 index `a` of table `oauthdemo`.`test` trx id 2A8BC lock mode S waiting  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 32  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);line-height:150%;color:inherit;background-color:rgb(255, 255, 255);list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 0: len 4; hex 00000002; asc ;;  </span></li><li style="list-style-image:initial;margin-top:8px;font-weight:400;box-sizing:border-box;list-style:none;border:none;list-style-type:decimal;margin-left:40px;border-left:3px solid rgb(108, 226, 108);background-color:rgb(248, 248, 248);color:rgb(92, 92, 92);line-height:150%;list-style-position:outside;padding:0px 3px 0px 10px;margin:0px;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"> 1: len 4; hex 00000002; asc ;;  </span></li></ol></div>
</div>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
从日志的<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">HOLDS
 THE LOCKS(S)</code>块中我们可以看到事务2持有索引a的X锁，并且是记录锁（Record Lock）。该锁是通过事务2在步骤2执行的delete语句申请的。由于是RR隔离模式下的基于唯一索引的等值查询（Where a = 2），所以会申请一个记录锁，而非next-key锁。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
从日志的<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">WAITING
 FOR THIS LOCK TO BE GRANTED</code>块中我们可以看到事务2正在申请S锁，也就是共享锁。该锁是insert into test (id,a) values (10,2)语句申请的。insert语句在普通情况下是会申请排他锁，也就是X锁，但是这里出现了S锁。这是因为a字段是一个唯一索引，所以insert语句会在插入前进行一次<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">duplicate
 key</code>的检查，为了使这次检查成功，需要申请S锁防止其他事务对a字段进行修改。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
那么为什么该S锁会失败呢？这是对同一个字段的锁的申请是需要排队的。S锁前面还有一个未申请成功的X锁，所以S锁必须等待，所以形成了循环等待，死锁出现了。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
通过阅读死锁日志，我们可以清楚地知道两个事务形成了怎样的循环等待，再加以分析，就可以逆向推断出循环等待的成因，也就是死锁形成的原因。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">死锁形成流程图</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
为了让大家更好地理解死锁形成的原因，我们再通过表格的形式阐述死锁形成的流程：</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<table style="width:100%;font-size:inherit;font-style:inherit;font-variant:inherit;margin-top:.54em;border-collapse:collapse;border:1px solid rgb(204,204,204);font-weight:inherit;text-align:center;border-spacing:0px;box-sizing:border-box;margin-bottom:24px;display:table;clear:both;"><thead style="box-sizing:border-box;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
步骤</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
事务1</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
事务2</th>
</tr></thead><tbody style="box-sizing:border-box;border:0px;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">1</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">begin</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">2</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">delete from test where a = 2; 执行成功，事务2占有a=2下的X锁，类型为记录锁。</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">3</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">begin</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">4</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">delete from test where a = 2; 事务1希望申请a=2下的X锁，但是由于事务2已经申请了一把X锁，两把X锁互斥，所以X锁申请进入锁请求队列。</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">5</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">出现死锁，事务1权重较小，所以被选择回滚（成为牺牲品）。</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">insert into test (id, a) values (10, 2); 由于a字段建立了唯一索引，所以需要申请S锁以便检查duplicate key，由于插入的a的值还是2，所以排在X锁后面。但是前面的X锁的申请只有在事务2commit或者rollback之后才能成功，此时形成了循环等待，死锁产生。</td>
</tr></tbody></table><br style="box-sizing:border-box;"/><p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">拓展</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
在排查死锁的过程中，有个同事还发现了上述场景会产生另一种死锁，该场景无法通过手工复现，只有高并发场景下才有可能复现。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
该死锁对应的日志这里就不贴出了，与上一个死锁的核心差别是事务2等待的锁从S锁换成了X锁，也就是<code style="border-radius:4px;box-sizing:border-box;font-size:12px;line-height:1.5;color:rgb(199,37,78);clear:both;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:3px auto 0px;padding:2px 4px;background:rgb(249,242,244);background-color:rgb(249, 242, 244);border:1px solid rgb(204,204,204);">lock_mode
 X locks gap before rec insert intention waiting</code>。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
我们还是通过表格来详细说明该死锁产生的流程：</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<table style="width:100%;font-size:inherit;font-style:inherit;font-variant:inherit;margin-top:.54em;border-collapse:collapse;border:1px solid rgb(204,204,204);font-weight:inherit;text-align:center;border-spacing:0px;box-sizing:border-box;margin-bottom:24px;display:table;clear:both;"><thead style="box-sizing:border-box;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
步骤</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
事务1</th>
<th style="padding:.2em .46em;box-sizing:border-box;margin:0px;text-align:left;border:1px solid rgb(204,204,204);line-height:22px;color:rgb(79, 79, 79);font-weight:700;background-color:rgb(239, 243, 245);font-size:14px;background:rgb(243,243,243);">
事务2</th>
</tr></thead><tbody style="box-sizing:border-box;border:0px;"><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">1</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">begin</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">2</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">delete from test where a = 2; 执行成功，事务2占有a=2下的X锁，类型为记录锁。</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">3</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">begin</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">4</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">【insert第1阶段】insert into test (id, a) values (10, 2); 事务2申请S锁进行duplicate key进行检查。检查成功。</td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(255, 255, 255);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">5</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">delete from test where a = 2; 事务1希望申请a=2下的X锁，但是由于事务2已经申请了一把X锁，两把X锁互斥，所以X锁申请进入锁请求队列。</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;"> </td>
</tr><tr style="border-bottom-color:initial;box-sizing:border-box;border-right-style:initial;border-bottom-style:initial;border-left-style:initial;border-right-color:initial;border-width:1px 0px 0px;border-left-color:initial;border-image:initial;border-top-style:solid;border-top-color:rgb(221, 221, 221);background-color:rgb(247, 247, 247);"><td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">6</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">出现死锁，事务1权重较小，所以被选择回滚（成为牺牲品）。</td>
<td style="box-sizing:border-box;border:1px solid rgb(204,204,204);font-size:14px;color:rgb(79, 79, 79);line-height:22px;padding:.2em .46em;text-align:left;margin:0px;">【insert第2阶段】insert into test (id, a) values (10, 2); 事务2开始插入数据，S锁升级为X锁，类型为insert intention。同理，X锁进入队列排队，形成循环等待，死锁产生。</td>
</tr></tbody></table><br style="box-sizing:border-box;"/><p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
<strong style="box-sizing:border-box;font-weight:700;">总结</strong></p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
排查死锁时，首先需要根据死锁日志分析循环等待的场景，然后根据当前各个事务执行的SQL分析出加锁类型以及顺序，逆向推断出如何形成循环等待，这样就能找到死锁产生的原因了。</p>
<p style="line-height:26px;margin:0px 0px 16px;font-weight:400;box-sizing:border-box;font-size:16px;color:rgb(79, 79, 79);padding:0px;text-align:justify;margin-top:0px;margin-bottom:0px;padding-top:5px;padding-bottom:5px;">
好了，以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，上述分析都是基于经验的推断，希望其他小伙伴们能够指出当中的错误以及不足指出，谢谢大家对脚本之家的支持。</p>
</div>
                </div>
                    </div>
        
    </div></span></div></div></div></div><br/></div></span>
</div></body></html> 