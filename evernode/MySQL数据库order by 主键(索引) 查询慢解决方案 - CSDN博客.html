<html>
<head>
  <title>MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="8755"/>
<h1>MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/2/6 14:23</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.csdn.net/hehexiaoxia/article/details/54585175"><i>http://blog.csdn.net/hehexiaoxia/article/details/54585175</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-size:16px;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-weight:400;box-sizing:border-box;background-color:rgb(245, 246, 247);line-height:24px;"><div style="font-weight:400;box-sizing:border-box;"><span><div style="box-shadow:rgba(0, 0, 0, 0.0470588) 0px 2px 4px 0px;background-color:rgb(255, 255, 255);">
        <h1 style="font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;margin:0px;box-sizing:border-box;padding:0px 29px;font-weight:700;color:rgb(44, 48, 51);font-size:24px;line-height:38px;">MySQL数据库order by 主键(索引) 查询慢解决方案</h1>
        <div style="margin:0px;font-weight:400;box-sizing:border-box;padding:0px 29px 8px;color:rgb(136, 136, 136);border-bottom:1px solid rgb(229, 229, 229);font-size:14px;line-height:38px;margin-top:5px;">
            <div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;float:left;">
                <span style="margin:0px;font-weight:400;box-sizing:border-box;padding:2px 6px;border:1px solid rgb(228, 235, 244);font-size:14px;color:rgb(120, 144, 156);margin-right:20px;">
                原创                </span>
                <span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;display:inline-block;color:rgb(187, 187, 187);font-size:14px;">2017年01月17日 17:30:13</span>
            </div>

            <ul style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;margin-left:26px;background-color:rgb(255, 255, 255);font-size:14px;">
                <li style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;color:rgb(187, 187, 187);">标签：</li>


                                                            <li style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=MySQL&amp;t=blog" style="outline:0px;margin:0px;padding:0px;font-weight:400;box-sizing:border-box;text-decoration:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">MySQL</a> <span style="padding:0px;font-weight:400;box-sizing:border-box;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
                                            <li style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=%E6%95%B0%E6%8D%AE%E5%BA%93&amp;t=blog" style="outline:0px;margin:0px;padding:0px;font-weight:400;box-sizing:border-box;text-decoration:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">数据库</a> </li>
                                    
            <span style="font-weight:400;list-style:none;font-size:14px;height:0px;visibility:hidden;display:block;clear:both;">.</span></ul>
            <ul style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:right;margin-top:5px;">
                <li style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;list-style:none;float:left;margin-left:30px;line-height:28px;"></li>
                
                
            </ul>
        <span style="font-weight:400;color:rgb(136, 136, 136);font-size:14px;line-height:38px;height:0px;visibility:hidden;display:block;clear:both;">.</span></div>
        <div style="margin:0px;font-weight:400;box-sizing:border-box;padding:20px 30px 0px;margin-bottom:30px;color:rgb(69, 69, 69);overflow:hidden;">
                            <div style="margin:0px;padding:0px;box-sizing:border-box;font-weight:400;font-size:16px;line-height:26px;text-align:justify;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;color:rgb(79, 79, 79);">
                        
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">今天遇到个奇葩的问题，应用主键排序速度奇慢无比，经过不懈的努力，终于找到了问题的原因。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><strong style="box-sizing:border-box;font-weight:700;">一、错误现象</strong></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">template表：</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center.png" type="image/png" data-filename="Center.png" alt="" height="117" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="666"/><br style="box-sizing:border-box;"/></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">索引：索引名随便起的，O(∩_∩)O哈哈~</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center [1].png" type="image/png" data-filename="Center.png" alt="" height="101" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="860"/><br style="box-sizing:border-box;"/></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">查询语句：</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"></p>
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[html]</b> <a href="http://blog.csdn.net/hehexiaoxia/article/details/54585175#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://csdnimg.cn/release/phoenix/production/../images/ico_plain.gif&quot;);" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="http://blog.csdn.net/hehexiaoxia/article/details/54585175#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://csdnimg.cn/release/phoenix/production/../images/ico_copy.gif&quot;);" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:464px;top:724px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-type:decimal-leading-zero;margin:0px;font-weight:400;box-sizing:border-box;list-style:none;border:none;padding:0px 3px 0px 10px;list-style-image:initial;border-left:3px solid rgb(108, 226, 108);background-color:rgb(255, 255, 255);color:inherit;line-height:150%;list-style-position:outside;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">select t.template_id from template t  ORDER BY t.template_id desc   </span></span></li></ol></div>数据库中数据7w多条，查询耗时在8s以上。
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><strong style="box-sizing:border-box;font-weight:700;">二、错误现象分析</strong></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">首先我们对这条sql执行查询计划：</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center [2].png" type="image/png" data-filename="Center.png" alt="" height="688" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="860"/><br style="box-sizing:border-box;"/></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;color:#cc0000;">发现这条语句应用的索引居然是key_sync_status,而不是主键，这就是问题的关键所在了！</span></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">为了进一步确定，再对下面的sql语句执行查询计划：<span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;color:#333333;background-color:rgb(255,255,255);">发现使用where条件后，索引变成了主键。</span></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center [3].png" type="image/png" data-filename="Center.png" alt="" height="688" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="860"/><br style="box-sizing:border-box;"/></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">通过以上的情况可以看出，MySQL默认的查询（没有where条件），不一定使用主键，由于MySQL的每一条简单查询只应用一个索引，所以，这个时候使用order by 主键，主键的索引功能失效。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><strong style="box-sizing:border-box;font-weight:700;">三、解决方案</strong></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">1、order by 索引（where条件中引用的索引）。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">2、强制使用主键：FORCE INDEX(PRI)，如果想强制使用索引，则用FORCE INDEX(索引名)。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"></p>
<div style="overflow-x:auto;text-align:left;font-weight:400;box-sizing:border-box;position:relative;overflow-y:hidden;padding:0px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;font-size:12px;background-color:rgb(231, 229, 220);width:99%;padding-top:1px;margin:18px 0px;"><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;padding-left:45px;"><div style="font-size:9px;margin:0px;line-height:normal;font-weight:normal;font-style:normal;font-variant:normal;font-stretch:normal;padding:3px 8px 10px 10px;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);"><b style="box-sizing:border-box;">[html]</b> <a href="http://blog.csdn.net/hehexiaoxia/article/details/54585175#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://csdnimg.cn/release/phoenix/production/../images/ico_plain.gif&quot;);" title="view plain">view plain</a><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> <a href="http://blog.csdn.net/hehexiaoxia/article/details/54585175#" style="font-size:9px;color:rgb(160, 160, 160);margin:0px;padding:1px;font-weight:400;box-sizing:border-box;text-decoration:none;background:0px 0px;border:none;outline:0px;background-color:inherit;margin-right:10px;background-repeat:no-repeat;background-position:left top;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-image:url(&quot;http://csdnimg.cn/release/phoenix/production/../images/ico_copy.gif&quot;);" title="copy">copy</a><div style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;position:absolute;left:464px;top:2671px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;visibility:hidden;background-color:rgb(255, 255, 255);"></div></div></span><span style="margin:0px;padding:0px;font-weight:400;box-sizing:border-box;"> </span></div></div><ol start="1" style="font-weight:400;box-sizing:border-box;padding:0px;list-style:decimal;border:none;background-color:rgb(255, 255, 255);color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);margin:0px 0px 1px 45px;"><li style="list-style-type:decimal-leading-zero;margin:0px;font-weight:400;box-sizing:border-box;list-style:none;border:none;padding:0px 3px 0px 10px;list-style-image:initial;border-left:3px solid rgb(108, 226, 108);background-color:rgb(255, 255, 255);color:inherit;line-height:150%;list-style-position:outside;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;"><span style="font-weight:400;box-sizing:border-box;margin:0px;padding:0px;border:none;color:rgb(0, 0, 0);background-color:inherit;">select t.template_id from template t FORCE INDEX(pri) ORDER BY t.template_id desc  </span></span></li></ol></div><strong style="box-sizing:border-box;font-weight:700;">四、其他order by 索引失效的原因分析</strong>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">1、MySQL每天一条简单语句只应用一个索引，所以order by的字段要在索引之中，并且和where条件可以合并成组合索引。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">例如：下面情况会应用组合索引。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center [4].png" type="image/png" data-filename="Center.png" alt="" height="361" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="776"/><br style="box-sizing:border-box;"/>
2、select的字段，必须是索引字段。（主键查询除外）</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">例如：下面情况不会应用组合索引。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><img src="MySQL数据库order by 主键(索引) 查询慢解决方案 - CSDN博客_files/Center [5].png" type="image/png" data-filename="Center.png" alt="" height="358" style="border:0px;outline:0px;box-sizing:border-box;max-width:100%;margin:0px 0px 24px;" width="860"/><br style="box-sizing:border-box;"/></p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">3、如果sql语句为复合语句，包含子查询等，可以把语句分解成简单查询来分析。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);">以上。</p>
<p style="box-sizing:border-box;margin:0px 0px 16px;padding:0px;font-weight:400;font-size:16px;line-height:26px;text-align:justify;color:rgb(79, 79, 79);"><br style="box-sizing:border-box;"/></p>
                </div>
                    </div>
    </div></span></div></div></div></div><br/></div></span>
</div></body></html> 