<html>
<head>
  <title>Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="10689"/>
<h1>Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/3/7 11:54</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.cnblogs.com/moss_tan_jun/p/6021822.html"><i>http://www.cnblogs.com/moss_tan_jun/p/6021822.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div><div style="font-family:'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;background-color:rgb(217, 214, 203);font-size:14px;"><table style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;background-color:rgb(255, 255, 255);"><tbody><tr><td style="font-size:12px;vertical-align:top;background-color:rgb(255, 255, 255);"><div><div><div><div style="line-height:1.5;"><div style="word-break:break-word;"><p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;"><span style="font-size:15px;">  为了优化SQL语句的排序性能，最好的情况是避免排序，合理利用索引是一个不错的方法。因为索引本身也是有序的，如果在需要排序的字段上面建立了合适的索引，那么就可以跳过排序的过程，提高SQL的查询速度。下面我通过一些典型的SQL来说明哪些SQL可以利用索引减少排序，哪些SQL不能。假设t1表存在索引key1(key_part1,key_part2),key2(key2)</span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:16px;color:#ff0000;">a.可以利用索引避免排序的SQL</span></p>
<div>
<div>
<div style="width:100%;margin:1em 0px;position:relative;overflow:auto;font-size:1em;background-color:rgb(255, 255, 255);">
<table border="0" cellpadding="0" cellspacing="0" style="padding:0px;display:block;word-break:break-word;font-variant:inherit;border-collapse:collapse;width:1093px;height:64px;text-align:left;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;font-weight:normal;position:static;right:auto;bottom:auto;top:auto;vertical-align:baseline;border:0px;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;min-height:auto;background:none;border-radius:0px;font-style:normal;font-size:12px;">
<tbody style="right:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;">
<tr style="right:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;">
<td style="text-align:left;white-space:nowrap;border-collapse:collapse;vertical-align:baseline;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;height:auto;bottom:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;border-radius:0px;color:rgb(175, 175, 175);width:35px;">
<div style="top:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;font-size:12px;border:0px;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;line-height:1.8em;white-space:normal;border-right-width:2px;border-right-style:solid;border-right-color:rgb(108, 226, 108);background-color:rgb(244, 244, 244);text-align:right;padding:0px 0.5em;">1</div>
<div style="top:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;font-size:12px;border:0px;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;line-height:1.8em;white-space:normal;background-color:rgb(255, 255, 255);border-right-width:2px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em;">2</div>
<div style="top:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;font-size:12px;border:0px;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;line-height:1.8em;white-space:normal;border-right-width:2px;border-right-style:solid;border-right-color:rgb(108, 226, 108);background-color:rgb(244, 244, 244);text-align:right;padding:0px 0.5em;">3</div>
<div style="top:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;font-size:12px;border:0px;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;line-height:1.8em;white-space:normal;background-color:rgb(255, 255, 255);border-right-width:2px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em;">4</div>
</td>
<td style="text-align:left;white-space:nowrap;border-collapse:collapse;top:auto;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;height:auto;vertical-align:baseline;bottom:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;border-radius:0px;width:auto;">
<div style="right:auto;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:auto;border:0px;text-align:left;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;background:none;position:relative;">
<div style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;line-height:1.8em;white-space:normal;background-color:rgb(244, 244, 244);padding:0px 1em;"><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">SELECT</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">* </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">FROM</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">t1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">ORDER</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">BY</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part1,key_part2;</code></div>
<div style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;line-height:1.8em;white-space:normal;background-color:rgb(255, 255, 255);padding:0px 1em;"><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">SELECT</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">* </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">FROM</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">t1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">WHERE</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part1 = constant </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">ORDER</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">BY</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part2;</code></div>
<div style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;line-height:1.8em;white-space:normal;background-color:rgb(244, 244, 244);padding:0px 1em;"><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">SELECT</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">* </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">FROM</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">t1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">WHERE</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part1 &gt; constant </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">ORDER</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">BY</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">ASC</code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">;</code></div>
<div style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;background:none;margin:0px;outline:0px;overflow:visible;min-height:auto;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;line-height:1.8em;white-space:normal;background-color:rgb(255, 255, 255);padding:0px 1em;"><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">SELECT</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">* </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">FROM</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">t1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">WHERE</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part1 = constant1 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:gray;">AND</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part2 &gt; constant2 </code><code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">ORDER</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:12px;min-height:auto;white-space:normal;font-weight:normal;color:rgb(0, 0, 255);">BY</code> <code style="text-align:left;border-radius:0px;bottom:auto;float:none;height:auto;left:auto;line-height:1.8em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;vertical-align:baseline;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:12px;min-height:auto;background:none;white-space:normal;color:rgb(0, 0, 0);">key_part2;</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:16px;color:#ff0000;">b.不能利用索引避免排序的SQL</span></p>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse;font-size:inherit;font-style:inherit;font-variant:inherit;height:167px;font-weight:inherit;width:1069px;word-break:break-word;border:1px solid silver;display:block;overflow:scroll;">
<tbody>
<tr>
<td style="font-size:12px;border:1px solid silver;border-collapse:collapse;padding:3px;white-space:nowrap;">
<div>1</div>
<div>2</div>
<div>3</div>
<div>4</div>
<div>5</div>
<div>6</div>
<div>7</div>
<div>8</div>
<div>9</div>
<div>10</div>
<div>11</div>
</td>
<td style="font-size:12px;border:1px solid silver;border-collapse:collapse;padding:3px;white-space:nowrap;">
<div>
<div><code>//排序字段在多个索引中，无法使用索引排序</code></div>
<div><code>SELECT</code> <code>* </code><code>FROM</code> <code>t1 </code><code>ORDER</code> <code>BY</code> <code>key_part1,key_part2, key2;</code></div>
<div> </div>
<div><code>//排序键顺序与索引中列顺序不一致，无法使用索引排序</code></div>
<div><code>SELECT</code> <code>* </code><code>FROM</code> <code>t1 </code><code>ORDER</code> <code>BY</code> <code>key_part2, key_part1;</code></div>
<div> </div>
<div><code>//升降序不一致，无法使用索引排序</code></div>
<div><code>SELECT</code> <code>* </code><code>FROM</code> <code>t1 </code><code>ORDER</code> <code>BY</code> <code>key_part1 </code><code>DESC</code><code>, key_part2 </code><code>ASC</code><code>;</code></div>
<div> </div>
<div><code>//key_part1是范围查询，key_part2无法使用索引排序</code></div>
<div><code>SELECT</code> <code>* </code><code>FROM</code> <code>t1 </code><code>WHERE</code> <code>key_part1&gt; constant </code><code>ORDER</code> <code>BY</code> <code>key_part2;</code></div>
</div>
</td>
</tr>
</tbody>
</table>
<p style="margin:10px auto;text-indent:0px;"><span style="color:#800000;"><strong><span style="font-size:18px;">2.排序实现的算法</span></strong><br/>     <span style="font-size:16px;"> 对于不能利用索引避免排序的SQL，数据库不得不自己实现排序功能以满足用户需求，此时<strong>SQL的执行计划中会出现“Using filesort”，这里需要注意的是filesort并不意味着就是文件排序，其实也有可能是内存排序，这个主要由sort_buffer_size参数与结果集大小确定</strong>。<span style="color:#ff0000;">MySQL内部实现排序主要有3种方式，<strong>常规排序，优化排序和优先队列排序</strong>，主要涉及<strong>3种排序算法：快速排序、归并排序和堆排序</strong>。</span></span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:16px;">假设表结构和SQL语句如下：</span></p>
<div style="border:1px solid rgb(204, 204, 204);padding:5px;overflow:auto;margin:5px 0px;color:rgb(0, 0, 0);background-color:rgb(245, 245, 245);max-width:900px;font-family:'Courier New';font-size:12px;">
<pre style="margin:0px 0px 0px 22px;word-wrap:break-word;white-space:pre-wrap;font-family:'Courier New';font-size:12px;">CREATE TABLE t1(id int, col1 varchar(64), col2 varchar(64), col3 varchar(64), PRIMARY KEY(id),key(col1,col2));
SELECT col1,col2,col3 FROM t1 WHERE col1&gt;100 ORDER BY col2;</pre>
</div>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:16px;color:#ff0000;">a.常规排序，双路排序<br/><span style="font-size:15px;">(1).从表t1中获取满足WHERE条件的记录<br/><span style="font-size:15px;">(2).对于每条记录，将记录的<strong>主键+排序键(id,col2)取出放入sort buffer</strong><br/><span style="font-size:15px;">(3).如果<strong>sort buffer可以存放</strong>所有满足条件的(id,col2)对，则进行排序；<strong>否则</strong>sort buffer满后，进行排序并<strong>写到临时文件中</strong>。(排序算法采用的是快速排序算法)<br/><span style="font-size:15px;">(4).若排序中<strong>产生了临时文件</strong>，需要利用<strong>归并排序</strong>算法，保证临时文件中记录是有序的<br/><span style="font-size:15px;">(5).循环执行上述过程，直到所有满足条件的记录全部参与排序<br/><span style="font-size:15px;">(6).<strong>扫描</strong>排好序的(id,col2)队，即<strong>sort buffer</strong>，并<strong>利用主键id去取SELECT需要返回的其他列</strong>(col1,col2,col3)<br/><span style="font-size:15px;">(7).将获取的结果集返回给用户。<br/><span style="font-size:15px;">      <span style="color:#ff0000;">从上述流程来看，<strong>是否使用文件排序主要看sort buffer是否能容下需要排序的(id,col2)的结果集，这个buffer的大小由sort_buffer_size参数控制</strong>。此外一次排序<strong>还需要两次IO</strong>，<strong>一次是取排序字段(id,col2)到sort buffer中，第二次是通过上面取出的主键id再来取其他所需要返回列</strong>(col1,col2,col3)，由于<strong>返回的结果集是按col2排序，因此id是乱序的</strong>，通过乱序的id取(col1,col2,col3)时会产生大量的随机IO。对于第二次IO取MySQL本身会优化，即在取之前<strong>先将主键id排序，并放入缓冲区</strong>，这个缓存区大小由参数<strong>read_rnd_buffer_size</strong>控制，然后有序去取记录，<strong>将随机IO转为顺序IO</strong>。<br/><span style="font-size:16px;color:#ff0000;">b.优化排序，单路排序，max_length_for_sort_data<br/>    <span style="font-size:15px;"> 常规排序方式除了排序本身，还需要额外两次IO。<strong>优化排序方式相对于常规排序，减少了第二次IO</strong>。<strong>主要区别在于，一次性取出sql中出现的所有字段放入sort buffer中而不是只取排序需要的字段</strong>(id,col2)。由于<strong>sort buffer中包含了查询需要的所有字段</strong>，因此<strong>排序完成后可以直接返回，无需二次取数据</strong>。这种方式的<strong>代价</strong>在于，同样大小的sort buffer，能存放的(col1,col2,col3)数目要小于(id,col2)，如果<strong>sort buffer不够大，可能导致需要写临时文件，造成额外的IO</strong>。当然MySQL提供了参数<strong>max_length_for_sort_data</strong>，只有当<strong>排序sql里出现的所有字段小于max_length_for_sort_data时，才能利用优化排序方式，否则只能用常规排序方式。</strong><br/><span style="font-size:16px;color:#ff0000;">c.优先队列排序<br/>     <span style="font-size:15px;">为了得到最终的排序结果，我们都需要将所有满足条件的记录进行排序才能返回。那么相对于优化排序方式，是否还有优化空间呢？<span style="color:#ff0000;"><strong>5.6版本针对Order by limit M，N语句，在空间层面做了优化，加入了一种新的排序方式--优先队列，这种方式采用堆排序实现</strong>。堆排序算法特征正好可以解<strong>limit M,N</strong> 这类排序的问题，虽然仍然需要所有字段参与排序，但是<strong>只需要M+N个元组的sort buffer空间即可</strong>，对于M，N很小的场景，基本<strong>不会因为sort buffer不够而导致需要临时文件进行归并排序的问题</strong>。对于升序，采用大顶堆，最终堆中的元素组成了最小的N个元素，对于降序，采用小顶堆，最终堆中的元素组成了最大的N的元素。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="color:#800000;"><strong><span style="font-size:18px;">3.排序不一致问题</span></strong></span></p>
<p style="margin:10px auto;text-indent:0px;"><strong><span style="font-size:16px;color:#ff0000;">案例1：</span></strong><span style="font-size:15px;color:#ff0000;">order by no_index limit n在MySQL5.5和5.6中的不一致</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;"><strong>MySQL从5.5迁移到5.6以后，发现分页出现了重复值</strong>（排序字段没有用索引，或则直接是全表扫描），MariaDB已经是优化后的方案，和5.6一致。</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">问题源头：<a href="https://bbs.aliyun.com/read/248026.html" style="text-decoration:none;color:rgb(29, 88, 209);" target="_blank">https://bbs.aliyun.com/read/248026.html</a>，解决办法：<a href="http://mysql.taobao.org/monthly/2015/06/04/" style="text-decoration:none;color:rgb(29, 88, 209);" target="_blank">http://mysql.taobao.org/monthly/2015/06/04/</a></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">测试表与数据：</span></p>
<div style="border:1px solid rgb(204, 204, 204);padding:5px;overflow:auto;margin:5px 0px;color:rgb(0, 0, 0);background-color:rgb(245, 245, 245);max-width:900px;font-family:'Courier New';font-size:12px;"><div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a href="#" style="text-decoration:none;color:rgb(29, 88, 209);border:none;background-color:rgb(245, 245, 245);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode.gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="height:auto;max-width:300px;border:none;background-color:rgb(245, 245, 245);" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [1].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [2].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<pre style="margin:0px 0px 0px 22px;word-wrap:break-word;white-space:pre-wrap;font-family:'Courier New';font-size:12px;">create table t1(id int primary key, c1 int, c2 varchar(128));
insert into t1 values(1,1,'a');
insert into t1 values(2,2,'b');
insert into t1 values(3,2,'c');
insert into t1 values(4,2,'d');
insert into t1 values(5,3,'e');
insert into t1 values(6,4,'f');
insert into t1 values(7,5,'g');</pre>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [3].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [4].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a href="#" style="text-decoration:none;color:rgb(29, 88, 209);border:none;background-color:rgb(245, 245, 245);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [5].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="height:auto;max-width:300px;border:none;background-color:rgb(245, 245, 245);" width="20"/></a></span></div></div>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">假设每页3条记录，第一页limit 0,3和第二页limit 3,3查询结果如下：</span></p>
<p style="margin:10px auto;text-indent:0px;"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/176539-20160322073833776-1421601293.png" type="image/png" data-filename="176539-20160322073833776-1421601293.png" alt="" height="247" style="border:0px;height:auto;max-width:300px;" width="383"/></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">我们可以看到 id为4的这条记录居然同时出现在两次查询中，这明显是不符合预期的，而且在5.5版本中没有这个问题。</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">使用<span style="color:#ff0000;"><strong>优先队列排序<span style="color:#000000;">的目的</span></strong>就是在不能使用索引有序性的时候，如果要<strong>排序，并且使用了limit n</strong>，那么只需要在排序的过程中，<strong>保留n条记录即可，这样虽然不能解决所有记录都需要排序的开销，但是只需要 sort buffer 少量的内存就可以完成排序，上面已经说明。</strong></span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">之所以<span style="color:#ff0000;"><strong>MySQL5.6</strong>出现了第二页数据重复的问题，是因为<span style="color:#ff0000;"><strong>使用了优先队列排序，其使用了堆排序的排序方法</strong>，而<span style="color:#ff0000;"><strong>堆排序是一个不稳定的排序方法，也就是相同的值（例子中的值2）可能排序出来的数据和读出来的数据顺序不一致，无法保证排序前后数据位置的一致，所以导致分页重复的现象</strong>。</span></span></span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">为了避免这个问题，有几种方法：</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;line-height:22.5px;">①：索引排序字段</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;line-height:22.5px;">利用索引的有序性，在字段添加上索引，就直接按照索引的有序性进行读取并分页，从而可以规避遇到的这个问题。</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">②：利用多列索引，对于单列相同无法排序的，利用其主键进行排序：</span></p>
<div style="border:1px solid rgb(204, 204, 204);padding:5px;overflow:auto;margin:5px 0px;color:rgb(0, 0, 0);background-color:rgb(245, 245, 245);max-width:900px;font-family:'Courier New';font-size:12px;">
<pre style="margin:0px 0px 0px 22px;word-wrap:break-word;white-space:pre-wrap;font-family:'Courier New';font-size:12px;">select * from t1 order by c1,id asc limit 0,3;
select * from t1 order by c1,id asc limit 3,3;</pre>
</div>
<p style="margin:10px auto;text-indent:0px;"><strong><span style="font-size:16px;color:#ff0000;">案例2：</span></strong><span style="font-size:15px;color:#ff0000;">单路排序和双路排序返回结果不一样</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">两个类似的查询语句，除了<strong>返回列不同，其它都相同，但排序的结果不一致</strong>。</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">测试表与数据：</span></p>
<div style="border:1px solid rgb(204, 204, 204);padding:5px;overflow:auto;margin:5px 0px;color:rgb(0, 0, 0);background-color:rgb(245, 245, 245);max-width:900px;font-family:'Courier New';font-size:12px;"><div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a href="#" style="text-decoration:none;color:rgb(29, 88, 209);border:none;background-color:rgb(245, 245, 245);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [6].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="height:auto;max-width:300px;border:none;background-color:rgb(245, 245, 245);" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [7].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [8].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<pre style="margin:0px 0px 0px 22px;word-wrap:break-word;white-space:pre-wrap;font-family:'Courier New';font-size:12px;">create table t2(id int primary key, status int, c1 varchar(255),c2 varchar(255),c3 varchar(255),key(c1));
insert into t2 values(7,1,'a',repeat('a',255),repeat('a',255));
insert into t2 values(6,2,'b',repeat('a',255),repeat('a',255));
insert into t2 values(5,2,'c',repeat('a',255),repeat('a',255));
insert into t2 values(4,2,'a',repeat('a',255),repeat('a',255));
insert into t2 values(3,3,'b',repeat('a',255),repeat('a',255));
insert into t2 values(2,4,'c',repeat('a',255),repeat('a',255));
insert into t2 values(1,5,'a',repeat('a',255),repeat('a',255));</pre>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [9].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a style="text-decoration:none;color:rgb(29, 88, 209);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [10].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="border:0px;height:auto;max-width:300px;" width="20"/></a></span></div>
<div style="margin-top:5px;background-color:rgb(245, 245, 245);"><span style="padding-right:5px;font-family:'Courier New';font-size:12px;line-height:1.5;"><a href="#" style="text-decoration:none;color:rgb(29, 88, 209);border:none;background-color:rgb(245, 245, 245);" title="复制代码"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/copycode [11].gif" type="image/gif" data-filename="copycode.gif" alt="复制代码" height="20" style="height:auto;max-width:300px;border:none;background-color:rgb(245, 245, 245);" width="20"/></a></span></div></div>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">分别执行SQL语句：</span></p>
<div style="border:1px solid rgb(204, 204, 204);padding:5px;overflow:auto;margin:5px 0px;color:rgb(0, 0, 0);background-color:rgb(245, 245, 245);max-width:900px;font-family:'Courier New';font-size:12px;">
<pre style="margin:0px 0px 0px 22px;word-wrap:break-word;white-space:pre-wrap;font-family:'Courier New';font-size:12px;">select id,status,c1,c2 from t2 force index(c1) where c1&gt;='b' order by status;
select id,status from t2 force index(c1) where c1&gt;='b' order by status;</pre>
</div>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">执行结果如下：</span></p>
<p style="margin:10px auto;text-indent:0px;"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/176539-20160322074157183-294517531.png" type="image/png" data-filename="176539-20160322074157183-294517531.png" alt="" height="413" style="border:0px;height:auto;max-width:300px;" width="656"/></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">看看两者的执行计划是否相同</span></p>
<p style="margin:10px auto;text-indent:0px;"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/176539-20160322074543745-293825930.png" type="image/png" data-filename="176539-20160322074543745-293825930.png" alt="" height="227" style="border:0px;height:auto;max-width:300px;" width="865"/></p>
<p style="margin:10px auto;text-indent:0px;">    <span style="font-size:15px;">为了说明问题，因为测试数据不多，确保能走上c1列索引，加了force index的hint。语句通过c1列索引取id，然后去表中捞取返回的列。根据c1列值的大小，记录在c1索引中的相对位置如下：</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">(c1,id)&lt;===&gt;(b,6),(b,3),(c,5),(c,2)，</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">对应的status值分别为2,3,2,4。从表中取数据并按status排序，则相对位置变为(6,2,b),(5,2,c),(3,3,b),(2,4,c)，这就是第二条语句查询返回的结果，那么为什么第一条查询语句(6,2,b),(5,2,c)是调换顺序的呢？</span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">这里说明下：<br/><span style="font-size:15px;">1. Query 语句所取出的字段类型大小总和小于max_length_for_sort_data 。<br/><span style="font-size:15px;">2. 排序的字段不包含TEXT和BLOB类型。</span></span></span></p>
<p style="margin:10px auto;text-indent:0px;"><span style="font-size:15px;">之前提到的<strong>优化排序</strong>就可以明白了：由于<strong>第一条查询返回的列的字节数超过了max_length_for_sort_data</strong>，导致排序<strong>采用常规排序</strong>，而在这种情况下第二次IO时，<strong>MYSQL本身优化会对id排序，将随机IO转为顺序IO</strong>，所以返回的先是5，后是6；而<strong>第二条查询采用的是优化排序，没有第二次取数据的过程，保持了排序后记录的相对位置，直接在sort buffer里取出</strong>。对于第一条语句，若想采用优化排序，我们将max_length_for_sort_data设置调大即可，比如2048。</span></p>
<p style="margin:10px auto;text-indent:0px;"><img src="Mysql 排序优化与索引使用（转) - moss_tan_jun - 博客园_files/176539-20160322080653573-1073249606.png" type="image/png" data-filename="176539-20160322080653573-1073249606.png" alt="" height="312" style="border:0px;height:auto;max-width:300px;" width="538"/></p></div></div></div></div></div></td></tr></tbody></table></div></div></div><br/></div></span>
</div></body></html> 