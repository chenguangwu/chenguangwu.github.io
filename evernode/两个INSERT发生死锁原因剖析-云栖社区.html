<html>
<head>
  <title>两个INSERT发生死锁原因剖析-云栖社区</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3279"/>
<h1>两个INSERT发生死锁原因剖析-云栖社区</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/10/22 22:45</i></td></tr>
<tr><td><b>标签：</b></td><td><i>微信</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://m.aliyun.com/yunqi/articles/198655"><i>https://m.aliyun.com/yunqi/articles/198655</i></a></td></tr>
</table>
</div>
<br/>

<div><span style="margin:0px;"><div style="margin:0;padding:0;font-family:PingFang-SC-Regular,STHeiTi,Arial,sans-serif;box-sizing:border-box;background:#eaeaea"><div style="margin:0;padding:0;box-sizing:border-box"><div style="margin:0;box-sizing:border-box;background:#fff;padding:.53333333rem"><h3 style="margin:0;padding:0;font-weight:500;box-sizing:border-box;color:#333;font-size:.53333333rem;line-height:.8rem">两个INSERT发生死锁原因剖析</h3><p style="margin:0;padding:0;box-sizing:border-box"><span style="box-sizing:border-box;color:#999ba4;font-size:.4rem;line-height:.82666667rem">1年前 </span><span style="box-sizing:border-box;float:right"><i style="box-sizing:border-box;float:left;vertical-align:center;margin-top:.26666667rem;display:inline-block;height:.29333333rem;width:.42666667rem;font-size:.4rem;background:url(https://g.alicdn.com/aliyun/m-aliyun-yunqi/1.0.24/images/eye-icon_530b125754208571f11f17c9c25221a7.png) 50% no-repeat;background-size:.42666667rem .29333333rem"></i><span style="box-sizing:border-box;float:left;padding-left:.13333333rem;font-size:.4rem;color:#999;line-height:.82666667rem">2121</span></span></p><div style="margin:0;padding:0;box-sizing:border-box;font-size:.45333333rem;line-height:.8rem;color:#333;width:100%;word-wrap:break-word;overflow:hidden"><span style="box-sizing:border-box"></span><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">两个INSERT也能发生死锁？貌似不可思议，实际上是正常的。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">本文整理过程中，先后向高鹏、王少华、苏斌等几位朋友请教确认，感谢。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">开始之前，关于锁、死锁，我们要先统一下几点认知：</p><ul style="margin:0;padding:0;list-style:none;box-sizing:border-box;list-style-type:disc;list-style-position:inside"><li style="margin:0;padding:0;box-sizing:border-box">死锁是由于多个事务相互持有其他事务所需要的锁，结果导致事务都无法继续，进而触发死锁检测，其中某个事务会被回滚，释放相应的锁，其他事务得以正常继续；简言之，就是多个事务之间的锁等待产生了回路，死循环了；</li><li style="margin:0;padding:0;box-sizing:border-box">死锁发生时，会立刻被检测到，并且回滚其中某个事务，而不会长时间阻塞、等待；</li><li style="margin:0;padding:0;box-sizing:border-box">从MySQL 5.7.15开始，新增选项 innodb_deadlock_detect，没记错的话应该是阿里团队率先实现的。当它设置为 OFF 时（默认值是 ON），InnoDB会不检测死锁，在高并发场景（例如“秒杀”）业务中特别有用，可以有效提高事务并发性能；</li><li style="margin:0;padding:0;box-sizing:border-box">在启用死锁检测时，InnoDB默认的最大检测深度为200，在上面提到的高并发高竞争场景下，在热点数据上的锁等待队列可能很长，死锁检测代价很大。或者当等待队列中所有的行锁总数超过 100万 时，也会被认为认为发生死锁了，直接触发死锁检测处理机制；</li><li style="margin:0;padding:0;box-sizing:border-box">InnoDB行锁等待超时默认为50秒，一般建议设置5-10秒就够了；</li><li style="margin:0;padding:0;box-sizing:border-box">有时候，可能会口误把 长时间的行锁等待 说成是 死锁，其实二者完全不一样，不要犯这种常识性口误。</li></ul><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">好了，正式开始今天的案例。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">先看测试表DDL：</p><pre style="margin:0;padding:0;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace"><code style="margin:0;padding:0;font-style:normal;font-weight:500;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace">yejr@imysql.com [yejr]&gt;show create table d\G ********************** 1. row ********************** Table: d Create Table: CREATE TABLE `d` ( `i` int(11) NOT NULL DEFAULT '0', PRIMARY KEY (`i`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4; yejr@imysql.com [yejr]&gt;select * from d; +---+ | i | +---+ | 1 | +---+</code></pre><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">然后我们执行下面的测试：</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em"><span style="box-sizing:border-box"><br style="box-sizing:border-box"/><img src="两个INSERT发生死锁原因剖析-云栖社区_files/088005973539b4f851a9deda736f788f1d16d742.png" type="image/png" data-filename="088005973539b4f851a9deda736f788f1d16d742.png" alt="image" style="border:0;box-sizing:border-box;height:auto;max-width:100%" title="image"/></span></p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em"><br style="box-sizing:border-box"/>这时候我们看下InnoDB STATUS的输出：</p><pre style="margin:0;padding:0;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace"><code style="margin:0;padding:0;font-style:normal;font-weight:500;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace">------------------------ LATEST DETECTED DEADLOCK ------------------------ 2017-09-02 14:59:08 0x700004208000 *** (1) TRANSACTION: TRANSACTION 274616, ACTIVE 12 sec inserting mysql tables in use 1, locked 1 LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s) MySQL thread id 16, OS thread handle 123145373167616, query id 398 localhost root executing insert into d select 1 *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 510 page no 3 n bits 72 index PRIMARY of table `yejr`.`d` trx id 274616 lock_mode X locks rec but not gap waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 32 0: len 4; hex 80000001; asc ;; 1: len 6; hex 0000000430b3; asc 0 ;; 2: len 7; hex 3b0000018027a4; asc ; ' ;; *** (2) TRANSACTION: TRANSACTION 274617, ACTIVE 4 sec inserting mysql tables in use 1, locked 1 3 lock struct(s), heap size 1136, 2 row lock(s) MySQL thread id 18, OS thread handle 123145371549696, query id 400 localhost root executing insert into d select 1 *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 510 page no 3 n bits 72 index PRIMARY of table `yejr`.`d` trx id 274617 lock mode S(想想，哪里冒出来的S锁？)Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 32 0: len 4; hex 80000001; asc ;; 1: len 6; hex 0000000430b3; asc 0 ;; 2: len 7; hex 3b0000018027a4; asc ; ' ;; *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 510 page no 3 n bits 72 index PRIMARY of table `yejr`.`d` trx id 274617 lock_mode X locks rec but not gap waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 32 0: len 4; hex 80000001; asc ;; 1: len 6; hex 0000000430b3; asc 0 ;; 2: len 7; hex 3b0000018027a4; asc ; ' ;; *** WE ROLL BACK TRANSACTION (2)</code></pre><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">从上面这个输出来看，我们看到的现场是两个 insert 请求发生了死锁。单纯看这2个SQL的话，应该是产生锁等待才对，而不是死锁。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">按照我们常规理解，session1 未 commit 前，应该是持有 i=1 上的record lock(X)，而session2 和 session3 则都在等待这个锁的释放。而实际上呢，肯定不是这样的，否则也不至于发生死锁了。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">关于InnoDB行锁更详细的知识点我们以后找时间再说。这次的案例其实在MySQL官方文档上已经解释过了，而且也给了演示案例（如本例）。文档中是这么说的：</p><pre style="margin:0;padding:0;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace"><code style="margin:0;padding:0;font-style:normal;font-weight:500;box-sizing:border-box;font-family:Menlo,Monaco,Consolas,Courier New,monospace">INSERT sets an exclusive lock on the inserted row. This lock is an index-record lock, not a next-key lock (that is, there is no gap lock) and does not prevent other sessions from inserting into the gap before the inserted row. Prior to inserting the row, a type of gap lock called an insert intention gap lock is set. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6 each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting. 【敲黑板、划重点】If a duplicate-key error occurs, a shared lock on the duplicate index record is set. This use of a shared lock can result in deadlock should there be multiple sessions trying to insert the same row if another session already has an exclusive lock. This can occur if another session deletes the row. </code></pre><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">划重点的核心内容是：当需要进行唯一性冲突检测时，需要先加一个 S 锁。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">这样的话，上面案例的加锁过程就不是之前推测的那样，而是像下面这样了：<br style="box-sizing:border-box"/><span style="box-sizing:border-box"><br style="box-sizing:border-box"/><img src="两个INSERT发生死锁原因剖析-云栖社区_files/347bc4c468ee6f58b707c5c9e6626bcddf5c1811.png" type="image/png" data-filename="347bc4c468ee6f58b707c5c9e6626bcddf5c1811.png" alt="image" style="border:0;box-sizing:border-box;height:auto;max-width:100%" title="image"/></span></p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em"><br style="box-sizing:border-box"/>下面是另一个类似的案例：</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em"><span style="box-sizing:border-box"><br style="box-sizing:border-box"/><img src="两个INSERT发生死锁原因剖析-云栖社区_files/344e8a49c752e80511379993e3a0b0165d65185e.png" type="image/png" data-filename="344e8a49c752e80511379993e3a0b0165d65185e.png" alt="image" style="border:0;box-sizing:border-box;height:auto;max-width:100%" title="image"/></span></p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em"><br style="box-sizing:border-box"/>通过上面这两个案例，其实想要告诉大家的是：发生死锁时，不能只看现场，还得分析过程，才能知道真正的原因，死锁发生的原因也并不复杂，但是得能想办法还原过程。</p><p style="padding:0;box-sizing:border-box;clear:both;margin:.13333333rem 0;margin-bottom:1.2em">原文发布时间为：2017-09-05<br style="box-sizing:border-box"/>本文来自云栖社区合作伙伴“老叶茶馆”，了解相关信息可以关注“老叶茶馆”微信公众号</p></div><p style="margin:0;padding:0;box-sizing:border-box;padding-top:.26666667rem"><a href="https://m.aliyun.com/yunqi/tags/tagid_389" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">mysql</a><a href="https://m.aliyun.com/yunqi/tags/tagid_390" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">innodb</a><a href="https://m.aliyun.com/yunqi/tags/tagid_636" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">高并发</a><a href="https://m.aliyun.com/yunqi/tags/tagid_1268" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">lock</a><a href="https://m.aliyun.com/yunqi/tags/tagid_1700" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">Transaction</a><a href="https://m.aliyun.com/yunqi/tags/tagid_2134" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">index</a><a href="https://m.aliyun.com/yunqi/tags/tagid_2304" style="text-decoration:none;box-sizing:border-box;display:inline-block;margin-right:.26666667rem;font-size:.34666667rem;-webkit-border-radius:0.5333333333333333rem;-webkit-background-clip:padding-box;-moz-border-radius:0.5333333333333333rem;-moz-background-clip:padding;border-radius:0.5333333333333333rem;background-clip:padding-box;padding:0 .26666667rem;border:1px solid #ccc;color:#666;min-height:.66666667rem;line-height:.66666667rem;margin-bottom:.4rem">thread</a></p><dl style="margin:0;padding:0;box-sizing:border-box;text-align:center"><dl style="margin:0;padding:0;box-sizing:border-box;text-align:center"></dl></dl></div><div style="margin:0;padding:0;box-sizing:border-box"><p style="margin:0;box-sizing:border-box;padding:0 .53333333rem;height:1.2rem;font-size:.4rem;color:#333;line-height:1.2rem">作者</p><dl style="margin:0;padding:0;box-sizing:border-box;background:#fff;text-align:center;padding-top:.88rem"><dt style="margin:0;padding:0;box-sizing:border-box"><img src="两个INSERT发生死锁原因剖析-云栖社区_files/avatar3.jpg@64h_64w_2e.jpg" type="image/jpeg" data-filename="avatar3.jpg@64h_64w_2e.jpg" alt="" style="border:0;box-sizing:border-box;height:1.89333333rem;width:1.89333333rem;-webkit-border-radius:50%;-webkit-background-clip:padding-box;-moz-border-radius:50%;-moz-background-clip:padding;border-radius:50%;background-clip:padding-box;overflow:hidden"/></dt><dd style="margin:0;box-sizing:border-box;line-height:.48rem;font-size:.4rem;padding:.2rem 0 .13333333rem;color:#000">技术小能手</dd><dd style="margin:0;padding:0;box-sizing:border-box;font-size:.37333333rem;line-height:.48rem"><i style="box-sizing:border-box;margin:.13333333rem 0;display:inline-block;width:.53333333rem;height:1px;background:#e5e5e5;overflow:hidden"></i><span style="box-sizing:border-box;background:#fff;padding:0 .13333333rem;color:#b0b2b7">TA的文章</span><i style="box-sizing:border-box;margin:.13333333rem 0;display:inline-block;width:.53333333rem;height:1px;background:#e5e5e5;overflow:hidden"></i></dd></dl><ul style="margin:0;list-style:none;box-sizing:border-box;padding:.26666667rem .53333333rem;background:#fff;font-size:.4rem"><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/656194" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">好好说说Java中的常量池之Class常量池</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/656192" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">利用责任链模式设计一个拦截器</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/656154" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">【Github2.2K星】PyTorch资源列表：450个NLP/CV/SP、论文实现、教程、示例</a></li></ul><p style="margin:0;box-sizing:border-box;padding:0 .53333333rem;height:1.2rem;font-size:.4rem;color:#333;line-height:1.2rem">相关文章</p><ul style="margin:0;list-style:none;box-sizing:border-box;padding:.26666667rem .53333333rem;background:#fff;font-size:.4rem;font-weight:400"><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/173635" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">MySQL锁系列（八）之 死锁</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/269774" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">&lt;转&gt;一个最不可思议的MySQL死锁分析</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/626217" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">MySQL并发时经典常见的死锁原因及解决方法</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/521530" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">Mysql并发时经典常见的死锁原因及解决方法</a></li><li style="margin:0;box-sizing:border-box;padding:.2rem 0;word-wrap:break-word;word-break:break-all"><a href="https://m.aliyun.com/yunqi/articles/528841" style="text-decoration:none;box-sizing:border-box;color:#333;font-weight:600">Mysql并发时经典常见的死锁原因及解决方法</a></li></ul></div></div></div></span>
</div></body></html> 