<html>
<head>
  <title>Activiti 中的会签通用指派</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="10355"/>
<h1>Activiti 中的会签通用指派</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2019/1/25 9:34</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.jianshu.com/p/4ca05e4651b2"><i>https://www.jianshu.com/p/4ca05e4651b2</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="font-family:sans-serif;text-size-adjust:100%;box-sizing:border-box;font-size:10px;-webkit-tap-highlight-color:transparent;"><div style="box-sizing:border-box;font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:17px;line-height:1.42857;background-color:rgb(255, 255, 255);min-width:768px;color:rgb(51, 51, 51);"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;">
        <h1 style="font-size:34px;margin:20px 0px 0px;box-sizing:border-box;font-family:-apple-system, &quot;SF UI Display&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-weight:700;line-height:1.3;color:inherit;word-break:break-word;margin-top:20px;margin-bottom:10px;">Activiti 中的会签通用指派</h1>

        
        <div style="box-sizing:border-box;margin:30px 0px 40px;">
          <a href="https://www.jianshu.com/u/06c5eb347359" style="background-color:transparent;box-sizing:border-box;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;width:48px;height:48px;display:inline-block;vertical-align:middle;">
            <img src="Activiti 中的会签通用指派_files/96.jpg" type="image/jpeg" data-filename="96.jpg" alt="96" height="46" style="border:1px solid rgb(221, 221, 221);box-sizing:border-box;vertical-align:middle;width:100%;height:100%;border-radius:50%;" width="46"/>
</a>          <div style="box-sizing:border-box;vertical-align:middle;display:inline-block;margin-left:8px;">
            <span style="box-sizing:border-box;margin-right:3px;font-size:16px;vertical-align:middle;"><a href="https://www.jianshu.com/u/06c5eb347359" style="background-color:transparent;box-sizing:border-box;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;">鑫奕航</a></span>
            
            <a style="background-color:rgb(66, 192, 46);box-sizing:border-box;color:rgb(255, 255, 255);text-decoration:none;display:inline-block;margin-bottom:0px;font-weight:400;text-align:center;vertical-align:middle;touch-action:manipulation;cursor:pointer;background-image:none;border:1px solid transparent;white-space:nowrap;padding:0px 7px 0px 5px;font-size:12px;line-height:normal;border-radius:40px;user-select:none;border-color:rgb(66, 192, 46);"><i style="box-sizing:border-box;font-size:inherit;font-style:normal;-webkit-font-smoothing:antialiased;font-family:iconfont;font-weight:400;"><span style="font-size:inherit;font-style:normal;font-family:iconfont;font-weight:400;"></span></i><span style="box-sizing:border-box;margin-left:2px;display:inline;">关注</span></a>
            
            <div style="box-sizing:border-box;margin-top:5px;font-size:12px;color:rgb(150, 150, 150);">
              
                <span style="box-sizing:border-box;padding-right:5px;" title="">2018.08.30 18:35*</span>
              <span style="box-sizing:border-box;padding-right:5px;">字数 1901</span>
            <span style="box-sizing:border-box;padding-right:5px;">阅读 382</span><span style="box-sizing:border-box;padding-right:5px;">评论 2</span><span style="box-sizing:border-box;padding-right:5px;">喜欢 3</span></div>
          </div>
          
        </div>


        
        <div style="box-sizing:border-box;color:rgb(47, 47, 47);font-size:16px;font-weight:400;line-height:1.7;word-break:break-word;">
          <div style="box-sizing:border-box;">
            <p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">今天帮群里一个伙伴解决Activiti的一个问题，花了点功夫，特此记录下来。<br style="box-sizing:border-box;"/>
在用Activiti做会签功能的时候，我们经常是使用 User Task的多实例。<br style="box-sizing:border-box;"/>
如下图所示，一个简单多任务实例的配置：</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:700px;max-height:544px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:41.370000000000005%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti 中的会签通用指派_files/webp.webp" type="image/webp" data-filename="webp.webp" height="290" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="700"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">1.png</div>
</div><br style="box-sizing:border-box;"/>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">我们必须要设置两个非常重要的变量： Collection, Element variable。 至于他们为何重要，了解会签的人都应该知道，我之所以认为他们重要，还有两个重要的原因：</p>

<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">会签一定是分配到多人的，不然也不是多实例了。否则直接做一个个人任务就好了。 Collection就是提供了一个设置多个人的方式；</li>
<li style="box-sizing:border-box;line-height:30px;">任务应该是要指派到具体的人。所以通常的会签我们直接设置assignee的表达式为${assignee}（同Element variable的值）, 这样，只要在设置了Collection 的值，引擎对集合的每个元素做遍历创建任务时，会把任务的assignee 设置好，如果按照上面的设置，那么每个任务刚好就分配给了Collection中每个用户的ID。<br style="box-sizing:border-box;"/>
再引申一下，如果不设置具体的assignee可否？ 比如我就设置所有批量任务的候选用户或者候选组。这样做是没问题的，问题在于这样做是否跟会签本身的业务意义冲突。会签应该是某一群人共同去执行同一个任务多个副本，每个人应该都能执行一份任务，至于最后完成的条件可以根据业务设定，不是非得所有全部完成。如果对于所有任务实例都设置候选用户或候选组，就意味着每个任务实例同时生成后需要候选用户去认领，这里就有两个可能： 1. 有的用户不去认领，这个任务别人也可以做；2. 一个用户可以认领多个任务并完成。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">总结一下这里想要实现的功能（这里不对会签的基本用法进行说明，假定你对会签很了解，特别是对Activiti中配置会签非常了解）：</p>
<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">不需要程序配合，直接在流程设计器里面设计会签节点就可以投入使用；</li>
<li style="box-sizing:border-box;line-height:30px;">任务的分配也是有流程设计器里面的指定。</li>
</ol>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">任务设计器中的统一配置约定：</h4>
<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">（必须）会签节点统一设置Collection(multiple-instance)为&quot;assigneeList&quot;,  Element Variable(multiple-instance) 为&quot;assignee&quot;， 至于这两个名称可以自定义，待会程序里面会用到，保持一致就可以.</li>
<li style="box-sizing:border-box;line-height:30px;">完成条件只能根据提供的几个参数来设定，如果不想让设计流程的人接触程序，只能有这么几个参数给他们使用， 如nrOfCompletedInstances 等。</li>
<li style="box-sizing:border-box;line-height:30px;">目前下面只限于一个流程中只有一个会签任务，如果有多个会签任务其实也能很方便的实现。</li>
</ol>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">实现思路：</h4>
<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">流程启动时或者通过流程实例启动事件进行监听，如果该流程定义中有会签任务，则根据会签任务配置的user, candidate user, candidate group把意图参与会签的用户找出，并把他们做为“assigneeList”的值，做为流程变量出入到流程实例中，这样能保证进入会签节点（多实例任务时），引擎能生成对应数量的任务实例；</li>
<li style="box-sizing:border-box;line-height:30px;">在会签任务节点上增加执行监听器(executionListener-创建任务时)，这样，每个任务创建好之后，会执行监听器，可以自定义设置任务的分配人员。 之前一直想使用全局的事件监听器(ActivitiEventListener)， 但是很奇怪的是在事件监听器里面是没有办法获取的流程相关的数据，根据现象和相关的搜索结果可以猜测，这是由于当流程引擎创建完任务之时，马上发出了任务相关的事件，此时数据还未flush到数据库里面（实际上流程那一步的完成需要等待时间监听器处理完），而事件监听器所属另外一个事务，此时查询不到创建的任务。</li>
</ol>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">DEMO 代码：</h4>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">测试中用到的流程定义文件(流程图如文章刚开始的示例图)：</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(97, 174, 238);">&lt;?</span>xml version=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;1.0&quot;</span> encoding=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;UTF-8&quot;</span><span style="box-sizing:border-box;color:rgb(97, 174, 238);">?&gt;</span></span>
<span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">definitions</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:xsi</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:xsd</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:activiti</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://activiti.org/bpmn&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:bpmndi</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:omgdc</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.omg.org/spec/DD/20100524/DC&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:omgdi</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.omg.org/spec/DD/20100524/DI&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">typeLanguage</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">expressionLanguage</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.w3.org/1999/XPath&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">targetNamespace</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://www.activiti.org/processdef&quot;</span>&gt;</span>
  <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">process</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meeting_audit_process&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">name</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;Meeting Audit Process&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">isExecutable</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;true&quot;</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">startEvent</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;startEvent1&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">startEvent</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">userTask</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meetingAudit&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">name</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;Meeting Audit&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:async</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;false&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:exclusive</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;false&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:assignee</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;13500000001,13500000002&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:candidateGroups</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;test_group&quot;</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">extensionElements</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">modeler:initiator-can-complete</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">xmlns:modeler</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;http://activiti.com/modeler&quot;</span>&gt;</span>&lt;![CDATA[false]]&gt;<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">modeler:initiator-can-complete</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">extensionElements</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">multiInstanceLoopCharacteristics</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">isSequential</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;false&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:collection</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;${assigneeList}&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">activiti:elementVariable</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;assignee&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">completionCondition</span>&gt;</span>${nrOfCompletedInstances &amp;gt;= 1}<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">completionCondition</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">multiInstanceLoopCharacteristics</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">userTask</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">sequenceFlow</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-9D4EDD47-E993-46FB-9738-8D65BDAF2C75&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">sourceRef</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meetingAudit&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">targetRef</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-1B2B1A10-BB81-4C57-8EB8-65883A8859DC&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">sequenceFlow</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">endEvent</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-1B2B1A10-BB81-4C57-8EB8-65883A8859DC&quot;</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">terminateEventDefinition</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">terminateEventDefinition</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">endEvent</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">sequenceFlow</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-F8F8CFB1-DD3A-46D4-B7A1-917D6DA04AD6&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">sourceRef</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;startEvent1&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">targetRef</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meetingAudit&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">sequenceFlow</span>&gt;</span>
  <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">process</span>&gt;</span>
  <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNDiagram</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNDiagram_meeting_audit_process&quot;</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNPlane</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meeting_audit_process&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNPlane_meeting_audit_process&quot;</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;startEvent1&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNShape_startEvent1&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">height</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;30.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">width</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;30.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;315.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;345.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;meetingAudit&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNShape_meetingAudit&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">height</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;80.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">width</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;100.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;450.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;330.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-1B2B1A10-BB81-4C57-8EB8-65883A8859DC&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNShape_sid-1B2B1A10-BB81-4C57-8EB8-65883A8859DC&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">height</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;28.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">width</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;28.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;690.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;360.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdc:Bounds</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNShape</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNEdge</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-F8F8CFB1-DD3A-46D4-B7A1-917D6DA04AD6&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNEdge_sid-F8F8CFB1-DD3A-46D4-B7A1-917D6DA04AD6&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;345.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;360.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;397.5&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;360.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;397.5&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;370.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;450.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;370.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNEdge</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNEdge</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">bpmnElement</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;sid-9D4EDD47-E993-46FB-9738-8D65BDAF2C75&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;BPMNEdge_sid-9D4EDD47-E993-46FB-9738-8D65BDAF2C75&quot;</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;550.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;370.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;620.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;370.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;620.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;374.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">x</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;690.0&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">y</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;374.0&quot;</span>&gt;</span><span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">omgdi:waypoint</span>&gt;</span>
      <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNEdge</span>&gt;</span>
    <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNPlane</span>&gt;</span>
  <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bpmndi:BPMNDiagram</span>&gt;</span>
<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">definitions</span>&gt;</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">实现 #1 需要的主要代码：</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;">        <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 根据需要启动的流程实例来获得相关的流程定义</span>
        ProcessDefinition meetingAuditProcessDefinition = listPDs.get(<span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>);
        BpmnModel bpmnModel = processEngine.getRepositoryService().getBpmnModel(meetingAuditProcessDefinition.getId());
        Collection&lt;FlowElement&gt; flowElements = bpmnModel.getMainProcess().getFlowElements();
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">for</span>(FlowElement e : flowElements) {

            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (e <span style="box-sizing:border-box;color:rgb(198, 120, 221);">instanceof</span> UserTask) {
                UserTask userTask = (UserTask) e;
                <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Object</span> behavior = userTask.getBehavior();
                <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (behavior <span style="box-sizing:border-box;color:rgb(198, 120, 221);">instanceof</span> MultiInstanceActivityBehavior) { <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 多实例用户任务</span>
                    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 可以根据获取的候选组/或者指派人员ID列表查询用户列表，设定到多实例的变量</span>
                    List&lt;<span style="box-sizing:border-box;color:rgb(230, 192, 123);">String</span>&gt; assigneeList = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> ArrayList&lt;&gt;();
                    <span style="box-sizing:border-box;color:rgb(230, 192, 123);">String</span> assignees = userTask.getAssignee();
                    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">for</span> (<span style="box-sizing:border-box;color:rgb(230, 192, 123);">String</span> assigneeId : assignees.split(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;,&quot;</span>)) {
                        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (StringUtils.isNotBlank(assigneeId)) {
                            assigneeList.add(assigneeId);
                        }
                    }
                    processVars.put(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;assigneeList&quot;</span>, assigneeList);
                }
            }
        }
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">实现 #2 需要在流程定义中通过程序的方式加入自己的executionListener, 由于这里只关注会签任务，就只需要在流程定义中对会签任务节点加上监听器。这里实现的方式是用postBpmnParseHandlers, 这个看起来是在流程引擎对流程定义进行解析，准备创建下一个Activiti时出发的。我就是在这里把executionListener注入到任务(此时只是创建Activity, 而不是多实例的user task)。</p>
<blockquote style="box-sizing:border-box;padding:20px;margin:0px 0px 20px;font-size:16px;border-left:6px solid rgb(180, 180, 180);margin-bottom:25px;background-color:rgb(247, 247, 247);font-weight:400;line-height:30px;word-break:break-word;">
<p style="box-sizing:border-box;margin:0px 0px 25px;margin-bottom:0px;word-break:break-word;font-size:16px;font-weight:400;line-height:1.7;">请注意下面的实现都是基于Activiti 6.0.0， 版本5.x.x 如此功能的代码相差非常大</p>
</blockquote>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.bpmn.model.ActivitiListener;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.bpmn.model.ImplementationType;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.bpmn.model.MultiInstanceLoopCharacteristics;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.bpmn.model.UserTask;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.delegate.TaskListener;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.impl.bpmn.parser.BpmnParse;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.impl.bpmn.parser.handler.UserTaskParseHandler;

<span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">/**
 * <span style="box-sizing:border-box;color:rgb(198, 120, 221);">@Description</span>: 
 * <span style="box-sizing:border-box;color:rgb(198, 120, 221);">@Author</span>: Yong Li
 * <span style="box-sizing:border-box;color:rgb(198, 120, 221);">@Date</span>: 2018/8/29 16:56
 */</span>
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">MultipleUserTaskBpmnParseHandler</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">extends</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">UserTaskParseHandler</span> </span>{

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> String eventName;
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> TaskListener taskListener;

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">MultipleUserTaskBpmnParseHandler</span><span style="box-sizing:border-box;">()</span> </span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.eventName =TaskListener.EVENTNAME_CREATE; <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 监听任务创建事件</span>
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.taskListener = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> MultipleTaskListener();
    }

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">MultipleUserTaskBpmnParseHandler</span><span style="box-sizing:border-box;">(String eventName, TaskListener taskListener)</span> </span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.eventName = eventName;
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.taskListener = taskListener;
    }

    <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">protected</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">executeParse</span><span style="box-sizing:border-box;">(BpmnParse bpmnParse, UserTask userTask)</span> </span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">super</span>.executeParse(bpmnParse, userTask);

        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (userTask.getLoopCharacteristics() <span style="box-sizing:border-box;color:rgb(198, 120, 221);">instanceof</span> MultiInstanceLoopCharacteristics) {
            ActivitiListener listener = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> ActivitiListener();
            listener.setEvent(eventName);
            <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//listener.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_INSTANCE);</span>
            <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//listener.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_INSTANCE);</span>
            <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">//listener.setInstance(taskListener);</span>

            listener.setImplementationType(ImplementationType.IMPLEMENTATION_TYPE_DELEGATEEXPRESSION);
            listener.setImplementation(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;#{multipleTaskListener}&quot;</span>);
            userTask.getTaskListeners().add(listener);
        }
    }
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">需要在processEngineConfiguration把这个监听器注册进去</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bean</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">id</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;processEngineConfiguration&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">class</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;</span>&gt;</span>
        ...
        <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">property</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">name</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;postBpmnParseHandlers&quot;</span>&gt;</span>
            <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">list</span>&gt;</span>
                <span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bean</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">class</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;workflow.listener.MultipleUserTaskBpmnParseHandler&quot;</span>/&gt;</span>
            <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">list</span>&gt;</span>
        <span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">property</span>&gt;</span>
<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bean</span>&gt;</span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">剩下就是在executionListener中对任务创建进行监听并进行任务指派了：</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.ProcessEngine;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.delegate.DelegateTask;
<span style="box-sizing:border-box;color:rgb(198, 120, 221);">import</span> org.activiti.engine.delegate.TaskListener;

<span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">MultipleTaskListener</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">implements</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">TaskListener</span> </span>{

    <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Resource</span>
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> ProcessEngine processEngine;

    <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 流程实例ID -&gt; 已经分配的人员列表 (如果一个流程实例里面有多个多任务实例的情况，需要重新定义map的key)</span>
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> Map&lt;String, List&lt;String&gt;&gt; processInstanceTaskIdsMap = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> HashMap&lt;&gt;();

    <span style="box-sizing:border-box;color:rgb(97, 174, 238);">@Override</span>
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">notify</span><span style="box-sizing:border-box;">(DelegateTask delegateTask)</span> </span>{
        String processInstanceId = delegateTask.getProcessInstanceId();
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (!processInstanceTaskIdsMap.containsKey(processInstanceId)) {
            processInstanceTaskIdsMap.put(processInstanceId, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> ArrayList&lt;&gt;());
        }
        processInstanceTaskIdsMap.get(processInstanceId).add(delegateTask.getId());

        <span style="box-sizing:border-box;color:rgb(146, 146, 146);font-style:normal;">// 最后一个多实例任务通知时，把所有任务进行指派</span>
        String[] allAssignees = delegateTask.getAssignee().split(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;,&quot;</span>);
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (processInstanceTaskIdsMap.get(processInstanceId).size() == allAssignees.length) {
            List&lt;String&gt; taskIds = processInstanceTaskIdsMap.get(processInstanceId);
            <span style="box-sizing:border-box;color:rgb(198, 120, 221);">for</span> (<span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> index = <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>; index &lt; taskIds.size(); index++) {
                processEngine.getTaskService().setAssignee(taskIds.get(index), allAssignees[index]);
            }
        }
    }

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> ProcessEngine <span style="box-sizing:border-box;color:rgb(97, 174, 238);">getProcessEngine</span><span style="box-sizing:border-box;">()</span> </span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> processEngine;
    }

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">setProcessEngine</span><span style="box-sizing:border-box;">(ProcessEngine processEngine)</span> </span>{
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.processEngine = processEngine;
    }
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">由于在指定监听器的时候用的是表达式，那么这里的监听器实例可以注册在spring容器中：</p>
<pre style="overflow:auto;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;display:block;padding:15px;margin:0px 0px 10px;line-height:1.42857;word-break:break-word;overflow-wrap:normal;color:rgb(171, 178, 191);border:1px solid rgb(204, 204, 204);border-radius:4px;margin-bottom:20px;white-space:pre;overflow-x:auto;background:rgb(40, 44, 52);background-color:rgb(245, 245, 245);"><code style="font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:13px;box-sizing:border-box;color:inherit;background-color:transparent;border-radius:0px;padding:0px;white-space:pre;border:none;vertical-align:middle;">&lt;bean id=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;multipleTaskListener&quot;</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span></span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;workflow.listener.MultipleTaskListener&quot;</span> depends-on=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;processEngine&quot;</span>&gt;
        <span style="box-sizing:border-box;"><span style="box-sizing:border-box;">&lt;<span style="box-sizing:border-box;color:rgb(224, 108, 117);">property</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">name</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;processEngine&quot;</span> <span style="box-sizing:border-box;color:rgb(209, 154, 102);">ref</span>=<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;processEngine&quot;</span> /&gt;</span>
<span style="box-sizing:border-box;">&lt;/<span style="box-sizing:border-box;color:rgb(224, 108, 117);">bean</span>&gt;</span></span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">如下图所示，再进行任务查找的时候，任务的assignee已经变成了单个用户了，之前在流程设计时定义流程任务的assignee为“13500000001,13500000002”。</p>
<br style="box-sizing:border-box;"/>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear 0s;margin:0px auto;max-width:636px;max-height:334px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:52.52%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="Activiti 中的会签通用指派_files/webp [1].webp" type="image/webp" data-filename="webp.webp" height="334" style="border:0px;box-sizing:border-box;vertical-align:middle;max-width:100%;display:block;transition:all 0.15s linear 0s;z-index:100;filter:blur(0px);opacity:1;height:auto;cursor:zoom-in;" width="636"/></div>
</div>
<div style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid rgb(217, 217, 217);font-size:14px;color:rgb(150, 150, 150);line-height:1.7;">1.png</div>
</div>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">总结</h4>
<ol style="box-sizing:border-box;word-break:break-word;padding:0px;margin:-5px 0px 20px 20px;margin-top:0px;margin-bottom:10px;">
<li style="box-sizing:border-box;line-height:30px;">Activiti 的文档有限，除了一点官方文档之外，主要是一些关键的API说明，当想要进一步深入的时候，文档或可参考的东西非常有限，并且还存在一些缺陷， 如上文提到的在事件监听器中数据查询问题；</li>
<li style="box-sizing:border-box;line-height:30px;">国内大多数都是在用Activiti流程引擎做应用，因为它比较简单、通俗，相较于一些流程引擎（jBPMN）还是显得轻量级，它也能快速适应市场变化，如它很快就可以跟spring boot整合了，但是可能一些商业化的流程软件并不是用它来做核心引擎的，因为国内关于它的较深入的文档案例实在太少，上面DEMO的很多API的使用基本上都是在国外的网站上一步一步摸索的。</li>
<li style="box-sizing:border-box;line-height:30px;">这里的DEMO 只是用于解决了会签里面的一个特定的问题，也许这个问题您并不是特别关心，但是通过这个窗口，我们可以知道还有一些方式可以介入到流程引擎之中，可以让我们进一步封装引擎，通过提供一个更加简单、适合自己产品需求的选项让我们的流程图设计用户能更简单的使用流程设计器，并进一步减少对程序开发的依赖。</li>
</ol>
<h4 style="box-sizing:border-box;font-family:inherit;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:20px;margin:0px 0px 15px;text-rendering:optimizelegibility;margin-top:10px;margin-bottom:10px;">最后，欢迎大家提出问题或有意思的优化。联系邮箱: <a href="https://www.jianshu.com/p/4ca05e4651b2mailto:13902443572@163.com" rel="nofollow" style="background-color:transparent;box-sizing:border-box;color:rgb(49, 148, 208);text-decoration:none;cursor:pointer;" target="_blank">13902443572@163.com</a>
</h4>

          </div>
        </div>
    </div></div></div></div></div></div><br/></div></span>
</div></body></html> 