<html>
<head>
  <title>为通过 ATS 检测 Tomcat 完全 TLS v1.2、完全正向加密及其结果检验 - CSDN博客</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="9311"/>
<h1>为通过 ATS 检测 Tomcat 完全 TLS v1.2、完全正向加密及其结果检验 - CSDN博客</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/10/27 16:10</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.csdn.net/defonds/article/details/54346343"><i>http://blog.csdn.net/defonds/article/details/54346343</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="box-sizing:border-box;font-family:sans-serif;text-size-adjust:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-size:16px;line-height:24px;color:rgb(51, 51, 51);background-color:rgb(244, 244, 244);font-weight:normal;"><div style="box-sizing:border-box;font-weight:normal;"><span style="box-sizing:border-box;"><div style="box-sizing:border-box;background-color:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.0470588) 0px 2px 4px 0px;">
            <h1 style="margin:0px;box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;font-size:24px;font-weight:bold;line-height:38px;color:rgb(44, 48, 51);padding:0px 29px;">为通过 ATS 检测 Tomcat 完全 TLS v1.2、完全正向加密及其结果检验</h1>
            <div style="box-sizing:border-box;margin:0px;font-weight:normal;display:block;padding:0px 29px 8px;color:rgb(136, 136, 136);border-bottom:1px solid rgb(229, 229, 229);font-size:14px;line-height:38px;margin-top:5px;"><span style="font-weight:normal;color:rgb(136, 136, 136);font-size:14px;line-height:38px;display:table;"> </span>
                <div style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;float:left;">
                    <span style="box-sizing:border-box;margin:0px;font-weight:normal;padding:2px 6px;border:1px solid rgb(228, 235, 244);font-size:14px;color:rgb(120, 144, 156);margin-right:20px;">原创</span>
                    <span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;display:inline-block;color:rgb(187, 187, 187);font-size:14px;">2017年01月12日 09:08:55</span>
                </div>
				<ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;display:block;float:left;margin-left:26px;background-color:rgb(255, 255, 255);font-size:14px;"><span style="font-weight:normal;list-style:none;font-size:14px;display:table;"> </span>
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;color:rgb(187, 187, 187);">标签：</li>
					
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=ats&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">ats</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
					
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=tomcat%20ats&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">tomcat ats</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
					
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=%E8%8B%B9%E6%9E%9Cats%E6%A3%80%E6%B5%8B&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">苹果ats检测</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
					
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=tomcat%E5%AE%8C%E5%85%A8%E6%AD%A3%E5%90%91%E5%8A%A0%E5%AF%86&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">tomcat完全正向加密</a> <span style="box-sizing:border-box;padding:0px;font-weight:normal;margin:0px 10px 0px 5px;color:rgb(229, 229, 229);display:inline-block;">/</span></li>
					
					<li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;"><a href="http://so.csdn.net/so/search/s.do?q=tomcat%20tls%20v1.2&amp;t=blog" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(64, 147, 198);display:inline-block;" target="_blank">tomcat tls v1.2</a> </li>
					
				<span style="font-weight:normal;list-style:none;font-size:14px;display:block;clear:both;height:0px;visibility:hidden;">.</span></ul>
                <ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:right;margin-top:5px;">
                    <li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:none;float:left;margin-left:30px;line-height:28px;"></li>
                    

                    
                    
                </ul>
            <span style="font-weight:normal;color:rgb(136, 136, 136);font-size:14px;line-height:38px;display:block;clear:both;height:0px;visibility:hidden;">.</span></div>
            <div style="box-sizing:border-box;margin:0px;font-weight:normal;padding:20px 30px 0px;margin-bottom:30px;color:rgb(69, 69, 69);overflow:hidden;">
                2017 年起 app store 要求 app 对接的服务器支持 TLS v1.2，否则 ats 检测不予通过。有点强制推 TLS v1.2 的意味。本文介绍如何使 tomcat 强制执行 TLS v1.2、完全正向加密。本文示例 tomcat 版本 7.0.68，jdk 版本 1.7.0。<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(255, 255, 153);">笔者强烈推荐在 DNS 解析层或反向代理服务层做这件事情，不建议放在 tomcat 这一层做。如果你非要在 tomcat 这层做，可以参考本文的做法。</span><br style="box-sizing:border-box;"/>首先声明，tomcat 7 以后能够通过 JSSE 支持 TLSv1、TLSv1.1、TLSv1.2。也能支持 ATS 所要求的那些正向签字算法，但是 ATS 要求只能支持这些正向签字算法，一些安全级别较弱的算法不能够支持，也就是完全正向加密。总之，本文要做的事情就是禁用 TLSv1、TLSv1.1，禁用非正向加密的弱签字算法。<br style="box-sizing:border-box;"/><h1 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;margin:0.8em 0px;font-size:2.6em;font-weight:100;line-height:1.1;color:inherit;"><a name="t0" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1. Tomcat 强制完全 TLS v1.2</h1>JDK 1.7 以上的 JSSE 才能支持到 TLS v1.2。<br style="box-sizing:border-box;"/><h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t1" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.1. ssl 证书迁移到 tomcat</h2><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t2" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.1.1. 联系证书颁发公司，转换为 jks 后缀格式</h3>对方技术支持会返回 keystore.jks 证书文件及其密码证书密码。<br style="box-sizing:border-box;"/><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t3" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.1.2. 将证书文件放在 %tomcat%/conf/ 目录</h3><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t4" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.1.3. 证书 tomcat 配置</h3>将 %tomcat%/conf/server.xml 中的以下注释部分取消注释：<br style="box-sizing:border-box;"/><div style="text-align:left;box-sizing:border-box;font-weight:normal;padding:0px;width:99%;overflow:auto;padding-top:1px;font-family:Consolas, &quot;Courier New&quot;, Courier, mono, serif;background-color:rgb(231, 229, 220);font-size:12px;position:relative;overflow-y:hidden;overflow-x:auto;margin:18px 0px;"><div style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;padding-left:45px;"><div style="line-height:normal;box-sizing:border-box;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;margin:0px;font-weight:normal;font-stretch:normal;font-size:9px;padding:3px 8px 10px 10px;font-variant:normal;color:silver;background-color:rgb(248, 248, 248);border-left:3px solid rgb(108, 226, 108);border-right:1px solid rgb(231, 229, 220);font-style:normal;"><b style="box-sizing:border-box;font-weight:bold;">[html]</b> <a href="http://blog.csdn.net/defonds/article/details/54346343#" style="margin-right:10px;outline:none;font-weight:normal;box-sizing:border-box;background-position:left top;border:none;margin:0px;width:16px;background:none;text-decoration:none;background-repeat:no-repeat;padding:1px;display:inline-block;background-color:inherit;height:16px;text-indent:-2000px;color:rgb(160, 160, 160);font-size:9px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif&quot;);" title="view plain">view plain</a><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;"> <a href="http://blog.csdn.net/defonds/article/details/54346343#" style="margin-right:10px;outline:none;font-weight:normal;box-sizing:border-box;background-position:left top;border:none;margin:0px;width:16px;background:none;text-decoration:none;background-repeat:no-repeat;padding:1px;display:inline-block;background-color:inherit;height:16px;text-indent:-2000px;color:rgb(160, 160, 160);font-size:9px;background-image:url(&quot;http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif&quot;);" title="copy">copy</a><div style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;position:absolute;left:464px;top:888px;width:16px;height:16px;z-index:99;"><div align="middle" style="box-sizing:border-box;background-color:rgb(255, 255, 255);"></div></div></span><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;"> </span></div></div><ol start="1" style="background-color:rgb(255, 255, 255);box-sizing:border-box;margin-top:0px;font-weight:normal;margin-bottom:10px;color:rgb(92, 92, 92);border-right:1px solid rgb(231, 229, 220);border:none;padding:0px;list-style:decimal;margin:0px 0px 1px 45px;"><li style="background-color:rgb(255, 255, 255);box-sizing:border-box;font-weight:normal;line-height:150%;border:none;list-style-image:initial;border-left:3px solid rgb(108, 226, 108);list-style-type:decimal-leading-zero;list-style:decimal;display:list-item;margin-left:40px;color:inherit;margin:0px;list-style-position:outside;padding:0px 3px 0px 10px;"><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"><span style="box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:rgb(153, 51, 0);font-weight:bold;">&lt;</span><span style="box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:rgb(153, 51, 0);font-weight:bold;">Connector</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">port</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;8443&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">protocol</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;org.apache.coyote.http11.Http11Protocol&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">  </span></span></li><li style="background-color:rgb(248, 248, 248);box-sizing:border-box;font-weight:normal;line-height:150%;border:none;list-style-image:initial;border-left:3px solid rgb(108, 226, 108);list-style-type:decimal-leading-zero;color:rgb(92, 92, 92);list-style:decimal;display:list-item;margin-left:40px;margin:0px;list-style-position:outside;padding:0px 3px 0px 10px;"><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">           <span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">maxThreads</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;150&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">SSLEnabled</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;true&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">scheme</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;https&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">secure</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;true&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">  </span></span></li><li style="background-color:rgb(255, 255, 255);box-sizing:border-box;font-weight:normal;line-height:150%;border:none;list-style-image:initial;border-left:3px solid rgb(108, 226, 108);list-style-type:decimal-leading-zero;list-style:decimal;display:list-item;margin-left:40px;color:inherit;margin:0px;list-style-position:outside;padding:0px 3px 0px 10px;"><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">           <span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">clientAuth</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;false&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:red;">sslProtocol</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">=</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;background-color:inherit;color:blue;">&quot;TLS&quot;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;"> </span><span style="box-sizing:border-box;margin:0px;padding:0px;border:none;background-color:inherit;color:rgb(153, 51, 0);font-weight:bold;">/&gt;</span><span style="box-sizing:border-box;font-weight:normal;margin:0px;padding:0px;border:none;color:black;background-color:inherit;">  </span></span></li></ol></div><br style="box-sizing:border-box;"/>然后向该 Connector 标签添加证书相关参数：<br style="box-sizing:border-box;"/><strong style="box-sizing:border-box;font-weight:bold;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#003300;">keystoreFile=&quot;<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(204, 204, 204);">conf/keystore.jks</span>&quot; keystorePass=&quot;<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(204, 204, 204);">证书密码</span>&quot;</span></strong><br style="box-sizing:border-box;"/><h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t5" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.2. 配置 tomcat 支持 TLSv1.2</h2><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t6" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.2.1. jvm 支持</h3>编辑 %tomcat%/bin/catalina.sh(或 bat)，在文件内容前添加：<br style="box-sizing:border-box;"/><strong style="box-sizing:border-box;font-weight:bold;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#003300;">set JAVA_OPTS=-Djdk.tls.client.protocols=&quot;TLSv1.2&quot; -Dsun.security.ssl.allowUnsafeRenegotiation=false -Dhttps.protocols=&quot;TLSv1.2&quot;</span></strong><br style="box-sizing:border-box;"/><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t7" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.2.2.tomcat 配置</h3>在上述 Connector 标签添加以下参数：<br style="box-sizing:border-box;"/><strong style="box-sizing:border-box;font-weight:bold;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#003300;">sslEnabledProtocols=&quot;TLSv1.2&quot;</span></strong><br style="box-sizing:border-box;"/><h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t8" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.3. 完全 TLS v1.2 的检测</h2><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t9" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.3.1. tomcat 启动时的验证</h3>我们在启动 tomcat 的时候可以看到配置的 JAVA_OPTS 相关日志：<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(255, 204, 153);">一月 11, 2017 11:29:36 上午 org.apache.catalina.startup.VersionLoggerListener log<br style="box-sizing:border-box;"/>信息: Command line argument: -Djdk.tls.client.protocols=<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#ff0000;">TLSv1.2</span><br style="box-sizing:border-box;"/>一月 11, 2017 11:29:36 上午 org.apache.catalina.startup.VersionLoggerListener log<br style="box-sizing:border-box;"/>信息: Command line argument: -Dsun.security.ssl.allowUnsafeRenegotiation=<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#ff0000;">false</span><br style="box-sizing:border-box;"/>一月 11, 2017 11:29:36 上午 org.apache.catalina.startup.VersionLoggerListener log<br style="box-sizing:border-box;"/>信息: Command line argument: -Dhttps.protocols=<span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#ff0000;">TLSv1.2</span></span><br style="box-sizing:border-box;"/><h3 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:1.7em;margin:0.8em 0px;"><a name="t10" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>1.3.2. openssl 命令行工具</h3>我们先看看 TLSv1.1 协议是否已禁用：<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(255, 204, 153);">C:\tools\OpenSSL-Win32\bin&gt;openssl s_client -connect localhost:8443 -tls1_1<br style="box-sizing:border-box;"/>CONNECTED(000000D0)<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#ff0000;">3252:error</span>:14094410:SSL routines:ssl3_read_bytes:sslv3 alert handshake failure:ssl\record\rec_layer_s3.c:1394:SSL alert number 40<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>no peer certificate available<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>No client certificate CA names sent<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>SSL handshake has read 7 bytes and written 102 bytes</span><br style="box-sizing:border-box;"/>握手失败，TLSv1.1 协议是否已禁用。再来看看 TLSv1.2：<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;background-color:rgb(255, 204, 153);">C:\tools\OpenSSL-Win32\bin&gt;openssl s_client -connect localhost:8443 -tls1_2<br style="box-sizing:border-box;"/>CONNECTED(000000D0)<br style="box-sizing:border-box;"/>depth=0 C = cn, ST = sh, L = sh, O = kdf, OU = kdf, CN = defonds kong<br style="box-sizing:border-box;"/>verify error:num=18:self signed certificate<br style="box-sizing:border-box;"/>verify return:1<br style="box-sizing:border-box;"/>depth=0 C = cn, ST = sh, L = sh, O = kdf, OU = kdf, CN = defonds kong<br style="box-sizing:border-box;"/>verify return:1<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>Certificate chain<br style="box-sizing:border-box;"/> 0 s:/C=cn/ST=sh/L=sh/O=kdf/OU=kdf/CN=defonds kong<br style="box-sizing:border-box;"/>   i:/C=cn/ST=sh/L=sh/O=kdf/OU=kdf/CN=defonds kong<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>Server certificate<br style="box-sizing:border-box;"/>-----BEGIN CERTIFICATE-----<br style="box-sizing:border-box;"/>(略)<br style="box-sizing:border-box;"/>-----END CERTIFICATE-----<br style="box-sizing:border-box;"/>subject=/C=cn/ST=sh/L=sh/O=kdf/OU=kdf/CN=defonds kong<br style="box-sizing:border-box;"/>issuer=/C=cn/ST=sh/L=sh/O=kdf/OU=kdf/CN=defonds kong<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>No client certificate CA names sent<br style="box-sizing:border-box;"/>Peer signing digest: SHA512<br style="box-sizing:border-box;"/>Server Temp Key: ECDH, P-256, 256 bits<br style="box-sizing:border-box;"/>---<br style="box-sizing:border-box;"/>SSL handshake has read 990 bytes and written 342 bytes</span><br style="box-sizing:border-box;"/>可以看到 tomcat 只支持 TLSv1.2 了。<br style="box-sizing:border-box;"/><h1 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;margin:0.8em 0px;font-size:2.6em;font-weight:100;line-height:1.1;color:inherit;"><a name="t11" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>2. Tomcat 强制完全正向加密</h1><h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t12" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>2.1. 配置 tomcat</h2>在上述Connector标签添加以下参数：<br style="box-sizing:border-box;"/><strong style="box-sizing:border-box;font-weight:bold;"><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;color:#003300;">ciphers=&quot;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_DHE_RSA_WITH_AES_128_GCM_SHA256,TLS_DHE_RSA_WITH_AES_256_GCM_SHA384,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_DHE_RSA_WITH_AES_128_CBC_SHA256,TLS_DHE_RSA_WITH_AES_128_CBC_SHA,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_DHE_RSA_WITH_AES_256_CBC_SHA256,TLS_DHE_RSA_WITH_AES_256_CBC_SHA,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_GCM_SHA384,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_RSA_WITH_AES_128_CBC_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA256,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_CBC_SHA,<br style="box-sizing:border-box;"/><span style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;white-space:pre;">			</span>   SSL_RSA_WITH_3DES_EDE_CBC_SHA&quot;</span></strong><br style="box-sizing:border-box;"/>最后重启tomcat即可。<br style="box-sizing:border-box;"/><h2 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;font-weight:100;line-height:1.1;color:inherit;font-size:2.15em;margin:0.8em 0px;"><a name="t13" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>2.2. 完全正向加密的检测</h2>很多证书服务商提供了在线 ATS 检测接口，比如：<br style="box-sizing:border-box;"/><ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;"><li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;"><a href="https://www.qcloud.com/product/ssl" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);" target="_blank">腾讯云</a></li><li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;"><a href="https://www.trustasia.com/tools-ats-ios9-checker" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);" target="_blank">亚数</a></li></ul><p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;">如腾讯云的检测结果：</p><p style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;"><img src="为通过 ATS 检测 Tomcat 完全 TLS v1.2、完全正向加密及其结果检验 - _files/20170112090946348.png" type="image/png" data-filename="20170112090946348.png" alt="腾讯云的检测结果.png" height="446" style="box-sizing:border-box;border:0px;vertical-align:middle;outline:none;max-width:100%;" width="860"/><br style="box-sizing:border-box;"/></p><h1 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;margin:0.8em 0px;font-size:2.6em;font-weight:100;line-height:1.1;color:inherit;"><a name="t14" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>3. 相关工具下载</h1>本文所涉及 openssl 工具安装包，以及 server.xml、catalina.bat、keystore.jks 都已打包上传 CSDN 资源，有兴趣的朋友可以自行去下载以参考：<br style="box-sizing:border-box;"/><a href="http://download.csdn.net/detail/defonds/9735398" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);" target="_blank">SSL/TLS 检测工具以及 tomcat 正向加密配置例子</a>。<br style="box-sizing:border-box;"/><h1 style="box-sizing:border-box;font-family:&quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun;padding:0px;margin:0.8em 0px;font-size:2.6em;font-weight:100;line-height:1.1;color:inherit;"><a name="t15" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);"></a>参考资料</h1><ul style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;"><li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;"><a href="http://stackoverflow.com/questions/9749339/does-tomcat-support-tls-v1-2" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);" target="_blank">Does Tomcat support TLS v1.2?</a></li><li style="box-sizing:border-box;margin:0px;padding:0px;font-weight:normal;list-style:disc;display:list-item;margin-left:40px;"><a href="https://www.hass.de/content/commvault-secure-your-insecure-web-console-tomcat-and-enable-ssl-perfect-forward-secrecy" style="background:transparent;box-sizing:border-box;text-decoration:none;margin:0px;padding:0px;font-weight:normal;outline:none;color:rgb(79, 161, 219);" target="_blank">CommVault: Secure your insecure Web Console (Tomcat) and enable SSL / Perfect Forward Secrecy</a></li></ul>
            </div>
        </div></span></div></div></div></div><br/></div></span>
</div></body></html> 