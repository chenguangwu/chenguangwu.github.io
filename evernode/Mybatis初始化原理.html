<html>
<head>
  <title>Mybatis初始化原理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600718 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="10509"/>
<h1>Mybatis初始化原理</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/12/26 13:31</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://mp.weixin.qq.com/s/jgSwKybN5qQT4otWE0oE_Q"><i>https://mp.weixin.qq.com/s/jgSwKybN5qQT4otWE0oE_Q</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="text-size-adjust:100%;line-height:1.6;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);"><div style="font-family:-apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color:rgb(51, 51, 51);letter-spacing:0.034em;line-height:1.6;font-size:initial;-webkit-appearance:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);background-color:rgb(255, 255, 255);"><div><div style="word-wrap:break-word;"><div style="background-color:rgb(255, 255, 255);"><div><div>

                
                <h2 style="padding:0px;font-weight:400;margin:0px;font-size:22px;line-height:1.4;margin-bottom:14px;">
                    
                    
                    当面试官问我Mybatis初始化原理时，我笑了

                                                                                </h2>
                <div style="margin:0px;padding:0px;margin-bottom:22px;line-height:20px;font-size:0px;word-wrap:break-word;word-break:break-all;position:relative;z-index:1;">
                                                                                
                                        <span style="padding:0px;margin:0px 10px 10px 0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);position:relative;">
                      <a href="#" style="margin:0px;padding:0px;color:rgb(87, 107, 149);text-decoration:none;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);">
                        Java架构沉思录                      </a>
                      
                    </span>


                    <em style="padding:0px;margin:0px 10px 10px 0px;display:inline-block;vertical-align:middle;font-size:15px;-webkit-tap-highlight-color:rgba(0, 0, 0, 0);color:rgba(0, 0, 0, 0.3);font-style:normal;">前天</em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div style="margin:0px;padding:0px;overflow:hidden;color:rgb(51, 51, 51);font-size:17px;word-wrap:break-word;text-align:justify;z-index:0;position:relative;">
                    

                    

                    
                    
                    <pre style="margin:1.2em 0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:1em;font-family:Consolas, Inconsolata, Courier, monospace;line-height:1.2em;"><code style="background-color:rgb(248, 248, 248);margin:0px 0.15em;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;padding:0.5em 0.7em;white-space:pre;overflow:auto;border-radius:3px;border-width:1px;border-style:solid;border-color:rgb(204, 204, 204);display:block !important;">作者：亦山
原文：https://blog.csdn.net/luanlouis/article/details/37744073</code></pre><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">对于任何框架而言，在使用前都要进行一系列的初始化，MyBatis也不例外。本章将通过以下几点详细介绍MyBatis的初始化过程。</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><ol style="padding:0px;margin:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:decimal;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis的初始化做了什么</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis基于XML配置文件创建Configuration对象的过程</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">涉及到的设计模式</p></li></ol><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h2 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(21, 153, 87);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:18px;">一、 MyBatis的初始化做了什么</span></strong></span></h2><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">任何框架的初始化，无非是加载自己运行时所需要的配置信息。MyBatis的配置信息，大概包含以下信息，其高层级结构如下：</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">× configuration 配置</strong></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">        × properties 属性<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × settings 设置<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × typeAliases 类型命名<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × typeHandlers 类型处理器<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × objectFactory 对象工厂<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × plugins 插件<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × environments 环境<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × environment 环境变量<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × transactionManager 事务管理器<br style="margin:0px;padding:0px;max-width:100%;box-sizing:inherit;word-wrap:break-word;"/>        × dataSource 数据源</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">×映射器</strong></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></strong></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis的上述配置信息会配置在XML配置文件中，那么，这些信息被加载进入MyBatis内部，MyBatis是怎样维护的呢？</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis采用了一个非常直白和简单的方式---使用 org.apache.ibatis.session.Configuration 对象作为一个所有配置信息的容器，Configuration对象的组织结构和XML配置文件的组织结构几乎完全一样（当然，Configuration对象的功能并不限于此，它还负责创建一些MyBatis内部使用的对象，如Executor等，这将在后续的文章中讨论）。如下图所示：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640" type="image/webp" data-filename="640" height="669" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:100% !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">  </p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis根据初始化好Configuration信息，这时候用户就可以使用MyBatis进行数据库操作了。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">可以这么说，MyBatis初始化的过程，就是创建 Configuration对象的过程。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis的初始化可以有两种方式：</p><ul style="padding:0px;margin:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:circle;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">基于XML配置文件：基于XML配置文件的方式是将MyBatis的所有配置信息放在XML文件中，MyBatis通过加载并XML配置文件，将配置文信息组装成内部的Configuration对象</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">基于Java API：这种方式不使用XML配置文件，需要MyBatis使用者在Java代码中，手动创建Configuration对象，然后将配置参数set 进入Configuration对象中</p></li></ul><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">    </p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">（PS:  MyBatis具体配置信息有哪些，又分别表示什么意思，不在本文的叙述范围，读者可以参考我的《Java Persistence withMyBatis 3 (中文版)》 的第二章 引导MyBatis中有详细的描述）</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">接下来我们将通过 基于XML配置文件方式的MyBatis初始化，深入探讨MyBatis是如何通过配置文件构建Configuration对象，并使用它的。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h2 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(21, 153, 87);font-size:18px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">二、MyBatis基于XML配置文件创建Configuration对象的过程</strong></span></h2><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">现在就从使用MyBatis的简单例子入手，深入分析一下MyBatis是怎样完成初始化的，都初始化了什么。看以下代码：   </p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [1]" type="image/webp" data-filename="640" height="146" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:661px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">有过MyBatis使用经验的读者会知道，上述语句的作用是执行com.foo.bean.BlogMapper.queryAllBlogInfo 定义的SQL语句，返回一个List结果集。总的来说，上述代码经历了mybatis初始化 --&gt;创建SqlSession --&gt;执行SQL语句 返回结果三个过程。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">上述代码的功能是根据配置文件mybatis-config.xml  配置文件，创建SqlSessionFactory对象，然后产生SqlSession，执行SQL语句。而mybatis的初始化就发生在第三句：SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);  现在就让我们看看第三句到底发生了什么。</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h3 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">MyBatis初始化基本过程：</strong></h3><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">SqlSessionFactoryBuilder根据传入的数据流生成Configuration对象，然后根据Configuration对象创建默认的SqlSessionFactory实例。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">初始化的基本过程如下序列图所示：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [2]" type="image/webp" data-filename="640" height="461" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:677px !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">由上图所示，mybatis初始化要经过简单的以下几步：</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">1. 调用SqlSessionFactoryBuilder对象的build(inputStream)方法；</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">2. SqlSessionFactoryBuilder会根据输入流inputStream等信息创建XMLConfigBuilder对象;</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">3. SqlSessionFactoryBuilder调用XMLConfigBuilder对象的parse()方法；</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">4. XMLConfigBuilder对象返回Configuration对象；</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">5. SqlSessionFactoryBuilder根据Configuration对象创建一个DefaultSessionFactory对象；</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">6. SqlSessionFactoryBuilder返回 DefaultSessionFactory对象给Client，供Client使用。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">SqlSessionFactoryBuilder相关的代码如下所示：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [3]" type="image/webp" data-filename="640" height="468" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:671px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [4]" type="image/webp" data-filename="640" height="346" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:673px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">上述的初始化过程中，涉及到了以下几个对象：</p><ul style="padding:0px;margin:0px;padding-left:2.2em;max-width:100%;box-sizing:border-box;word-wrap:break-word;list-style-type:circle;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">SqlSessionFactoryBuilder ： SqlSessionFactory的构造器，用于创建SqlSessionFactory，采用了Builder设计模式</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">Configuration ：该对象是mybatis-config.xml文件中所有mybatis配置信息</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">SqlSessionFactory：SqlSession工厂类，以工厂形式创建SqlSession对象，采用了Factory工厂设计模式</p></li><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">XmlConfigParser ：负责将mybatis-config.xml配置文件解析成Configuration对象，共SqlSessonFactoryBuilder使用，创建SqlSessionFactory</p></li></ul><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:16px;">创建Configuration对象的过程</strong></p><p style="clear:both;margin:0px;margin-bottom:10px;margin-top:10px;text-align:justify;padding:0px;min-height:1em;word-wrap:break-word;box-sizing:border-box;max-width:100%;line-height:1.75em;">接着上述的 MyBatis初始化基本过程讨论，当SqlSessionFactoryBuilder执行build()方法，调用了XMLConfigBuilder的parse()方法，然后返回了Configuration对象。那么parse()方法是如何处理XML文件，生成Configuration对象的呢？</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">1. XMLConfigBuilder会将XML配置文件的信息转换为Document对象，而XML配置定义文件DTD转换成XMLMapperEntityResolver对象，然后将二者封装到XpathParser对象中，XpathParser的作用是提供根据Xpath表达式获取基本的DOM节点Node信息的操作。如下图所示：    </p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [5]" type="image/webp" data-filename="640" height="325" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:677px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [6]" type="image/webp" data-filename="640" height="356" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:677px !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">2.  之后XMLConfigBuilder调用parse()方法：会从XPathParser中取出 &lt;configuration&gt;节点对应的Node对象，然后解析此Node节点的子Node：properties, settings, typeAliases,typeHandlers, objectFactory, objectWrapperFactory, plugins, environments,databaseIdProvider, mappers</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [7]" type="image/webp" data-filename="640" height="546" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:670px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [8]" type="image/webp" data-filename="640" height="413" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:667px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"> <br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">注意：在上述代码中，还有一个非常重要的地方，就是解析XML配置文件子节点&lt;mappers&gt;的方法mapperElements(root.evalNode(&quot;mappers&quot;)), 它将解析我们配置的Mapper.xml配置文件，Mapper配置文件可以说是MyBatis的核心，MyBatis的特性和理念都体现在此Mapper的配置和设计上，我们将在后续的文章中讨论它，敬请期待～ </p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">3.  然后将这些值解析出来设置到Configuration对象中。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">解析子节点的过程这里就不一一介绍了，用户可以参照MyBatis源码仔细揣摩，我们就看上述的environmentsElement(root.evalNode(&quot;environments&quot;)); 方法是如何将environments的信息解析出来，设置到Configuration对象中的：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [9]" type="image/webp" data-filename="640" height="530" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:670px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [10]" type="image/webp" data-filename="640" height="517" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:670px !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">4.  返回Configuration对象 </p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">我们将上述的MyBatis初始化基本过程的序列图细化。</p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [11]" type="image/webp" data-filename="640" height="597" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:677px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"> </p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h2 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:18px;color:rgb(21, 153, 87);"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;">三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象</strong></span></h2><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">我们可以使用XMLConfigBuilder手动解析XML配置文件来创建Configuration对象，代码如下：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [12]" type="image/webp" data-filename="640" height="183" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:669px !important;visibility:visible !important;" width="661"/></p><h2 style="padding:0px;font-weight:400;font-size:16px;margin:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></h2><h2 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;font-size:18px;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;color:rgb(21, 153, 87);">四、涉及到的设计模式</span></strong></span></h2><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">初始化的过程涉及到创建各种对象，所以会使用一些创建型的设计模式。在初始化的过程中，Builder模式运用的比较多。</p><h3 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">Builder模式应用1： SqlSessionFactory的创建</h3><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">对于创建SqlSessionFactory时，会根据情况提供不同的参数，其参数组合可以有以下几种：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [13]" type="image/webp" data-filename="640" height="270" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:256px !important;visibility:visible !important;" width="256"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">由于构造时参数不定，可以为其创建一个构造器Builder，将SqlSessionFactory的构建过程和表示分开：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [14]" type="image/webp" data-filename="640" height="254" style="border-width:0px;margin:auto;max-width:80%;box-sizing:border-box;word-wrap:break-word;height:auto !important;padding:0px;border-style:initial;border-color:initial;vertical-align:middle;cursor:zoom-in;width:100% !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">MyBatis将SqlSessionFactoryBuilder和SqlSessionFactory相互独立。</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><h3 style="font-weight:400;font-size:16px;margin:10px 8px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">Builder模式应用2： 数据库连接环境Environment对象的创建</h3><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">在构建Configuration对象的过程中，XMLConfigParser解析 mybatis XML配置文件节点&lt;environment&gt;节点时，会有以下相应的代码：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [15]" type="image/webp" data-filename="640" height="497" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:669px !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">在Environment内部，定义了静态内部Builder类：</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [16]" type="image/webp" data-filename="640" height="586" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:671px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [17]" type="image/webp" data-filename="640" height="574" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:670px !important;visibility:visible !important;" width="661"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;"><img src="Mybatis初始化原理_files/640 [18]" type="image/webp" data-filename="640" height="172" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:670px !important;visibility:visible !important;" width="661"/></p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;"><br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;"/></p><p style="margin:10px 8px;padding:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:justify;line-height:1.75em;">以上就是本文 《深入理解mybatis原理》Mybatis初始化机制详解的全部内容，希望对大家有所帮助！上述内容如有不妥之处，还请读者指出，共同探讨，共同进步！</p><p style="padding:0px;margin:0px;clear:both;min-height:1em;max-width:100%;box-sizing:border-box;word-wrap:break-word;text-align:center;"><img src="Mybatis初始化原理_files/640 [19]" type="image/webp" data-filename="640" height="271" style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;word-wrap:break-word;height:auto !important;width:271px !important;visibility:visible !important;" width="271"/></p>
                </div>
                

                
                
                
                
                

                
                                

                
                                
                
                            </div></div></div></div></div></div></div></div>
</div>
</span>
</div></body></html> 