<html>
<head>
  <title>深入浅出CAS</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7296"/>
<h1>深入浅出CAS</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/8/8 15:40</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://www.jianshu.com/p/fb6e91b013cc"><i>https://www.jianshu.com/p/fb6e91b013cc</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;position: relative;"><div style="box-sizing:border-box;font-family:sans-serif;text-size-adjust:100%;font-size:10px;-webkit-tap-highlight-color:transparent;"><div style="box-sizing:border-box;font-size:17px;line-height:1.42857;background-color:rgb(255, 255, 255);min-width:768px;color:rgb(51, 51, 51);font-family:-apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;">
        <h1 style="box-sizing:border-box;color:inherit;margin-top:20px;margin-bottom:10px;font-size:34px;margin:20px 0px 0px;font-family:-apple-system, &quot;SF UI Display&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-weight:700;line-height:1.3;word-break:break-word;">深入浅出CAS</h1>

        
        <div style="box-sizing:border-box;margin:30px 0px 40px;">
          <a href="https://www.jianshu.com/u/90ab66c248e6" style="box-sizing:border-box;background-color:transparent;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;width:48px;height:48px;display:inline-block;vertical-align:middle;">
            <img src="深入浅出CAS_files/96" type="image/png" data-filename="96" height="46" style="box-sizing:border-box;vertical-align:middle;border:1px solid rgb(221, 221, 221);width:100%;height:100%;border-radius:50%;" width="46"/>
</a>          <div style="box-sizing:border-box;vertical-align:middle;display:inline-block;margin-left:8px;">
            <span style="box-sizing:border-box;margin-right:3px;font-size:16px;vertical-align:middle;"><a href="https://www.jianshu.com/u/90ab66c248e6" style="box-sizing:border-box;background-color:transparent;color:rgb(51, 51, 51);text-decoration:none;cursor:pointer;">占小狼</a></span>
              <img src="深入浅出CAS_files/595a1b60-08f6-4beb-998f-2bf55e230555" type="image/png" data-filename="595a1b60-08f6-4beb-998f-2bf55e230555" height="20" style="box-sizing:border-box;vertical-align:middle;border:0px;margin-right:5px;width:20px;height:20px;border-radius:0px;" title="" width="20"/>
            
            <a style="cursor:pointer;box-sizing:border-box;border:1px solid rgba(151, 151, 151, 0.6);text-decoration:none;white-space:nowrap;margin-bottom:0px;text-align:center;vertical-align:middle;touch-action:manipulation;color:rgb(140, 140, 140);display:inline-block;font-weight:400;user-select:none;border-radius:40px;line-height:normal;background:none;font-size:12px;padding:0px 7px 0px 5px;"><i style="box-sizing:border-box;font-size:inherit;font-style:normal;-webkit-font-smoothing:antialiased;font-family:iconfont;font-weight:400;"><span style="font-size:inherit;font-style:normal;font-family:iconfont;font-weight:400;"></span></i><span style="box-sizing:border-box;margin-left:2px;display:inline;">已关注</span></a>
            
            <div style="box-sizing:border-box;margin-top:5px;font-size:12px;color:rgb(150, 150, 150);">
              
                <span style="box-sizing:border-box;padding-right:5px;" title="">2016.07.12 13:42*</span>
              <span style="box-sizing:border-box;padding-right:5px;">字数 1637</span>
            <span style="box-sizing:border-box;padding-right:5px;">阅读 30290</span><span style="box-sizing:border-box;padding-right:5px;">评论 79</span><span style="box-sizing:border-box;padding-right:5px;">喜欢 189</span><span style="box-sizing:border-box;padding-right:5px;">赞赏 2</span></div>
          </div>
          
        </div>


        
        <div style="box-sizing:border-box;color:rgb(47, 47, 47);font-size:16px;font-weight:400;line-height:1.7;word-break:break-word;">
          <div style="box-sizing:border-box;">
            <blockquote style="box-sizing:border-box;margin:0px 0px 20px;padding:20px;font-size:16px;border-left:6px solid rgb(180, 180, 180);margin-bottom:25px;background-color:rgb(247, 247, 247);font-weight:400;line-height:30px;word-break:break-word;">
<p style="box-sizing:border-box;margin:0px 0px 25px;font-size:16px;font-weight:400;line-height:1.7;margin-bottom:0px;word-break:break-word;"><a href="https://www.jianshu.com/users/90ab66c248e6/latest_articles" style="box-sizing:border-box;background-color:transparent;text-decoration:none;cursor:pointer;color:rgb(49, 148, 208);" target="_blank">占小狼</a> 转载请注明原创出处，谢谢！</p>
</blockquote>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">前言</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">CAS（Compare and Swap），即比较并替换，实现并发算法时常用到的一种技术，Doug lea大神在java同步器中大量使用了CAS技术，鬼斧神工的实现了多线程执行的安全性。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">CAS的思想很简单：三个参数，一个当前内存值V、旧的预期值A、即将更新的值B，当且仅当预期值A和内存值V相同时，将内存值修改为B并返回true，否则什么都不做，并返回false。</p>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">问题</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">一个<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">n++</code>的问题。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Case</span> {</span>

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> n;

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">add</span><span style="box-sizing:border-box;">()</span> </span>{
        n++;
    }
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">通过<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">javap -verbose Case</code>看看add方法的字节码指令</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">add</span><span style="box-sizing:border-box;">()</span></span>;
    flags: ACC_PUBLIC
    Code:
      <span style="box-sizing:border-box;color:rgb(230, 192, 123);">stack</span>=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">3</span>, locals=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>, args_size=<span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0</span>: aload_0       
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>: dup           
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">2</span>: getfield      #<span style="box-sizing:border-box;color:rgb(209, 154, 102);">2</span>                  <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// Field n:I</span>
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">5</span>: iconst_1      
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">6</span>: iadd          
         <span style="box-sizing:border-box;color:rgb(209, 154, 102);">7</span>: putfield      #<span style="box-sizing:border-box;color:rgb(209, 154, 102);">2</span>                  <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// Field n:I</span>
        <span style="box-sizing:border-box;color:rgb(209, 154, 102);">10</span>: <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span>        
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">n++</code>被拆分成了几个指令：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">getfield</code>拿到原始n；</li>
<li style="box-sizing:border-box;line-height:30px;">执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">iadd</code>进行加1操作；</li>
<li style="box-sizing:border-box;line-height:30px;">执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">putfield</code>写把累加后的值写回n；</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">通过volatile修饰的变量可以保证线程之间的可见性，但并不能保证这3个指令的原子执行，在多线程并发执行下，无法做到线程安全，得到正确的结果，那么应该如何解决呢？</p>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">如何解决</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">在<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">add</code>方法加上synchronized修饰解决。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Case</span> </span>{

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> n;

    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">synchronized</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">void</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">add</span><span style="box-sizing:border-box;">()</span> </span>{
        n++;
    }
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">这个方案当然可行，但是性能上差了点，还有其它方案么？</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">再来看一段代码</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> a = <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>;
<span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">boolean</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">compareAndSwapInt</span><span style="box-sizing:border-box;">(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> b)</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">if</span> (a == <span style="box-sizing:border-box;color:rgb(209, 154, 102);">1</span>) {
        a = b;
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">true</span>;
    }
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">false</span>;
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">如果这段代码在并发下执行，会发生什么？</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">假设线程1和线程2都过了<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">a==1</code>的检测，都准备执行对a进行赋值，结果就是两个线程同时修改了变量a，显然这种结果是无法符合预期的，无法确定a的最终值。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">解决方法也同样暴力，在compareAndSwapInt方法加锁同步，变成一个原子操作，同一时刻只有一个线程才能修改变量a。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">除了低性能的加锁方案，我们还可以使用JDK自带的CAS方案，在CAS中，比较和替换是一组原子操作，不会被外部打断，且在性能上更占有优势。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">下面以<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">AtomicInteger</code>的实现为例，分析一下CAS是如何实现的。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">class</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">AtomicInteger</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">extends</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">Number</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">implements</span> <span style="box-sizing:border-box;color:rgb(230, 192, 123);">java</span>.<span style="box-sizing:border-box;color:rgb(230, 192, 123);">io</span>.<span style="box-sizing:border-box;color:rgb(230, 192, 123);">Serializable</span> </span>{
    <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// setup to use Unsafe.compareAndSwapInt for updates</span>
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> Unsafe unsafe = Unsafe.getUnsafe();
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">long</span> valueOffset;

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">static</span> {
        <span style="box-sizing:border-box;color:rgb(198, 120, 221);">try</span> {
            valueOffset = unsafe.objectFieldOffset
                (AtomicInteger.class.getDeclaredField(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;value&quot;</span>));
        } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">catch</span> (Exception ex) { <span style="box-sizing:border-box;color:rgb(198, 120, 221);">throw</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">new</span> Error(ex); }
    }

    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">private</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> value;
    <span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">get</span><span style="box-sizing:border-box;">()</span> </span>{<span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> value;}
}
</code></pre>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">Unsafe，是CAS的核心类，由于Java方法无法直接访问底层系统，需要通过本地（native）方法来访问，Unsafe相当于一个后门，基于该类可以直接操作特定内存的数据。</li>
<li style="box-sizing:border-box;line-height:30px;">变量valueOffset，表示该变量值在内存中的偏移地址，因为Unsafe就是根据内存偏移地址获取数据的。</li>
<li style="box-sizing:border-box;line-height:30px;">变量value用volatile修饰，保证了多线程之间的内存可见性。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">看看<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">AtomicInteger</code>如何实现并发下的累加操作：</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">getAndAdd</span><span style="box-sizing:border-box;">(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> delta)</span> </span>{    
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> unsafe.getAndAddInt(<span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>, valueOffset, delta);
}

<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">//unsafe.getAndAddInt</span>
<span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">getAndAddInt</span><span style="box-sizing:border-box;">(Object var1, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">long</span> var2, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> var4)</span> </span>{
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> var5;
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">do</span> {
        var5 = <span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.getIntVolatile(var1, var2);
    } <span style="box-sizing:border-box;color:rgb(198, 120, 221);">while</span>(!<span style="box-sizing:border-box;color:rgb(198, 120, 221);">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> var5;
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">假设线程A和线程B同时执行getAndAdd操作（分别跑在不同CPU上）：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">AtomicInteger里面的value原始值为3，即主内存中AtomicInteger的value为3，根据Java内存模型，线程A和线程B各自持有一份value的副本，值为3。</li>
<li style="box-sizing:border-box;line-height:30px;">线程A通过<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">getIntVolatile(var1, var2)</code>拿到value值3，这时线程A被挂起。</li>
<li style="box-sizing:border-box;line-height:30px;">线程B也通过<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">getIntVolatile(var1, var2)</code>方法获取到value值3，运气好，线程B没有被挂起，并执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">compareAndSwapInt</code>方法比较内存值也为3，成功修改内存值为2。</li>
<li style="box-sizing:border-box;line-height:30px;">这时线程A恢复，执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">compareAndSwapInt</code>方法比较，发现自己手里的值(3)和内存的值(2)不一致，说明该值已经被其它线程提前修改过了，那只能重新来一遍了。</li>
<li style="box-sizing:border-box;line-height:30px;">重新获取value值，因为变量value被volatile修饰，所以其它线程对它的修改，线程A总是能够看到，线程A继续执行<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">compareAndSwapInt</code>进行比较替换，直到成功。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">整个过程中，利用CAS保证了对于value的修改的并发安全，继续深入看看Unsafe类中的compareAndSwapInt方法实现。</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">public</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">final</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">native</span> <span style="box-sizing:border-box;color:rgb(198, 120, 221);">boolean</span> <span style="box-sizing:border-box;color:rgb(97, 174, 238);">compareAndSwapInt</span><span style="box-sizing:border-box;">(Object paramObject, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">long</span> paramLong, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> paramInt1, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> paramInt2)</span></span>;
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">Unsafe类中的compareAndSwapInt，是一个本地方法，该方法的实现位于<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">unsafe.cpp</code>中</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;">UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x))
  UnsafeWrapper(<span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;Unsafe_CompareAndSwapInt&quot;</span>);
  oop p = JNIHandles::resolve(obj);
  jint* addr = (jint *) index_oop_from_field_offset_long(p, offset);
  <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> (jint)(Atomic::cmpxchg(x, addr, e)) == e;
UNSAFE_END
</code></pre>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">先想办法拿到变量value在内存中的地址。</li>
<li style="box-sizing:border-box;line-height:30px;">通过<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">Atomic::cmpxchg</code>实现比较替换，其中参数x是即将更新的值，参数e是原内存的值。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">如果是Linux的x86，<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">Atomic::cmpxchg</code>方法的实现如下：</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">inline</span> jint Atomic::cmpxchg (jint exchange_value, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> jint* dest, jint compare_value) {
  <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> mp = os::is_MP();
  __asm__ <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> (LOCK_IF_MP(%<span style="box-sizing:border-box;color:rgb(209, 154, 102);">4</span>) <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;cmpxchgl %1,(%3)&quot;</span>
                    : <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;=a&quot;</span> (exchange_value)
                    : <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;r&quot;</span> (exchange_value), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;a&quot;</span> (compare_value), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;r&quot;</span> (dest), <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;r&quot;</span> (mp)
                    : <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;cc&quot;</span>, <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;memory&quot;</span>);
  <span style="box-sizing:border-box;color:rgb(198, 120, 221);">return</span> exchange_value;
}
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">看到这汇编，内心崩溃 </p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">__asm__</code>表示汇编的开始<br style="box-sizing:border-box;"/>
<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">volatile</code>表示禁止编译器优化<br style="box-sizing:border-box;"/>
<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">LOCK_IF_MP</code>是个内联函数</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(97, 174, 238);">#<span style="box-sizing:border-box;">define</span> LOCK_IF_MP(mp) <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;cmp $0, &quot;</span> #mp <span style="box-sizing:border-box;color:rgb(152, 195, 121);">&quot;; je 1f; lock; 1: &quot;</span></span>
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">Window的x86实现如下：</p>
<pre style="word-wrap:normal;background-color:rgb(245, 245, 245);border:1px solid rgb(204, 204, 204);box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;line-height:1.42857;margin:0px 0px 10px;border-radius:4px;padding:15px;display:block;color:rgb(171, 178, 191);font-size:13px;background:rgb(40, 44, 52);margin-bottom:20px;white-space:pre;overflow-x:auto;overflow:auto;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:inherit;border-radius:0px;font-size:12px;border:none;vertical-align:middle;background-color:transparent;padding:0px;white-space:pre;"><span style="box-sizing:border-box;color:rgb(198, 120, 221);">inline</span> jint Atomic::cmpxchg (jint exchange_value, <span style="box-sizing:border-box;color:rgb(198, 120, 221);">volatile</span> jint* dest, jint compare_value) {
    <span style="box-sizing:border-box;color:rgb(198, 120, 221);">int</span> mp = os::isMP(); <span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">//判断是否是多处理器</span>
    _<span style="box-sizing:border-box;color:rgb(198, 120, 221);">asm</span> {
        mov edx, dest
        mov ecx, exchange_value
        mov eax, compare_value
        LOCK_IF_MP(mp)
        cmpxchg dword ptr [edx], ecx
    }
}

<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// Adding a lock prefix to an instruction on MP machine</span>
<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// VC++ doesn't like the lock prefix to be on a single line</span>
<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// so we can't insert a label after the lock prefix.</span>
<span style="box-sizing:border-box;color:rgb(92, 99, 112);font-style:italic;">// By emitting a lock prefix, we can define a label after it.</span>
<span style="box-sizing:border-box;color:rgb(97, 174, 238);">#define LOCK_IF_MP(mp) __asm cmp mp, 0  \</span>
                       __<span style="box-sizing:border-box;color:rgb(198, 120, 221);">asm</span> je L0      \
                       __<span style="box-sizing:border-box;color:rgb(198, 120, 221);">asm</span> _emit <span style="box-sizing:border-box;color:rgb(209, 154, 102);">0xF0</span> \
                       __<span style="box-sizing:border-box;color:rgb(198, 120, 221);">asm</span> L0:
</code></pre>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;"><code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">LOCK_IF_MP</code>根据当前系统是否为多核处理器决定是否为cmpxchg指令添加lock前缀。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">如果是多处理器，为cmpxchg指令添加lock前缀。</li>
<li style="box-sizing:border-box;line-height:30px;">反之，就省略lock前缀。（单处理器会不需要lock前缀提供的内存屏障效果）</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">intel手册对lock前缀的说明如下：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:10px;padding:0px;margin:-5px 0px 20px 20px;word-break:break-word;">
<li style="box-sizing:border-box;line-height:30px;">确保后续指令执行的原子性。<br style="box-sizing:border-box;"/>
在Pentium及之前的处理器中，带有lock前缀的指令在执行期间会锁住总线，使得其它处理器暂时无法通过总线访问内存，很显然，这个开销很大。在新的处理器中，Intel使用缓存锁定来保证指令执行的原子性，缓存锁定将大大降低lock前缀指令的执行开销。</li>
<li style="box-sizing:border-box;line-height:30px;">禁止该指令与前面和后面的读写指令重排序。</li>
<li style="box-sizing:border-box;line-height:30px;">把写缓冲区的所有数据刷新到内存中。</li>
</ol>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">上面的第2点和第3点所具有的内存屏障效果，保证了CAS同时具有volatile读和volatile写的内存语义。</p>
<h3 style="box-sizing:border-box;font-family:inherit;margin-top:20px;margin-bottom:10px;font-weight:700;line-height:1.7;color:rgb(47, 47, 47);font-size:22px;margin:0px 0px 15px;text-rendering:optimizeLegibility;">CAS缺点</h3>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">CAS存在一个很明显的问题，即ABA问题。</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">问题：如果变量V初次读取的时候是A，并且在准备赋值的时候检查到它仍然是A，那能说明它的值没有被其他线程修改过了吗？</p>
<p style="box-sizing:border-box;margin:0px 0px 25px;word-break:break-word;">如果在这段期间曾经被改成B，然后又改回A，那CAS操作就会误认为它从来没有被修改过。针对这种情况，java并发包中提供了一个带有标记的原子引用类<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;color:rgb(199, 37, 78);border-radius:4px;font-size:12px;background-color:rgb(246, 246, 246);padding:2px 4px;border:none;white-space:pre-wrap;vertical-align:middle;">AtomicStampedReference</code>，它可以通过控制变量值的版本来保证CAS的正确性。</p>
<div style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;">
<div style="box-sizing:border-box;z-index:100;position:relative;background-color:transparent;transition:background-color 0.1s linear;margin:0px auto;max-width:700px;max-height:400px;">
<div style="box-sizing:border-box;z-index:50;padding-bottom:57.25%;"></div>
<div style="box-sizing:border-box;position:absolute;top:0px;left:0px;width:100%;height:100%;overflow:hidden;"><img src="深入浅出CAS_files/700" type="image/png" data-filename="700" height="401" style="transition:all 0.15s linear;border:0px;vertical-align:middle;max-width:100%;height:auto;box-sizing:border-box;z-index:100;filter:blur(0px);opacity:1;display:block;cursor:zoom-in;" width="700"/></div>
</div>

</div>

          </div>
        </div>
    </div></div></div></div></div></div>
</div>
</span>
</div></body></html> 