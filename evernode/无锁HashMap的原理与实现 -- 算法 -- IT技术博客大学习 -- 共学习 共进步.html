<html>
<head>
  <title>无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步！</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="7537"/>
<h1>无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步！</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2015/10/18 14:55</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blogread.cn/it/article/6449"><i>http://blogread.cn/it/article/6449</i></a></td></tr>
</table>
</div>
<br/>

<div><span><br/><div style="font-size: 16px"><div><div style="font-size:14px;text-align:center;background:rgb(214, 234, 247);font-family:'Microsoft Yahei', 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti;"><div><div style="text-align:left;overflow:hidden;"><div><div style="overflow:hidden;border-radius:5px;background:rgb(255, 255, 255);">
				<div style="padding:1px 0px;text-align:center;"><h2>无锁HashMap的原理与实现</h2></div>
				<div style="text-align:right;padding-right:5px;line-height:25px;font-size:12px;">
											<div style="width:106px;height:24px;position:relative;"><div style="font-size: 16px"><div> 
    <div style="padding:0px;margin:0px;background-color:transparent;">
        <div style="padding:0px;text-align:center;font-size:12px;">
			<div style="text-align:right;">
				
				<p style="padding:0px;margin:0px;text-align:center;"><a href="http://service.weibo.com/staticjs/weiboshare.html?url=http%3A%2F%2Fblogread.cn%2Fit%2Farticle%2F6449%3Ff%3Dwb1&amp;type=5&amp;count=&amp;appkey=3741373929&amp;title=%E3%80%90%E6%97%A0%E9%94%81HashMap%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%91HashMap%E4%B8%BB%E8%A6%81%E6%9C%89%E6%8F%92%E5%85%A5%E3%80%81%E5%88%A0%E9%99%A4%E3%80%81%E6%9F%A5%E6%89%BE%E4%BB%A5%E5%8F%8AReHash%E5%9B%9B%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E3%80%82%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E7%9A%84HashMap%E5%AE%9E%E7%8E%B0%EF%BC%8C%E4%BC%9A%E7%94%A8%E5%88%B0%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%EF%BC%8C%E6%95%B0%E7%BB%84%E7%9A%84%E6%AF%8F%E9%A1%B9%E5%85%83%E7%B4%A0%E4%B8%BA%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E9%93%BE%E8%A1%A8%E3%80%82%E5%AF%B9%E4%BA%8E%E6%AD%A4%E9%93%BE%E8%A1%A8%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E6%96%87%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95%EF%BC%8C%E6%89%A7%E8%A1%8C%E6%8F%92%E5%85%A5%E3%80%81%E5%88%A0%E9%99%A4%E4%BB%A5%E5%8F%8A%E6%9F%A5%E6%89%BE%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BD%86%E5%AF%B9%E4%BA%8EReHash%E6%93%8D%E4%BD%9C%E5%88%99%E6%AF%94%E8%BE%83%E5%9B%B0%E9%9A%BE%E3%80%82&amp;pic=&amp;ralateUid=1646218964&amp;language=zh_cn&amp;rnd=1445147774939&amp;refer=http%3A%2F%2Fblogread.cn%2Fit%2Farticle%2F6449%3Ff%3Dwb&amp;dpc=1#" style="outline:none;" title="分享到微博"><img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/transparent.gif" type="image/gif" data-filename="transparent.gif" height="24" style="border:none;background:url(http://img.t.sinajs.cn/t35/appstyle/opent/images/app/btn_trans.gif?id=201104131414) 0px 0px;width:106px;height:24px;background-position:-32px -32px;" width="106"/></a></p>
			</div>
		</div>
     
</div></div></div></div>
															浏览:3502次  <a href="http://blogread.cn/it/article/6449?f=wb#original" style="text-decoration:none;">出处信息</a>
				</div>

				<div style="line-height:25px;padding:15px 5px;font-size:16px;background:rgb(255, 255, 255);">
										<div style="float:right;margin:4px;">

												
						
						<ins style="display:inline-block;width:336px;height:280px;"></ins>
						
												
					</div>
					
					<p>    <strong> (本文由<a href="https://github.com/onetwogoo" rel="author" style="text-decoration:none;">onetwogoo</a>投稿)</strong></p><p>    在《<a href="http://coolshell.cn/articles/9606.html" style="text-decoration:none;" target="_blank" title="疫苗：Java HashMap的死循环">疫苗：Java HashMap的死循环</a>》中，我们看到，java.util.HashMap并不能直接应用于多线程环境。对于多线程环境中应用HashMap，主要有以下几种选择：</p><ul><li><p>使用线程安全的java.util.Hashtable作为替代。</p></li><li><p>使用java.util.Collections.synchronizedMap方法，将已有的HashMap对象包装为线程安全的。</p></li><li><p>使用java.util.concurrent.ConcurrentHashMap类作为替代，它具有非常好的性能。</p></li><p>    而以上几种方法在实现的具体细节上，都或多或少地用到了互斥锁。互斥锁会造成线程阻塞，降低运行效率，并有可能产生死锁、优先级翻转等一系列问题。</p><p>    CAS(Compare And Swap)是一种底层硬件提供的功能，它可以将判断并更改一个值的操作原子化。关于CAS的一些应用，《<a href="http://coolshell.cn/articles/8239.html" style="text-decoration:none;" target="_blank" title="无锁队列的实现">无锁队列的实现</a>》一文中有很详细的介绍。</p><h4>Java中的原子操作</h4><p>    在java.util.concurrent.atomic包中，Java为我们提供了很多方便的原子类型，它们底层完全基于CAS操作。</p><p>    例如我们希望实现一个全局公用的计数器，那么可以：</p><div><div style="width:96%;margin:1em 0px;position:relative;font-size:1em;background-color:white;"><div style="top:1px;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;font-style:normal;text-align:left;font-weight:normal;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;box-sizing:content-box;width:11px;border:none;right:1px;font-size:10px;position:absolute;background:rgb(108, 226, 108);height:11px;z-index:10;color:white;"><span><a href="http://blogread.cn/it/article/6449?f=wb#" style="text-align:center;text-decoration:none;border:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border-radius:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;display:block;padding-top:1px;color:white;">?</a></span></div><table border="0" cellpadding="0" cellspacing="0" style="overflow:visible;font-size:1em;font-style:normal;font-variant:inherit;border-radius:0px;border:1px solid rgb(192, 192, 192);float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;font-weight:normal;padding:0px;position:static;right:auto;text-align:left;top:auto;width:100%;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;min-height:inherit;background:none;"><tbody style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><tr style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><td style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;padding:5px;color:rgb(0, 0, 0);"><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">1</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">2</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">3</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">4</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">5</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">6</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">7</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">8</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">9</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">10</div></td><td style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;min-height:inherit;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;width:92%;"><div style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;position:relative;"><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">private</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">AtomicInteger counter = </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">new</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">AtomicInteger(</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:rgb(0, 153, 0);">3</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">);</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"> </code> </div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">public</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">void</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">addCounter() {</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">for</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">(;;) {</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">int</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">oldValue = counter.get();</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">int</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">newValue = oldValue + </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:rgb(0, 153, 0);">1</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">;</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">if</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">(counter.compareAndSet(oldValue, newValue))</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">            </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">return</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">;</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">}</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">}</code></div></div></td></tr></tbody></table></div></div><p>    其中，compareAndSet方法会检查counter现有的值是否为oldValue，如果是，则将其设置为新值newValue，操作成功并返回true；否则操作失败并返回false。</p><p>    当计算counter新值时，若其他线程将counter的值改变，compareAndSwap就会失败。此时我们只需在外面加一层循环，不断尝试这个过程，那么最终一定会成功将counter值+1。(其实AtomicInteger已经为常用的+1/-1操作定义了incrementAndGet与decrementAndGet方法，以后我们只需简单调用它即可)</p><p>    除了AtomicInteger外，java.util.concurrent.atomic包还提供了AtomicReference和AtomicReferenceArray类型，它们分别代表原子性的引用和原子性的引用数组(引用的数组)。</p><h4>无锁链表的实现</h4><p>    在实现无锁HashMap之前，让我们先来看一下比较简单的无锁链表的实现方法。</p><p>    以插入操作为例：</p><li><p>首先我们需要找到待插入位置前面的节点A和后面的节点B。</p></li><li><p>然后新建一个节点C，并使其next指针指向节点B。(见图1)</p></li><li><p>最后使节点A的next指针指向节点C。(见图2)</p></li><p>    <img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/图1-3.jpg" type="image/jpeg" data-filename="图1-3.jpg" height="479" width="600"/></p><p>    但在操作中途，有可能其他线程在A与B直接也插入了一些节点(假设为D)，如果我们不做任何判断，可能造成其他线程插入节点的丢失。(见图3)我们可以利用CAS操作，在为节点A的next指针赋值时，判断其是否仍然指向B，如果节点A的next指针发生了变化则重试整个插入操作。大致代码如下：</p><div><div style="width:96%;margin:1em 0px;position:relative;font-size:1em;background-color:white;"><div style="top:1px;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;font-style:normal;text-align:left;font-weight:normal;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;box-sizing:content-box;width:11px;border:none;right:1px;font-size:10px;position:absolute;background:rgb(108, 226, 108);height:11px;z-index:10;color:white;"><span><a href="http://blogread.cn/it/article/6449?f=wb#" style="text-align:center;text-decoration:none;border:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border-radius:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;display:block;padding-top:1px;color:white;">?</a></span></div><table border="0" cellpadding="0" cellspacing="0" style="overflow:visible;font-size:1em;font-style:normal;font-variant:inherit;border-radius:0px;border:1px solid rgb(192, 192, 192);float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;font-weight:normal;padding:0px;position:static;right:auto;text-align:left;top:auto;width:100%;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;min-height:inherit;background:none;"><tbody style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><tr style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><td style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;padding:5px;color:rgb(0, 0, 0);"><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">1</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">2</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">3</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">4</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">5</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">6</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">7</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">8</div></td><td style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;min-height:inherit;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;width:92%;"><div style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;position:relative;"><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">private</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">void</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">listInsert(Node head, Node c) {</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">for</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">(;;) {</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">Node a = findInsertionPlace(head), b = a.next.get();</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">c.next.set(b);</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">if</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">(a.next.compareAndSwap(b,c))</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">            </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">return</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">;</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">}</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">}</code></div></div></td></tr></tbody></table></div></div><p>    (Node类的next字段为AtomicReference&lt;Node&gt;类型，即指向Node类型的原子性引用)</p><p>    无锁链表的查找操作与普通链表没有区别。而其删除操作，则需要找到待删除节点前方的节点A和后方的节点B，利用CAS操作验证并更新节点A的next指针，使其指向节点B。</p><h4>无锁HashMap的难点与突破</h4><p>    HashMap主要有<strong>插入</strong>、<strong>删除</strong>、<strong>查找</strong>以及<strong>ReHash</strong>四种基本操作。一个典型的HashMap实现，会用到一个数组，数组的每项元素为一个节点的链表。对于此链表，我们可以利用上文提到的操作方法，执行插入、删除以及查找操作，但对于ReHash操作则比较困难。</p><p>    <img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/图4.jpg" type="image/jpeg" data-filename="图4.jpg" height="265" width="648"/></p><p>    如图4，在ReHash过程中，一个典型的操作是遍历旧表中的每个节点，计算其在新表中的位置，然后将其移动至新表中。期间我们需要操纵3次指针：</p><li><p>将A的next指针指向D</p></li><li><p>将B的next指针指向C</p></li><li><p>将C的next指针指向E</p></li><p>    而这三次指针操作必须同时完成，才能保证移动操作的原子性。但我们不难看出，CAS操作每次只能保证<strong>一个</strong>变量的值被原子性地验证并更新，无法满足同时验证并更新三个指针的需求。</p><p>    于是我们不妨换一个思路，既然移动节点的操作如此困难，我们可以使所有节点始终保持有序状态，从而避免了移动操作。在典型的HashMap实现中，数组的长度始终保持为2i，而从Hash值映射为数组下标的过程，只是简单地对数组长度执行取模运算(即仅保留Hash二进制的后i位)。当ReHash时，数组长度加倍变为2i+1，旧数组第j项链表中的每个节点，要么移动到新数组中第j项，要么移动到新数组中第j+2i项，而它们的唯一区别在于Hash值第i+1位的不同(第i+1位为0则仍为第j项，否则为第j+2i项)。</p><p style="text-align:center;"><img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/图5-6.jpg" type="image/jpeg" data-filename="图5-6.jpg" height="297" width="690"/></p><p>    如图5，我们将所有节点按照Hash值的翻转位序(如1101-&gt;1011)由小到大排列。当数组大小为8时，2、18在一个组内；3、11、27在另一个组内。每组的开始，插入一个哨兵节点，以方便后续操作。为了使哨兵节点正确排在组的最前方，我们将正常节点Hash的最高位(翻转后变为最低位)置为1，而哨兵节点不设置这一位。</p><p>    当数组扩容至16时(见图6)，第二组分裂为一个只含3的组和一个含有11、27的组，但节点之间的相对顺序并未改变。这样在ReHash时，我们就不需要移动节点了。</p><h4>实现细节</h4><p>    由于扩容时数组的复制会占用大量的时间，这里我们采用了将整个数组分块，懒惰建立的方法。这样，当访问到某下标时，仅需判断此下标所在块是否已建立完毕(如果没有则建立)。</p><p>    另外定义size为当前已使用的下标范围，其初始值为2，数组扩容时仅需将size加倍即可；定义count代表目前HashMap中包含的总节点个数(不算哨兵节点)。</p><p>    初始时，数组中除第0项外，所有项都为null。第0项指向一个仅有一个哨兵节点的链表，代表整条链的起点。初始时全貌见图7，其中浅绿色代表当前未使用的下标范围，虚线箭头代表逻辑上存在，但实际未建立的块。</p><p>    <img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/图7.jpg" type="image/jpeg" data-filename="图7.jpg" height="282" width="446"/></p><h5>初始化下标操作</h5><p>    数组中为null的项都认为处于未初始化状态，初始化某个下标即代表建立其对应的哨兵节点。初始化是递归进行的，即若其父下标未初始化，则先初始化其父下标。(一个下标的父下标是其移除最高二进制位后得到的下标)大致代码如下：</p><div><div style="width:96%;margin:1em 0px;position:relative;font-size:1em;background-color:white;"><div style="top:1px;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;font-style:normal;text-align:left;font-weight:normal;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;box-sizing:content-box;width:11px;border:none;right:1px;font-size:10px;position:absolute;background:rgb(108, 226, 108);height:11px;z-index:10;color:white;"><span><a href="http://blogread.cn/it/article/6449?f=wb#" style="text-align:center;text-decoration:none;border:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border-radius:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;display:block;padding-top:1px;color:white;">?</a></span></div><table border="0" cellpadding="0" cellspacing="0" style="overflow:visible;font-size:1em;font-style:normal;font-variant:inherit;border-radius:0px;border:1px solid rgb(192, 192, 192);float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;font-weight:normal;padding:0px;position:static;right:auto;text-align:left;top:auto;width:100%;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;min-height:inherit;background:none;"><tbody style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><tr style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"><td style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;padding:5px;color:rgb(0, 0, 0);"><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">1</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">2</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">3</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">4</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">5</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">6</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">7</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">8</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">9</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:white;border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">10</div><div style="width:auto;white-space:nowrap;box-sizing:content-box;float:none;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;min-height:inherit;top:auto;border:0px;left:auto;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;border-radius:0px;background-color:rgb(250, 250, 250);border-right-width:3px;border-right-style:solid;border-right-color:rgb(108, 226, 108);text-align:right;padding:0px 0.5em 0px 1em;">11</div></td><td style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;min-height:inherit;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;width:92%;"><div style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;min-height:inherit;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;background:none;position:relative;"><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">private</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">void</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">initializeBucket(</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">int</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">bucketIdx) {</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">int</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">parentIdx = bucketIdx ^ Integer.highestOneBit(bucketIdx);</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">if</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">(getBucket(parentIdx) == </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">null</code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">)</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">        </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">initializeBucket(parentIdx);</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"> </code> </div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">Node dummy = </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">new</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">Node();</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">dummy.hash = Integer.reverse(bucketIdx);</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">dummy.next = </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;background:none;font-style:normal;font-size:1em;min-height:inherit;font-weight:bold;color:rgb(0, 102, 153);">new</code> <code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">AtomicReference&amp;lt;&amp;gt;();</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;"> </code> </div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:white;padding:0px 1em;"><code style="right:auto;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;border:0px;text-align:left;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;">    </code><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">setBucket(bucketIdx, listInsert(getBucket(parentIdx), dummy));</code></div><div style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;background:none;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background-color:rgb(250, 250, 250);padding:0px 1em;"><code style="text-align:left;border-radius:0px;float:none;left:auto;line-height:1.1em;margin:0px;outline:0px;overflow:visible;padding:0px;position:static;right:auto;border:0px;top:auto;width:auto;box-sizing:content-box;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;font-weight:normal;font-style:normal;font-size:1em;min-height:inherit;background:none;color:black;">}</code></div></div></td></tr></tbody></table></div></div><p>    其中getBucket即封装过的获取数组某下标内容的方法，setBucket同理。listInsert将从指定位置开始查找适合插入的位置插入给定的节点，若链表中已存在hash相同的节点则返回那个已存在的节点；否则返回新插入的节点。</p><h5>插入操作</h5><li><p>首先用HashMap的size对键的hashCode取模，得到应插入的数组下标。</p></li><li><p>然后判断该下标处是否为null，如果为null则初始化此下标。</p></li><li><p>构造一个新的节点，并插入到适当位置，注意节点中的hash值应为原hashCode经过位翻转并将最低位置1之后的值。</p></li><li><p>将节点个数计数器加1，若加1后节点过多，则仅需将size改为size*2，代表对数组扩容(ReHash)。</p></li><h5>查找操作</h5><li><p>找出待查找节点在数组中的下标。</p></li><li><p>判断该下标处是否为null，如果为null则返回查找失败。</p></li><li><p>从相应位置进入链表，顺次寻找，直至找出待查找节点或超出本组节点范围。</p></li><h5>删除操作</h5><li><p>找出应删除节点在数组中的下标。</p></li><li><p>判断该下标处是否为null，如果为null则初始化此下标。</p></li><li><p>找到待删除节点，并从链表中删除。(注意由于哨兵节点的存在，任何正常元素只被其唯一的前驱节点所引用，不存在被前驱节点与数组中指针同时引用的情况，从而不会出现需要同时修改多个指针的情况)</p></li><li><p>将节点个数计数器减1。</p></li><h4>参考文献</h4><p>    <a href="http://www.cs.ucf.edu/~dcm/Teaching/COT4810-Spring2011/Literature/SplitOrderedLists.pdf" style="text-decoration:none;" target="_blank" title="《Split-Ordered Lists:Lock-Free Extensible Hash Tables》">《Split-Ordered Lists: Lock-Free Extensible Hash Tables》</a></p><p>    (全文完)<br/></p><div><div><ul><li></li></ul></div></div><p><br/></p></ul>
						
										<div>
						
						
						<ins style="display:inline-block;width:728px;height:90px;"></ins>
						
					</div>
										
										<div style="margin:10px 0px;padding:10px;background:#F3F781;text-align:center;-moz-border-radius:5px;border-radius:5px;">
					觉得文章有用？立即：
<div style="width:106px;height:24px;position:relative;"><div style="font-size: 16px"><div> 
    <div style="padding:0px;margin:0px;background-color:transparent;">
        <div style="padding:0px;text-align:center;font-size:12px;">
			<div style="text-align:right;">
				
				<p style="padding:0px;margin:0px;text-align:center;"><a href="http://service.weibo.com/staticjs/weiboshare.html?url=http%3A%2F%2Fblogread.cn%2Fit%2Farticle%2F6449%3Ff%3Dwb2&amp;type=5&amp;count=&amp;appkey=3741373929&amp;title=%E3%80%90%E6%97%A0%E9%94%81HashMap%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0%E3%80%91HashMap%E4%B8%BB%E8%A6%81%E6%9C%89%E6%8F%92%E5%85%A5%E3%80%81%E5%88%A0%E9%99%A4%E3%80%81%E6%9F%A5%E6%89%BE%E4%BB%A5%E5%8F%8AReHash%E5%9B%9B%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E3%80%82%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E7%9A%84HashMap%E5%AE%9E%E7%8E%B0%EF%BC%8C%E4%BC%9A%E7%94%A8%E5%88%B0%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%EF%BC%8C%E6%95%B0%E7%BB%84%E7%9A%84%E6%AF%8F%E9%A1%B9%E5%85%83%E7%B4%A0%E4%B8%BA%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E9%93%BE%E8%A1%A8%E3%80%82%E5%AF%B9%E4%BA%8E%E6%AD%A4%E9%93%BE%E8%A1%A8%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E6%96%87%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95%EF%BC%8C%E6%89%A7%E8%A1%8C%E6%8F%92%E5%85%A5%E3%80%81%E5%88%A0%E9%99%A4%E4%BB%A5%E5%8F%8A%E6%9F%A5%E6%89%BE%E6%93%8D%E4%BD%9C%EF%BC%8C%E4%BD%86%E5%AF%B9%E4%BA%8EReHash%E6%93%8D%E4%BD%9C%E5%88%99%E6%AF%94%E8%BE%83%E5%9B%B0%E9%9A%BE%E3%80%82&amp;pic=&amp;ralateUid=1646218964&amp;language=zh_cn&amp;rnd=1445147774950&amp;refer=http%3A%2F%2Fblogread.cn%2Fit%2Farticle%2F6449%3Ff%3Dwb&amp;dpc=1#" style="outline:none;" title="分享到微博"><img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/transparent [1].gif" type="image/gif" data-filename="transparent.gif" height="24" style="border:none;background:url(http://img.t.sinajs.cn/t35/appstyle/opent/images/app/btn_trans.gif?id=201104131414) 0px 0px;width:106px;height:24px;background-position:-32px -32px;" width="106"/></a></p>
			</div>
		</div>
     
</div></div></div></div>
						和朋友一起 <strong>共学习 共进步！</strong>
						
										</div>
										
										<h3>建议继续学习：</h3>
					<ol>
													<li><a href="http://blogread.cn/it/article/5271?f=sa" style="text-decoration:none;">关于memcache分布式一致性hash    <span style="font-size:14px;">(阅读：6077)</span></a></li>
													<li><a href="http://blogread.cn/it/article/2337?f=sa" style="text-decoration:none;">关于使用STL的红黑树map还是hashmap的问题    <span style="font-size:14px;">(阅读：4843)</span></a></li>
													<li><a href="http://blogread.cn/it/article/516?f=sa" style="text-decoration:none;">如果用户在5分钟内重复上线，就给他发警告，问如何设计？    <span style="font-size:14px;">(阅读：4122)</span></a></li>
													<li><a href="http://blogread.cn/it/article/5983?f=sa" style="text-decoration:none;">MinHash原理与应用    <span style="font-size:14px;">(阅读：3690)</span></a></li>
													<li><a href="http://blogread.cn/it/article/5941?f=sa" style="text-decoration:none;">LVS hash size解决4096个并发的问题    <span style="font-size:14px;">(阅读：3330)</span></a></li>
													<li><a href="http://blogread.cn/it/article/2338?f=sa" style="text-decoration:none;">MySQL锁管理(并发锁,行锁,表锁,预加锁,全局锁等等)    <span style="font-size:14px;">(阅读：3096)</span></a></li>
													<li><a href="http://blogread.cn/it/article/1633?f=sa" style="text-decoration:none;">分布式系统hash策略    <span style="font-size:14px;">(阅读：3074)</span></a></li>
													<li><a href="http://blogread.cn/it/article/3222?f=sa" style="text-decoration:none;">DYNAMO平台的独门绝技： 利用NWR模型与vector clock解决锁问题    <span style="font-size:14px;">(阅读：2969)</span></a></li>
													<li><a href="http://blogread.cn/it/article/4003?f=sa" style="text-decoration:none;">redis源代码分析 - hash table    <span style="font-size:14px;">(阅读：2942)</span></a></li>
													<li><a href="http://blogread.cn/it/article/665?f=sa" style="text-decoration:none;">一致性hash算法    <span style="font-size:14px;">(阅读：2909)</span></a></li>
												
					</ol>
										
					<div style="margin:10px 0px;padding:10px;text-align:center;-moz-border-radius:5px;border-radius:5px;">
						<b>QQ技术交流群：445447336，欢迎加入！</b><br/>
						<b>扫一扫订阅我的微信号：IT技术博客大学习</b><br/>
						<div style="height:258px;position:relative;"><div style="font-size: 16px"><div><div style="margin:0px;"><img src="无锁HashMap的原理与实现 -- 算法 -- IT技术博客大学习 -- 共学习 共进步_files/Image.jpg" type="image/jpeg" data-filename="Image.jpg" height="258" style="-webkit-user-select:none;" width="258"/></div></div></div></div>
					</div>

				</div>

			</div></div></div></div></div></div></div><br/></span>
</div></body></html> 