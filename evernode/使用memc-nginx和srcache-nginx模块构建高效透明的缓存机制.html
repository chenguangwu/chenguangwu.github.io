<html>
<head>
  <title>使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3318"/>
<h1>使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/10/12 15:12</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://blog.codinglabs.org/articles/nginx-memc-and-srcache.html"><i>http://blog.codinglabs.org/articles/nginx-memc-and-srcache.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span>
  <div>
<div style="font-size: 16px; display: inline-block; min-width: 100%;"><div style="font-family:sans-serif;text-size-adjust:100%;"><div style="font-family:&quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Hiragino Sans GB&quot;, &quot;Hiragino Sans GB W3&quot;, &quot;WenQuanYi Micro Hei&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, sans-serif;"><div><div><div>
            <p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">为了提高性能，几乎所有互联网应用都有缓存机制，其中<a href="http://memcached.org/" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">Memcache</a>是使用非常广泛的一个分布式缓存系统。众所周知，LAMP是非常经典的Web架构方式，但是随着<a href="http://wiki.nginx.org/" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">Nginx</a>的成熟，越来越多的系统开始转型为LNMP（Linux+Nginx+MySQL+PHP with fpm），这是因为Nginx采用基于事件机制的I/O多路复用思想设计，在高并发情况下其性能远远优于默认采用prefork模式的Apache，另外，相对于Apache，Nginx更轻量，同时拥有大量优秀的扩展模块，使得在Nginx上可以实现一些美妙的功能。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">传统上，PHP中使用memcache的方法是使用<a href="http://pecl.php.net/package/memcache" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">php-memcache</a>或<a href="http://pecl.php.net/package/memcached" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">php-memached</a>扩展操作memcache，然而在Nginx上有构建更高效缓存机制的方法，本文将首先介绍这种机制，然后介绍具体的操作步骤方法，最后将对这种机制和传统的PHP操作memcache的性能进行一个benchmark。

</p>
<h1 style="font-size:2em;font-weight:normal;color:rgb(42, 42, 42);">Nginx的Memc和SR Cache模块</h1>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">缓存策略的改进</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">我们知道，Nginx的核心设计思想是事件驱动的非阻塞I/O。Nginx被设计为可以配置I/O多路复用策略，在Unix系统中传统的多路复用是采用select或poll，但是这两个方法的问题是随着监听socket的增加，性能会下降，因为在linux内核中是采用轮询的方式判断是否可以触发事件，换句话说算法的复杂度为O(N)，而在较新的linux内核中引入了复杂度为O(1)的epoll，因此Nginx在Linux下默认采用epoll，而在FreeBSD下默认采用kqueue作为I/O策略。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">即便是这样，传统的缓存策略仍可能造成效率低下，因为传统上是通过PHP操作memcache的，要执行PHP代码，Nginx就必然要和FastCGI通信，同时也要进入PHP的生命周期，因此SAPI、PHP Core和Zend Engine的一系列逻辑会被执行。<strike>更糟糕的是，fpm和PHP可能会阻塞，因此破坏了Nginx的非阻塞性。</strike>（原文中此处表述有误，fastcgi与nginx进行同步通信，但并不会破坏nginx i/o的非阻塞性，多谢<a href="http://agentzh.org/" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">agentzh</a>给予指正）下图展示了在memcache命中时整个处理过程。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image.png" type="image/png" data-filename="Image.png" height="265" style="border:0px;" width="644"/></p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">可以看到，即使memcache命中，还是要进入PHP的生命周期。我们知道，目前很多互联网应用都使用RESTful规范进行设计，在RESTful应用下，普遍使用uri和查询参数作为缓存的key，因此一种更高效的缓存策略是Nginx直接访问memcache，并用<span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:2.659em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:2.19em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.201em, 1002.19em, 2.503em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">u</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">r</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">和</span></span></span></span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.309em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:1.316em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">u</span><span style="transition:none;">r</span><span style="transition:none;">i</span><span style="transition:none;"><span style="transition:none;">和</span></span></span></span></span>args等Nginx内置变量设定缓存key规则，这样，当缓存命中时，Nginx可以跳过通过fastcgi和PHP通信的过程，直接从memcache中获取数据并返回。memc-nginx和srcache-nginx正是利用这种策略提高了缓存的效率。下图是这种高效缓存策略的示意图（当memcache命中时）。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [1].png" type="image/png" data-filename="Image.png" height="265" style="border:0px;" width="590"/></p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">模块介绍</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);"><a href="http://wiki.nginx.org/HttpMemcModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">memc-nginx</a>和<a href="http://wiki.nginx.org/HttpSRCacheModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">srcache-nginx</a>模块均为前淘宝工程师agentzh（章亦春）开发。其中memc模块扩展了Nginx标准的memcache模块，增加了set、add、delete等memcache命令，而srcache则是为location增加了透明的基于subrequest的缓存层。两者配合使用，可以实现上一节提到的高效缓存机制。关于两个模块的详细信息可以参考它们Nginx官网的wiki（<a href="http://wiki.nginx.org/HttpMemcModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">memc wiki</a>，<a href="http://wiki.nginx.org/HttpSRCacheModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">srcache wiki</a>）页。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">安装及配置</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">下面以LNMP环境介绍如何使用这两个模块构建缓存层。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">因为Nginx并不支持模块动态加载，所以要安装新的模块，必须重新编译Nginx。首先下载两个模块（<a href="https://github.com/agentzh/memc-nginx-module/downloads" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">memc下载地址</a>，<a href="https://github.com/agentzh/srcache-nginx-module/downloads" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">srcache下载地址</a>），另外，为了发挥出缓存的最大性能，建议将memcache的upstream配置为keep-alive，为了支持upstream的keep-alive需要同时安装<a href="http://wiki.nginx.org/HttpUpstreamKeepaliveModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">http-upstream-keepalive-module</a>。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">将模块下载并解压到合适的目录，这里我Nginx使用的版本是1.0.4，与相关模块一起解压到了/home/zhangyang/downloads，如下图所示。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [2].png" type="image/png" data-filename="Image.png" height="382" style="border:0px;" width="764"/></p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">其中红框框起来的是我们需要用到的模块。进入nginx目录，执行下列命令：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(42, 161, 152);">/configure --prefix=/</span><span style="color:rgb(38, 139, 210);">usr</span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(203, 75, 22);">local</span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">nginx \</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">--</span><span style="color:rgb(38, 139, 210);">add</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(203, 75, 22);">module</span><span style="color:rgb(131, 148, 150);">=../</span><span style="color:rgb(38, 139, 210);">memc</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(38, 139, 210);">nginx</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(203, 75, 22);">module</span><span style="color:rgb(38, 139, 210);"> \</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">--</span><span style="color:rgb(38, 139, 210);">add</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(203, 75, 22);">module</span><span style="color:rgb(131, 148, 150);">=../</span><span style="color:rgb(38, 139, 210);">srcache</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(38, 139, 210);">nginx</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(203, 75, 22);">module</span><span style="color:rgb(38, 139, 210);"> \</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">--</span><span style="color:rgb(38, 139, 210);">add</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(203, 75, 22);">module</span><span style="color:rgb(131, 148, 150);">=../</span><span style="color:rgb(38, 139, 210);">ngx_http_upstream_keepalive</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">make</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">make install</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这里我将nginx安装到/usr/local/nginx下，你可以根据自己的需要更改安装路径，另外，我只列出了本文必要的configure命令，你也可以增加需要的configure选项。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">然后需要对nginx进行配置，nginx默认主配置文件放在安装目录的conf下，例如我的主配置文件为/usr/local/nginx/conf/nginx.conf。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这里我只贴出相关的配置：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(88, 97, 117);font-style:italic;">#Memcache服务upstream</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">upstream memcache </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    server localhost</span><span style="color:rgb(131, 148, 150);">:</span><span style="color:rgb(42, 161, 152);">11211</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    keepalive </span><span style="color:rgb(42, 161, 152);">512</span><span style="color:rgb(38, 139, 210);"> single</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">}</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">server </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    listen       </span><span style="color:rgb(42, 161, 152);">80</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    server_name  localhost</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(88, 97, 117);font-style:italic;">#memc-nginx-module</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    location </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">memc </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        </span><span style="color:rgb(203, 75, 22);">internal</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        memc_connect_timeout </span><span style="color:rgb(42, 161, 152);">100ms</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        memc_send_timeout </span><span style="color:rgb(42, 161, 152);">100ms</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        memc_read_timeout </span><span style="color:rgb(42, 161, 152);">100ms</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> $memc_key $query_string</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> $memc_exptime </span><span style="color:rgb(42, 161, 152);">300</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        memc_pass memcache</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(131, 148, 150);">}</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    location </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        root   </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(203, 75, 22);">var</span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">www</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        index  index</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">html index</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">htm index</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">php</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(131, 148, 150);">}</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(88, 97, 117);font-style:italic;"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(88, 97, 117);font-style:italic;">#</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    location </span><span style="color:rgb(131, 148, 150);">~</span><span style="color:rgb(38, 139, 210);"> \.php$ </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        charset        utf</span><span style="color:rgb(131, 148, 150);">-</span><span style="color:rgb(42, 161, 152);">8</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        default_type   text</span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">html</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        </span><span style="color:rgb(88, 97, 117);font-style:italic;">#srcache-nginx-module</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> $key $uri$args</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        srcache_fetch GET </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">memc $key</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        srcache_store PUT </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">memc $key</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        root           </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(203, 75, 22);">var</span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">www</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        fastcgi_pass   </span><span style="color:rgb(42, 161, 152);">127.0</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(42, 161, 152);">0.1</span><span style="color:rgb(131, 148, 150);">:</span><span style="color:rgb(42, 161, 152);">9000</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        fastcgi_index  index</span><span style="color:rgb(131, 148, 150);">.</span><span style="color:rgb(38, 139, 210);">php</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        include        fastcgi_params</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(131, 148, 150);">}</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">}</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">下面解释一下其中几个点。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">上文说过，memc-nginx是一个标准的upstream模块，因此首先需要定义memcache的upstream。这里我在本机上启动了一个memcache服务，端口为默认的11211，keepalive指令是http-upsteram-keepalive-module提供的功能，这里我们最大保持512个不立即关闭的连接用于提升性能。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">下面是为memc-nginx-module配置location，我们配置为/memc，所有请求都通过请求这个location来操作memcache，memc-nginx-module存取memcache是基于http method语义的，使用http的GET方法表示get、PUT方法表示set、DELETE方法表示delete。这里我们将/memc设为<a href="http://wiki.nginx.org/NginxHttpCoreModule#internal" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">internal</a>表示只接受内部访问，不接收外部http请求，这是为了安全考虑，当然如果需要通过http协议开放外部访问，可以去掉internal然后使用<a href="http://wiki.nginx.org/NginxHttpAccessModule#deny" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">deny</a>和<a href="http://wiki.nginx.org/NginxHttpAccessModule#allow" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">allow</a>指令控制权限。比较重要的是<span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:35.003em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:29.169em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.201em, 1029.17em, 2.503em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">m</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">e</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">m</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:relative;line-height:normal;text-decoration:none;transition:none;width:0.888em;height:0px;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(3.44em, 1000.42em, 4.169em, -999.997em);top:-4.008em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">c</span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:4.013em;"></span></span><span style="vertical-align:0px;display:inline;border:0px;padding:0px;margin:0px;position:absolute;line-height:normal;text-decoration:none;transition:none;top:-3.852em;left:0.419em;"><span style="vertical-align:0px;display:inline;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;font-size:70.7%;font-family:MathJax_Math-italic;">k</span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:4.013em;"></span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">e</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">y<span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;overflow:hidden;height:1px;width:0.003em;"></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">这</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">个</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">变</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">量</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">，</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">它</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">表</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">示</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">以</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">什</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">么</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">作</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">为</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">k</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">e</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">y<span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;overflow:hidden;height:1px;width:0.003em;"></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">，</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">这</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">里</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">我</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">们</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">直</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">接</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">使</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">用</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">N<span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;overflow:hidden;height:1px;width:0.107em;"></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">g<span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;overflow:hidden;height:1px;width:0.003em;"></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">n</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">x</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">内</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">置</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">的</span></span></span></span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.309em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:1.316em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">m</span><span style="transition:none;">e</span><span style="transition:none;">m</span><span style="transition:none;"><span style="transition:none;">c</span><span style="transition:none;">k</span></span><span style="transition:none;">e</span><span style="transition:none;">y</span><span style="transition:none;"><span style="transition:none;">这</span></span><span style="transition:none;"><span style="transition:none;">个</span></span><span style="transition:none;"><span style="transition:none;">变</span></span><span style="transition:none;"><span style="transition:none;">量</span></span><span style="transition:none;"><span style="transition:none;">，</span></span><span style="transition:none;"><span style="transition:none;">它</span></span><span style="transition:none;"><span style="transition:none;">表</span></span><span style="transition:none;"><span style="transition:none;">示</span></span><span style="transition:none;"><span style="transition:none;">以</span></span><span style="transition:none;"><span style="transition:none;">什</span></span><span style="transition:none;"><span style="transition:none;">么</span></span><span style="transition:none;"><span style="transition:none;">作</span></span><span style="transition:none;"><span style="transition:none;">为</span></span><span style="transition:none;">k</span><span style="transition:none;">e</span><span style="transition:none;">y</span><span style="transition:none;"><span style="transition:none;">，</span></span><span style="transition:none;"><span style="transition:none;">这</span></span><span style="transition:none;"><span style="transition:none;">里</span></span><span style="transition:none;"><span style="transition:none;">我</span></span><span style="transition:none;"><span style="transition:none;">们</span></span><span style="transition:none;"><span style="transition:none;">直</span></span><span style="transition:none;"><span style="transition:none;">接</span></span><span style="transition:none;"><span style="transition:none;">使</span></span><span style="transition:none;"><span style="transition:none;">用</span></span><span style="transition:none;">N</span><span style="transition:none;">g</span><span style="transition:none;">i</span><span style="transition:none;">n</span><span style="transition:none;">x</span><span style="transition:none;"><span style="transition:none;">内</span></span><span style="transition:none;"><span style="transition:none;">置</span></span><span style="transition:none;"><span style="transition:none;">的</span></span></span></span></span>query_string来作为key，$memc_exptime表示缓存失效时间，以秒记。这里统一设为300（5分钟），在实际应用中可以根据具体情况为不同的内容设置不同的过期时间。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">最后我们为“~ \.php$”这个location配置了缓存，这表示所有以“.php”结尾的请求都会结果被缓存，当然这里只是示例需要，实际中一般不会这么配，而是为特定需要缓存的location配置缓存。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">srcache_fetch表示注册一个输入拦截处理器到location，这个配置将在location进入时被执行；而srcache_store表示注册一个输出拦截器到location，当location执行完成并输出时会被执行。注意srcache模块实际可以与任何缓存模块进行配合使用，而不必一定是memc。这里我们以<span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:1.669em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:1.357em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.305em, 1001.3em, 2.294em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">u</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">r</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.059em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:0.941em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">u</span><span style="transition:none;">r</span><span style="transition:none;">i</span></span></span></span>args作为缓存的key。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">经过上述配置后，相当于对Nginx增加了如下逻辑：当所请求的uri以“.php”结尾时，首先到memcache中查询有没有以<span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:1.669em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:1.357em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.305em, 1001.3em, 2.294em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">u</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">r</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.059em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:0.941em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">u</span><span style="transition:none;">r</span><span style="transition:none;">i</span></span></span></span>args为key的数据，如果有则直接返回；否则，执行location的逻辑，如果返回的http状态码为200，则在输出前以<span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:1.669em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:1.357em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.305em, 1001.3em, 2.294em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">u</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">r</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.059em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:0.941em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">u</span><span style="transition:none;">r</span><span style="transition:none;">i</span></span></span></span>args为key，将输入结果存入memcache。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">更多配置</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">上一节给出了使用memc和srcache构建缓存层的最基本方法，实际应用中可能需要更多灵活的配置，例如为不同的location配置不同的缓存参数，根据返回内容而不是返回的http状态码确定是否缓存等等。可以有很多的方法实现这些需求，例如，srcache还支持两个指令：srcache_fetch_skip和srcache_fetch_skip，这两个指令接受一个参数，当参数已定义且非0时，则进行相应操作，否则不进行。例如，如果配置了srcache_fetch_skip <span style="white-space:nowrap;display:inline;font-weight:normal;line-height:normal;font-size:100%;text-indent:0px;text-align:left;text-transform:none;letter-spacing:normal;word-spacing:normal;word-wrap:normal;font-style:normal;float:none;direction:ltr;max-width:none;max-height:none;min-width:0px;min-height:0px;border:0px;padding:0px;margin:0px;position:relative;"><span style="min-height:0px;transition:none;margin:0px;max-width:none;max-height:none;min-width:0px;padding:0px;vertical-align:0px;line-height:normal;text-decoration:none;border:0px;white-space:nowrap;"><span style="display:inline-block;transition:none;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;width:13.128em;"><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:0px;position:relative;text-decoration:none;transition:none;width:10.94em;height:0px;font-size:120%;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:absolute;text-decoration:none;transition:none;clip:rect(1.201em, 1010.94em, 2.503em, -999.997em);top:-2.133em;left:0em;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">s</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">k</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">i</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;font-family:MathJax_Math-italic;">p</span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">，</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">这</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">条</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">指</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">令</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">，</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">那</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">么</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">只</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">有</span></span></span></span><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="transition:none;display:inline;position:static;border:0px;padding:0px;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;"><span style="line-height:normal;display:inline;border:0px;padding:0px;margin:0px;vertical-align:0px;position:static;text-decoration:none;transition:none;font-family:STIXGeneral, &quot;Arial Unicode MS&quot;, serif;font-size:83%;font-style:normal;font-weight:normal;">当</span></span></span></span></span><span style="vertical-align:0px;display:inline-block;border:0px;padding:0px;margin:0px;position:static;line-height:normal;text-decoration:none;transition:none;width:0px;height:2.138em;"></span></span></span><span style="line-height:normal;display:inline-block;border:0px;padding:0px;margin:0px;vertical-align:-0.309em;position:static;text-decoration:none;transition:none;overflow:hidden;border-left:0px solid;width:0px;height:1.316em;"></span></span></span><span style="width:1px;top:0px;clip:rect(1px, 1px, 1px, 1px);user-select:none;left:0px;display:block;transition:none;margin:0px;vertical-align:0px;line-height:normal;text-decoration:none;height:1px;position:absolute;overflow:hidden;border:0px;padding:1px 0px 0px;"><span style="transition:none;"><span style="transition:none;">s</span><span style="transition:none;">k</span><span style="transition:none;">i</span><span style="transition:none;">p</span><span style="transition:none;"><span style="transition:none;">，</span></span><span style="transition:none;"><span style="transition:none;">这</span></span><span style="transition:none;"><span style="transition:none;">条</span></span><span style="transition:none;"><span style="transition:none;">指</span></span><span style="transition:none;"><span style="transition:none;">令</span></span><span style="transition:none;"><span style="transition:none;">，</span></span><span style="transition:none;"><span style="transition:none;">那</span></span><span style="transition:none;"><span style="transition:none;">么</span></span><span style="transition:none;"><span style="transition:none;">只</span></span><span style="transition:none;"><span style="transition:none;">有</span></span><span style="transition:none;"><span style="transition:none;">当</span></span></span></span></span>skip的值为非0时，才将结果缓存，如果配合<a href="http://wiki.nginx.org/HttpLuaModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">ngx_lua</a>模块的<a href="http://wiki.nginx.org/HttpLuaModule#set_by_lua" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">set_by_lua</a>指令，则可以实现复杂的缓存控制。如：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">location </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">xxxx </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(38, 139, 210);"> $key </span><span style="color:rgb(131, 148, 150);">...;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    set_by_lua $skip </span><span style="color:rgb(42, 161, 152);">'</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">        if ngx.var.cookie_foo == &quot;bar&quot; then</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">            return 1</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">        end</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">        return 0</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(42, 161, 152);">    '</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    srcache_fetch_skip $skip</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    srcache_store_skip $skip</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    srcache_fetch GET </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">memc $key</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    srcache_store GET </span><span style="color:rgb(131, 148, 150);">/</span><span style="color:rgb(38, 139, 210);">memc $key</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    </span><span style="color:rgb(88, 97, 117);font-style:italic;"># proxy_pass/fastcgi_pass/...</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">}</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这表示对/xxxx这个location的访问，只有存在cookie “foo”且值为“bar”时缓存机制才起作用。关于ngx_lua的更多内容请参考其<a href="http://wiki.nginx.org/HttpLuaModule" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">主页</a>。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">另外，我最近在春哥（章亦春在淘宝的昵称）的微博上看到他目前正在完善srcache的功能，为其实现更多<a href="http://tools.ietf.org/pdf/rfc2616.pdf" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">RFC2616</a>的缓存行为标准。关于这个模块的最新动态可以关注其<a href="https://github.com/agentzh/srcache-nginx-module" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">github</a>主页。</p>
<h1 style="font-size:2em;font-weight:normal;color:rgb(42, 42, 42);">Benchmark</h1>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">下面对使用memc和srcache构建的缓存机制进行一个简单的benchmark，并与使用PHP操作memcache的策略进行一个对比。为了简单起见，我们的测试PHP脚本不去访问I/O，而仅仅是调用phpinfo函数输出PHP相关信息。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">测试一共分三组进行：第一组在Nginx和PHP中均不开启缓存，第二组仅使用PHP memcache缓存，第三组仅使用Nginx memcache缓存。三组都用<a href="http://httpd.apache.org/docs/2.0/programs/ab.html" style="text-decoration:none;color:rgb(0, 136, 204);" target="_blank">ab</a>程序去压，并发数为20，请求次数为10000。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这里的测试环境是我的一个虚拟机，操作系统为Ubuntu10，内存512M。Nginx采用epoll，单worker进程，memcache最大并发数为1024，最大使用内存64m。</p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">不开启缓存</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这一组我们不开启缓存，PHP程序非常简单：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">&lt;?</span><span style="color:rgb(38, 139, 210);">php</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">phpinfo</span><span style="color:rgb(131, 148, 150);">();</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">?&gt;</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">测试结果如下：</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [3].png" type="image/png" data-filename="Image.png" height="558" style="border:0px;" width="661"/></p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">PHP memcache缓存策略</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">第二组我们用PHP操作缓存，测试脚本为：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-size:11px;background-color:rgb(4, 32, 41);padding:10px;border:1px solid rgb(225, 225, 232);border-radius:4px;font-family:Menlo, Monaco, &quot;Andale Mono&quot;, &quot;lucida console&quot;, &quot;Courier New&quot;, monospace;"><ol style="color:rgb(76, 102, 108);margin:0px;"><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">&lt;?</span><span style="color:rgb(38, 139, 210);">php</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">$memc </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">new</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(181, 137, 0);">Memcached</span><span style="color:rgb(131, 148, 150);">;</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">$memc</span><span style="color:rgb(131, 148, 150);">-&gt;</span><span style="color:rgb(38, 139, 210);">addServer</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">'localhost'</span><span style="color:rgb(131, 148, 150);">,</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">11211</span><span style="color:rgb(131, 148, 150);">)</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">or</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(203, 75, 22);">die</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">'Connect to memcache server failed!'</span><span style="color:rgb(131, 148, 150);">);</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">$output </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> $memc</span><span style="color:rgb(131, 148, 150);">-&gt;</span><span style="color:rgb(203, 75, 22);">get</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">'my_key'</span><span style="color:rgb(131, 148, 150);">);</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(203, 75, 22);">if</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(38, 139, 210);">empty</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(38, 139, 210);">$output</span><span style="color:rgb(131, 148, 150);">))</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(131, 148, 150);">{</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    ob_start</span><span style="color:rgb(131, 148, 150);">();</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    phpinfo</span><span style="color:rgb(131, 148, 150);">();</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    $output </span><span style="color:rgb(131, 148, 150);">=</span><span style="color:rgb(38, 139, 210);"> ob_get_contents</span><span style="color:rgb(131, 148, 150);">();</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    ob_end_clean</span><span style="color:rgb(131, 148, 150);">();</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">    $memc</span><span style="color:rgb(131, 148, 150);">-&gt;</span><span style="color:rgb(203, 75, 22);">set</span><span style="color:rgb(131, 148, 150);">(</span><span style="color:rgb(42, 161, 152);">'my_key'</span><span style="color:rgb(131, 148, 150);">,</span><span style="color:rgb(38, 139, 210);"> $output</span><span style="color:rgb(131, 148, 150);">,</span><span style="color:rgb(38, 139, 210);"> </span><span style="color:rgb(42, 161, 152);">300</span><span style="color:rgb(131, 148, 150);">);</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">}</span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(38, 139, 210);">echo $output</span><span style="color:rgb(131, 148, 150);">;</span><span style="color:rgb(38, 139, 210);"> </span></li><li style="line-height:18px;padding-left:12px;color:rgb(90, 90, 90);margin:0px;"><span style="color:rgb(131, 148, 150);">?&gt;</span></li></ol></pre>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">测试结果如下：</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [4].png" type="image/png" data-filename="Image.png" height="558" style="border:0px;" width="659"/></p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">Nginx memcache缓存策略</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">最后，我们将PHP脚本回归到不使用缓存的版本，并配置好memc和srcache缓存机制。测试结果如下：</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [5].png" type="image/png" data-filename="Image.png" height="564" style="border:0px;" width="664"/></p>
<h2 style="font-weight:normal;color:rgb(42, 42, 42);">结果对比分析</h2>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">为了直观，我取“每秒处理请求数”、“平均每个请求处理时间”和“吞吐率”作为评价指标，制作了一张图表。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);text-align:center;"><img src="使用memc-nginx和srcache-nginx模块构建高效透明的缓存机制_files/Image [6].png" type="image/png" data-filename="Image.png" height="400" style="border:0px;" width="607"/></p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">我想看到图表，结论已毋需我多言。在各项指标上使用memc和srcache构建的缓存机制都大大优于使用PHP操作memcache。其中每秒处理请求数（并发度）和吞吐率都是其9倍左右，而平均个请求所用时间仅有传统策略的1/8。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">这里要特别说明一下，这里之所以PHP memcache策略比不使用缓存优势不明显，是因为我们的PHP脚本不涉及I/O操作，如果其中存在如数据库存取，PHP memcache的优势还是有的，但不论如何，Nginx memcache策略在性能上的优势是其无法比拟的。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">另外，除了性能优势外，使用这种策略还可以简化PHP逻辑，因为缓存这一层都放在Nginx中了，PHP就从缓存操作中解放了出来，因此是一举多得。</p>
<p style="font-size:16px;line-height:1.8em;color:rgb(90, 90, 90);">如果你的系统也构建在LNMP上（或LAMP）上，不妨使用本文提到的方法替代传统的缓存策略，尽情享受性能上的提升。</p>

        </div></div></div></div></div></div>
</div>
</span>
</div></body></html> 